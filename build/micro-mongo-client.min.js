var I,g={exports:{}};var C=function(){if(I)return g.exports;I=1;var C,A="object"==typeof Reflect?Reflect:null,Z=A&&"function"==typeof A.apply?A.apply:function(I,g,C){return Function.prototype.apply.call(I,g,C)};C=A&&"function"==typeof A.ownKeys?A.ownKeys:Object.getOwnPropertySymbols?function(I){return Object.getOwnPropertyNames(I).concat(Object.getOwnPropertySymbols(I))}:function(I){return Object.getOwnPropertyNames(I)};var l=Number.isNaN||function(I){return I!=I};function G(){G.init.call(this)}g.exports=G,g.exports.once=function(I,g){return new Promise(function(C,A){function Z(C){I.removeListener(g,l),A(C)}function l(){"function"==typeof I.removeListener&&I.removeListener("error",Z),C([].slice.call(arguments))}X(I,g,l,{once:!0}),"error"!==g&&function(I,g,C){"function"==typeof I.on&&X(I,"error",g,C)}(I,Z,{once:!0})})},G.EventEmitter=G,G.prototype._events=void 0,G.prototype._eventsCount=0,G.prototype._maxListeners=void 0;var b=10;function c(I){if("function"!=typeof I)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof I)}function d(I){return void 0===I._maxListeners?G.defaultMaxListeners:I._maxListeners}function i(I,g,C,A){var Z,l,G,b;if(c(C),void 0===(l=I._events)?(l=I._events=/* @__PURE__ */Object.create(null),I._eventsCount=0):(void 0!==l.newListener&&(I.emit("newListener",g,C.listener?C.listener:C),l=I._events),G=l[g]),void 0===G)G=l[g]=C,++I._eventsCount;else if("function"==typeof G?G=l[g]=A?[C,G]:[G,C]:A?G.unshift(C):G.push(C),(Z=d(I))>0&&G.length>Z&&!G.warned){G.warned=!0;var i=new Error("Possible EventEmitter memory leak detected. "+G.length+" "+String(g)+" listeners added. Use emitter.setMaxListeners() to increase limit");i.name="MaxListenersExceededWarning",i.emitter=I,i.type=g,i.count=G.length,b=i,console&&console.warn&&console.warn(b)}return I}function B(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function m(I,g,C){var A={fired:!1,wrapFn:void 0,target:I,type:g,listener:C},Z=B.bind(A);return Z.listener=C,A.wrapFn=Z,Z}function W(I,g,C){var A=I._events;if(void 0===A)return[];var Z=A[g];return void 0===Z?[]:"function"==typeof Z?C?[Z.listener||Z]:[Z]:C?function(I){for(var g=new Array(I.length),C=0;C<g.length;++C)g[C]=I[C].listener||I[C];return g}(Z):V(Z,Z.length)}function o(I){var g=this._events;if(void 0!==g){var C=g[I];if("function"==typeof C)return 1;if(void 0!==C)return C.length}return 0}function V(I,g){for(var C=new Array(g),A=0;A<g;++A)C[A]=I[A];return C}function X(I,g,C,A){if("function"==typeof I.on)A.once?I.once(g,C):I.on(g,C);else{if("function"!=typeof I.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof I);I.addEventListener(g,function Z(l){A.once&&I.removeEventListener(g,Z),C(l)})}}return Object.defineProperty(G,"defaultMaxListeners",{enumerable:!0,get:function(){return b},set:function(I){if("number"!=typeof I||I<0||l(I))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+I+".");b=I}}),G.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=/* @__PURE__ */Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},G.prototype.setMaxListeners=function(I){if("number"!=typeof I||I<0||l(I))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+I+".");return this._maxListeners=I,this},G.prototype.getMaxListeners=function(){return d(this)},G.prototype.emit=function(I){for(var g=[],C=1;C<arguments.length;C++)g.push(arguments[C]);var A="error"===I,l=this._events;if(void 0!==l)A=A&&void 0===l.error;else if(!A)return!1;if(A){var G;if(g.length>0&&(G=g[0]),G instanceof Error)throw G;var b=new Error("Unhandled error."+(G?" ("+G.message+")":""));throw b.context=G,b}var c=l[I];if(void 0===c)return!1;if("function"==typeof c)Z(c,this,g);else{var d=c.length,i=V(c,d);for(C=0;C<d;++C)Z(i[C],this,g)}return!0},G.prototype.addListener=function(I,g){return i(this,I,g,!1)},G.prototype.on=G.prototype.addListener,G.prototype.prependListener=function(I,g){return i(this,I,g,!0)},G.prototype.once=function(I,g){return c(g),this.on(I,m(this,I,g)),this},G.prototype.prependOnceListener=function(I,g){return c(g),this.prependListener(I,m(this,I,g)),this},G.prototype.removeListener=function(I,g){var C,A,Z,l,G;if(c(g),void 0===(A=this._events))return this;if(void 0===(C=A[I]))return this;if(C===g||C.listener===g)0===--this._eventsCount?this._events=/* @__PURE__ */Object.create(null):(delete A[I],A.removeListener&&this.emit("removeListener",I,C.listener||g));else if("function"!=typeof C){for(Z=-1,l=C.length-1;l>=0;l--)if(C[l]===g||C[l].listener===g){G=C[l].listener,Z=l;break}if(Z<0)return this;0===Z?C.shift():function(I,g){for(;g+1<I.length;g++)I[g]=I[g+1];I.pop()}(C,Z),1===C.length&&(A[I]=C[0]),void 0!==A.removeListener&&this.emit("removeListener",I,G||g)}return this},G.prototype.off=G.prototype.removeListener,G.prototype.removeAllListeners=function(I){var g,C,A;if(void 0===(C=this._events))return this;if(void 0===C.removeListener)return 0===arguments.length?(this._events=/* @__PURE__ */Object.create(null),this._eventsCount=0):void 0!==C[I]&&(0===--this._eventsCount?this._events=/* @__PURE__ */Object.create(null):delete C[I]),this;if(0===arguments.length){var Z,l=Object.keys(C);for(A=0;A<l.length;++A)"removeListener"!==(Z=l[A])&&this.removeAllListeners(Z);return this.removeAllListeners("removeListener"),this._events=/* @__PURE__ */Object.create(null),this._eventsCount=0,this}if("function"==typeof(g=C[I]))this.removeListener(I,g);else if(void 0!==g)for(A=g.length-1;A>=0;A--)this.removeListener(I,g[A]);return this},G.prototype.listeners=function(I){return W(this,I,!0)},G.prototype.rawListeners=function(I){return W(this,I,!1)},G.listenerCount=function(I,g){return"function"==typeof I.listenerCount?I.listenerCount(g):o.call(I,g)},G.prototype.listenerCount=o,G.prototype.eventNames=function(){return this._eventsCount>0?C(this._events):[]},g.exports}();const A={OK:0,INTERNAL_ERROR:1,BAD_VALUE:2,NO_SUCH_KEY:4,GRAPH_CONTAINS_CYCLE:5,HOST_UNREACHABLE:6,HOST_NOT_FOUND:7,UNKNOWN_ERROR:8,FAILED_TO_PARSE:17287,CANNOT_MUTATE_OBJECT:10,USER_NOT_FOUND:11,UNSUPPORTED_FORMAT:12,UNAUTHORIZED:13,TYPE_MISMATCH:14,OVERFLOW:15,INVALID_LENGTH:16,PROTOCOL_ERROR:17,AUTHENTICATION_FAILED:18,ILLEGAL_OPERATION:20,NAMESPACE_NOT_FOUND:26,INDEX_NOT_FOUND:27,PATH_NOT_VIABLE:28,CANNOT_CREATE_INDEX:67,INDEX_ALREADY_EXISTS:68,INDEX_EXISTS:68,COMMAND_NOT_FOUND:59,NAMESPACE_EXISTS:48,INVALID_NAMESPACE:73,INDEX_OPTIONS_CONFLICT:85,INVALID_INDEX_SPECIFICATION_OPTION:197,WRITE_CONFLICT:112,DUPLICATE_KEY:11e3,DUPLICATE_KEY_UPDATE:11001,DOCUMENT_VALIDATION_FAILURE:121,BAD_QUERY:2,CANNOT_INDEX_PARALLEL_ARRAYS:171,CURSOR_NOT_FOUND:43,COLLECTION_IS_EMPTY:26,CANNOT_DO_EXCLUSION_ON_FIELD_ID_IN_INCLUSION_PROJECTION:31254,NOT_IMPLEMENTED:999,OPERATION_NOT_SUPPORTED:998};class Z extends Error{constructor(I,g={}){super(I),this.name="MongoError",this.code=g.code||A.UNKNOWN_ERROR,this.codeName=this._getCodeName(this.code),this.$err=I,g.collection&&(this.collection=g.collection),g.database&&(this.database=g.database),g.operation&&(this.operation=g.operation),g.query&&(this.query=g.query),g.document&&(this.document=g.document),g.field&&(this.field=g.field),g.index&&(this.index=g.index),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}_getCodeName(I){return{0:"OK",1:"InternalError",2:"BadValue",4:"NoSuchKey",5:"GraphContainsCycle",6:"HostUnreachable",7:"HostNotFound",8:"UnknownError",10:"CannotMutateObject",11:"UserNotFound",12:"UnsupportedFormat",13:"Unauthorized",14:"TypeMismatch",15:"Overflow",16:"InvalidLength",17:"ProtocolError",18:"AuthenticationFailed",20:"IllegalOperation",26:"NamespaceNotFound",27:"IndexNotFound",28:"PathNotViable",43:"CursorNotFound",48:"NamespaceExists",59:"CommandNotFound",67:"CannotCreateIndex",68:"IndexExists",73:"InvalidNamespace",85:"IndexOptionsConflict",112:"WriteConflict",121:"DocumentValidationFailure",171:"CannotIndexParallelArrays",197:"InvalidIndexSpecificationOption",998:"OperationNotSupported",999:"NotImplemented",11e3:"DuplicateKey",11001:"DuplicateKeyUpdate",17287:"FailedToParse"}[I]||"UnknownError"}toJSON(){const I={name:this.name,message:this.message,code:this.code,codeName:this.codeName};return this.collection&&(I.collection=this.collection),this.database&&(I.database=this.database),this.operation&&(I.operation=this.operation),this.index&&(I.index=this.index),this.indexName&&(I.indexName=this.indexName),this.field&&(I.field=this.field),this.query&&(I.query=this.query),this.document&&(I.document=this.document),this.namespace&&(I.namespace=this.namespace),this.cursorId&&(I.cursorId=this.cursorId),this.feature&&(I.feature=this.feature),this.keyPattern&&(I.keyPattern=this.keyPattern),this.keyValue&&(I.keyValue=this.keyValue),this.writeErrors&&(I.writeErrors=this.writeErrors),I}}class l extends Z{constructor(I,g={}){super(I,g),this.name="MongoServerError"}}class G extends Z{constructor(I,g={}){super(I,g),this.name="MongoDriverError",this.code=g.code||A.INTERNAL_ERROR}}class b extends Z{constructor(I,g={}){super(I,g),this.name="WriteError",this.code=g.code||A.WRITE_CONFLICT}}class c extends b{constructor(I,g={}){const C=JSON.stringify(I);super(`E11000 duplicate key error${g.collection?` collection: ${g.collection}`:""} index: ${C} dup key: ${C}`,{...g,code:A.DUPLICATE_KEY}),this.name="DuplicateKeyError",this.keyPattern=I,this.keyValue=g.keyValue||I}}class d extends Z{constructor(I,g={}){super(I,g),this.name="ValidationError",this.code=g.code||A.DOCUMENT_VALIDATION_FAILURE,this.validationErrors=g.validationErrors||[]}}class i extends Z{constructor(I,g={}){super(I,g),this.name="IndexError"}}class B extends i{constructor(I,g={}){super(`Index with name '${I}' already exists`,{...g,code:A.INDEX_EXISTS}),this.name="IndexExistsError",this.indexName=I}}class m extends i{constructor(I,g={}){super(`Index '${I}' not found`,{...g,code:A.INDEX_NOT_FOUND,index:I}),this.name="IndexNotFoundError",this.indexName=I}}class W extends i{constructor(I,g={}){super(`Cannot create index: ${I}`,{...g,code:A.CANNOT_CREATE_INDEX}),this.name="CannotCreateIndexError"}}class o extends Z{constructor(I,g={}){super(I,g),this.name="QueryError",this.code=g.code||A.BAD_QUERY}}class V extends Z{constructor(I,g,C,Z={}){super(`Type mismatch for field '${I}': expected ${g}, got ${C}`,{...Z,code:A.TYPE_MISMATCH,field:I}),this.name="TypeMismatchError",this.expectedType=g,this.actualType=C}}class X extends Z{constructor(I,g={}){super(I,g),this.name="NamespaceError"}}class s extends X{constructor(I,g={}){super(`Namespace '${I}' not found`,{...g,code:A.NAMESPACE_NOT_FOUND}),this.name="NamespaceNotFoundError",this.namespace=I}}class Y extends X{constructor(I,g,C={}){"object"!=typeof g||C||(C=g,g=void 0);super(g?`Invalid namespace '${I}': ${g}`:`Invalid namespace '${I}'`,{...C,code:A.INVALID_NAMESPACE}),this.name="InvalidNamespaceError",this.namespace=I}}class h extends Z{constructor(I,g={}){super(I,g),this.name="CursorError"}}class y extends h{constructor(I,g={}){super(`Cursor ${I} not found`,{...g,code:A.CURSOR_NOT_FOUND}),this.name="CursorNotFoundError",this.cursorId=I}}class K extends Z{constructor(I,g={}){super(`${I} is not implemented in micro-mongo`,{...g,code:A.NOT_IMPLEMENTED}),this.name="NotImplementedError",this.feature=I}}class a extends Z{constructor(I,g,C={}){"object"!=typeof g||C||(C=g,g=void 0);super(g?`Operation '${I}' is not supported: ${g}`:`Operation '${I}' is not supported`,{...C,code:A.OPERATION_NOT_SUPPORTED,operation:I}),this.name="OperationNotSupportedError"}}class u extends Z{constructor(I,g,C,Z={}){super(`Bad value for field '${I}': ${C}`,{...Z,code:A.BAD_VALUE,field:I}),this.name="BadValueError",this.value=g}}class H extends Z{constructor(I=[],g={}){super(`Bulk write operation error: ${I.length} error(s)`,g),this.name="BulkWriteError",this.writeErrors=I,this.code=g.code||A.WRITE_CONFLICT}}class R extends Z{constructor(I,g={}){super(I,g),this.name="MongoNetworkError",this.code=g.code||A.HOST_UNREACHABLE}}class n extends C.EventEmitter{static create({bridge:I,database:g,collection:C,streamId:A,pipeline:Z=[],options:l={}}){const G=new n({bridge:I,streamId:A});return A||I.sendRequest({target:"collection",database:g,collection:C,method:"watch",args:[Z,l]}).then(I=>{I&&I.streamId&&(G.streamId=I.streamId)}).catch(()=>{}),G}constructor({bridge:I,streamId:g}){super(),this.bridge=I,this.streamId=g,this._onEvent=this._onEvent.bind(this),this.bridge.on("event",this._onEvent)}_onEvent(I,g){if("changeStream"!==I)return;if(!g||g.streamId!==this.streamId)return;const{type:C,data:A}=g;"change"===C&&this.emit("change",A),"error"===C&&this.emit("error",A),"close"===C&&(this.emit("close"),this._cleanup())}_cleanup(){this.bridge.off("event",this._onEvent)}async close(){await this.bridge.sendRequest({target:"changestream",streamId:this.streamId,method:"close"}),this._cleanup()}async next(){return new Promise((I,g)=>{const C=g=>{this.off("change",C),this.off("error",A),I(g)},A=I=>{this.off("change",C),this.off("error",A),g(I)};this.on("change",C),this.on("error",A)})}}class p{constructor({bridge:I,cursorId:g,batch:C=[],exhausted:A=!1,batchSize:Z=100,requestPromise:l,requestPayload:G}){this.bridge=I,this.cursorId=g,this.buffer=Array.isArray(C)?C:[],this.exhausted=A||!1,this._batchSize=Z,this._requestPromise=l||null,this._requestPayload=G||null,this._initialized=!l&&!G}async _ensureInitialized(){if(!this._initialized)if(this._requestPayload){const I={};void 0!==this._limit&&(I.limit=this._limit),void 0!==this._skip&&(I.skip=this._skip),void 0!==this._sort&&(I.sort=this._sort),void 0!==this._min&&(I.min=this._min),void 0!==this._max&&(I.max=this._max),void 0!==this._hint&&(I.hint=this._hint),void 0!==this._comment&&(I.comment=this._comment),void 0!==this._maxTimeMS&&(I.maxTimeMS=this._maxTimeMS),void 0!==this._maxScan&&(I.maxScan=this._maxScan),void 0!==this._returnKey&&(I.returnKey=this._returnKey),void 0!==this._showRecordId&&(I.showRecordId=this._showRecordId),void 0!==this._collation&&(I.collation=this._collation),this._requestPayload.cursorOpts=I;const g=await this.bridge.sendRequest(this._requestPayload);this.cursorId=g.cursorId,this.buffer=g.batch||[],this.exhausted=g.exhausted||!1,this._batchSize=g.batchSize||100,this._requestPayload=null,this._initialized=!0}else if(this._requestPromise){const I=await this._requestPromise;this.cursorId=I.cursorId,this.buffer=I.batch||[],this.exhausted=I.exhausted||!1,this._batchSize=I.batchSize||100,this._requestPromise=null,this._initialized=!0}}async hasNext(){return await this._ensureInitialized(),this.buffer.length>0||!this.exhausted&&(await this._getMore(),this.buffer.length>0)}async next(){return await this.hasNext()?this.buffer.shift():null}async toArray(){await this._ensureInitialized();const I=[...this.buffer];for(this.buffer=[];!this.exhausted;)await this._getMore(),I.push(...this.buffer),this.buffer=[];return I}async count(){return(await this.toArray()).length}limit(I){return this._limit=I,this}skip(I){return this._skip=I,this}sort(I){return this._sort=I,this}batchSize(I){return this._batchSize=I,this}async close(){return this._closed=!0,await this._closeRemote(),this}isClosed(){return this._closed||!1}comment(I){return this._comment=I,this}hint(I){return this._hint=I,this}async explain(I="queryPlanner"){await this._ensureInitialized();try{return await this.bridge.sendRequest({target:"cursor",cursorId:this.cursorId,method:"explain",args:[I]})}catch(g){return{queryPlanner:{plannerVersion:1,namespace:"unknown",indexFilterSet:!1,parsedQuery:{},winningPlan:{stage:"COLLSCAN"}},..."executionStats"===I&&{executionStats:{executionSuccess:!0,nReturned:0,executionTimeMillis:0}},ok:1}}}async itcount(){let I=0;for(;await this.hasNext();)await this.next(),I++;return I}async size(){await this._ensureInitialized();let I=this.buffer.length;const g=[...this.buffer];for(;!this.exhausted;)await this._getMore(),I+=this.buffer.length;return this.buffer=g,I}min(I){return this._min=I,this}max(I){return this._max=I,this}maxTimeMS(I){return this._maxTimeMS=I,this}maxScan(I){return this._maxScan=I,this}noCursorTimeout(){return this._noCursorTimeout=!0,this}objsLeftInBatch(){return this.buffer.length}pretty(){return this._pretty=!0,this}readConcern(I){return this._readConcern=I,this}readPref(I,g){return this._readPref={mode:I,tagSet:g},this}returnKey(I=!0){return this._returnKey=I,this}showRecordId(I=!0){return this._showRecordId=I,this}allowDiskUse(I=!0){return this._allowDiskUse=I,this}collation(I){return this._collation=I,this}async forEach(I){for(;await this.hasNext();){const g=await this.next();await I(g)}}async map(I){const g=[];for(;await this.hasNext();){const C=await this.next();g.push(await I(C))}return g}async*[Symbol.asyncIterator](){for(;await this.hasNext();)yield await this.next()}async _getMore(){if(this.exhausted)return;const I=await this.bridge.sendRequest({target:"cursor",cursorId:this.cursorId,method:"getMore",args:[{batchSize:this._batchSize}]});this.buffer=I?.batch||[],this.exhausted=!!I?.exhausted,this.exhausted&&await this._closeRemote()}async _closeRemote(){if(this.cursorId){try{await this.bridge.sendRequest({target:"cursor",cursorId:this.cursorId,method:"close"})}catch(I){}this.cursorId=null}}}class e{constructor({dbName:I,name:g,bridge:C}){return this.dbName=I,this.name=g,this.bridge=C,this.indexes=[],new Proxy(this,{get:(I,g,C)=>g in I?Reflect.get(I,g,C):"symbol"==typeof g||String(g).startsWith("_")?void 0:"watch"===g?(...g)=>I._watch(...g):"find"===g||"aggregate"===g?(...C)=>I._cursorMethod(String(g),C):(...C)=>I._call(String(g),C)})}_cursorMethod(I,g=[]){const C={target:"collection",database:this.dbName,collection:this.name,method:I,args:g},A=new p({bridge:this.bridge,requestPayload:C});return"aggregate"===I&&(A.then=function(I,g){return this.toArray().then(I,g)}),A}_call(I,g=[]){return this.bridge.sendRequest({target:"collection",database:this.dbName,collection:this.name,method:I,args:g}).then(C=>{if(C&&C.cursorId)return new p({bridge:this.bridge,cursorId:C.cursorId,batch:C.batch,exhausted:C.exhausted,batchSize:C.batchSize});if("createIndex"===I){const I=g[0],C=g[1]||{},A=C.name||Object.entries(I).map(([I,g])=>`${I}_${g}`).join("_");this.indexes.find(I=>I.name===A)||this.indexes.push({name:A,key:I,...C})}if("dropIndex"===I){const I=g[0];this.indexes=this.indexes.filter(g=>g.name!==I)}return"dropIndexes"===I&&(this.indexes=[]),C})}getIndexes(){return this.indexes}_watch(I=[],g={}){return n.create({bridge:this.bridge,database:this.dbName,collection:this.name,pipeline:I,options:g})}}class t{constructor({dbName:I,bridge:g,options:C={}}){this.dbName=I,this.bridge=g,this.options=C,this.collections=/* @__PURE__ */new Map;const A=/* @__PURE__ */new Set(["getCollectionNames","getCollectionInfos","createCollection","dropCollection","dropDatabase","collection","getCollection","watch"]);return this._methodNames=A,new Proxy(this,{get:(I,g,C)=>g in I?Reflect.get(I,g,C):"symbol"==typeof g||String(g).startsWith("_")?void 0:A.has(g)?"createCollection"===g?(...C)=>{const A=C[0];return I.collection(A),I._call(String(g),C)}:"dropCollection"===g?(...C)=>{const A=C[0];return I.collections.delete(A),I._call(String(g),C)}:"dropDatabase"===g?(...C)=>(I.collections.clear(),I._call(String(g),C)):(...C)=>I._call(String(g),C):I.collection(g)})}collection(I){if(this.collections.has(I))return this.collections.get(I);const g=new e({dbName:this.dbName,name:I,bridge:this.bridge});return this.collections.set(I,g),g}getCollectionNames(){return Array.from(this.collections.keys())}async close(){}_call(I,g=[]){return this.bridge.sendRequest({target:"db",database:this.dbName,method:I,args:g}).then(I=>I&&I.streamId?n.create({bridge:this.bridge,database:this.dbName,collection:null,streamId:I.streamId}):I)}}class S extends C.EventEmitter{constructor(I="mongodb://localhost:27017",g={}){if(super(),this.uri=I,this.options=Object.freeze({...g}),this._isConnected=!1,this._defaultDb=this._parseDefaultDbName(I),this._databases=/* @__PURE__ */new Map,!g.workerBridge)throw new Error("workerBridge is required. Create one with: const bridge = await WorkerBridge.create()");this._bridge=g.workerBridge,this._ownsBridge=!1}static async connect(I,g={}){const C=new S(I,g);return await C.connect(),C}async connect(){return this._isConnected||(this._isConnected=!0,this.emit("open",this)),this}db(I,g={}){const C=I||this._defaultDb;if(!C)throw new Error("No database name provided and no default in connection string");if(this._databases.has(C))return this._databases.get(C);const A=new t({dbName:C,bridge:this._bridge,options:{...this.options,...g}});return this._databases.set(C,A),A}async close(){this._bridge&&this._ownsBridge&&(await this._bridge.terminate(),this._bridge=null),this._isConnected=!1,this.emit("close")}async close(I=!1){if(this._isConnected){for(const[I,g]of this._databases)await g.close();this._databases.clear(),this._isConnected=!1,this.emit("close")}}startSession(I={}){return{id:crypto.randomUUID(),endSession:()=>{},withTransaction:async I=>await I(this)}}async withSession(I,g){const C=this.startSession("function"==typeof I?{}:I),A="function"==typeof I?I:g;try{return await A(C)}finally{C.endSession()}}get readConcern(){return this.options.readConcern}get writeConcern(){return this.options.writeConcern}get readPreference(){return this.options.readPreference}watch(I=[],g={}){return n.create({bridge:this._bridge,database:null,collection:null,pipeline:I,options:g})}_parseDefaultDbName(I){const g=I.match(/\/([^/?]+)/);return g?g[1]:null}_parseUriParams(I){const g={},C=I.indexOf("?");if(-1===C)return g;const A=I.substring(C+1).split("&");for(const Z of A){const[I,C]=Z.split("=");I&&("true"===C?g[I]=!0:"false"===C?g[I]=!1:isNaN(C)?g[I]=decodeURIComponent(C||""):g[I]=Number(C))}return g}}class N{constructor(I){if(null==I)this.id=N.generate();else if("string"==typeof I){if(!N.isValid(I))throw new Error(`Argument passed in must be a string of 24 hex characters, got: ${I}`);this.id=I.toLowerCase()}else if(I instanceof Uint8Array&&12===I.length)this.id=Array.from(I).map(I=>I.toString(16).padStart(2,"0")).join("");else{if(!(I instanceof N))throw new Error("Argument passed in must be a string of 24 hex characters or an ObjectId");this.id=I.id}}toString(){return this.id}toHexString(){return this.id}getTimestamp(){const I=parseInt(this.id.substring(0,8),16);return new Date(1e3*I)}equals(I){if(!(I instanceof N))throw new Error("Can only compare with another ObjectId");return this.id===I.id}compare(I){if(!(I instanceof N))throw new Error("Can only compare with another ObjectId");return this.id.localeCompare(I.id)}toJSON(){return this.id}inspect(){return`ObjectId("${this.id}")`}toBytes(){const I=new Uint8Array(12);for(let g=0;g<12;g++)I[g]=parseInt(this.id.substring(2*g,2*g+2),16);return I}static isValid(I){return!!I&&("string"==typeof I&&(24===I.length&&/^[0-9a-fA-F]{24}$/.test(I)))}static createFromTime(I){const g=("00000000"+Math.floor(I/1e3).toString(16)).slice(-8);return new N(g+"0000000000000000")}static generate(){const I=Math.floor(Date.now()/1e3),g="undefined"!=typeof crypto&&crypto.getRandomValues?new Uint8Array(8):null;let C="";if(g){crypto.getRandomValues(g);for(let I=0;I<g.length;I++)C+=("0"+g[I].toString(16)).slice(-2)}else C=Math.random().toString(16).slice(2).padEnd(8,"0").slice(0,8)+Math.random().toString(16).slice(2).padEnd(8,"0").slice(0,8);return(("00000000"+I.toString(16)).slice(-8)+C).slice(0,24)}}function F(I,g){return I instanceof N||g instanceof N?I instanceof N&&g instanceof N||I instanceof N&&"string"==typeof g?I.equals(g):g instanceof N&&"string"==typeof I&&g.equals(I):I==g}function w(I,g){for(var C=g.split("."),A=I[C[0]],Z=1;Z<C.length;Z++){if(null==A||null==A)return A;var l=C[Z],G=parseInt(l,10);A=J(A)&&!isNaN(G)&&G>=0&&G<A.length?A[G]:A[l]}return A}function J(I){return Array==I.constructor}function k(I,g){for(var C=0;C<g.length;C++)if(F(g[C],I))return!0;return!1}function v(I,g){if(I.length!=g.length)return!1;for(var C=0;C<I.length;C++)if(!F(I[C],g[C])){if(typeof I[C]!=typeof g[C])return!1;if("object"==typeof I[C]&&null!==I[C]){if(J(I[C])){if(!v(I[C],g[C]))return!1}else if(!z(I[C],g[C]))return!1}else if(!F(I[C],g[C]))return!1}return!0}function z(I,g){for(var C in I)if(I.hasOwnProperty(C)){if(!g.hasOwnProperty(C))return!1;if(!F(I[C],g[C])){if(typeof I[C]!=typeof g[C])return!1;if("object"==typeof I[C]&&null!==I[C]){if(J(I[C])){if(!v(I[C],g[C]))return!1}else if(!z(I[C],g[C]))return!1}else if(!F(I[C],g[C]))return!1}}for(var C in g)if(g.hasOwnProperty(C)&&!I.hasOwnProperty(C))return!1;return!0}const r={ational:"ate",tional:"tion",enci:"ence",anci:"ance",izer:"ize",bli:"ble",alli:"al",entli:"ent",eli:"e",ousli:"ous",ization:"ize",ation:"ate",ator:"ate",alism:"al",iveness:"ive",fulness:"ful",ousness:"ous",aliti:"al",iviti:"ive",biliti:"ble",logi:"log"},Q={icate:"ic",ative:"",alize:"al",iciti:"ic",ical:"ic",ful:"",ness:""},x="[aeiouy]",U="([^aeiou][^aeiouy]*)",T="("+x+"[aeiou]*)",j=new RegExp("^"+U+"?"+T+U),L=new RegExp("^"+U+"?"+T+U+T+"?$"),M=new RegExp("^"+U+"?("+T+U+"){2,}"),f=new RegExp("^"+U+"?"+x),D=new RegExp("^"+U+x+"[^aeiouwxy]$"),O=/ll$/,P=/^(.+?)e$/,E=/^(.+?)y$/,q=/^(.+?(s|t))(ion)$/,_=/^(.+?)(ed|ing)$/,$=/(at|bl|iz)$/,II=/^(.+?)eed$/,gI=/^.+?[^s]s$/,CI=/^.+?(ss|i)es$/,AI=/([^aeiouylsz])\1$/,ZI=/^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$/,lI=/^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/,GI=/^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$/;const bI=/* @__PURE__ */new Set(["a","about","after","all","also","am","an","and","another","any","are","around","as","at","be","because","been","before","being","between","both","but","by","came","can","come","could","did","do","each","for","from","get","got","has","had","he","have","her","here","him","himself","his","how","i","if","in","into","is","it","like","make","many","me","might","more","most","much","must","my","never","now","of","on","only","or","other","our","out","over","said","same","see","should","since","some","still","such","take","than","that","the","their","them","then","there","these","they","this","those","through","to","too","under","up","very","was","way","we","well","were","what","where","which","while","who","with","would","you","your"]);function cI(I,g){if(null==I)return I;if("boolean"==typeof I||"number"==typeof I)return I;if("string"==typeof I)return I.startsWith("$$")?"$$KEEP"===I||"$$PRUNE"===I||"$$DESCEND"===I?I:w(g,I.substring(2)):"$"===I.charAt(0)?w(g,I.substring(1)):I;if("object"==typeof I){if(Array.isArray(I))return I.map(I=>cI(I,g));const C=Object.keys(I);if(0===C.length)return I;const A=C[0];if("$"===A.charAt(0)){return function(I,g,C){switch(I){case"$add":return function(I,g){if(!Array.isArray(I))return null;let C=0;for(const A of I){const I=cI(A,g);I instanceof Date?C+=I.getTime():"number"==typeof I&&(C+=I)}return C}(g,C);case"$subtract":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=cI(I[0],g),A=cI(I[1],g);if(C instanceof Date&&A instanceof Date)return C.getTime()-A.getTime();if(C instanceof Date&&"number"==typeof A)return new Date(C.getTime()-A);if("number"==typeof C&&"number"==typeof A)return C-A;return null}(g,C);case"$multiply":return function(I,g){if(!Array.isArray(I))return null;let C=1;for(const A of I){const I=cI(A,g);"number"==typeof I&&(C*=I)}return C}(g,C);case"$divide":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=cI(I[0],g),A=cI(I[1],g);if("number"==typeof C&&"number"==typeof A&&0!==A)return C/A;return null}(g,C);case"$mod":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=cI(I[0],g),A=cI(I[1],g);if("number"==typeof C&&"number"==typeof A&&0!==A)return C%A;return null}(g,C);case"$pow":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=cI(I[0],g),A=cI(I[1],g);if("number"==typeof C&&"number"==typeof A)return Math.pow(C,A);return null}(g,C);case"$sqrt":return function(I,g){const C=cI(I,g);if("number"==typeof C&&C>=0)return Math.sqrt(C);return null}(g,C);case"$abs":return function(I,g){const C=cI(I,g);if("number"==typeof C)return Math.abs(C);return null}(g,C);case"$ceil":return function(I,g){const C=cI(I,g);if("number"==typeof C)return Math.ceil(C);return null}(g,C);case"$floor":return function(I,g){const C=cI(I,g);if("number"==typeof C)return Math.floor(C);return null}(g,C);case"$trunc":return function(I,g){const C=cI(I,g);if("number"==typeof C)return Math.trunc(C);return null}(g,C);case"$round":return function(I,g){const C=cI(Array.isArray(I)?I[0]:I,g),A=Array.isArray(I)&&void 0!==I[1]?cI(I[1],g):0;if("number"==typeof C&&"number"==typeof A){const I=Math.pow(10,A);return Math.round(C*I)/I}return null}(g,C);case"$concat":return function(I,g){if(!Array.isArray(I))return null;let C="";for(const A of I){const I=cI(A,g);null!=I&&(C+=String(I))}return C}(g,C);case"$substr":return function(I,g){if(!Array.isArray(I)||I.length<3)return null;const C=String(cI(I[0],g)||""),A=cI(I[1],g),Z=cI(I[2],g);if("number"==typeof A&&"number"==typeof Z)return C.substr(A,Z);return null}(g,C);case"$toLower":return function(I,g){const C=cI(I,g);return null!=C?String(C).toLowerCase():""}(g,C);case"$toUpper":return function(I,g){const C=cI(I,g);return null!=C?String(C).toUpperCase():""}(g,C);case"$trim":return function(I,g){const C=cI("object"==typeof I&&I.input?I.input:I,g),A=I.chars?cI(I.chars,g):null;let Z=null!=C?String(C):"";if(A){const I=new RegExp(`^[${dI(A)}]+|[${dI(A)}]+$`,"g");return Z.replace(I,"")}return Z.trim()}(g,C);case"$ltrim":return function(I,g){const C=cI("object"==typeof I&&I.input?I.input:I,g),A=I.chars?cI(I.chars,g):null;let Z=null!=C?String(C):"";if(A){const I=new RegExp(`^[${dI(A)}]+`,"g");return Z.replace(I,"")}return Z.replace(/^\s+/,"")}(g,C);case"$rtrim":return function(I,g){const C=cI("object"==typeof I&&I.input?I.input:I,g),A=I.chars?cI(I.chars,g):null;let Z=null!=C?String(C):"";if(A){const I=new RegExp(`[${dI(A)}]+$`,"g");return Z.replace(I,"")}return Z.replace(/\s+$/,"")}(g,C);case"$split":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=String(cI(I[0],g)||""),A=String(cI(I[1],g)||"");return C.split(A)}(g,C);case"$strLenCP":return function(I,g){const C=cI(I,g);return null!=C?String(C).length:0}(g,C);case"$strcasecmp":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=String(cI(I[0],g)||"").toLowerCase(),A=String(cI(I[1],g)||"").toLowerCase();return C<A?-1:C>A?1:0}(g,C);case"$indexOfCP":return function(I,g){if(!Array.isArray(I)||I.length<2)return null;const C=String(cI(I[0],g)||""),A=String(cI(I[1],g)||""),Z=void 0!==I[2]?cI(I[2],g):0,l=void 0!==I[3]?cI(I[3],g):C.length,G=C.substring(Z,l).indexOf(A);return-1===G?-1:G+Z}(g,C);case"$replaceOne":return function(I,g){const C=String(cI(I.input,g)||""),A=String(cI(I.find,g)||""),Z=String(cI(I.replacement,g)||"");return C.replace(A,Z)}(g,C);case"$replaceAll":return function(I,g){const C=String(cI(I.input,g)||""),A=String(cI(I.find,g)||""),Z=String(cI(I.replacement,g)||"");return C.split(A).join(Z)}(g,C);case"$cmp":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=cI(I[0],g),A=cI(I[1],g);return C<A?-1:C>A?1:0}(g,C);case"$eq":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=cI(I[0],g),A=cI(I[1],g);return C===A}(g,C);case"$ne":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=cI(I[0],g),A=cI(I[1],g);return C!==A}(g,C);case"$gt":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=cI(I[0],g),A=cI(I[1],g);return C>A}(g,C);case"$gte":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=cI(I[0],g),A=cI(I[1],g);return C>=A}(g,C);case"$lt":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=cI(I[0],g),A=cI(I[1],g);return C<A}(g,C);case"$lte":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=cI(I[0],g),A=cI(I[1],g);return C<=A}(g,C);case"$and":return function(I,g){if(!Array.isArray(I))return null;for(const C of I){if(!cI(C,g))return!1}return!0}(g,C);case"$or":return function(I,g){if(!Array.isArray(I))return null;for(const C of I){if(cI(C,g))return!0}return!1}(g,C);case"$not":return function(I,g){const C=cI(Array.isArray(I)?I[0]:I,g);return!C}(g,C);case"$cond":return function(I,g){let C,A,Z;if(Array.isArray(I)){if(3!==I.length)return null;[C,A,Z]=I}else{if("object"!=typeof I)return null;C=I.if,A=I.then,Z=I.else}const l=cI(C,g);return cI(l?A:Z,g)}(g,C);case"$ifNull":return function(I,g){if(!Array.isArray(I)||I.length<2)return null;for(let C=0;C<I.length;C++){const A=cI(I[C],g);if(null!=A)return A}return null}(g,C);case"$switch":return function(I,g){if("object"!=typeof I||!Array.isArray(I.branches))return null;for(const C of I.branches){if(cI(C.case,g))return cI(C.then,g)}return void 0!==I.default?cI(I.default,g):null}(g,C);case"$year":return function(I,g){const C=cI(I,g);if(C instanceof Date)return C.getUTCFullYear();return null}(g,C);case"$month":return function(I,g){const C=cI(I,g);if(C instanceof Date)return C.getUTCMonth()+1;return null}(g,C);case"$dayOfMonth":return function(I,g){const C=cI(I,g);if(C instanceof Date)return C.getUTCDate();return null}(g,C);case"$dayOfWeek":return function(I,g){const C=cI(I,g);if(C instanceof Date)return C.getUTCDay()+1;return null}(g,C);case"$dayOfYear":return function(I,g){const C=cI(I,g);if(C instanceof Date){const I=new Date(Date.UTC(C.getUTCFullYear(),0,0)),g=C-I,A=864e5;return Math.floor(g/A)}return null}(g,C);case"$hour":return function(I,g){const C=cI(I,g);if(C instanceof Date)return C.getUTCHours();return null}(g,C);case"$minute":return function(I,g){const C=cI(I,g);if(C instanceof Date)return C.getUTCMinutes();return null}(g,C);case"$second":return function(I,g){const C=cI(I,g);if(C instanceof Date)return C.getUTCSeconds();return null}(g,C);case"$millisecond":return function(I,g){const C=cI(I,g);if(C instanceof Date)return C.getUTCMilliseconds();return null}(g,C);case"$week":return function(I,g){const C=cI(I,g);if(C instanceof Date){const I=new Date(Date.UTC(C.getUTCFullYear(),0,1));return Math.ceil(((C-I)/864e5+I.getUTCDay()+1)/7)-1}return null}(g,C);case"$isoWeek":return function(I,g){const C=cI(I,g);if(C instanceof Date){const I=new Date(C.valueOf()),g=(C.getUTCDay()+6)%7;I.setUTCDate(I.getUTCDate()-g+3);const A=I.valueOf();return I.setUTCMonth(0,1),4!==I.getUTCDay()&&I.setUTCMonth(0,1+(4-I.getUTCDay()+7)%7),1+Math.ceil((A-I)/6048e5)}return null}(g,C);case"$isoWeekYear":return function(I,g){const C=cI(I,g);if(C instanceof Date){const I=new Date(C.valueOf());return I.setUTCDate(I.getUTCDate()-(C.getUTCDay()+6)%7+3),I.getUTCFullYear()}return null}(g,C);case"$dateToString":return function(I,g){const C=I.format?cI(I.format,g):"%Y-%m-%dT%H:%M:%S.%LZ",A=cI(I.date,g);return A instanceof Date?C.replace("%Y",A.getUTCFullYear()).replace("%m",String(A.getUTCMonth()+1).padStart(2,"0")).replace("%d",String(A.getUTCDate()).padStart(2,"0")).replace("%H",String(A.getUTCHours()).padStart(2,"0")).replace("%M",String(A.getUTCMinutes()).padStart(2,"0")).replace("%S",String(A.getUTCSeconds()).padStart(2,"0")).replace("%L",String(A.getUTCMilliseconds()).padStart(3,"0")):null}(g,C);case"$toDate":return function(I,g){const C=cI(I,g);if(C instanceof Date)return C;if("string"==typeof C||"number"==typeof C){const I=new Date(C);return isNaN(I.getTime())?null:I}return null}(g,C);case"$arrayElemAt":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=cI(I[0],g),A=cI(I[1],g);if(!Array.isArray(C)||"number"!=typeof A)return null;const Z=A<0?C.length+A:A;return C[Z]}(g,C);case"$concatArrays":return function(I,g){if(!Array.isArray(I))return null;const C=[];for(const A of I){const I=cI(A,g);Array.isArray(I)&&C.push(...I)}return C}(g,C);case"$filter":return function(I,g){const C=cI(I.input,g),A=I.as||"this",Z=I.cond;return Array.isArray(C)?C.filter(I=>{const C={...g,[A]:I};return cI(Z,C)}):null}(g,C);case"$in":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=cI(I[0],g),A=cI(I[1],g);return!!Array.isArray(A)&&A.includes(C)}(g,C);case"$indexOfArray":return function(I,g){if(!Array.isArray(I)||I.length<2)return null;const C=cI(I[0],g),A=cI(I[1],g),Z=void 0!==I[2]?cI(I[2],g):0,l=void 0!==I[3]?cI(I[3],g):C.length;if(!Array.isArray(C))return null;for(let G=Z;G<l&&G<C.length;G++)if(C[G]===A)return G;return-1}(g,C);case"$isArray":return function(I,g){const C=cI(I,g);return Array.isArray(C)}(g,C);case"$map":return function(I,g){const C=cI(I.input,g),A=I.as||"this",Z=I.in;return Array.isArray(C)?C.map(I=>{const C={...g,[A]:I};return cI(Z,C)}):null}(g,C);case"$reduce":return function(I,g){const C=cI(I.input,g),A=cI(I.initialValue,g),Z=I.in;if(!Array.isArray(C))return null;let l=A;for(const G of C){l=cI(Z,{...g,value:l,this:G})}return l}(g,C);case"$size":return function(I,g){const C=cI(I,g);return Array.isArray(C)?C.length:null}(g,C);case"$slice":return function(I,g){if(!Array.isArray(I)||I.length<2)return null;const C=cI(I[0],g);if(!Array.isArray(C))return null;if(2===I.length){const A=cI(I[1],g);return A>=0?C.slice(0,A):C.slice(A)}{const A=cI(I[1],g),Z=cI(I[2],g);return C.slice(A,A+Z)}}(g,C);case"$reverseArray":return function(I,g){const C=cI(I,g);return Array.isArray(C)?C.slice().reverse():null}(g,C);case"$zip":return function(I,g){const C=I.inputs?cI(I.inputs,g):null,A=I.useLongestLength||!1,Z=I.defaults;if(!Array.isArray(C))return null;const l=C.map(I=>cI(I,g));if(!l.every(I=>Array.isArray(I)))return null;const G=Math.max(...l.map(I=>I.length)),b=A?G:Math.min(...l.map(I=>I.length)),c=[];for(let d=0;d<b;d++){const I=[];for(let g=0;g<l.length;g++)d<l[g].length?I.push(l[g][d]):Z&&g<Z.length?I.push(Z[g]):I.push(null);c.push(I)}return c}(g,C);case"$type":return function(I,g){const C=cI(I,g);return null===C?"null":void 0===C?"missing":"boolean"==typeof C?"bool":"number"==typeof C?Number.isInteger(C)?"int":"double":"string"==typeof C?"string":C instanceof Date?"date":Array.isArray(C)?"array":"object"==typeof C?"object":"unknown"}(g,C);case"$convert":return function(I,g){const C=cI(I.input,g),A=I.to,Z=I.onError,l=I.onNull;if(null===C)return void 0!==l?cI(l,g):null;try{switch(A){case"double":case"decimal":return parseFloat(C);case"int":case"long":return parseInt(C);case"bool":return Boolean(C);case"string":return String(C);case"date":return new Date(C);default:return C}}catch(G){return void 0!==Z?cI(Z,g):null}}(g,C);case"$toBool":return function(I,g){const C=cI(I,g);return Boolean(C)}(g,C);case"$toDecimal":return function(I,g){const C=cI(I,g);return parseFloat(C)}(g,C);case"$toDouble":return function(I,g){const C=cI(I,g);return parseFloat(C)}(g,C);case"$toInt":return function(I,g){const C=cI(I,g);return parseInt(C)}(g,C);case"$toLong":return function(I,g){const C=cI(I,g);return parseInt(C)}(g,C);case"$toString":return function(I,g){const C=cI(I,g);return null==C?null:String(C)}(g,C);case"$objectToArray":return function(I,g){const C=cI(I,g);if("object"!=typeof C||null===C||Array.isArray(C))return null;return Object.keys(C).map(I=>({k:I,v:C[I]}))}(g,C);case"$arrayToObject":return function(I,g){const C=cI(I,g);if(!Array.isArray(C))return null;const A={};for(const Z of C)Array.isArray(Z)&&2===Z.length?A[Z[0]]=Z[1]:"object"==typeof Z&&void 0!==Z.k&&void 0!==Z.v&&(A[Z.k]=Z.v);return A}(g,C);case"$mergeObjects":return function(I,g){if(!Array.isArray(I))return cI(I,g);const C={};for(const A of I){const I=cI(A,g);"object"!=typeof I||null===I||Array.isArray(I)||Object.assign(C,I)}return C}(g,C);case"$literal":return g;default:throw new Error(`Unsupported aggregation operator: ${I}`)}}(A,I[A],g)}{const A={};for(const Z of C)A[Z]=cI(I[Z],g);return A}}return I}function dI(I){return I.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}const iI={1:"double",2:"string",3:"object",4:"array",5:"binData",6:"undefined",7:"objectId",8:"bool",9:"date",10:"null",11:"regex",13:"javascript",15:"javascriptWithScope",16:"int",17:"timestamp",18:"long",19:"decimal",127:"maxKey","-1":"minKey"},BI=Object.entries(iI).reduce((I,[g,C])=>(I[C]=parseInt(g),I),{});function mI(I,g){if(J(g)){for(let C=0;C<g.length;C++)if(mI(I,g[C]))return!0;return!1}const C="number"==typeof g?g:BI[g],A=iI[C]||g;return null===I?"null"===A||10===C:void 0===I?"undefined"===A||6===C:"number"==typeof I?Number.isInteger(I)?"int"===A||16===C:"double"===A||1===C:"string"==typeof I?"string"===A||2===C:"boolean"==typeof I?"bool"===A||8===C:I instanceof Date?"date"===A||9===C:I instanceof N?"objectId"===A||7===C:I instanceof RegExp?"regex"===A||11===C:J(I)?"array"===A||4===C:"object"==typeof I?"object"===A||3===C:typeof I===g}function WI(I){if(J(I)){let g=0;for(let C=0;C<I.length;C++)g|=1<<I[C];return g}return"number"==typeof I?I:0}function oI(I,g){if("number"!=typeof I)return!1;const C=WI(g);return(I&C)===C}function VI(I,g){if("number"!=typeof I)return!1;return 0===(I&WI(g))}function XI(I,g){if("number"!=typeof I)return!1;return 0!==(I&WI(g))}function sI(I,g){if("number"!=typeof I)return!1;const C=WI(g);return(I&C)!==C}function YI(I,g){if(g.type){const C=J(I)?"array":null===I?"null":typeof I;if(g.type!==C)return!1}if(g.required&&J(g.required))for(let C=0;C<g.required.length;C++)if(!(g.required[C]in I))return!1;if(g.properties)for(const C in g.properties){if(!(C in I))return!1;const A=g.properties[C];if(!YI(I[C],A))return!1}if(void 0!==g.minimum&&"number"==typeof I&&I<g.minimum)return!1;if(void 0!==g.maximum&&"number"==typeof I&&I>g.maximum)return!1;if(void 0!==g.minLength&&"string"==typeof I&&I.length<g.minLength)return!1;if(void 0!==g.maxLength&&"string"==typeof I&&I.length>g.maxLength)return!1;if(g.pattern&&"string"==typeof I){if(!new RegExp(g.pattern).test(I))return!1}return!(g.enum&&J(g.enum)&&!g.enum.includes(I))}function hI(I,g){return I instanceof N&&g instanceof N?I.equals(g):I==g}function yI(I,g,C){let A=I,Z=g;switch(I instanceof N&&(A=I.toString()),g instanceof N&&(Z=g.toString()),C){case">":return A>Z;case">=":return A>=Z;case"<":return A<Z;case"<=":return A<=Z;default:return!1}}function KI(I,g){if(void 0===I)return!1;if(null===I)return g(I);if(J(I)){for(var C=0;C<I.length;C++)if(g(I[C]))return!0;return!1}return g(I)}function aI(I){if("string"!=typeof I)return[];const g=function(I){return"string"!=typeof I?[]:I.toLowerCase().split(/\W+/).filter(I=>I.length>0).filter(I=>!bI.has(I))}(I);return g.map(I=>function(I){let g=String(I).toLowerCase();if(g.length<3)return g;let C,A=!1;return 121===g.codePointAt(0)&&(A=!0,g="Y"+g.slice(1)),CI.test(g)?g=g.slice(0,-2):gI.test(g)&&(g=g.slice(0,-1)),(C=II.exec(g))?j.test(C[1])&&(g=g.slice(0,-1)):(C=_.exec(g))&&f.test(C[1])&&(g=C[1],$.test(g)?g+="e":AI.test(g)?g=g.slice(0,-1):D.test(g)&&(g+="e")),(C=E.exec(g))&&f.test(C[1])&&(g=C[1]+"i"),(C=ZI.exec(g))&&j.test(C[1])&&(g=C[1]+r[C[2]]),(C=lI.exec(g))&&j.test(C[1])&&(g=C[1]+Q[C[2]]),(C=GI.exec(g))?M.test(C[1])&&(g=C[1]):(C=q.exec(g))&&M.test(C[1])&&(g=C[1]),(C=P.exec(g))&&(M.test(C[1])||L.test(C[1])&&!D.test(C[1]))&&(g=C[1]),O.test(g)&&M.test(g)&&(g=g.slice(0,-1)),A&&(g="y"+g.slice(1)),g}(I))}function uI(I,g){if("string"!=typeof I)return!1;const C=new Set(aI(I));return aI(g).some(I=>C.has(I))}function HI(I,g){try{if(!Array.isArray(g)||2!==g.length)return!1;const C=g[0][0],A=g[0][1],Z=g[1][0];return RI(I,C,Z,g[1][1],A)}catch(C){return!1}}function RI(I,g,C,A,Z){if(!I)return!1;if("FeatureCollection"===I.type&&I.features&&I.features.length>0){for(const l of I.features)if(l.geometry&&!RI(l.geometry,g,C,A,Z))return!1;return!0}if("Feature"===I.type&&I.geometry)return RI(I.geometry,g,C,A,Z);if("Point"===I.type&&I.coordinates){const[l,G]=I.coordinates;if("number"==typeof l&&"number"==typeof G)return l>=g&&l<=C&&G>=A&&G<=Z}if("Polygon"===I.type&&I.coordinates&&I.coordinates.length>0){for(const l of I.coordinates)for(const I of l){const l=I[0],G=I[1];if(l<g||l>C||G<A||G>Z)return!1}return!0}return!1}function nI(I){if(!I)return null;if("FeatureCollection"===I.type&&I.features&&I.features.length>0){const g=I.features[0];if(g.geometry)return nI(g.geometry)}if("Feature"===I.type&&I.geometry)return nI(I.geometry);if("Point"===I.type&&I.coordinates){const[g,C]=I.coordinates;if("number"==typeof g&&"number"==typeof C)return{lat:C,lng:g}}if("Polygon"===I.type&&I.coordinates&&I.coordinates.length>0){const g=I.coordinates[0];if(g.length>0){let I=0,C=0;for(const A of g)C+=A[0],I+=A[1];return{lat:I/g.length,lng:C/g.length}}}return null}function pI(I,g,C,A){const Z=(C-I)*Math.PI/180,l=(A-g)*Math.PI/180,G=Math.sin(Z/2)*Math.sin(Z/2)+Math.cos(I*Math.PI/180)*Math.cos(C*Math.PI/180)*Math.sin(l/2)*Math.sin(l/2);return 6371*(2*Math.atan2(Math.sqrt(G),Math.sqrt(1-G)))}function eI(I,g,C,A){const Z=nI(I);if(!Z)return!1;return 1e3*pI(Z.lat,Z.lng,C,g)<=A}function tI(I,g){if(!I||!g)return!1;const C=nI(g);if(!C)return!1;const A=nI(I);if(!A)return!1;if("Polygon"===g.type&&"Point"===I.type)return SI(A.lng,A.lat,g.coordinates[0]);if("Polygon"===I.type&&"Point"===g.type){const C=g.coordinates;return SI(C[0],C[1],I.coordinates[0])}if("Point"===I.type&&"Point"===g.type){return pI(A.lat,A.lng,C.lat,C.lng)<.001}return!1}function SI(I,g,C){let A=!1;for(let Z=0,l=C.length-1;Z<C.length;l=Z++){const G=C[Z][0],b=C[Z][1],c=C[l][0],d=C[l][1];b>g!=d>g&&I<(c-G)*(g-b)/(d-b)+G&&(A=!A)}return A}function NI(I,g){var C=Object.keys(g)[0],A=g[C];if("$"!=C.charAt(0))return FI(I,C,A);if("$and"==C)return wI(I,A);if("$or"==C)return function(I,g){for(var C=0;C<g.length;C++)if(NI(I,g[C]))return!0;return!1}(I,A);if("$not"==C)return function(I,g){return!NI(I,g)}(I,A);if("$nor"==C)return function(I,g){for(var C=0;C<g.length;C++)if(NI(I,g[C]))return!1;return!0}(I,A);if("$where"==C)return function(I,g){if("function"==typeof g)try{return g.call(I)}catch(C){return!1}else if("string"==typeof g)try{return new Function("return "+g).call(I)}catch(C){return!1}return!1}(I,A);if("$comment"==C)return!0;if("$jsonSchema"==C)return YI(I,A);if("$text"==C){return function(I,g){return!(!I||"object"!=typeof I)&&function I(C){if("string"==typeof C)return uI(C,g);if("object"!=typeof C||null===C)return!1;if(J(C)){for(let g=0;g<C.length;g++)if(I(C[g]))return!0;return!1}for(const g in C)if(C.hasOwnProperty(g)&&I(C[g]))return!0;return!1}(I)}(I,A.$search||A)}if("$expr"!=C)throw{$err:"Can't canonicalize query: BadValue unknown top level operator: "+C,code:17287};try{return cI(A,I)}catch(Z){return!1}}function FI(I,g,C){var A=function(I,g){for(var C=g.split("."),A=[I],Z=0;Z<C.length;Z++){for(var l=C[Z],G=parseInt(l,10),b=[],c=0;c<A.length;c++){var d=A[c];if(null!=d&&null!=d)if(J(d)&&!isNaN(G)&&G>=0)G<d.length&&b.push(d[G]);else if(J(d))for(var i=0;i<d.length;i++)null!=d[i]&&null!=d[i]&&"object"==typeof d[i]&&b.push(d[i][l]);else"object"==typeof d&&b.push(d[l])}A=b}if(0!==(A=A.filter(function(I){return void 0!==I})).length)return 1===A.length?A[0]:A}(I,g);if("string"==typeof C)return KI(A,function(I){return hI(I,C)});if("number"==typeof C)return KI(A,function(I){return hI(I,C)});if("boolean"==typeof C)return KI(A,function(I){return hI(I,C)});if(C instanceof N)return KI(A,function(I){return hI(I,C)});if("object"==typeof C){if(C instanceof RegExp)return null!=A&&KI(A,function(I){return I&&I.match(C)});if(J(C))return null!=A&&KI(A,function(I){return I&&v(I,C)});var Z=Object.keys(C);if("$"==Z[0].charAt(0)){for(var l=0;l<Z.length;l++){var G=Object.keys(C)[l],b=C[G];if("$eq"==G){if(!KI(A,function(I){return hI(I,b)}))return!1}else if("$gt"==G){if(!KI(A,function(I){return yI(I,b,">")}))return!1}else if("$gte"==G){if(!KI(A,function(I){return yI(I,b,">=")}))return!1}else if("$lt"==G){if(!KI(A,function(I){return yI(I,b,"<")}))return!1}else if("$lte"==G){if(!KI(A,function(I){return yI(I,b,"<=")}))return!1}else if("$ne"==G){if(!KI(A,function(I){return!hI(I,b)}))return!1}else if("$in"==G){if(!KI(A,function(I){return k(I,b)}))return!1}else if("$nin"==G){if(KI(A,function(I){return k(I,b)}))return!1}else if("$exists"==G){var c=w(I,g);if(b?null==c:null!=c)return!1}else if("$type"==G){if(void 0===A){if(6!==("number"==typeof b?b:BI[b]))return!1}else if(!mI(A,b))return!1}else if("$mod"==G){if(2!=b.length)throw{$err:"Can't canonicalize query: BadValue malformed mod, not enough elements",code:17287};if(!KI(A,function(I){return null!=I&&I%b[0]==b[1]}))return!1}else if("$regex"==G){var d=b,i=C.$options||"",B="string"==typeof d?new RegExp(d,i):d;if(!KI(A,function(I){return null!=I&&B.test(I)}))return!1}else{if("$options"==G)continue;if("$text"==G){if(!KI(A,function(I){return null!=I&&uI(I,b)}))return!1}else if("$expr"==G)try{if(!cI(b,I))return!1}catch(a){return!1}else if("$geoWithin"==G){if(!KI(A,function(I){return null!=I&&HI(I,b)}))return!1}else if("$near"==G||"$nearSphere"==G){let I;if(b.$geometry?I=b.$geometry.coordinates:b.coordinates?I=b.coordinates:Array.isArray(b)&&(I=b),!(I&&I.length>=2))return!1;{const[g,C]=I,Z=b.$maxDistance||1e6;if(!KI(A,function(I){return null!=I&&eI(I,g,C,Z)}))return!1}}else if("$geoIntersects"==G){const I=b.$geometry||b;if(!KI(A,function(g){return null!=g&&tI(g,I)}))return!1}else if("$not"==G){if(FI(I,g,b))return!1}else if("$all"==G){if(null==(W=w(I,g))||!J(W))return!1;for(var m=0;m<b.length;m++)if(!k(b[m],W))return!1}else if("$elemMatch"==G){var W;if(null==(W=w(I,g))||!J(W))return!1;var o=!1;for(m=0;m<W.length;m++){var V=W[m];if("object"!=typeof V||J(V)){for(var X=!0,s=Object.keys(b),Y=0;Y<s.length;Y++){var h=s[Y],y=b[h];("$gte"!=h||V>=y)&&("$gt"!=h||V>y)&&("$lte"!=h||V<=y)&&("$lt"!=h||V<y)?"$eq"==h&&V!=y||"$ne"==h&&V==y?X=!1:"$in"!=h||k(V,y)?"$nin"==h&&k(V,y)&&(X=!1):X=!1:X=!1}if(X){o=!0;break}}else if(JI(V,b)){o=!0;break}}if(!o)return!1}else if("$size"==G){var K=w(I,g);if(null==K||!J(K))return!1;if(K.length!=b)return!1}else if("$bitsAllSet"==G){if(!KI(A,function(I){return oI(I,b)}))return!1}else if("$bitsAllClear"==G){if(!KI(A,function(I){return VI(I,b)}))return!1}else if("$bitsAnySet"==G){if(!KI(A,function(I){return XI(I,b)}))return!1}else{if("$bitsAnyClear"!=G)throw{$err:"Can't canonicalize query: BadValue unknown operator: "+G,code:17287};if(!KI(A,function(I){return sI(I,b)}))return!1}}}return!0}return w(I,g)&&z(w(I,g),C)}}function wI(I,g){for(var C=0;C<g.length;C++)if(!NI(I,g[C]))return!1;return!0}function JI(I,g){return wI(I,function(I){var g=[];for(var C in I)if(I.hasOwnProperty(C)){var A={};A[C]=I[C],g.push(A)}return g}(g))}class kI extends C.EventEmitter{constructor(I,g=[],C={}){super(),this.target=I,this.pipeline=g,this.options=C,this.closed=!1,this._listeners=/* @__PURE__ */new Map,this._changeCounter=0,this._startWatching()}_startWatching(){if(this.closed)return;const I=this._getCollectionsToWatch();for(const g of I)this._watchCollection(g);"DB"===this.target.constructor.name&&this._interceptDBCollectionCreation(),"MongoClient"===this.target.constructor.name&&this._interceptClientDBCreation()}_getCollectionsToWatch(){const I=[];if("MongoClient"===this.target.constructor.name)return this._monitorClient(),I;if("DB"===this.target.constructor.name){const g=this.target.getCollectionNames();for(const C of g){const g=this.target[C];g&&g.isCollection&&I.push(g)}this._monitorDB()}return this.target.isCollection&&I.push(this.target),I}_watchCollection(I){if(this.closed)return;if(!I)return;if("function"!=typeof I.on)return;if(!I.isCollection)return;if(this._listeners.has(I))return;const g={insert:g=>this._emitChange("insert",I,g),update:(g,C)=>this._emitChange("update",I,g,C),replace:g=>this._emitChange("replace",I,g),delete:g=>this._emitChange("delete",I,g)};this._listeners.set(I,g),I.on("insert",g.insert),I.on("update",g.update),I.on("replace",g.replace),I.on("delete",g.delete)}_emitChange(I,g,C,A=null){if(this.closed)return;const Z=this._createChangeEvent(I,g,C,A);this._matchesPipeline(Z)&&this.emit("change",Z)}_createChangeEvent(I,g,C,A){const Z={_id:{_data:Buffer.from(String(++this._changeCounter)).toString("base64")},operationType:I,clusterTime:/* @__PURE__ */new Date,ns:{db:g.db.dbName,coll:g.name},documentKey:{_id:C._id}};switch(I){case"insert":case"replace":Z.fullDocument=C;break;case"update":Z.updateDescription=A||{updatedFields:{},removedFields:[],truncatedArrays:[]},"updateLookup"===this.options.fullDocument&&(Z.fullDocument=C)}return Z}_matchesPipeline(I){if(!this.pipeline||0===this.pipeline.length)return!0;for(const g of this.pipeline)if(g.$match&&!JI(I,g.$match))return!1;return!0}_getNestedValue(I,g){return g.split(".").reduce((I,g)=>I?.[g],I)}_monitorClient(){}_interceptClientDBCreation(){const I=this.target,g=I.db.bind(I),C=this;this._watchedDBs=/* @__PURE__ */new Map,I.db=function(I,A){const Z=g(I,A),l=Z.dbName;if(!C._watchedDBs.has(l)){C._watchedDBs.set(l,Z);const I=Z.getCollectionNames();for(const g of I){const I=Z[g];I&&I.isCollection&&!C._listeners.has(I)&&C._watchCollection(I)}C._interceptDBCollectionCreationForClient(Z)}return Z},this._originalClientMethods={db:g}}_interceptDBCollectionCreationForClient(I){const g=I.collection.bind(I),C=I.createCollection.bind(I),A=this;I.collection=function(I){const C=g(I);return C&&C.isCollection&&!A._listeners.has(C)&&A._watchCollection(C),C},I.createCollection=function(g){C(g);const Z=I[g];Z&&Z.isCollection&&!A._listeners.has(Z)&&A._watchCollection(Z)}}_monitorDB(){}_interceptDBCollectionCreation(){const I=this.target,g=I.collection.bind(I),C=I.createCollection.bind(I),A=this;I.collection=function(I){const C=g(I);return C&&C.isCollection&&!A._listeners.has(C)&&A._watchCollection(C),C},I.createCollection=function(g){C(g);const Z=I[g];Z&&Z.isCollection&&!A._listeners.has(Z)&&A._watchCollection(Z)},this._originalDBMethods={collection:g,createCollection:C}}close(){if(!this.closed){this.closed=!0;for(const[I,g]of this._listeners)I.off("insert",g.insert),I.off("update",g.update),I.off("replace",g.replace),I.off("delete",g.delete);this._listeners.clear(),this._originalDBMethods&&"DB"===this.target.constructor.name&&(this.target.collection=this._originalDBMethods.collection,this.target.createCollection=this._originalDBMethods.createCollection),this._originalClientMethods&&"MongoClient"===this.target.constructor.name&&(this.target.db=this._originalClientMethods.db),this.emit("close"),this.removeAllListeners()}}get isClosed(){return this.closed}async*[Symbol.asyncIterator](){const I=[];let g=null,C=!1;const A=C=>{g?(g({value:C,done:!1}),g=null):I.push(C)},Z=()=>{C=!0,g&&(g({done:!0}),g=null)},l=I=>{g&&(g(Promise.reject(I)),g=null)};this.on("change",A),this.on("close",Z),this.on("error",l);try{for(;!C;)if(I.length>0)yield I.shift();else{const I=await new Promise(I=>{g=I,C&&I({done:!0})});if(I.done)break;yield I.value}}finally{this.off("change",A),this.off("close",Z),this.off("error",l)}}async next(){return new Promise((I,g)=>{const C=g=>{l(),I(g)},A=()=>{l(),I(null)},Z=I=>{l(),g(I)},l=()=>{this.off("change",C),this.off("close",A),this.off("error",Z)};this.closed?I(null):(this.once("change",C),this.once("close",A),this.once("error",Z))})}}function vI(I){if(null==I)return I;if(I instanceof N)return{__objectId:I.toString()};if(Array.isArray(I))return I.map(vI);if("object"==typeof I){const g={};for(const[C,A]of Object.entries(I))g[C]=vI(A);return g}return I}function zI(I){if(null==I)return I;if("object"==typeof I&&I.__objectId)return new N(I.__objectId);if(Array.isArray(I))return I.map(zI);if("object"==typeof I){const g={};for(const[C,A]of Object.entries(I))g[C]=zI(A);return g}return I}class rI extends C.EventEmitter{constructor(I){super(),this.worker=I,this._nextId=1,this._pending=/* @__PURE__ */new Map,this._terminating=!1,this._handleMessage=this._handleMessage.bind(this),this._handleError=this._handleError.bind(this),this._attach()}static async create(I={}){if("undefined"!=typeof window&&void 0!==globalThis.Worker)return new QI(I);const{Worker:g}=await Promise.resolve().then(()=>UI),{fileURLToPath:C}=await Promise.resolve().then(()=>UI);let A=I.workerPath;if(!A){A=C(new URL("data:text/javascript;base64,dmFyIGV2ZW50cyA9IHsgZXhwb3J0czoge30gfTsKdmFyIGhhc1JlcXVpcmVkRXZlbnRzOwpmdW5jdGlvbiByZXF1aXJlRXZlbnRzKCkgewogIGlmIChoYXNSZXF1aXJlZEV2ZW50cykgcmV0dXJuIGV2ZW50cy5leHBvcnRzOwogIGhhc1JlcXVpcmVkRXZlbnRzID0gMTsKICB2YXIgUiA9IHR5cGVvZiBSZWZsZWN0ID09PSAib2JqZWN0IiA/IFJlZmxlY3QgOiBudWxsOwogIHZhciBSZWZsZWN0QXBwbHkgPSBSICYmIHR5cGVvZiBSLmFwcGx5ID09PSAiZnVuY3Rpb24iID8gUi5hcHBseSA6IGZ1bmN0aW9uIFJlZmxlY3RBcHBseTIodGFyZ2V0LCByZWNlaXZlciwgYXJncykgewogICAgcmV0dXJuIEZ1bmN0aW9uLnByb3RvdHlwZS5hcHBseS5jYWxsKHRhcmdldCwgcmVjZWl2ZXIsIGFyZ3MpOwogIH07CiAgdmFyIFJlZmxlY3RPd25LZXlzOwogIGlmIChSICYmIHR5cGVvZiBSLm93bktleXMgPT09ICJmdW5jdGlvbiIpIHsKICAgIFJlZmxlY3RPd25LZXlzID0gUi5vd25LZXlzOwogIH0gZWxzZSBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgUmVmbGVjdE93bktleXMgPSBmdW5jdGlvbiBSZWZsZWN0T3duS2V5czIodGFyZ2V0KSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyh0YXJnZXQpLmNvbmNhdChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKHRhcmdldCkpOwogICAgfTsKICB9IGVsc2UgewogICAgUmVmbGVjdE93bktleXMgPSBmdW5jdGlvbiBSZWZsZWN0T3duS2V5czIodGFyZ2V0KSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyh0YXJnZXQpOwogICAgfTsKICB9CiAgZnVuY3Rpb24gUHJvY2Vzc0VtaXRXYXJuaW5nKHdhcm5pbmcpIHsKICAgIGlmIChjb25zb2xlICYmIGNvbnNvbGUud2FybikgY29uc29sZS53YXJuKHdhcm5pbmcpOwogIH0KICB2YXIgTnVtYmVySXNOYU4gPSBOdW1iZXIuaXNOYU4gfHwgZnVuY3Rpb24gTnVtYmVySXNOYU4yKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgIT09IHZhbHVlOwogIH07CiAgZnVuY3Rpb24gRXZlbnRFbWl0dGVyKCkgewogICAgRXZlbnRFbWl0dGVyLmluaXQuY2FsbCh0aGlzKTsKICB9CiAgZXZlbnRzLmV4cG9ydHMgPSBFdmVudEVtaXR0ZXI7CiAgZXZlbnRzLmV4cG9ydHMub25jZSA9IG9uY2U7CiAgRXZlbnRFbWl0dGVyLkV2ZW50RW1pdHRlciA9IEV2ZW50RW1pdHRlcjsKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLl9ldmVudHMgPSB2b2lkIDA7CiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5fZXZlbnRzQ291bnQgPSAwOwogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUuX21heExpc3RlbmVycyA9IHZvaWQgMDsKICB2YXIgZGVmYXVsdE1heExpc3RlbmVycyA9IDEwOwogIGZ1bmN0aW9uIGNoZWNrTGlzdGVuZXIobGlzdGVuZXIpIHsKICAgIGlmICh0eXBlb2YgbGlzdGVuZXIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignVGhlICJsaXN0ZW5lciIgYXJndW1lbnQgbXVzdCBiZSBvZiB0eXBlIEZ1bmN0aW9uLiBSZWNlaXZlZCB0eXBlICcgKyB0eXBlb2YgbGlzdGVuZXIpOwogICAgfQogIH0KICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRXZlbnRFbWl0dGVyLCAiZGVmYXVsdE1heExpc3RlbmVycyIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gZGVmYXVsdE1heExpc3RlbmVyczsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uKGFyZykgewogICAgICBpZiAodHlwZW9mIGFyZyAhPT0gIm51bWJlciIgfHwgYXJnIDwgMCB8fCBOdW1iZXJJc05hTihhcmcpKSB7CiAgICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ1RoZSB2YWx1ZSBvZiAiZGVmYXVsdE1heExpc3RlbmVycyIgaXMgb3V0IG9mIHJhbmdlLiBJdCBtdXN0IGJlIGEgbm9uLW5lZ2F0aXZlIG51bWJlci4gUmVjZWl2ZWQgJyArIGFyZyArICIuIik7CiAgICAgIH0KICAgICAgZGVmYXVsdE1heExpc3RlbmVycyA9IGFyZzsKICAgIH0KICB9KTsKICBFdmVudEVtaXR0ZXIuaW5pdCA9IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXMuX2V2ZW50cyA9PT0gdm9pZCAwIHx8IHRoaXMuX2V2ZW50cyA9PT0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpLl9ldmVudHMpIHsKICAgICAgdGhpcy5fZXZlbnRzID0gLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIHRoaXMuX2V2ZW50c0NvdW50ID0gMDsKICAgIH0KICAgIHRoaXMuX21heExpc3RlbmVycyA9IHRoaXMuX21heExpc3RlbmVycyB8fCB2b2lkIDA7CiAgfTsKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLnNldE1heExpc3RlbmVycyA9IGZ1bmN0aW9uIHNldE1heExpc3RlbmVycyhuKSB7CiAgICBpZiAodHlwZW9mIG4gIT09ICJudW1iZXIiIHx8IG4gPCAwIHx8IE51bWJlcklzTmFOKG4pKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdUaGUgdmFsdWUgb2YgIm4iIGlzIG91dCBvZiByYW5nZS4gSXQgbXVzdCBiZSBhIG5vbi1uZWdhdGl2ZSBudW1iZXIuIFJlY2VpdmVkICcgKyBuICsgIi4iKTsKICAgIH0KICAgIHRoaXMuX21heExpc3RlbmVycyA9IG47CiAgICByZXR1cm4gdGhpczsKICB9OwogIGZ1bmN0aW9uIF9nZXRNYXhMaXN0ZW5lcnModGhhdCkgewogICAgaWYgKHRoYXQuX21heExpc3RlbmVycyA9PT0gdm9pZCAwKQogICAgICByZXR1cm4gRXZlbnRFbWl0dGVyLmRlZmF1bHRNYXhMaXN0ZW5lcnM7CiAgICByZXR1cm4gdGhhdC5fbWF4TGlzdGVuZXJzOwogIH0KICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLmdldE1heExpc3RlbmVycyA9IGZ1bmN0aW9uIGdldE1heExpc3RlbmVycygpIHsKICAgIHJldHVybiBfZ2V0TWF4TGlzdGVuZXJzKHRoaXMpOwogIH07CiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5lbWl0ID0gZnVuY3Rpb24gZW1pdCh0eXBlKSB7CiAgICB2YXIgYXJncyA9IFtdOwogICAgZm9yICh2YXIgaSA9IDE7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIGFyZ3MucHVzaChhcmd1bWVudHNbaV0pOwogICAgdmFyIGRvRXJyb3IgPSB0eXBlID09PSAiZXJyb3IiOwogICAgdmFyIGV2ZW50czIgPSB0aGlzLl9ldmVudHM7CiAgICBpZiAoZXZlbnRzMiAhPT0gdm9pZCAwKQogICAgICBkb0Vycm9yID0gZG9FcnJvciAmJiBldmVudHMyLmVycm9yID09PSB2b2lkIDA7CiAgICBlbHNlIGlmICghZG9FcnJvcikKICAgICAgcmV0dXJuIGZhbHNlOwogICAgaWYgKGRvRXJyb3IpIHsKICAgICAgdmFyIGVyOwogICAgICBpZiAoYXJncy5sZW5ndGggPiAwKQogICAgICAgIGVyID0gYXJnc1swXTsKICAgICAgaWYgKGVyIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgICB0aHJvdyBlcjsKICAgICAgfQogICAgICB2YXIgZXJyID0gbmV3IEVycm9yKCJVbmhhbmRsZWQgZXJyb3IuIiArIChlciA/ICIgKCIgKyBlci5tZXNzYWdlICsgIikiIDogIiIpKTsKICAgICAgZXJyLmNvbnRleHQgPSBlcjsKICAgICAgdGhyb3cgZXJyOwogICAgfQogICAgdmFyIGhhbmRsZXIgPSBldmVudHMyW3R5cGVdOwogICAgaWYgKGhhbmRsZXIgPT09IHZvaWQgMCkKICAgICAgcmV0dXJuIGZhbHNlOwogICAgaWYgKHR5cGVvZiBoYW5kbGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIFJlZmxlY3RBcHBseShoYW5kbGVyLCB0aGlzLCBhcmdzKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBsZW4gPSBoYW5kbGVyLmxlbmd0aDsKICAgICAgdmFyIGxpc3RlbmVycyA9IGFycmF5Q2xvbmUoaGFuZGxlciwgbGVuKTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47ICsraSkKICAgICAgICBSZWZsZWN0QXBwbHkobGlzdGVuZXJzW2ldLCB0aGlzLCBhcmdzKTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH07CiAgZnVuY3Rpb24gX2FkZExpc3RlbmVyKHRhcmdldCwgdHlwZSwgbGlzdGVuZXIsIHByZXBlbmQpIHsKICAgIHZhciBtOwogICAgdmFyIGV2ZW50czI7CiAgICB2YXIgZXhpc3Rpbmc7CiAgICBjaGVja0xpc3RlbmVyKGxpc3RlbmVyKTsKICAgIGV2ZW50czIgPSB0YXJnZXQuX2V2ZW50czsKICAgIGlmIChldmVudHMyID09PSB2b2lkIDApIHsKICAgICAgZXZlbnRzMiA9IHRhcmdldC5fZXZlbnRzID0gLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIHRhcmdldC5fZXZlbnRzQ291bnQgPSAwOwogICAgfSBlbHNlIHsKICAgICAgaWYgKGV2ZW50czIubmV3TGlzdGVuZXIgIT09IHZvaWQgMCkgewogICAgICAgIHRhcmdldC5lbWl0KAogICAgICAgICAgIm5ld0xpc3RlbmVyIiwKICAgICAgICAgIHR5cGUsCiAgICAgICAgICBsaXN0ZW5lci5saXN0ZW5lciA/IGxpc3RlbmVyLmxpc3RlbmVyIDogbGlzdGVuZXIKICAgICAgICApOwogICAgICAgIGV2ZW50czIgPSB0YXJnZXQuX2V2ZW50czsKICAgICAgfQogICAgICBleGlzdGluZyA9IGV2ZW50czJbdHlwZV07CiAgICB9CiAgICBpZiAoZXhpc3RpbmcgPT09IHZvaWQgMCkgewogICAgICBleGlzdGluZyA9IGV2ZW50czJbdHlwZV0gPSBsaXN0ZW5lcjsKICAgICAgKyt0YXJnZXQuX2V2ZW50c0NvdW50OwogICAgfSBlbHNlIHsKICAgICAgaWYgKHR5cGVvZiBleGlzdGluZyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIGV4aXN0aW5nID0gZXZlbnRzMlt0eXBlXSA9IHByZXBlbmQgPyBbbGlzdGVuZXIsIGV4aXN0aW5nXSA6IFtleGlzdGluZywgbGlzdGVuZXJdOwogICAgICB9IGVsc2UgaWYgKHByZXBlbmQpIHsKICAgICAgICBleGlzdGluZy51bnNoaWZ0KGxpc3RlbmVyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBleGlzdGluZy5wdXNoKGxpc3RlbmVyKTsKICAgICAgfQogICAgICBtID0gX2dldE1heExpc3RlbmVycyh0YXJnZXQpOwogICAgICBpZiAobSA+IDAgJiYgZXhpc3RpbmcubGVuZ3RoID4gbSAmJiAhZXhpc3Rpbmcud2FybmVkKSB7CiAgICAgICAgZXhpc3Rpbmcud2FybmVkID0gdHJ1ZTsKICAgICAgICB2YXIgdyA9IG5ldyBFcnJvcigiUG9zc2libGUgRXZlbnRFbWl0dGVyIG1lbW9yeSBsZWFrIGRldGVjdGVkLiAiICsgZXhpc3RpbmcubGVuZ3RoICsgIiAiICsgU3RyaW5nKHR5cGUpICsgIiBsaXN0ZW5lcnMgYWRkZWQuIFVzZSBlbWl0dGVyLnNldE1heExpc3RlbmVycygpIHRvIGluY3JlYXNlIGxpbWl0Iik7CiAgICAgICAgdy5uYW1lID0gIk1heExpc3RlbmVyc0V4Y2VlZGVkV2FybmluZyI7CiAgICAgICAgdy5lbWl0dGVyID0gdGFyZ2V0OwogICAgICAgIHcudHlwZSA9IHR5cGU7CiAgICAgICAgdy5jb3VudCA9IGV4aXN0aW5nLmxlbmd0aDsKICAgICAgICBQcm9jZXNzRW1pdFdhcm5pbmcodyk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0YXJnZXQ7CiAgfQogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUuYWRkTGlzdGVuZXIgPSBmdW5jdGlvbiBhZGRMaXN0ZW5lcih0eXBlLCBsaXN0ZW5lcikgewogICAgcmV0dXJuIF9hZGRMaXN0ZW5lcih0aGlzLCB0eXBlLCBsaXN0ZW5lciwgZmFsc2UpOwogIH07CiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5vbiA9IEV2ZW50RW1pdHRlci5wcm90b3R5cGUuYWRkTGlzdGVuZXI7CiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5wcmVwZW5kTGlzdGVuZXIgPSBmdW5jdGlvbiBwcmVwZW5kTGlzdGVuZXIodHlwZSwgbGlzdGVuZXIpIHsKICAgIHJldHVybiBfYWRkTGlzdGVuZXIodGhpcywgdHlwZSwgbGlzdGVuZXIsIHRydWUpOwogIH07CiAgZnVuY3Rpb24gb25jZVdyYXBwZXIoKSB7CiAgICBpZiAoIXRoaXMuZmlyZWQpIHsKICAgICAgdGhpcy50YXJnZXQucmVtb3ZlTGlzdGVuZXIodGhpcy50eXBlLCB0aGlzLndyYXBGbik7CiAgICAgIHRoaXMuZmlyZWQgPSB0cnVlOwogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkKICAgICAgICByZXR1cm4gdGhpcy5saXN0ZW5lci5jYWxsKHRoaXMudGFyZ2V0KTsKICAgICAgcmV0dXJuIHRoaXMubGlzdGVuZXIuYXBwbHkodGhpcy50YXJnZXQsIGFyZ3VtZW50cyk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIF9vbmNlV3JhcCh0YXJnZXQsIHR5cGUsIGxpc3RlbmVyKSB7CiAgICB2YXIgc3RhdGUgPSB7IGZpcmVkOiBmYWxzZSwgd3JhcEZuOiB2b2lkIDAsIHRhcmdldCwgdHlwZSwgbGlzdGVuZXIgfTsKICAgIHZhciB3cmFwcGVkID0gb25jZVdyYXBwZXIuYmluZChzdGF0ZSk7CiAgICB3cmFwcGVkLmxpc3RlbmVyID0gbGlzdGVuZXI7CiAgICBzdGF0ZS53cmFwRm4gPSB3cmFwcGVkOwogICAgcmV0dXJuIHdyYXBwZWQ7CiAgfQogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUub25jZSA9IGZ1bmN0aW9uIG9uY2UyKHR5cGUsIGxpc3RlbmVyKSB7CiAgICBjaGVja0xpc3RlbmVyKGxpc3RlbmVyKTsKICAgIHRoaXMub24odHlwZSwgX29uY2VXcmFwKHRoaXMsIHR5cGUsIGxpc3RlbmVyKSk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUucHJlcGVuZE9uY2VMaXN0ZW5lciA9IGZ1bmN0aW9uIHByZXBlbmRPbmNlTGlzdGVuZXIodHlwZSwgbGlzdGVuZXIpIHsKICAgIGNoZWNrTGlzdGVuZXIobGlzdGVuZXIpOwogICAgdGhpcy5wcmVwZW5kTGlzdGVuZXIodHlwZSwgX29uY2VXcmFwKHRoaXMsIHR5cGUsIGxpc3RlbmVyKSk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUucmVtb3ZlTGlzdGVuZXIgPSBmdW5jdGlvbiByZW1vdmVMaXN0ZW5lcih0eXBlLCBsaXN0ZW5lcikgewogICAgdmFyIGxpc3QsIGV2ZW50czIsIHBvc2l0aW9uLCBpLCBvcmlnaW5hbExpc3RlbmVyOwogICAgY2hlY2tMaXN0ZW5lcihsaXN0ZW5lcik7CiAgICBldmVudHMyID0gdGhpcy5fZXZlbnRzOwogICAgaWYgKGV2ZW50czIgPT09IHZvaWQgMCkKICAgICAgcmV0dXJuIHRoaXM7CiAgICBsaXN0ID0gZXZlbnRzMlt0eXBlXTsKICAgIGlmIChsaXN0ID09PSB2b2lkIDApCiAgICAgIHJldHVybiB0aGlzOwogICAgaWYgKGxpc3QgPT09IGxpc3RlbmVyIHx8IGxpc3QubGlzdGVuZXIgPT09IGxpc3RlbmVyKSB7CiAgICAgIGlmICgtLXRoaXMuX2V2ZW50c0NvdW50ID09PSAwKQogICAgICAgIHRoaXMuX2V2ZW50cyA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICBlbHNlIHsKICAgICAgICBkZWxldGUgZXZlbnRzMlt0eXBlXTsKICAgICAgICBpZiAoZXZlbnRzMi5yZW1vdmVMaXN0ZW5lcikKICAgICAgICAgIHRoaXMuZW1pdCgicmVtb3ZlTGlzdGVuZXIiLCB0eXBlLCBsaXN0Lmxpc3RlbmVyIHx8IGxpc3RlbmVyKTsKICAgICAgfQogICAgfSBlbHNlIGlmICh0eXBlb2YgbGlzdCAhPT0gImZ1bmN0aW9uIikgewogICAgICBwb3NpdGlvbiA9IC0xOwogICAgICBmb3IgKGkgPSBsaXN0Lmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgaWYgKGxpc3RbaV0gPT09IGxpc3RlbmVyIHx8IGxpc3RbaV0ubGlzdGVuZXIgPT09IGxpc3RlbmVyKSB7CiAgICAgICAgICBvcmlnaW5hbExpc3RlbmVyID0gbGlzdFtpXS5saXN0ZW5lcjsKICAgICAgICAgIHBvc2l0aW9uID0gaTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAocG9zaXRpb24gPCAwKQogICAgICAgIHJldHVybiB0aGlzOwogICAgICBpZiAocG9zaXRpb24gPT09IDApCiAgICAgICAgbGlzdC5zaGlmdCgpOwogICAgICBlbHNlIHsKICAgICAgICBzcGxpY2VPbmUobGlzdCwgcG9zaXRpb24pOwogICAgICB9CiAgICAgIGlmIChsaXN0Lmxlbmd0aCA9PT0gMSkKICAgICAgICBldmVudHMyW3R5cGVdID0gbGlzdFswXTsKICAgICAgaWYgKGV2ZW50czIucmVtb3ZlTGlzdGVuZXIgIT09IHZvaWQgMCkKICAgICAgICB0aGlzLmVtaXQoInJlbW92ZUxpc3RlbmVyIiwgdHlwZSwgb3JpZ2luYWxMaXN0ZW5lciB8fCBsaXN0ZW5lcik7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9OwogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUub2ZmID0gRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5yZW1vdmVMaXN0ZW5lcjsKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLnJlbW92ZUFsbExpc3RlbmVycyA9IGZ1bmN0aW9uIHJlbW92ZUFsbExpc3RlbmVycyh0eXBlKSB7CiAgICB2YXIgbGlzdGVuZXJzLCBldmVudHMyLCBpOwogICAgZXZlbnRzMiA9IHRoaXMuX2V2ZW50czsKICAgIGlmIChldmVudHMyID09PSB2b2lkIDApCiAgICAgIHJldHVybiB0aGlzOwogICAgaWYgKGV2ZW50czIucmVtb3ZlTGlzdGVuZXIgPT09IHZvaWQgMCkgewogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHRoaXMuX2V2ZW50cyA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICAgIHRoaXMuX2V2ZW50c0NvdW50ID0gMDsKICAgICAgfSBlbHNlIGlmIChldmVudHMyW3R5cGVdICE9PSB2b2lkIDApIHsKICAgICAgICBpZiAoLS10aGlzLl9ldmVudHNDb3VudCA9PT0gMCkKICAgICAgICAgIHRoaXMuX2V2ZW50cyA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICAgIGVsc2UKICAgICAgICAgIGRlbGV0ZSBldmVudHMyW3R5cGVdOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHsKICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhldmVudHMyKTsKICAgICAgdmFyIGtleTsKICAgICAgZm9yIChpID0gMDsgaSA8IGtleXMubGVuZ3RoOyArK2kpIHsKICAgICAgICBrZXkgPSBrZXlzW2ldOwogICAgICAgIGlmIChrZXkgPT09ICJyZW1vdmVMaXN0ZW5lciIpIGNvbnRpbnVlOwogICAgICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKGtleSk7CiAgICAgIH0KICAgICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoInJlbW92ZUxpc3RlbmVyIik7CiAgICAgIHRoaXMuX2V2ZW50cyA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICB0aGlzLl9ldmVudHNDb3VudCA9IDA7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgbGlzdGVuZXJzID0gZXZlbnRzMlt0eXBlXTsKICAgIGlmICh0eXBlb2YgbGlzdGVuZXJzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIodHlwZSwgbGlzdGVuZXJzKTsKICAgIH0gZWxzZSBpZiAobGlzdGVuZXJzICE9PSB2b2lkIDApIHsKICAgICAgZm9yIChpID0gbGlzdGVuZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCBsaXN0ZW5lcnNbaV0pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9OwogIGZ1bmN0aW9uIF9saXN0ZW5lcnModGFyZ2V0LCB0eXBlLCB1bndyYXApIHsKICAgIHZhciBldmVudHMyID0gdGFyZ2V0Ll9ldmVudHM7CiAgICBpZiAoZXZlbnRzMiA9PT0gdm9pZCAwKQogICAgICByZXR1cm4gW107CiAgICB2YXIgZXZsaXN0ZW5lciA9IGV2ZW50czJbdHlwZV07CiAgICBpZiAoZXZsaXN0ZW5lciA9PT0gdm9pZCAwKQogICAgICByZXR1cm4gW107CiAgICBpZiAodHlwZW9mIGV2bGlzdGVuZXIgPT09ICJmdW5jdGlvbiIpCiAgICAgIHJldHVybiB1bndyYXAgPyBbZXZsaXN0ZW5lci5saXN0ZW5lciB8fCBldmxpc3RlbmVyXSA6IFtldmxpc3RlbmVyXTsKICAgIHJldHVybiB1bndyYXAgPyB1bndyYXBMaXN0ZW5lcnMoZXZsaXN0ZW5lcikgOiBhcnJheUNsb25lKGV2bGlzdGVuZXIsIGV2bGlzdGVuZXIubGVuZ3RoKTsKICB9CiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5saXN0ZW5lcnMgPSBmdW5jdGlvbiBsaXN0ZW5lcnModHlwZSkgewogICAgcmV0dXJuIF9saXN0ZW5lcnModGhpcywgdHlwZSwgdHJ1ZSk7CiAgfTsKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLnJhd0xpc3RlbmVycyA9IGZ1bmN0aW9uIHJhd0xpc3RlbmVycyh0eXBlKSB7CiAgICByZXR1cm4gX2xpc3RlbmVycyh0aGlzLCB0eXBlLCBmYWxzZSk7CiAgfTsKICBFdmVudEVtaXR0ZXIubGlzdGVuZXJDb3VudCA9IGZ1bmN0aW9uKGVtaXR0ZXIsIHR5cGUpIHsKICAgIGlmICh0eXBlb2YgZW1pdHRlci5saXN0ZW5lckNvdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHJldHVybiBlbWl0dGVyLmxpc3RlbmVyQ291bnQodHlwZSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbGlzdGVuZXJDb3VudC5jYWxsKGVtaXR0ZXIsIHR5cGUpOwogICAgfQogIH07CiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5saXN0ZW5lckNvdW50ID0gbGlzdGVuZXJDb3VudDsKICBmdW5jdGlvbiBsaXN0ZW5lckNvdW50KHR5cGUpIHsKICAgIHZhciBldmVudHMyID0gdGhpcy5fZXZlbnRzOwogICAgaWYgKGV2ZW50czIgIT09IHZvaWQgMCkgewogICAgICB2YXIgZXZsaXN0ZW5lciA9IGV2ZW50czJbdHlwZV07CiAgICAgIGlmICh0eXBlb2YgZXZsaXN0ZW5lciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHJldHVybiAxOwogICAgICB9IGVsc2UgaWYgKGV2bGlzdGVuZXIgIT09IHZvaWQgMCkgewogICAgICAgIHJldHVybiBldmxpc3RlbmVyLmxlbmd0aDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIDA7CiAgfQogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUuZXZlbnROYW1lcyA9IGZ1bmN0aW9uIGV2ZW50TmFtZXMoKSB7CiAgICByZXR1cm4gdGhpcy5fZXZlbnRzQ291bnQgPiAwID8gUmVmbGVjdE93bktleXModGhpcy5fZXZlbnRzKSA6IFtdOwogIH07CiAgZnVuY3Rpb24gYXJyYXlDbG9uZShhcnIsIG4pIHsKICAgIHZhciBjb3B5MiA9IG5ldyBBcnJheShuKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbjsgKytpKQogICAgICBjb3B5MltpXSA9IGFycltpXTsKICAgIHJldHVybiBjb3B5MjsKICB9CiAgZnVuY3Rpb24gc3BsaWNlT25lKGxpc3QsIGluZGV4KSB7CiAgICBmb3IgKDsgaW5kZXggKyAxIDwgbGlzdC5sZW5ndGg7IGluZGV4KyspCiAgICAgIGxpc3RbaW5kZXhdID0gbGlzdFtpbmRleCArIDFdOwogICAgbGlzdC5wb3AoKTsKICB9CiAgZnVuY3Rpb24gdW53cmFwTGlzdGVuZXJzKGFycikgewogICAgdmFyIHJldCA9IG5ldyBBcnJheShhcnIubGVuZ3RoKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmV0Lmxlbmd0aDsgKytpKSB7CiAgICAgIHJldFtpXSA9IGFycltpXS5saXN0ZW5lciB8fCBhcnJbaV07CiAgICB9CiAgICByZXR1cm4gcmV0OwogIH0KICBmdW5jdGlvbiBvbmNlKGVtaXR0ZXIsIG5hbWUpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgZnVuY3Rpb24gZXJyb3JMaXN0ZW5lcihlcnIpIHsKICAgICAgICBlbWl0dGVyLnJlbW92ZUxpc3RlbmVyKG5hbWUsIHJlc29sdmVyKTsKICAgICAgICByZWplY3QoZXJyKTsKICAgICAgfQogICAgICBmdW5jdGlvbiByZXNvbHZlcigpIHsKICAgICAgICBpZiAodHlwZW9mIGVtaXR0ZXIucmVtb3ZlTGlzdGVuZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIGVtaXR0ZXIucmVtb3ZlTGlzdGVuZXIoImVycm9yIiwgZXJyb3JMaXN0ZW5lcik7CiAgICAgICAgfQogICAgICAgIHJlc29sdmUoW10uc2xpY2UuY2FsbChhcmd1bWVudHMpKTsKICAgICAgfQogICAgICBldmVudFRhcmdldEFnbm9zdGljQWRkTGlzdGVuZXIoZW1pdHRlciwgbmFtZSwgcmVzb2x2ZXIsIHsgb25jZTogdHJ1ZSB9KTsKICAgICAgaWYgKG5hbWUgIT09ICJlcnJvciIpIHsKICAgICAgICBhZGRFcnJvckhhbmRsZXJJZkV2ZW50RW1pdHRlcihlbWl0dGVyLCBlcnJvckxpc3RlbmVyLCB7IG9uY2U6IHRydWUgfSk7CiAgICAgIH0KICAgIH0pOwogIH0KICBmdW5jdGlvbiBhZGRFcnJvckhhbmRsZXJJZkV2ZW50RW1pdHRlcihlbWl0dGVyLCBoYW5kbGVyLCBmbGFncykgewogICAgaWYgKHR5cGVvZiBlbWl0dGVyLm9uID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIGV2ZW50VGFyZ2V0QWdub3N0aWNBZGRMaXN0ZW5lcihlbWl0dGVyLCAiZXJyb3IiLCBoYW5kbGVyLCBmbGFncyk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGV2ZW50VGFyZ2V0QWdub3N0aWNBZGRMaXN0ZW5lcihlbWl0dGVyLCBuYW1lLCBsaXN0ZW5lciwgZmxhZ3MpIHsKICAgIGlmICh0eXBlb2YgZW1pdHRlci5vbiA9PT0gImZ1bmN0aW9uIikgewogICAgICBpZiAoZmxhZ3Mub25jZSkgewogICAgICAgIGVtaXR0ZXIub25jZShuYW1lLCBsaXN0ZW5lcik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZW1pdHRlci5vbihuYW1lLCBsaXN0ZW5lcik7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAodHlwZW9mIGVtaXR0ZXIuYWRkRXZlbnRMaXN0ZW5lciA9PT0gImZ1bmN0aW9uIikgewogICAgICBlbWl0dGVyLmFkZEV2ZW50TGlzdGVuZXIobmFtZSwgZnVuY3Rpb24gd3JhcExpc3RlbmVyKGFyZykgewogICAgICAgIGlmIChmbGFncy5vbmNlKSB7CiAgICAgICAgICBlbWl0dGVyLnJlbW92ZUV2ZW50TGlzdGVuZXIobmFtZSwgd3JhcExpc3RlbmVyKTsKICAgICAgICB9CiAgICAgICAgbGlzdGVuZXIoYXJnKTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdUaGUgImVtaXR0ZXIiIGFyZ3VtZW50IG11c3QgYmUgb2YgdHlwZSBFdmVudEVtaXR0ZXIuIFJlY2VpdmVkIHR5cGUgJyArIHR5cGVvZiBlbWl0dGVyKTsKICAgIH0KICB9CiAgcmV0dXJuIGV2ZW50cy5leHBvcnRzOwp9CnZhciBldmVudHNFeHBvcnRzID0gcmVxdWlyZUV2ZW50cygpOwpjb25zdCBUWVBFID0gewogIE5VTEw6IDAsCiAgRkFMU0U6IDEsCiAgVFJVRTogMiwKICBJTlQ6IDMsCiAgRkxPQVQ6IDQsCiAgU1RSSU5HOiA1LAogIE9JRDogNiwKICBEQVRFOiA3LAogIFBPSU5URVI6IDgsCiAgQklOQVJZOiA5LAogIEFSUkFZOiAxNiwKICBPQkpFQ1Q6IDE3Cn07CmNsYXNzIE9iamVjdElkIHsKICBjb25zdHJ1Y3RvcihpZCkgewogICAgaWYgKGlkID09PSB2b2lkIDAgfHwgaWQgPT09IG51bGwpIHsKICAgICAgdGhpcy5pZCA9IE9iamVjdElkLmdlbmVyYXRlKCk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBpZCA9PT0gInN0cmluZyIpIHsKICAgICAgaWYgKCFPYmplY3RJZC5pc1ZhbGlkKGlkKSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihgQXJndW1lbnQgcGFzc2VkIGluIG11c3QgYmUgYSBzdHJpbmcgb2YgMjQgaGV4IGNoYXJhY3RlcnMsIGdvdDogJHtpZH1gKTsKICAgICAgfQogICAgICB0aGlzLmlkID0gaWQudG9Mb3dlckNhc2UoKTsKICAgIH0gZWxzZSBpZiAoaWQgaW5zdGFuY2VvZiBVaW50OEFycmF5ICYmIGlkLmxlbmd0aCA9PT0gMTIpIHsKICAgICAgdGhpcy5pZCA9IEFycmF5LmZyb20oaWQpLm1hcCgoYikgPT4gYi50b1N0cmluZygxNikucGFkU3RhcnQoMiwgIjAiKSkuam9pbigiIik7CiAgICB9IGVsc2UgaWYgKGlkIGluc3RhbmNlb2YgT2JqZWN0SWQpIHsKICAgICAgdGhpcy5pZCA9IGlkLmlkOwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGBBcmd1bWVudCBwYXNzZWQgaW4gbXVzdCBiZSBhIHN0cmluZyBvZiAyNCBoZXggY2hhcmFjdGVycyBvciBhbiBPYmplY3RJZGApOwogICAgfQogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBPYmplY3RJZCBhcyBhIDI0LWNoYXJhY3RlciBoZXggc3RyaW5nCiAgICovCiAgdG9TdHJpbmcoKSB7CiAgICByZXR1cm4gdGhpcy5pZDsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgT2JqZWN0SWQgYXMgYSAyNC1jaGFyYWN0ZXIgaGV4IHN0cmluZyAoYWxpYXMgZm9yIHRvU3RyaW5nKQogICAqLwogIHRvSGV4U3RyaW5nKCkgewogICAgcmV0dXJuIHRoaXMuaWQ7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIHRpbWVzdGFtcCBwb3J0aW9uIG9mIHRoZSBPYmplY3RJZCBhcyBhIERhdGUKICAgKi8KICBnZXRUaW1lc3RhbXAoKSB7CiAgICBjb25zdCB0aW1lc3RhbXAgPSBwYXJzZUludCh0aGlzLmlkLnN1YnN0cmluZygwLCA4KSwgMTYpOwogICAgcmV0dXJuIG5ldyBEYXRlKHRpbWVzdGFtcCAqIDFlMyk7CiAgfQogIGVxdWFscyhvdGhlcikgewogICAgaWYgKCEob3RoZXIgaW5zdGFuY2VvZiBPYmplY3RJZCkpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW4gb25seSBjb21wYXJlIHdpdGggYW5vdGhlciBPYmplY3RJZCIpOwogICAgfQogICAgcmV0dXJuIHRoaXMuaWQgPT09IG90aGVyLmlkOwogIH0KICAvKioKICAgKiBDb21wYXJlcyB0aGlzIE9iamVjdElkIHdpdGggYW5vdGhlciBmb3IgZXF1YWxpdHkKICAgKi8KICBjb21wYXJlKG90aGVyKSB7CiAgICBpZiAoIShvdGhlciBpbnN0YW5jZW9mIE9iamVjdElkKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbiBvbmx5IGNvbXBhcmUgd2l0aCBhbm90aGVyIE9iamVjdElkIik7CiAgICB9CiAgICByZXR1cm4gdGhpcy5pZC5sb2NhbGVDb21wYXJlKG90aGVyLmlkKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgT2JqZWN0SWQgaW4gSlNPTiBmb3JtYXQgKGFzIGhleCBzdHJpbmcpCiAgICovCiAgdG9KU09OKCkgewogICAgcmV0dXJuIHRoaXMuaWQ7CiAgfQogIC8qKgogICAqIEN1c3RvbSBpbnNwZWN0IGZvciBOb2RlLmpzIGNvbnNvbGUubG9nCiAgICovCiAgaW5zcGVjdCgpIHsKICAgIHJldHVybiBgT2JqZWN0SWQoIiR7dGhpcy5pZH0iKWA7CiAgfQogIHRvQnl0ZXMoKSB7CiAgICBjb25zdCBieXRlcyA9IG5ldyBVaW50OEFycmF5KDEyKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTI7IGkrKykgewogICAgICBieXRlc1tpXSA9IHBhcnNlSW50KHRoaXMuaWQuc3Vic3RyaW5nKGkgKiAyLCBpICogMiArIDIpLCAxNik7CiAgICB9CiAgICByZXR1cm4gYnl0ZXM7CiAgfQogIC8qKgogICAqIFZhbGlkYXRlcyBpZiBhIHN0cmluZyBpcyBhIHZhbGlkIE9iamVjdElkIGhleCBzdHJpbmcKICAgKi8KICBzdGF0aWMgaXNWYWxpZChpZCkgewogICAgaWYgKCFpZCkgcmV0dXJuIGZhbHNlOwogICAgaWYgKHR5cGVvZiBpZCAhPT0gInN0cmluZyIpIHJldHVybiBmYWxzZTsKICAgIGlmIChpZC5sZW5ndGggIT09IDI0KSByZXR1cm4gZmFsc2U7CiAgICByZXR1cm4gL15bMC05YS1mQS1GXXsyNH0kLy50ZXN0KGlkKTsKICB9CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBPYmplY3RJZCBmcm9tIGEgdGltZXN0YW1wCiAgICovCiAgc3RhdGljIGNyZWF0ZUZyb21UaW1lKHRpbWVzdGFtcCkgewogICAgY29uc3QgdHMgPSBNYXRoLmZsb29yKHRpbWVzdGFtcCAvIDFlMyk7CiAgICBjb25zdCB0c0hleCA9ICgiMDAwMDAwMDAiICsgdHMudG9TdHJpbmcoMTYpKS5zbGljZSgtOCk7CiAgICBjb25zdCB0YWlsID0gIjAwMDAwMDAwMDAwMDAwMDAiOwogICAgcmV0dXJuIG5ldyBPYmplY3RJZCh0c0hleCArIHRhaWwpOwogIH0KICAvKioKICAgKiBHZW5lcmF0ZXMgYSBuZXcgT2JqZWN0SWQgaGV4IHN0cmluZwogICAqIEZvcm1hdDogOC1jaGFyIHRpbWVzdGFtcCAoNCBieXRlcykgKyAxNi1jaGFyIHJhbmRvbSBkYXRhICg4IGJ5dGVzKQogICAqLwogIHN0YXRpYyBnZW5lcmF0ZSgpIHsKICAgIGNvbnN0IHRzID0gTWF0aC5mbG9vcihEYXRlLm5vdygpIC8gMWUzKTsKICAgIGNvbnN0IHJhbmQgPSB0eXBlb2YgY3J5cHRvICE9PSAidW5kZWZpbmVkIiAmJiBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzID8gbmV3IFVpbnQ4QXJyYXkoOCkgOiBudWxsOwogICAgbGV0IHRhaWwgPSAiIjsKICAgIGlmIChyYW5kKSB7CiAgICAgIGNyeXB0by5nZXRSYW5kb21WYWx1ZXMocmFuZCk7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmFuZC5sZW5ndGg7IGkrKykgewogICAgICAgIHRhaWwgKz0gKCIwIiArIHJhbmRbaV0udG9TdHJpbmcoMTYpKS5zbGljZSgtMik7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHRhaWwgPSBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDE2KS5zbGljZSgyKS5wYWRFbmQoOCwgIjAiKS5zbGljZSgwLCA4KSArIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMTYpLnNsaWNlKDIpLnBhZEVuZCg4LCAiMCIpLnNsaWNlKDAsIDgpOwogICAgfQogICAgY29uc3QgdHNIZXggPSAoIjAwMDAwMDAwIiArIHRzLnRvU3RyaW5nKDE2KSkuc2xpY2UoLTgpOwogICAgcmV0dXJuICh0c0hleCArIHRhaWwpLnNsaWNlKDAsIDI0KTsKICB9Cn0KY2xhc3MgUG9pbnRlciB7CiAgY29uc3RydWN0b3Iob2Zmc2V0KSB7CiAgICBpZiAob2Zmc2V0ID09PSB2b2lkIDAgfHwgb2Zmc2V0ID09PSBudWxsKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiUG9pbnRlciBvZmZzZXQgbXVzdCBiZSBhIG51bWJlciIpOwogICAgfQogICAgaWYgKHR5cGVvZiBvZmZzZXQgIT09ICJudW1iZXIiKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiUG9pbnRlciBvZmZzZXQgbXVzdCBiZSBhIG51bWJlciIpOwogICAgfQogICAgaWYgKCFOdW1iZXIuaXNJbnRlZ2VyKG9mZnNldCkpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJQb2ludGVyIG9mZnNldCBtdXN0IGJlIGFuIGludGVnZXIiKTsKICAgIH0KICAgIGlmIChvZmZzZXQgPCAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiUG9pbnRlciBvZmZzZXQgbXVzdCBiZSBub24tbmVnYXRpdmUiKTsKICAgIH0KICAgIGlmIChvZmZzZXQgPiBOdW1iZXIuTUFYX1NBRkVfSU5URUdFUikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlBvaW50ZXIgb2Zmc2V0IGV4Y2VlZHMgbWF4aW11bSBzYWZlIGludGVnZXIiKTsKICAgIH0KICAgIHRoaXMub2Zmc2V0ID0gb2Zmc2V0OwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBwb2ludGVyIG9mZnNldCBhcyBhIG51bWJlcgogICAqLwogIHZhbHVlT2YoKSB7CiAgICByZXR1cm4gdGhpcy5vZmZzZXQ7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIHBvaW50ZXIgb2Zmc2V0IGFzIGEgc3RyaW5nCiAgICovCiAgdG9TdHJpbmcoKSB7CiAgICByZXR1cm4gdGhpcy5vZmZzZXQudG9TdHJpbmcoKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgcG9pbnRlciBpbiBKU09OIGZvcm1hdCAoYXMgbnVtYmVyKQogICAqLwogIHRvSlNPTigpIHsKICAgIHJldHVybiB0aGlzLm9mZnNldDsKICB9CiAgLyoqCiAgICogQ3VzdG9tIGluc3BlY3QgZm9yIE5vZGUuanMgY29uc29sZS5sb2cKICAgKi8KICBpbnNwZWN0KCkgewogICAgcmV0dXJuIGBQb2ludGVyKCR7dGhpcy5vZmZzZXR9KWA7CiAgfQogIC8qKgogICAqIENvbXBhcmVzIHRoaXMgUG9pbnRlciB3aXRoIGFub3RoZXIgZm9yIGVxdWFsaXR5CiAgICovCiAgZXF1YWxzKG90aGVyKSB7CiAgICBpZiAoIShvdGhlciBpbnN0YW5jZW9mIFBvaW50ZXIpKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHJldHVybiB0aGlzLm9mZnNldCA9PT0gb3RoZXIub2Zmc2V0OwogIH0KfQpmdW5jdGlvbiBlbmNvZGUodmFsdWUpIHsKICBjb25zdCBidWZmZXJzID0gW107CiAgZnVuY3Rpb24gZW5jb2RlVmFsdWUodmFsKSB7CiAgICBpZiAodmFsID09PSBudWxsKSB7CiAgICAgIGJ1ZmZlcnMucHVzaChuZXcgVWludDhBcnJheShbVFlQRS5OVUxMXSkpOwogICAgfSBlbHNlIGlmICh2YWwgPT09IGZhbHNlKSB7CiAgICAgIGJ1ZmZlcnMucHVzaChuZXcgVWludDhBcnJheShbVFlQRS5GQUxTRV0pKTsKICAgIH0gZWxzZSBpZiAodmFsID09PSB0cnVlKSB7CiAgICAgIGJ1ZmZlcnMucHVzaChuZXcgVWludDhBcnJheShbVFlQRS5UUlVFXSkpOwogICAgfSBlbHNlIGlmICh2YWwgaW5zdGFuY2VvZiBPYmplY3RJZCkgewogICAgICBidWZmZXJzLnB1c2gobmV3IFVpbnQ4QXJyYXkoW1RZUEUuT0lEXSkpOwogICAgICBidWZmZXJzLnB1c2godmFsLnRvQnl0ZXMoKSk7CiAgICB9IGVsc2UgaWYgKHZhbCBpbnN0YW5jZW9mIERhdGUpIHsKICAgICAgYnVmZmVycy5wdXNoKG5ldyBVaW50OEFycmF5KFtUWVBFLkRBVEVdKSk7CiAgICAgIGNvbnN0IGJ1ZmZlciA9IG5ldyBBcnJheUJ1ZmZlcig4KTsKICAgICAgY29uc3QgdmlldyA9IG5ldyBEYXRhVmlldyhidWZmZXIpOwogICAgICB2aWV3LnNldEJpZ0ludDY0KDAsIEJpZ0ludCh2YWwuZ2V0VGltZSgpKSwgdHJ1ZSk7CiAgICAgIGJ1ZmZlcnMucHVzaChuZXcgVWludDhBcnJheShidWZmZXIpKTsKICAgIH0gZWxzZSBpZiAodmFsIGluc3RhbmNlb2YgUG9pbnRlcikgewogICAgICBidWZmZXJzLnB1c2gobmV3IFVpbnQ4QXJyYXkoW1RZUEUuUE9JTlRFUl0pKTsKICAgICAgY29uc3QgYnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKDgpOwogICAgICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KGJ1ZmZlcik7CiAgICAgIHZpZXcuc2V0QmlnVWludDY0KDAsIEJpZ0ludCh2YWwub2Zmc2V0KSwgdHJ1ZSk7CiAgICAgIGJ1ZmZlcnMucHVzaChuZXcgVWludDhBcnJheShidWZmZXIpKTsKICAgIH0gZWxzZSBpZiAodmFsIGluc3RhbmNlb2YgVWludDhBcnJheSkgewogICAgICBidWZmZXJzLnB1c2gobmV3IFVpbnQ4QXJyYXkoW1RZUEUuQklOQVJZXSkpOwogICAgICBjb25zdCBsZW5ndGhCdWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIoNCk7CiAgICAgIGNvbnN0IGxlbmd0aFZpZXcgPSBuZXcgRGF0YVZpZXcobGVuZ3RoQnVmZmVyKTsKICAgICAgbGVuZ3RoVmlldy5zZXRVaW50MzIoMCwgdmFsLmxlbmd0aCwgdHJ1ZSk7CiAgICAgIGJ1ZmZlcnMucHVzaChuZXcgVWludDhBcnJheShsZW5ndGhCdWZmZXIpKTsKICAgICAgYnVmZmVycy5wdXNoKHZhbCk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWwgPT09ICJudW1iZXIiKSB7CiAgICAgIGlmIChOdW1iZXIuaXNJbnRlZ2VyKHZhbCkgJiYgTnVtYmVyLmlzU2FmZUludGVnZXIodmFsKSkgewogICAgICAgIGJ1ZmZlcnMucHVzaChuZXcgVWludDhBcnJheShbVFlQRS5JTlRdKSk7CiAgICAgICAgY29uc3QgYnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKDgpOwogICAgICAgIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcoYnVmZmVyKTsKICAgICAgICB2aWV3LnNldEJpZ0ludDY0KDAsIEJpZ0ludCh2YWwpLCB0cnVlKTsKICAgICAgICBidWZmZXJzLnB1c2gobmV3IFVpbnQ4QXJyYXkoYnVmZmVyKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYnVmZmVycy5wdXNoKG5ldyBVaW50OEFycmF5KFtUWVBFLkZMT0FUXSkpOwogICAgICAgIGNvbnN0IGJ1ZmZlciA9IG5ldyBBcnJheUJ1ZmZlcig4KTsKICAgICAgICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KGJ1ZmZlcik7CiAgICAgICAgdmlldy5zZXRGbG9hdDY0KDAsIHZhbCwgdHJ1ZSk7CiAgICAgICAgYnVmZmVycy5wdXNoKG5ldyBVaW50OEFycmF5KGJ1ZmZlcikpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWwgPT09ICJzdHJpbmciKSB7CiAgICAgIGJ1ZmZlcnMucHVzaChuZXcgVWludDhBcnJheShbVFlQRS5TVFJJTkddKSk7CiAgICAgIGNvbnN0IGVuY29kZWQgPSBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUodmFsKTsKICAgICAgY29uc3QgbGVuZ3RoQnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKDQpOwogICAgICBjb25zdCBsZW5ndGhWaWV3ID0gbmV3IERhdGFWaWV3KGxlbmd0aEJ1ZmZlcik7CiAgICAgIGxlbmd0aFZpZXcuc2V0VWludDMyKDAsIGVuY29kZWQubGVuZ3RoLCB0cnVlKTsKICAgICAgYnVmZmVycy5wdXNoKG5ldyBVaW50OEFycmF5KGxlbmd0aEJ1ZmZlcikpOwogICAgICBidWZmZXJzLnB1c2goZW5jb2RlZCk7CiAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkodmFsKSkgewogICAgICBjb25zdCB0ZW1wQnVmZmVycyA9IFtdOwogICAgICBjb25zdCBsZW5ndGhCdWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIoNCk7CiAgICAgIGNvbnN0IGxlbmd0aFZpZXcgPSBuZXcgRGF0YVZpZXcobGVuZ3RoQnVmZmVyKTsKICAgICAgbGVuZ3RoVmlldy5zZXRVaW50MzIoMCwgdmFsLmxlbmd0aCwgdHJ1ZSk7CiAgICAgIHRlbXBCdWZmZXJzLnB1c2gobmV3IFVpbnQ4QXJyYXkobGVuZ3RoQnVmZmVyKSk7CiAgICAgIGNvbnN0IHN0YXJ0TGVuZ3RoID0gYnVmZmVycy5sZW5ndGg7CiAgICAgIGZvciAoY29uc3QgaXRlbSBvZiB2YWwpIHsKICAgICAgICBlbmNvZGVWYWx1ZShpdGVtKTsKICAgICAgfQogICAgICBjb25zdCBlbGVtZW50QnVmZmVycyA9IGJ1ZmZlcnMuc3BsaWNlKHN0YXJ0TGVuZ3RoKTsKICAgICAgdGVtcEJ1ZmZlcnMucHVzaCguLi5lbGVtZW50QnVmZmVycyk7CiAgICAgIGNvbnN0IGNvbnRlbnRTaXplID0gdGVtcEJ1ZmZlcnMucmVkdWNlKChzdW0sIGJ1ZikgPT4gc3VtICsgYnVmLmxlbmd0aCwgMCk7CiAgICAgIGJ1ZmZlcnMucHVzaChuZXcgVWludDhBcnJheShbVFlQRS5BUlJBWV0pKTsKICAgICAgY29uc3Qgc2l6ZUJ1ZmZlciA9IG5ldyBBcnJheUJ1ZmZlcig0KTsKICAgICAgY29uc3Qgc2l6ZVZpZXcgPSBuZXcgRGF0YVZpZXcoc2l6ZUJ1ZmZlcik7CiAgICAgIHNpemVWaWV3LnNldFVpbnQzMigwLCBjb250ZW50U2l6ZSwgdHJ1ZSk7CiAgICAgIGJ1ZmZlcnMucHVzaChuZXcgVWludDhBcnJheShzaXplQnVmZmVyKSk7CiAgICAgIGJ1ZmZlcnMucHVzaCguLi50ZW1wQnVmZmVycyk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWwgPT09ICJvYmplY3QiKSB7CiAgICAgIGNvbnN0IHRlbXBCdWZmZXJzID0gW107CiAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyh2YWwpOwogICAgICBjb25zdCBsZW5ndGhCdWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIoNCk7CiAgICAgIGNvbnN0IGxlbmd0aFZpZXcgPSBuZXcgRGF0YVZpZXcobGVuZ3RoQnVmZmVyKTsKICAgICAgbGVuZ3RoVmlldy5zZXRVaW50MzIoMCwga2V5cy5sZW5ndGgsIHRydWUpOwogICAgICB0ZW1wQnVmZmVycy5wdXNoKG5ldyBVaW50OEFycmF5KGxlbmd0aEJ1ZmZlcikpOwogICAgICBjb25zdCBzdGFydExlbmd0aCA9IGJ1ZmZlcnMubGVuZ3RoOwogICAgICBmb3IgKGNvbnN0IGtleSBvZiBrZXlzKSB7CiAgICAgICAgY29uc3QgZW5jb2RlZCA9IG5ldyBUZXh0RW5jb2RlcigpLmVuY29kZShrZXkpOwogICAgICAgIGNvbnN0IGtleUxlbmd0aEJ1ZmZlciA9IG5ldyBBcnJheUJ1ZmZlcig0KTsKICAgICAgICBjb25zdCBrZXlMZW5ndGhWaWV3ID0gbmV3IERhdGFWaWV3KGtleUxlbmd0aEJ1ZmZlcik7CiAgICAgICAga2V5TGVuZ3RoVmlldy5zZXRVaW50MzIoMCwgZW5jb2RlZC5sZW5ndGgsIHRydWUpOwogICAgICAgIGJ1ZmZlcnMucHVzaChuZXcgVWludDhBcnJheShrZXlMZW5ndGhCdWZmZXIpKTsKICAgICAgICBidWZmZXJzLnB1c2goZW5jb2RlZCk7CiAgICAgICAgZW5jb2RlVmFsdWUodmFsW2tleV0pOwogICAgICB9CiAgICAgIGNvbnN0IGt2QnVmZmVycyA9IGJ1ZmZlcnMuc3BsaWNlKHN0YXJ0TGVuZ3RoKTsKICAgICAgdGVtcEJ1ZmZlcnMucHVzaCguLi5rdkJ1ZmZlcnMpOwogICAgICBjb25zdCBjb250ZW50U2l6ZSA9IHRlbXBCdWZmZXJzLnJlZHVjZSgoc3VtLCBidWYpID0+IHN1bSArIGJ1Zi5sZW5ndGgsIDApOwogICAgICBidWZmZXJzLnB1c2gobmV3IFVpbnQ4QXJyYXkoW1RZUEUuT0JKRUNUXSkpOwogICAgICBjb25zdCBzaXplQnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKDQpOwogICAgICBjb25zdCBzaXplVmlldyA9IG5ldyBEYXRhVmlldyhzaXplQnVmZmVyKTsKICAgICAgc2l6ZVZpZXcuc2V0VWludDMyKDAsIGNvbnRlbnRTaXplLCB0cnVlKTsKICAgICAgYnVmZmVycy5wdXNoKG5ldyBVaW50OEFycmF5KHNpemVCdWZmZXIpKTsKICAgICAgYnVmZmVycy5wdXNoKC4uLnRlbXBCdWZmZXJzKTsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5zdXBwb3J0ZWQgdHlwZTogJHt0eXBlb2YgdmFsfWApOwogICAgfQogIH0KICBlbmNvZGVWYWx1ZSh2YWx1ZSk7CiAgY29uc3QgdG90YWxMZW5ndGggPSBidWZmZXJzLnJlZHVjZSgoc3VtLCBidWYpID0+IHN1bSArIGJ1Zi5sZW5ndGgsIDApOwogIGNvbnN0IHJlc3VsdCA9IG5ldyBVaW50OEFycmF5KHRvdGFsTGVuZ3RoKTsKICBsZXQgb2Zmc2V0ID0gMDsKICBmb3IgKGNvbnN0IGJ1ZiBvZiBidWZmZXJzKSB7CiAgICByZXN1bHQuc2V0KGJ1Ziwgb2Zmc2V0KTsKICAgIG9mZnNldCArPSBidWYubGVuZ3RoOwogIH0KICByZXR1cm4gcmVzdWx0Owp9CmZ1bmN0aW9uIGRlY29kZShkYXRhKSB7CiAgbGV0IG9mZnNldCA9IDA7CiAgZnVuY3Rpb24gZGVjb2RlVmFsdWUoKSB7CiAgICBpZiAob2Zmc2V0ID49IGRhdGEubGVuZ3RoKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCBlbmQgb2YgZGF0YSIpOwogICAgfQogICAgY29uc3QgdHlwZSA9IGRhdGFbb2Zmc2V0KytdOwogICAgc3dpdGNoICh0eXBlKSB7CiAgICAgIGNhc2UgVFlQRS5OVUxMOgogICAgICAgIHJldHVybiBudWxsOwogICAgICBjYXNlIFRZUEUuRkFMU0U6CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICBjYXNlIFRZUEUuVFJVRToKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgY2FzZSBUWVBFLklOVDogewogICAgICAgIGlmIChvZmZzZXQgKyA0ID4gZGF0YS5sZW5ndGgpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCBlbmQgb2YgZGF0YSBmb3IgSU5UIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCArIG9mZnNldCwgOCk7CiAgICAgICAgY29uc3QgdmFsdWUgPSB2aWV3LmdldEJpZ0ludDY0KDAsIHRydWUpOwogICAgICAgIG9mZnNldCArPSA4OwogICAgICAgIGlmICh2YWx1ZSA8IEJpZ0ludChOdW1iZXIuTUlOX1NBRkVfSU5URUdFUikgfHwgdmFsdWUgPiBCaWdJbnQoTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkRlY29kZWQgaW50ZWdlciBleGNlZWRzIHNhZmUgcmFuZ2UiKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIE51bWJlcih2YWx1ZSk7CiAgICAgIH0KICAgICAgY2FzZSBUWVBFLkZMT0FUOiB7CiAgICAgICAgaWYgKG9mZnNldCArIDggPiBkYXRhLmxlbmd0aCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmV4cGVjdGVkIGVuZCBvZiBkYXRhIGZvciBGTE9BVCIpOwogICAgICAgIH0KICAgICAgICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KGRhdGEuYnVmZmVyLCBkYXRhLmJ5dGVPZmZzZXQgKyBvZmZzZXQsIDgpOwogICAgICAgIGNvbnN0IHZhbHVlID0gdmlldy5nZXRGbG9hdDY0KDAsIHRydWUpOwogICAgICAgIG9mZnNldCArPSA4OwogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogICAgICBjYXNlIFRZUEUuU1RSSU5HOiB7CiAgICAgICAgaWYgKG9mZnNldCArIDQgPiBkYXRhLmxlbmd0aCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmV4cGVjdGVkIGVuZCBvZiBkYXRhIGZvciBTVFJJTkcgbGVuZ3RoIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aFZpZXcgPSBuZXcgRGF0YVZpZXcoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCArIG9mZnNldCwgNCk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gbGVuZ3RoVmlldy5nZXRVaW50MzIoMCwgdHJ1ZSk7CiAgICAgICAgb2Zmc2V0ICs9IDQ7CiAgICAgICAgaWYgKG9mZnNldCArIGxlbmd0aCA+IGRhdGEubGVuZ3RoKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuZXhwZWN0ZWQgZW5kIG9mIGRhdGEgZm9yIFNUUklORyBjb250ZW50Iik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHN0cmluZ0RhdGEgPSBkYXRhLnNsaWNlKG9mZnNldCwgb2Zmc2V0ICsgbGVuZ3RoKTsKICAgICAgICBvZmZzZXQgKz0gbGVuZ3RoOwogICAgICAgIHJldHVybiBuZXcgVGV4dERlY29kZXIoKS5kZWNvZGUoc3RyaW5nRGF0YSk7CiAgICAgIH0KICAgICAgY2FzZSBUWVBFLk9JRDogewogICAgICAgIGlmIChvZmZzZXQgKyAxMiA+IGRhdGEubGVuZ3RoKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuZXhwZWN0ZWQgZW5kIG9mIGRhdGEgZm9yIE9JRCIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBvaWRCeXRlcyA9IGRhdGEuc2xpY2Uob2Zmc2V0LCBvZmZzZXQgKyAxMik7CiAgICAgICAgb2Zmc2V0ICs9IDEyOwogICAgICAgIHJldHVybiBuZXcgT2JqZWN0SWQob2lkQnl0ZXMpOwogICAgICB9CiAgICAgIGNhc2UgVFlQRS5EQVRFOiB7CiAgICAgICAgaWYgKG9mZnNldCArIDggPiBkYXRhLmxlbmd0aCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmV4cGVjdGVkIGVuZCBvZiBkYXRhIGZvciBEQVRFIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCArIG9mZnNldCwgOCk7CiAgICAgICAgY29uc3QgdGltZXN0YW1wID0gdmlldy5nZXRCaWdJbnQ2NCgwLCB0cnVlKTsKICAgICAgICBvZmZzZXQgKz0gODsKICAgICAgICByZXR1cm4gbmV3IERhdGUoTnVtYmVyKHRpbWVzdGFtcCkpOwogICAgICB9CiAgICAgIGNhc2UgVFlQRS5QT0lOVEVSOiB7CiAgICAgICAgaWYgKG9mZnNldCArIDggPiBkYXRhLmxlbmd0aCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmV4cGVjdGVkIGVuZCBvZiBkYXRhIGZvciBQT0lOVEVSIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCArIG9mZnNldCwgOCk7CiAgICAgICAgY29uc3QgcG9pbnRlck9mZnNldCA9IHZpZXcuZ2V0QmlnVWludDY0KDAsIHRydWUpOwogICAgICAgIG9mZnNldCArPSA4OwogICAgICAgIGlmIChwb2ludGVyT2Zmc2V0ID4gQmlnSW50KE51bWJlci5NQVhfU0FGRV9JTlRFR0VSKSkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJQb2ludGVyIG9mZnNldCBvdXQgb2YgdmFsaWQgcmFuZ2UiKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBQb2ludGVyKE51bWJlcihwb2ludGVyT2Zmc2V0KSk7CiAgICAgIH0KICAgICAgY2FzZSBUWVBFLkJJTkFSWTogewogICAgICAgIGlmIChvZmZzZXQgKyA0ID4gZGF0YS5sZW5ndGgpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCBlbmQgb2YgZGF0YSBmb3IgQklOQVJZIGxlbmd0aCIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGhWaWV3ID0gbmV3IERhdGFWaWV3KGRhdGEuYnVmZmVyLCBkYXRhLmJ5dGVPZmZzZXQgKyBvZmZzZXQsIDQpOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGxlbmd0aFZpZXcuZ2V0VWludDMyKDAsIHRydWUpOwogICAgICAgIG9mZnNldCArPSA0OwogICAgICAgIGlmIChvZmZzZXQgKyBsZW5ndGggPiBkYXRhLmxlbmd0aCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmV4cGVjdGVkIGVuZCBvZiBkYXRhIGZvciBCSU5BUlkgY29udGVudCIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBiaW5hcnlEYXRhID0gZGF0YS5zbGljZShvZmZzZXQsIG9mZnNldCArIGxlbmd0aCk7CiAgICAgICAgb2Zmc2V0ICs9IGxlbmd0aDsKICAgICAgICByZXR1cm4gYmluYXJ5RGF0YTsKICAgICAgfQogICAgICBjYXNlIFRZUEUuQVJSQVk6IHsKICAgICAgICBpZiAob2Zmc2V0ICsgNCA+IGRhdGEubGVuZ3RoKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuZXhwZWN0ZWQgZW5kIG9mIGRhdGEgZm9yIEFSUkFZIHNpemUiKTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc2l6ZVZpZXcgPSBuZXcgRGF0YVZpZXcoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCArIG9mZnNldCwgNCk7CiAgICAgICAgY29uc3Qgc2l6ZSA9IHNpemVWaWV3LmdldFVpbnQzMigwLCB0cnVlKTsKICAgICAgICBvZmZzZXQgKz0gNDsKICAgICAgICBpZiAob2Zmc2V0ICsgc2l6ZSA+IGRhdGEubGVuZ3RoKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuZXhwZWN0ZWQgZW5kIG9mIGRhdGEgZm9yIEFSUkFZIGNvbnRlbnQiKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbGVuZ3RoVmlldyA9IG5ldyBEYXRhVmlldyhkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0ICsgb2Zmc2V0LCA0KTsKICAgICAgICBjb25zdCBsZW5ndGggPSBsZW5ndGhWaWV3LmdldFVpbnQzMigwLCB0cnVlKTsKICAgICAgICBvZmZzZXQgKz0gNDsKICAgICAgICBjb25zdCBhcnIgPSBbXTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBhcnIucHVzaChkZWNvZGVWYWx1ZSgpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFycjsKICAgICAgfQogICAgICBjYXNlIFRZUEUuT0JKRUNUOiB7CiAgICAgICAgaWYgKG9mZnNldCArIDQgPiBkYXRhLmxlbmd0aCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmV4cGVjdGVkIGVuZCBvZiBkYXRhIGZvciBPQkpFQ1Qgc2l6ZSIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBzaXplVmlldyA9IG5ldyBEYXRhVmlldyhkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0ICsgb2Zmc2V0LCA0KTsKICAgICAgICBjb25zdCBzaXplID0gc2l6ZVZpZXcuZ2V0VWludDMyKDAsIHRydWUpOwogICAgICAgIG9mZnNldCArPSA0OwogICAgICAgIGlmIChvZmZzZXQgKyBzaXplID4gZGF0YS5sZW5ndGgpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCBlbmQgb2YgZGF0YSBmb3IgT0JKRUNUIGNvbnRlbnQiKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbGVuZ3RoVmlldyA9IG5ldyBEYXRhVmlldyhkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0ICsgb2Zmc2V0LCA0KTsKICAgICAgICBjb25zdCBsZW5ndGggPSBsZW5ndGhWaWV3LmdldFVpbnQzMigwLCB0cnVlKTsKICAgICAgICBvZmZzZXQgKz0gNDsKICAgICAgICBjb25zdCBvYmogPSB7fTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAob2Zmc2V0ICsgNCA+IGRhdGEubGVuZ3RoKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCBlbmQgb2YgZGF0YSBmb3IgT0JKRUNUIGtleSBsZW5ndGgiKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGtleUxlbmd0aFZpZXcgPSBuZXcgRGF0YVZpZXcoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCArIG9mZnNldCwgNCk7CiAgICAgICAgICBjb25zdCBrZXlMZW5ndGggPSBrZXlMZW5ndGhWaWV3LmdldFVpbnQzMigwLCB0cnVlKTsKICAgICAgICAgIG9mZnNldCArPSA0OwogICAgICAgICAgaWYgKG9mZnNldCArIGtleUxlbmd0aCA+IGRhdGEubGVuZ3RoKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCBlbmQgb2YgZGF0YSBmb3IgT0JKRUNUIGtleSIpOwogICAgICAgICAgfQogICAgICAgICAgY29uc3Qga2V5RGF0YSA9IGRhdGEuc2xpY2Uob2Zmc2V0LCBvZmZzZXQgKyBrZXlMZW5ndGgpOwogICAgICAgICAgb2Zmc2V0ICs9IGtleUxlbmd0aDsKICAgICAgICAgIGNvbnN0IGtleSA9IG5ldyBUZXh0RGVjb2RlcigpLmRlY29kZShrZXlEYXRhKTsKICAgICAgICAgIG9ialtrZXldID0gZGVjb2RlVmFsdWUoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9iajsKICAgICAgfQogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biB0eXBlIGJ5dGU6IDB4JHt0eXBlLnRvU3RyaW5nKDE2KX1gKTsKICAgIH0KICB9CiAgcmV0dXJuIGRlY29kZVZhbHVlKCk7Cn0KY2xhc3MgQkpzb25GaWxlIHsKICBjb25zdHJ1Y3RvcihzeW5jQWNjZXNzSGFuZGxlKSB7CiAgICBpZiAoIXN5bmNBY2Nlc3NIYW5kbGUpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJGaWxlU3lzdGVtU3luY0FjY2Vzc0hhbmRsZSBpcyByZXF1aXJlZCIpOwogICAgfQogICAgdGhpcy5zeW5jQWNjZXNzSGFuZGxlID0gc3luY0FjY2Vzc0hhbmRsZTsKICB9CiAgLyoqCiAgICogUmVhZCBhIHJhbmdlIG9mIGJ5dGVzIGZyb20gdGhlIGZpbGUKICAgKi8KICAjcmVhZFJhbmdlKHN0YXJ0LCBsZW5ndGgpIHsKICAgIGNvbnN0IGJ1ZmZlciA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCk7CiAgICBjb25zdCBieXRlc1JlYWQgPSB0aGlzLnN5bmNBY2Nlc3NIYW5kbGUucmVhZChidWZmZXIsIHsgYXQ6IHN0YXJ0IH0pOwogICAgaWYgKGJ5dGVzUmVhZCA8IGxlbmd0aCkgewogICAgICByZXR1cm4gYnVmZmVyLnNsaWNlKDAsIGJ5dGVzUmVhZCk7CiAgICB9CiAgICByZXR1cm4gYnVmZmVyOwogIH0KICAvKioKICAgKiBHZXQgdGhlIGN1cnJlbnQgZmlsZSBzaXplCiAgICovCiAgZ2V0RmlsZVNpemUoKSB7CiAgICByZXR1cm4gdGhpcy5zeW5jQWNjZXNzSGFuZGxlLmdldFNpemUoKTsKICB9CiAgLyoqCiAgICogV3JpdGUgZGF0YSB0byBmaWxlLCB0cnVuY2F0aW5nIGV4aXN0aW5nIGNvbnRlbnQKICAgKiBAcGFyYW0geyp9IGRhdGEgLSBEYXRhIHRvIGVuY29kZSBhbmQgd3JpdGUKICAgKi8KICB3cml0ZShkYXRhKSB7CiAgICBjb25zdCBiaW5hcnlEYXRhID0gZW5jb2RlKGRhdGEpOwogICAgdGhpcy5zeW5jQWNjZXNzSGFuZGxlLnRydW5jYXRlKDApOwogICAgdGhpcy5zeW5jQWNjZXNzSGFuZGxlLndyaXRlKGJpbmFyeURhdGEsIHsgYXQ6IDAgfSk7CiAgfQogIC8qKgogICAqIFJlYWQgYW5kIGRlY29kZSBkYXRhIGZyb20gZmlsZSBzdGFydGluZyBhdCBvcHRpb25hbCBwb2ludGVyIG9mZnNldAogICAqIEBwYXJhbSB7UG9pbnRlcn0gcG9pbnRlciAtIE9wdGlvbmFsIG9mZnNldCB0byBzdGFydCByZWFkaW5nIGZyb20gKGRlZmF1bHQ6IDApCiAgICogQHJldHVybnMgeyp9IC0gRGVjb2RlZCBkYXRhCiAgICovCiAgcmVhZChwb2ludGVyID0gbmV3IFBvaW50ZXIoMCkpIHsKICAgIGNvbnN0IGZpbGVTaXplID0gdGhpcy5nZXRGaWxlU2l6ZSgpOwogICAgaWYgKGZpbGVTaXplID09PSAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiRmlsZSBpcyBlbXB0eSIpOwogICAgfQogICAgY29uc3QgcG9pbnRlclZhbHVlID0gcG9pbnRlci52YWx1ZU9mKCk7CiAgICBpZiAocG9pbnRlclZhbHVlIDwgMCB8fCBwb2ludGVyVmFsdWUgPj0gZmlsZVNpemUpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGBQb2ludGVyIG9mZnNldCAke3BvaW50ZXJ9IG91dCBvZiBmaWxlIGJvdW5kcyBbMCwgJHtmaWxlU2l6ZX0pYCk7CiAgICB9CiAgICBjb25zdCBiaW5hcnlEYXRhID0gdGhpcy4jcmVhZFJhbmdlKHBvaW50ZXJWYWx1ZSwgZmlsZVNpemUgLSBwb2ludGVyVmFsdWUpOwogICAgcmV0dXJuIGRlY29kZShiaW5hcnlEYXRhKTsKICB9CiAgLyoqCiAgICogQXBwZW5kIGRhdGEgdG8gZmlsZSB3aXRob3V0IHRydW5jYXRpbmcgZXhpc3RpbmcgY29udGVudAogICAqIEBwYXJhbSB7Kn0gZGF0YSAtIERhdGEgdG8gZW5jb2RlIGFuZCBhcHBlbmQKICAgKi8KICBhcHBlbmQoZGF0YSkgewogICAgY29uc3QgYmluYXJ5RGF0YSA9IGVuY29kZShkYXRhKTsKICAgIGNvbnN0IGV4aXN0aW5nU2l6ZSA9IHRoaXMuZ2V0RmlsZVNpemUoKTsKICAgIHRoaXMuc3luY0FjY2Vzc0hhbmRsZS53cml0ZShiaW5hcnlEYXRhLCB7IGF0OiBleGlzdGluZ1NpemUgfSk7CiAgfQogIC8qKgogICAqIEV4cGxpY2l0bHkgZmx1c2ggYW55IHBlbmRpbmcgd3JpdGVzIHRvIGRpc2sKICAgKi8KICBmbHVzaCgpIHsKICAgIHRoaXMuc3luY0FjY2Vzc0hhbmRsZS5mbHVzaCgpOwogIH0KICAvKioKICAgKiBHZW5lcmF0b3IgdG8gc2NhbiB0aHJvdWdoIGFsbCByZWNvcmRzIGluIHRoZSBmaWxlCiAgICogRWFjaCByZWNvcmQgaXMgZGVjb2RlZCBhbmQgeWllbGRlZCBvbmUgYXQgYSB0aW1lCiAgICovCiAgKnNjYW4oKSB7CiAgICBjb25zdCBmaWxlU2l6ZSA9IHRoaXMuZ2V0RmlsZVNpemUoKTsKICAgIGlmIChmaWxlU2l6ZSA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBsZXQgb2Zmc2V0ID0gMDsKICAgIHdoaWxlIChvZmZzZXQgPCBmaWxlU2l6ZSkgewogICAgICBjb25zdCBnZXRWYWx1ZVNpemUgPSAocmVhZFBvc2l0aW9uKSA9PiB7CiAgICAgICAgbGV0IHRlbXBEYXRhID0gdGhpcy4jcmVhZFJhbmdlKHJlYWRQb3NpdGlvbiwgMSk7CiAgICAgICAgY29uc3QgdHlwZSA9IHRlbXBEYXRhWzBdOwogICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgY2FzZSBUWVBFLk5VTEw6CiAgICAgICAgICBjYXNlIFRZUEUuRkFMU0U6CiAgICAgICAgICBjYXNlIFRZUEUuVFJVRToKICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICBjYXNlIFRZUEUuSU5UOgogICAgICAgICAgY2FzZSBUWVBFLkZMT0FUOgogICAgICAgICAgY2FzZSBUWVBFLkRBVEU6CiAgICAgICAgICBjYXNlIFRZUEUuUE9JTlRFUjoKICAgICAgICAgICAgcmV0dXJuIDEgKyA4OwogICAgICAgICAgY2FzZSBUWVBFLk9JRDoKICAgICAgICAgICAgcmV0dXJuIDEgKyAxMjsKICAgICAgICAgIGNhc2UgVFlQRS5TVFJJTkc6IHsKICAgICAgICAgICAgdGVtcERhdGEgPSB0aGlzLiNyZWFkUmFuZ2UocmVhZFBvc2l0aW9uICsgMSwgNCk7CiAgICAgICAgICAgIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcodGVtcERhdGEuYnVmZmVyLCB0ZW1wRGF0YS5ieXRlT2Zmc2V0LCA0KTsKICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gdmlldy5nZXRVaW50MzIoMCwgdHJ1ZSk7CiAgICAgICAgICAgIHJldHVybiAxICsgNCArIGxlbmd0aDsKICAgICAgICAgIH0KICAgICAgICAgIGNhc2UgVFlQRS5CSU5BUlk6IHsKICAgICAgICAgICAgdGVtcERhdGEgPSB0aGlzLiNyZWFkUmFuZ2UocmVhZFBvc2l0aW9uICsgMSwgNCk7CiAgICAgICAgICAgIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcodGVtcERhdGEuYnVmZmVyLCB0ZW1wRGF0YS5ieXRlT2Zmc2V0LCA0KTsKICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gdmlldy5nZXRVaW50MzIoMCwgdHJ1ZSk7CiAgICAgICAgICAgIHJldHVybiAxICsgNCArIGxlbmd0aDsKICAgICAgICAgIH0KICAgICAgICAgIGNhc2UgVFlQRS5BUlJBWTogewogICAgICAgICAgICB0ZW1wRGF0YSA9IHRoaXMuI3JlYWRSYW5nZShyZWFkUG9zaXRpb24gKyAxLCA0KTsKICAgICAgICAgICAgY29uc3QgdmlldyA9IG5ldyBEYXRhVmlldyh0ZW1wRGF0YS5idWZmZXIsIHRlbXBEYXRhLmJ5dGVPZmZzZXQsIDQpOwogICAgICAgICAgICBjb25zdCBzaXplID0gdmlldy5nZXRVaW50MzIoMCwgdHJ1ZSk7CiAgICAgICAgICAgIHJldHVybiAxICsgNCArIHNpemU7CiAgICAgICAgICB9CiAgICAgICAgICBjYXNlIFRZUEUuT0JKRUNUOiB7CiAgICAgICAgICAgIHRlbXBEYXRhID0gdGhpcy4jcmVhZFJhbmdlKHJlYWRQb3NpdGlvbiArIDEsIDQpOwogICAgICAgICAgICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KHRlbXBEYXRhLmJ1ZmZlciwgdGVtcERhdGEuYnl0ZU9mZnNldCwgNCk7CiAgICAgICAgICAgIGNvbnN0IHNpemUgPSB2aWV3LmdldFVpbnQzMigwLCB0cnVlKTsKICAgICAgICAgICAgcmV0dXJuIDEgKyA0ICsgc2l6ZTsKICAgICAgICAgIH0KICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biB0eXBlIGJ5dGU6IDB4JHt0eXBlLnRvU3RyaW5nKDE2KX1gKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIGNvbnN0IHZhbHVlU2l6ZSA9IGdldFZhbHVlU2l6ZShvZmZzZXQpOwogICAgICBjb25zdCB2YWx1ZURhdGEgPSB0aGlzLiNyZWFkUmFuZ2Uob2Zmc2V0LCB2YWx1ZVNpemUpOwogICAgICBvZmZzZXQgKz0gdmFsdWVTaXplOwogICAgICB5aWVsZCBkZWNvZGUodmFsdWVEYXRhKTsKICAgIH0KICB9Cn0KZnVuY3Rpb24gdmFsdWVzRXF1YWwkMShhLCBiKSB7CiAgaWYgKGEgaW5zdGFuY2VvZiBPYmplY3RJZCB8fCBiIGluc3RhbmNlb2YgT2JqZWN0SWQpIHsKICAgIGlmIChhIGluc3RhbmNlb2YgT2JqZWN0SWQgJiYgYiBpbnN0YW5jZW9mIE9iamVjdElkKSB7CiAgICAgIHJldHVybiBhLmVxdWFscyhiKTsKICAgIH0KICAgIGlmIChhIGluc3RhbmNlb2YgT2JqZWN0SWQgJiYgdHlwZW9mIGIgPT09ICJzdHJpbmciKSB7CiAgICAgIHJldHVybiBhLmVxdWFscyhiKTsKICAgIH0KICAgIGlmIChiIGluc3RhbmNlb2YgT2JqZWN0SWQgJiYgdHlwZW9mIGEgPT09ICJzdHJpbmciKSB7CiAgICAgIHJldHVybiBiLmVxdWFscyhhKTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CiAgcmV0dXJuIGEgPT0gYjsKfQpmdW5jdGlvbiBjb3B5KG8pIHsKICBpZiAobyBpbnN0YW5jZW9mIE9iamVjdElkKSB7CiAgICByZXR1cm4gbmV3IE9iamVjdElkKG8uaWQpOwogIH0KICB2YXIgb3V0LCB2LCBrZXk7CiAgb3V0ID0gQXJyYXkuaXNBcnJheShvKSA/IFtdIDoge307CiAgZm9yIChrZXkgaW4gbykgewogICAgdiA9IG9ba2V5XTsKICAgIG91dFtrZXldID0gdHlwZW9mIHYgPT09ICJvYmplY3QiICYmIHYgIT09IG51bGwgPyBjb3B5KHYpIDogdjsKICB9CiAgcmV0dXJuIG91dDsKfQpmdW5jdGlvbiBnZXRQcm9wKG9iaiwgbmFtZSkgewogIHZhciBwYXRoID0gbmFtZS5zcGxpdCgiLiIpOwogIHZhciByZXN1bHQgPSBvYmpbcGF0aFswXV07CiAgZm9yICh2YXIgaSA9IDE7IGkgPCBwYXRoLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAocmVzdWx0ID09IHZvaWQgMCB8fCByZXN1bHQgPT0gbnVsbCkgcmV0dXJuIHJlc3VsdDsKICAgIHZhciBwYXRoU2VnbWVudCA9IHBhdGhbaV07CiAgICB2YXIgbnVtZXJpY0luZGV4ID0gcGFyc2VJbnQocGF0aFNlZ21lbnQsIDEwKTsKICAgIGlmIChpc0FycmF5KHJlc3VsdCkgJiYgIWlzTmFOKG51bWVyaWNJbmRleCkgJiYgbnVtZXJpY0luZGV4ID49IDAgJiYgbnVtZXJpY0luZGV4IDwgcmVzdWx0Lmxlbmd0aCkgewogICAgICByZXN1bHQgPSByZXN1bHRbbnVtZXJpY0luZGV4XTsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3VsdCA9IHJlc3VsdFtwYXRoU2VnbWVudF07CiAgICB9CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KZnVuY3Rpb24gZ2V0RmllbGRWYWx1ZXMob2JqLCBuYW1lKSB7CiAgdmFyIHBhdGggPSBuYW1lLnNwbGl0KCIuIik7CiAgdmFyIHJlc3VsdHMgPSBbb2JqXTsKICBmb3IgKHZhciBpID0gMDsgaSA8IHBhdGgubGVuZ3RoOyBpKyspIHsKICAgIHZhciBwYXRoU2VnbWVudCA9IHBhdGhbaV07CiAgICB2YXIgbnVtZXJpY0luZGV4ID0gcGFyc2VJbnQocGF0aFNlZ21lbnQsIDEwKTsKICAgIHZhciBuZXdSZXN1bHRzID0gW107CiAgICBmb3IgKHZhciBqID0gMDsgaiA8IHJlc3VsdHMubGVuZ3RoOyBqKyspIHsKICAgICAgdmFyIGN1cnJlbnQgPSByZXN1bHRzW2pdOwogICAgICBpZiAoY3VycmVudCA9PSB2b2lkIDAgfHwgY3VycmVudCA9PSBudWxsKSBjb250aW51ZTsKICAgICAgaWYgKGlzQXJyYXkoY3VycmVudCkgJiYgIWlzTmFOKG51bWVyaWNJbmRleCkgJiYgbnVtZXJpY0luZGV4ID49IDApIHsKICAgICAgICBpZiAobnVtZXJpY0luZGV4IDwgY3VycmVudC5sZW5ndGgpIHsKICAgICAgICAgIG5ld1Jlc3VsdHMucHVzaChjdXJyZW50W251bWVyaWNJbmRleF0pOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChpc0FycmF5KGN1cnJlbnQpKSB7CiAgICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCBjdXJyZW50Lmxlbmd0aDsgaysrKSB7CiAgICAgICAgICBpZiAoY3VycmVudFtrXSAhPSB2b2lkIDAgJiYgY3VycmVudFtrXSAhPSBudWxsICYmIHR5cGVvZiBjdXJyZW50W2tdID09PSAib2JqZWN0IikgewogICAgICAgICAgICBuZXdSZXN1bHRzLnB1c2goY3VycmVudFtrXVtwYXRoU2VnbWVudF0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICh0eXBlb2YgY3VycmVudCA9PT0gIm9iamVjdCIpIHsKICAgICAgICBuZXdSZXN1bHRzLnB1c2goY3VycmVudFtwYXRoU2VnbWVudF0pOwogICAgICB9CiAgICB9CiAgICByZXN1bHRzID0gbmV3UmVzdWx0czsKICB9CiAgcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKGZ1bmN0aW9uKHYpIHsKICAgIHJldHVybiB2ICE9PSB2b2lkIDA7CiAgfSk7CiAgaWYgKHJlc3VsdHMubGVuZ3RoID09PSAwKSByZXR1cm4gdm9pZCAwOwogIGlmIChyZXN1bHRzLmxlbmd0aCA9PT0gMSkgcmV0dXJuIHJlc3VsdHNbMF07CiAgcmV0dXJuIHJlc3VsdHM7Cn0KZnVuY3Rpb24gc2V0UHJvcChvYmosIG5hbWUsIHZhbHVlKSB7CiAgaWYgKG5hbWUuaW5kZXhPZigiJFtdIikgIT09IC0xKSB7CiAgICByZXR1cm4gc2V0UHJvcFdpdGhBbGxQb3NpdGlvbmFsKG9iaiwgbmFtZSwgdmFsdWUpOwogIH0KICB2YXIgcGF0aCA9IG5hbWUuc3BsaXQoIi4iKTsKICB2YXIgY3VycmVudCA9IG9iajsKICBmb3IgKHZhciBpID0gMDsgaSA8IHBhdGgubGVuZ3RoIC0gMTsgaSsrKSB7CiAgICB2YXIgcGF0aFNlZ21lbnQgPSBwYXRoW2ldOwogICAgdmFyIG51bWVyaWNJbmRleCA9IHBhcnNlSW50KHBhdGhTZWdtZW50LCAxMCk7CiAgICBpZiAoaXNBcnJheShjdXJyZW50KSAmJiAhaXNOYU4obnVtZXJpY0luZGV4KSAmJiBudW1lcmljSW5kZXggPj0gMCkgewogICAgICB3aGlsZSAoY3VycmVudC5sZW5ndGggPD0gbnVtZXJpY0luZGV4KSB7CiAgICAgICAgY3VycmVudC5wdXNoKHZvaWQgMCk7CiAgICAgIH0KICAgICAgaWYgKGN1cnJlbnRbbnVtZXJpY0luZGV4XSA9PSB2b2lkIDAgfHwgY3VycmVudFtudW1lcmljSW5kZXhdID09IG51bGwpIHsKICAgICAgICB2YXIgbmV4dFNlZ21lbnQgPSBwYXRoW2kgKyAxXTsKICAgICAgICB2YXIgbmV4dE51bWVyaWMgPSBwYXJzZUludChuZXh0U2VnbWVudCwgMTApOwogICAgICAgIGlmICghaXNOYU4obmV4dE51bWVyaWMpICYmIG5leHROdW1lcmljID49IDApIHsKICAgICAgICAgIGN1cnJlbnRbbnVtZXJpY0luZGV4XSA9IFtdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjdXJyZW50W251bWVyaWNJbmRleF0gPSB7fTsKICAgICAgICB9CiAgICAgIH0KICAgICAgY3VycmVudCA9IGN1cnJlbnRbbnVtZXJpY0luZGV4XTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChjdXJyZW50W3BhdGhTZWdtZW50XSA9PSB2b2lkIDAgfHwgY3VycmVudFtwYXRoU2VnbWVudF0gPT0gbnVsbCkgewogICAgICAgIHZhciBuZXh0U2VnbWVudCA9IHBhdGhbaSArIDFdOwogICAgICAgIHZhciBuZXh0TnVtZXJpYyA9IHBhcnNlSW50KG5leHRTZWdtZW50LCAxMCk7CiAgICAgICAgaWYgKCFpc05hTihuZXh0TnVtZXJpYykgJiYgbmV4dE51bWVyaWMgPj0gMCkgewogICAgICAgICAgY3VycmVudFtwYXRoU2VnbWVudF0gPSBbXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY3VycmVudFtwYXRoU2VnbWVudF0gPSB7fTsKICAgICAgICB9CiAgICAgIH0KICAgICAgY3VycmVudCA9IGN1cnJlbnRbcGF0aFNlZ21lbnRdOwogICAgfQogIH0KICB2YXIgbGFzdFNlZ21lbnQgPSBwYXRoW3BhdGgubGVuZ3RoIC0gMV07CiAgdmFyIGxhc3ROdW1lcmljSW5kZXggPSBwYXJzZUludChsYXN0U2VnbWVudCwgMTApOwogIGlmIChpc0FycmF5KGN1cnJlbnQpICYmICFpc05hTihsYXN0TnVtZXJpY0luZGV4KSAmJiBsYXN0TnVtZXJpY0luZGV4ID49IDApIHsKICAgIHdoaWxlIChjdXJyZW50Lmxlbmd0aCA8PSBsYXN0TnVtZXJpY0luZGV4KSB7CiAgICAgIGN1cnJlbnQucHVzaCh2b2lkIDApOwogICAgfQogICAgY3VycmVudFtsYXN0TnVtZXJpY0luZGV4XSA9IHZhbHVlOwogIH0gZWxzZSB7CiAgICBjdXJyZW50W2xhc3RTZWdtZW50XSA9IHZhbHVlOwogIH0KfQpmdW5jdGlvbiBzZXRQcm9wV2l0aEFsbFBvc2l0aW9uYWwob2JqLCBuYW1lLCB2YWx1ZSkgewogIHZhciBwYXRoID0gbmFtZS5zcGxpdCgiLiIpOwogIHZhciBjdXJyZW50ID0gb2JqOwogIGZvciAodmFyIGkgPSAwOyBpIDwgcGF0aC5sZW5ndGg7IGkrKykgewogICAgdmFyIHBhdGhTZWdtZW50ID0gcGF0aFtpXTsKICAgIGlmIChwYXRoU2VnbWVudCA9PT0gIiRbXSIpIHsKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGN1cnJlbnQpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgcG9zaXRpb25hbCBvcGVyYXRvciBkaWQgbm90IGZpbmQgdGhlIG1hdGNoIG5lZWRlZCBmcm9tIHRoZSBxdWVyeS4iKTsKICAgICAgfQogICAgICB2YXIgcmVtYWluaW5nUGF0aCA9IHBhdGguc2xpY2UoaSArIDEpLmpvaW4oIi4iKTsKICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBjdXJyZW50Lmxlbmd0aDsgaisrKSB7CiAgICAgICAgaWYgKHJlbWFpbmluZ1BhdGgpIHsKICAgICAgICAgIHNldFByb3AoY3VycmVudFtqXSwgcmVtYWluaW5nUGF0aCwgdmFsdWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjdXJyZW50W2pdID0gdmFsdWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBudW1lcmljSW5kZXggPSBwYXJzZUludChwYXRoU2VnbWVudCwgMTApOwogICAgaWYgKGlzQXJyYXkoY3VycmVudCkgJiYgIWlzTmFOKG51bWVyaWNJbmRleCkgJiYgbnVtZXJpY0luZGV4ID49IDApIHsKICAgICAgY3VycmVudCA9IGN1cnJlbnRbbnVtZXJpY0luZGV4XTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChjdXJyZW50W3BhdGhTZWdtZW50XSA9PSB2b2lkIDAgfHwgY3VycmVudFtwYXRoU2VnbWVudF0gPT0gbnVsbCkgewogICAgICAgIHZhciBuZXh0U2VnbWVudCA9IGkgKyAxIDwgcGF0aC5sZW5ndGggPyBwYXRoW2kgKyAxXSA6IG51bGw7CiAgICAgICAgaWYgKG5leHRTZWdtZW50ID09PSAiJFtdIikgewogICAgICAgICAgY3VycmVudFtwYXRoU2VnbWVudF0gPSBbXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIG5leHROdW1lcmljID0gcGFyc2VJbnQobmV4dFNlZ21lbnQsIDEwKTsKICAgICAgICAgIGlmICghaXNOYU4obmV4dE51bWVyaWMpICYmIG5leHROdW1lcmljID49IDApIHsKICAgICAgICAgICAgY3VycmVudFtwYXRoU2VnbWVudF0gPSBbXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGN1cnJlbnRbcGF0aFNlZ21lbnRdID0ge307CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGN1cnJlbnQgPSBjdXJyZW50W3BhdGhTZWdtZW50XTsKICAgIH0KICB9Cn0KZnVuY3Rpb24gaXNBcnJheShvKSB7CiAgcmV0dXJuIEFycmF5ID09IG8uY29uc3RydWN0b3I7Cn0KZnVuY3Rpb24gdG9BcnJheShvYmopIHsKICB2YXIgYXJyID0gW107CiAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgIHZhciBlbCA9IHt9OwogICAgICBlbFtrZXldID0gb2JqW2tleV07CiAgICAgIGFyci5wdXNoKGVsKTsKICAgIH0KICB9CiAgcmV0dXJuIGFycjsKfQpmdW5jdGlvbiBpc0luKHZhbCwgdmFsdWVzKSB7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCB2YWx1ZXMubGVuZ3RoOyBpKyspIHsKICAgIGlmICh2YWx1ZXNFcXVhbCQxKHZhbHVlc1tpXSwgdmFsKSkgcmV0dXJuIHRydWU7CiAgfQogIHJldHVybiBmYWxzZTsKfQpmdW5jdGlvbiBhcnJheU1hdGNoZXMoeCwgeSkgewogIGlmICh4Lmxlbmd0aCAhPSB5Lmxlbmd0aCkgcmV0dXJuIGZhbHNlOwogIGZvciAodmFyIGkgPSAwOyBpIDwgeC5sZW5ndGg7IGkrKykgewogICAgaWYgKHZhbHVlc0VxdWFsJDEoeFtpXSwgeVtpXSkpIGNvbnRpbnVlOwogICAgaWYgKHR5cGVvZiB4W2ldICE9IHR5cGVvZiB5W2ldKSByZXR1cm4gZmFsc2U7CiAgICBpZiAodHlwZW9mIHhbaV0gPT0gIm9iamVjdCIgJiYgeFtpXSAhPT0gbnVsbCkgewogICAgICBpZiAoaXNBcnJheSh4W2ldKSkgewogICAgICAgIGlmICghYXJyYXlNYXRjaGVzKHhbaV0sIHlbaV0pKSByZXR1cm4gZmFsc2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKCFvYmplY3RNYXRjaGVzKHhbaV0sIHlbaV0pKSByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmICghdmFsdWVzRXF1YWwkMSh4W2ldLCB5W2ldKSkgcmV0dXJuIGZhbHNlOwogICAgfQogIH0KICByZXR1cm4gdHJ1ZTsKfQpmdW5jdGlvbiBvYmplY3RNYXRjaGVzKHgsIHkpIHsKICBmb3IgKHZhciBwIGluIHgpIHsKICAgIGlmICgheC5oYXNPd25Qcm9wZXJ0eShwKSkgY29udGludWU7CiAgICBpZiAoIXkuaGFzT3duUHJvcGVydHkocCkpIHJldHVybiBmYWxzZTsKICAgIGlmICh2YWx1ZXNFcXVhbCQxKHhbcF0sIHlbcF0pKSBjb250aW51ZTsKICAgIGlmICh0eXBlb2YgeFtwXSAhPSB0eXBlb2YgeVtwXSkgcmV0dXJuIGZhbHNlOwogICAgaWYgKHR5cGVvZiB4W3BdID09ICJvYmplY3QiICYmIHhbcF0gIT09IG51bGwpIHsKICAgICAgaWYgKGlzQXJyYXkoeFtwXSkpIHsKICAgICAgICBpZiAoIWFycmF5TWF0Y2hlcyh4W3BdLCB5W3BdKSkgcmV0dXJuIGZhbHNlOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICghb2JqZWN0TWF0Y2hlcyh4W3BdLCB5W3BdKSkgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAoIXZhbHVlc0VxdWFsJDEoeFtwXSwgeVtwXSkpIHJldHVybiBmYWxzZTsKICAgIH0KICB9CiAgZm9yICh2YXIgcCBpbiB5KSB7CiAgICBpZiAoeS5oYXNPd25Qcm9wZXJ0eShwKSAmJiAheC5oYXNPd25Qcm9wZXJ0eShwKSkgcmV0dXJuIGZhbHNlOwogIH0KICByZXR1cm4gdHJ1ZTsKfQpmdW5jdGlvbiBhcHBseVByb2plY3Rpb24ocHJvamVjdGlvbiwgZG9jKSB7CiAgdmFyIHJlc3VsdCA9IHt9OwogIHZhciBrZXlzID0gT2JqZWN0LmtleXMocHJvamVjdGlvbik7CiAgaWYgKGtleXMubGVuZ3RoID09IDApIHJldHVybiBkb2M7CiAgdmFyIGhhc0luY2x1c2lvbiA9IGZhbHNlOwogIHZhciBoYXNFeGNsdXNpb24gPSBmYWxzZTsKICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgIGlmIChrZXlzW2ldID09PSAiX2lkIikgY29udGludWU7CiAgICBpZiAocHJvamVjdGlvbltrZXlzW2ldXSkgaGFzSW5jbHVzaW9uID0gdHJ1ZTsKICAgIGVsc2UgaGFzRXhjbHVzaW9uID0gdHJ1ZTsKICB9CiAgaWYgKGhhc0luY2x1c2lvbiAmJiBoYXNFeGNsdXNpb24pIHsKICAgIHRocm93IHsgJGVycjogIkNhbid0IGNhbm9uaWNhbGl6ZSBxdWVyeTogQmFkVmFsdWUgUHJvamVjdGlvbiBjYW5ub3QgaGF2ZSBhIG1peCBvZiBpbmNsdXNpb24gYW5kIGV4Y2x1c2lvbi4iLCBjb2RlOiAxNzI4NyB9OwogIH0KICBpZiAocHJvamVjdGlvbltrZXlzWzBdXSB8fCBoYXNJbmNsdXNpb24pIHsKICAgIGlmIChwcm9qZWN0aW9uLl9pZCAhPT0gMCkgewogICAgICByZXN1bHQuX2lkID0gZG9jLl9pZDsKICAgIH0KICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICBpZiAoa2V5c1tpXSA9PT0gIl9pZCIpIGNvbnRpbnVlOwogICAgICBpZiAoIXByb2plY3Rpb25ba2V5c1tpXV0pIGNvbnRpbnVlOwogICAgICB2YXIgZmllbGRQYXRoID0ga2V5c1tpXTsKICAgICAgdmFyIHZhbHVlID0gZ2V0UHJvcChkb2MsIGZpZWxkUGF0aCk7CiAgICAgIGlmICh2YWx1ZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgc2V0UHJvcChyZXN1bHQsIGZpZWxkUGF0aCwgdmFsdWUpOwogICAgICB9CiAgICB9CiAgfSBlbHNlIHsKICAgIGZvciAodmFyIGtleSBpbiBkb2MpIHsKICAgICAgaWYgKGRvYy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgdmFyIHZhbCA9IGRvY1trZXldOwogICAgICAgIGlmICh0eXBlb2YgdmFsID09PSAib2JqZWN0IiAmJiB2YWwgIT09IG51bGwgJiYgIWlzQXJyYXkodmFsKSkgewogICAgICAgICAgcmVzdWx0W2tleV0gPSBjb3B5KHZhbCk7CiAgICAgICAgfSBlbHNlIGlmIChpc0FycmF5KHZhbCkpIHsKICAgICAgICAgIHJlc3VsdFtrZXldID0gdmFsLnNsaWNlKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdFtrZXldID0gdmFsOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChwcm9qZWN0aW9uW2tleXNbaV1dKSBjb250aW51ZTsKICAgICAgdmFyIGZpZWxkUGF0aCA9IGtleXNbaV07CiAgICAgIHZhciBwYXRoUGFydHMgPSBmaWVsZFBhdGguc3BsaXQoIi4iKTsKICAgICAgaWYgKHBhdGhQYXJ0cy5sZW5ndGggPT09IDEpIHsKICAgICAgICBkZWxldGUgcmVzdWx0W2ZpZWxkUGF0aF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHBhcmVudCA9IHJlc3VsdDsKICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHBhdGhQYXJ0cy5sZW5ndGggLSAxOyBqKyspIHsKICAgICAgICAgIGlmIChwYXJlbnQgPT0gdm9pZCAwIHx8IHBhcmVudCA9PSBudWxsKSBicmVhazsKICAgICAgICAgIHBhcmVudCA9IHBhcmVudFtwYXRoUGFydHNbal1dOwogICAgICAgIH0KICAgICAgICBpZiAocGFyZW50ICE9IHZvaWQgMCAmJiBwYXJlbnQgIT0gbnVsbCkgewogICAgICAgICAgZGVsZXRlIHBhcmVudFtwYXRoUGFydHNbcGF0aFBhcnRzLmxlbmd0aCAtIDFdXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIHJlc3VsdDsKfQpjb25zdCBFcnJvckNvZGVzID0gewogIEJBRF9WQUxVRTogMiwKICBVTktOT1dOX0VSUk9SOiA4LAogIEZBSUxFRF9UT19QQVJTRTogMTcyODcsCiAgLy8gVXNpbmcgdGVzdC1jb21wYXRpYmxlIGVycm9yIGNvZGUKICBOQU1FU1BBQ0VfTk9UX0ZPVU5EOiAyNiwKICBJTkRFWF9OT1RfRk9VTkQ6IDI3LAogIElOREVYX09QVElPTlNfQ09ORkxJQ1Q6IDg1LAogIERVUExJQ0FURV9LRVk6IDExZTMsCiAgLy8gUXVlcnkgZXJyb3JzCiAgQkFEX1FVRVJZOiAyLAogIENBTk5PVF9ET19FWENMVVNJT05fT05fRklFTERfSURfSU5fSU5DTFVTSU9OX1BST0pFQ1RJT046IDMxMjU0LAogIC8vIE5vdCBpbXBsZW1lbnRlZCAoY3VzdG9tIGNvZGUpCiAgTk9UX0lNUExFTUVOVEVEOiA5OTkKfTsKY2xhc3MgTW9uZ29FcnJvciBleHRlbmRzIEVycm9yIHsKICBjb25zdHJ1Y3RvcihtZXNzYWdlLCBvcHRpb25zID0ge30pIHsKICAgIHN1cGVyKG1lc3NhZ2UpOwogICAgdGhpcy5uYW1lID0gIk1vbmdvRXJyb3IiOwogICAgdGhpcy5jb2RlID0gb3B0aW9ucy5jb2RlIHx8IEVycm9yQ29kZXMuVU5LTk9XTl9FUlJPUjsKICAgIHRoaXMuY29kZU5hbWUgPSB0aGlzLl9nZXRDb2RlTmFtZSh0aGlzLmNvZGUpOwogICAgdGhpcy4kZXJyID0gbWVzc2FnZTsKICAgIGlmIChvcHRpb25zLmNvbGxlY3Rpb24pIHRoaXMuY29sbGVjdGlvbiA9IG9wdGlvbnMuY29sbGVjdGlvbjsKICAgIGlmIChvcHRpb25zLmRhdGFiYXNlKSB0aGlzLmRhdGFiYXNlID0gb3B0aW9ucy5kYXRhYmFzZTsKICAgIGlmIChvcHRpb25zLm9wZXJhdGlvbikgdGhpcy5vcGVyYXRpb24gPSBvcHRpb25zLm9wZXJhdGlvbjsKICAgIGlmIChvcHRpb25zLnF1ZXJ5KSB0aGlzLnF1ZXJ5ID0gb3B0aW9ucy5xdWVyeTsKICAgIGlmIChvcHRpb25zLmRvY3VtZW50KSB0aGlzLmRvY3VtZW50ID0gb3B0aW9ucy5kb2N1bWVudDsKICAgIGlmIChvcHRpb25zLmZpZWxkKSB0aGlzLmZpZWxkID0gb3B0aW9ucy5maWVsZDsKICAgIGlmIChvcHRpb25zLmluZGV4KSB0aGlzLmluZGV4ID0gb3B0aW9ucy5pbmRleDsKICAgIGlmIChFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSkgewogICAgICBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSh0aGlzLCB0aGlzLmNvbnN0cnVjdG9yKTsKICAgIH0KICB9CiAgX2dldENvZGVOYW1lKGNvZGUpIHsKICAgIGNvbnN0IGNvZGVUb05hbWUgPSB7CiAgICAgIDA6ICJPSyIsCiAgICAgIDE6ICJJbnRlcm5hbEVycm9yIiwKICAgICAgMjogIkJhZFZhbHVlIiwKICAgICAgNDogIk5vU3VjaEtleSIsCiAgICAgIDU6ICJHcmFwaENvbnRhaW5zQ3ljbGUiLAogICAgICA2OiAiSG9zdFVucmVhY2hhYmxlIiwKICAgICAgNzogIkhvc3ROb3RGb3VuZCIsCiAgICAgIDg6ICJVbmtub3duRXJyb3IiLAogICAgICAxMDogIkNhbm5vdE11dGF0ZU9iamVjdCIsCiAgICAgIDExOiAiVXNlck5vdEZvdW5kIiwKICAgICAgMTI6ICJVbnN1cHBvcnRlZEZvcm1hdCIsCiAgICAgIDEzOiAiVW5hdXRob3JpemVkIiwKICAgICAgMTQ6ICJUeXBlTWlzbWF0Y2giLAogICAgICAxNTogIk92ZXJmbG93IiwKICAgICAgMTY6ICJJbnZhbGlkTGVuZ3RoIiwKICAgICAgMTc6ICJQcm90b2NvbEVycm9yIiwKICAgICAgMTg6ICJBdXRoZW50aWNhdGlvbkZhaWxlZCIsCiAgICAgIDIwOiAiSWxsZWdhbE9wZXJhdGlvbiIsCiAgICAgIDI2OiAiTmFtZXNwYWNlTm90Rm91bmQiLAogICAgICAyNzogIkluZGV4Tm90Rm91bmQiLAogICAgICAyODogIlBhdGhOb3RWaWFibGUiLAogICAgICA0MzogIkN1cnNvck5vdEZvdW5kIiwKICAgICAgNDg6ICJOYW1lc3BhY2VFeGlzdHMiLAogICAgICA1OTogIkNvbW1hbmROb3RGb3VuZCIsCiAgICAgIDY3OiAiQ2Fubm90Q3JlYXRlSW5kZXgiLAogICAgICA2ODogIkluZGV4RXhpc3RzIiwKICAgICAgNzM6ICJJbnZhbGlkTmFtZXNwYWNlIiwKICAgICAgODU6ICJJbmRleE9wdGlvbnNDb25mbGljdCIsCiAgICAgIDExMjogIldyaXRlQ29uZmxpY3QiLAogICAgICAxMjE6ICJEb2N1bWVudFZhbGlkYXRpb25GYWlsdXJlIiwKICAgICAgMTcxOiAiQ2Fubm90SW5kZXhQYXJhbGxlbEFycmF5cyIsCiAgICAgIDE5NzogIkludmFsaWRJbmRleFNwZWNpZmljYXRpb25PcHRpb24iLAogICAgICA5OTg6ICJPcGVyYXRpb25Ob3RTdXBwb3J0ZWQiLAogICAgICA5OTk6ICJOb3RJbXBsZW1lbnRlZCIsCiAgICAgIDExZTM6ICJEdXBsaWNhdGVLZXkiLAogICAgICAxMTAwMTogIkR1cGxpY2F0ZUtleVVwZGF0ZSIsCiAgICAgIDE3Mjg3OiAiRmFpbGVkVG9QYXJzZSIKICAgIH07CiAgICByZXR1cm4gY29kZVRvTmFtZVtjb2RlXSB8fCAiVW5rbm93bkVycm9yIjsKICB9CiAgdG9KU09OKCkgewogICAgY29uc3QganNvbiA9IHsKICAgICAgbmFtZTogdGhpcy5uYW1lLAogICAgICBtZXNzYWdlOiB0aGlzLm1lc3NhZ2UsCiAgICAgIGNvZGU6IHRoaXMuY29kZSwKICAgICAgY29kZU5hbWU6IHRoaXMuY29kZU5hbWUKICAgIH07CiAgICBpZiAodGhpcy5jb2xsZWN0aW9uKSBqc29uLmNvbGxlY3Rpb24gPSB0aGlzLmNvbGxlY3Rpb247CiAgICBpZiAodGhpcy5kYXRhYmFzZSkganNvbi5kYXRhYmFzZSA9IHRoaXMuZGF0YWJhc2U7CiAgICBpZiAodGhpcy5vcGVyYXRpb24pIGpzb24ub3BlcmF0aW9uID0gdGhpcy5vcGVyYXRpb247CiAgICBpZiAodGhpcy5pbmRleCkganNvbi5pbmRleCA9IHRoaXMuaW5kZXg7CiAgICBpZiAodGhpcy5pbmRleE5hbWUpIGpzb24uaW5kZXhOYW1lID0gdGhpcy5pbmRleE5hbWU7CiAgICBpZiAodGhpcy5maWVsZCkganNvbi5maWVsZCA9IHRoaXMuZmllbGQ7CiAgICBpZiAodGhpcy5xdWVyeSkganNvbi5xdWVyeSA9IHRoaXMucXVlcnk7CiAgICBpZiAodGhpcy5kb2N1bWVudCkganNvbi5kb2N1bWVudCA9IHRoaXMuZG9jdW1lbnQ7CiAgICBpZiAodGhpcy5uYW1lc3BhY2UpIGpzb24ubmFtZXNwYWNlID0gdGhpcy5uYW1lc3BhY2U7CiAgICBpZiAodGhpcy5jdXJzb3JJZCkganNvbi5jdXJzb3JJZCA9IHRoaXMuY3Vyc29ySWQ7CiAgICBpZiAodGhpcy5mZWF0dXJlKSBqc29uLmZlYXR1cmUgPSB0aGlzLmZlYXR1cmU7CiAgICBpZiAodGhpcy5rZXlQYXR0ZXJuKSBqc29uLmtleVBhdHRlcm4gPSB0aGlzLmtleVBhdHRlcm47CiAgICBpZiAodGhpcy5rZXlWYWx1ZSkganNvbi5rZXlWYWx1ZSA9IHRoaXMua2V5VmFsdWU7CiAgICBpZiAodGhpcy53cml0ZUVycm9ycykganNvbi53cml0ZUVycm9ycyA9IHRoaXMud3JpdGVFcnJvcnM7CiAgICByZXR1cm4ganNvbjsKICB9Cn0KY2xhc3MgSW5kZXhFcnJvciBleHRlbmRzIE1vbmdvRXJyb3IgewogIGNvbnN0cnVjdG9yKG1lc3NhZ2UsIG9wdGlvbnMgPSB7fSkgewogICAgc3VwZXIobWVzc2FnZSwgb3B0aW9ucyk7CiAgICB0aGlzLm5hbWUgPSAiSW5kZXhFcnJvciI7CiAgfQp9CmNsYXNzIEluZGV4Tm90Rm91bmRFcnJvciBleHRlbmRzIEluZGV4RXJyb3IgewogIGNvbnN0cnVjdG9yKGluZGV4TmFtZSwgb3B0aW9ucyA9IHt9KSB7CiAgICBzdXBlcihgSW5kZXggJyR7aW5kZXhOYW1lfScgbm90IGZvdW5kYCwgewogICAgICAuLi5vcHRpb25zLAogICAgICBjb2RlOiBFcnJvckNvZGVzLklOREVYX05PVF9GT1VORCwKICAgICAgaW5kZXg6IGluZGV4TmFtZQogICAgfSk7CiAgICB0aGlzLm5hbWUgPSAiSW5kZXhOb3RGb3VuZEVycm9yIjsKICAgIHRoaXMuaW5kZXhOYW1lID0gaW5kZXhOYW1lOwogIH0KfQpjbGFzcyBRdWVyeUVycm9yIGV4dGVuZHMgTW9uZ29FcnJvciB7CiAgY29uc3RydWN0b3IobWVzc2FnZSwgb3B0aW9ucyA9IHt9KSB7CiAgICBzdXBlcihtZXNzYWdlLCBvcHRpb25zKTsKICAgIHRoaXMubmFtZSA9ICJRdWVyeUVycm9yIjsKICAgIHRoaXMuY29kZSA9IG9wdGlvbnMuY29kZSB8fCBFcnJvckNvZGVzLkJBRF9RVUVSWTsKICB9Cn0KY2xhc3MgTm90SW1wbGVtZW50ZWRFcnJvciBleHRlbmRzIE1vbmdvRXJyb3IgewogIGNvbnN0cnVjdG9yKGZlYXR1cmUsIG9wdGlvbnMgPSB7fSkgewogICAgc3VwZXIoYCR7ZmVhdHVyZX0gaXMgbm90IGltcGxlbWVudGVkIGluIG1pY3JvLW1vbmdvYCwgewogICAgICAuLi5vcHRpb25zLAogICAgICBjb2RlOiBFcnJvckNvZGVzLk5PVF9JTVBMRU1FTlRFRAogICAgfSk7CiAgICB0aGlzLm5hbWUgPSAiTm90SW1wbGVtZW50ZWRFcnJvciI7CiAgICB0aGlzLmZlYXR1cmUgPSBmZWF0dXJlOwogIH0KfQpjbGFzcyBCYWRWYWx1ZUVycm9yIGV4dGVuZHMgTW9uZ29FcnJvciB7CiAgY29uc3RydWN0b3IoZmllbGQsIHZhbHVlLCByZWFzb24sIG9wdGlvbnMgPSB7fSkgewogICAgc3VwZXIoYEJhZCB2YWx1ZSBmb3IgZmllbGQgJyR7ZmllbGR9JzogJHtyZWFzb259YCwgewogICAgICAuLi5vcHRpb25zLAogICAgICBjb2RlOiBFcnJvckNvZGVzLkJBRF9WQUxVRSwKICAgICAgZmllbGQKICAgIH0pOwogICAgdGhpcy5uYW1lID0gIkJhZFZhbHVlRXJyb3IiOwogICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogIH0KfQpjbGFzcyBDdXJzb3IgewogIGNvbnN0cnVjdG9yKGNvbGxlY3Rpb24sIHF1ZXJ5LCBwcm9qZWN0aW9uLCBkb2N1bWVudHNPclByb21pc2UsIFNvcnRlZEN1cnNvcjIpIHsKICAgIHRoaXMuY29sbGVjdGlvbiA9IGNvbGxlY3Rpb247CiAgICB0aGlzLnF1ZXJ5ID0gcXVlcnk7CiAgICB0aGlzLnByb2plY3Rpb24gPSBwcm9qZWN0aW9uOwogICAgdGhpcy5fZG9jdW1lbnRzUHJvbWlzZSA9IGRvY3VtZW50c09yUHJvbWlzZSBpbnN0YW5jZW9mIFByb21pc2UgPyBkb2N1bWVudHNPclByb21pc2UgOiBQcm9taXNlLnJlc29sdmUoZG9jdW1lbnRzT3JQcm9taXNlKTsKICAgIHRoaXMuZG9jdW1lbnRzID0gbnVsbDsKICAgIHRoaXMuX2luaXRpYWxpemVkID0gZmFsc2U7CiAgICB0aGlzLlNvcnRlZEN1cnNvciA9IFNvcnRlZEN1cnNvcjI7CiAgICBpZiAocHJvamVjdGlvbiAmJiBPYmplY3Qua2V5cyhwcm9qZWN0aW9uKS5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhwcm9qZWN0aW9uKTsKICAgICAgbGV0IGhhc0luY2x1c2lvbiA9IGZhbHNlOwogICAgICBsZXQgaGFzRXhjbHVzaW9uID0gZmFsc2U7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChrZXlzW2ldID09PSAiX2lkIikgY29udGludWU7CiAgICAgICAgaWYgKHByb2plY3Rpb25ba2V5c1tpXV0pIGhhc0luY2x1c2lvbiA9IHRydWU7CiAgICAgICAgZWxzZSBoYXNFeGNsdXNpb24gPSB0cnVlOwogICAgICB9CiAgICAgIGlmIChoYXNJbmNsdXNpb24gJiYgaGFzRXhjbHVzaW9uKSB7CiAgICAgICAgdGhyb3cgbmV3IFF1ZXJ5RXJyb3IoIkNhbid0IGNhbm9uaWNhbGl6ZSBxdWVyeTogQmFkVmFsdWUgUHJvamVjdGlvbiBjYW5ub3QgaGF2ZSBhIG1peCBvZiBpbmNsdXNpb24gYW5kIGV4Y2x1c2lvbi4iLCB7CiAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLkZBSUxFRF9UT19QQVJTRSwKICAgICAgICAgIGNvbGxlY3Rpb246IGNvbGxlY3Rpb24ubmFtZQogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgICB0aGlzLnBvcyA9IDA7CiAgICB0aGlzLl9saW1pdCA9IDA7CiAgICB0aGlzLl9za2lwID0gMDsKICAgIHRoaXMuX2Nsb3NlZCA9IGZhbHNlOwogIH0KICAvKioKICAgKiBFbnN1cmUgZG9jdW1lbnRzIGFyZSBsb2FkZWQgZnJvbSB0aGUgcHJvbWlzZQogICAqIEBwcml2YXRlCiAgICovCiAgYXN5bmMgX2Vuc3VyZUluaXRpYWxpemVkKCkgewogICAgaWYgKCF0aGlzLl9pbml0aWFsaXplZCkgewogICAgICB0aGlzLmRvY3VtZW50cyA9IGF3YWl0IHRoaXMuX2RvY3VtZW50c1Byb21pc2U7CiAgICAgIHRoaXMuX2luaXRpYWxpemVkID0gdHJ1ZTsKICAgIH0KICB9CiAgYmF0Y2hTaXplKHNpemUpIHsKICAgIHRoaXMuX2JhdGNoU2l6ZSA9IHNpemU7CiAgICByZXR1cm4gdGhpczsKICB9CiAgY2xvc2UoKSB7CiAgICB0aGlzLl9jbG9zZWQgPSB0cnVlOwogICAgaWYgKHRoaXMuZG9jdW1lbnRzKSB7CiAgICAgIHRoaXMucG9zID0gdGhpcy5kb2N1bWVudHMubGVuZ3RoOwogICAgfQogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgY29tbWVudChjb21tZW50U3RyaW5nKSB7CiAgICB0aGlzLl9jb21tZW50ID0gY29tbWVudFN0cmluZzsKICAgIHJldHVybiB0aGlzOwogIH0KICBhc3luYyBjb3VudCgpIHsKICAgIGF3YWl0IHRoaXMuX2Vuc3VyZUluaXRpYWxpemVkKCk7CiAgICByZXR1cm4gdGhpcy5kb2N1bWVudHMubGVuZ3RoOwogIH0KICBleHBsYWluKHZlcmJvc2l0eSA9ICJxdWVyeVBsYW5uZXIiKSB7CiAgICByZXR1cm4gewogICAgICBxdWVyeVBsYW5uZXI6IHsKICAgICAgICBwbGFubmVyVmVyc2lvbjogMSwKICAgICAgICBuYW1lc3BhY2U6IGAke3RoaXMuY29sbGVjdGlvbi5kYj8ubmFtZSB8fCAiZGIifS4ke3RoaXMuY29sbGVjdGlvbi5uYW1lfWAsCiAgICAgICAgaW5kZXhGaWx0ZXJTZXQ6IGZhbHNlLAogICAgICAgIHBhcnNlZFF1ZXJ5OiB0aGlzLnF1ZXJ5LAogICAgICAgIHdpbm5pbmdQbGFuOiB7CiAgICAgICAgICBzdGFnZTogIkNPTExTQ0FOIiwKICAgICAgICAgIGZpbHRlcjogdGhpcy5xdWVyeSwKICAgICAgICAgIGRpcmVjdGlvbjogImZvcndhcmQiCiAgICAgICAgfQogICAgICB9LAogICAgICBleGVjdXRpb25TdGF0czogdmVyYm9zaXR5ID09PSAiZXhlY3V0aW9uU3RhdHMiIHx8IHZlcmJvc2l0eSA9PT0gImFsbFBsYW5zRXhlY3V0aW9uIiA/IHsKICAgICAgICBleGVjdXRpb25TdWNjZXNzOiB0cnVlLAogICAgICAgIG5SZXR1cm5lZDogdGhpcy5kb2N1bWVudHMgPyB0aGlzLmRvY3VtZW50cy5sZW5ndGggOiAwLAogICAgICAgIGV4ZWN1dGlvblRpbWVNaWxsaXM6IDAsCiAgICAgICAgdG90YWxLZXlzRXhhbWluZWQ6IDAsCiAgICAgICAgdG90YWxEb2NzRXhhbWluZWQ6IHRoaXMuZG9jdW1lbnRzID8gdGhpcy5kb2N1bWVudHMubGVuZ3RoIDogMAogICAgICB9IDogdm9pZCAwLAogICAgICBvazogMQogICAgfTsKICB9CiAgYXN5bmMgZm9yRWFjaChmbikgewogICAgYXdhaXQgdGhpcy5fZW5zdXJlSW5pdGlhbGl6ZWQoKTsKICAgIHdoaWxlIChhd2FpdCB0aGlzLmhhc05leHQoKSkgewogICAgICBhd2FpdCBmbihhd2FpdCB0aGlzLm5leHQoKSk7CiAgICB9CiAgfQogIGFzeW5jIGhhc05leHQoKSB7CiAgICBpZiAodGhpcy5fY2xvc2VkKSByZXR1cm4gZmFsc2U7CiAgICBhd2FpdCB0aGlzLl9lbnN1cmVJbml0aWFsaXplZCgpOwogICAgaWYgKHRoaXMucG9zID09PSAwICYmIHRoaXMuX3NraXAgPiAwKSB7CiAgICAgIHRoaXMucG9zID0gTWF0aC5taW4odGhpcy5fc2tpcCwgdGhpcy5kb2N1bWVudHMubGVuZ3RoKTsKICAgIH0KICAgIGxldCBlZmZlY3RpdmVNYXg7CiAgICBpZiAodGhpcy5fbGltaXQgPiAwKSB7CiAgICAgIGVmZmVjdGl2ZU1heCA9IE1hdGgubWluKHRoaXMuX3NraXAgKyB0aGlzLl9saW1pdCwgdGhpcy5kb2N1bWVudHMubGVuZ3RoKTsKICAgIH0gZWxzZSB7CiAgICAgIGVmZmVjdGl2ZU1heCA9IHRoaXMuZG9jdW1lbnRzLmxlbmd0aDsKICAgIH0KICAgIHJldHVybiB0aGlzLnBvcyA8IGVmZmVjdGl2ZU1heDsKICB9CiAgaGludChpbmRleCkgewogICAgdGhpcy5faGludCA9IGluZGV4OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGFzeW5jIGl0Y291bnQoKSB7CiAgICBhd2FpdCB0aGlzLl9lbnN1cmVJbml0aWFsaXplZCgpOwogICAgbGV0IGNvdW50ID0gMDsKICAgIHdoaWxlIChhd2FpdCB0aGlzLmhhc05leHQoKSkgewogICAgICBhd2FpdCB0aGlzLm5leHQoKTsKICAgICAgY291bnQrKzsKICAgIH0KICAgIHJldHVybiBjb3VudDsKICB9CiAgbGltaXQoX21heCkgewogICAgdGhpcy5fbGltaXQgPSBfbWF4OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGFzeW5jIG1hcChmbikgewogICAgYXdhaXQgdGhpcy5fZW5zdXJlSW5pdGlhbGl6ZWQoKTsKICAgIGNvbnN0IHJlc3VsdHMgPSBbXTsKICAgIHdoaWxlIChhd2FpdCB0aGlzLmhhc05leHQoKSkgewogICAgICByZXN1bHRzLnB1c2goYXdhaXQgZm4oYXdhaXQgdGhpcy5uZXh0KCkpKTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH0KICBtYXhTY2FuKG1heFNjYW4pIHsKICAgIHRoaXMuX21heFNjYW4gPSBtYXhTY2FuOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIG1heFRpbWVNUyhtcykgewogICAgdGhpcy5fbWF4VGltZU1TID0gbXM7CiAgICByZXR1cm4gdGhpczsKICB9CiAgbWF4KGluZGV4Qm91bmRzKSB7CiAgICB0aGlzLl9tYXhJbmRleEJvdW5kcyA9IGluZGV4Qm91bmRzOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIG1pbihpbmRleEJvdW5kcykgewogICAgdGhpcy5fbWluSW5kZXhCb3VuZHMgPSBpbmRleEJvdW5kczsKICAgIHJldHVybiB0aGlzOwogIH0KICBhc3luYyBuZXh0KCkgewogICAgaWYgKCFhd2FpdCB0aGlzLmhhc05leHQoKSkgewogICAgICB0aHJvdyBuZXcgUXVlcnlFcnJvcigiRXJyb3I6IGVycm9yIGhhc05leHQ6IGZhbHNlIiwgewogICAgICAgIGNvbGxlY3Rpb246IHRoaXMuY29sbGVjdGlvbi5uYW1lCiAgICAgIH0pOwogICAgfQogICAgY29uc3QgcmVzdWx0ID0gdGhpcy5kb2N1bWVudHNbdGhpcy5wb3MrK107CiAgICBpZiAodGhpcy5wcm9qZWN0aW9uKSB7CiAgICAgIHJldHVybiBhcHBseVByb2plY3Rpb24odGhpcy5wcm9qZWN0aW9uLCByZXN1bHQpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgbm9DdXJzb3JUaW1lb3V0KCkgewogICAgdGhpcy5fbm9DdXJzb3JUaW1lb3V0ID0gdHJ1ZTsKICAgIHJldHVybiB0aGlzOwogIH0KICBvYmpzTGVmdEluQmF0Y2goKSB7CiAgICBpZiAoIXRoaXMuZG9jdW1lbnRzKSByZXR1cm4gMDsKICAgIHJldHVybiB0aGlzLnNpemUoKTsKICB9CiAgcHJldHR5KCkgewogICAgdGhpcy5fcHJldHR5ID0gdHJ1ZTsKICAgIHJldHVybiB0aGlzOwogIH0KICByZWFkQ29uY2VybihsZXZlbCkgewogICAgdGhpcy5fcmVhZENvbmNlcm4gPSBsZXZlbDsKICAgIHJldHVybiB0aGlzOwogIH0KICByZWFkUHJlZihtb2RlLCB0YWdTZXQpIHsKICAgIHRoaXMuX3JlYWRQcmVmID0geyBtb2RlLCB0YWdTZXQgfTsKICAgIHJldHVybiB0aGlzOwogIH0KICByZXR1cm5LZXkoZW5hYmxlZCA9IHRydWUpIHsKICAgIHRoaXMuX3JldHVybktleSA9IGVuYWJsZWQ7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2hvd1JlY29yZElkKGVuYWJsZWQgPSB0cnVlKSB7CiAgICB0aGlzLl9zaG93UmVjb3JkSWQgPSBlbmFibGVkOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNpemUoKSB7CiAgICBpZiAoIXRoaXMuZG9jdW1lbnRzKSByZXR1cm4gMDsKICAgIGNvbnN0IHJlbWFpbmluZyA9IHRoaXMuZG9jdW1lbnRzLmxlbmd0aCAtIHRoaXMucG9zOwogICAgaWYgKHRoaXMuX2xpbWl0ID4gMCkgewogICAgICBjb25zdCBtYXhQb3MgPSB0aGlzLl9za2lwICsgdGhpcy5fbGltaXQ7CiAgICAgIHJldHVybiBNYXRoLm1pbihtYXhQb3MgLSB0aGlzLnBvcywgcmVtYWluaW5nKTsKICAgIH0KICAgIHJldHVybiByZW1haW5pbmc7CiAgfQogIHNraXAobnVtKSB7CiAgICB0aGlzLl9za2lwID0gbnVtOwogICAgaWYgKHRoaXMucG9zID09PSAwKSB7CiAgICAgIGlmICh0aGlzLmRvY3VtZW50cykgewogICAgICAgIHRoaXMucG9zID0gTWF0aC5taW4obnVtLCB0aGlzLmRvY3VtZW50cy5sZW5ndGgpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgaXNDbG9zZWQoKSB7CiAgICByZXR1cm4gdGhpcy5fY2xvc2VkID09PSB0cnVlOwogIH0KICBzbmFwc2hvdCgpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJzbmFwc2hvdCIpOwogIH0KICBzb3J0KHMpIHsKICAgIHJldHVybiBuZXcgdGhpcy5Tb3J0ZWRDdXJzb3IodGhpcy5jb2xsZWN0aW9uLCB0aGlzLnF1ZXJ5LCB0aGlzLCBzKTsKICB9CiAgYWxsb3dEaXNrVXNlKGVuYWJsZWQgPSB0cnVlKSB7CiAgICB0aGlzLl9hbGxvd0Rpc2tVc2UgPSBlbmFibGVkOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGNvbGxhdGlvbihjb2xsYXRpb25Eb2N1bWVudCkgewogICAgdGhpcy5fY29sbGF0aW9uID0gY29sbGF0aW9uRG9jdW1lbnQ7CiAgICByZXR1cm4gdGhpczsKICB9CiAgdGFpbGFibGUoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigidGFpbGFibGUiKTsKICB9CiAgYXN5bmMgdG9BcnJheSgpIHsKICAgIGF3YWl0IHRoaXMuX2Vuc3VyZUluaXRpYWxpemVkKCk7CiAgICBjb25zdCByZXN1bHRzID0gW107CiAgICB3aGlsZSAoYXdhaXQgdGhpcy5oYXNOZXh0KCkpIHsKICAgICAgcmVzdWx0cy5wdXNoKGF3YWl0IHRoaXMubmV4dCgpKTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH0KICAvLyBTdXBwb3J0IGZvciBhc3luYyBpdGVyYXRpb24gKGZvciBhd2FpdC4uLm9mKQogIGFzeW5jICpbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCkgewogICAgYXdhaXQgdGhpcy5fZW5zdXJlSW5pdGlhbGl6ZWQoKTsKICAgIHdoaWxlIChhd2FpdCB0aGlzLmhhc05leHQoKSkgewogICAgICB5aWVsZCBhd2FpdCB0aGlzLm5leHQoKTsKICAgIH0KICB9Cn0KY2xhc3MgU29ydGVkQ3Vyc29yIHsKICBjb25zdHJ1Y3Rvcihjb2xsZWN0aW9uLCBxdWVyeSwgY3Vyc29yLCBzb3J0KSB7CiAgICB0aGlzLmNvbGxlY3Rpb24gPSBjb2xsZWN0aW9uOwogICAgdGhpcy5xdWVyeSA9IHF1ZXJ5OwogICAgdGhpcy5zb3J0U3BlYyA9IHNvcnQ7CiAgICB0aGlzLnBvcyA9IDA7CiAgICB0aGlzLl9jdXJzb3IgPSBjdXJzb3I7CiAgICB0aGlzLl9zb3J0ID0gc29ydDsKICAgIHRoaXMuX2luaXRpYWxpemVkID0gZmFsc2U7CiAgICB0aGlzLml0ZW1zID0gbnVsbDsKICB9CiAgYXN5bmMgX2Vuc3VyZUluaXRpYWxpemVkKCkgewogICAgaWYgKHRoaXMuX2luaXRpYWxpemVkKSByZXR1cm47CiAgICBhd2FpdCB0aGlzLl9jdXJzb3IuX2Vuc3VyZUluaXRpYWxpemVkKCk7CiAgICB0aGlzLml0ZW1zID0gW107CiAgICB3aGlsZSAoYXdhaXQgdGhpcy5fY3Vyc29yLmhhc05leHQoKSkgewogICAgICB0aGlzLml0ZW1zLnB1c2goYXdhaXQgdGhpcy5fY3Vyc29yLm5leHQoKSk7CiAgICB9CiAgICBjb25zdCBzb3J0S2V5cyA9IE9iamVjdC5rZXlzKHRoaXMuX3NvcnQpOwogICAgdGhpcy5pdGVtcy5zb3J0KChmdW5jdGlvbihhLCBiKSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc29ydEtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoYVtzb3J0S2V5c1tpXV0gPT0gdm9pZCAwICYmIGJbc29ydEtleXNbaV1dICE9IHZvaWQgMCkgcmV0dXJuIC0xICogdGhpcy5fc29ydFtzb3J0S2V5c1tpXV07CiAgICAgICAgaWYgKGFbc29ydEtleXNbaV1dICE9IHZvaWQgMCAmJiBiW3NvcnRLZXlzW2ldXSA9PSB2b2lkIDApIHJldHVybiAxICogdGhpcy5fc29ydFtzb3J0S2V5c1tpXV07CiAgICAgICAgaWYgKGFbc29ydEtleXNbaV1dIDwgYltzb3J0S2V5c1tpXV0pIHJldHVybiAtMSAqIHRoaXMuX3NvcnRbc29ydEtleXNbaV1dOwogICAgICAgIGlmIChhW3NvcnRLZXlzW2ldXSA+IGJbc29ydEtleXNbaV1dKSByZXR1cm4gMSAqIHRoaXMuX3NvcnRbc29ydEtleXNbaV1dOwogICAgICB9CiAgICAgIHJldHVybiAwOwogICAgfSkuYmluZCh0aGlzKSk7CiAgICB0aGlzLl9pbml0aWFsaXplZCA9IHRydWU7CiAgfQogIGJhdGNoU2l6ZSgpIHsKICAgIHRocm93ICJOb3QgSW1wbGVtZW50ZWQiOwogIH0KICBjbG9zZSgpIHsKICAgIHRocm93ICJOb3QgSW1wbGVtZW50ZWQiOwogIH0KICBjb21tZW50KCkgewogICAgdGhyb3cgIk5vdCBJbXBsZW1lbnRlZCI7CiAgfQogIGFzeW5jIGNvdW50KCkgewogICAgYXdhaXQgdGhpcy5fZW5zdXJlSW5pdGlhbGl6ZWQoKTsKICAgIHJldHVybiB0aGlzLml0ZW1zLmxlbmd0aDsKICB9CiAgZXhwbGFpbigpIHsKICAgIHRocm93ICJOb3QgSW1wbGVtZW50ZWQiOwogIH0KICBhc3luYyBmb3JFYWNoKGZuKSB7CiAgICBhd2FpdCB0aGlzLl9lbnN1cmVJbml0aWFsaXplZCgpOwogICAgd2hpbGUgKGF3YWl0IHRoaXMuaGFzTmV4dCgpKSB7CiAgICAgIGF3YWl0IGZuKGF3YWl0IHRoaXMubmV4dCgpKTsKICAgIH0KICB9CiAgYXN5bmMgaGFzTmV4dCgpIHsKICAgIGF3YWl0IHRoaXMuX2Vuc3VyZUluaXRpYWxpemVkKCk7CiAgICByZXR1cm4gdGhpcy5wb3MgPCB0aGlzLml0ZW1zLmxlbmd0aDsKICB9CiAgaGludCgpIHsKICAgIHRocm93ICJOb3QgSW1wbGVtZW50ZWQiOwogIH0KICBpdGNvdW50KCkgewogICAgdGhyb3cgIk5vdCBJbXBsZW1lbnRlZCI7CiAgfQogIGFzeW5jIGxpbWl0KG1heCkgewogICAgYXdhaXQgdGhpcy5fZW5zdXJlSW5pdGlhbGl6ZWQoKTsKICAgIHRoaXMuaXRlbXMgPSB0aGlzLml0ZW1zLnNsaWNlKDAsIG1heCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgYXN5bmMgbWFwKGZuKSB7CiAgICBhd2FpdCB0aGlzLl9lbnN1cmVJbml0aWFsaXplZCgpOwogICAgY29uc3QgcmVzdWx0cyA9IFtdOwogICAgd2hpbGUgKGF3YWl0IHRoaXMuaGFzTmV4dCgpKSB7CiAgICAgIHJlc3VsdHMucHVzaChhd2FpdCBmbihhd2FpdCB0aGlzLm5leHQoKSkpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdHM7CiAgfQogIG1heFNjYW4oKSB7CiAgICB0aHJvdyAiTm90IEltcGxlbWVudGVkIjsKICB9CiAgbWF4VGltZU1TKCkgewogICAgdGhyb3cgIk5vdCBJbXBsZW1lbnRlZCI7CiAgfQogIG1heCgpIHsKICAgIHRocm93ICJOb3QgSW1wbGVtZW50ZWQiOwogIH0KICBtaW4oKSB7CiAgICB0aHJvdyAiTm90IEltcGxlbWVudGVkIjsKICB9CiAgYXN5bmMgbmV4dCgpIHsKICAgIGF3YWl0IHRoaXMuX2Vuc3VyZUluaXRpYWxpemVkKCk7CiAgICByZXR1cm4gdGhpcy5pdGVtc1t0aGlzLnBvcysrXTsKICB9CiAgbm9DdXJzb3JUaW1lb3V0KCkgewogICAgdGhyb3cgIk5vdCBJbXBsZW1lbnRlZCI7CiAgfQogIG9ianNMZWZ0SW5CYXRjaCgpIHsKICAgIHRocm93ICJOb3QgSW1wbGVtZW50ZWQiOwogIH0KICBwcmV0dHkoKSB7CiAgICB0aHJvdyAiTm90IEltcGxlbWVudGVkIjsKICB9CiAgcmVhZENvbmNlcm4oKSB7CiAgICB0aHJvdyAiTm90IEltcGxlbWVudGVkIjsKICB9CiAgcmVhZFByZWYoKSB7CiAgICB0aHJvdyAiTm90IEltcGxlbWVudGVkIjsKICB9CiAgcmV0dXJuS2V5KCkgewogICAgdGhyb3cgIk5vdCBJbXBsZW1lbnRlZCI7CiAgfQogIHNob3dSZWNvcmRJZCgpIHsKICAgIHRocm93ICJOb3QgSW1wbGVtZW50ZWQiOwogIH0KICBzaXplKCkgewogICAgdGhyb3cgIk5vdCBJbXBsZW1lbnRlZCI7CiAgfQogIGFzeW5jIHNraXAobnVtKSB7CiAgICBhd2FpdCB0aGlzLl9lbnN1cmVJbml0aWFsaXplZCgpOwogICAgd2hpbGUgKG51bSA+IDApIHsKICAgICAgYXdhaXQgdGhpcy5uZXh0KCk7CiAgICAgIG51bS0tOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNuYXBzaG90KCkgewogICAgdGhyb3cgIk5vdCBJbXBsZW1lbnRlZCI7CiAgfQogIHNvcnQocykgewogICAgcmV0dXJuIG5ldyBTb3J0ZWRDdXJzb3IodGhpcy5jb2xsZWN0aW9uLCB0aGlzLnF1ZXJ5LCB0aGlzLCBzKTsKICB9CiAgdGFpbGFibGUoKSB7CiAgICB0aHJvdyAiTm90IEltcGxlbWVudGVkIjsKICB9CiAgYXN5bmMgdG9BcnJheSgpIHsKICAgIGF3YWl0IHRoaXMuX2Vuc3VyZUluaXRpYWxpemVkKCk7CiAgICBjb25zdCByZXN1bHRzID0gW107CiAgICB3aGlsZSAoYXdhaXQgdGhpcy5oYXNOZXh0KCkpIHsKICAgICAgcmVzdWx0cy5wdXNoKHRoaXMubmV4dCgpKTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH0KICAvLyBTdXBwb3J0IGZvciBhc3luYyBpdGVyYXRpb24gKGZvciBhd2FpdC4uLm9mKQogIGFzeW5jICpbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCkgewogICAgYXdhaXQgdGhpcy5fZW5zdXJlSW5pdGlhbGl6ZWQoKTsKICAgIHdoaWxlIChhd2FpdCB0aGlzLmhhc05leHQoKSkgewogICAgICB5aWVsZCBhd2FpdCB0aGlzLm5leHQoKTsKICAgIH0KICB9Cn0KY29uc3Qgc3RlcDJsaXN0ID0gewogIGF0aW9uYWw6ICJhdGUiLAogIHRpb25hbDogInRpb24iLAogIGVuY2k6ICJlbmNlIiwKICBhbmNpOiAiYW5jZSIsCiAgaXplcjogIml6ZSIsCiAgYmxpOiAiYmxlIiwKICBhbGxpOiAiYWwiLAogIGVudGxpOiAiZW50IiwKICBlbGk6ICJlIiwKICBvdXNsaTogIm91cyIsCiAgaXphdGlvbjogIml6ZSIsCiAgYXRpb246ICJhdGUiLAogIGF0b3I6ICJhdGUiLAogIGFsaXNtOiAiYWwiLAogIGl2ZW5lc3M6ICJpdmUiLAogIGZ1bG5lc3M6ICJmdWwiLAogIG91c25lc3M6ICJvdXMiLAogIGFsaXRpOiAiYWwiLAogIGl2aXRpOiAiaXZlIiwKICBiaWxpdGk6ICJibGUiLAogIGxvZ2k6ICJsb2ciCn07CmNvbnN0IHN0ZXAzbGlzdCA9IHsKICBpY2F0ZTogImljIiwKICBhdGl2ZTogIiIsCiAgYWxpemU6ICJhbCIsCiAgaWNpdGk6ICJpYyIsCiAgaWNhbDogImljIiwKICBmdWw6ICIiLAogIG5lc3M6ICIiCn07CmNvbnN0IGNvbnNvbmFudCA9ICJbXmFlaW91XSI7CmNvbnN0IHZvd2VsID0gIlthZWlvdXldIjsKY29uc3QgY29uc29uYW50cyA9ICIoIiArIGNvbnNvbmFudCArICJbXmFlaW91eV0qKSI7CmNvbnN0IHZvd2VscyA9ICIoIiArIHZvd2VsICsgIlthZWlvdV0qKSI7CmNvbnN0IGd0MCA9IG5ldyBSZWdFeHAoIl4iICsgY29uc29uYW50cyArICI/IiArIHZvd2VscyArIGNvbnNvbmFudHMpOwpjb25zdCBlcTEgPSBuZXcgUmVnRXhwKAogICJeIiArIGNvbnNvbmFudHMgKyAiPyIgKyB2b3dlbHMgKyBjb25zb25hbnRzICsgdm93ZWxzICsgIj8kIgopOwpjb25zdCBndDEgPSBuZXcgUmVnRXhwKCJeIiArIGNvbnNvbmFudHMgKyAiPygiICsgdm93ZWxzICsgY29uc29uYW50cyArICIpezIsfSIpOwpjb25zdCB2b3dlbEluU3RlbSA9IG5ldyBSZWdFeHAoIl4iICsgY29uc29uYW50cyArICI/IiArIHZvd2VsKTsKY29uc3QgY29uc29uYW50TGlrZSA9IG5ldyBSZWdFeHAoIl4iICsgY29uc29uYW50cyArIHZvd2VsICsgIlteYWVpb3V3eHldJCIpOwpjb25zdCBzZnhMbCA9IC9sbCQvOwpjb25zdCBzZnhFID0gL14oLis/KWUkLzsKY29uc3Qgc2Z4WSA9IC9eKC4rPyl5JC87CmNvbnN0IHNmeElvbiA9IC9eKC4rPyhzfHQpKShpb24pJC87CmNvbnN0IHNmeEVkT3JJbmcgPSAvXiguKz8pKGVkfGluZykkLzsKY29uc3Qgc2Z4QXRPckJsT3JJeiA9IC8oYXR8Ymx8aXopJC87CmNvbnN0IHNmeEVFRCA9IC9eKC4rPyllZWQkLzsKY29uc3Qgc2Z4UyA9IC9eLis/W15zXXMkLzsKY29uc3Qgc2Z4U3Nlc09ySWVzID0gL14uKz8oc3N8aSllcyQvOwpjb25zdCBzZnhNdWx0aUNvbnNvbmFudExpa2UgPSAvKFteYWVpb3V5bHN6XSlcMSQvOwpjb25zdCBzdGVwMiA9IC9eKC4rPykoYXRpb25hbHx0aW9uYWx8ZW5jaXxhbmNpfGl6ZXJ8YmxpfGFsbGl8ZW50bGl8ZWxpfG91c2xpfGl6YXRpb258YXRpb258YXRvcnxhbGlzbXxpdmVuZXNzfGZ1bG5lc3N8b3VzbmVzc3xhbGl0aXxpdml0aXxiaWxpdGl8bG9naSkkLzsKY29uc3Qgc3RlcDMgPSAvXiguKz8pKGljYXRlfGF0aXZlfGFsaXplfGljaXRpfGljYWx8ZnVsfG5lc3MpJC87CmNvbnN0IHN0ZXA0ID0gL14oLis/KShhbHxhbmNlfGVuY2V8ZXJ8aWN8YWJsZXxpYmxlfGFudHxlbWVudHxtZW50fGVudHxvdXxpc218YXRlfGl0aXxvdXN8aXZlfGl6ZSkkLzsKZnVuY3Rpb24gc3RlbW1lcih2YWx1ZSkgewogIGxldCByZXN1bHQgPSBTdHJpbmcodmFsdWUpLnRvTG93ZXJDYXNlKCk7CiAgaWYgKHJlc3VsdC5sZW5ndGggPCAzKSB7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBsZXQgZmlyc3RDaGFyYWN0ZXJXYXNMb3dlckNhc2VZID0gZmFsc2U7CiAgaWYgKHJlc3VsdC5jb2RlUG9pbnRBdCgwKSA9PT0gMTIxKSB7CiAgICBmaXJzdENoYXJhY3Rlcldhc0xvd2VyQ2FzZVkgPSB0cnVlOwogICAgcmVzdWx0ID0gIlkiICsgcmVzdWx0LnNsaWNlKDEpOwogIH0KICBpZiAoc2Z4U3Nlc09ySWVzLnRlc3QocmVzdWx0KSkgewogICAgcmVzdWx0ID0gcmVzdWx0LnNsaWNlKDAsIC0yKTsKICB9IGVsc2UgaWYgKHNmeFMudGVzdChyZXN1bHQpKSB7CiAgICByZXN1bHQgPSByZXN1bHQuc2xpY2UoMCwgLTEpOwogIH0KICBsZXQgbWF0Y2g7CiAgaWYgKG1hdGNoID0gc2Z4RUVELmV4ZWMocmVzdWx0KSkgewogICAgaWYgKGd0MC50ZXN0KG1hdGNoWzFdKSkgewogICAgICByZXN1bHQgPSByZXN1bHQuc2xpY2UoMCwgLTEpOwogICAgfQogIH0gZWxzZSBpZiAoKG1hdGNoID0gc2Z4RWRPckluZy5leGVjKHJlc3VsdCkpICYmIHZvd2VsSW5TdGVtLnRlc3QobWF0Y2hbMV0pKSB7CiAgICByZXN1bHQgPSBtYXRjaFsxXTsKICAgIGlmIChzZnhBdE9yQmxPckl6LnRlc3QocmVzdWx0KSkgewogICAgICByZXN1bHQgKz0gImUiOwogICAgfSBlbHNlIGlmIChzZnhNdWx0aUNvbnNvbmFudExpa2UudGVzdChyZXN1bHQpKSB7CiAgICAgIHJlc3VsdCA9IHJlc3VsdC5zbGljZSgwLCAtMSk7CiAgICB9IGVsc2UgaWYgKGNvbnNvbmFudExpa2UudGVzdChyZXN1bHQpKSB7CiAgICAgIHJlc3VsdCArPSAiZSI7CiAgICB9CiAgfQogIGlmICgobWF0Y2ggPSBzZnhZLmV4ZWMocmVzdWx0KSkgJiYgdm93ZWxJblN0ZW0udGVzdChtYXRjaFsxXSkpIHsKICAgIHJlc3VsdCA9IG1hdGNoWzFdICsgImkiOwogIH0KICBpZiAoKG1hdGNoID0gc3RlcDIuZXhlYyhyZXN1bHQpKSAmJiBndDAudGVzdChtYXRjaFsxXSkpIHsKICAgIHJlc3VsdCA9IG1hdGNoWzFdICsgc3RlcDJsaXN0W21hdGNoWzJdXTsKICB9CiAgaWYgKChtYXRjaCA9IHN0ZXAzLmV4ZWMocmVzdWx0KSkgJiYgZ3QwLnRlc3QobWF0Y2hbMV0pKSB7CiAgICByZXN1bHQgPSBtYXRjaFsxXSArIHN0ZXAzbGlzdFttYXRjaFsyXV07CiAgfQogIGlmIChtYXRjaCA9IHN0ZXA0LmV4ZWMocmVzdWx0KSkgewogICAgaWYgKGd0MS50ZXN0KG1hdGNoWzFdKSkgewogICAgICByZXN1bHQgPSBtYXRjaFsxXTsKICAgIH0KICB9IGVsc2UgaWYgKChtYXRjaCA9IHNmeElvbi5leGVjKHJlc3VsdCkpICYmIGd0MS50ZXN0KG1hdGNoWzFdKSkgewogICAgcmVzdWx0ID0gbWF0Y2hbMV07CiAgfQogIGlmICgobWF0Y2ggPSBzZnhFLmV4ZWMocmVzdWx0KSkgJiYgKGd0MS50ZXN0KG1hdGNoWzFdKSB8fCBlcTEudGVzdChtYXRjaFsxXSkgJiYgIWNvbnNvbmFudExpa2UudGVzdChtYXRjaFsxXSkpKSB7CiAgICByZXN1bHQgPSBtYXRjaFsxXTsKICB9CiAgaWYgKHNmeExsLnRlc3QocmVzdWx0KSAmJiBndDEudGVzdChyZXN1bHQpKSB7CiAgICByZXN1bHQgPSByZXN1bHQuc2xpY2UoMCwgLTEpOwogIH0KICBpZiAoZmlyc3RDaGFyYWN0ZXJXYXNMb3dlckNhc2VZKSB7CiAgICByZXN1bHQgPSAieSIgKyByZXN1bHQuc2xpY2UoMSk7CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KY2xhc3MgTm9kZURhdGEgewogIC8qKgogICAqIENyZWF0ZXMgYSBub2RlIGRhdGEgb2JqZWN0IGZvciBzZXJpYWxpemF0aW9uCiAgICogQHBhcmFtIHtudW1iZXJ9IGlkIC0gVW5pcXVlIG5vZGUgSUQKICAgKiBAcGFyYW0ge2Jvb2xlYW59IGlzTGVhZiAtIExlYWYgZmxhZwogICAqIEBwYXJhbSB7QXJyYXl9IGtleXMgLSBLZXkgYXJyYXkKICAgKiBAcGFyYW0ge0FycmF5fSB2YWx1ZXMgLSBWYWx1ZSBhcnJheSAobGVhZiBub2RlcykKICAgKiBAcGFyYW0ge0FycmF5fSBjaGlsZHJlbiAtIENoaWxkIHBvaW50ZXJzIChpbnRlcm5hbCBub2RlcykKICAgKiBAcGFyYW0ge1BvaW50ZXJ9IG5leHQgLSBQb2ludGVyIHRvIG5leHQgbGVhZgogICAqLwogIGNvbnN0cnVjdG9yKGlkLCBpc0xlYWYsIGtleXMsIHZhbHVlcywgY2hpbGRyZW4sIG5leHQpIHsKICAgIHRoaXMuaWQgPSBpZDsKICAgIHRoaXMuaXNMZWFmID0gaXNMZWFmOwogICAgdGhpcy5rZXlzID0ga2V5czsKICAgIHRoaXMudmFsdWVzID0gdmFsdWVzOwogICAgdGhpcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgZm9yIChsZXQgdiBvZiBjaGlsZHJlbikgewogICAgICBpZiAoISh2IGluc3RhbmNlb2YgUG9pbnRlcikpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNoaWxkcmVuIG11c3QgYmUgUG9pbnRlciBvYmplY3RzIik7CiAgICAgIH0KICAgIH0KICAgIHRoaXMubmV4dCA9IG5leHQ7CiAgfQp9CmNsYXNzIEJQbHVzVHJlZSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhIG5ldyBwZXJzaXN0ZW50IEIrIHRyZWUKICAgKiBAcGFyYW0ge0ZpbGVTeXN0ZW1TeW5jQWNjZXNzSGFuZGxlfSBzeW5jSGFuZGxlIC0gU3luYyBhY2Nlc3MgaGFuZGxlIHRvIHN0b3JhZ2UgZmlsZQogICAqIEBwYXJhbSB7bnVtYmVyfSBvcmRlciAtIFRyZWUgb3JkZXIgKGRlZmF1bHQ6IDMpCiAgICovCiAgY29uc3RydWN0b3Ioc3luY0hhbmRsZSwgb3JkZXIgPSAzKSB7CiAgICBpZiAob3JkZXIgPCAzKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiQisgdHJlZSBvcmRlciBtdXN0IGJlIGF0IGxlYXN0IDMiKTsKICAgIH0KICAgIHRoaXMuZmlsZSA9IG5ldyBCSnNvbkZpbGUoc3luY0hhbmRsZSk7CiAgICB0aGlzLm9yZGVyID0gb3JkZXI7CiAgICB0aGlzLm1pbktleXMgPSBNYXRoLmNlaWwob3JkZXIgLyAyKSAtIDE7CiAgICB0aGlzLmlzT3BlbiA9IGZhbHNlOwogICAgdGhpcy5yb290UG9pbnRlciA9IG51bGw7CiAgICB0aGlzLm5leHROb2RlSWQgPSAwOwogICAgdGhpcy5fc2l6ZSA9IDA7CiAgfQogIC8qKgogICAqIE9wZW4gdGhlIHRyZWUgKGxvYWQgb3IgaW5pdGlhbGl6ZSBtZXRhZGF0YSkKICAgKi8KICBhc3luYyBvcGVuKCkgewogICAgaWYgKHRoaXMuaXNPcGVuKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVHJlZSBpcyBhbHJlYWR5IG9wZW4iKTsKICAgIH0KICAgIGNvbnN0IGZpbGVTaXplID0gdGhpcy5maWxlLmdldEZpbGVTaXplKCk7CiAgICBjb25zdCBleGlzdHMgPSBmaWxlU2l6ZSA+IDA7CiAgICBpZiAoZXhpc3RzKSB7CiAgICAgIHRoaXMuX2xvYWRNZXRhZGF0YSgpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5faW5pdGlhbGl6ZU5ld1RyZWUoKTsKICAgIH0KICAgIHRoaXMuaXNPcGVuID0gdHJ1ZTsKICB9CiAgLyoqCiAgICogQ2xvc2UgdGhlIHRyZWUgYW5kIHNhdmUgbWV0YWRhdGEKICAgKi8KICBhc3luYyBjbG9zZSgpIHsKICAgIGlmICh0aGlzLmlzT3BlbikgewogICAgICBpZiAodGhpcy5maWxlICYmIHRoaXMuZmlsZS5zeW5jQWNjZXNzSGFuZGxlKSB7CiAgICAgICAgdGhpcy5maWxlLmZsdXNoKCk7CiAgICAgICAgYXdhaXQgdGhpcy5maWxlLnN5bmNBY2Nlc3NIYW5kbGUuY2xvc2UoKTsKICAgICAgfQogICAgICB0aGlzLmlzT3BlbiA9IGZhbHNlOwogICAgfQogIH0KICAvKioKICAgKiBJbml0aWFsaXplIGEgbmV3IGVtcHR5IHRyZWUKICAgKi8KICBfaW5pdGlhbGl6ZU5ld1RyZWUoKSB7CiAgICBjb25zdCByb290Tm9kZSA9IG5ldyBOb2RlRGF0YSgwLCB0cnVlLCBbXSwgW10sIFtdLCBudWxsKTsKICAgIHRoaXMubmV4dE5vZGVJZCA9IDE7CiAgICB0aGlzLl9zaXplID0gMDsKICAgIGNvbnN0IHJvb3RQb2ludGVyID0gdGhpcy5fc2F2ZU5vZGUocm9vdE5vZGUpOwogICAgdGhpcy5yb290UG9pbnRlciA9IHJvb3RQb2ludGVyOwogICAgdGhpcy5fc2F2ZU1ldGFkYXRhKCk7CiAgfQogIC8qKgogICAqIFNhdmUgbWV0YWRhdGEgdG8gZmlsZQogICAqLwogIF9zYXZlTWV0YWRhdGEoKSB7CiAgICBjb25zdCBtZXRhZGF0YSA9IHsKICAgICAgdmVyc2lvbjogMSwKICAgICAgbWF4RW50cmllczogdGhpcy5vcmRlciwKICAgICAgLy8gUmVuYW1lZCB0byBtYXRjaCBSVHJlZSBzaXplCiAgICAgIG1pbkVudHJpZXM6IHRoaXMubWluS2V5cywKICAgICAgLy8gUmVuYW1lZCB0byBtYXRjaCBSVHJlZSBzaXplCiAgICAgIHNpemU6IHRoaXMuX3NpemUsCiAgICAgIHJvb3RQb2ludGVyOiB0aGlzLnJvb3RQb2ludGVyLAogICAgICBuZXh0SWQ6IHRoaXMubmV4dE5vZGVJZAogICAgICAvLyBSZW5hbWVkIHRvIG1hdGNoIFJUcmVlIHNpemUKICAgIH07CiAgICB0aGlzLmZpbGUuYXBwZW5kKG1ldGFkYXRhKTsKICB9CiAgLyoqCiAgICogTG9hZCBtZXRhZGF0YSBmcm9tIGZpbGUKICAgKi8KICBfbG9hZE1ldGFkYXRhKCkgewogICAgY29uc3QgZmlsZVNpemUgPSB0aGlzLmZpbGUuZ2V0RmlsZVNpemUoKTsKICAgIGNvbnN0IE1FVEFEQVRBX1NJWkUgPSAxMzU7CiAgICBpZiAoZmlsZVNpemUgPCBNRVRBREFUQV9TSVpFKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCB0cmVlIGZpbGUiKTsKICAgIH0KICAgIGNvbnN0IG1ldGFkYXRhT2Zmc2V0ID0gZmlsZVNpemUgLSBNRVRBREFUQV9TSVpFOwogICAgY29uc3QgbWV0YWRhdGEgPSB0aGlzLmZpbGUucmVhZChtZXRhZGF0YU9mZnNldCk7CiAgICBpZiAoIW1ldGFkYXRhIHx8IHR5cGVvZiBtZXRhZGF0YS5tYXhFbnRyaWVzID09PSAidW5kZWZpbmVkIikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byByZWFkIG1ldGFkYXRhOiBtaXNzaW5nIHJlcXVpcmVkIGZpZWxkc2ApOwogICAgfQogICAgdGhpcy5vcmRlciA9IG1ldGFkYXRhLm1heEVudHJpZXM7CiAgICB0aGlzLm1pbktleXMgPSBtZXRhZGF0YS5taW5FbnRyaWVzOwogICAgdGhpcy5fc2l6ZSA9IG1ldGFkYXRhLnNpemU7CiAgICB0aGlzLm5leHROb2RlSWQgPSBtZXRhZGF0YS5uZXh0SWQ7CiAgICB0aGlzLnJvb3RQb2ludGVyID0gbWV0YWRhdGEucm9vdFBvaW50ZXI7CiAgfQogIC8qKgogICAqIFNhdmUgYSBub2RlIHRvIGRpc2sKICAgKi8KICBfc2F2ZU5vZGUobm9kZSkgewogICAgY29uc3Qgb2Zmc2V0ID0gdGhpcy5maWxlLmdldEZpbGVTaXplKCk7CiAgICB0aGlzLmZpbGUuYXBwZW5kKG5vZGUpOwogICAgcmV0dXJuIG5ldyBQb2ludGVyKG9mZnNldCk7CiAgfQogIC8qKgogICAqIExvYWQgYSBub2RlIGZyb20gZGlzawogICAqLwogIF9sb2FkTm9kZShwb2ludGVyKSB7CiAgICBpZiAoIShwb2ludGVyIGluc3RhbmNlb2YgUG9pbnRlcikpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBQb2ludGVyIG9iamVjdCIpOwogICAgfQogICAgY29uc3QgZGF0YSA9IHRoaXMuZmlsZS5yZWFkKHBvaW50ZXIpOwogICAgcmV0dXJuIG5ldyBOb2RlRGF0YSgKICAgICAgZGF0YS5pZCwKICAgICAgZGF0YS5pc0xlYWYsCiAgICAgIGRhdGEua2V5cywKICAgICAgZGF0YS52YWx1ZXMsCiAgICAgIGRhdGEuY2hpbGRyZW4sCiAgICAgIGRhdGEubmV4dAogICAgKTsKICB9CiAgLyoqCiAgICogTG9hZCByb290IG5vZGUKICAgKi8KICBfbG9hZFJvb3QoKSB7CiAgICByZXR1cm4gdGhpcy5fbG9hZE5vZGUodGhpcy5yb290UG9pbnRlcik7CiAgfQogIC8qKgogICAqIFNlYXJjaCBmb3IgYSBrZXkKICAgKi8KICBzZWFyY2goa2V5KSB7CiAgICBjb25zdCByb290ID0gdGhpcy5fbG9hZFJvb3QoKTsKICAgIHJldHVybiB0aGlzLl9zZWFyY2hOb2RlKHJvb3QsIGtleSk7CiAgfQogIC8qKgogICAqIEludGVybmFsIHNlYXJjaAogICAqLwogIF9zZWFyY2hOb2RlKG5vZGUsIGtleSkgewogICAgaWYgKG5vZGUuaXNMZWFmKSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZS5rZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKGtleSA9PT0gbm9kZS5rZXlzW2ldKSB7CiAgICAgICAgICByZXR1cm4gbm9kZS52YWx1ZXNbaV07CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9IGVsc2UgewogICAgICBsZXQgaSA9IDA7CiAgICAgIHdoaWxlIChpIDwgbm9kZS5rZXlzLmxlbmd0aCAmJiBrZXkgPj0gbm9kZS5rZXlzW2ldKSB7CiAgICAgICAgaSsrOwogICAgICB9CiAgICAgIGNvbnN0IGNoaWxkID0gdGhpcy5fbG9hZE5vZGUobm9kZS5jaGlsZHJlbltpXSk7CiAgICAgIHJldHVybiB0aGlzLl9zZWFyY2hOb2RlKGNoaWxkLCBrZXkpOwogICAgfQogIH0KICAvKioKICAgKiBJbnNlcnQgYSBrZXktdmFsdWUgcGFpcgogICAqLwogIGFkZChrZXksIHZhbHVlKSB7CiAgICBjb25zdCByb290ID0gdGhpcy5fbG9hZFJvb3QoKTsKICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuX2FkZFRvTm9kZShyb290LCBrZXksIHZhbHVlKTsKICAgIGxldCBuZXdSb290OwogICAgaWYgKHJlc3VsdC5uZXdOb2RlKSB7CiAgICAgIG5ld1Jvb3QgPSByZXN1bHQubmV3Tm9kZTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IGxlZnRQb2ludGVyID0gdGhpcy5fc2F2ZU5vZGUocmVzdWx0LmxlZnQpOwogICAgICBjb25zdCByaWdodFBvaW50ZXIgPSB0aGlzLl9zYXZlTm9kZShyZXN1bHQucmlnaHQpOwogICAgICBuZXdSb290ID0gbmV3IE5vZGVEYXRhKAogICAgICAgIHRoaXMubmV4dE5vZGVJZCsrLAogICAgICAgIGZhbHNlLAogICAgICAgIFtyZXN1bHQuc3BsaXRLZXldLAogICAgICAgIFtdLAogICAgICAgIFtsZWZ0UG9pbnRlciwgcmlnaHRQb2ludGVyXSwKICAgICAgICBudWxsCiAgICAgICk7CiAgICB9CiAgICBjb25zdCByb290UG9pbnRlciA9IHRoaXMuX3NhdmVOb2RlKG5ld1Jvb3QpOwogICAgdGhpcy5yb290UG9pbnRlciA9IHJvb3RQb2ludGVyOwogICAgdGhpcy5fc2l6ZSsrOwogICAgdGhpcy5fc2F2ZU1ldGFkYXRhKCk7CiAgfQogIC8qKgogICAqIEludGVybmFsIGFkZAogICAqLwogIF9hZGRUb05vZGUobm9kZSwga2V5LCB2YWx1ZSkgewogICAgaWYgKG5vZGUuaXNMZWFmKSB7CiAgICAgIGNvbnN0IGtleXMgPSBbLi4ubm9kZS5rZXlzXTsKICAgICAgY29uc3QgdmFsdWVzID0gWy4uLm5vZGUudmFsdWVzXTsKICAgICAgY29uc3QgZXhpc3RpbmdJZHggPSBrZXlzLmluZGV4T2Yoa2V5KTsKICAgICAgaWYgKGV4aXN0aW5nSWR4ICE9PSAtMSkgewogICAgICAgIHZhbHVlc1tleGlzdGluZ0lkeF0gPSB2YWx1ZTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgbmV3Tm9kZTogbmV3IE5vZGVEYXRhKG5vZGUuaWQsIHRydWUsIGtleXMsIHZhbHVlcywgW10sIG51bGwpCiAgICAgICAgfTsKICAgICAgfQogICAgICBsZXQgaW5zZXJ0SWR4ID0gMDsKICAgICAgd2hpbGUgKGluc2VydElkeCA8IGtleXMubGVuZ3RoICYmIGtleSA+IGtleXNbaW5zZXJ0SWR4XSkgewogICAgICAgIGluc2VydElkeCsrOwogICAgICB9CiAgICAgIGtleXMuc3BsaWNlKGluc2VydElkeCwgMCwga2V5KTsKICAgICAgdmFsdWVzLnNwbGljZShpbnNlcnRJZHgsIDAsIHZhbHVlKTsKICAgICAgaWYgKGtleXMubGVuZ3RoIDwgdGhpcy5vcmRlcikgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBuZXdOb2RlOiBuZXcgTm9kZURhdGEobm9kZS5pZCwgdHJ1ZSwga2V5cywgdmFsdWVzLCBbXSwgbnVsbCkKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IG1pZCA9IE1hdGguY2VpbChrZXlzLmxlbmd0aCAvIDIpOwogICAgICAgIGNvbnN0IGxlZnRLZXlzID0ga2V5cy5zbGljZSgwLCBtaWQpOwogICAgICAgIGNvbnN0IGxlZnRWYWx1ZXMgPSB2YWx1ZXMuc2xpY2UoMCwgbWlkKTsKICAgICAgICBjb25zdCByaWdodEtleXMgPSBrZXlzLnNsaWNlKG1pZCk7CiAgICAgICAgY29uc3QgcmlnaHRWYWx1ZXMgPSB2YWx1ZXMuc2xpY2UobWlkKTsKICAgICAgICBjb25zdCByaWdodE5vZGUgPSBuZXcgTm9kZURhdGEodGhpcy5uZXh0Tm9kZUlkKyssIHRydWUsIHJpZ2h0S2V5cywgcmlnaHRWYWx1ZXMsIFtdLCBudWxsKTsKICAgICAgICBjb25zdCBsZWZ0Tm9kZSA9IG5ldyBOb2RlRGF0YShub2RlLmlkLCB0cnVlLCBsZWZ0S2V5cywgbGVmdFZhbHVlcywgW10sIG51bGwpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBsZWZ0OiBsZWZ0Tm9kZSwKICAgICAgICAgIHJpZ2h0OiByaWdodE5vZGUsCiAgICAgICAgICBzcGxpdEtleTogcmlnaHRLZXlzWzBdCiAgICAgICAgfTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY29uc3Qga2V5cyA9IFsuLi5ub2RlLmtleXNdOwogICAgICBjb25zdCBjaGlsZHJlbiA9IFsuLi5ub2RlLmNoaWxkcmVuXTsKICAgICAgbGV0IGNoaWxkSWR4ID0gMDsKICAgICAgd2hpbGUgKGNoaWxkSWR4IDwga2V5cy5sZW5ndGggJiYga2V5ID49IGtleXNbY2hpbGRJZHhdKSB7CiAgICAgICAgY2hpbGRJZHgrKzsKICAgICAgfQogICAgICBjb25zdCBjaGlsZE5vZGUgPSB0aGlzLl9sb2FkTm9kZShjaGlsZHJlbltjaGlsZElkeF0pOwogICAgICBjb25zdCByZXN1bHQgPSB0aGlzLl9hZGRUb05vZGUoY2hpbGROb2RlLCBrZXksIHZhbHVlKTsKICAgICAgaWYgKHJlc3VsdC5uZXdOb2RlKSB7CiAgICAgICAgY29uc3QgbmV3Q2hpbGRQb2ludGVyID0gdGhpcy5fc2F2ZU5vZGUocmVzdWx0Lm5ld05vZGUpOwogICAgICAgIGNoaWxkcmVuW2NoaWxkSWR4XSA9IG5ld0NoaWxkUG9pbnRlcjsKICAgICAgICByZXR1cm4gewogICAgICAgICAgbmV3Tm9kZTogbmV3IE5vZGVEYXRhKG5vZGUuaWQsIGZhbHNlLCBrZXlzLCBbXSwgY2hpbGRyZW4sIG51bGwpCiAgICAgICAgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBsZWZ0UG9pbnRlciA9IHRoaXMuX3NhdmVOb2RlKHJlc3VsdC5sZWZ0KTsKICAgICAgICBjb25zdCByaWdodFBvaW50ZXIgPSB0aGlzLl9zYXZlTm9kZShyZXN1bHQucmlnaHQpOwogICAgICAgIGtleXMuc3BsaWNlKGNoaWxkSWR4LCAwLCByZXN1bHQuc3BsaXRLZXkpOwogICAgICAgIGNoaWxkcmVuLnNwbGljZShjaGlsZElkeCwgMSwgbGVmdFBvaW50ZXIsIHJpZ2h0UG9pbnRlcik7CiAgICAgICAgaWYgKGtleXMubGVuZ3RoIDwgdGhpcy5vcmRlcikgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgbmV3Tm9kZTogbmV3IE5vZGVEYXRhKG5vZGUuaWQsIGZhbHNlLCBrZXlzLCBbXSwgY2hpbGRyZW4sIG51bGwpCiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCBtaWQgPSBNYXRoLmNlaWwoa2V5cy5sZW5ndGggLyAyKSAtIDE7CiAgICAgICAgICBjb25zdCBzcGxpdEtleSA9IGtleXNbbWlkXTsKICAgICAgICAgIGNvbnN0IGxlZnRLZXlzID0ga2V5cy5zbGljZSgwLCBtaWQpOwogICAgICAgICAgY29uc3QgcmlnaHRLZXlzID0ga2V5cy5zbGljZShtaWQgKyAxKTsKICAgICAgICAgIGNvbnN0IGxlZnRDaGlsZHJlbiA9IGNoaWxkcmVuLnNsaWNlKDAsIG1pZCArIDEpOwogICAgICAgICAgY29uc3QgcmlnaHRDaGlsZHJlbiA9IGNoaWxkcmVuLnNsaWNlKG1pZCArIDEpOwogICAgICAgICAgY29uc3QgbGVmdE5vZGUgPSBuZXcgTm9kZURhdGEobm9kZS5pZCwgZmFsc2UsIGxlZnRLZXlzLCBbXSwgbGVmdENoaWxkcmVuLCBudWxsKTsKICAgICAgICAgIGNvbnN0IHJpZ2h0Tm9kZSA9IG5ldyBOb2RlRGF0YSh0aGlzLm5leHROb2RlSWQrKywgZmFsc2UsIHJpZ2h0S2V5cywgW10sIHJpZ2h0Q2hpbGRyZW4sIG51bGwpOwogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgbGVmdDogbGVmdE5vZGUsCiAgICAgICAgICAgIHJpZ2h0OiByaWdodE5vZGUsCiAgICAgICAgICAgIHNwbGl0S2V5CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICAvKioKICAgKiBEZWxldGUgYSBrZXkKICAgKi8KICBkZWxldGUoa2V5KSB7CiAgICBjb25zdCByb290ID0gdGhpcy5fbG9hZFJvb3QoKTsKICAgIGNvbnN0IG5ld1Jvb3QgPSB0aGlzLl9kZWxldGVGcm9tTm9kZShyb290LCBrZXkpOwogICAgaWYgKCFuZXdSb290KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGxldCBmaW5hbFJvb3QgPSBuZXdSb290OwogICAgaWYgKGZpbmFsUm9vdC5rZXlzLmxlbmd0aCA9PT0gMCAmJiAhZmluYWxSb290LmlzTGVhZiAmJiBmaW5hbFJvb3QuY2hpbGRyZW4ubGVuZ3RoID4gMCkgewogICAgICBmaW5hbFJvb3QgPSB0aGlzLl9sb2FkTm9kZShmaW5hbFJvb3QuY2hpbGRyZW5bMF0pOwogICAgfQogICAgY29uc3Qgcm9vdFBvaW50ZXIgPSB0aGlzLl9zYXZlTm9kZShmaW5hbFJvb3QpOwogICAgdGhpcy5yb290UG9pbnRlciA9IHJvb3RQb2ludGVyOwogICAgdGhpcy5fc2l6ZS0tOwogICAgdGhpcy5fc2F2ZU1ldGFkYXRhKCk7CiAgfQogIC8qKgogICAqIEludGVybmFsIGRlbGV0ZQogICAqLwogIF9kZWxldGVGcm9tTm9kZShub2RlLCBrZXkpIHsKICAgIGlmIChub2RlLmlzTGVhZikgewogICAgICBjb25zdCBrZXlJbmRleCA9IG5vZGUua2V5cy5pbmRleE9mKGtleSk7CiAgICAgIGlmIChrZXlJbmRleCA9PT0gLTEpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICBjb25zdCBuZXdLZXlzID0gWy4uLm5vZGUua2V5c107CiAgICAgIGNvbnN0IG5ld1ZhbHVlcyA9IFsuLi5ub2RlLnZhbHVlc107CiAgICAgIG5ld0tleXMuc3BsaWNlKGtleUluZGV4LCAxKTsKICAgICAgbmV3VmFsdWVzLnNwbGljZShrZXlJbmRleCwgMSk7CiAgICAgIHJldHVybiBuZXcgTm9kZURhdGEobm9kZS5pZCwgdHJ1ZSwgbmV3S2V5cywgbmV3VmFsdWVzLCBbXSwgbm9kZS5uZXh0KTsKICAgIH0gZWxzZSB7CiAgICAgIGxldCBpID0gMDsKICAgICAgd2hpbGUgKGkgPCBub2RlLmtleXMubGVuZ3RoICYmIGtleSA+PSBub2RlLmtleXNbaV0pIHsKICAgICAgICBpKys7CiAgICAgIH0KICAgICAgY29uc3QgY2hpbGROb2RlID0gdGhpcy5fbG9hZE5vZGUobm9kZS5jaGlsZHJlbltpXSk7CiAgICAgIGNvbnN0IG5ld0NoaWxkID0gdGhpcy5fZGVsZXRlRnJvbU5vZGUoY2hpbGROb2RlLCBrZXkpOwogICAgICBpZiAoIW5ld0NoaWxkKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgY29uc3QgbmV3Q2hpbGRyZW4gPSBbLi4ubm9kZS5jaGlsZHJlbl07CiAgICAgIGNvbnN0IG5ld0NoaWxkUG9pbnRlciA9IHRoaXMuX3NhdmVOb2RlKG5ld0NoaWxkKTsKICAgICAgbmV3Q2hpbGRyZW5baV0gPSBuZXdDaGlsZFBvaW50ZXI7CiAgICAgIHJldHVybiBuZXcgTm9kZURhdGEobm9kZS5pZCwgZmFsc2UsIFsuLi5ub2RlLmtleXNdLCBbXSwgbmV3Q2hpbGRyZW4sIG51bGwpOwogICAgfQogIH0KICAvKioKICAgKiBHZXQgYWxsIGVudHJpZXMgYXMgYXJyYXkKICAgKi8KICB0b0FycmF5KCkgewogICAgY29uc3QgcmVzdWx0ID0gW107CiAgICB0aGlzLl9jb2xsZWN0QWxsRW50cmllcyh0aGlzLl9sb2FkUm9vdCgpLCByZXN1bHQpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgLyoqCiAgICogQXN5bmMgaXRlcmF0b3IgZm9yIGVmZmljaWVudGx5IHRyYXZlcnNpbmcgYWxsIGVudHJpZXMgd2l0aG91dCBsb2FkaW5nIGV2ZXJ5dGhpbmcgaW50byBtZW1vcnkKICAgKiBFbmFibGVzIHVzYWdlOiBgZm9yIGF3YWl0IChjb25zdCBlbnRyeSBvZiB0cmVlKSB7IC4uLiB9YAogICAqIEVhY2ggZW50cnkgaGFzIHNoYXBlOiB7IGtleSwgdmFsdWUgfQogICAqLwogIGFzeW5jICpbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCkgewogICAgaWYgKCF0aGlzLmlzT3BlbikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlRyZWUgbXVzdCBiZSBvcGVuIGJlZm9yZSBpdGVyYXRpb24iKTsKICAgIH0KICAgIGlmICh0aGlzLl9zaXplID09PSAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHlpZWxkKiB0aGlzLl9pdGVyYXRlTm9kZSh0aGlzLl9sb2FkUm9vdCgpKTsKICB9CiAgLyoqCiAgICogSGVscGVyIGdlbmVyYXRvciB0byByZWN1cnNpdmVseSBpdGVyYXRlIHRocm91Z2ggYSBub2RlCiAgICogQHByaXZhdGUKICAgKi8KICAqX2l0ZXJhdGVOb2RlKG5vZGUpIHsKICAgIGlmIChub2RlLmlzTGVhZikgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUua2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIHlpZWxkIHsKICAgICAgICAgIGtleTogbm9kZS5rZXlzW2ldLAogICAgICAgICAgdmFsdWU6IG5vZGUudmFsdWVzW2ldCiAgICAgICAgfTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZm9yIChjb25zdCBjaGlsZFBvaW50ZXIgb2Ygbm9kZS5jaGlsZHJlbikgewogICAgICAgIGNvbnN0IGNoaWxkID0gdGhpcy5fbG9hZE5vZGUoY2hpbGRQb2ludGVyKTsKICAgICAgICB5aWVsZCogdGhpcy5faXRlcmF0ZU5vZGUoY2hpbGQpOwogICAgICB9CiAgICB9CiAgfQogIC8qKgogICAqIENvbGxlY3QgYWxsIGVudHJpZXMgaW4gc29ydGVkIG9yZGVyIGJ5IHRyYXZlcnNpbmcgdHJlZQogICAqIEBwcml2YXRlCiAgICovCiAgX2NvbGxlY3RBbGxFbnRyaWVzKG5vZGUsIHJlc3VsdCkgewogICAgaWYgKG5vZGUuaXNMZWFmKSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZS5rZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcmVzdWx0LnB1c2goewogICAgICAgICAga2V5OiBub2RlLmtleXNbaV0sCiAgICAgICAgICB2YWx1ZTogbm9kZS52YWx1ZXNbaV0KICAgICAgICB9KTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZm9yIChjb25zdCBjaGlsZFBvaW50ZXIgb2Ygbm9kZS5jaGlsZHJlbikgewogICAgICAgIGNvbnN0IGNoaWxkID0gdGhpcy5fbG9hZE5vZGUoY2hpbGRQb2ludGVyKTsKICAgICAgICB0aGlzLl9jb2xsZWN0QWxsRW50cmllcyhjaGlsZCwgcmVzdWx0KTsKICAgICAgfQogICAgfQogIH0KICAvKioKICAgKiBHZXQgdHJlZSBzaXplCiAgICovCiAgc2l6ZSgpIHsKICAgIHJldHVybiB0aGlzLl9zaXplOwogIH0KICAvKioKICAgKiBDaGVjayBpZiBlbXB0eQogICAqLwogIGlzRW1wdHkoKSB7CiAgICByZXR1cm4gdGhpcy5fc2l6ZSA9PT0gMDsKICB9CiAgLyoqCiAgICogUmFuZ2Ugc2VhcmNoCiAgICovCiAgcmFuZ2VTZWFyY2gobWluS2V5LCBtYXhLZXkpIHsKICAgIGNvbnN0IHJlc3VsdCA9IFtdOwogICAgdGhpcy5fcmFuZ2VTZWFyY2hOb2RlKHRoaXMuX2xvYWRSb290KCksIG1pbktleSwgbWF4S2V5LCByZXN1bHQpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgLyoqCiAgICogUmFuZ2Ugc2VhcmNoIGhlbHBlciB0aGF0IHRyYXZlcnNlcyB0cmVlCiAgICogQHByaXZhdGUKICAgKi8KICBfcmFuZ2VTZWFyY2hOb2RlKG5vZGUsIG1pbktleSwgbWF4S2V5LCByZXN1bHQpIHsKICAgIGlmIChub2RlLmlzTGVhZikgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUua2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChub2RlLmtleXNbaV0gPj0gbWluS2V5ICYmIG5vZGUua2V5c1tpXSA8PSBtYXhLZXkpIHsKICAgICAgICAgIHJlc3VsdC5wdXNoKHsKICAgICAgICAgICAga2V5OiBub2RlLmtleXNbaV0sCiAgICAgICAgICAgIHZhbHVlOiBub2RlLnZhbHVlc1tpXQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBmb3IgKGNvbnN0IGNoaWxkUG9pbnRlciBvZiBub2RlLmNoaWxkcmVuKSB7CiAgICAgICAgY29uc3QgY2hpbGQgPSB0aGlzLl9sb2FkTm9kZShjaGlsZFBvaW50ZXIpOwogICAgICAgIHRoaXMuX3JhbmdlU2VhcmNoTm9kZShjaGlsZCwgbWluS2V5LCBtYXhLZXksIHJlc3VsdCk7CiAgICAgIH0KICAgIH0KICB9CiAgLyoqCiAgICogR2V0IHRyZWUgaGVpZ2h0CiAgICovCiAgZ2V0SGVpZ2h0KCkgewogICAgbGV0IGhlaWdodCA9IDA7CiAgICBsZXQgY3VycmVudCA9IHRoaXMuX2xvYWRSb290KCk7CiAgICB3aGlsZSAoIWN1cnJlbnQuaXNMZWFmKSB7CiAgICAgIGhlaWdodCsrOwogICAgICBjdXJyZW50ID0gdGhpcy5fbG9hZE5vZGUoY3VycmVudC5jaGlsZHJlblswXSk7CiAgICB9CiAgICByZXR1cm4gaGVpZ2h0OwogIH0KICAvKioKICAgKiBDb21wYWN0IHRoZSB0cmVlIGJ5IGNvcHlpbmcgYWxsIGxpdmUgZW50cmllcyBpbnRvIGEgbmV3IGZpbGUuCiAgICogUmV0dXJucyBzaXplIG1ldHJpY3Mgc28gY2FsbGVycyBjYW4gc2VlIGhvdyBtdWNoIHNwYWNlIHdhcyByZWNsYWltZWQuCiAgICogQHBhcmFtIHtGaWxlU3lzdGVtU3luY0FjY2Vzc0hhbmRsZX0gZGVzdFN5bmNIYW5kbGUgLSBTeW5jIGhhbmRsZSBmb3IgZGVzdGluYXRpb24gZmlsZQogICAqIEByZXR1cm5zIHtQcm9taXNlPHtvbGRTaXplOm51bWJlcixuZXdTaXplOm51bWJlcixieXRlc1NhdmVkOm51bWJlcn0+fQogICAqLwogIGFzeW5jIGNvbXBhY3QoZGVzdFN5bmNIYW5kbGUpIHsKICAgIGlmICghdGhpcy5pc09wZW4pIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJUcmVlIGZpbGUgaXMgbm90IG9wZW4iKTsKICAgIH0KICAgIGlmICghZGVzdFN5bmNIYW5kbGUpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJEZXN0aW5hdGlvbiBzeW5jIGhhbmRsZSBpcyByZXF1aXJlZCBmb3IgY29tcGFjdGlvbiIpOwogICAgfQogICAgY29uc3Qgb2xkU2l6ZSA9IHRoaXMuZmlsZS5nZXRGaWxlU2l6ZSgpOwogICAgY29uc3QgZW50cmllcyA9IHRoaXMudG9BcnJheSgpOwogICAgY29uc3QgbmV3VHJlZSA9IG5ldyBCUGx1c1RyZWUoZGVzdFN5bmNIYW5kbGUsIHRoaXMub3JkZXIpOwogICAgYXdhaXQgbmV3VHJlZS5vcGVuKCk7CiAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIGVudHJpZXMpIHsKICAgICAgYXdhaXQgbmV3VHJlZS5hZGQoZW50cnkua2V5LCBlbnRyeS52YWx1ZSk7CiAgICB9CiAgICBjb25zdCBuZXdTaXplID0gbmV3VHJlZS5maWxlLmdldEZpbGVTaXplKCk7CiAgICBhd2FpdCBuZXdUcmVlLmNsb3NlKCk7CiAgICByZXR1cm4gewogICAgICBvbGRTaXplLAogICAgICBuZXdTaXplLAogICAgICBieXRlc1NhdmVkOiBNYXRoLm1heCgwLCBvbGRTaXplIC0gbmV3U2l6ZSkKICAgIH07CiAgfQp9CmNvbnN0IFNUT1BXT1JEUyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsKICAiYSIsCiAgImFib3V0IiwKICAiYWZ0ZXIiLAogICJhbGwiLAogICJhbHNvIiwKICAiYW0iLAogICJhbiIsCiAgImFuZCIsCiAgImFub3RoZXIiLAogICJhbnkiLAogICJhcmUiLAogICJhcm91bmQiLAogICJhcyIsCiAgImF0IiwKICAiYmUiLAogICJiZWNhdXNlIiwKICAiYmVlbiIsCiAgImJlZm9yZSIsCiAgImJlaW5nIiwKICAiYmV0d2VlbiIsCiAgImJvdGgiLAogICJidXQiLAogICJieSIsCiAgImNhbWUiLAogICJjYW4iLAogICJjb21lIiwKICAiY291bGQiLAogICJkaWQiLAogICJkbyIsCiAgImVhY2giLAogICJmb3IiLAogICJmcm9tIiwKICAiZ2V0IiwKICAiZ290IiwKICAiaGFzIiwKICAiaGFkIiwKICAiaGUiLAogICJoYXZlIiwKICAiaGVyIiwKICAiaGVyZSIsCiAgImhpbSIsCiAgImhpbXNlbGYiLAogICJoaXMiLAogICJob3ciLAogICJpIiwKICAiaWYiLAogICJpbiIsCiAgImludG8iLAogICJpcyIsCiAgIml0IiwKICAibGlrZSIsCiAgIm1ha2UiLAogICJtYW55IiwKICAibWUiLAogICJtaWdodCIsCiAgIm1vcmUiLAogICJtb3N0IiwKICAibXVjaCIsCiAgIm11c3QiLAogICJteSIsCiAgIm5ldmVyIiwKICAibm93IiwKICAib2YiLAogICJvbiIsCiAgIm9ubHkiLAogICJvciIsCiAgIm90aGVyIiwKICAib3VyIiwKICAib3V0IiwKICAib3ZlciIsCiAgInNhaWQiLAogICJzYW1lIiwKICAic2VlIiwKICAic2hvdWxkIiwKICAic2luY2UiLAogICJzb21lIiwKICAic3RpbGwiLAogICJzdWNoIiwKICAidGFrZSIsCiAgInRoYW4iLAogICJ0aGF0IiwKICAidGhlIiwKICAidGhlaXIiLAogICJ0aGVtIiwKICAidGhlbiIsCiAgInRoZXJlIiwKICAidGhlc2UiLAogICJ0aGV5IiwKICAidGhpcyIsCiAgInRob3NlIiwKICAidGhyb3VnaCIsCiAgInRvIiwKICAidG9vIiwKICAidW5kZXIiLAogICJ1cCIsCiAgInZlcnkiLAogICJ3YXMiLAogICJ3YXkiLAogICJ3ZSIsCiAgIndlbGwiLAogICJ3ZXJlIiwKICAid2hhdCIsCiAgIndoZXJlIiwKICAid2hpY2giLAogICJ3aGlsZSIsCiAgIndobyIsCiAgIndpdGgiLAogICJ3b3VsZCIsCiAgInlvdSIsCiAgInlvdXIiCl0pOwpmdW5jdGlvbiB0b2tlbml6ZSh0ZXh0MikgewogIGlmICh0eXBlb2YgdGV4dDIgIT09ICJzdHJpbmciKSB7CiAgICByZXR1cm4gW107CiAgfQogIGNvbnN0IHdvcmRzID0gdGV4dDIudG9Mb3dlckNhc2UoKS5zcGxpdCgvXFcrLykuZmlsdGVyKCh3b3JkKSA9PiB3b3JkLmxlbmd0aCA+IDApOwogIHJldHVybiB3b3Jkcy5maWx0ZXIoKHdvcmQpID0+ICFTVE9QV09SRFMuaGFzKHdvcmQpKTsKfQpjbGFzcyBUZXh0SW5kZXggewogIGNvbnN0cnVjdG9yKG9wdGlvbnMgPSB7fSkgewogICAgY29uc3QgewogICAgICBvcmRlciA9IDE2LAogICAgICB0cmVlcwogICAgfSA9IG9wdGlvbnM7CiAgICB0aGlzLm9yZGVyID0gb3JkZXI7CiAgICB0aGlzLmluZGV4ID0gdHJlZXM/LmluZGV4IHx8IG51bGw7CiAgICB0aGlzLmRvY3VtZW50VGVybXMgPSB0cmVlcz8uZG9jdW1lbnRUZXJtcyB8fCBudWxsOwogICAgdGhpcy5kb2N1bWVudExlbmd0aHMgPSB0cmVlcz8uZG9jdW1lbnRMZW5ndGhzIHx8IG51bGw7CiAgICB0aGlzLmlzT3BlbiA9IGZhbHNlOwogIH0KICBhc3luYyBvcGVuKCkgewogICAgaWYgKHRoaXMuaXNPcGVuKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVGV4dEluZGV4IGlzIGFscmVhZHkgb3BlbiIpOwogICAgfQogICAgaWYgKCF0aGlzLmluZGV4IHx8ICF0aGlzLmRvY3VtZW50VGVybXMgfHwgIXRoaXMuZG9jdW1lbnRMZW5ndGhzKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVHJlZXMgbXVzdCBiZSBpbml0aWFsaXplZCBiZWZvcmUgb3BlbmluZyIpOwogICAgfQogICAgYXdhaXQgUHJvbWlzZS5hbGwoWwogICAgICB0aGlzLmluZGV4Lm9wZW4oKSwKICAgICAgdGhpcy5kb2N1bWVudFRlcm1zLm9wZW4oKSwKICAgICAgdGhpcy5kb2N1bWVudExlbmd0aHMub3BlbigpCiAgICBdKTsKICAgIHRoaXMuaXNPcGVuID0gdHJ1ZTsKICB9CiAgYXN5bmMgY2xvc2UoKSB7CiAgICBpZiAoIXRoaXMuaXNPcGVuKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGF3YWl0IFByb21pc2UuYWxsKFsKICAgICAgdGhpcy5pbmRleC5jbG9zZSgpLAogICAgICB0aGlzLmRvY3VtZW50VGVybXMuY2xvc2UoKSwKICAgICAgdGhpcy5kb2N1bWVudExlbmd0aHMuY2xvc2UoKQogICAgXSk7CiAgICB0aGlzLmlzT3BlbiA9IGZhbHNlOwogIH0KICBfZW5zdXJlT3BlbigpIHsKICAgIGlmICghdGhpcy5pc09wZW4pIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJUZXh0SW5kZXggaXMgbm90IG9wZW4iKTsKICAgIH0KICB9CiAgLyoqCiAgICogQWRkIHRlcm1zIGZyb20gdGV4dCB0byB0aGUgaW5kZXggZm9yIGEgZ2l2ZW4gZG9jdW1lbnQgSUQKICAgKiBAcGFyYW0ge3N0cmluZ30gZG9jSWQgLSBUaGUgZG9jdW1lbnQgaWRlbnRpZmllcgogICAqIEBwYXJhbSB7c3RyaW5nfSB0ZXh0IC0gVGhlIHRleHQgY29udGVudCB0byBpbmRleAogICAqLwogIGFzeW5jIGFkZChkb2NJZCwgdGV4dDIpIHsKICAgIHRoaXMuX2Vuc3VyZU9wZW4oKTsKICAgIGlmICghZG9jSWQpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJEb2N1bWVudCBJRCBpcyByZXF1aXJlZCIpOwogICAgfQogICAgY29uc3Qgd29yZHMgPSB0b2tlbml6ZSh0ZXh0Mik7CiAgICBjb25zdCB0ZXJtRnJlcXVlbmN5ID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIHdvcmRzLmZvckVhY2goKHdvcmQpID0+IHsKICAgICAgY29uc3Qgc3RlbSA9IHN0ZW1tZXIod29yZCk7CiAgICAgIHRlcm1GcmVxdWVuY3kuc2V0KHN0ZW0sICh0ZXJtRnJlcXVlbmN5LmdldChzdGVtKSB8fCAwKSArIDEpOwogICAgfSk7CiAgICBmb3IgKGNvbnN0IFtzdGVtLCBmcmVxdWVuY3ldIG9mIHRlcm1GcmVxdWVuY3kuZW50cmllcygpKSB7CiAgICAgIGNvbnN0IHBvc3RpbmdzID0gYXdhaXQgdGhpcy5pbmRleC5zZWFyY2goc3RlbSkgfHwge307CiAgICAgIHBvc3RpbmdzW2RvY0lkXSA9IGZyZXF1ZW5jeTsKICAgICAgYXdhaXQgdGhpcy5pbmRleC5hZGQoc3RlbSwgcG9zdGluZ3MpOwogICAgfQogICAgY29uc3QgZXhpc3RpbmdUZXJtcyA9IGF3YWl0IHRoaXMuZG9jdW1lbnRUZXJtcy5zZWFyY2goZG9jSWQpIHx8IHt9OwogICAgY29uc3QgbWVyZ2VkVGVybXMgPSB7IC4uLmV4aXN0aW5nVGVybXMgfTsKICAgIHRlcm1GcmVxdWVuY3kuZm9yRWFjaCgoZnJlcXVlbmN5LCBzdGVtKSA9PiB7CiAgICAgIG1lcmdlZFRlcm1zW3N0ZW1dID0gZnJlcXVlbmN5OwogICAgfSk7CiAgICBjb25zdCBkb2NMZW5ndGggPSBPYmplY3QudmFsdWVzKG1lcmdlZFRlcm1zKS5yZWR1Y2UoKHN1bSwgY291bnQpID0+IHN1bSArIGNvdW50LCAwKTsKICAgIGF3YWl0IHRoaXMuZG9jdW1lbnRUZXJtcy5hZGQoZG9jSWQsIG1lcmdlZFRlcm1zKTsKICAgIGF3YWl0IHRoaXMuZG9jdW1lbnRMZW5ndGhzLmFkZChkb2NJZCwgZG9jTGVuZ3RoKTsKICB9CiAgLyoqCiAgICogUmVtb3ZlIGFsbCBpbmRleGVkIHRlcm1zIGZvciBhIGdpdmVuIGRvY3VtZW50IElECiAgICogQHBhcmFtIHtzdHJpbmd9IGRvY0lkIC0gVGhlIGRvY3VtZW50IGlkZW50aWZpZXIgdG8gcmVtb3ZlCiAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgZG9jdW1lbnQgd2FzIGZvdW5kIGFuZCByZW1vdmVkLCBmYWxzZSBvdGhlcndpc2UKICAgKi8KICBhc3luYyByZW1vdmUoZG9jSWQpIHsKICAgIHRoaXMuX2Vuc3VyZU9wZW4oKTsKICAgIGNvbnN0IHRlcm1zID0gYXdhaXQgdGhpcy5kb2N1bWVudFRlcm1zLnNlYXJjaChkb2NJZCk7CiAgICBpZiAoIXRlcm1zKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGZvciAoY29uc3QgW3Rlcm1dIG9mIE9iamVjdC5lbnRyaWVzKHRlcm1zKSkgewogICAgICBjb25zdCBwb3N0aW5ncyA9IGF3YWl0IHRoaXMuaW5kZXguc2VhcmNoKHRlcm0pIHx8IHt9OwogICAgICBkZWxldGUgcG9zdGluZ3NbZG9jSWRdOwogICAgICBpZiAoT2JqZWN0LmtleXMocG9zdGluZ3MpLmxlbmd0aCA9PT0gMCkgewogICAgICAgIGF3YWl0IHRoaXMuaW5kZXguZGVsZXRlKHRlcm0pOwogICAgICB9IGVsc2UgewogICAgICAgIGF3YWl0IHRoaXMuaW5kZXguYWRkKHRlcm0sIHBvc3RpbmdzKTsKICAgICAgfQogICAgfQogICAgYXdhaXQgdGhpcy5kb2N1bWVudFRlcm1zLmRlbGV0ZShkb2NJZCk7CiAgICBhd2FpdCB0aGlzLmRvY3VtZW50TGVuZ3Rocy5kZWxldGUoZG9jSWQpOwogICAgcmV0dXJuIHRydWU7CiAgfQogIC8qKgogICAqIFF1ZXJ5IHRoZSBpbmRleCBmb3IgZG9jdW1lbnRzIGNvbnRhaW5pbmcgdGhlIGdpdmVuIHRlcm1zIHdpdGggcmVsZXZhbmNlIHNjb3JpbmcKICAgKiBAcGFyYW0ge3N0cmluZ30gcXVlcnlUZXh0IC0gVGhlIHNlYXJjaCBxdWVyeSB0ZXh0CiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgLSBRdWVyeSBvcHRpb25zCiAgICogQHBhcmFtIHtib29sZWFufSBvcHRpb25zLnNjb3JlZCAtIElmIHRydWUsIHJldHVybiBzY29yZWQgcmVzdWx0czsgaWYgZmFsc2UsIHJldHVybiBqdXN0IElEcyAoZGVmYXVsdDogdHJ1ZSkKICAgKiBAcGFyYW0ge2Jvb2xlYW59IG9wdGlvbnMucmVxdWlyZUFsbCAtIElmIHRydWUsIHJlcXVpcmUgQUxMIHRlcm1zOyBpZiBmYWxzZSwgcmFuayBieSByZWxldmFuY2UgKGRlZmF1bHQ6IGZhbHNlKQogICAqIEByZXR1cm5zIHtBcnJheX0gQXJyYXkgb2YgZG9jdW1lbnQgSURzIChpZiBzY29yZWQ9ZmFsc2UpIG9yIG9iamVjdHMgd2l0aCB7aWQsIHNjb3JlfSAoaWYgc2NvcmVkPXRydWUpCiAgICovCiAgYXN5bmMgcXVlcnkocXVlcnlUZXh0LCBvcHRpb25zID0geyBzY29yZWQ6IHRydWUsIHJlcXVpcmVBbGw6IGZhbHNlIH0pIHsKICAgIHRoaXMuX2Vuc3VyZU9wZW4oKTsKICAgIGNvbnN0IHdvcmRzID0gdG9rZW5pemUocXVlcnlUZXh0KTsKICAgIGlmICh3b3Jkcy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIFtdOwogICAgfQogICAgY29uc3Qgc3RlbW1lZFRlcm1zID0gd29yZHMubWFwKCh3b3JkKSA9PiBzdGVtbWVyKHdvcmQpKTsKICAgIGNvbnN0IHVuaXF1ZVRlcm1zID0gWy4uLm5ldyBTZXQoc3RlbW1lZFRlcm1zKV07CiAgICBpZiAob3B0aW9ucy5yZXF1aXJlQWxsKSB7CiAgICAgIGNvbnN0IGRvY1NldHMgPSBbXTsKICAgICAgZm9yIChjb25zdCB0ZXJtIG9mIHVuaXF1ZVRlcm1zKSB7CiAgICAgICAgY29uc3QgdGVybURvY3MgPSBhd2FpdCB0aGlzLmluZGV4LnNlYXJjaCh0ZXJtKTsKICAgICAgICBkb2NTZXRzLnB1c2gobmV3IFNldChPYmplY3Qua2V5cyh0ZXJtRG9jcyB8fCB7fSkpKTsKICAgICAgfQogICAgICBpZiAoZG9jU2V0cy5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgICAgY29uc3QgaW50ZXJzZWN0aW9uID0gbmV3IFNldChkb2NTZXRzWzBdKTsKICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBkb2NTZXRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgZm9yIChjb25zdCBkb2NJZCBvZiBbLi4uaW50ZXJzZWN0aW9uXSkgewogICAgICAgICAgaWYgKCFkb2NTZXRzW2ldLmhhcyhkb2NJZCkpIHsKICAgICAgICAgICAgaW50ZXJzZWN0aW9uLmRlbGV0ZShkb2NJZCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBBcnJheS5mcm9tKGludGVyc2VjdGlvbik7CiAgICB9CiAgICBjb25zdCBkb2NMZW5ndGhFbnRyaWVzID0gYXdhaXQgdGhpcy5kb2N1bWVudExlbmd0aHMudG9BcnJheSgpOwogICAgY29uc3QgZG9jTGVuZ3RoTWFwID0gbmV3IE1hcChkb2NMZW5ndGhFbnRyaWVzLm1hcCgoeyBrZXksIHZhbHVlIH0pID0+IFtTdHJpbmcoa2V5KSwgdmFsdWUgfHwgMV0pKTsKICAgIGNvbnN0IHRvdGFsRG9jcyA9IGRvY0xlbmd0aEVudHJpZXMubGVuZ3RoOwogICAgY29uc3QgaWRmID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIGZvciAoY29uc3QgdGVybSBvZiB1bmlxdWVUZXJtcykgewogICAgICBjb25zdCB0ZXJtRG9jcyA9IGF3YWl0IHRoaXMuaW5kZXguc2VhcmNoKHRlcm0pOwogICAgICBjb25zdCBkb2NzV2l0aFRlcm0gPSB0ZXJtRG9jcyA/IE9iamVjdC5rZXlzKHRlcm1Eb2NzKS5sZW5ndGggOiAwOwogICAgICBpZiAoZG9jc1dpdGhUZXJtID4gMCkgewogICAgICAgIGlkZi5zZXQodGVybSwgTWF0aC5sb2codG90YWxEb2NzIC8gZG9jc1dpdGhUZXJtKSk7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IGRvY1Njb3JlcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICBmb3IgKGNvbnN0IHRlcm0gb2YgdW5pcXVlVGVybXMpIHsKICAgICAgY29uc3QgdGVybURvY3MgPSBhd2FpdCB0aGlzLmluZGV4LnNlYXJjaCh0ZXJtKTsKICAgICAgaWYgKCF0ZXJtRG9jcykgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGZvciAoY29uc3QgW2RvY0lkLCB0ZXJtRnJlcV0gb2YgT2JqZWN0LmVudHJpZXModGVybURvY3MpKSB7CiAgICAgICAgY29uc3QgZG9jTGVuZ3RoID0gZG9jTGVuZ3RoTWFwLmdldChkb2NJZCkgfHwgMTsKICAgICAgICBjb25zdCB0ZiA9IHRlcm1GcmVxIC8gZG9jTGVuZ3RoOwogICAgICAgIGNvbnN0IHRlcm1JZGYgPSBpZGYuZ2V0KHRlcm0pIHx8IDA7CiAgICAgICAgY29uc3QgcHJldiA9IGRvY1Njb3Jlcy5nZXQoZG9jSWQpIHx8IDA7CiAgICAgICAgZG9jU2NvcmVzLnNldChkb2NJZCwgcHJldiArIHRmICogdGVybUlkZik7CiAgICAgIH0KICAgIH0KICAgIGZvciAoY29uc3QgW2RvY0lkLCBzY29yZV0gb2YgZG9jU2NvcmVzLmVudHJpZXMoKSkgewogICAgICBjb25zdCBkb2NUZXJtcyA9IGF3YWl0IHRoaXMuZG9jdW1lbnRUZXJtcy5zZWFyY2goZG9jSWQpIHx8IHt9OwogICAgICBjb25zdCBtYXRjaGluZ1Rlcm1zID0gdW5pcXVlVGVybXMuZmlsdGVyKCh0ZXJtKSA9PiAhIWRvY1Rlcm1zW3Rlcm1dKS5sZW5ndGg7CiAgICAgIGNvbnN0IGNvdmVyYWdlID0gbWF0Y2hpbmdUZXJtcyAvIHVuaXF1ZVRlcm1zLmxlbmd0aDsKICAgICAgZG9jU2NvcmVzLnNldChkb2NJZCwgc2NvcmUgKiAoMSArIGNvdmVyYWdlKSk7CiAgICB9CiAgICBjb25zdCByZXN1bHRzID0gQXJyYXkuZnJvbShkb2NTY29yZXMuZW50cmllcygpKS5tYXAoKFtpZCwgc2NvcmVdKSA9PiAoeyBpZCwgc2NvcmUgfSkpLnNvcnQoKGEsIGIpID0+IGIuc2NvcmUgLSBhLnNjb3JlKTsKICAgIGlmIChvcHRpb25zLnNjb3JlZCA9PT0gZmFsc2UpIHsKICAgICAgcmV0dXJuIHJlc3VsdHMubWFwKChyKSA9PiByLmlkKTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH0KICAvKioKICAgKiBHZXQgdGhlIG51bWJlciBvZiB1bmlxdWUgdGVybXMgaW4gdGhlIGluZGV4CiAgICogQHJldHVybnMge251bWJlcn0gTnVtYmVyIG9mIHVuaXF1ZSB0ZXJtcwogICAqLwogIGFzeW5jIGdldFRlcm1Db3VudCgpIHsKICAgIHRoaXMuX2Vuc3VyZU9wZW4oKTsKICAgIGNvbnN0IHRlcm1zID0gYXdhaXQgdGhpcy5pbmRleC50b0FycmF5KCk7CiAgICByZXR1cm4gdGVybXMubGVuZ3RoOwogIH0KICAvKioKICAgKiBHZXQgdGhlIG51bWJlciBvZiBkb2N1bWVudHMgaW4gdGhlIGluZGV4CiAgICogQHJldHVybnMge251bWJlcn0gTnVtYmVyIG9mIGluZGV4ZWQgZG9jdW1lbnRzCiAgICovCiAgYXN5bmMgZ2V0RG9jdW1lbnRDb3VudCgpIHsKICAgIHRoaXMuX2Vuc3VyZU9wZW4oKTsKICAgIGNvbnN0IGRvY3MgPSBhd2FpdCB0aGlzLmRvY3VtZW50VGVybXMudG9BcnJheSgpOwogICAgcmV0dXJuIGRvY3MubGVuZ3RoOwogIH0KICAvKioKICAgKiBDbGVhciBhbGwgZGF0YSBmcm9tIHRoZSBpbmRleAogICAqLwogIGFzeW5jIGNsZWFyKCkgewogICAgdGhpcy5fZW5zdXJlT3BlbigpOwogICAgY29uc3QgW3Rlcm1zLCBkb2NzLCBsZW5ndGhzXSA9IGF3YWl0IFByb21pc2UuYWxsKFsKICAgICAgdGhpcy5pbmRleC50b0FycmF5KCksCiAgICAgIHRoaXMuZG9jdW1lbnRUZXJtcy50b0FycmF5KCksCiAgICAgIHRoaXMuZG9jdW1lbnRMZW5ndGhzLnRvQXJyYXkoKQogICAgXSk7CiAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIHRlcm1zKSB7CiAgICAgIGF3YWl0IHRoaXMuaW5kZXguZGVsZXRlKGVudHJ5LmtleSk7CiAgICB9CiAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIGRvY3MpIHsKICAgICAgYXdhaXQgdGhpcy5kb2N1bWVudFRlcm1zLmRlbGV0ZShlbnRyeS5rZXkpOwogICAgfQogICAgZm9yIChjb25zdCBlbnRyeSBvZiBsZW5ndGhzKSB7CiAgICAgIGF3YWl0IHRoaXMuZG9jdW1lbnRMZW5ndGhzLmRlbGV0ZShlbnRyeS5rZXkpOwogICAgfQogIH0KICAvKioKICAgKiBDb21wYWN0IGFsbCBpbnRlcm5hbCBCKyB0cmVlcyB1c2luZyBwcm92aWRlZCBkZXN0aW5hdGlvbiB0cmVlIGluc3RhbmNlcy4KICAgKiBUaGUgZGVzdGluYXRpb24gdHJlZXMgc2hvdWxkIGJlIGZyZXNobHkgY3JlYXRlZCAodW5vcGVuZWQpIHdpdGggbmV3IHN5bmMgaGFuZGxlcy4KICAgKiBBZnRlciBjb21wYWN0aW9uIGNvbXBsZXRlcywgdGhlIGRlc3RpbmF0aW9uIHN5bmMgaGFuZGxlcyB3aWxsIGJlIGNsb3NlZC4KICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAtIENvbXBhY3Rpb24gb3B0aW9ucyAgCiAgICogQHBhcmFtIHtCUGx1c1RyZWV9IG9wdGlvbnMuaW5kZXggLSBGcmVzaCBkZXN0aW5hdGlvbiB0cmVlIGZvciBpbmRleCBkYXRhCiAgICogQHBhcmFtIHtCUGx1c1RyZWV9IG9wdGlvbnMuZG9jdW1lbnRUZXJtcyAtIEZyZXNoIGRlc3RpbmF0aW9uIHRyZWUgZm9yIGRvY3VtZW50IHRlcm1zCiAgICogQHBhcmFtIHtCUGx1c1RyZWV9IG9wdGlvbnMuZG9jdW1lbnRMZW5ndGhzIC0gRnJlc2ggZGVzdGluYXRpb24gdHJlZSBmb3IgZG9jdW1lbnQgbGVuZ3RocwogICAqIEByZXR1cm5zIHtQcm9taXNlPHt0ZXJtczogb2JqZWN0LCBkb2N1bWVudHM6IG9iamVjdCwgbGVuZ3Roczogb2JqZWN0fT59CiAgICovCiAgYXN5bmMgY29tcGFjdCh7IGluZGV4OiBkZXN0SW5kZXgsIGRvY3VtZW50VGVybXM6IGRlc3REb2NUZXJtcywgZG9jdW1lbnRMZW5ndGhzOiBkZXN0RG9jTGVuZ3RocyB9KSB7CiAgICB0aGlzLl9lbnN1cmVPcGVuKCk7CiAgICBpZiAoIWRlc3RJbmRleCB8fCAhZGVzdERvY1Rlcm1zIHx8ICFkZXN0RG9jTGVuZ3RocykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIkRlc3RpbmF0aW9uIHRyZWVzIG11c3QgYmUgcHJvdmlkZWQgZm9yIGNvbXBhY3Rpb24iKTsKICAgIH0KICAgIGNvbnN0IHRlcm1zUmVzdWx0ID0gYXdhaXQgdGhpcy5pbmRleC5jb21wYWN0KGRlc3RJbmRleC5maWxlLnN5bmNBY2Nlc3NIYW5kbGUpOwogICAgY29uc3QgZG9jdW1lbnRzUmVzdWx0ID0gYXdhaXQgdGhpcy5kb2N1bWVudFRlcm1zLmNvbXBhY3QoZGVzdERvY1Rlcm1zLmZpbGUuc3luY0FjY2Vzc0hhbmRsZSk7CiAgICBjb25zdCBsZW5ndGhzUmVzdWx0ID0gYXdhaXQgdGhpcy5kb2N1bWVudExlbmd0aHMuY29tcGFjdChkZXN0RG9jTGVuZ3Rocy5maWxlLnN5bmNBY2Nlc3NIYW5kbGUpOwogICAgYXdhaXQgdGhpcy5jbG9zZSgpOwogICAgdGhpcy5pc09wZW4gPSBmYWxzZTsKICAgIHJldHVybiB7CiAgICAgIHRlcm1zOiB0ZXJtc1Jlc3VsdCwKICAgICAgZG9jdW1lbnRzOiBkb2N1bWVudHNSZXN1bHQsCiAgICAgIGxlbmd0aHM6IGxlbmd0aHNSZXN1bHQKICAgIH07CiAgfQp9CmZ1bmN0aW9uIGV2YWx1YXRlRXhwcmVzc2lvbihleHByLCBkb2MpIHsKICBpZiAoZXhwciA9PT0gbnVsbCB8fCBleHByID09PSB2b2lkIDApIHsKICAgIHJldHVybiBleHByOwogIH0KICBpZiAodHlwZW9mIGV4cHIgPT09ICJib29sZWFuIiB8fCB0eXBlb2YgZXhwciA9PT0gIm51bWJlciIpIHsKICAgIHJldHVybiBleHByOwogIH0KICBpZiAodHlwZW9mIGV4cHIgPT09ICJzdHJpbmciKSB7CiAgICBpZiAoZXhwci5zdGFydHNXaXRoKCIkJCIpKSB7CiAgICAgIGlmIChleHByID09PSAiJCRLRUVQIiB8fCBleHByID09PSAiJCRQUlVORSIgfHwgZXhwciA9PT0gIiQkREVTQ0VORCIpIHsKICAgICAgICByZXR1cm4gZXhwcjsKICAgICAgfQogICAgICByZXR1cm4gZ2V0UHJvcChkb2MsIGV4cHIuc3Vic3RyaW5nKDIpKTsKICAgIH0gZWxzZSBpZiAoZXhwci5jaGFyQXQoMCkgPT09ICIkIikgewogICAgICByZXR1cm4gZ2V0UHJvcChkb2MsIGV4cHIuc3Vic3RyaW5nKDEpKTsKICAgIH0KICAgIHJldHVybiBleHByOwogIH0KICBpZiAodHlwZW9mIGV4cHIgPT09ICJvYmplY3QiKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheShleHByKSkgewogICAgICByZXR1cm4gZXhwci5tYXAoKGl0ZW0pID0+IGV2YWx1YXRlRXhwcmVzc2lvbihpdGVtLCBkb2MpKTsKICAgIH0KICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhleHByKTsKICAgIGlmIChrZXlzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gZXhwcjsKICAgIH0KICAgIGNvbnN0IG9wZXJhdG9yID0ga2V5c1swXTsKICAgIGlmIChvcGVyYXRvci5jaGFyQXQoMCkgPT09ICIkIikgewogICAgICBjb25zdCBvcGVyYW5kID0gZXhwcltvcGVyYXRvcl07CiAgICAgIHJldHVybiBldmFsdWF0ZU9wZXJhdG9yKG9wZXJhdG9yLCBvcGVyYW5kLCBkb2MpOwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgcmVzdWx0ID0ge307CiAgICAgIGZvciAoY29uc3Qga2V5IG9mIGtleXMpIHsKICAgICAgICByZXN1bHRba2V5XSA9IGV2YWx1YXRlRXhwcmVzc2lvbihleHByW2tleV0sIGRvYyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICB9CiAgcmV0dXJuIGV4cHI7Cn0KZnVuY3Rpb24gZXZhbHVhdGVPcGVyYXRvcihvcGVyYXRvciwgb3BlcmFuZCwgZG9jKSB7CiAgc3dpdGNoIChvcGVyYXRvcikgewogICAgLy8gQXJpdGhtZXRpYyBvcGVyYXRvcnMKICAgIGNhc2UgIiRhZGQiOgogICAgICByZXR1cm4gZXZhbEFkZChvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJHN1YnRyYWN0IjoKICAgICAgcmV0dXJuIGV2YWxTdWJ0cmFjdChvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJG11bHRpcGx5IjoKICAgICAgcmV0dXJuIGV2YWxNdWx0aXBseShvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJGRpdmlkZSI6CiAgICAgIHJldHVybiBldmFsRGl2aWRlKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkbW9kIjoKICAgICAgcmV0dXJuIGV2YWxNb2Qob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRwb3ciOgogICAgICByZXR1cm4gZXZhbFBvdyhvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJHNxcnQiOgogICAgICByZXR1cm4gZXZhbFNxcnQob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRhYnMiOgogICAgICByZXR1cm4gZXZhbEFicyhvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJGNlaWwiOgogICAgICByZXR1cm4gZXZhbENlaWwob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRmbG9vciI6CiAgICAgIHJldHVybiBldmFsRmxvb3Iob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiR0cnVuYyI6CiAgICAgIHJldHVybiBldmFsVHJ1bmMob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRyb3VuZCI6CiAgICAgIHJldHVybiBldmFsUm91bmQob3BlcmFuZCwgZG9jKTsKICAgIC8vIFN0cmluZyBvcGVyYXRvcnMKICAgIGNhc2UgIiRjb25jYXQiOgogICAgICByZXR1cm4gZXZhbENvbmNhdChvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJHN1YnN0ciI6CiAgICAgIHJldHVybiBldmFsU3Vic3RyKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkdG9Mb3dlciI6CiAgICAgIHJldHVybiBldmFsVG9Mb3dlcihvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJHRvVXBwZXIiOgogICAgICByZXR1cm4gZXZhbFRvVXBwZXIob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiR0cmltIjoKICAgICAgcmV0dXJuIGV2YWxUcmltKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkbHRyaW0iOgogICAgICByZXR1cm4gZXZhbEx0cmltKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkcnRyaW0iOgogICAgICByZXR1cm4gZXZhbFJ0cmltKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkc3BsaXQiOgogICAgICByZXR1cm4gZXZhbFNwbGl0KG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkc3RyTGVuQ1AiOgogICAgICByZXR1cm4gZXZhbFN0ckxlbkNQKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkc3RyY2FzZWNtcCI6CiAgICAgIHJldHVybiBldmFsU3RyY2FzZWNtcChvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJGluZGV4T2ZDUCI6CiAgICAgIHJldHVybiBldmFsSW5kZXhPZkNQKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkcmVwbGFjZU9uZSI6CiAgICAgIHJldHVybiBldmFsUmVwbGFjZU9uZShvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJHJlcGxhY2VBbGwiOgogICAgICByZXR1cm4gZXZhbFJlcGxhY2VBbGwob3BlcmFuZCwgZG9jKTsKICAgIC8vIENvbXBhcmlzb24gb3BlcmF0b3JzCiAgICBjYXNlICIkY21wIjoKICAgICAgcmV0dXJuIGV2YWxDbXAob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRlcSI6CiAgICAgIHJldHVybiBldmFsRXEob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRuZSI6CiAgICAgIHJldHVybiBldmFsTmUob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRndCI6CiAgICAgIHJldHVybiBldmFsR3Qob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRndGUiOgogICAgICByZXR1cm4gZXZhbEd0ZShvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJGx0IjoKICAgICAgcmV0dXJuIGV2YWxMdChvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJGx0ZSI6CiAgICAgIHJldHVybiBldmFsTHRlKG9wZXJhbmQsIGRvYyk7CiAgICAvLyBMb2dpY2FsIG9wZXJhdG9ycwogICAgY2FzZSAiJGFuZCI6CiAgICAgIHJldHVybiBldmFsQW5kKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkb3IiOgogICAgICByZXR1cm4gZXZhbE9yKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkbm90IjoKICAgICAgcmV0dXJuIGV2YWxOb3Qob3BlcmFuZCwgZG9jKTsKICAgIC8vIENvbmRpdGlvbmFsIG9wZXJhdG9ycwogICAgY2FzZSAiJGNvbmQiOgogICAgICByZXR1cm4gZXZhbENvbmQob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRpZk51bGwiOgogICAgICByZXR1cm4gZXZhbElmTnVsbChvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJHN3aXRjaCI6CiAgICAgIHJldHVybiBldmFsU3dpdGNoKG9wZXJhbmQsIGRvYyk7CiAgICAvLyBEYXRlIG9wZXJhdG9ycwogICAgY2FzZSAiJHllYXIiOgogICAgICByZXR1cm4gZXZhbFllYXIob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRtb250aCI6CiAgICAgIHJldHVybiBldmFsTW9udGgob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRkYXlPZk1vbnRoIjoKICAgICAgcmV0dXJuIGV2YWxEYXlPZk1vbnRoKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkZGF5T2ZXZWVrIjoKICAgICAgcmV0dXJuIGV2YWxEYXlPZldlZWsob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRkYXlPZlllYXIiOgogICAgICByZXR1cm4gZXZhbERheU9mWWVhcihvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJGhvdXIiOgogICAgICByZXR1cm4gZXZhbEhvdXIob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRtaW51dGUiOgogICAgICByZXR1cm4gZXZhbE1pbnV0ZShvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJHNlY29uZCI6CiAgICAgIHJldHVybiBldmFsU2Vjb25kKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkbWlsbGlzZWNvbmQiOgogICAgICByZXR1cm4gZXZhbE1pbGxpc2Vjb25kKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkd2VlayI6CiAgICAgIHJldHVybiBldmFsV2VlayhvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJGlzb1dlZWsiOgogICAgICByZXR1cm4gZXZhbElzb1dlZWsob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRpc29XZWVrWWVhciI6CiAgICAgIHJldHVybiBldmFsSXNvV2Vla1llYXIob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRkYXRlVG9TdHJpbmciOgogICAgICByZXR1cm4gZXZhbERhdGVUb1N0cmluZyhvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJHRvRGF0ZSI6CiAgICAgIHJldHVybiBldmFsVG9EYXRlKG9wZXJhbmQsIGRvYyk7CiAgICAvLyBBcnJheSBvcGVyYXRvcnMKICAgIGNhc2UgIiRhcnJheUVsZW1BdCI6CiAgICAgIHJldHVybiBldmFsQXJyYXlFbGVtQXQob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRjb25jYXRBcnJheXMiOgogICAgICByZXR1cm4gZXZhbENvbmNhdEFycmF5cyhvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJGZpbHRlciI6CiAgICAgIHJldHVybiBldmFsRmlsdGVyKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkaW4iOgogICAgICByZXR1cm4gZXZhbEluKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkaW5kZXhPZkFycmF5IjoKICAgICAgcmV0dXJuIGV2YWxJbmRleE9mQXJyYXkob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRpc0FycmF5IjoKICAgICAgcmV0dXJuIGV2YWxJc0FycmF5KG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkbWFwIjoKICAgICAgcmV0dXJuIGV2YWxNYXAob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRyZWR1Y2UiOgogICAgICByZXR1cm4gZXZhbFJlZHVjZShvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJHNpemUiOgogICAgICByZXR1cm4gZXZhbFNpemUob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRzbGljZSI6CiAgICAgIHJldHVybiBldmFsU2xpY2Uob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRyZXZlcnNlQXJyYXkiOgogICAgICByZXR1cm4gZXZhbFJldmVyc2VBcnJheShvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJHppcCI6CiAgICAgIHJldHVybiBldmFsWmlwKG9wZXJhbmQsIGRvYyk7CiAgICAvLyBUeXBlIG9wZXJhdG9ycwogICAgY2FzZSAiJHR5cGUiOgogICAgICByZXR1cm4gZXZhbFR5cGUob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRjb252ZXJ0IjoKICAgICAgcmV0dXJuIGV2YWxDb252ZXJ0KG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkdG9Cb29sIjoKICAgICAgcmV0dXJuIGV2YWxUb0Jvb2wob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiR0b0RlY2ltYWwiOgogICAgICByZXR1cm4gZXZhbFRvRGVjaW1hbChvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJHRvRG91YmxlIjoKICAgICAgcmV0dXJuIGV2YWxUb0RvdWJsZShvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJHRvSW50IjoKICAgICAgcmV0dXJuIGV2YWxUb0ludChvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJHRvTG9uZyI6CiAgICAgIHJldHVybiBldmFsVG9Mb25nKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkdG9TdHJpbmciOgogICAgICByZXR1cm4gZXZhbFRvU3RyaW5nKG9wZXJhbmQsIGRvYyk7CiAgICAvLyBPYmplY3Qgb3BlcmF0b3JzCiAgICBjYXNlICIkb2JqZWN0VG9BcnJheSI6CiAgICAgIHJldHVybiBldmFsT2JqZWN0VG9BcnJheShvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJGFycmF5VG9PYmplY3QiOgogICAgICByZXR1cm4gZXZhbEFycmF5VG9PYmplY3Qob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRtZXJnZU9iamVjdHMiOgogICAgICByZXR1cm4gZXZhbE1lcmdlT2JqZWN0cyhvcGVyYW5kLCBkb2MpOwogICAgLy8gTGl0ZXJhbCBvcGVyYXRvcgogICAgY2FzZSAiJGxpdGVyYWwiOgogICAgICByZXR1cm4gb3BlcmFuZDsKICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5zdXBwb3J0ZWQgYWdncmVnYXRpb24gb3BlcmF0b3I6ICR7b3BlcmF0b3J9YCk7CiAgfQp9CmZ1bmN0aW9uIGV2YWxBZGQob3BlcmFuZHMsIGRvYykgewogIGlmICghQXJyYXkuaXNBcnJheShvcGVyYW5kcykpIHJldHVybiBudWxsOwogIGxldCBzdW0gPSAwOwogIGZvciAoY29uc3Qgb3BlcmFuZCBvZiBvcGVyYW5kcykgewogICAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgICBpZiAodmFsIGluc3RhbmNlb2YgRGF0ZSkgewogICAgICBzdW0gKz0gdmFsLmdldFRpbWUoKTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gIm51bWJlciIpIHsKICAgICAgc3VtICs9IHZhbDsKICAgIH0KICB9CiAgcmV0dXJuIHN1bTsKfQpmdW5jdGlvbiBldmFsU3VidHJhY3Qob3BlcmFuZHMsIGRvYykgewogIGlmICghQXJyYXkuaXNBcnJheShvcGVyYW5kcykgfHwgb3BlcmFuZHMubGVuZ3RoICE9PSAyKSByZXR1cm4gbnVsbDsKICBjb25zdCB2YWwxID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmRzWzBdLCBkb2MpOwogIGNvbnN0IHZhbDIgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMV0sIGRvYyk7CiAgaWYgKHZhbDEgaW5zdGFuY2VvZiBEYXRlICYmIHZhbDIgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICByZXR1cm4gdmFsMS5nZXRUaW1lKCkgLSB2YWwyLmdldFRpbWUoKTsKICB9IGVsc2UgaWYgKHZhbDEgaW5zdGFuY2VvZiBEYXRlICYmIHR5cGVvZiB2YWwyID09PSAibnVtYmVyIikgewogICAgcmV0dXJuIG5ldyBEYXRlKHZhbDEuZ2V0VGltZSgpIC0gdmFsMik7CiAgfSBlbHNlIGlmICh0eXBlb2YgdmFsMSA9PT0gIm51bWJlciIgJiYgdHlwZW9mIHZhbDIgPT09ICJudW1iZXIiKSB7CiAgICByZXR1cm4gdmFsMSAtIHZhbDI7CiAgfQogIHJldHVybiBudWxsOwp9CmZ1bmN0aW9uIGV2YWxNdWx0aXBseShvcGVyYW5kcywgZG9jKSB7CiAgaWYgKCFBcnJheS5pc0FycmF5KG9wZXJhbmRzKSkgcmV0dXJuIG51bGw7CiAgbGV0IHByb2R1Y3QgPSAxOwogIGZvciAoY29uc3Qgb3BlcmFuZCBvZiBvcGVyYW5kcykgewogICAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgICBpZiAodHlwZW9mIHZhbCA9PT0gIm51bWJlciIpIHsKICAgICAgcHJvZHVjdCAqPSB2YWw7CiAgICB9CiAgfQogIHJldHVybiBwcm9kdWN0Owp9CmZ1bmN0aW9uIGV2YWxEaXZpZGUob3BlcmFuZHMsIGRvYykgewogIGlmICghQXJyYXkuaXNBcnJheShvcGVyYW5kcykgfHwgb3BlcmFuZHMubGVuZ3RoICE9PSAyKSByZXR1cm4gbnVsbDsKICBjb25zdCB2YWwxID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmRzWzBdLCBkb2MpOwogIGNvbnN0IHZhbDIgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMV0sIGRvYyk7CiAgaWYgKHR5cGVvZiB2YWwxID09PSAibnVtYmVyIiAmJiB0eXBlb2YgdmFsMiA9PT0gIm51bWJlciIgJiYgdmFsMiAhPT0gMCkgewogICAgcmV0dXJuIHZhbDEgLyB2YWwyOwogIH0KICByZXR1cm4gbnVsbDsKfQpmdW5jdGlvbiBldmFsTW9kKG9wZXJhbmRzLCBkb2MpIHsKICBpZiAoIUFycmF5LmlzQXJyYXkob3BlcmFuZHMpIHx8IG9wZXJhbmRzLmxlbmd0aCAhPT0gMikgcmV0dXJuIG51bGw7CiAgY29uc3QgdmFsMSA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1swXSwgZG9jKTsKICBjb25zdCB2YWwyID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmRzWzFdLCBkb2MpOwogIGlmICh0eXBlb2YgdmFsMSA9PT0gIm51bWJlciIgJiYgdHlwZW9mIHZhbDIgPT09ICJudW1iZXIiICYmIHZhbDIgIT09IDApIHsKICAgIHJldHVybiB2YWwxICUgdmFsMjsKICB9CiAgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gZXZhbFBvdyhvcGVyYW5kcywgZG9jKSB7CiAgaWYgKCFBcnJheS5pc0FycmF5KG9wZXJhbmRzKSB8fCBvcGVyYW5kcy5sZW5ndGggIT09IDIpIHJldHVybiBudWxsOwogIGNvbnN0IGJhc2UgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMF0sIGRvYyk7CiAgY29uc3QgZXhwb25lbnQgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMV0sIGRvYyk7CiAgaWYgKHR5cGVvZiBiYXNlID09PSAibnVtYmVyIiAmJiB0eXBlb2YgZXhwb25lbnQgPT09ICJudW1iZXIiKSB7CiAgICByZXR1cm4gTWF0aC5wb3coYmFzZSwgZXhwb25lbnQpOwogIH0KICByZXR1cm4gbnVsbDsKfQpmdW5jdGlvbiBldmFsU3FydChvcGVyYW5kLCBkb2MpIHsKICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZCwgZG9jKTsKICBpZiAodHlwZW9mIHZhbCA9PT0gIm51bWJlciIgJiYgdmFsID49IDApIHsKICAgIHJldHVybiBNYXRoLnNxcnQodmFsKTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gZXZhbEFicyhvcGVyYW5kLCBkb2MpIHsKICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZCwgZG9jKTsKICBpZiAodHlwZW9mIHZhbCA9PT0gIm51bWJlciIpIHsKICAgIHJldHVybiBNYXRoLmFicyh2YWwpOwogIH0KICByZXR1cm4gbnVsbDsKfQpmdW5jdGlvbiBldmFsQ2VpbChvcGVyYW5kLCBkb2MpIHsKICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZCwgZG9jKTsKICBpZiAodHlwZW9mIHZhbCA9PT0gIm51bWJlciIpIHsKICAgIHJldHVybiBNYXRoLmNlaWwodmFsKTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gZXZhbEZsb29yKG9wZXJhbmQsIGRvYykgewogIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLCBkb2MpOwogIGlmICh0eXBlb2YgdmFsID09PSAibnVtYmVyIikgewogICAgcmV0dXJuIE1hdGguZmxvb3IodmFsKTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gZXZhbFRydW5jKG9wZXJhbmQsIGRvYykgewogIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLCBkb2MpOwogIGlmICh0eXBlb2YgdmFsID09PSAibnVtYmVyIikgewogICAgcmV0dXJuIE1hdGgudHJ1bmModmFsKTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gZXZhbFJvdW5kKG9wZXJhbmRzLCBkb2MpIHsKICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24oQXJyYXkuaXNBcnJheShvcGVyYW5kcykgPyBvcGVyYW5kc1swXSA6IG9wZXJhbmRzLCBkb2MpOwogIGNvbnN0IHBsYWNlID0gQXJyYXkuaXNBcnJheShvcGVyYW5kcykgJiYgb3BlcmFuZHNbMV0gIT09IHZvaWQgMCA/IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1sxXSwgZG9jKSA6IDA7CiAgaWYgKHR5cGVvZiB2YWwgPT09ICJudW1iZXIiICYmIHR5cGVvZiBwbGFjZSA9PT0gIm51bWJlciIpIHsKICAgIGNvbnN0IG11bHRpcGxpZXIgPSBNYXRoLnBvdygxMCwgcGxhY2UpOwogICAgcmV0dXJuIE1hdGgucm91bmQodmFsICogbXVsdGlwbGllcikgLyBtdWx0aXBsaWVyOwogIH0KICByZXR1cm4gbnVsbDsKfQpmdW5jdGlvbiBldmFsQ29uY2F0KG9wZXJhbmRzLCBkb2MpIHsKICBpZiAoIUFycmF5LmlzQXJyYXkob3BlcmFuZHMpKSByZXR1cm4gbnVsbDsKICBsZXQgcmVzdWx0ID0gIiI7CiAgZm9yIChjb25zdCBvcGVyYW5kIG9mIG9wZXJhbmRzKSB7CiAgICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZCwgZG9jKTsKICAgIGlmICh2YWwgIT09IG51bGwgJiYgdmFsICE9PSB2b2lkIDApIHsKICAgICAgcmVzdWx0ICs9IFN0cmluZyh2YWwpOwogICAgfQogIH0KICByZXR1cm4gcmVzdWx0Owp9CmZ1bmN0aW9uIGV2YWxTdWJzdHIob3BlcmFuZHMsIGRvYykgewogIGlmICghQXJyYXkuaXNBcnJheShvcGVyYW5kcykgfHwgb3BlcmFuZHMubGVuZ3RoIDwgMykgcmV0dXJuIG51bGw7CiAgY29uc3Qgc3RyID0gU3RyaW5nKGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1swXSwgZG9jKSB8fCAiIik7CiAgY29uc3Qgc3RhcnQgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMV0sIGRvYyk7CiAgY29uc3QgbGVuZ3RoID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmRzWzJdLCBkb2MpOwogIGlmICh0eXBlb2Ygc3RhcnQgPT09ICJudW1iZXIiICYmIHR5cGVvZiBsZW5ndGggPT09ICJudW1iZXIiKSB7CiAgICByZXR1cm4gc3RyLnN1YnN0cihzdGFydCwgbGVuZ3RoKTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gZXZhbFRvTG93ZXIob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgcmV0dXJuIHZhbCAhPT0gbnVsbCAmJiB2YWwgIT09IHZvaWQgMCA/IFN0cmluZyh2YWwpLnRvTG93ZXJDYXNlKCkgOiAiIjsKfQpmdW5jdGlvbiBldmFsVG9VcHBlcihvcGVyYW5kLCBkb2MpIHsKICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZCwgZG9jKTsKICByZXR1cm4gdmFsICE9PSBudWxsICYmIHZhbCAhPT0gdm9pZCAwID8gU3RyaW5nKHZhbCkudG9VcHBlckNhc2UoKSA6ICIiOwp9CmZ1bmN0aW9uIGV2YWxUcmltKG9wZXJhbmQsIGRvYykgewogIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbih0eXBlb2Ygb3BlcmFuZCA9PT0gIm9iamVjdCIgJiYgb3BlcmFuZC5pbnB1dCA/IG9wZXJhbmQuaW5wdXQgOiBvcGVyYW5kLCBkb2MpOwogIGNvbnN0IGNoYXJzID0gb3BlcmFuZC5jaGFycyA/IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLmNoYXJzLCBkb2MpIDogbnVsbDsKICBsZXQgc3RyID0gdmFsICE9PSBudWxsICYmIHZhbCAhPT0gdm9pZCAwID8gU3RyaW5nKHZhbCkgOiAiIjsKICBpZiAoY2hhcnMpIHsKICAgIGNvbnN0IGNoYXJzUmVnZXggPSBuZXcgUmVnRXhwKGBeWyR7ZXNjYXBlUmVnZXgoY2hhcnMpfV0rfFske2VzY2FwZVJlZ2V4KGNoYXJzKX1dKyRgLCAiZyIpOwogICAgcmV0dXJuIHN0ci5yZXBsYWNlKGNoYXJzUmVnZXgsICIiKTsKICB9CiAgcmV0dXJuIHN0ci50cmltKCk7Cn0KZnVuY3Rpb24gZXZhbEx0cmltKG9wZXJhbmQsIGRvYykgewogIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbih0eXBlb2Ygb3BlcmFuZCA9PT0gIm9iamVjdCIgJiYgb3BlcmFuZC5pbnB1dCA/IG9wZXJhbmQuaW5wdXQgOiBvcGVyYW5kLCBkb2MpOwogIGNvbnN0IGNoYXJzID0gb3BlcmFuZC5jaGFycyA/IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLmNoYXJzLCBkb2MpIDogbnVsbDsKICBsZXQgc3RyID0gdmFsICE9PSBudWxsICYmIHZhbCAhPT0gdm9pZCAwID8gU3RyaW5nKHZhbCkgOiAiIjsKICBpZiAoY2hhcnMpIHsKICAgIGNvbnN0IGNoYXJzUmVnZXggPSBuZXcgUmVnRXhwKGBeWyR7ZXNjYXBlUmVnZXgoY2hhcnMpfV0rYCwgImciKTsKICAgIHJldHVybiBzdHIucmVwbGFjZShjaGFyc1JlZ2V4LCAiIik7CiAgfQogIHJldHVybiBzdHIucmVwbGFjZSgvXlxzKy8sICIiKTsKfQpmdW5jdGlvbiBldmFsUnRyaW0ob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKHR5cGVvZiBvcGVyYW5kID09PSAib2JqZWN0IiAmJiBvcGVyYW5kLmlucHV0ID8gb3BlcmFuZC5pbnB1dCA6IG9wZXJhbmQsIGRvYyk7CiAgY29uc3QgY2hhcnMgPSBvcGVyYW5kLmNoYXJzID8gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQuY2hhcnMsIGRvYykgOiBudWxsOwogIGxldCBzdHIgPSB2YWwgIT09IG51bGwgJiYgdmFsICE9PSB2b2lkIDAgPyBTdHJpbmcodmFsKSA6ICIiOwogIGlmIChjaGFycykgewogICAgY29uc3QgY2hhcnNSZWdleCA9IG5ldyBSZWdFeHAoYFske2VzY2FwZVJlZ2V4KGNoYXJzKX1dKyRgLCAiZyIpOwogICAgcmV0dXJuIHN0ci5yZXBsYWNlKGNoYXJzUmVnZXgsICIiKTsKICB9CiAgcmV0dXJuIHN0ci5yZXBsYWNlKC9ccyskLywgIiIpOwp9CmZ1bmN0aW9uIGV2YWxTcGxpdChvcGVyYW5kcywgZG9jKSB7CiAgaWYgKCFBcnJheS5pc0FycmF5KG9wZXJhbmRzKSB8fCBvcGVyYW5kcy5sZW5ndGggIT09IDIpIHJldHVybiBudWxsOwogIGNvbnN0IHN0ciA9IFN0cmluZyhldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMF0sIGRvYykgfHwgIiIpOwogIGNvbnN0IGRlbGltaXRlciA9IFN0cmluZyhldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMV0sIGRvYykgfHwgIiIpOwogIHJldHVybiBzdHIuc3BsaXQoZGVsaW1pdGVyKTsKfQpmdW5jdGlvbiBldmFsU3RyTGVuQ1Aob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgcmV0dXJuIHZhbCAhPT0gbnVsbCAmJiB2YWwgIT09IHZvaWQgMCA/IFN0cmluZyh2YWwpLmxlbmd0aCA6IDA7Cn0KZnVuY3Rpb24gZXZhbFN0cmNhc2VjbXAob3BlcmFuZHMsIGRvYykgewogIGlmICghQXJyYXkuaXNBcnJheShvcGVyYW5kcykgfHwgb3BlcmFuZHMubGVuZ3RoICE9PSAyKSByZXR1cm4gbnVsbDsKICBjb25zdCBzdHIxID0gU3RyaW5nKGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1swXSwgZG9jKSB8fCAiIikudG9Mb3dlckNhc2UoKTsKICBjb25zdCBzdHIyID0gU3RyaW5nKGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1sxXSwgZG9jKSB8fCAiIikudG9Mb3dlckNhc2UoKTsKICBpZiAoc3RyMSA8IHN0cjIpIHJldHVybiAtMTsKICBpZiAoc3RyMSA+IHN0cjIpIHJldHVybiAxOwogIHJldHVybiAwOwp9CmZ1bmN0aW9uIGV2YWxJbmRleE9mQ1Aob3BlcmFuZHMsIGRvYykgewogIGlmICghQXJyYXkuaXNBcnJheShvcGVyYW5kcykgfHwgb3BlcmFuZHMubGVuZ3RoIDwgMikgcmV0dXJuIG51bGw7CiAgY29uc3Qgc3RyID0gU3RyaW5nKGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1swXSwgZG9jKSB8fCAiIik7CiAgY29uc3Qgc3Vic3RyID0gU3RyaW5nKGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1sxXSwgZG9jKSB8fCAiIik7CiAgY29uc3Qgc3RhcnQgPSBvcGVyYW5kc1syXSAhPT0gdm9pZCAwID8gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmRzWzJdLCBkb2MpIDogMDsKICBjb25zdCBlbmQgPSBvcGVyYW5kc1szXSAhPT0gdm9pZCAwID8gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmRzWzNdLCBkb2MpIDogc3RyLmxlbmd0aDsKICBjb25zdCBzZWFyY2hTdHIgPSBzdHIuc3Vic3RyaW5nKHN0YXJ0LCBlbmQpOwogIGNvbnN0IGluZGV4ID0gc2VhcmNoU3RyLmluZGV4T2Yoc3Vic3RyKTsKICByZXR1cm4gaW5kZXggPT09IC0xID8gLTEgOiBpbmRleCArIHN0YXJ0Owp9CmZ1bmN0aW9uIGV2YWxSZXBsYWNlT25lKG9wZXJhbmQsIGRvYykgewogIGNvbnN0IGlucHV0ID0gU3RyaW5nKGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLmlucHV0LCBkb2MpIHx8ICIiKTsKICBjb25zdCBmaW5kID0gU3RyaW5nKGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLmZpbmQsIGRvYykgfHwgIiIpOwogIGNvbnN0IHJlcGxhY2VtZW50ID0gU3RyaW5nKGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLnJlcGxhY2VtZW50LCBkb2MpIHx8ICIiKTsKICByZXR1cm4gaW5wdXQucmVwbGFjZShmaW5kLCByZXBsYWNlbWVudCk7Cn0KZnVuY3Rpb24gZXZhbFJlcGxhY2VBbGwob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgaW5wdXQgPSBTdHJpbmcoZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQuaW5wdXQsIGRvYykgfHwgIiIpOwogIGNvbnN0IGZpbmQgPSBTdHJpbmcoZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQuZmluZCwgZG9jKSB8fCAiIik7CiAgY29uc3QgcmVwbGFjZW1lbnQgPSBTdHJpbmcoZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQucmVwbGFjZW1lbnQsIGRvYykgfHwgIiIpOwogIHJldHVybiBpbnB1dC5zcGxpdChmaW5kKS5qb2luKHJlcGxhY2VtZW50KTsKfQpmdW5jdGlvbiBlc2NhcGVSZWdleChzdHIpIHsKICByZXR1cm4gc3RyLnJlcGxhY2UoL1suKis/XiR7fSgpfFtcXVxcXS9nLCAiXFwkJiIpOwp9CmZ1bmN0aW9uIGV2YWxDbXAob3BlcmFuZHMsIGRvYykgewogIGlmICghQXJyYXkuaXNBcnJheShvcGVyYW5kcykgfHwgb3BlcmFuZHMubGVuZ3RoICE9PSAyKSByZXR1cm4gbnVsbDsKICBjb25zdCB2YWwxID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmRzWzBdLCBkb2MpOwogIGNvbnN0IHZhbDIgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMV0sIGRvYyk7CiAgaWYgKHZhbDEgPCB2YWwyKSByZXR1cm4gLTE7CiAgaWYgKHZhbDEgPiB2YWwyKSByZXR1cm4gMTsKICByZXR1cm4gMDsKfQpmdW5jdGlvbiBldmFsRXEob3BlcmFuZHMsIGRvYykgewogIGlmICghQXJyYXkuaXNBcnJheShvcGVyYW5kcykgfHwgb3BlcmFuZHMubGVuZ3RoICE9PSAyKSByZXR1cm4gbnVsbDsKICBjb25zdCB2YWwxID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmRzWzBdLCBkb2MpOwogIGNvbnN0IHZhbDIgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMV0sIGRvYyk7CiAgcmV0dXJuIHZhbDEgPT09IHZhbDI7Cn0KZnVuY3Rpb24gZXZhbE5lKG9wZXJhbmRzLCBkb2MpIHsKICBpZiAoIUFycmF5LmlzQXJyYXkob3BlcmFuZHMpIHx8IG9wZXJhbmRzLmxlbmd0aCAhPT0gMikgcmV0dXJuIG51bGw7CiAgY29uc3QgdmFsMSA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1swXSwgZG9jKTsKICBjb25zdCB2YWwyID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmRzWzFdLCBkb2MpOwogIHJldHVybiB2YWwxICE9PSB2YWwyOwp9CmZ1bmN0aW9uIGV2YWxHdChvcGVyYW5kcywgZG9jKSB7CiAgaWYgKCFBcnJheS5pc0FycmF5KG9wZXJhbmRzKSB8fCBvcGVyYW5kcy5sZW5ndGggIT09IDIpIHJldHVybiBudWxsOwogIGNvbnN0IHZhbDEgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMF0sIGRvYyk7CiAgY29uc3QgdmFsMiA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1sxXSwgZG9jKTsKICByZXR1cm4gdmFsMSA+IHZhbDI7Cn0KZnVuY3Rpb24gZXZhbEd0ZShvcGVyYW5kcywgZG9jKSB7CiAgaWYgKCFBcnJheS5pc0FycmF5KG9wZXJhbmRzKSB8fCBvcGVyYW5kcy5sZW5ndGggIT09IDIpIHJldHVybiBudWxsOwogIGNvbnN0IHZhbDEgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMF0sIGRvYyk7CiAgY29uc3QgdmFsMiA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1sxXSwgZG9jKTsKICByZXR1cm4gdmFsMSA+PSB2YWwyOwp9CmZ1bmN0aW9uIGV2YWxMdChvcGVyYW5kcywgZG9jKSB7CiAgaWYgKCFBcnJheS5pc0FycmF5KG9wZXJhbmRzKSB8fCBvcGVyYW5kcy5sZW5ndGggIT09IDIpIHJldHVybiBudWxsOwogIGNvbnN0IHZhbDEgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMF0sIGRvYyk7CiAgY29uc3QgdmFsMiA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1sxXSwgZG9jKTsKICByZXR1cm4gdmFsMSA8IHZhbDI7Cn0KZnVuY3Rpb24gZXZhbEx0ZShvcGVyYW5kcywgZG9jKSB7CiAgaWYgKCFBcnJheS5pc0FycmF5KG9wZXJhbmRzKSB8fCBvcGVyYW5kcy5sZW5ndGggIT09IDIpIHJldHVybiBudWxsOwogIGNvbnN0IHZhbDEgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMF0sIGRvYyk7CiAgY29uc3QgdmFsMiA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1sxXSwgZG9jKTsKICByZXR1cm4gdmFsMSA8PSB2YWwyOwp9CmZ1bmN0aW9uIGV2YWxBbmQob3BlcmFuZHMsIGRvYykgewogIGlmICghQXJyYXkuaXNBcnJheShvcGVyYW5kcykpIHJldHVybiBudWxsOwogIGZvciAoY29uc3Qgb3BlcmFuZCBvZiBvcGVyYW5kcykgewogICAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgICBpZiAoIXZhbCkgcmV0dXJuIGZhbHNlOwogIH0KICByZXR1cm4gdHJ1ZTsKfQpmdW5jdGlvbiBldmFsT3Iob3BlcmFuZHMsIGRvYykgewogIGlmICghQXJyYXkuaXNBcnJheShvcGVyYW5kcykpIHJldHVybiBudWxsOwogIGZvciAoY29uc3Qgb3BlcmFuZCBvZiBvcGVyYW5kcykgewogICAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgICBpZiAodmFsKSByZXR1cm4gdHJ1ZTsKICB9CiAgcmV0dXJuIGZhbHNlOwp9CmZ1bmN0aW9uIGV2YWxOb3Qob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKEFycmF5LmlzQXJyYXkob3BlcmFuZCkgPyBvcGVyYW5kWzBdIDogb3BlcmFuZCwgZG9jKTsKICByZXR1cm4gIXZhbDsKfQpmdW5jdGlvbiBldmFsQ29uZChvcGVyYW5kLCBkb2MpIHsKICBsZXQgaWZFeHByLCB0aGVuRXhwciwgZWxzZUV4cHI7CiAgaWYgKEFycmF5LmlzQXJyYXkob3BlcmFuZCkpIHsKICAgIGlmIChvcGVyYW5kLmxlbmd0aCAhPT0gMykgcmV0dXJuIG51bGw7CiAgICBbaWZFeHByLCB0aGVuRXhwciwgZWxzZUV4cHJdID0gb3BlcmFuZDsKICB9IGVsc2UgaWYgKHR5cGVvZiBvcGVyYW5kID09PSAib2JqZWN0IikgewogICAgaWZFeHByID0gb3BlcmFuZC5pZjsKICAgIHRoZW5FeHByID0gb3BlcmFuZC50aGVuOwogICAgZWxzZUV4cHIgPSBvcGVyYW5kLmVsc2U7CiAgfSBlbHNlIHsKICAgIHJldHVybiBudWxsOwogIH0KICBjb25zdCBjb25kaXRpb24gPSBldmFsdWF0ZUV4cHJlc3Npb24oaWZFeHByLCBkb2MpOwogIHJldHVybiBjb25kaXRpb24gPyBldmFsdWF0ZUV4cHJlc3Npb24odGhlbkV4cHIsIGRvYykgOiBldmFsdWF0ZUV4cHJlc3Npb24oZWxzZUV4cHIsIGRvYyk7Cn0KZnVuY3Rpb24gZXZhbElmTnVsbChvcGVyYW5kcywgZG9jKSB7CiAgaWYgKCFBcnJheS5pc0FycmF5KG9wZXJhbmRzKSB8fCBvcGVyYW5kcy5sZW5ndGggPCAyKSByZXR1cm4gbnVsbDsKICBmb3IgKGxldCBpID0gMDsgaSA8IG9wZXJhbmRzLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbaV0sIGRvYyk7CiAgICBpZiAodmFsICE9PSBudWxsICYmIHZhbCAhPT0gdm9pZCAwKSB7CiAgICAgIHJldHVybiB2YWw7CiAgICB9CiAgfQogIHJldHVybiBudWxsOwp9CmZ1bmN0aW9uIGV2YWxTd2l0Y2gob3BlcmFuZCwgZG9jKSB7CiAgaWYgKHR5cGVvZiBvcGVyYW5kICE9PSAib2JqZWN0IiB8fCAhQXJyYXkuaXNBcnJheShvcGVyYW5kLmJyYW5jaGVzKSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIGZvciAoY29uc3QgYnJhbmNoIG9mIG9wZXJhbmQuYnJhbmNoZXMpIHsKICAgIGNvbnN0IGNhc2VSZXN1bHQgPSBldmFsdWF0ZUV4cHJlc3Npb24oYnJhbmNoLmNhc2UsIGRvYyk7CiAgICBpZiAoY2FzZVJlc3VsdCkgewogICAgICByZXR1cm4gZXZhbHVhdGVFeHByZXNzaW9uKGJyYW5jaC50aGVuLCBkb2MpOwogICAgfQogIH0KICByZXR1cm4gb3BlcmFuZC5kZWZhdWx0ICE9PSB2b2lkIDAgPyBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZC5kZWZhdWx0LCBkb2MpIDogbnVsbDsKfQpmdW5jdGlvbiBldmFsWWVhcihvcGVyYW5kLCBkb2MpIHsKICBjb25zdCBkYXRlID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgaWYgKGRhdGUgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICByZXR1cm4gZGF0ZS5nZXRVVENGdWxsWWVhcigpOwogIH0KICByZXR1cm4gbnVsbDsKfQpmdW5jdGlvbiBldmFsTW9udGgob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgZGF0ZSA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLCBkb2MpOwogIGlmIChkYXRlIGluc3RhbmNlb2YgRGF0ZSkgewogICAgcmV0dXJuIGRhdGUuZ2V0VVRDTW9udGgoKSArIDE7CiAgfQogIHJldHVybiBudWxsOwp9CmZ1bmN0aW9uIGV2YWxEYXlPZk1vbnRoKG9wZXJhbmQsIGRvYykgewogIGNvbnN0IGRhdGUgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZCwgZG9jKTsKICBpZiAoZGF0ZSBpbnN0YW5jZW9mIERhdGUpIHsKICAgIHJldHVybiBkYXRlLmdldFVUQ0RhdGUoKTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gZXZhbERheU9mV2VlayhvcGVyYW5kLCBkb2MpIHsKICBjb25zdCBkYXRlID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgaWYgKGRhdGUgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICByZXR1cm4gZGF0ZS5nZXRVVENEYXkoKSArIDE7CiAgfQogIHJldHVybiBudWxsOwp9CmZ1bmN0aW9uIGV2YWxEYXlPZlllYXIob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgZGF0ZSA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLCBkb2MpOwogIGlmIChkYXRlIGluc3RhbmNlb2YgRGF0ZSkgewogICAgY29uc3Qgc3RhcnQgPSBuZXcgRGF0ZShEYXRlLlVUQyhkYXRlLmdldFVUQ0Z1bGxZZWFyKCksIDAsIDApKTsKICAgIGNvbnN0IGRpZmYgPSBkYXRlIC0gc3RhcnQ7CiAgICBjb25zdCBvbmVEYXkgPSAxZTMgKiA2MCAqIDYwICogMjQ7CiAgICByZXR1cm4gTWF0aC5mbG9vcihkaWZmIC8gb25lRGF5KTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gZXZhbEhvdXIob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgZGF0ZSA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLCBkb2MpOwogIGlmIChkYXRlIGluc3RhbmNlb2YgRGF0ZSkgewogICAgcmV0dXJuIGRhdGUuZ2V0VVRDSG91cnMoKTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gZXZhbE1pbnV0ZShvcGVyYW5kLCBkb2MpIHsKICBjb25zdCBkYXRlID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgaWYgKGRhdGUgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICByZXR1cm4gZGF0ZS5nZXRVVENNaW51dGVzKCk7CiAgfQogIHJldHVybiBudWxsOwp9CmZ1bmN0aW9uIGV2YWxTZWNvbmQob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgZGF0ZSA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLCBkb2MpOwogIGlmIChkYXRlIGluc3RhbmNlb2YgRGF0ZSkgewogICAgcmV0dXJuIGRhdGUuZ2V0VVRDU2Vjb25kcygpOwogIH0KICByZXR1cm4gbnVsbDsKfQpmdW5jdGlvbiBldmFsTWlsbGlzZWNvbmQob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgZGF0ZSA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLCBkb2MpOwogIGlmIChkYXRlIGluc3RhbmNlb2YgRGF0ZSkgewogICAgcmV0dXJuIGRhdGUuZ2V0VVRDTWlsbGlzZWNvbmRzKCk7CiAgfQogIHJldHVybiBudWxsOwp9CmZ1bmN0aW9uIGV2YWxXZWVrKG9wZXJhbmQsIGRvYykgewogIGNvbnN0IGRhdGUgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZCwgZG9jKTsKICBpZiAoZGF0ZSBpbnN0YW5jZW9mIERhdGUpIHsKICAgIGNvbnN0IG9uZWphbiA9IG5ldyBEYXRlKERhdGUuVVRDKGRhdGUuZ2V0VVRDRnVsbFllYXIoKSwgMCwgMSkpOwogICAgY29uc3Qgd2VlayA9IE1hdGguY2VpbCgoKGRhdGUgLSBvbmVqYW4pIC8gODY0ZTUgKyBvbmVqYW4uZ2V0VVRDRGF5KCkgKyAxKSAvIDcpOwogICAgcmV0dXJuIHdlZWsgLSAxOwogIH0KICByZXR1cm4gbnVsbDsKfQpmdW5jdGlvbiBldmFsSXNvV2VlayhvcGVyYW5kLCBkb2MpIHsKICBjb25zdCBkYXRlID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgaWYgKGRhdGUgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICBjb25zdCB0YXJnZXQgPSBuZXcgRGF0ZShkYXRlLnZhbHVlT2YoKSk7CiAgICBjb25zdCBkYXlOciA9IChkYXRlLmdldFVUQ0RheSgpICsgNikgJSA3OwogICAgdGFyZ2V0LnNldFVUQ0RhdGUodGFyZ2V0LmdldFVUQ0RhdGUoKSAtIGRheU5yICsgMyk7CiAgICBjb25zdCBmaXJzdFRodXJzZGF5ID0gdGFyZ2V0LnZhbHVlT2YoKTsKICAgIHRhcmdldC5zZXRVVENNb250aCgwLCAxKTsKICAgIGlmICh0YXJnZXQuZ2V0VVRDRGF5KCkgIT09IDQpIHsKICAgICAgdGFyZ2V0LnNldFVUQ01vbnRoKDAsIDEgKyAoNCAtIHRhcmdldC5nZXRVVENEYXkoKSArIDcpICUgNyk7CiAgICB9CiAgICByZXR1cm4gMSArIE1hdGguY2VpbCgoZmlyc3RUaHVyc2RheSAtIHRhcmdldCkgLyA2MDQ4ZTUpOwogIH0KICByZXR1cm4gbnVsbDsKfQpmdW5jdGlvbiBldmFsSXNvV2Vla1llYXIob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgZGF0ZSA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLCBkb2MpOwogIGlmIChkYXRlIGluc3RhbmNlb2YgRGF0ZSkgewogICAgY29uc3QgdGFyZ2V0ID0gbmV3IERhdGUoZGF0ZS52YWx1ZU9mKCkpOwogICAgdGFyZ2V0LnNldFVUQ0RhdGUodGFyZ2V0LmdldFVUQ0RhdGUoKSAtIChkYXRlLmdldFVUQ0RheSgpICsgNikgJSA3ICsgMyk7CiAgICByZXR1cm4gdGFyZ2V0LmdldFVUQ0Z1bGxZZWFyKCk7CiAgfQogIHJldHVybiBudWxsOwp9CmZ1bmN0aW9uIGV2YWxEYXRlVG9TdHJpbmcob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgZm9ybWF0ID0gb3BlcmFuZC5mb3JtYXQgPyBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZC5mb3JtYXQsIGRvYykgOiAiJVktJW0tJWRUJUg6JU06JVMuJUxaIjsKICBjb25zdCBkYXRlID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQuZGF0ZSwgZG9jKTsKICBpZiAoIShkYXRlIGluc3RhbmNlb2YgRGF0ZSkpIHJldHVybiBudWxsOwogIHJldHVybiBmb3JtYXQucmVwbGFjZSgiJVkiLCBkYXRlLmdldFVUQ0Z1bGxZZWFyKCkpLnJlcGxhY2UoIiVtIiwgU3RyaW5nKGRhdGUuZ2V0VVRDTW9udGgoKSArIDEpLnBhZFN0YXJ0KDIsICIwIikpLnJlcGxhY2UoIiVkIiwgU3RyaW5nKGRhdGUuZ2V0VVRDRGF0ZSgpKS5wYWRTdGFydCgyLCAiMCIpKS5yZXBsYWNlKCIlSCIsIFN0cmluZyhkYXRlLmdldFVUQ0hvdXJzKCkpLnBhZFN0YXJ0KDIsICIwIikpLnJlcGxhY2UoIiVNIiwgU3RyaW5nKGRhdGUuZ2V0VVRDTWludXRlcygpKS5wYWRTdGFydCgyLCAiMCIpKS5yZXBsYWNlKCIlUyIsIFN0cmluZyhkYXRlLmdldFVUQ1NlY29uZHMoKSkucGFkU3RhcnQoMiwgIjAiKSkucmVwbGFjZSgiJUwiLCBTdHJpbmcoZGF0ZS5nZXRVVENNaWxsaXNlY29uZHMoKSkucGFkU3RhcnQoMywgIjAiKSk7Cn0KZnVuY3Rpb24gZXZhbFRvRGF0ZShvcGVyYW5kLCBkb2MpIHsKICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZCwgZG9jKTsKICBpZiAodmFsIGluc3RhbmNlb2YgRGF0ZSkgcmV0dXJuIHZhbDsKICBpZiAodHlwZW9mIHZhbCA9PT0gInN0cmluZyIgfHwgdHlwZW9mIHZhbCA9PT0gIm51bWJlciIpIHsKICAgIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZSh2YWwpOwogICAgcmV0dXJuIGlzTmFOKGRhdGUuZ2V0VGltZSgpKSA/IG51bGwgOiBkYXRlOwogIH0KICByZXR1cm4gbnVsbDsKfQpmdW5jdGlvbiBldmFsQXJyYXlFbGVtQXQob3BlcmFuZHMsIGRvYykgewogIGlmICghQXJyYXkuaXNBcnJheShvcGVyYW5kcykgfHwgb3BlcmFuZHMubGVuZ3RoICE9PSAyKSByZXR1cm4gbnVsbDsKICBjb25zdCBhcnIgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMF0sIGRvYyk7CiAgY29uc3QgaWR4ID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmRzWzFdLCBkb2MpOwogIGlmICghQXJyYXkuaXNBcnJheShhcnIpIHx8IHR5cGVvZiBpZHggIT09ICJudW1iZXIiKSByZXR1cm4gbnVsbDsKICBjb25zdCBpbmRleCA9IGlkeCA8IDAgPyBhcnIubGVuZ3RoICsgaWR4IDogaWR4OwogIHJldHVybiBhcnJbaW5kZXhdOwp9CmZ1bmN0aW9uIGV2YWxDb25jYXRBcnJheXMob3BlcmFuZHMsIGRvYykgewogIGlmICghQXJyYXkuaXNBcnJheShvcGVyYW5kcykpIHJldHVybiBudWxsOwogIGNvbnN0IHJlc3VsdCA9IFtdOwogIGZvciAoY29uc3Qgb3BlcmFuZCBvZiBvcGVyYW5kcykgewogICAgY29uc3QgYXJyID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgICBpZiAoQXJyYXkuaXNBcnJheShhcnIpKSB7CiAgICAgIHJlc3VsdC5wdXNoKC4uLmFycik7CiAgICB9CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KZnVuY3Rpb24gZXZhbEZpbHRlcihvcGVyYW5kLCBkb2MpIHsKICBjb25zdCBpbnB1dCA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLmlucHV0LCBkb2MpOwogIGNvbnN0IGFzVmFyID0gb3BlcmFuZC5hcyB8fCAidGhpcyI7CiAgY29uc3QgY29uZCA9IG9wZXJhbmQuY29uZDsKICBpZiAoIUFycmF5LmlzQXJyYXkoaW5wdXQpKSByZXR1cm4gbnVsbDsKICByZXR1cm4gaW5wdXQuZmlsdGVyKChpdGVtKSA9PiB7CiAgICBjb25zdCBpdGVtRG9jID0geyAuLi5kb2MsIFthc1Zhcl06IGl0ZW0gfTsKICAgIHJldHVybiBldmFsdWF0ZUV4cHJlc3Npb24oY29uZCwgaXRlbURvYyk7CiAgfSk7Cn0KZnVuY3Rpb24gZXZhbEluKG9wZXJhbmRzLCBkb2MpIHsKICBpZiAoIUFycmF5LmlzQXJyYXkob3BlcmFuZHMpIHx8IG9wZXJhbmRzLmxlbmd0aCAhPT0gMikgcmV0dXJuIG51bGw7CiAgY29uc3QgdmFsdWUgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMF0sIGRvYyk7CiAgY29uc3QgYXJyID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmRzWzFdLCBkb2MpOwogIGlmICghQXJyYXkuaXNBcnJheShhcnIpKSByZXR1cm4gZmFsc2U7CiAgcmV0dXJuIGFyci5pbmNsdWRlcyh2YWx1ZSk7Cn0KZnVuY3Rpb24gZXZhbEluZGV4T2ZBcnJheShvcGVyYW5kcywgZG9jKSB7CiAgaWYgKCFBcnJheS5pc0FycmF5KG9wZXJhbmRzKSB8fCBvcGVyYW5kcy5sZW5ndGggPCAyKSByZXR1cm4gbnVsbDsKICBjb25zdCBhcnIgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMF0sIGRvYyk7CiAgY29uc3Qgc2VhcmNoID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmRzWzFdLCBkb2MpOwogIGNvbnN0IHN0YXJ0ID0gb3BlcmFuZHNbMl0gIT09IHZvaWQgMCA/IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1syXSwgZG9jKSA6IDA7CiAgY29uc3QgZW5kID0gb3BlcmFuZHNbM10gIT09IHZvaWQgMCA/IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1szXSwgZG9jKSA6IGFyci5sZW5ndGg7CiAgaWYgKCFBcnJheS5pc0FycmF5KGFycikpIHJldHVybiBudWxsOwogIGZvciAobGV0IGkgPSBzdGFydDsgaSA8IGVuZCAmJiBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAoYXJyW2ldID09PSBzZWFyY2gpIHJldHVybiBpOwogIH0KICByZXR1cm4gLTE7Cn0KZnVuY3Rpb24gZXZhbElzQXJyYXkob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgcmV0dXJuIEFycmF5LmlzQXJyYXkodmFsKTsKfQpmdW5jdGlvbiBldmFsTWFwKG9wZXJhbmQsIGRvYykgewogIGNvbnN0IGlucHV0ID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQuaW5wdXQsIGRvYyk7CiAgY29uc3QgYXNWYXIgPSBvcGVyYW5kLmFzIHx8ICJ0aGlzIjsKICBjb25zdCBpbkV4cHIgPSBvcGVyYW5kLmluOwogIGlmICghQXJyYXkuaXNBcnJheShpbnB1dCkpIHJldHVybiBudWxsOwogIHJldHVybiBpbnB1dC5tYXAoKGl0ZW0pID0+IHsKICAgIGNvbnN0IGl0ZW1Eb2MgPSB7IC4uLmRvYywgW2FzVmFyXTogaXRlbSB9OwogICAgcmV0dXJuIGV2YWx1YXRlRXhwcmVzc2lvbihpbkV4cHIsIGl0ZW1Eb2MpOwogIH0pOwp9CmZ1bmN0aW9uIGV2YWxSZWR1Y2Uob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgaW5wdXQgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZC5pbnB1dCwgZG9jKTsKICBjb25zdCBpbml0aWFsVmFsdWUgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZC5pbml0aWFsVmFsdWUsIGRvYyk7CiAgY29uc3QgaW5FeHByID0gb3BlcmFuZC5pbjsKICBpZiAoIUFycmF5LmlzQXJyYXkoaW5wdXQpKSByZXR1cm4gbnVsbDsKICBsZXQgdmFsdWUgPSBpbml0aWFsVmFsdWU7CiAgZm9yIChjb25zdCBpdGVtIG9mIGlucHV0KSB7CiAgICBjb25zdCBpdGVtRG9jID0geyAuLi5kb2MsIHZhbHVlLCB0aGlzOiBpdGVtIH07CiAgICB2YWx1ZSA9IGV2YWx1YXRlRXhwcmVzc2lvbihpbkV4cHIsIGl0ZW1Eb2MpOwogIH0KICByZXR1cm4gdmFsdWU7Cn0KZnVuY3Rpb24gZXZhbFNpemUob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgYXJyID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgcmV0dXJuIEFycmF5LmlzQXJyYXkoYXJyKSA/IGFyci5sZW5ndGggOiBudWxsOwp9CmZ1bmN0aW9uIGV2YWxTbGljZShvcGVyYW5kcywgZG9jKSB7CiAgaWYgKCFBcnJheS5pc0FycmF5KG9wZXJhbmRzKSB8fCBvcGVyYW5kcy5sZW5ndGggPCAyKSByZXR1cm4gbnVsbDsKICBjb25zdCBhcnIgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMF0sIGRvYyk7CiAgaWYgKCFBcnJheS5pc0FycmF5KGFycikpIHJldHVybiBudWxsOwogIGlmIChvcGVyYW5kcy5sZW5ndGggPT09IDIpIHsKICAgIGNvbnN0IG4gPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMV0sIGRvYyk7CiAgICByZXR1cm4gbiA+PSAwID8gYXJyLnNsaWNlKDAsIG4pIDogYXJyLnNsaWNlKG4pOwogIH0gZWxzZSB7CiAgICBjb25zdCBwb3NpdGlvbiA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1sxXSwgZG9jKTsKICAgIGNvbnN0IG4gPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMl0sIGRvYyk7CiAgICByZXR1cm4gYXJyLnNsaWNlKHBvc2l0aW9uLCBwb3NpdGlvbiArIG4pOwogIH0KfQpmdW5jdGlvbiBldmFsUmV2ZXJzZUFycmF5KG9wZXJhbmQsIGRvYykgewogIGNvbnN0IGFyciA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLCBkb2MpOwogIHJldHVybiBBcnJheS5pc0FycmF5KGFycikgPyBhcnIuc2xpY2UoKS5yZXZlcnNlKCkgOiBudWxsOwp9CmZ1bmN0aW9uIGV2YWxaaXAob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgaW5wdXRzID0gb3BlcmFuZC5pbnB1dHMgPyBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZC5pbnB1dHMsIGRvYykgOiBudWxsOwogIGNvbnN0IHVzZUxvbmdlc3RMZW5ndGggPSBvcGVyYW5kLnVzZUxvbmdlc3RMZW5ndGggfHwgZmFsc2U7CiAgY29uc3QgZGVmYXVsdHMgPSBvcGVyYW5kLmRlZmF1bHRzOwogIGlmICghQXJyYXkuaXNBcnJheShpbnB1dHMpKSByZXR1cm4gbnVsbDsKICBjb25zdCBhcnJheXMgPSBpbnB1dHMubWFwKChpbnB1dCkgPT4gZXZhbHVhdGVFeHByZXNzaW9uKGlucHV0LCBkb2MpKTsKICBpZiAoIWFycmF5cy5ldmVyeSgoYXJyKSA9PiBBcnJheS5pc0FycmF5KGFycikpKSByZXR1cm4gbnVsbDsKICBjb25zdCBtYXhMZW5ndGggPSBNYXRoLm1heCguLi5hcnJheXMubWFwKChhcnIpID0+IGFyci5sZW5ndGgpKTsKICBjb25zdCBsZW5ndGggPSB1c2VMb25nZXN0TGVuZ3RoID8gbWF4TGVuZ3RoIDogTWF0aC5taW4oLi4uYXJyYXlzLm1hcCgoYXJyKSA9PiBhcnIubGVuZ3RoKSk7CiAgY29uc3QgcmVzdWx0ID0gW107CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgY29uc3QgdHVwbGUgPSBbXTsKICAgIGZvciAobGV0IGogPSAwOyBqIDwgYXJyYXlzLmxlbmd0aDsgaisrKSB7CiAgICAgIGlmIChpIDwgYXJyYXlzW2pdLmxlbmd0aCkgewogICAgICAgIHR1cGxlLnB1c2goYXJyYXlzW2pdW2ldKTsKICAgICAgfSBlbHNlIGlmIChkZWZhdWx0cyAmJiBqIDwgZGVmYXVsdHMubGVuZ3RoKSB7CiAgICAgICAgdHVwbGUucHVzaChkZWZhdWx0c1tqXSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdHVwbGUucHVzaChudWxsKTsKICAgICAgfQogICAgfQogICAgcmVzdWx0LnB1c2godHVwbGUpOwogIH0KICByZXR1cm4gcmVzdWx0Owp9CmZ1bmN0aW9uIGV2YWxUeXBlKG9wZXJhbmQsIGRvYykgewogIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLCBkb2MpOwogIGlmICh2YWwgPT09IG51bGwpIHJldHVybiAibnVsbCI7CiAgaWYgKHZhbCA9PT0gdm9pZCAwKSByZXR1cm4gIm1pc3NpbmciOwogIGlmICh0eXBlb2YgdmFsID09PSAiYm9vbGVhbiIpIHJldHVybiAiYm9vbCI7CiAgaWYgKHR5cGVvZiB2YWwgPT09ICJudW1iZXIiKSByZXR1cm4gTnVtYmVyLmlzSW50ZWdlcih2YWwpID8gImludCIgOiAiZG91YmxlIjsKICBpZiAodHlwZW9mIHZhbCA9PT0gInN0cmluZyIpIHJldHVybiAic3RyaW5nIjsKICBpZiAodmFsIGluc3RhbmNlb2YgRGF0ZSkgcmV0dXJuICJkYXRlIjsKICBpZiAoQXJyYXkuaXNBcnJheSh2YWwpKSByZXR1cm4gImFycmF5IjsKICBpZiAodHlwZW9mIHZhbCA9PT0gIm9iamVjdCIpIHJldHVybiAib2JqZWN0IjsKICByZXR1cm4gInVua25vd24iOwp9CmZ1bmN0aW9uIGV2YWxDb252ZXJ0KG9wZXJhbmQsIGRvYykgewogIGNvbnN0IGlucHV0ID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQuaW5wdXQsIGRvYyk7CiAgY29uc3QgdG8gPSBvcGVyYW5kLnRvOwogIGNvbnN0IG9uRXJyb3IgPSBvcGVyYW5kLm9uRXJyb3I7CiAgY29uc3Qgb25OdWxsID0gb3BlcmFuZC5vbk51bGw7CiAgaWYgKGlucHV0ID09PSBudWxsKSB7CiAgICByZXR1cm4gb25OdWxsICE9PSB2b2lkIDAgPyBldmFsdWF0ZUV4cHJlc3Npb24ob25OdWxsLCBkb2MpIDogbnVsbDsKICB9CiAgdHJ5IHsKICAgIHN3aXRjaCAodG8pIHsKICAgICAgY2FzZSAiZG91YmxlIjoKICAgICAgY2FzZSAiZGVjaW1hbCI6CiAgICAgICAgcmV0dXJuIHBhcnNlRmxvYXQoaW5wdXQpOwogICAgICBjYXNlICJpbnQiOgogICAgICBjYXNlICJsb25nIjoKICAgICAgICByZXR1cm4gcGFyc2VJbnQoaW5wdXQpOwogICAgICBjYXNlICJib29sIjoKICAgICAgICByZXR1cm4gQm9vbGVhbihpbnB1dCk7CiAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgcmV0dXJuIFN0cmluZyhpbnB1dCk7CiAgICAgIGNhc2UgImRhdGUiOgogICAgICAgIHJldHVybiBuZXcgRGF0ZShpbnB1dCk7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIGlucHV0OwogICAgfQogIH0gY2F0Y2ggKGUpIHsKICAgIHJldHVybiBvbkVycm9yICE9PSB2b2lkIDAgPyBldmFsdWF0ZUV4cHJlc3Npb24ob25FcnJvciwgZG9jKSA6IG51bGw7CiAgfQp9CmZ1bmN0aW9uIGV2YWxUb0Jvb2wob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgcmV0dXJuIEJvb2xlYW4odmFsKTsKfQpmdW5jdGlvbiBldmFsVG9EZWNpbWFsKG9wZXJhbmQsIGRvYykgewogIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLCBkb2MpOwogIHJldHVybiBwYXJzZUZsb2F0KHZhbCk7Cn0KZnVuY3Rpb24gZXZhbFRvRG91YmxlKG9wZXJhbmQsIGRvYykgewogIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLCBkb2MpOwogIHJldHVybiBwYXJzZUZsb2F0KHZhbCk7Cn0KZnVuY3Rpb24gZXZhbFRvSW50KG9wZXJhbmQsIGRvYykgewogIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLCBkb2MpOwogIHJldHVybiBwYXJzZUludCh2YWwpOwp9CmZ1bmN0aW9uIGV2YWxUb0xvbmcob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgcmV0dXJuIHBhcnNlSW50KHZhbCk7Cn0KZnVuY3Rpb24gZXZhbFRvU3RyaW5nKG9wZXJhbmQsIGRvYykgewogIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLCBkb2MpOwogIGlmICh2YWwgPT09IG51bGwgfHwgdmFsID09PSB2b2lkIDApIHJldHVybiBudWxsOwogIHJldHVybiBTdHJpbmcodmFsKTsKfQpmdW5jdGlvbiBldmFsT2JqZWN0VG9BcnJheShvcGVyYW5kLCBkb2MpIHsKICBjb25zdCBvYmogPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZCwgZG9jKTsKICBpZiAodHlwZW9mIG9iaiAhPT0gIm9iamVjdCIgfHwgb2JqID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkob2JqKSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiBPYmplY3Qua2V5cyhvYmopLm1hcCgoa2V5KSA9PiAoeyBrOiBrZXksIHY6IG9ialtrZXldIH0pKTsKfQpmdW5jdGlvbiBldmFsQXJyYXlUb09iamVjdChvcGVyYW5kLCBkb2MpIHsKICBjb25zdCBhcnIgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZCwgZG9jKTsKICBpZiAoIUFycmF5LmlzQXJyYXkoYXJyKSkgcmV0dXJuIG51bGw7CiAgY29uc3QgcmVzdWx0ID0ge307CiAgZm9yIChjb25zdCBpdGVtIG9mIGFycikgewogICAgaWYgKEFycmF5LmlzQXJyYXkoaXRlbSkgJiYgaXRlbS5sZW5ndGggPT09IDIpIHsKICAgICAgcmVzdWx0W2l0ZW1bMF1dID0gaXRlbVsxXTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIGl0ZW0gPT09ICJvYmplY3QiICYmIGl0ZW0uayAhPT0gdm9pZCAwICYmIGl0ZW0udiAhPT0gdm9pZCAwKSB7CiAgICAgIHJlc3VsdFtpdGVtLmtdID0gaXRlbS52OwogICAgfQogIH0KICByZXR1cm4gcmVzdWx0Owp9CmZ1bmN0aW9uIGV2YWxNZXJnZU9iamVjdHMob3BlcmFuZHMsIGRvYykgewogIGlmICghQXJyYXkuaXNBcnJheShvcGVyYW5kcykpIHsKICAgIHJldHVybiBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHMsIGRvYyk7CiAgfQogIGNvbnN0IHJlc3VsdCA9IHt9OwogIGZvciAoY29uc3Qgb3BlcmFuZCBvZiBvcGVyYW5kcykgewogICAgY29uc3Qgb2JqID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgICBpZiAodHlwZW9mIG9iaiA9PT0gIm9iamVjdCIgJiYgb2JqICE9PSBudWxsICYmICFBcnJheS5pc0FycmF5KG9iaikpIHsKICAgICAgT2JqZWN0LmFzc2lnbihyZXN1bHQsIG9iaik7CiAgICB9CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KY29uc3QgQlNPTl9UWVBFUyA9IHsKICAxOiAiZG91YmxlIiwKICAyOiAic3RyaW5nIiwKICAzOiAib2JqZWN0IiwKICA0OiAiYXJyYXkiLAogIDU6ICJiaW5EYXRhIiwKICA2OiAidW5kZWZpbmVkIiwKICA3OiAib2JqZWN0SWQiLAogIDg6ICJib29sIiwKICA5OiAiZGF0ZSIsCiAgMTA6ICJudWxsIiwKICAxMTogInJlZ2V4IiwKICAxMzogImphdmFzY3JpcHQiLAogIDE1OiAiamF2YXNjcmlwdFdpdGhTY29wZSIsCiAgMTY6ICJpbnQiLAogIDE3OiAidGltZXN0YW1wIiwKICAxODogImxvbmciLAogIDE5OiAiZGVjaW1hbCIsCiAgMTI3OiAibWF4S2V5IiwKICAiLTEiOiAibWluS2V5Igp9Owpjb25zdCBUWVBFX0FMSUFTRVMgPSBPYmplY3QuZW50cmllcyhCU09OX1RZUEVTKS5yZWR1Y2UoKGFjYywgW2NvZGUsIG5hbWVdKSA9PiB7CiAgYWNjW25hbWVdID0gcGFyc2VJbnQoY29kZSk7CiAgcmV0dXJuIGFjYzsKfSwge30pOwpmdW5jdGlvbiBtYXRjaGVzVHlwZSh2YWx1ZSwgdHlwZVNwZWMpIHsKICBpZiAoaXNBcnJheSh0eXBlU3BlYykpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdHlwZVNwZWMubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKG1hdGNoZXNUeXBlKHZhbHVlLCB0eXBlU3BlY1tpXSkpIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KICBjb25zdCB0eXBlQ29kZSA9IHR5cGVvZiB0eXBlU3BlYyA9PT0gIm51bWJlciIgPyB0eXBlU3BlYyA6IFRZUEVfQUxJQVNFU1t0eXBlU3BlY107CiAgY29uc3QgdHlwZU5hbWUgPSBCU09OX1RZUEVTW3R5cGVDb2RlXSB8fCB0eXBlU3BlYzsKICBpZiAodmFsdWUgPT09IG51bGwpIHJldHVybiB0eXBlTmFtZSA9PT0gIm51bGwiIHx8IHR5cGVDb2RlID09PSAxMDsKICBpZiAodmFsdWUgPT09IHZvaWQgMCkgcmV0dXJuIHR5cGVOYW1lID09PSAidW5kZWZpbmVkIiB8fCB0eXBlQ29kZSA9PT0gNjsKICBpZiAodHlwZW9mIHZhbHVlID09PSAibnVtYmVyIikgewogICAgaWYgKE51bWJlci5pc0ludGVnZXIodmFsdWUpKSByZXR1cm4gdHlwZU5hbWUgPT09ICJpbnQiIHx8IHR5cGVDb2RlID09PSAxNjsKICAgIHJldHVybiB0eXBlTmFtZSA9PT0gImRvdWJsZSIgfHwgdHlwZUNvZGUgPT09IDE7CiAgfQogIGlmICh0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciKSByZXR1cm4gdHlwZU5hbWUgPT09ICJzdHJpbmciIHx8IHR5cGVDb2RlID09PSAyOwogIGlmICh0eXBlb2YgdmFsdWUgPT09ICJib29sZWFuIikgcmV0dXJuIHR5cGVOYW1lID09PSAiYm9vbCIgfHwgdHlwZUNvZGUgPT09IDg7CiAgaWYgKHZhbHVlIGluc3RhbmNlb2YgRGF0ZSkgcmV0dXJuIHR5cGVOYW1lID09PSAiZGF0ZSIgfHwgdHlwZUNvZGUgPT09IDk7CiAgaWYgKHZhbHVlIGluc3RhbmNlb2YgT2JqZWN0SWQpIHJldHVybiB0eXBlTmFtZSA9PT0gIm9iamVjdElkIiB8fCB0eXBlQ29kZSA9PT0gNzsKICBpZiAodmFsdWUgaW5zdGFuY2VvZiBSZWdFeHApIHJldHVybiB0eXBlTmFtZSA9PT0gInJlZ2V4IiB8fCB0eXBlQ29kZSA9PT0gMTE7CiAgaWYgKGlzQXJyYXkodmFsdWUpKSByZXR1cm4gdHlwZU5hbWUgPT09ICJhcnJheSIgfHwgdHlwZUNvZGUgPT09IDQ7CiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIpIHJldHVybiB0eXBlTmFtZSA9PT0gIm9iamVjdCIgfHwgdHlwZUNvZGUgPT09IDM7CiAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gdHlwZVNwZWM7Cn0KZnVuY3Rpb24gdG9CaXRNYXNrKHBvc2l0aW9ucykgewogIGlmIChpc0FycmF5KHBvc2l0aW9ucykpIHsKICAgIGxldCBtYXNrID0gMDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9zaXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgIG1hc2sgfD0gMSA8PCBwb3NpdGlvbnNbaV07CiAgICB9CiAgICByZXR1cm4gbWFzazsKICB9IGVsc2UgaWYgKHR5cGVvZiBwb3NpdGlvbnMgPT09ICJudW1iZXIiKSB7CiAgICByZXR1cm4gcG9zaXRpb25zOwogIH0KICByZXR1cm4gMDsKfQpmdW5jdGlvbiBtYXRjaGVzQml0c0FsbFNldCh2YWx1ZSwgcG9zaXRpb25zKSB7CiAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gIm51bWJlciIpIHJldHVybiBmYWxzZTsKICBjb25zdCBtYXNrID0gdG9CaXRNYXNrKHBvc2l0aW9ucyk7CiAgcmV0dXJuICh2YWx1ZSAmIG1hc2spID09PSBtYXNrOwp9CmZ1bmN0aW9uIG1hdGNoZXNCaXRzQWxsQ2xlYXIodmFsdWUsIHBvc2l0aW9ucykgewogIGlmICh0eXBlb2YgdmFsdWUgIT09ICJudW1iZXIiKSByZXR1cm4gZmFsc2U7CiAgY29uc3QgbWFzayA9IHRvQml0TWFzayhwb3NpdGlvbnMpOwogIHJldHVybiAodmFsdWUgJiBtYXNrKSA9PT0gMDsKfQpmdW5jdGlvbiBtYXRjaGVzQml0c0FueVNldCh2YWx1ZSwgcG9zaXRpb25zKSB7CiAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gIm51bWJlciIpIHJldHVybiBmYWxzZTsKICBjb25zdCBtYXNrID0gdG9CaXRNYXNrKHBvc2l0aW9ucyk7CiAgcmV0dXJuICh2YWx1ZSAmIG1hc2spICE9PSAwOwp9CmZ1bmN0aW9uIG1hdGNoZXNCaXRzQW55Q2xlYXIodmFsdWUsIHBvc2l0aW9ucykgewogIGlmICh0eXBlb2YgdmFsdWUgIT09ICJudW1iZXIiKSByZXR1cm4gZmFsc2U7CiAgY29uc3QgbWFzayA9IHRvQml0TWFzayhwb3NpdGlvbnMpOwogIHJldHVybiAodmFsdWUgJiBtYXNrKSAhPT0gbWFzazsKfQpmdW5jdGlvbiB2YWxpZGF0ZUpzb25TY2hlbWEoZG9jLCBzY2hlbWEpIHsKICBpZiAoc2NoZW1hLnR5cGUpIHsKICAgIGNvbnN0IGRvY1R5cGUgPSBpc0FycmF5KGRvYykgPyAiYXJyYXkiIDogZG9jID09PSBudWxsID8gIm51bGwiIDogdHlwZW9mIGRvYzsKICAgIGlmIChzY2hlbWEudHlwZSAhPT0gZG9jVHlwZSkgcmV0dXJuIGZhbHNlOwogIH0KICBpZiAoc2NoZW1hLnJlcXVpcmVkICYmIGlzQXJyYXkoc2NoZW1hLnJlcXVpcmVkKSkgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzY2hlbWEucmVxdWlyZWQubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKCEoc2NoZW1hLnJlcXVpcmVkW2ldIGluIGRvYykpIHJldHVybiBmYWxzZTsKICAgIH0KICB9CiAgaWYgKHNjaGVtYS5wcm9wZXJ0aWVzKSB7CiAgICBmb3IgKGNvbnN0IGtleSBpbiBzY2hlbWEucHJvcGVydGllcykgewogICAgICBpZiAoIShrZXkgaW4gZG9jKSkgcmV0dXJuIGZhbHNlOwogICAgICBjb25zdCBwcm9wU2NoZW1hID0gc2NoZW1hLnByb3BlcnRpZXNba2V5XTsKICAgICAgaWYgKCF2YWxpZGF0ZUpzb25TY2hlbWEoZG9jW2tleV0sIHByb3BTY2hlbWEpKSByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQogIGlmIChzY2hlbWEubWluaW11bSAhPT0gdm9pZCAwICYmIHR5cGVvZiBkb2MgPT09ICJudW1iZXIiKSB7CiAgICBpZiAoZG9jIDwgc2NoZW1hLm1pbmltdW0pIHJldHVybiBmYWxzZTsKICB9CiAgaWYgKHNjaGVtYS5tYXhpbXVtICE9PSB2b2lkIDAgJiYgdHlwZW9mIGRvYyA9PT0gIm51bWJlciIpIHsKICAgIGlmIChkb2MgPiBzY2hlbWEubWF4aW11bSkgcmV0dXJuIGZhbHNlOwogIH0KICBpZiAoc2NoZW1hLm1pbkxlbmd0aCAhPT0gdm9pZCAwICYmIHR5cGVvZiBkb2MgPT09ICJzdHJpbmciKSB7CiAgICBpZiAoZG9jLmxlbmd0aCA8IHNjaGVtYS5taW5MZW5ndGgpIHJldHVybiBmYWxzZTsKICB9CiAgaWYgKHNjaGVtYS5tYXhMZW5ndGggIT09IHZvaWQgMCAmJiB0eXBlb2YgZG9jID09PSAic3RyaW5nIikgewogICAgaWYgKGRvYy5sZW5ndGggPiBzY2hlbWEubWF4TGVuZ3RoKSByZXR1cm4gZmFsc2U7CiAgfQogIGlmIChzY2hlbWEucGF0dGVybiAmJiB0eXBlb2YgZG9jID09PSAic3RyaW5nIikgewogICAgY29uc3QgcmVnZXggPSBuZXcgUmVnRXhwKHNjaGVtYS5wYXR0ZXJuKTsKICAgIGlmICghcmVnZXgudGVzdChkb2MpKSByZXR1cm4gZmFsc2U7CiAgfQogIGlmIChzY2hlbWEuZW51bSAmJiBpc0FycmF5KHNjaGVtYS5lbnVtKSkgewogICAgaWYgKCFzY2hlbWEuZW51bS5pbmNsdWRlcyhkb2MpKSByZXR1cm4gZmFsc2U7CiAgfQogIHJldHVybiB0cnVlOwp9CmZ1bmN0aW9uIHZhbHVlc0VxdWFsKGEsIGIpIHsKICBpZiAoYSBpbnN0YW5jZW9mIE9iamVjdElkICYmIGIgaW5zdGFuY2VvZiBPYmplY3RJZCkgewogICAgcmV0dXJuIGEuZXF1YWxzKGIpOwogIH0KICByZXR1cm4gYSA9PSBiOwp9CmZ1bmN0aW9uIGNvbXBhcmVWYWx1ZXMoYSwgYiwgb3BlcmF0b3IpIHsKICBsZXQgYVZhbCA9IGE7CiAgbGV0IGJWYWwgPSBiOwogIGlmIChhIGluc3RhbmNlb2YgT2JqZWN0SWQpIHsKICAgIGFWYWwgPSBhLnRvU3RyaW5nKCk7CiAgfQogIGlmIChiIGluc3RhbmNlb2YgT2JqZWN0SWQpIHsKICAgIGJWYWwgPSBiLnRvU3RyaW5nKCk7CiAgfQogIHN3aXRjaCAob3BlcmF0b3IpIHsKICAgIGNhc2UgIj4iOgogICAgICByZXR1cm4gYVZhbCA+IGJWYWw7CiAgICBjYXNlICI+PSI6CiAgICAgIHJldHVybiBhVmFsID49IGJWYWw7CiAgICBjYXNlICI8IjoKICAgICAgcmV0dXJuIGFWYWwgPCBiVmFsOwogICAgY2FzZSAiPD0iOgogICAgICByZXR1cm4gYVZhbCA8PSBiVmFsOwogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuIGZhbHNlOwogIH0KfQpmdW5jdGlvbiBmaWVsZFZhbHVlTWF0Y2hlcyhmaWVsZFZhbHVlLCBjaGVja0ZuKSB7CiAgaWYgKGZpZWxkVmFsdWUgPT09IHZvaWQgMCkgcmV0dXJuIGZhbHNlOwogIGlmIChmaWVsZFZhbHVlID09PSBudWxsKSByZXR1cm4gY2hlY2tGbihmaWVsZFZhbHVlKTsKICBpZiAoaXNBcnJheShmaWVsZFZhbHVlKSkgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmaWVsZFZhbHVlLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChjaGVja0ZuKGZpZWxkVmFsdWVbaV0pKSByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CiAgcmV0dXJuIGNoZWNrRm4oZmllbGRWYWx1ZSk7Cn0KZnVuY3Rpb24gdG9rZW5pemVUZXh0KHRleHQyKSB7CiAgaWYgKHR5cGVvZiB0ZXh0MiAhPT0gInN0cmluZyIpIHJldHVybiBbXTsKICBjb25zdCB3b3JkcyA9IHRva2VuaXplKHRleHQyKTsKICByZXR1cm4gd29yZHMubWFwKCh3KSA9PiBzdGVtbWVyKHcpKTsKfQpmdW5jdGlvbiB0ZXh0KHByb3AsIHF1ZXJ5VGV4dCkgewogIGlmICh0eXBlb2YgcHJvcCAhPT0gInN0cmluZyIpIHJldHVybiBmYWxzZTsKICBjb25zdCBwcm9wVG9rZW5zID0gbmV3IFNldCh0b2tlbml6ZVRleHQocHJvcCkpOwogIGNvbnN0IHF1ZXJ5VG9rZW5zID0gdG9rZW5pemVUZXh0KHF1ZXJ5VGV4dCk7CiAgcmV0dXJuIHF1ZXJ5VG9rZW5zLnNvbWUoKHRlcm0pID0+IHByb3BUb2tlbnMuaGFzKHRlcm0pKTsKfQpmdW5jdGlvbiB0ZXh0U2VhcmNoRG9jdW1lbnQoZG9jLCBzZWFyY2hUZXh0KSB7CiAgaWYgKCFkb2MgfHwgdHlwZW9mIGRvYyAhPT0gIm9iamVjdCIpIHJldHVybiBmYWxzZTsKICBmdW5jdGlvbiBzZWFyY2hPYmplY3Qob2JqKSB7CiAgICBpZiAodHlwZW9mIG9iaiA9PT0gInN0cmluZyIpIHsKICAgICAgcmV0dXJuIHRleHQob2JqLCBzZWFyY2hUZXh0KTsKICAgIH0KICAgIGlmICh0eXBlb2Ygb2JqICE9PSAib2JqZWN0IiB8fCBvYmogPT09IG51bGwpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgaWYgKGlzQXJyYXkob2JqKSkgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG9iai5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChzZWFyY2hPYmplY3Qob2JqW2ldKSkgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgZm9yIChjb25zdCBrZXkgaW4gb2JqKSB7CiAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgIGlmIChzZWFyY2hPYmplY3Qob2JqW2tleV0pKSByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KICByZXR1cm4gc2VhcmNoT2JqZWN0KGRvYyk7Cn0KZnVuY3Rpb24gZ2VvV2l0aGluKHByb3AsIHF1ZXJ5KSB7CiAgdHJ5IHsKICAgIGlmICghQXJyYXkuaXNBcnJheShxdWVyeSkgfHwgcXVlcnkubGVuZ3RoICE9PSAyKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGNvbnN0IG1pbkxvbiA9IHF1ZXJ5WzBdWzBdOwogICAgY29uc3QgbWF4TGF0ID0gcXVlcnlbMF1bMV07CiAgICBjb25zdCBtYXhMb24gPSBxdWVyeVsxXVswXTsKICAgIGNvbnN0IG1pbkxhdCA9IHF1ZXJ5WzFdWzFdOwogICAgcmV0dXJuIGlzR2VvbWV0cnlXaXRoaW5CQm94KHByb3AsIG1pbkxvbiwgbWF4TG9uLCBtaW5MYXQsIG1heExhdCk7CiAgfSBjYXRjaCAoZSkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KfQpmdW5jdGlvbiBpc0dlb21ldHJ5V2l0aGluQkJveChnZW9Kc29uLCBtaW5Mb24sIG1heExvbiwgbWluTGF0LCBtYXhMYXQpIHsKICBpZiAoIWdlb0pzb24pIHJldHVybiBmYWxzZTsKICBpZiAoZ2VvSnNvbi50eXBlID09PSAiRmVhdHVyZUNvbGxlY3Rpb24iICYmIGdlb0pzb24uZmVhdHVyZXMgJiYgZ2VvSnNvbi5mZWF0dXJlcy5sZW5ndGggPiAwKSB7CiAgICBmb3IgKGNvbnN0IGZlYXR1cmUgb2YgZ2VvSnNvbi5mZWF0dXJlcykgewogICAgICBpZiAoZmVhdHVyZS5nZW9tZXRyeSkgewogICAgICAgIGlmICghaXNHZW9tZXRyeVdpdGhpbkJCb3goZmVhdHVyZS5nZW9tZXRyeSwgbWluTG9uLCBtYXhMb24sIG1pbkxhdCwgbWF4TGF0KSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQogIGlmIChnZW9Kc29uLnR5cGUgPT09ICJGZWF0dXJlIiAmJiBnZW9Kc29uLmdlb21ldHJ5KSB7CiAgICByZXR1cm4gaXNHZW9tZXRyeVdpdGhpbkJCb3goZ2VvSnNvbi5nZW9tZXRyeSwgbWluTG9uLCBtYXhMb24sIG1pbkxhdCwgbWF4TGF0KTsKICB9CiAgaWYgKGdlb0pzb24udHlwZSA9PT0gIlBvaW50IiAmJiBnZW9Kc29uLmNvb3JkaW5hdGVzKSB7CiAgICBjb25zdCBbbG5nLCBsYXRdID0gZ2VvSnNvbi5jb29yZGluYXRlczsKICAgIGlmICh0eXBlb2YgbG5nID09PSAibnVtYmVyIiAmJiB0eXBlb2YgbGF0ID09PSAibnVtYmVyIikgewogICAgICByZXR1cm4gbG5nID49IG1pbkxvbiAmJiBsbmcgPD0gbWF4TG9uICYmIGxhdCA+PSBtaW5MYXQgJiYgbGF0IDw9IG1heExhdDsKICAgIH0KICB9CiAgaWYgKGdlb0pzb24udHlwZSA9PT0gIlBvbHlnb24iICYmIGdlb0pzb24uY29vcmRpbmF0ZXMgJiYgZ2VvSnNvbi5jb29yZGluYXRlcy5sZW5ndGggPiAwKSB7CiAgICBmb3IgKGNvbnN0IHJpbmcgb2YgZ2VvSnNvbi5jb29yZGluYXRlcykgewogICAgICBmb3IgKGNvbnN0IGNvb3JkIG9mIHJpbmcpIHsKICAgICAgICBjb25zdCBsbmcgPSBjb29yZFswXTsKICAgICAgICBjb25zdCBsYXQgPSBjb29yZFsxXTsKICAgICAgICBpZiAobG5nIDwgbWluTG9uIHx8IGxuZyA+IG1heExvbiB8fCBsYXQgPCBtaW5MYXQgfHwgbGF0ID4gbWF4TGF0KSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgcmV0dXJuIGZhbHNlOwp9CmZ1bmN0aW9uIGV4dHJhY3RDb29yZGluYXRlc0Zyb21HZW9KU09OKGdlb0pzb24pIHsKICBpZiAoIWdlb0pzb24pIHJldHVybiBudWxsOwogIGlmIChnZW9Kc29uLnR5cGUgPT09ICJGZWF0dXJlQ29sbGVjdGlvbiIgJiYgZ2VvSnNvbi5mZWF0dXJlcyAmJiBnZW9Kc29uLmZlYXR1cmVzLmxlbmd0aCA+IDApIHsKICAgIGNvbnN0IGZlYXR1cmUgPSBnZW9Kc29uLmZlYXR1cmVzWzBdOwogICAgaWYgKGZlYXR1cmUuZ2VvbWV0cnkpIHsKICAgICAgcmV0dXJuIGV4dHJhY3RDb29yZGluYXRlc0Zyb21HZW9KU09OKGZlYXR1cmUuZ2VvbWV0cnkpOwogICAgfQogIH0KICBpZiAoZ2VvSnNvbi50eXBlID09PSAiRmVhdHVyZSIgJiYgZ2VvSnNvbi5nZW9tZXRyeSkgewogICAgcmV0dXJuIGV4dHJhY3RDb29yZGluYXRlc0Zyb21HZW9KU09OKGdlb0pzb24uZ2VvbWV0cnkpOwogIH0KICBpZiAoZ2VvSnNvbi50eXBlID09PSAiUG9pbnQiICYmIGdlb0pzb24uY29vcmRpbmF0ZXMpIHsKICAgIGNvbnN0IFtsbmcsIGxhdF0gPSBnZW9Kc29uLmNvb3JkaW5hdGVzOwogICAgaWYgKHR5cGVvZiBsbmcgPT09ICJudW1iZXIiICYmIHR5cGVvZiBsYXQgPT09ICJudW1iZXIiKSB7CiAgICAgIHJldHVybiB7IGxhdCwgbG5nIH07CiAgICB9CiAgfQogIGlmIChnZW9Kc29uLnR5cGUgPT09ICJQb2x5Z29uIiAmJiBnZW9Kc29uLmNvb3JkaW5hdGVzICYmIGdlb0pzb24uY29vcmRpbmF0ZXMubGVuZ3RoID4gMCkgewogICAgY29uc3QgcmluZyA9IGdlb0pzb24uY29vcmRpbmF0ZXNbMF07CiAgICBpZiAocmluZy5sZW5ndGggPiAwKSB7CiAgICAgIGxldCBzdW1MYXQgPSAwLCBzdW1MbmcgPSAwOwogICAgICBmb3IgKGNvbnN0IGNvb3JkIG9mIHJpbmcpIHsKICAgICAgICBzdW1MbmcgKz0gY29vcmRbMF07CiAgICAgICAgc3VtTGF0ICs9IGNvb3JkWzFdOwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgbGF0OiBzdW1MYXQgLyByaW5nLmxlbmd0aCwKICAgICAgICBsbmc6IHN1bUxuZyAvIHJpbmcubGVuZ3RoCiAgICAgIH07CiAgICB9CiAgfQogIHJldHVybiBudWxsOwp9CmZ1bmN0aW9uIGhhdmVyc2luZURpc3RhbmNlJDEobGF0MSwgbG5nMSwgbGF0MiwgbG5nMikgewogIGNvbnN0IFIgPSA2MzcxOwogIGNvbnN0IGRMYXQgPSAobGF0MiAtIGxhdDEpICogTWF0aC5QSSAvIDE4MDsKICBjb25zdCBkTG5nID0gKGxuZzIgLSBsbmcxKSAqIE1hdGguUEkgLyAxODA7CiAgY29uc3QgYSA9IE1hdGguc2luKGRMYXQgLyAyKSAqIE1hdGguc2luKGRMYXQgLyAyKSArIE1hdGguY29zKGxhdDEgKiBNYXRoLlBJIC8gMTgwKSAqIE1hdGguY29zKGxhdDIgKiBNYXRoLlBJIC8gMTgwKSAqIE1hdGguc2luKGRMbmcgLyAyKSAqIE1hdGguc2luKGRMbmcgLyAyKTsKICBjb25zdCBjID0gMiAqIE1hdGguYXRhbjIoTWF0aC5zcXJ0KGEpLCBNYXRoLnNxcnQoMSAtIGEpKTsKICByZXR1cm4gUiAqIGM7Cn0KZnVuY3Rpb24gaXNOZWFyKGdlb0pzb24sIHJlZkxuZywgcmVmTGF0LCBtYXhEaXN0YW5jZU1ldGVycykgewogIGNvbnN0IGNvb3JkcyA9IGV4dHJhY3RDb29yZGluYXRlc0Zyb21HZW9KU09OKGdlb0pzb24pOwogIGlmICghY29vcmRzKSByZXR1cm4gZmFsc2U7CiAgY29uc3QgZGlzdGFuY2VLbSA9IGhhdmVyc2luZURpc3RhbmNlJDEoY29vcmRzLmxhdCwgY29vcmRzLmxuZywgcmVmTGF0LCByZWZMbmcpOwogIGNvbnN0IGRpc3RhbmNlTSA9IGRpc3RhbmNlS20gKiAxZTM7CiAgcmV0dXJuIGRpc3RhbmNlTSA8PSBtYXhEaXN0YW5jZU1ldGVyczsKfQpmdW5jdGlvbiBnZW9JbnRlcnNlY3RzKGdlb0pzb24sIHF1ZXJ5R2VvKSB7CiAgaWYgKCFnZW9Kc29uIHx8ICFxdWVyeUdlbykgcmV0dXJuIGZhbHNlOwogIGNvbnN0IHF1ZXJ5Q29vcmRzID0gZXh0cmFjdENvb3JkaW5hdGVzRnJvbUdlb0pTT04ocXVlcnlHZW8pOwogIGlmICghcXVlcnlDb29yZHMpIHJldHVybiBmYWxzZTsKICBjb25zdCBkb2NDb29yZHMgPSBleHRyYWN0Q29vcmRpbmF0ZXNGcm9tR2VvSlNPTihnZW9Kc29uKTsKICBpZiAoIWRvY0Nvb3JkcykgcmV0dXJuIGZhbHNlOwogIGlmIChxdWVyeUdlby50eXBlID09PSAiUG9seWdvbiIgJiYgZ2VvSnNvbi50eXBlID09PSAiUG9pbnQiKSB7CiAgICByZXR1cm4gcG9pbnRJblBvbHlnb24oZG9jQ29vcmRzLmxuZywgZG9jQ29vcmRzLmxhdCwgcXVlcnlHZW8uY29vcmRpbmF0ZXNbMF0pOwogIH0KICBpZiAoZ2VvSnNvbi50eXBlID09PSAiUG9seWdvbiIgJiYgcXVlcnlHZW8udHlwZSA9PT0gIlBvaW50IikgewogICAgY29uc3QgcXVlcnlQdCA9IHF1ZXJ5R2VvLmNvb3JkaW5hdGVzOwogICAgcmV0dXJuIHBvaW50SW5Qb2x5Z29uKHF1ZXJ5UHRbMF0sIHF1ZXJ5UHRbMV0sIGdlb0pzb24uY29vcmRpbmF0ZXNbMF0pOwogIH0KICBpZiAoZ2VvSnNvbi50eXBlID09PSAiUG9pbnQiICYmIHF1ZXJ5R2VvLnR5cGUgPT09ICJQb2ludCIpIHsKICAgIGNvbnN0IGRpc3QgPSBoYXZlcnNpbmVEaXN0YW5jZSQxKGRvY0Nvb3Jkcy5sYXQsIGRvY0Nvb3Jkcy5sbmcsIHF1ZXJ5Q29vcmRzLmxhdCwgcXVlcnlDb29yZHMubG5nKTsKICAgIHJldHVybiBkaXN0IDwgMWUtMzsKICB9CiAgcmV0dXJuIGZhbHNlOwp9CmZ1bmN0aW9uIHBvaW50SW5Qb2x5Z29uKGxuZywgbGF0LCByaW5nKSB7CiAgbGV0IGluc2lkZSA9IGZhbHNlOwogIGZvciAobGV0IGkgPSAwLCBqID0gcmluZy5sZW5ndGggLSAxOyBpIDwgcmluZy5sZW5ndGg7IGogPSBpKyspIHsKICAgIGNvbnN0IHhpID0gcmluZ1tpXVswXSwgeWkgPSByaW5nW2ldWzFdOwogICAgY29uc3QgeGogPSByaW5nW2pdWzBdLCB5aiA9IHJpbmdbal1bMV07CiAgICBjb25zdCBpbnRlcnNlY3QgPSB5aSA+IGxhdCAhPT0geWogPiBsYXQgJiYgbG5nIDwgKHhqIC0geGkpICogKGxhdCAtIHlpKSAvICh5aiAtIHlpKSArIHhpOwogICAgaWYgKGludGVyc2VjdCkgaW5zaWRlID0gIWluc2lkZTsKICB9CiAgcmV0dXJuIGluc2lkZTsKfQpmdW5jdGlvbiB3aGVyZShkb2MsIHZhbHVlKSB7CiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gImZ1bmN0aW9uIikgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIHZhbHVlLmNhbGwoZG9jKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAic3RyaW5nIikgewogICAgdHJ5IHsKICAgICAgdmFyIGZuID0gbmV3IEZ1bmN0aW9uKCJyZXR1cm4gIiArIHZhbHVlKTsKICAgICAgcmV0dXJuIGZuLmNhbGwoZG9jKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0KICByZXR1cm4gZmFsc2U7Cn0KZnVuY3Rpb24gdGxNYXRjaGVzKGRvYywgcXVlcnkpIHsKICB2YXIga2V5ID0gT2JqZWN0LmtleXMocXVlcnkpWzBdOwogIHZhciB2YWx1ZSA9IHF1ZXJ5W2tleV07CiAgaWYgKGtleS5jaGFyQXQoMCkgPT0gIiQiKSB7CiAgICBpZiAoa2V5ID09ICIkYW5kIikgcmV0dXJuIGFuZChkb2MsIHZhbHVlKTsKICAgIGVsc2UgaWYgKGtleSA9PSAiJG9yIikgcmV0dXJuIG9yKGRvYywgdmFsdWUpOwogICAgZWxzZSBpZiAoa2V5ID09ICIkbm90IikgcmV0dXJuIG5vdChkb2MsIHZhbHVlKTsKICAgIGVsc2UgaWYgKGtleSA9PSAiJG5vciIpIHJldHVybiBub3IoZG9jLCB2YWx1ZSk7CiAgICBlbHNlIGlmIChrZXkgPT0gIiR3aGVyZSIpIHJldHVybiB3aGVyZShkb2MsIHZhbHVlKTsKICAgIGVsc2UgaWYgKGtleSA9PSAiJGNvbW1lbnQiKSByZXR1cm4gdHJ1ZTsKICAgIGVsc2UgaWYgKGtleSA9PSAiJGpzb25TY2hlbWEiKSByZXR1cm4gdmFsaWRhdGVKc29uU2NoZW1hKGRvYywgdmFsdWUpOwogICAgZWxzZSBpZiAoa2V5ID09ICIkdGV4dCIpIHsKICAgICAgY29uc3Qgc2VhcmNoVGV4dCA9IHZhbHVlLiRzZWFyY2ggfHwgdmFsdWU7CiAgICAgIHJldHVybiB0ZXh0U2VhcmNoRG9jdW1lbnQoZG9jLCBzZWFyY2hUZXh0KTsKICAgIH0gZWxzZSBpZiAoa2V5ID09ICIkZXhwciIpIHsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gZXZhbHVhdGVFeHByZXNzaW9uKHZhbHVlLCBkb2MpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9IGVsc2UgdGhyb3cgeyAkZXJyOiAiQ2FuJ3QgY2Fub25pY2FsaXplIHF1ZXJ5OiBCYWRWYWx1ZSB1bmtub3duIHRvcCBsZXZlbCBvcGVyYXRvcjogIiArIGtleSwgY29kZTogMTcyODcgfTsKICB9IGVsc2UgewogICAgcmV0dXJuIG9wTWF0Y2hlcyhkb2MsIGtleSwgdmFsdWUpOwogIH0KfQpmdW5jdGlvbiBvcE1hdGNoZXMoZG9jLCBrZXksIHZhbHVlKSB7CiAgdmFyIGZpZWxkVmFsdWUgPSBnZXRGaWVsZFZhbHVlcyhkb2MsIGtleSk7CiAgaWYgKHR5cGVvZiB2YWx1ZSA9PSAic3RyaW5nIikgcmV0dXJuIGZpZWxkVmFsdWVNYXRjaGVzKGZpZWxkVmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgIHJldHVybiB2YWx1ZXNFcXVhbCh2LCB2YWx1ZSk7CiAgfSk7CiAgZWxzZSBpZiAodHlwZW9mIHZhbHVlID09ICJudW1iZXIiKSByZXR1cm4gZmllbGRWYWx1ZU1hdGNoZXMoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgcmV0dXJuIHZhbHVlc0VxdWFsKHYsIHZhbHVlKTsKICB9KTsKICBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT0gImJvb2xlYW4iKSByZXR1cm4gZmllbGRWYWx1ZU1hdGNoZXMoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgcmV0dXJuIHZhbHVlc0VxdWFsKHYsIHZhbHVlKTsKICB9KTsKICBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIE9iamVjdElkKSByZXR1cm4gZmllbGRWYWx1ZU1hdGNoZXMoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgcmV0dXJuIHZhbHVlc0VxdWFsKHYsIHZhbHVlKTsKICB9KTsKICBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT0gIm9iamVjdCIpIHsKICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFJlZ0V4cCkgcmV0dXJuIGZpZWxkVmFsdWUgIT0gdm9pZCAwICYmIGZpZWxkVmFsdWVNYXRjaGVzKGZpZWxkVmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgICAgcmV0dXJuIHYgJiYgdi5tYXRjaCh2YWx1ZSk7CiAgICB9KTsKICAgIGVsc2UgaWYgKGlzQXJyYXkodmFsdWUpKSByZXR1cm4gZmllbGRWYWx1ZSAhPSB2b2lkIDAgJiYgZmllbGRWYWx1ZU1hdGNoZXMoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgICByZXR1cm4gdiAmJiBhcnJheU1hdGNoZXModiwgdmFsdWUpOwogICAgfSk7CiAgICBlbHNlIHsKICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyh2YWx1ZSk7CiAgICAgIGlmIChrZXlzWzBdLmNoYXJBdCgwKSA9PSAiJCIpIHsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBvcGVyYXRvciA9IE9iamVjdC5rZXlzKHZhbHVlKVtpXTsKICAgICAgICAgIHZhciBvcGVyYW5kID0gdmFsdWVbb3BlcmF0b3JdOwogICAgICAgICAgaWYgKG9wZXJhdG9yID09ICIkZXEiKSB7CiAgICAgICAgICAgIGlmICghZmllbGRWYWx1ZU1hdGNoZXMoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgIHJldHVybiB2YWx1ZXNFcXVhbCh2LCBvcGVyYW5kKTsKICAgICAgICAgICAgfSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSBpZiAob3BlcmF0b3IgPT0gIiRndCIpIHsKICAgICAgICAgICAgaWYgKCFmaWVsZFZhbHVlTWF0Y2hlcyhmaWVsZFZhbHVlLCBmdW5jdGlvbih2KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNvbXBhcmVWYWx1ZXModiwgb3BlcmFuZCwgIj4iKTsKICAgICAgICAgICAgfSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSBpZiAob3BlcmF0b3IgPT0gIiRndGUiKSB7CiAgICAgICAgICAgIGlmICghZmllbGRWYWx1ZU1hdGNoZXMoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgIHJldHVybiBjb21wYXJlVmFsdWVzKHYsIG9wZXJhbmQsICI+PSIpOwogICAgICAgICAgICB9KSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJGx0IikgewogICAgICAgICAgICBpZiAoIWZpZWxkVmFsdWVNYXRjaGVzKGZpZWxkVmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgICByZXR1cm4gY29tcGFyZVZhbHVlcyh2LCBvcGVyYW5kLCAiPCIpOwogICAgICAgICAgICB9KSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJGx0ZSIpIHsKICAgICAgICAgICAgaWYgKCFmaWVsZFZhbHVlTWF0Y2hlcyhmaWVsZFZhbHVlLCBmdW5jdGlvbih2KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNvbXBhcmVWYWx1ZXModiwgb3BlcmFuZCwgIjw9Iik7CiAgICAgICAgICAgIH0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgaWYgKG9wZXJhdG9yID09ICIkbmUiKSB7CiAgICAgICAgICAgIGlmICghZmllbGRWYWx1ZU1hdGNoZXMoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgIHJldHVybiAhdmFsdWVzRXF1YWwodiwgb3BlcmFuZCk7CiAgICAgICAgICAgIH0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgaWYgKG9wZXJhdG9yID09ICIkaW4iKSB7CiAgICAgICAgICAgIGlmICghZmllbGRWYWx1ZU1hdGNoZXMoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgIHJldHVybiBpc0luKHYsIG9wZXJhbmQpOwogICAgICAgICAgICB9KSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJG5pbiIpIHsKICAgICAgICAgICAgaWYgKGZpZWxkVmFsdWVNYXRjaGVzKGZpZWxkVmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgICByZXR1cm4gaXNJbih2LCBvcGVyYW5kKTsKICAgICAgICAgICAgfSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSBpZiAob3BlcmF0b3IgPT0gIiRleGlzdHMiKSB7CiAgICAgICAgICAgIHZhciByYXdWYWx1ZSA9IGdldFByb3AoZG9jLCBrZXkpOwogICAgICAgICAgICBpZiAob3BlcmFuZCA/IHJhd1ZhbHVlID09IHZvaWQgMCA6IHJhd1ZhbHVlICE9IHZvaWQgMCkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJHR5cGUiKSB7CiAgICAgICAgICAgIGlmIChmaWVsZFZhbHVlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICBjb25zdCBleHBlY3RlZFR5cGVDb2RlID0gdHlwZW9mIG9wZXJhbmQgPT09ICJudW1iZXIiID8gb3BlcmFuZCA6IFRZUEVfQUxJQVNFU1tvcGVyYW5kXTsKICAgICAgICAgICAgICBpZiAoZXhwZWN0ZWRUeXBlQ29kZSAhPT0gNikgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmICghbWF0Y2hlc1R5cGUoZmllbGRWYWx1ZSwgb3BlcmFuZCkpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJG1vZCIpIHsKICAgICAgICAgICAgaWYgKG9wZXJhbmQubGVuZ3RoICE9IDIpIHRocm93IHsgJGVycjogIkNhbid0IGNhbm9uaWNhbGl6ZSBxdWVyeTogQmFkVmFsdWUgbWFsZm9ybWVkIG1vZCwgbm90IGVub3VnaCBlbGVtZW50cyIsIGNvZGU6IDE3Mjg3IH07CiAgICAgICAgICAgIGlmICghZmllbGRWYWx1ZU1hdGNoZXMoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgIHJldHVybiB2ICE9IHZvaWQgMCAmJiB2ICUgb3BlcmFuZFswXSA9PSBvcGVyYW5kWzFdOwogICAgICAgICAgICB9KSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJHJlZ2V4IikgewogICAgICAgICAgICB2YXIgcGF0dGVybiA9IG9wZXJhbmQ7CiAgICAgICAgICAgIHZhciBmbGFncyA9IHZhbHVlLiRvcHRpb25zIHx8ICIiOwogICAgICAgICAgICB2YXIgcmVnZXggPSB0eXBlb2YgcGF0dGVybiA9PT0gInN0cmluZyIgPyBuZXcgUmVnRXhwKHBhdHRlcm4sIGZsYWdzKSA6IHBhdHRlcm47CiAgICAgICAgICAgIGlmICghZmllbGRWYWx1ZU1hdGNoZXMoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgIHJldHVybiB2ICE9IHZvaWQgMCAmJiByZWdleC50ZXN0KHYpOwogICAgICAgICAgICB9KSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJG9wdGlvbnMiKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJHRleHQiKSB7CiAgICAgICAgICAgIGlmICghZmllbGRWYWx1ZU1hdGNoZXMoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgIHJldHVybiB2ICE9IHZvaWQgMCAmJiB0ZXh0KHYsIG9wZXJhbmQpOwogICAgICAgICAgICB9KSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJGV4cHIiKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgICAgICAgICAgICAgaWYgKCFyZXN1bHQpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJGdlb1dpdGhpbiIpIHsKICAgICAgICAgICAgaWYgKCFmaWVsZFZhbHVlTWF0Y2hlcyhmaWVsZFZhbHVlLCBmdW5jdGlvbih2KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHYgIT0gdm9pZCAwICYmIGdlb1dpdGhpbih2LCBvcGVyYW5kKTsKICAgICAgICAgICAgfSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSBpZiAob3BlcmF0b3IgPT0gIiRuZWFyIiB8fCBvcGVyYXRvciA9PSAiJG5lYXJTcGhlcmUiKSB7CiAgICAgICAgICAgIGxldCBjb29yZGluYXRlczsKICAgICAgICAgICAgaWYgKG9wZXJhbmQuJGdlb21ldHJ5KSB7CiAgICAgICAgICAgICAgY29vcmRpbmF0ZXMgPSBvcGVyYW5kLiRnZW9tZXRyeS5jb29yZGluYXRlczsKICAgICAgICAgICAgfSBlbHNlIGlmIChvcGVyYW5kLmNvb3JkaW5hdGVzKSB7CiAgICAgICAgICAgICAgY29vcmRpbmF0ZXMgPSBvcGVyYW5kLmNvb3JkaW5hdGVzOwogICAgICAgICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkob3BlcmFuZCkpIHsKICAgICAgICAgICAgICBjb29yZGluYXRlcyA9IG9wZXJhbmQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNvb3JkaW5hdGVzICYmIGNvb3JkaW5hdGVzLmxlbmd0aCA+PSAyKSB7CiAgICAgICAgICAgICAgY29uc3QgW2xuZywgbGF0XSA9IGNvb3JkaW5hdGVzOwogICAgICAgICAgICAgIGNvbnN0IG1heERpc3RhbmNlTWV0ZXJzID0gb3BlcmFuZC4kbWF4RGlzdGFuY2UgfHwgMWU2OwogICAgICAgICAgICAgIGlmICghZmllbGRWYWx1ZU1hdGNoZXMoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgICAgcmV0dXJuIHYgIT0gdm9pZCAwICYmIGlzTmVhcih2LCBsbmcsIGxhdCwgbWF4RGlzdGFuY2VNZXRlcnMpOwogICAgICAgICAgICAgIH0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKG9wZXJhdG9yID09ICIkZ2VvSW50ZXJzZWN0cyIpIHsKICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBvcGVyYW5kLiRnZW9tZXRyeSB8fCBvcGVyYW5kOwogICAgICAgICAgICBpZiAoIWZpZWxkVmFsdWVNYXRjaGVzKGZpZWxkVmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgICByZXR1cm4gdiAhPSB2b2lkIDAgJiYgZ2VvSW50ZXJzZWN0cyh2LCBnZW9tZXRyeSk7CiAgICAgICAgICAgIH0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgaWYgKG9wZXJhdG9yID09ICIkbm90IikgewogICAgICAgICAgICBpZiAob3BNYXRjaGVzKGRvYywga2V5LCBvcGVyYW5kKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJGFsbCIpIHsKICAgICAgICAgICAgdmFyIGFycmF5RmllbGRWYWx1ZSA9IGdldFByb3AoZG9jLCBrZXkpOwogICAgICAgICAgICBpZiAoYXJyYXlGaWVsZFZhbHVlID09IHZvaWQgMCB8fCAhaXNBcnJheShhcnJheUZpZWxkVmFsdWUpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgb3BlcmFuZC5sZW5ndGg7IGorKykgewogICAgICAgICAgICAgIGlmICghaXNJbihvcGVyYW5kW2pdLCBhcnJheUZpZWxkVmFsdWUpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAob3BlcmF0b3IgPT0gIiRlbGVtTWF0Y2giKSB7CiAgICAgICAgICAgIHZhciBhcnJheUZpZWxkVmFsdWUgPSBnZXRQcm9wKGRvYywga2V5KTsKICAgICAgICAgICAgaWYgKGFycmF5RmllbGRWYWx1ZSA9PSB2b2lkIDAgfHwgIWlzQXJyYXkoYXJyYXlGaWVsZFZhbHVlKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB2YXIgZm91bmQgPSBmYWxzZTsKICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBhcnJheUZpZWxkVmFsdWUubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICB2YXIgZWxlbWVudCA9IGFycmF5RmllbGRWYWx1ZVtqXTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGVsZW1lbnQgPT09ICJvYmplY3QiICYmICFpc0FycmF5KGVsZW1lbnQpKSB7CiAgICAgICAgICAgICAgICBpZiAobWF0Y2hlcyhlbGVtZW50LCBvcGVyYW5kKSkgewogICAgICAgICAgICAgICAgICBmb3VuZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2hlc1ByaW1pdGl2ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB2YXIgb3BLZXlzID0gT2JqZWN0LmtleXMob3BlcmFuZCk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBrID0gMDsgayA8IG9wS2V5cy5sZW5ndGg7IGsrKykgewogICAgICAgICAgICAgICAgICB2YXIgb3AgPSBvcEtleXNba107CiAgICAgICAgICAgICAgICAgIHZhciBvcFZhbHVlID0gb3BlcmFuZFtvcF07CiAgICAgICAgICAgICAgICAgIGlmIChvcCA9PSAiJGd0ZSIgJiYgIShlbGVtZW50ID49IG9wVmFsdWUpKSBtYXRjaGVzUHJpbWl0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG9wID09ICIkZ3QiICYmICEoZWxlbWVudCA+IG9wVmFsdWUpKSBtYXRjaGVzUHJpbWl0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG9wID09ICIkbHRlIiAmJiAhKGVsZW1lbnQgPD0gb3BWYWx1ZSkpIG1hdGNoZXNQcmltaXRpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgZWxzZSBpZiAob3AgPT0gIiRsdCIgJiYgIShlbGVtZW50IDwgb3BWYWx1ZSkpIG1hdGNoZXNQcmltaXRpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgZWxzZSBpZiAob3AgPT0gIiRlcSIgJiYgIShlbGVtZW50ID09IG9wVmFsdWUpKSBtYXRjaGVzUHJpbWl0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG9wID09ICIkbmUiICYmICEoZWxlbWVudCAhPSBvcFZhbHVlKSkgbWF0Y2hlc1ByaW1pdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICBlbHNlIGlmIChvcCA9PSAiJGluIiAmJiAhaXNJbihlbGVtZW50LCBvcFZhbHVlKSkgbWF0Y2hlc1ByaW1pdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICBlbHNlIGlmIChvcCA9PSAiJG5pbiIgJiYgaXNJbihlbGVtZW50LCBvcFZhbHVlKSkgbWF0Y2hlc1ByaW1pdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG1hdGNoZXNQcmltaXRpdmUpIHsKICAgICAgICAgICAgICAgICAgZm91bmQgPSB0cnVlOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFmb3VuZCkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJHNpemUiKSB7CiAgICAgICAgICAgIHZhciBzaXplRmllbGRWYWx1ZSA9IGdldFByb3AoZG9jLCBrZXkpOwogICAgICAgICAgICBpZiAoc2l6ZUZpZWxkVmFsdWUgPT0gdm9pZCAwIHx8ICFpc0FycmF5KHNpemVGaWVsZFZhbHVlKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBpZiAoc2l6ZUZpZWxkVmFsdWUubGVuZ3RoICE9IG9wZXJhbmQpIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSBpZiAob3BlcmF0b3IgPT0gIiRiaXRzQWxsU2V0IikgewogICAgICAgICAgICBpZiAoIWZpZWxkVmFsdWVNYXRjaGVzKGZpZWxkVmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgICByZXR1cm4gbWF0Y2hlc0JpdHNBbGxTZXQodiwgb3BlcmFuZCk7CiAgICAgICAgICAgIH0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgaWYgKG9wZXJhdG9yID09ICIkYml0c0FsbENsZWFyIikgewogICAgICAgICAgICBpZiAoIWZpZWxkVmFsdWVNYXRjaGVzKGZpZWxkVmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgICByZXR1cm4gbWF0Y2hlc0JpdHNBbGxDbGVhcih2LCBvcGVyYW5kKTsKICAgICAgICAgICAgfSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSBpZiAob3BlcmF0b3IgPT0gIiRiaXRzQW55U2V0IikgewogICAgICAgICAgICBpZiAoIWZpZWxkVmFsdWVNYXRjaGVzKGZpZWxkVmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgICByZXR1cm4gbWF0Y2hlc0JpdHNBbnlTZXQodiwgb3BlcmFuZCk7CiAgICAgICAgICAgIH0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgaWYgKG9wZXJhdG9yID09ICIkYml0c0FueUNsZWFyIikgewogICAgICAgICAgICBpZiAoIWZpZWxkVmFsdWVNYXRjaGVzKGZpZWxkVmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgICByZXR1cm4gbWF0Y2hlc0JpdHNBbnlDbGVhcih2LCBvcGVyYW5kKTsKICAgICAgICAgICAgfSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IHsgJGVycjogIkNhbid0IGNhbm9uaWNhbGl6ZSBxdWVyeTogQmFkVmFsdWUgdW5rbm93biBvcGVyYXRvcjogIiArIG9wZXJhdG9yLCBjb2RlOiAxNzI4NyB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZ2V0UHJvcChkb2MsIGtleSkgJiYgb2JqZWN0TWF0Y2hlcyhnZXRQcm9wKGRvYywga2V5KSwgdmFsdWUpOwogICAgICB9CiAgICB9CiAgfQp9CmZ1bmN0aW9uIG5vdChkb2MsIHZhbHVlKSB7CiAgcmV0dXJuICF0bE1hdGNoZXMoZG9jLCB2YWx1ZSk7Cn0KZnVuY3Rpb24gYW5kKGRvYywgZWxzKSB7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbHMubGVuZ3RoOyBpKyspIHsKICAgIGlmICghdGxNYXRjaGVzKGRvYywgZWxzW2ldKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQogIHJldHVybiB0cnVlOwp9CmZ1bmN0aW9uIG9yKGRvYywgZWxzKSB7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbHMubGVuZ3RoOyBpKyspIHsKICAgIGlmICh0bE1hdGNoZXMoZG9jLCBlbHNbaV0pKSByZXR1cm4gdHJ1ZTsKICB9CiAgcmV0dXJuIGZhbHNlOwp9CmZ1bmN0aW9uIG5vcihkb2MsIGVscykgewogIGZvciAodmFyIGkgPSAwOyBpIDwgZWxzLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAodGxNYXRjaGVzKGRvYywgZWxzW2ldKSkgcmV0dXJuIGZhbHNlOwogIH0KICByZXR1cm4gdHJ1ZTsKfQpmdW5jdGlvbiBtYXRjaGVzKGRvYywgcXVlcnkpIHsKICByZXR1cm4gYW5kKGRvYywgdG9BcnJheShxdWVyeSkpOwp9CmZ1bmN0aW9uIG1hdGNoV2l0aEFycmF5SW5kaWNlcyhkb2MsIHF1ZXJ5KSB7CiAgY29uc3QgYXJyYXlGaWx0ZXJzID0ge307CiAgY29uc3QgbWF0Y2hlZCA9IGFuZFdpdGhUcmFja2luZyhkb2MsIHRvQXJyYXkocXVlcnkpLCBhcnJheUZpbHRlcnMpOwogIHJldHVybiB7IG1hdGNoZWQsIGFycmF5RmlsdGVycyB9Owp9CmZ1bmN0aW9uIGFuZFdpdGhUcmFja2luZyhkb2MsIGVscywgYXJyYXlGaWx0ZXJzKSB7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbHMubGVuZ3RoOyBpKyspIHsKICAgIGlmICghdGxNYXRjaGVzV2l0aFRyYWNraW5nKGRvYywgZWxzW2ldLCBhcnJheUZpbHRlcnMpKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9CiAgcmV0dXJuIHRydWU7Cn0KZnVuY3Rpb24gdGxNYXRjaGVzV2l0aFRyYWNraW5nKGRvYywgcXVlcnksIGFycmF5RmlsdGVycykgewogIHZhciBrZXkgPSBPYmplY3Qua2V5cyhxdWVyeSlbMF07CiAgdmFyIHZhbHVlID0gcXVlcnlba2V5XTsKICBpZiAoa2V5LmNoYXJBdCgwKSA9PSAiJCIpIHsKICAgIGlmIChrZXkgPT0gIiRhbmQiKSByZXR1cm4gYW5kV2l0aFRyYWNraW5nKGRvYywgdmFsdWUsIGFycmF5RmlsdGVycyk7CiAgICBlbHNlIGlmIChrZXkgPT0gIiRvciIpIHJldHVybiBvcldpdGhUcmFja2luZyhkb2MsIHZhbHVlLCBhcnJheUZpbHRlcnMpOwogICAgZWxzZSBpZiAoa2V5ID09ICIkbm90IikgewogICAgICByZXR1cm4gIXRsTWF0Y2hlcyhkb2MsIHZhbHVlKTsKICAgIH0gZWxzZSBpZiAoa2V5ID09ICIkbm9yIikgcmV0dXJuIG5vcldpdGhUcmFja2luZyhkb2MsIHZhbHVlLCBhcnJheUZpbHRlcnMpOwogICAgZWxzZSBpZiAoa2V5ID09ICIkd2hlcmUiKSByZXR1cm4gd2hlcmUoZG9jLCB2YWx1ZSk7CiAgICBlbHNlIGlmIChrZXkgPT0gIiRjb21tZW50IikgcmV0dXJuIHRydWU7CiAgICBlbHNlIGlmIChrZXkgPT0gIiRqc29uU2NoZW1hIikgcmV0dXJuIHZhbGlkYXRlSnNvblNjaGVtYShkb2MsIHZhbHVlKTsKICAgIGVsc2UgaWYgKGtleSA9PSAiJGV4cHIiKSB7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIGV2YWx1YXRlRXhwcmVzc2lvbih2YWx1ZSwgZG9jKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfSBlbHNlIHRocm93IHsgJGVycjogIkNhbid0IGNhbm9uaWNhbGl6ZSBxdWVyeTogQmFkVmFsdWUgdW5rbm93biB0b3AgbGV2ZWwgb3BlcmF0b3I6ICIgKyBrZXksIGNvZGU6IDE3Mjg3IH07CiAgfSBlbHNlIHsKICAgIHJldHVybiBvcE1hdGNoZXNXaXRoVHJhY2tpbmcoZG9jLCBrZXksIHZhbHVlLCBhcnJheUZpbHRlcnMpOwogIH0KfQpmdW5jdGlvbiBvcldpdGhUcmFja2luZyhkb2MsIGVscywgYXJyYXlGaWx0ZXJzKSB7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbHMubGVuZ3RoOyBpKyspIHsKICAgIGlmICh0bE1hdGNoZXNXaXRoVHJhY2tpbmcoZG9jLCBlbHNbaV0sIGFycmF5RmlsdGVycykpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQogIHJldHVybiBmYWxzZTsKfQpmdW5jdGlvbiBub3JXaXRoVHJhY2tpbmcoZG9jLCBlbHMsIGFycmF5RmlsdGVycykgewogIGZvciAodmFyIGkgPSAwOyBpIDwgZWxzLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAodGxNYXRjaGVzV2l0aFRyYWNraW5nKGRvYywgZWxzW2ldLCBhcnJheUZpbHRlcnMpKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9CiAgcmV0dXJuIHRydWU7Cn0KZnVuY3Rpb24gb3BNYXRjaGVzV2l0aFRyYWNraW5nKGRvYywga2V5LCB2YWx1ZSwgYXJyYXlGaWx0ZXJzKSB7CiAgY29uc3QgYmFzZUZpZWxkID0ga2V5LnNwbGl0KCIuIilbMF07CiAgY29uc3QgZmllbGRWYWx1ZSA9IGdldEZpZWxkVmFsdWVzKGRvYywga2V5KTsKICBjb25zdCB0cmFja01hdGNoaW5nSW5kZXggPSAoZmllbGRWYWx1ZTIsIGNoZWNrRm4pID0+IHsKICAgIGlmIChmaWVsZFZhbHVlMiA9PT0gdm9pZCAwKSByZXR1cm4gZmFsc2U7CiAgICBpZiAoZmllbGRWYWx1ZTIgPT09IG51bGwpIHJldHVybiBjaGVja0ZuKGZpZWxkVmFsdWUyKTsKICAgIGlmIChpc0FycmF5KGZpZWxkVmFsdWUyKSkgewogICAgICBjb25zdCBiYXNlVmFsdWUgPSBnZXRQcm9wKGRvYywgYmFzZUZpZWxkKTsKICAgICAgaWYgKGlzQXJyYXkoYmFzZVZhbHVlKSkgewogICAgICAgIGZvciAodmFyIGkyID0gMDsgaTIgPCBmaWVsZFZhbHVlMi5sZW5ndGg7IGkyKyspIHsKICAgICAgICAgIGlmIChjaGVja0ZuKGZpZWxkVmFsdWUyW2kyXSkpIHsKICAgICAgICAgICAgYXJyYXlGaWx0ZXJzW2tleV0gPSBpMjsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGZpZWxkVmFsdWVNYXRjaGVzKGZpZWxkVmFsdWUyLCBjaGVja0ZuKTsKICB9OwogIGlmICh0eXBlb2YgdmFsdWUgPT0gInN0cmluZyIpIHJldHVybiB0cmFja01hdGNoaW5nSW5kZXgoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgcmV0dXJuIHZhbHVlc0VxdWFsKHYsIHZhbHVlKTsKICB9KTsKICBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT0gIm51bWJlciIpIHJldHVybiB0cmFja01hdGNoaW5nSW5kZXgoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgcmV0dXJuIHZhbHVlc0VxdWFsKHYsIHZhbHVlKTsKICB9KTsKICBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT0gImJvb2xlYW4iKSByZXR1cm4gdHJhY2tNYXRjaGluZ0luZGV4KGZpZWxkVmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgIHJldHVybiB2YWx1ZXNFcXVhbCh2LCB2YWx1ZSk7CiAgfSk7CiAgZWxzZSBpZiAodmFsdWUgaW5zdGFuY2VvZiBPYmplY3RJZCkgcmV0dXJuIHRyYWNrTWF0Y2hpbmdJbmRleChmaWVsZFZhbHVlLCBmdW5jdGlvbih2KSB7CiAgICByZXR1cm4gdmFsdWVzRXF1YWwodiwgdmFsdWUpOwogIH0pOwogIGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PSAib2JqZWN0IikgewogICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgUmVnRXhwKSByZXR1cm4gZmllbGRWYWx1ZSAhPSB2b2lkIDAgJiYgdHJhY2tNYXRjaGluZ0luZGV4KGZpZWxkVmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgICAgcmV0dXJuIHYgJiYgdi5tYXRjaCh2YWx1ZSk7CiAgICB9KTsKICAgIGVsc2UgaWYgKGlzQXJyYXkodmFsdWUpKSByZXR1cm4gZmllbGRWYWx1ZSAhPSB2b2lkIDAgJiYgdHJhY2tNYXRjaGluZ0luZGV4KGZpZWxkVmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgICAgcmV0dXJuIHYgJiYgYXJyYXlNYXRjaGVzKHYsIHZhbHVlKTsKICAgIH0pOwogICAgZWxzZSB7CiAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXModmFsdWUpOwogICAgICBpZiAoa2V5c1swXS5jaGFyQXQoMCkgPT0gIiQiKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgb3BlcmF0b3IgPSBrZXlzW2ldOwogICAgICAgICAgdmFyIG9wZXJhbmQgPSB2YWx1ZVtvcGVyYXRvcl07CiAgICAgICAgICBpZiAob3BlcmF0b3IgPT0gIiRlcSIpIHsKICAgICAgICAgICAgaWYgKCF0cmFja01hdGNoaW5nSW5kZXgoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgIHJldHVybiB2YWx1ZXNFcXVhbCh2LCBvcGVyYW5kKTsKICAgICAgICAgICAgfSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSBpZiAob3BlcmF0b3IgPT0gIiRndCIpIHsKICAgICAgICAgICAgaWYgKCF0cmFja01hdGNoaW5nSW5kZXgoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgIHJldHVybiBjb21wYXJlVmFsdWVzKHYsIG9wZXJhbmQsICI+Iik7CiAgICAgICAgICAgIH0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgaWYgKG9wZXJhdG9yID09ICIkZ3RlIikgewogICAgICAgICAgICBpZiAoIXRyYWNrTWF0Y2hpbmdJbmRleChmaWVsZFZhbHVlLCBmdW5jdGlvbih2KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNvbXBhcmVWYWx1ZXModiwgb3BlcmFuZCwgIj49Iik7CiAgICAgICAgICAgIH0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgaWYgKG9wZXJhdG9yID09ICIkbHQiKSB7CiAgICAgICAgICAgIGlmICghdHJhY2tNYXRjaGluZ0luZGV4KGZpZWxkVmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgICByZXR1cm4gY29tcGFyZVZhbHVlcyh2LCBvcGVyYW5kLCAiPCIpOwogICAgICAgICAgICB9KSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJGx0ZSIpIHsKICAgICAgICAgICAgaWYgKCF0cmFja01hdGNoaW5nSW5kZXgoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgIHJldHVybiBjb21wYXJlVmFsdWVzKHYsIG9wZXJhbmQsICI8PSIpOwogICAgICAgICAgICB9KSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJG5lIikgewogICAgICAgICAgICBpZiAoIXRyYWNrTWF0Y2hpbmdJbmRleChmaWVsZFZhbHVlLCBmdW5jdGlvbih2KSB7CiAgICAgICAgICAgICAgcmV0dXJuICF2YWx1ZXNFcXVhbCh2LCBvcGVyYW5kKTsKICAgICAgICAgICAgfSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSBpZiAob3BlcmF0b3IgPT0gIiRpbiIpIHsKICAgICAgICAgICAgaWYgKCF0cmFja01hdGNoaW5nSW5kZXgoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgIHJldHVybiBpc0luKHYsIG9wZXJhbmQpOwogICAgICAgICAgICB9KSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJG5pbiIpIHsKICAgICAgICAgICAgaWYgKHRyYWNrTWF0Y2hpbmdJbmRleChmaWVsZFZhbHVlLCBmdW5jdGlvbih2KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGlzSW4odiwgb3BlcmFuZCk7CiAgICAgICAgICAgIH0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgaWYgKG9wZXJhdG9yID09ICIkZWxlbU1hdGNoIikgewogICAgICAgICAgICB2YXIgYXJyYXlGaWVsZFZhbHVlID0gZ2V0UHJvcChkb2MsIGtleSk7CiAgICAgICAgICAgIGlmIChhcnJheUZpZWxkVmFsdWUgPT0gdm9pZCAwIHx8ICFpc0FycmF5KGFycmF5RmllbGRWYWx1ZSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBhcnJheUZpZWxkVmFsdWUubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICB2YXIgZWxlbWVudCA9IGFycmF5RmllbGRWYWx1ZVtqXTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGVsZW1lbnQgPT09ICJvYmplY3QiICYmICFpc0FycmF5KGVsZW1lbnQpKSB7CiAgICAgICAgICAgICAgICBpZiAobWF0Y2hlcyhlbGVtZW50LCBvcGVyYW5kKSkgewogICAgICAgICAgICAgICAgICBhcnJheUZpbHRlcnNba2V5XSA9IGo7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2hlc1ByaW1pdGl2ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB2YXIgb3BLZXlzID0gT2JqZWN0LmtleXMob3BlcmFuZCk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBrID0gMDsgayA8IG9wS2V5cy5sZW5ndGg7IGsrKykgewogICAgICAgICAgICAgICAgICB2YXIgb3AgPSBvcEtleXNba107CiAgICAgICAgICAgICAgICAgIHZhciBvcFZhbHVlID0gb3BlcmFuZFtvcF07CiAgICAgICAgICAgICAgICAgIGlmIChvcCA9PSAiJGd0ZSIgJiYgIShlbGVtZW50ID49IG9wVmFsdWUpKSBtYXRjaGVzUHJpbWl0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG9wID09ICIkZ3QiICYmICEoZWxlbWVudCA+IG9wVmFsdWUpKSBtYXRjaGVzUHJpbWl0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG9wID09ICIkbHRlIiAmJiAhKGVsZW1lbnQgPD0gb3BWYWx1ZSkpIG1hdGNoZXNQcmltaXRpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgZWxzZSBpZiAob3AgPT0gIiRsdCIgJiYgIShlbGVtZW50IDwgb3BWYWx1ZSkpIG1hdGNoZXNQcmltaXRpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgZWxzZSBpZiAob3AgPT0gIiRlcSIgJiYgZWxlbWVudCAhPSBvcFZhbHVlKSBtYXRjaGVzUHJpbWl0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG9wID09ICIkbmUiICYmIGVsZW1lbnQgPT0gb3BWYWx1ZSkgbWF0Y2hlc1ByaW1pdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG1hdGNoZXNQcmltaXRpdmUpIHsKICAgICAgICAgICAgICAgICAgYXJyYXlGaWx0ZXJzW2tleV0gPSBqOwogICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKCFvcE1hdGNoZXMoZG9jLCBrZXksIHZhbHVlKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmllbGRWYWx1ZSAhPSB2b2lkIDAgJiYgdHJhY2tNYXRjaGluZ0luZGV4KGZpZWxkVmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgICAgICAgIHJldHVybiBvYmplY3RNYXRjaGVzKHYsIHZhbHVlKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gZmFsc2U7Cn0KZnVuY3Rpb24gZXh0cmFjdEZpbHRlcmVkUG9zaXRpb25hbElkZW50aWZpZXIocGF0aFNlZ21lbnQpIHsKICBjb25zdCBtYXRjaCA9IHBhdGhTZWdtZW50Lm1hdGNoKC9eXCRcWyhbXlxdXSspXF0kLyk7CiAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiBudWxsOwp9CmZ1bmN0aW9uIHBhcnNlRmllbGRQYXRoKGZpZWxkUGF0aCkgewogIGNvbnN0IHNlZ21lbnRzID0gZmllbGRQYXRoLnNwbGl0KCIuIik7CiAgcmV0dXJuIHNlZ21lbnRzLm1hcCgoc2VnbWVudCkgPT4gewogICAgY29uc3QgaWRlbnRpZmllciA9IGV4dHJhY3RGaWx0ZXJlZFBvc2l0aW9uYWxJZGVudGlmaWVyKHNlZ21lbnQpOwogICAgcmV0dXJuIHsKICAgICAgc2VnbWVudCwKICAgICAgaXNGaWx0ZXJlZFBvc2l0aW9uYWw6IGlkZW50aWZpZXIgIT09IG51bGwsCiAgICAgIGlkZW50aWZpZXIKICAgIH07CiAgfSk7Cn0KZnVuY3Rpb24gYXBwbHlUb0ZpbHRlcmVkQXJyYXlFbGVtZW50cyhkb2MsIHBhcnNlZFBhdGgsIHZhbHVlLCBvcGVyYXRpb24sIGFycmF5RmlsdGVycykgewogIGZ1bmN0aW9uIHRyYXZlcnNlKGN1cnJlbnQsIHBhdGhJbmRleCwgZmlsdGVyQ29udGV4dCkgewogICAgaWYgKHBhdGhJbmRleCA+PSBwYXJzZWRQYXRoLmxlbmd0aCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBwYXRoSW5mbyA9IHBhcnNlZFBhdGhbcGF0aEluZGV4XTsKICAgIGNvbnN0IGlzTGFzdFNlZ21lbnQgPSBwYXRoSW5kZXggPT09IHBhcnNlZFBhdGgubGVuZ3RoIC0gMTsKICAgIGlmIChwYXRoSW5mby5pc0ZpbHRlcmVkUG9zaXRpb25hbCkgewogICAgICBjb25zdCBpZGVudGlmaWVyID0gcGF0aEluZm8uaWRlbnRpZmllcjsKICAgICAgY29uc3QgZmlsdGVyID0gYXJyYXlGaWx0ZXJzID8gYXJyYXlGaWx0ZXJzLmZpbmQoKGYpID0+IHsKICAgICAgICBjb25zdCBmaWx0ZXJLZXlzID0gT2JqZWN0LmtleXMoZik7CiAgICAgICAgcmV0dXJuIGZpbHRlcktleXMuc29tZSgoa2V5KSA9PiBrZXkuc3RhcnRzV2l0aChpZGVudGlmaWVyICsgIi4iKSB8fCBrZXkgPT09IGlkZW50aWZpZXIpOwogICAgICB9KSA6IG51bGw7CiAgICAgIGlmICghYXJyYXlGaWx0ZXJzKSB7CiAgICAgICAgaWYgKCFjdXJyZW50W3BhdGhJbmZvLnNlZ21lbnRdKSB7CiAgICAgICAgICBjb25zdCBuZXh0UGF0aCA9IHBhcnNlZFBhdGhbcGF0aEluZGV4ICsgMV07CiAgICAgICAgICBpZiAobmV4dFBhdGggJiYgbmV4dFBhdGguaXNGaWx0ZXJlZFBvc2l0aW9uYWwpIHsKICAgICAgICAgICAgY3VycmVudFtwYXRoSW5mby5zZWdtZW50XSA9IFtdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY3VycmVudFtwYXRoSW5mby5zZWdtZW50XSA9IHt9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaXNMYXN0U2VnbWVudCkgewogICAgICAgICAgYXBwbHlPcGVyYXRpb25Ub1ZhbHVlKGN1cnJlbnQsIHBhdGhJbmZvLnNlZ21lbnQsIHZhbHVlLCBvcGVyYXRpb24pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0cmF2ZXJzZShjdXJyZW50W3BhdGhJbmZvLnNlZ21lbnRdLCBwYXRoSW5kZXggKyAxKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmICghaXNBcnJheShjdXJyZW50KSkgewogICAgICAgIGlmICghY3VycmVudFtwYXRoSW5mby5zZWdtZW50XSkgewogICAgICAgICAgY3VycmVudFtwYXRoSW5mby5zZWdtZW50XSA9IHt9OwogICAgICAgIH0KICAgICAgICBpZiAoaXNMYXN0U2VnbWVudCkgewogICAgICAgICAgYXBwbHlPcGVyYXRpb25Ub1ZhbHVlKGN1cnJlbnQsIHBhdGhJbmZvLnNlZ21lbnQsIHZhbHVlLCBvcGVyYXRpb24pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0cmF2ZXJzZShjdXJyZW50W3BhdGhJbmZvLnNlZ21lbnRdLCBwYXRoSW5kZXggKyAxKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY3VycmVudC5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGVsZW1lbnQgPSBjdXJyZW50W2ldOwogICAgICAgIGxldCBzaG91bGRVcGRhdGUgPSB0cnVlOwogICAgICAgIGlmIChmaWx0ZXIpIHsKICAgICAgICAgIGxldCB0cmFuc2Zvcm1lZEZpbHRlciA9IHt9OwogICAgICAgICAgbGV0IGhhc0RpcmVjdE1hdGNoID0gZmFsc2U7CiAgICAgICAgICBPYmplY3Qua2V5cyhmaWx0ZXIpLmZvckVhY2goKGtleSkgPT4gewogICAgICAgICAgICBpZiAoa2V5LnN0YXJ0c1dpdGgoaWRlbnRpZmllciArICIuIikpIHsKICAgICAgICAgICAgICBjb25zdCBmaWVsZFBhdGggPSBrZXkuc3Vic3RyaW5nKGlkZW50aWZpZXIubGVuZ3RoICsgMSk7CiAgICAgICAgICAgICAgdHJhbnNmb3JtZWRGaWx0ZXJbZmllbGRQYXRoXSA9IGZpbHRlcltrZXldOwogICAgICAgICAgICB9IGVsc2UgaWYgKGtleSA9PT0gaWRlbnRpZmllcikgewogICAgICAgICAgICAgIHRyYW5zZm9ybWVkRmlsdGVyID0gZmlsdGVyW2tleV07CiAgICAgICAgICAgICAgaGFzRGlyZWN0TWF0Y2ggPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIGlmIChoYXNEaXJlY3RNYXRjaCkgewogICAgICAgICAgICBjb25zdCB0ZXN0RG9jID0geyB2YWx1ZTogZWxlbWVudCB9OwogICAgICAgICAgICBjb25zdCB0ZXN0RmlsdGVyID0geyB2YWx1ZTogdHJhbnNmb3JtZWRGaWx0ZXIgfTsKICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gbWF0Y2hlcyh0ZXN0RG9jLCB0ZXN0RmlsdGVyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IG1hdGNoZXMoZWxlbWVudCwgdHJhbnNmb3JtZWRGaWx0ZXIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoc2hvdWxkVXBkYXRlKSB7CiAgICAgICAgICBpZiAoaXNMYXN0U2VnbWVudCkgewogICAgICAgICAgICBhcHBseU9wZXJhdGlvblRvVmFsdWUoY3VycmVudCwgaSwgdmFsdWUsIG9wZXJhdGlvbik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoZWxlbWVudCAhPT0gbnVsbCAmJiBlbGVtZW50ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0cmF2ZXJzZShjdXJyZW50W2ldLCBwYXRoSW5kZXggKyAxKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKGN1cnJlbnRbcGF0aEluZm8uc2VnbWVudF0gPT09IHZvaWQgMCB8fCBjdXJyZW50W3BhdGhJbmZvLnNlZ21lbnRdID09PSBudWxsKSB7CiAgICAgICAgaWYgKCFpc0xhc3RTZWdtZW50KSB7CiAgICAgICAgICBjb25zdCBuZXh0UGF0aCA9IHBhcnNlZFBhdGhbcGF0aEluZGV4ICsgMV07CiAgICAgICAgICBpZiAobmV4dFBhdGggJiYgbmV4dFBhdGguaXNGaWx0ZXJlZFBvc2l0aW9uYWwpIHsKICAgICAgICAgICAgY3VycmVudFtwYXRoSW5mby5zZWdtZW50XSA9IFtdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY3VycmVudFtwYXRoSW5mby5zZWdtZW50XSA9IHt9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoaXNMYXN0U2VnbWVudCkgewogICAgICAgIGFwcGx5T3BlcmF0aW9uVG9WYWx1ZShjdXJyZW50LCBwYXRoSW5mby5zZWdtZW50LCB2YWx1ZSwgb3BlcmF0aW9uKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoY3VycmVudFtwYXRoSW5mby5zZWdtZW50XSAhPT0gdm9pZCAwICYmIGN1cnJlbnRbcGF0aEluZm8uc2VnbWVudF0gIT09IG51bGwpIHsKICAgICAgICAgIHRyYXZlcnNlKGN1cnJlbnRbcGF0aEluZm8uc2VnbWVudF0sIHBhdGhJbmRleCArIDEpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICB0cmF2ZXJzZShkb2MsIDApOwp9CmZ1bmN0aW9uIGFwcGx5T3BlcmF0aW9uVG9WYWx1ZShjb250YWluZXIsIGtleSwgdmFsdWUsIG9wZXJhdGlvbikgewogIHN3aXRjaCAob3BlcmF0aW9uKSB7CiAgICBjYXNlICIkc2V0IjoKICAgICAgY29udGFpbmVyW2tleV0gPSB2YWx1ZTsKICAgICAgYnJlYWs7CiAgICBjYXNlICIkaW5jIjoKICAgICAgaWYgKGNvbnRhaW5lcltrZXldID09PSB2b2lkIDApIGNvbnRhaW5lcltrZXldID0gMDsKICAgICAgY29udGFpbmVyW2tleV0gKz0gdmFsdWU7CiAgICAgIGJyZWFrOwogICAgY2FzZSAiJG11bCI6CiAgICAgIGNvbnRhaW5lcltrZXldID0gY29udGFpbmVyW2tleV0gKiB2YWx1ZTsKICAgICAgYnJlYWs7CiAgICBjYXNlICIkbWluIjoKICAgICAgY29udGFpbmVyW2tleV0gPSBNYXRoLm1pbihjb250YWluZXJba2V5XSwgdmFsdWUpOwogICAgICBicmVhazsKICAgIGNhc2UgIiRtYXgiOgogICAgICBjb250YWluZXJba2V5XSA9IE1hdGgubWF4KGNvbnRhaW5lcltrZXldLCB2YWx1ZSk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAiJHVuc2V0IjoKICAgICAgZGVsZXRlIGNvbnRhaW5lcltrZXldOwogICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgIGNvbnRhaW5lcltrZXldID0gdmFsdWU7CiAgfQp9CmZ1bmN0aW9uIGhhc0ZpbHRlcmVkUG9zaXRpb25hbE9wZXJhdG9yKGZpZWxkUGF0aCkgewogIHJldHVybiAvXCRcW1teXF1dK1xdLy50ZXN0KGZpZWxkUGF0aCk7Cn0KZnVuY3Rpb24gaGFzQWxsUG9zaXRpb25hbChmaWVsZCkgewogIHJldHVybiBmaWVsZC5pbmRleE9mKCIkW10iKSAhPT0gLTE7Cn0KZnVuY3Rpb24gYXBwbHlUb0FsbFBvc2l0aW9uYWwoZG9jLCBmaWVsZCwgdXBkYXRlRm4pIHsKICB2YXIgcGF0aCA9IGZpZWxkLnNwbGl0KCIuIik7CiAgdmFyIGN1cnJlbnQgPSBkb2M7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXRoLmxlbmd0aDsgaSsrKSB7CiAgICB2YXIgcGF0aFNlZ21lbnQgPSBwYXRoW2ldOwogICAgaWYgKHBhdGhTZWdtZW50ID09PSAiJFtdIikgewogICAgICBpZiAoIUFycmF5LmlzQXJyYXkoY3VycmVudCkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIHJlbWFpbmluZ1BhdGggPSBwYXRoLnNsaWNlKGkgKyAxKS5qb2luKCIuIik7CiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgY3VycmVudC5sZW5ndGg7IGorKykgewogICAgICAgIGlmIChyZW1haW5pbmdQYXRoKSB7CiAgICAgICAgICBpZiAocmVtYWluaW5nUGF0aC5pbmRleE9mKCIkW10iKSAhPT0gLTEpIHsKICAgICAgICAgICAgYXBwbHlUb0FsbFBvc2l0aW9uYWwoY3VycmVudFtqXSwgcmVtYWluaW5nUGF0aCwgdXBkYXRlRm4pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRWYWx1ZSA9IGdldFByb3AoY3VycmVudFtqXSwgcmVtYWluaW5nUGF0aCk7CiAgICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IHVwZGF0ZUZuKGN1cnJlbnRWYWx1ZSk7CiAgICAgICAgICAgIHNldFByb3AoY3VycmVudFtqXSwgcmVtYWluaW5nUGF0aCwgbmV3VmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjdXJyZW50W2pdID0gdXBkYXRlRm4oY3VycmVudFtqXSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChjdXJyZW50ID09IG51bGwgfHwgY3VycmVudCA9PSB2b2lkIDApIHJldHVybjsKICAgIGN1cnJlbnQgPSBjdXJyZW50W3BhdGhTZWdtZW50XTsKICB9Cn0KZnVuY3Rpb24gcmVwbGFjZVBvc2l0aW9uYWxPcGVyYXRvcihmaWVsZFBhdGgsIGFycmF5RmlsdGVycykgewogIGlmICghYXJyYXlGaWx0ZXJzIHx8ICFmaWVsZFBhdGguaW5jbHVkZXMoIiQiKSkgewogICAgcmV0dXJuIGZpZWxkUGF0aDsKICB9CiAgY29uc3QgcGFydHMgPSBmaWVsZFBhdGguc3BsaXQoIi4iKTsKICBjb25zdCBkb2xsYXJJbmRleCA9IHBhcnRzLmluZGV4T2YoIiQiKTsKICBpZiAoZG9sbGFySW5kZXggPT09IC0xKSB7CiAgICByZXR1cm4gZmllbGRQYXRoOwogIH0KICBjb25zdCBwYXRoQmVmb3JlRG9sbGFyID0gcGFydHMuc2xpY2UoMCwgZG9sbGFySW5kZXgpLmpvaW4oIi4iKTsKICBsZXQgbWF0Y2hlZEluZGV4ID0gbnVsbDsKICBmb3IgKGNvbnN0IGZpbHRlclBhdGggaW4gYXJyYXlGaWx0ZXJzKSB7CiAgICBpZiAoZmlsdGVyUGF0aCA9PT0gcGF0aEJlZm9yZURvbGxhciB8fCBmaWx0ZXJQYXRoLnN0YXJ0c1dpdGgocGF0aEJlZm9yZURvbGxhciArICIuIikpIHsKICAgICAgbWF0Y2hlZEluZGV4ID0gYXJyYXlGaWx0ZXJzW2ZpbHRlclBhdGhdOwogICAgICBicmVhazsKICAgIH0KICB9CiAgaWYgKG1hdGNoZWRJbmRleCAhPT0gbnVsbCAmJiBtYXRjaGVkSW5kZXggIT09IHZvaWQgMCkgewogICAgcGFydHNbZG9sbGFySW5kZXhdID0gbWF0Y2hlZEluZGV4LnRvU3RyaW5nKCk7CiAgICByZXR1cm4gcGFydHMuam9pbigiLiIpOwogIH0KICByZXR1cm4gZmllbGRQYXRoOwp9CmZ1bmN0aW9uIGFwcGx5VXBkYXRlcyh1cGRhdGVzLCBkb2MsIHNldE9uSW5zZXJ0LCBwb3NpdGlvbmFsTWF0Y2hJbmZvLCB1c2VyQXJyYXlGaWx0ZXJzKSB7CiAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyh1cGRhdGVzKTsKICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgIHZhciBrZXkgPSBrZXlzW2ldOwogICAgdmFyIHZhbHVlID0gdXBkYXRlc1trZXldOwogICAgaWYgKGtleSA9PSAiJGluYyIpIHsKICAgICAgdmFyIGZpZWxkcyA9IE9iamVjdC5rZXlzKHZhbHVlKTsKICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBmaWVsZHMubGVuZ3RoOyBqKyspIHsKICAgICAgICB2YXIgZmllbGQgPSByZXBsYWNlUG9zaXRpb25hbE9wZXJhdG9yKGZpZWxkc1tqXSwgcG9zaXRpb25hbE1hdGNoSW5mbyk7CiAgICAgICAgdmFyIGFtb3VudCA9IHZhbHVlW2ZpZWxkc1tqXV07CiAgICAgICAgaWYgKGhhc0ZpbHRlcmVkUG9zaXRpb25hbE9wZXJhdG9yKGZpZWxkKSkgewogICAgICAgICAgaWYgKCF1c2VyQXJyYXlGaWx0ZXJzKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiYXJyYXlGaWx0ZXJzIG9wdGlvbiBpcyByZXF1aXJlZCB3aGVuIHVzaW5nIGZpbHRlcmVkIHBvc2l0aW9uYWwgb3BlcmF0b3IgJFs8aWRlbnRpZmllcj5dIik7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBwYXJzZWRQYXRoID0gcGFyc2VGaWVsZFBhdGgoZmllbGQpOwogICAgICAgICAgYXBwbHlUb0ZpbHRlcmVkQXJyYXlFbGVtZW50cyhkb2MsIHBhcnNlZFBhdGgsIGFtb3VudCwgIiRpbmMiLCB1c2VyQXJyYXlGaWx0ZXJzKTsKICAgICAgICB9IGVsc2UgaWYgKGhhc0FsbFBvc2l0aW9uYWwoZmllbGQpKSB7CiAgICAgICAgICBhcHBseVRvQWxsUG9zaXRpb25hbChkb2MsIGZpZWxkLCBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgICAgcmV0dXJuICh2YWwgPT09IHZvaWQgMCA/IDAgOiB2YWwpICsgYW1vdW50OwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBjdXJyZW50VmFsdWUgPSBnZXRQcm9wKGRvYywgZmllbGQpOwogICAgICAgICAgaWYgKGN1cnJlbnRWYWx1ZSA9PSB2b2lkIDApIGN1cnJlbnRWYWx1ZSA9IDA7CiAgICAgICAgICBzZXRQcm9wKGRvYywgZmllbGQsIGN1cnJlbnRWYWx1ZSArIGFtb3VudCk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgaWYgKGtleSA9PSAiJG11bCIpIHsKICAgICAgdmFyIGZpZWxkcyA9IE9iamVjdC5rZXlzKHZhbHVlKTsKICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBmaWVsZHMubGVuZ3RoOyBqKyspIHsKICAgICAgICB2YXIgZmllbGQgPSByZXBsYWNlUG9zaXRpb25hbE9wZXJhdG9yKGZpZWxkc1tqXSwgcG9zaXRpb25hbE1hdGNoSW5mbyk7CiAgICAgICAgdmFyIGFtb3VudCA9IHZhbHVlW2ZpZWxkc1tqXV07CiAgICAgICAgaWYgKGhhc0ZpbHRlcmVkUG9zaXRpb25hbE9wZXJhdG9yKGZpZWxkKSkgewogICAgICAgICAgaWYgKCF1c2VyQXJyYXlGaWx0ZXJzKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiYXJyYXlGaWx0ZXJzIG9wdGlvbiBpcyByZXF1aXJlZCB3aGVuIHVzaW5nIGZpbHRlcmVkIHBvc2l0aW9uYWwgb3BlcmF0b3IgJFs8aWRlbnRpZmllcj5dIik7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBwYXJzZWRQYXRoID0gcGFyc2VGaWVsZFBhdGgoZmllbGQpOwogICAgICAgICAgYXBwbHlUb0ZpbHRlcmVkQXJyYXlFbGVtZW50cyhkb2MsIHBhcnNlZFBhdGgsIGFtb3VudCwgIiRtdWwiLCB1c2VyQXJyYXlGaWx0ZXJzKTsKICAgICAgICB9IGVsc2UgaWYgKGhhc0FsbFBvc2l0aW9uYWwoZmllbGQpKSB7CiAgICAgICAgICBhcHBseVRvQWxsUG9zaXRpb25hbChkb2MsIGZpZWxkLCBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgICAgcmV0dXJuIHZhbCAqIGFtb3VudDsKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgY3VycmVudFZhbHVlID0gZ2V0UHJvcChkb2MsIGZpZWxkKTsKICAgICAgICAgIGlmIChjdXJyZW50VmFsdWUgPT0gdm9pZCAwKSBjdXJyZW50VmFsdWUgPSAwOwogICAgICAgICAgc2V0UHJvcChkb2MsIGZpZWxkLCBjdXJyZW50VmFsdWUgKiBhbW91bnQpOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIGlmIChrZXkgPT0gIiRyZW5hbWUiKSB7CiAgICAgIHZhciBmaWVsZHMgPSBPYmplY3Qua2V5cyh2YWx1ZSk7CiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgZmllbGRzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgdmFyIGZpZWxkID0gcmVwbGFjZVBvc2l0aW9uYWxPcGVyYXRvcihmaWVsZHNbal0sIHBvc2l0aW9uYWxNYXRjaEluZm8pOwogICAgICAgIHZhciBuZXdOYW1lID0gcmVwbGFjZVBvc2l0aW9uYWxPcGVyYXRvcih2YWx1ZVtmaWVsZHNbal1dLCBwb3NpdGlvbmFsTWF0Y2hJbmZvKTsKICAgICAgICBkb2NbbmV3TmFtZV0gPSBkb2NbZmllbGRdOwogICAgICAgIGRlbGV0ZSBkb2NbZmllbGRdOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGtleSA9PSAiJHNldE9uSW5zZXJ0IiAmJiBzZXRPbkluc2VydCkgewogICAgICB2YXIgZmllbGRzID0gT2JqZWN0LmtleXModmFsdWUpOwogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGZpZWxkcy5sZW5ndGg7IGorKykgewogICAgICAgIHZhciBmaWVsZCA9IHJlcGxhY2VQb3NpdGlvbmFsT3BlcmF0b3IoZmllbGRzW2pdLCBwb3NpdGlvbmFsTWF0Y2hJbmZvKTsKICAgICAgICBkb2NbZmllbGRdID0gdmFsdWVbZmllbGRzW2pdXTsKICAgICAgfQogICAgfSBlbHNlIGlmIChrZXkgPT0gIiRzZXQiKSB7CiAgICAgIHZhciBmaWVsZHMgPSBPYmplY3Qua2V5cyh2YWx1ZSk7CiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgZmllbGRzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgdmFyIGZpZWxkID0gcmVwbGFjZVBvc2l0aW9uYWxPcGVyYXRvcihmaWVsZHNbal0sIHBvc2l0aW9uYWxNYXRjaEluZm8pOwogICAgICAgIGlmIChoYXNGaWx0ZXJlZFBvc2l0aW9uYWxPcGVyYXRvcihmaWVsZCkpIHsKICAgICAgICAgIGlmICghdXNlckFycmF5RmlsdGVycykgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImFycmF5RmlsdGVycyBvcHRpb24gaXMgcmVxdWlyZWQgd2hlbiB1c2luZyBmaWx0ZXJlZCBwb3NpdGlvbmFsIG9wZXJhdG9yICRbPGlkZW50aWZpZXI+XSIpOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgcGFyc2VkUGF0aCA9IHBhcnNlRmllbGRQYXRoKGZpZWxkKTsKICAgICAgICAgIGFwcGx5VG9GaWx0ZXJlZEFycmF5RWxlbWVudHMoZG9jLCBwYXJzZWRQYXRoLCB2YWx1ZVtmaWVsZHNbal1dLCAiJHNldCIsIHVzZXJBcnJheUZpbHRlcnMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZXRQcm9wKGRvYywgZmllbGQsIHZhbHVlW2ZpZWxkc1tqXV0pOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIGlmIChrZXkgPT0gIiR1bnNldCIpIHsKICAgICAgdmFyIGZpZWxkcyA9IE9iamVjdC5rZXlzKHZhbHVlKTsKICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBmaWVsZHMubGVuZ3RoOyBqKyspIHsKICAgICAgICB2YXIgZmllbGQgPSByZXBsYWNlUG9zaXRpb25hbE9wZXJhdG9yKGZpZWxkc1tqXSwgcG9zaXRpb25hbE1hdGNoSW5mbyk7CiAgICAgICAgZGVsZXRlIGRvY1tmaWVsZF07CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoa2V5ID09ICIkbWluIikgewogICAgICB2YXIgZmllbGRzID0gT2JqZWN0LmtleXModmFsdWUpOwogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGZpZWxkcy5sZW5ndGg7IGorKykgewogICAgICAgIHZhciBmaWVsZCA9IHJlcGxhY2VQb3NpdGlvbmFsT3BlcmF0b3IoZmllbGRzW2pdLCBwb3NpdGlvbmFsTWF0Y2hJbmZvKTsKICAgICAgICB2YXIgYW1vdW50ID0gdmFsdWVbZmllbGRzW2pdXTsKICAgICAgICBpZiAoaGFzRmlsdGVyZWRQb3NpdGlvbmFsT3BlcmF0b3IoZmllbGQpKSB7CiAgICAgICAgICBpZiAoIXVzZXJBcnJheUZpbHRlcnMpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJhcnJheUZpbHRlcnMgb3B0aW9uIGlzIHJlcXVpcmVkIHdoZW4gdXNpbmcgZmlsdGVyZWQgcG9zaXRpb25hbCBvcGVyYXRvciAkWzxpZGVudGlmaWVyPl0iKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHBhcnNlZFBhdGggPSBwYXJzZUZpZWxkUGF0aChmaWVsZCk7CiAgICAgICAgICBhcHBseVRvRmlsdGVyZWRBcnJheUVsZW1lbnRzKGRvYywgcGFyc2VkUGF0aCwgYW1vdW50LCAiJG1pbiIsIHVzZXJBcnJheUZpbHRlcnMpOwogICAgICAgIH0gZWxzZSBpZiAoaGFzQWxsUG9zaXRpb25hbChmaWVsZCkpIHsKICAgICAgICAgIGFwcGx5VG9BbGxQb3NpdGlvbmFsKGRvYywgZmllbGQsIGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgICByZXR1cm4gTWF0aC5taW4odmFsLCBhbW91bnQpOwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBjdXJyZW50VmFsdWUgPSBnZXRQcm9wKGRvYywgZmllbGQpOwogICAgICAgICAgc2V0UHJvcChkb2MsIGZpZWxkLCBNYXRoLm1pbihjdXJyZW50VmFsdWUsIGFtb3VudCkpOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIGlmIChrZXkgPT0gIiRtYXgiKSB7CiAgICAgIHZhciBmaWVsZHMgPSBPYmplY3Qua2V5cyh2YWx1ZSk7CiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgZmllbGRzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgdmFyIGZpZWxkID0gcmVwbGFjZVBvc2l0aW9uYWxPcGVyYXRvcihmaWVsZHNbal0sIHBvc2l0aW9uYWxNYXRjaEluZm8pOwogICAgICAgIHZhciBhbW91bnQgPSB2YWx1ZVtmaWVsZHNbal1dOwogICAgICAgIGlmIChoYXNGaWx0ZXJlZFBvc2l0aW9uYWxPcGVyYXRvcihmaWVsZCkpIHsKICAgICAgICAgIGlmICghdXNlckFycmF5RmlsdGVycykgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImFycmF5RmlsdGVycyBvcHRpb24gaXMgcmVxdWlyZWQgd2hlbiB1c2luZyBmaWx0ZXJlZCBwb3NpdGlvbmFsIG9wZXJhdG9yICRbPGlkZW50aWZpZXI+XSIpOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgcGFyc2VkUGF0aCA9IHBhcnNlRmllbGRQYXRoKGZpZWxkKTsKICAgICAgICAgIGFwcGx5VG9GaWx0ZXJlZEFycmF5RWxlbWVudHMoZG9jLCBwYXJzZWRQYXRoLCBhbW91bnQsICIkbWF4IiwgdXNlckFycmF5RmlsdGVycyk7CiAgICAgICAgfSBlbHNlIGlmIChoYXNBbGxQb3NpdGlvbmFsKGZpZWxkKSkgewogICAgICAgICAgYXBwbHlUb0FsbFBvc2l0aW9uYWwoZG9jLCBmaWVsZCwgZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgIHJldHVybiBNYXRoLm1heCh2YWwsIGFtb3VudCk7CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGN1cnJlbnRWYWx1ZSA9IGdldFByb3AoZG9jLCBmaWVsZCk7CiAgICAgICAgICBzZXRQcm9wKGRvYywgZmllbGQsIE1hdGgubWF4KGN1cnJlbnRWYWx1ZSwgYW1vdW50KSk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgaWYgKGtleSA9PSAiJGN1cnJlbnREYXRlIikgewogICAgICB2YXIgZmllbGRzID0gT2JqZWN0LmtleXModmFsdWUpOwogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGZpZWxkcy5sZW5ndGg7IGorKykgewogICAgICAgIHZhciBmaWVsZCA9IHJlcGxhY2VQb3NpdGlvbmFsT3BlcmF0b3IoZmllbGRzW2pdLCBwb3NpdGlvbmFsTWF0Y2hJbmZvKTsKICAgICAgICB2YXIgdHlwZVNwZWMgPSB2YWx1ZVtmaWVsZHNbal1dOwogICAgICAgIGlmICh0eXBlU3BlYyA9PT0gdHJ1ZSB8fCB0eXBlb2YgdHlwZVNwZWMgPT09ICJvYmplY3QiICYmIHR5cGVTcGVjLiR0eXBlID09PSAiZGF0ZSIpIHsKICAgICAgICAgIHNldFByb3AoZG9jLCBmaWVsZCwgLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZXRQcm9wKGRvYywgZmllbGQsIC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoa2V5ID09ICIkYWRkVG9TZXQiKSB7CiAgICAgIHZhciBmaWVsZHMgPSBPYmplY3Qua2V5cyh2YWx1ZSk7CiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgZmllbGRzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgdmFyIGZpZWxkID0gcmVwbGFjZVBvc2l0aW9uYWxPcGVyYXRvcihmaWVsZHNbal0sIHBvc2l0aW9uYWxNYXRjaEluZm8pOwogICAgICAgIHZhciBhZGRWYWx1ZSA9IHZhbHVlW2ZpZWxkc1tqXV07CiAgICAgICAgdmFyIGN1cnJlbnRBcnJheSA9IGdldFByb3AoZG9jLCBmaWVsZCk7CiAgICAgICAgaWYgKGN1cnJlbnRBcnJheSAmJiBBcnJheS5pc0FycmF5KGN1cnJlbnRBcnJheSkpIHsKICAgICAgICAgIGN1cnJlbnRBcnJheS5wdXNoKGFkZFZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoa2V5ID09ICIkcG9wIikgewogICAgICB2YXIgZmllbGRzID0gT2JqZWN0LmtleXModmFsdWUpOwogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGZpZWxkcy5sZW5ndGg7IGorKykgewogICAgICAgIHZhciBmaWVsZCA9IHJlcGxhY2VQb3NpdGlvbmFsT3BlcmF0b3IoZmllbGRzW2pdLCBwb3NpdGlvbmFsTWF0Y2hJbmZvKTsKICAgICAgICB2YXIgcG9wVmFsdWUgPSB2YWx1ZVtmaWVsZHNbal1dOwogICAgICAgIHZhciBjdXJyZW50QXJyYXkgPSBnZXRQcm9wKGRvYywgZmllbGQpOwogICAgICAgIGlmIChjdXJyZW50QXJyYXkgJiYgQXJyYXkuaXNBcnJheShjdXJyZW50QXJyYXkpKSB7CiAgICAgICAgICBpZiAocG9wVmFsdWUgPT0gMSkgewogICAgICAgICAgICBjdXJyZW50QXJyYXkucG9wKCk7CiAgICAgICAgICB9IGVsc2UgaWYgKHBvcFZhbHVlID09IC0xKSB7CiAgICAgICAgICAgIGN1cnJlbnRBcnJheS5zaGlmdCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIGlmIChrZXkgPT0gIiRwdWxsIikgewogICAgICB2YXIgZmllbGRzID0gT2JqZWN0LmtleXModmFsdWUpOwogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGZpZWxkcy5sZW5ndGg7IGorKykgewogICAgICAgIHZhciBmaWVsZCA9IHJlcGxhY2VQb3NpdGlvbmFsT3BlcmF0b3IoZmllbGRzW2pdLCBwb3NpdGlvbmFsTWF0Y2hJbmZvKTsKICAgICAgICB2YXIgY29uZGl0aW9uID0gdmFsdWVbZmllbGRzW2pdXTsKICAgICAgICB2YXIgc3JjID0gZ2V0UHJvcChkb2MsIGZpZWxkKTsKICAgICAgICBpZiAoc3JjID09IHZvaWQgMCB8fCAhQXJyYXkuaXNBcnJheShzcmMpKSBjb250aW51ZTsKICAgICAgICB2YXIgbm90UmVtb3ZlZCA9IFtdOwogICAgICAgIGZvciAodmFyIGsgPSAwOyBrIDwgc3JjLmxlbmd0aDsgaysrKSB7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IHNyY1trXTsKICAgICAgICAgIHZhciBzaG91bGRSZW1vdmUgPSBmYWxzZTsKICAgICAgICAgIGlmICh0eXBlb2YgY29uZGl0aW9uID09PSAib2JqZWN0IiAmJiBjb25kaXRpb24gIT09IG51bGwgJiYgIUFycmF5LmlzQXJyYXkoY29uZGl0aW9uKSkgewogICAgICAgICAgICBpZiAodHlwZW9mIGVsZW1lbnQgPT09ICJvYmplY3QiICYmIGVsZW1lbnQgIT09IG51bGwgJiYgIUFycmF5LmlzQXJyYXkoZWxlbWVudCkpIHsKICAgICAgICAgICAgICBzaG91bGRSZW1vdmUgPSBtYXRjaGVzKGVsZW1lbnQsIGNvbmRpdGlvbik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHRlbXBEb2MgPSB7IF9fdGVtcDogZWxlbWVudCB9OwogICAgICAgICAgICAgIHNob3VsZFJlbW92ZSA9IG9wTWF0Y2hlcyh0ZW1wRG9jLCAiX190ZW1wIiwgY29uZGl0aW9uKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2hvdWxkUmVtb3ZlID0gZWxlbWVudCA9PSBjb25kaXRpb247CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXNob3VsZFJlbW92ZSkgbm90UmVtb3ZlZC5wdXNoKGVsZW1lbnQpOwogICAgICAgIH0KICAgICAgICBzZXRQcm9wKGRvYywgZmllbGQsIG5vdFJlbW92ZWQpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGtleSA9PSAiJHB1bGxBbGwiKSB7CiAgICAgIHZhciBmaWVsZHMgPSBPYmplY3Qua2V5cyh2YWx1ZSk7CiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgZmllbGRzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgdmFyIGZpZWxkID0gcmVwbGFjZVBvc2l0aW9uYWxPcGVyYXRvcihmaWVsZHNbal0sIHBvc2l0aW9uYWxNYXRjaEluZm8pOwogICAgICAgIHZhciBzcmMgPSBnZXRQcm9wKGRvYywgZmllbGQpOwogICAgICAgIHZhciB0b1JlbW92ZSA9IHZhbHVlW2ZpZWxkc1tqXV07CiAgICAgICAgdmFyIG5vdFJlbW92ZWQgPSBbXTsKICAgICAgICBmb3IgKHZhciBrID0gMDsgayA8IHNyYy5sZW5ndGg7IGsrKykgewogICAgICAgICAgdmFyIHJlbW92ZWQgPSBmYWxzZTsKICAgICAgICAgIGZvciAodmFyIGwgPSAwOyBsIDwgdG9SZW1vdmUubGVuZ3RoOyBsKyspIHsKICAgICAgICAgICAgaWYgKHNyY1trXSA9PSB0b1JlbW92ZVtsXSkgewogICAgICAgICAgICAgIHJlbW92ZWQgPSB0cnVlOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXJlbW92ZWQpIG5vdFJlbW92ZWQucHVzaChzcmNba10pOwogICAgICAgIH0KICAgICAgICBzZXRQcm9wKGRvYywgZmllbGQsIG5vdFJlbW92ZWQpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGtleSA9PSAiJHB1c2hBbGwiKSB7CiAgICAgIHZhciBmaWVsZHMgPSBPYmplY3Qua2V5cyh2YWx1ZSk7CiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgZmllbGRzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgdmFyIGZpZWxkID0gcmVwbGFjZVBvc2l0aW9uYWxPcGVyYXRvcihmaWVsZHNbal0sIHBvc2l0aW9uYWxNYXRjaEluZm8pOwogICAgICAgIHZhciB2YWx1ZXMgPSB2YWx1ZVtmaWVsZHNbal1dOwogICAgICAgIHZhciBjdXJyZW50QXJyYXkgPSBnZXRQcm9wKGRvYywgZmllbGQpOwogICAgICAgIGlmIChjdXJyZW50QXJyYXkgJiYgQXJyYXkuaXNBcnJheShjdXJyZW50QXJyYXkpKSB7CiAgICAgICAgICBmb3IgKHZhciBrID0gMDsgayA8IHZhbHVlcy5sZW5ndGg7IGsrKykgewogICAgICAgICAgICBjdXJyZW50QXJyYXkucHVzaCh2YWx1ZXNba10pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIGlmIChrZXkgPT0gIiRwdXNoIikgewogICAgICB2YXIgZmllbGRzID0gT2JqZWN0LmtleXModmFsdWUpOwogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGZpZWxkcy5sZW5ndGg7IGorKykgewogICAgICAgIHZhciBmaWVsZCA9IHJlcGxhY2VQb3NpdGlvbmFsT3BlcmF0b3IoZmllbGRzW2pdLCBwb3NpdGlvbmFsTWF0Y2hJbmZvKTsKICAgICAgICB2YXIgcHVzaFZhbHVlID0gdmFsdWVbZmllbGRzW2pdXTsKICAgICAgICB2YXIgaXNNb2RpZmllclB1c2ggPSBwdXNoVmFsdWUgIT09IG51bGwgJiYgdHlwZW9mIHB1c2hWYWx1ZSA9PT0gIm9iamVjdCIgJiYgKHB1c2hWYWx1ZS4kZWFjaCAhPT0gdm9pZCAwIHx8IHB1c2hWYWx1ZS4kcG9zaXRpb24gIT09IHZvaWQgMCB8fCBwdXNoVmFsdWUuJHNsaWNlICE9PSB2b2lkIDAgfHwgcHVzaFZhbHVlLiRzb3J0ICE9PSB2b2lkIDApOwogICAgICAgIGlmIChpc01vZGlmaWVyUHVzaCkgewogICAgICAgICAgdmFyIGN1cnJlbnRBcnJheSA9IGdldFByb3AoZG9jLCBmaWVsZCk7CiAgICAgICAgICBpZiAoIWN1cnJlbnRBcnJheSkgewogICAgICAgICAgICBjdXJyZW50QXJyYXkgPSBbXTsKICAgICAgICAgICAgc2V0UHJvcChkb2MsIGZpZWxkLCBjdXJyZW50QXJyYXkpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHZhbHVlc1RvUHVzaCA9IHB1c2hWYWx1ZS4kZWFjaCAhPT0gdm9pZCAwID8gcHVzaFZhbHVlLiRlYWNoIDogW3B1c2hWYWx1ZV07CiAgICAgICAgICB2YXIgcG9zaXRpb24gPSBwdXNoVmFsdWUuJHBvc2l0aW9uICE9PSB2b2lkIDAgPyBwdXNoVmFsdWUuJHBvc2l0aW9uIDogY3VycmVudEFycmF5Lmxlbmd0aDsKICAgICAgICAgIGlmIChwb3NpdGlvbiA8IDApIHsKICAgICAgICAgICAgcG9zaXRpb24gPSBNYXRoLm1heCgwLCBjdXJyZW50QXJyYXkubGVuZ3RoICsgcG9zaXRpb24pOwogICAgICAgICAgfQogICAgICAgICAgY3VycmVudEFycmF5LnNwbGljZShwb3NpdGlvbiwgMCwgLi4udmFsdWVzVG9QdXNoKTsKICAgICAgICAgIGlmIChwdXNoVmFsdWUuJHNvcnQgIT09IHZvaWQgMCkgewogICAgICAgICAgICB2YXIgc29ydFNwZWMgPSBwdXNoVmFsdWUuJHNvcnQ7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygc29ydFNwZWMgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgY3VycmVudEFycmF5LnNvcnQoZnVuY3Rpb24oYSwgYikgewogICAgICAgICAgICAgICAgaWYgKGEgPCBiKSByZXR1cm4gc29ydFNwZWMgPiAwID8gLTEgOiAxOwogICAgICAgICAgICAgICAgaWYgKGEgPiBiKSByZXR1cm4gc29ydFNwZWMgPiAwID8gMSA6IC0xOwogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHNvcnRTcGVjID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgIGN1cnJlbnRBcnJheS5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICAgICAgICAgIHZhciBzb3J0S2V5cyA9IE9iamVjdC5rZXlzKHNvcnRTcGVjKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGsyID0gMDsgazIgPCBzb3J0S2V5cy5sZW5ndGg7IGsyKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIHNvcnRLZXkgPSBzb3J0S2V5c1trMl07CiAgICAgICAgICAgICAgICAgIHZhciBzb3J0RGlyID0gc29ydFNwZWNbc29ydEtleV07CiAgICAgICAgICAgICAgICAgIHZhciBhVmFsID0gZ2V0UHJvcChhLCBzb3J0S2V5KTsKICAgICAgICAgICAgICAgICAgdmFyIGJWYWwgPSBnZXRQcm9wKGIsIHNvcnRLZXkpOwogICAgICAgICAgICAgICAgICBpZiAoYVZhbCA8IGJWYWwpIHJldHVybiBzb3J0RGlyID4gMCA/IC0xIDogMTsKICAgICAgICAgICAgICAgICAgaWYgKGFWYWwgPiBiVmFsKSByZXR1cm4gc29ydERpciA+IDAgPyAxIDogLTE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHB1c2hWYWx1ZS4kc2xpY2UgIT09IHZvaWQgMCkgewogICAgICAgICAgICB2YXIgc2xpY2VWYWx1ZSA9IHB1c2hWYWx1ZS4kc2xpY2U7CiAgICAgICAgICAgIGlmIChzbGljZVZhbHVlIDwgMCkgewogICAgICAgICAgICAgIHZhciBzbGljZWQgPSBjdXJyZW50QXJyYXkuc2xpY2Uoc2xpY2VWYWx1ZSk7CiAgICAgICAgICAgICAgc2V0UHJvcChkb2MsIGZpZWxkLCBzbGljZWQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHNsaWNlVmFsdWUgPT09IDApIHsKICAgICAgICAgICAgICBzZXRQcm9wKGRvYywgZmllbGQsIFtdKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgc2xpY2VkID0gY3VycmVudEFycmF5LnNsaWNlKDAsIHNsaWNlVmFsdWUpOwogICAgICAgICAgICAgIHNldFByb3AoZG9jLCBmaWVsZCwgc2xpY2VkKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgY3VycmVudEFycmF5ID0gZ2V0UHJvcChkb2MsIGZpZWxkKTsKICAgICAgICAgIGlmIChjdXJyZW50QXJyYXkgJiYgQXJyYXkuaXNBcnJheShjdXJyZW50QXJyYXkpKSB7CiAgICAgICAgICAgIGN1cnJlbnRBcnJheS5wdXNoKHB1c2hWYWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgaWYgKGtleSA9PSAiJGJpdCIpIHsKICAgICAgdmFyIGZpZWxkcyA9IE9iamVjdC5rZXlzKHZhbHVlKTsKICAgICAgdmFyIGZpZWxkID0gcmVwbGFjZVBvc2l0aW9uYWxPcGVyYXRvcihmaWVsZHNbMF0sIHBvc2l0aW9uYWxNYXRjaEluZm8pOwogICAgICB2YXIgb3BlcmF0aW9uID0gdmFsdWVbZmllbGRzWzBdXTsKICAgICAgdmFyIG9wZXJhdG9yID0gT2JqZWN0LmtleXMob3BlcmF0aW9uKVswXTsKICAgICAgdmFyIG9wZXJhbmQgPSBvcGVyYXRpb25bb3BlcmF0b3JdOwogICAgICB2YXIgY3VycmVudFZhbHVlID0gZ2V0UHJvcChkb2MsIGZpZWxkKTsKICAgICAgaWYgKG9wZXJhdG9yID09ICJhbmQiKSB7CiAgICAgICAgc2V0UHJvcChkb2MsIGZpZWxkLCBjdXJyZW50VmFsdWUgJiBvcGVyYW5kKTsKICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAib3IiKSB7CiAgICAgICAgc2V0UHJvcChkb2MsIGZpZWxkLCBjdXJyZW50VmFsdWUgfCBvcGVyYW5kKTsKICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAieG9yIikgewogICAgICAgIHNldFByb3AoZG9jLCBmaWVsZCwgY3VycmVudFZhbHVlIF4gb3BlcmFuZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgInVua25vd24gJGJpdCBvcGVyYXRvcjogIiArIG9wZXJhdG9yOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB0aHJvdyAidW5rbm93biB1cGRhdGUgb3BlcmF0b3I6ICIgKyBrZXk7CiAgICB9CiAgfQp9CmZ1bmN0aW9uIGNyZWF0ZURvY0Zyb21VcGRhdGUocXVlcnksIHVwZGF0ZXMsIGlkKSB7CiAgdmFyIG5ld0RvYyA9IHsgX2lkOiBpZCB9OwogIHZhciBvbmx5RmllbGRzID0gdHJ1ZTsKICB2YXIgdXBkYXRlS2V5cyA9IE9iamVjdC5rZXlzKHVwZGF0ZXMpOwogIGZvciAodmFyIGkgPSAwOyBpIDwgdXBkYXRlS2V5cy5sZW5ndGg7IGkrKykgewogICAgaWYgKHVwZGF0ZUtleXNbaV0uY2hhckF0KDApID09ICIkIikgewogICAgICBvbmx5RmllbGRzID0gZmFsc2U7CiAgICAgIGJyZWFrOwogICAgfQogIH0KICBpZiAob25seUZpZWxkcykgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB1cGRhdGVLZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIG5ld0RvY1t1cGRhdGVLZXlzW2ldXSA9IHVwZGF0ZXNbdXBkYXRlS2V5c1tpXV07CiAgICB9CiAgfSBlbHNlIHsKICAgIHZhciBxdWVyeUtleXMgPSBPYmplY3Qua2V5cyhxdWVyeSk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHF1ZXJ5S2V5cy5sZW5ndGg7IGkrKykgewogICAgICBuZXdEb2NbcXVlcnlLZXlzW2ldXSA9IHF1ZXJ5W3F1ZXJ5S2V5c1tpXV07CiAgICB9CiAgICBhcHBseVVwZGF0ZXModXBkYXRlcywgbmV3RG9jLCB0cnVlKTsKICB9CiAgcmV0dXJuIG5ld0RvYzsKfQpjbGFzcyBJbmRleCB7CiAgY29uc3RydWN0b3IobmFtZSwga2V5cywgc3RvcmFnZSwgb3B0aW9ucyA9IHt9KSB7CiAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgdGhpcy5rZXlzID0ga2V5czsKICAgIHRoaXMuc3RvcmFnZSA9IHN0b3JhZ2U7CiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogIH0KICAvKioKICAgKiBBZGQgYSBkb2N1bWVudCB0byB0aGUgaW5kZXgKICAgKiBAcGFyYW0ge09iamVjdH0gZG9jIC0gVGhlIGRvY3VtZW50IHRvIGluZGV4CiAgICovCiAgYWRkKGRvYykgewogICAgdGhyb3cgbmV3IEVycm9yKCJhZGQoKSBtdXN0IGJlIGltcGxlbWVudGVkIGJ5IHN1YmNsYXNzIik7CiAgfQogIC8qKgogICAqIFJlbW92ZSBhIGRvY3VtZW50IGZyb20gdGhlIGluZGV4CiAgICogQHBhcmFtIHtPYmplY3R9IGRvYyAtIFRoZSBkb2N1bWVudCB0byByZW1vdmUKICAgKi8KICByZW1vdmUoZG9jKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoInJlbW92ZSgpIG11c3QgYmUgaW1wbGVtZW50ZWQgYnkgc3ViY2xhc3MiKTsKICB9CiAgLyoqCiAgICogVXBkYXRlIGEgZG9jdW1lbnQgaW4gdGhlIGluZGV4IChyZW1vdmUgb2xkLCBhZGQgbmV3KQogICAqIEBwYXJhbSB7T2JqZWN0fSBvbGREb2MgLSBUaGUgb2xkIGRvY3VtZW50CiAgICogQHBhcmFtIHtPYmplY3R9IG5ld0RvYyAtIFRoZSBuZXcgZG9jdW1lbnQKICAgKi8KICB1cGRhdGUob2xkRG9jLCBuZXdEb2MpIHsKICAgIHRoaXMucmVtb3ZlKG9sZERvYyk7CiAgICB0aGlzLmFkZChuZXdEb2MpOwogIH0KICAvKioKICAgKiBRdWVyeSB0aGUgaW5kZXgKICAgKiBAcGFyYW0geyp9IHF1ZXJ5IC0gVGhlIHF1ZXJ5IHRvIGV4ZWN1dGUKICAgKiBAcmV0dXJucyB7QXJyYXl9IEFycmF5IG9mIGRvY3VtZW50IElEcyBvciBudWxsIGlmIGluZGV4IGNhbm5vdCBzYXRpc2Z5IHF1ZXJ5CiAgICovCiAgcXVlcnkocXVlcnkpIHsKICAgIHRocm93IG5ldyBFcnJvcigicXVlcnkoKSBtdXN0IGJlIGltcGxlbWVudGVkIGJ5IHN1YmNsYXNzIik7CiAgfQogIC8qKgogICAqIENsZWFyIGFsbCBkYXRhIGZyb20gdGhlIGluZGV4CiAgICovCiAgY2xlYXIoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoImNsZWFyKCkgbXVzdCBiZSBpbXBsZW1lbnRlZCBieSBzdWJjbGFzcyIpOwogIH0KICAvKioKICAgKiBHZXQgaW5kZXggc3BlY2lmaWNhdGlvbiAoZm9yIGdldEluZGV4ZXMoKSkKICAgKi8KICBnZXRTcGVjKCkgewogICAgcmV0dXJuIHsKICAgICAgbmFtZTogdGhpcy5uYW1lLAogICAgICBrZXk6IHRoaXMua2V5cwogICAgfTsKICB9Cn0KY2xhc3MgUmVndWxhckNvbGxlY3Rpb25JbmRleCBleHRlbmRzIEluZGV4IHsKICBjb25zdHJ1Y3RvcihuYW1lLCBrZXlzLCBzdG9yYWdlRmlsZVBhdGgsIG9wdGlvbnMgPSB7fSkgewogICAgc3VwZXIobmFtZSwga2V5cywgc3RvcmFnZUZpbGVQYXRoLCBvcHRpb25zKTsKICAgIHRoaXMuc3RvcmFnZUZpbGVQYXRoID0gc3RvcmFnZUZpbGVQYXRoOwogICAgdGhpcy5kYXRhID0gbnVsbDsKICAgIHRoaXMuc3luY0hhbmRsZSA9IG51bGw7CiAgICB0aGlzLmlzT3BlbiA9IGZhbHNlOwogIH0KICAvKioKICAgKiBPcGVuIHRoZSBpbmRleCBmaWxlCiAgICogTXVzdCBiZSBjYWxsZWQgYmVmb3JlIHVzaW5nIHRoZSBpbmRleAogICAqLwogIGFzeW5jIG9wZW4oKSB7CiAgICBpZiAodGhpcy5pc09wZW4pIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdHJ5IHsKICAgICAgY29uc3QgcGF0aFBhcnRzID0gdGhpcy5zdG9yYWdlRmlsZVBhdGguc3BsaXQoIi8iKS5maWx0ZXIoQm9vbGVhbik7CiAgICAgIGNvbnN0IGZpbGVuYW1lID0gcGF0aFBhcnRzLnBvcCgpOwogICAgICBpZiAoIWZpbGVuYW1lKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHN0b3JhZ2UgcGF0aDogJHt0aGlzLnN0b3JhZ2VGaWxlUGF0aH1gKTsKICAgICAgfQogICAgICBsZXQgZGlySGFuZGxlID0gYXdhaXQgZ2xvYmFsVGhpcy5uYXZpZ2F0b3Iuc3RvcmFnZS5nZXREaXJlY3RvcnkoKTsKICAgICAgZm9yIChjb25zdCBwYXJ0IG9mIHBhdGhQYXJ0cykgewogICAgICAgIGRpckhhbmRsZSA9IGF3YWl0IGRpckhhbmRsZS5nZXREaXJlY3RvcnlIYW5kbGUocGFydCwgeyBjcmVhdGU6IHRydWUgfSk7CiAgICAgIH0KICAgICAgY29uc3QgZmlsZUhhbmRsZSA9IGF3YWl0IGRpckhhbmRsZS5nZXRGaWxlSGFuZGxlKGZpbGVuYW1lLCB7IGNyZWF0ZTogdHJ1ZSB9KTsKICAgICAgdGhpcy5zeW5jSGFuZGxlID0gYXdhaXQgZmlsZUhhbmRsZS5jcmVhdGVTeW5jQWNjZXNzSGFuZGxlKCk7CiAgICAgIHRoaXMuZGF0YSA9IG5ldyBCUGx1c1RyZWUodGhpcy5zeW5jSGFuZGxlLCA1MCk7CiAgICAgIGF3YWl0IHRoaXMuZGF0YS5vcGVuKCk7CiAgICAgIHRoaXMuaXNPcGVuID0gdHJ1ZTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChlcnJvci5tZXNzYWdlICYmIChlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCJVbmtub3duIHR5cGUgYnl0ZSIpIHx8IGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoIkZhaWxlZCB0byByZWFkIG1ldGFkYXRhIikgfHwgZXJyb3IubWVzc2FnZS5pbmNsdWRlcygiSW52YWxpZCB0cmVlIGZpbGUiKSkpIHsKICAgICAgICBpZiAodGhpcy5zeW5jSGFuZGxlKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBhd2FpdCB0aGlzLnN5bmNIYW5kbGUuY2xvc2UoKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuc3luY0hhbmRsZSA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHBhdGhQYXJ0cyA9IHRoaXMuc3RvcmFnZUZpbGVQYXRoLnNwbGl0KCIvIikuZmlsdGVyKEJvb2xlYW4pOwogICAgICAgIGNvbnN0IGZpbGVuYW1lID0gcGF0aFBhcnRzLnBvcCgpOwogICAgICAgIGlmICghZmlsZW5hbWUpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBzdG9yYWdlIHBhdGg6ICR7dGhpcy5zdG9yYWdlRmlsZVBhdGh9YCk7CiAgICAgICAgfQogICAgICAgIGxldCBkaXJIYW5kbGUgPSBhd2FpdCBnbG9iYWxUaGlzLm5hdmlnYXRvci5zdG9yYWdlLmdldERpcmVjdG9yeSgpOwogICAgICAgIGZvciAoY29uc3QgcGFydCBvZiBwYXRoUGFydHMpIHsKICAgICAgICAgIGRpckhhbmRsZSA9IGF3YWl0IGRpckhhbmRsZS5nZXREaXJlY3RvcnlIYW5kbGUocGFydCwgeyBjcmVhdGU6IHRydWUgfSk7CiAgICAgICAgfQogICAgICAgIHRyeSB7CiAgICAgICAgICBhd2FpdCBkaXJIYW5kbGUucmVtb3ZlRW50cnkoZmlsZW5hbWUpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB9CiAgICAgICAgY29uc3QgZmlsZUhhbmRsZSA9IGF3YWl0IGRpckhhbmRsZS5nZXRGaWxlSGFuZGxlKGZpbGVuYW1lLCB7IGNyZWF0ZTogdHJ1ZSB9KTsKICAgICAgICB0aGlzLnN5bmNIYW5kbGUgPSBhd2FpdCBmaWxlSGFuZGxlLmNyZWF0ZVN5bmNBY2Nlc3NIYW5kbGUoKTsKICAgICAgICB0aGlzLmRhdGEgPSBuZXcgQlBsdXNUcmVlKHRoaXMuc3luY0hhbmRsZSwgNTApOwogICAgICAgIGF3YWl0IHRoaXMuZGF0YS5vcGVuKCk7CiAgICAgICAgdGhpcy5pc09wZW4gPSB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IGVycm9yOwogICAgICB9CiAgICB9CiAgfQogIC8qKgogICAqIENsb3NlIHRoZSBpbmRleCBmaWxlCiAgICovCiAgYXN5bmMgY2xvc2UoKSB7CiAgICBpZiAodGhpcy5pc09wZW4pIHsKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCB0aGlzLmRhdGEuY2xvc2UoKTsKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBpZiAoIWVycm9yLm1lc3NhZ2UgfHwgIWVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoIkZpbGUgaXMgbm90IG9wZW4iKSkgewogICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMuaXNPcGVuID0gZmFsc2U7CiAgICB9CiAgfQogIC8qKgogICAqIEV4dHJhY3QgaW5kZXgga2V5IHZhbHVlIGZyb20gYSBkb2N1bWVudAogICAqLwogIGV4dHJhY3RJbmRleEtleShkb2MpIHsKICAgIGNvbnN0IGtleUZpZWxkcyA9IE9iamVjdC5rZXlzKHRoaXMua2V5cyk7CiAgICBpZiAoa2V5RmllbGRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIG51bGw7CiAgICBpZiAoa2V5RmllbGRzLmxlbmd0aCA9PT0gMSkgewogICAgICBjb25zdCBmaWVsZCA9IGtleUZpZWxkc1swXTsKICAgICAgY29uc3QgdmFsdWUgPSBnZXRQcm9wKGRvYywgZmllbGQpOwogICAgICBpZiAodmFsdWUgPT09IHZvaWQgMCkgcmV0dXJuIG51bGw7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICAgIGNvbnN0IGtleVBhcnRzID0gW107CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleUZpZWxkcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCB2YWx1ZSA9IGdldFByb3AoZG9jLCBrZXlGaWVsZHNbaV0pOwogICAgICBpZiAodmFsdWUgPT09IHZvaWQgMCkgcmV0dXJuIG51bGw7CiAgICAgIGtleVBhcnRzLnB1c2goCiAgICAgICAgdmFsdWUKICAgICAgICAvKkpTT04uc3RyaW5naWZ5KHZhbHVlKSAqLwogICAgICApOwogICAgfQogICAgcmV0dXJuIGtleVBhcnRzLmpvaW4oIlwwIik7CiAgfQogIC8qKgogICAqIEFkZCBhIGRvY3VtZW50IHRvIHRoZSBpbmRleAogICAgKiAKICAgKiBAcGFyYW0ge09iamVjdH0gZG9jIC0gVGhlIGRvY3VtZW50IHRvIGluZGV4CiAgICovCiAgYXN5bmMgYWRkKGRvYykgewogICAgaWYgKCF0aGlzLmlzT3BlbikgewogICAgICBhd2FpdCB0aGlzLm9wZW4oKTsKICAgIH0KICAgIGNvbnN0IGluZGV4S2V5ID0gdGhpcy5leHRyYWN0SW5kZXhLZXkoZG9jKTsKICAgIGlmIChpbmRleEtleSAhPT0gbnVsbCkgewogICAgICBjb25zdCBkb2NJZCA9IGRvYy5faWQudG9TdHJpbmcoKTsKICAgICAgY29uc3QgZXhpc3RpbmcgPSBhd2FpdCB0aGlzLmRhdGEuc2VhcmNoKGluZGV4S2V5KTsKICAgICAgbGV0IGRvY0lkczsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZXhpc3RpbmcpKSB7CiAgICAgICAgaWYgKCFleGlzdGluZy5pbmNsdWRlcyhkb2NJZCkpIHsKICAgICAgICAgIGRvY0lkcyA9IFsuLi5leGlzdGluZywgZG9jSWRdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGV4aXN0aW5nKSB7CiAgICAgICAgZG9jSWRzID0gZXhpc3RpbmcgPT09IGRvY0lkID8gW2V4aXN0aW5nXSA6IFtleGlzdGluZywgZG9jSWRdOwogICAgICB9IGVsc2UgewogICAgICAgIGRvY0lkcyA9IFtkb2NJZF07CiAgICAgIH0KICAgICAgYXdhaXQgdGhpcy5kYXRhLmFkZChpbmRleEtleSwgZG9jSWRzKTsKICAgIH0KICB9CiAgLyoqCiAgICogUmVtb3ZlIGEgZG9jdW1lbnQgZnJvbSB0aGUgaW5kZXgKICAgICogCiAgICogQHBhcmFtIHtPYmplY3R9IGRvYyAtIFRoZSBkb2N1bWVudCB0byByZW1vdmUKICAgKi8KICBhc3luYyByZW1vdmUoZG9jKSB7CiAgICBpZiAoIXRoaXMuaXNPcGVuKSB7CiAgICAgIGF3YWl0IHRoaXMub3BlbigpOwogICAgfQogICAgY29uc3QgaW5kZXhLZXkgPSB0aGlzLmV4dHJhY3RJbmRleEtleShkb2MpOwogICAgaWYgKGluZGV4S2V5ICE9PSBudWxsKSB7CiAgICAgIGNvbnN0IGRvY0lkID0gZG9jLl9pZC50b1N0cmluZygpOwogICAgICBjb25zdCBleGlzdGluZyA9IGF3YWl0IHRoaXMuZGF0YS5zZWFyY2goaW5kZXhLZXkpOwogICAgICBpZiAoQXJyYXkuaXNBcnJheShleGlzdGluZykpIHsKICAgICAgICBjb25zdCBmaWx0ZXJlZCA9IGV4aXN0aW5nLmZpbHRlcigoaWQpID0+IGlkICE9PSBkb2NJZCk7CiAgICAgICAgaWYgKGZpbHRlcmVkLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGF3YWl0IHRoaXMuZGF0YS5hZGQoaW5kZXhLZXksIGZpbHRlcmVkKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYXdhaXQgdGhpcy5kYXRhLmRlbGV0ZShpbmRleEtleSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGV4aXN0aW5nID09PSBkb2NJZCkgewogICAgICAgIGF3YWl0IHRoaXMuZGF0YS5kZWxldGUoaW5kZXhLZXkpOwogICAgICB9CiAgICB9CiAgfQogIC8qKgogICAqIFF1ZXJ5IHRoZSBpbmRleAogICAgKiAKICAgKiBAcGFyYW0geyp9IHF1ZXJ5IC0gVGhlIHF1ZXJ5IG9iamVjdAogICAqIEByZXR1cm5zIHtQcm9taXNlPEFycmF5fG51bGw+fSBBcnJheSBvZiBkb2N1bWVudCBJRHMgb3IgbnVsbCBpZiBpbmRleCBjYW5ub3Qgc2F0aXNmeSBxdWVyeQogICAqLwogIGFzeW5jIHF1ZXJ5KHF1ZXJ5KSB7CiAgICBjb25zdCBxdWVyeUtleXMgPSBPYmplY3Qua2V5cyhxdWVyeSk7CiAgICBjb25zdCBpbmRleEZpZWxkcyA9IE9iamVjdC5rZXlzKHRoaXMua2V5cyk7CiAgICBpZiAoaW5kZXhGaWVsZHMubGVuZ3RoICE9PSAxKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgY29uc3QgZmllbGQgPSBpbmRleEZpZWxkc1swXTsKICAgIGlmIChxdWVyeUtleXMuaW5kZXhPZihmaWVsZCkgPT09IC0xKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgY29uc3QgcXVlcnlWYWx1ZSA9IHF1ZXJ5W2ZpZWxkXTsKICAgIGlmICh0eXBlb2YgcXVlcnlWYWx1ZSAhPT0gIm9iamVjdCIgfHwgcXVlcnlWYWx1ZSA9PT0gbnVsbCkgewogICAgICBjb25zdCBpbmRleEtleSA9IHF1ZXJ5VmFsdWU7CiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuZGF0YS5zZWFyY2goaW5kZXhLZXkpOwogICAgICByZXR1cm4gcmVzdWx0IHx8IFtdOwogICAgfQogICAgaWYgKHR5cGVvZiBxdWVyeVZhbHVlID09PSAib2JqZWN0IiAmJiAhQXJyYXkuaXNBcnJheShxdWVyeVZhbHVlKSkgewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fcXVlcnlXaXRoT3BlcmF0b3JzKGZpZWxkLCBxdWVyeVZhbHVlKTsKICAgIH0KICAgIHJldHVybiBudWxsOwogIH0KICAvKioKICAgKiBRdWVyeSBpbmRleCB3aXRoIGNvbXBhcmlzb24gb3BlcmF0b3JzCiAgICAqIAogICAqIEBwcml2YXRlCiAgICovCiAgYXN5bmMgX3F1ZXJ5V2l0aE9wZXJhdG9ycyhmaWVsZCwgb3BlcmF0b3JzKSB7CiAgICBjb25zdCBvcHMgPSBPYmplY3Qua2V5cyhvcGVyYXRvcnMpOwogICAgY29uc3QgcmVzdWx0cyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICBjb25zdCBoYXNSYW5nZU9wID0gb3BzLnNvbWUoKG9wKSA9PiBbIiRndCIsICIkZ3RlIiwgIiRsdCIsICIkbHRlIl0uaW5jbHVkZXMob3ApKTsKICAgIGlmIChoYXNSYW5nZU9wKSB7CiAgICAgIGNvbnN0IGhhc0d0ID0gb3BzLmluY2x1ZGVzKCIkZ3QiKSB8fCBvcHMuaW5jbHVkZXMoIiRndGUiKTsKICAgICAgY29uc3QgaGFzTHQgPSBvcHMuaW5jbHVkZXMoIiRsdCIpIHx8IG9wcy5pbmNsdWRlcygiJGx0ZSIpOwogICAgICBpZiAoaGFzR3QgJiYgaGFzTHQpIHsKICAgICAgICBjb25zdCBtaW5WYWx1ZSA9IG9wcy5pbmNsdWRlcygiJGd0ZSIpID8gb3BlcmF0b3JzWyIkZ3RlIl0gOiBvcHMuaW5jbHVkZXMoIiRndCIpID8gb3BlcmF0b3JzWyIkZ3QiXSA6IC1JbmZpbml0eTsKICAgICAgICBjb25zdCBtYXhWYWx1ZSA9IG9wcy5pbmNsdWRlcygiJGx0ZSIpID8gb3BlcmF0b3JzWyIkbHRlIl0gOiBvcHMuaW5jbHVkZXMoIiRsdCIpID8gb3BlcmF0b3JzWyIkbHQiXSA6IEluZmluaXR5OwogICAgICAgIGNvbnN0IHJhbmdlUmVzdWx0cyA9IGF3YWl0IHRoaXMuZGF0YS5yYW5nZVNlYXJjaChtaW5WYWx1ZSwgbWF4VmFsdWUpOwogICAgICAgIGZvciAoY29uc3QgZW50cnkgb2YgcmFuZ2VSZXN1bHRzKSB7CiAgICAgICAgICBjb25zdCBrZXlWYWx1ZSA9IGVudHJ5LmtleTsKICAgICAgICAgIGNvbnN0IHZhbHVlID0gZW50cnkudmFsdWU7CiAgICAgICAgICBsZXQgbWF0Y2hlczIgPSB0cnVlOwogICAgICAgICAgaWYgKG9wcy5pbmNsdWRlcygiJGd0IikgJiYgIShrZXlWYWx1ZSA+IG9wZXJhdG9yc1siJGd0Il0pKSBtYXRjaGVzMiA9IGZhbHNlOwogICAgICAgICAgaWYgKG9wcy5pbmNsdWRlcygiJGd0ZSIpICYmICEoa2V5VmFsdWUgPj0gb3BlcmF0b3JzWyIkZ3RlIl0pKSBtYXRjaGVzMiA9IGZhbHNlOwogICAgICAgICAgaWYgKG9wcy5pbmNsdWRlcygiJGx0IikgJiYgIShrZXlWYWx1ZSA8IG9wZXJhdG9yc1siJGx0Il0pKSBtYXRjaGVzMiA9IGZhbHNlOwogICAgICAgICAgaWYgKG9wcy5pbmNsdWRlcygiJGx0ZSIpICYmICEoa2V5VmFsdWUgPD0gb3BlcmF0b3JzWyIkbHRlIl0pKSBtYXRjaGVzMiA9IGZhbHNlOwogICAgICAgICAgaWYgKG1hdGNoZXMyICYmIHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgIHZhbHVlLmZvckVhY2goKGlkKSA9PiByZXN1bHRzLmFkZChpZCkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc3VsdHMuYWRkKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gQXJyYXkuZnJvbShyZXN1bHRzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBhbGxFbnRyaWVzID0gYXdhaXQgdGhpcy5kYXRhLnRvQXJyYXkoKTsKICAgICAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIGFsbEVudHJpZXMpIHsKICAgICAgICAgIGNvbnN0IGtleVZhbHVlID0gZW50cnkua2V5OwogICAgICAgICAgY29uc3QgdmFsdWUgPSBlbnRyeS52YWx1ZTsKICAgICAgICAgIGxldCBtYXRjaGVzMiA9IHRydWU7CiAgICAgICAgICBmb3IgKGNvbnN0IG9wIG9mIG9wcykgewogICAgICAgICAgICBjb25zdCBvcGVyYW5kID0gb3BlcmF0b3JzW29wXTsKICAgICAgICAgICAgaWYgKG9wID09PSAiJGd0IiAmJiAhKGtleVZhbHVlID4gb3BlcmFuZCkpIG1hdGNoZXMyID0gZmFsc2U7CiAgICAgICAgICAgIGVsc2UgaWYgKG9wID09PSAiJGd0ZSIgJiYgIShrZXlWYWx1ZSA+PSBvcGVyYW5kKSkgbWF0Y2hlczIgPSBmYWxzZTsKICAgICAgICAgICAgZWxzZSBpZiAob3AgPT09ICIkbHQiICYmICEoa2V5VmFsdWUgPCBvcGVyYW5kKSkgbWF0Y2hlczIgPSBmYWxzZTsKICAgICAgICAgICAgZWxzZSBpZiAob3AgPT09ICIkbHRlIiAmJiAhKGtleVZhbHVlIDw9IG9wZXJhbmQpKSBtYXRjaGVzMiA9IGZhbHNlOwogICAgICAgICAgICBlbHNlIGlmIChvcCA9PT0gIiRlcSIgJiYgIShrZXlWYWx1ZSA9PT0gb3BlcmFuZCkpIG1hdGNoZXMyID0gZmFsc2U7CiAgICAgICAgICAgIGVsc2UgaWYgKG9wID09PSAiJG5lIiAmJiAhKGtleVZhbHVlICE9PSBvcGVyYW5kKSkgbWF0Y2hlczIgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChtYXRjaGVzMiAmJiB2YWx1ZSkgewogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICB2YWx1ZS5mb3JFYWNoKChpZCkgPT4gcmVzdWx0cy5hZGQoaWQpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXN1bHRzLmFkZCh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIEFycmF5LmZyb20ocmVzdWx0cyk7CiAgICAgIH0KICAgIH0KICAgIGlmIChvcHMuaW5jbHVkZXMoIiRpbiIpKSB7CiAgICAgIGNvbnN0IHZhbHVlcyA9IG9wZXJhdG9yc1siJGluIl07CiAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlcykpIHsKICAgICAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIHZhbHVlcykgewogICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5kYXRhLnNlYXJjaCh2YWx1ZSk7CiAgICAgICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHJlc3VsdCkpIHsKICAgICAgICAgICAgICByZXN1bHQuZm9yRWFjaCgoaWQpID0+IHJlc3VsdHMuYWRkKGlkKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzdWx0cy5hZGQocmVzdWx0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gQXJyYXkuZnJvbShyZXN1bHRzKTsKICAgICAgfQogICAgfQogICAgaWYgKG9wcy5pbmNsdWRlcygiJGVxIikpIHsKICAgICAgY29uc3QgdmFsdWUgPSBvcGVyYXRvcnNbIiRlcSJdOwogICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmRhdGEuc2VhcmNoKHZhbHVlKTsKICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgIHJldHVybiBBcnJheS5pc0FycmF5KHJlc3VsdCkgPyByZXN1bHQgOiBbcmVzdWx0XTsKICAgICAgfQogICAgICByZXR1cm4gW107CiAgICB9CiAgICBpZiAob3BzLmluY2x1ZGVzKCIkbmUiKSkgewogICAgICBjb25zdCBleGNsdWRlVmFsdWUgPSBvcGVyYXRvcnNbIiRuZSJdOwogICAgICBjb25zdCBhbGxFbnRyaWVzID0gYXdhaXQgdGhpcy5kYXRhLnRvQXJyYXkoKTsKICAgICAgZm9yIChjb25zdCBlbnRyeSBvZiBhbGxFbnRyaWVzKSB7CiAgICAgICAgaWYgKGVudHJ5LmtleSAhPT0gZXhjbHVkZVZhbHVlICYmIGVudHJ5LnZhbHVlKSB7CiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShlbnRyeS52YWx1ZSkpIHsKICAgICAgICAgICAgZW50cnkudmFsdWUuZm9yRWFjaCgoaWQpID0+IHJlc3VsdHMuYWRkKGlkKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXN1bHRzLmFkZChlbnRyeS52YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBBcnJheS5mcm9tKHJlc3VsdHMpOwogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfQogIC8qKgogICAqIENsZWFyIGFsbCBlbnRyaWVzIGZyb20gdGhlIGluZGV4CiAgICovCiAgYXN5bmMgY2xlYXIoKSB7CiAgICBpZiAodGhpcy5pc09wZW4pIHsKICAgICAgYXdhaXQgdGhpcy5jbG9zZSgpOwogICAgfQogICAgY29uc3QgcGF0aFBhcnRzID0gdGhpcy5zdG9yYWdlRmlsZVBhdGguc3BsaXQoIi8iKS5maWx0ZXIoQm9vbGVhbik7CiAgICBjb25zdCBmaWxlbmFtZSA9IHBhdGhQYXJ0cy5wb3AoKTsKICAgIGxldCBkaXJIYW5kbGUgPSBhd2FpdCBnbG9iYWxUaGlzLm5hdmlnYXRvci5zdG9yYWdlLmdldERpcmVjdG9yeSgpOwogICAgZm9yIChjb25zdCBwYXJ0IG9mIHBhdGhQYXJ0cykgewogICAgICBkaXJIYW5kbGUgPSBhd2FpdCBkaXJIYW5kbGUuZ2V0RGlyZWN0b3J5SGFuZGxlKHBhcnQsIHsgY3JlYXRlOiB0cnVlIH0pOwogICAgfQogICAgdHJ5IHsKICAgICAgYXdhaXQgZGlySGFuZGxlLnJlbW92ZUVudHJ5KGZpbGVuYW1lKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgIH0KICAgIGF3YWl0IHRoaXMub3BlbigpOwogIH0KfQpjbGFzcyBUZXh0Q29sbGVjdGlvbkluZGV4IGV4dGVuZHMgSW5kZXggewogIGNvbnN0cnVjdG9yKG5hbWUsIGtleXMsIHN0b3JhZ2UsIG9wdGlvbnMgPSB7fSkgewogICAgc3VwZXIobmFtZSwga2V5cywgc3RvcmFnZSk7CiAgICB0aGlzLnN0b3JhZ2VCYXNlUGF0aCA9IHN0b3JhZ2U7CiAgICB0aGlzLnRleHRJbmRleCA9IG51bGw7CiAgICB0aGlzLnN5bmNIYW5kbGVzID0gW107CiAgICB0aGlzLmlzT3BlbiA9IGZhbHNlOwogICAgdGhpcy5pbmRleGVkRmllbGRzID0gW107CiAgICBmb3IgKGNvbnN0IGZpZWxkIGluIGtleXMpIHsKICAgICAgaWYgKGtleXNbZmllbGRdID09PSAidGV4dCIpIHsKICAgICAgICB0aGlzLmluZGV4ZWRGaWVsZHMucHVzaChmaWVsZCk7CiAgICAgIH0KICAgIH0KICAgIGlmICh0aGlzLmluZGV4ZWRGaWVsZHMubGVuZ3RoID09PSAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignVGV4dCBpbmRleCBtdXN0IGhhdmUgYXQgbGVhc3Qgb25lIGZpZWxkIHdpdGggdHlwZSAidGV4dCInKTsKICAgIH0KICB9CiAgLyoqCiAgICogT3BlbiB0aGUgaW5kZXggZmlsZXMKICAgKiBNdXN0IGJlIGNhbGxlZCBiZWZvcmUgdXNpbmcgdGhlIGluZGV4CiAgICovCiAgYXN5bmMgb3BlbigpIHsKICAgIGlmICh0aGlzLmlzT3BlbikgewogICAgICByZXR1cm47CiAgICB9CiAgICB0cnkgewogICAgICBjb25zdCBpbmRleFRyZWUgPSBhd2FpdCB0aGlzLl9jcmVhdGVCUGx1c1RyZWUodGhpcy5zdG9yYWdlQmFzZVBhdGggKyAiLXRlcm1zLmJqc29uIik7CiAgICAgIGNvbnN0IGRvY1Rlcm1zVHJlZSA9IGF3YWl0IHRoaXMuX2NyZWF0ZUJQbHVzVHJlZSh0aGlzLnN0b3JhZ2VCYXNlUGF0aCArICItZG9jdW1lbnRzLmJqc29uIik7CiAgICAgIGNvbnN0IGxlbmd0aHNUcmVlID0gYXdhaXQgdGhpcy5fY3JlYXRlQlBsdXNUcmVlKHRoaXMuc3RvcmFnZUJhc2VQYXRoICsgIi1sZW5ndGhzLmJqc29uIik7CiAgICAgIHRoaXMudGV4dEluZGV4ID0gbmV3IFRleHRJbmRleCh7CiAgICAgICAgb3JkZXI6IDE2LAogICAgICAgIHRyZWVzOiB7CiAgICAgICAgICBpbmRleDogaW5kZXhUcmVlLAogICAgICAgICAgZG9jdW1lbnRUZXJtczogZG9jVGVybXNUcmVlLAogICAgICAgICAgZG9jdW1lbnRMZW5ndGhzOiBsZW5ndGhzVHJlZQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGF3YWl0IHRoaXMudGV4dEluZGV4Lm9wZW4oKTsKICAgICAgdGhpcy5pc09wZW4gPSB0cnVlOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGVycm9yLmNvZGUgPT09ICJFTk9FTlQiIHx8IGVycm9yLm1lc3NhZ2UgJiYgKGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoIkZhaWxlZCB0byByZWFkIG1ldGFkYXRhIikgfHwgZXJyb3IubWVzc2FnZS5pbmNsdWRlcygibWlzc2luZyByZXF1aXJlZCBmaWVsZHMiKSB8fCBlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCJVbmtub3duIHR5cGUgYnl0ZSIpIHx8IGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoIkludmFsaWQiKSB8fCBlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCJmaWxlIHRvbyBzbWFsbCIpKSkgewogICAgICAgIGF3YWl0IHRoaXMuX2Nsb3NlU3luY0hhbmRsZXMoKTsKICAgICAgICBhd2FpdCB0aGlzLl9kZWxldGVJbmRleEZpbGVzKCk7CiAgICAgICAgYXdhaXQgdGhpcy5fZW5zdXJlRGlyZWN0b3J5Rm9yRmlsZSh0aGlzLnN0b3JhZ2VCYXNlUGF0aCArICItdGVybXMuYmpzb24iKTsKICAgICAgICBjb25zdCBpbmRleFRyZWUgPSBhd2FpdCB0aGlzLl9jcmVhdGVCUGx1c1RyZWUodGhpcy5zdG9yYWdlQmFzZVBhdGggKyAiLXRlcm1zLmJqc29uIik7CiAgICAgICAgY29uc3QgZG9jVGVybXNUcmVlID0gYXdhaXQgdGhpcy5fY3JlYXRlQlBsdXNUcmVlKHRoaXMuc3RvcmFnZUJhc2VQYXRoICsgIi1kb2N1bWVudHMuYmpzb24iKTsKICAgICAgICBjb25zdCBsZW5ndGhzVHJlZSA9IGF3YWl0IHRoaXMuX2NyZWF0ZUJQbHVzVHJlZSh0aGlzLnN0b3JhZ2VCYXNlUGF0aCArICItbGVuZ3Rocy5ianNvbiIpOwogICAgICAgIHRoaXMudGV4dEluZGV4ID0gbmV3IFRleHRJbmRleCh7CiAgICAgICAgICBvcmRlcjogMTYsCiAgICAgICAgICB0cmVlczogewogICAgICAgICAgICBpbmRleDogaW5kZXhUcmVlLAogICAgICAgICAgICBkb2N1bWVudFRlcm1zOiBkb2NUZXJtc1RyZWUsCiAgICAgICAgICAgIGRvY3VtZW50TGVuZ3RoczogbGVuZ3Roc1RyZWUKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBhd2FpdCB0aGlzLnRleHRJbmRleC5vcGVuKCk7CiAgICAgICAgdGhpcy5pc09wZW4gPSB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IGVycm9yOwogICAgICB9CiAgICB9CiAgfQogIGFzeW5jIF9jcmVhdGVCUGx1c1RyZWUoZmlsZVBhdGgpIHsKICAgIGNvbnN0IHBhdGhQYXJ0cyA9IGZpbGVQYXRoLnNwbGl0KCIvIikuZmlsdGVyKEJvb2xlYW4pOwogICAgY29uc3QgZmlsZW5hbWUgPSBwYXRoUGFydHMucG9wKCk7CiAgICBpZiAoIWZpbGVuYW1lKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBzdG9yYWdlIHBhdGg6ICR7ZmlsZVBhdGh9YCk7CiAgICB9CiAgICBsZXQgZGlySGFuZGxlID0gYXdhaXQgZ2xvYmFsVGhpcy5uYXZpZ2F0b3Iuc3RvcmFnZS5nZXREaXJlY3RvcnkoKTsKICAgIGZvciAoY29uc3QgcGFydCBvZiBwYXRoUGFydHMpIHsKICAgICAgZGlySGFuZGxlID0gYXdhaXQgZGlySGFuZGxlLmdldERpcmVjdG9yeUhhbmRsZShwYXJ0LCB7IGNyZWF0ZTogdHJ1ZSB9KTsKICAgIH0KICAgIGNvbnN0IGZpbGVIYW5kbGUgPSBhd2FpdCBkaXJIYW5kbGUuZ2V0RmlsZUhhbmRsZShmaWxlbmFtZSwgeyBjcmVhdGU6IHRydWUgfSk7CiAgICBjb25zdCBzeW5jSGFuZGxlID0gYXdhaXQgZmlsZUhhbmRsZS5jcmVhdGVTeW5jQWNjZXNzSGFuZGxlKCk7CiAgICB0aGlzLnN5bmNIYW5kbGVzLnB1c2goc3luY0hhbmRsZSk7CiAgICByZXR1cm4gbmV3IEJQbHVzVHJlZShzeW5jSGFuZGxlLCAxNik7CiAgfQogIGFzeW5jIF9jbG9zZVN5bmNIYW5kbGVzKCkgewogICAgZm9yIChjb25zdCBoYW5kbGUgb2YgdGhpcy5zeW5jSGFuZGxlcykgewogICAgICB0cnkgewogICAgICAgIGF3YWl0IGhhbmRsZS5jbG9zZSgpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuc3luY0hhbmRsZXMgPSBbXTsKICB9CiAgYXN5bmMgX2RlbGV0ZUluZGV4RmlsZXMoKSB7CiAgICBjb25zdCBzdWZmaXhlcyA9IFsiLXRlcm1zLmJqc29uIiwgIi1kb2N1bWVudHMuYmpzb24iLCAiLWxlbmd0aHMuYmpzb24iXTsKICAgIGZvciAoY29uc3Qgc3VmZml4IG9mIHN1ZmZpeGVzKSB7CiAgICAgIGF3YWl0IHRoaXMuX2RlbGV0ZUZpbGUodGhpcy5zdG9yYWdlQmFzZVBhdGggKyBzdWZmaXgpOwogICAgfQogIH0KICBhc3luYyBfZGVsZXRlRmlsZShmaWxlUGF0aCkgewogICAgaWYgKCFmaWxlUGF0aCkgcmV0dXJuOwogICAgdHJ5IHsKICAgICAgY29uc3QgcGF0aFBhcnRzID0gZmlsZVBhdGguc3BsaXQoIi8iKS5maWx0ZXIoQm9vbGVhbik7CiAgICAgIGNvbnN0IGZpbGVuYW1lID0gcGF0aFBhcnRzLnBvcCgpOwogICAgICBpZiAoIWZpbGVuYW1lKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHN0b3JhZ2UgcGF0aDogJHtmaWxlUGF0aH1gKTsKICAgICAgfQogICAgICBsZXQgZGlyID0gYXdhaXQgZ2xvYmFsVGhpcy5uYXZpZ2F0b3Iuc3RvcmFnZS5nZXREaXJlY3RvcnkoKTsKICAgICAgZm9yIChjb25zdCBwYXJ0IG9mIHBhdGhQYXJ0cykgewogICAgICAgIGRpciA9IGF3YWl0IGRpci5nZXREaXJlY3RvcnlIYW5kbGUocGFydCwgeyBjcmVhdGU6IGZhbHNlIH0pOwogICAgICB9CiAgICAgIGF3YWl0IGRpci5yZW1vdmVFbnRyeShmaWxlbmFtZSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgfQogIH0KICBhc3luYyBfZW5zdXJlRGlyZWN0b3J5Rm9yRmlsZShmaWxlUGF0aCkgewogICAgaWYgKCFmaWxlUGF0aCkgcmV0dXJuOwogICAgY29uc3QgcGF0aFBhcnRzID0gZmlsZVBhdGguc3BsaXQoIi8iKS5maWx0ZXIoQm9vbGVhbik7CiAgICBwYXRoUGFydHMucG9wKCk7CiAgICBpZiAocGF0aFBhcnRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwogICAgdHJ5IHsKICAgICAgbGV0IGRpciA9IGF3YWl0IGdsb2JhbFRoaXMubmF2aWdhdG9yLnN0b3JhZ2UuZ2V0RGlyZWN0b3J5KCk7CiAgICAgIGZvciAoY29uc3QgcGFydCBvZiBwYXRoUGFydHMpIHsKICAgICAgICBkaXIgPSBhd2FpdCBkaXIuZ2V0RGlyZWN0b3J5SGFuZGxlKHBhcnQsIHsgY3JlYXRlOiB0cnVlIH0pOwogICAgICB9CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoZXJyb3IuY29kZSAhPT0gIkVFWElTVCIpIHsKICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgfQogICAgfQogIH0KICAvKioKICAgKiBDbG9zZSB0aGUgaW5kZXggZmlsZXMKICAgKi8KICBhc3luYyBjbG9zZSgpIHsKICAgIGlmICh0aGlzLmlzT3BlbikgewogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMudGV4dEluZGV4LmNsb3NlKCk7CiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgaWYgKCFlcnJvci5tZXNzYWdlIHx8ICFlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCJGaWxlIGlzIG5vdCBvcGVuIikpIHsKICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLmlzT3BlbiA9IGZhbHNlOwogICAgfQogIH0KICAvKioKICAgKiBFeHRyYWN0IHRleHQgY29udGVudCBmcm9tIGEgZG9jdW1lbnQgZm9yIHRoZSBpbmRleGVkIGZpZWxkcwogICAqIEBwYXJhbSB7T2JqZWN0fSBkb2MgLSBUaGUgZG9jdW1lbnQKICAgKiBAcmV0dXJucyB7c3RyaW5nfSBDb21iaW5lZCB0ZXh0IGZyb20gYWxsIGluZGV4ZWQgZmllbGRzCiAgICovCiAgX2V4dHJhY3RUZXh0KGRvYykgewogICAgY29uc3QgdGV4dFBhcnRzID0gW107CiAgICBmb3IgKGNvbnN0IGZpZWxkIG9mIHRoaXMuaW5kZXhlZEZpZWxkcykgewogICAgICBjb25zdCB2YWx1ZSA9IGdldFByb3AoZG9jLCBmaWVsZCk7CiAgICAgIGlmICh2YWx1ZSAhPT0gdm9pZCAwICYmIHZhbHVlICE9PSBudWxsKSB7CiAgICAgICAgdGV4dFBhcnRzLnB1c2goU3RyaW5nKHZhbHVlKSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0ZXh0UGFydHMuam9pbigiICIpOwogIH0KICAvKioKICAgKiBBZGQgYSBkb2N1bWVudCB0byB0aGUgdGV4dCBpbmRleAogICAqIEBwYXJhbSB7T2JqZWN0fSBkb2MgLSBUaGUgZG9jdW1lbnQgdG8gaW5kZXgKICAgKi8KICBhc3luYyBhZGQoZG9jKSB7CiAgICBpZiAoIWRvYy5faWQpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJEb2N1bWVudCBtdXN0IGhhdmUgYW4gX2lkIGZpZWxkIik7CiAgICB9CiAgICBjb25zdCB0ZXh0MiA9IHRoaXMuX2V4dHJhY3RUZXh0KGRvYyk7CiAgICBpZiAodGV4dDIpIHsKICAgICAgYXdhaXQgdGhpcy50ZXh0SW5kZXguYWRkKFN0cmluZyhkb2MuX2lkKSwgdGV4dDIpOwogICAgfQogIH0KICAvKioKICAgKiBSZW1vdmUgYSBkb2N1bWVudCBmcm9tIHRoZSB0ZXh0IGluZGV4CiAgICogQHBhcmFtIHtPYmplY3R9IGRvYyAtIFRoZSBkb2N1bWVudCB0byByZW1vdmUKICAgKi8KICBhc3luYyByZW1vdmUoZG9jKSB7CiAgICBpZiAoIWRvYy5faWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgYXdhaXQgdGhpcy50ZXh0SW5kZXgucmVtb3ZlKFN0cmluZyhkb2MuX2lkKSk7CiAgfQogIC8qKgogICAqIFF1ZXJ5IHRoZSB0ZXh0IGluZGV4CiAgICogQHBhcmFtIHsqfSBxdWVyeSAtIFRoZSBxdWVyeSBvYmplY3QKICAgKiBAcmV0dXJucyB7QXJyYXl8bnVsbH0gQXJyYXkgb2YgZG9jdW1lbnQgSURzIG9yIG51bGwgaWYgcXVlcnkgaXMgbm90IGEgdGV4dCBzZWFyY2gKICAgKi8KICBxdWVyeShxdWVyeSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIC8qKgogICAqIFNlYXJjaCB0aGUgdGV4dCBpbmRleAogICAqIEBwYXJhbSB7c3RyaW5nfSBzZWFyY2hUZXh0IC0gVGhlIHRleHQgdG8gc2VhcmNoIGZvcgogICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIC0gU2VhcmNoIG9wdGlvbnMKICAgKiBAcmV0dXJucyB7UHJvbWlzZTxBcnJheT59IEFycmF5IG9mIGRvY3VtZW50IElEcwogICAqLwogIGFzeW5jIHNlYXJjaChzZWFyY2hUZXh0LCBvcHRpb25zID0ge30pIHsKICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLnRleHRJbmRleC5xdWVyeShzZWFyY2hUZXh0LCB7IHNjb3JlZDogZmFsc2UsIC4uLm9wdGlvbnMgfSk7CiAgICByZXR1cm4gcmVzdWx0czsKICB9CiAgLyoqCiAgICogQ2xlYXIgYWxsIGRhdGEgZnJvbSB0aGUgaW5kZXgKICAgKi8KICAvLyBUT0RPOiBSZWNyZWF0ZSB0aGUgaW5kZXggZW1wdHkgb3IgZGVsZXRlCiAgYXN5bmMgY2xlYXIoKSB7CiAgICBpZiAodGhpcy5pc09wZW4pIHsKICAgICAgYXdhaXQgdGhpcy5jbG9zZSgpOwogICAgfQogICAgYXdhaXQgdGhpcy5fZGVsZXRlSW5kZXhGaWxlcygpOwogICAgYXdhaXQgdGhpcy5vcGVuKCk7CiAgfQogIC8qKgogICAqIEdldCBpbmRleCBzcGVjaWZpY2F0aW9uCiAgICovCiAgZ2V0U3BlYygpIHsKICAgIHJldHVybiB7CiAgICAgIG5hbWU6IHRoaXMubmFtZSwKICAgICAga2V5OiB0aGlzLmtleXMsCiAgICAgIHRleHRJbmRleFZlcnNpb246IDMsCiAgICAgIHdlaWdodHM6IHRoaXMuX2dldFdlaWdodHMoKQogICAgfTsKICB9CiAgLyoqCiAgICogR2V0IGZpZWxkIHdlaWdodHMgKGFsbCBkZWZhdWx0IHRvIDEgZm9yIG5vdykKICAgKi8KICBfZ2V0V2VpZ2h0cygpIHsKICAgIGNvbnN0IHdlaWdodHMgPSB7fTsKICAgIGZvciAoY29uc3QgZmllbGQgb2YgdGhpcy5pbmRleGVkRmllbGRzKSB7CiAgICAgIHdlaWdodHNbZmllbGRdID0gMTsKICAgIH0KICAgIHJldHVybiB3ZWlnaHRzOwogIH0KfQpmdW5jdGlvbiBoYXZlcnNpbmVEaXN0YW5jZShsYXQxLCBsbmcxLCBsYXQyLCBsbmcyKSB7CiAgY29uc3QgUiA9IDYzNzE7CiAgY29uc3QgZExhdCA9IChsYXQyIC0gbGF0MSkgKiBNYXRoLlBJIC8gMTgwOwogIGNvbnN0IGRMbmcgPSAobG5nMiAtIGxuZzEpICogTWF0aC5QSSAvIDE4MDsKICBjb25zdCBhID0gTWF0aC5zaW4oZExhdCAvIDIpICogTWF0aC5zaW4oZExhdCAvIDIpICsgTWF0aC5jb3MobGF0MSAqIE1hdGguUEkgLyAxODApICogTWF0aC5jb3MobGF0MiAqIE1hdGguUEkgLyAxODApICogTWF0aC5zaW4oZExuZyAvIDIpICogTWF0aC5zaW4oZExuZyAvIDIpOwogIGNvbnN0IGMgPSAyICogTWF0aC5hdGFuMihNYXRoLnNxcnQoYSksIE1hdGguc3FydCgxIC0gYSkpOwogIHJldHVybiBSICogYzsKfQpmdW5jdGlvbiByYWRpdXNUb0JvdW5kaW5nQm94KGxhdCwgbG5nLCByYWRpdXNLbSkgewogIGNvbnN0IGxhdERlbHRhID0gcmFkaXVzS20gLyAxMTE7CiAgY29uc3QgbG5nRGVsdGEgPSByYWRpdXNLbSAvICgxMTEgKiBNYXRoLmNvcyhsYXQgKiBNYXRoLlBJIC8gMTgwKSk7CiAgcmV0dXJuIHsKICAgIG1pbkxhdDogbGF0IC0gbGF0RGVsdGEsCiAgICBtYXhMYXQ6IGxhdCArIGxhdERlbHRhLAogICAgbWluTG5nOiBsbmcgLSBsbmdEZWx0YSwKICAgIG1heExuZzogbG5nICsgbG5nRGVsdGEKICB9Owp9CmZ1bmN0aW9uIGludGVyc2VjdHMoYmJveDEsIGJib3gyKSB7CiAgcmV0dXJuICEoYmJveDEubWF4TGF0IDwgYmJveDIubWluTGF0IHx8IGJib3gxLm1pbkxhdCA+IGJib3gyLm1heExhdCB8fCBiYm94MS5tYXhMbmcgPCBiYm94Mi5taW5MbmcgfHwgYmJveDEubWluTG5nID4gYmJveDIubWF4TG5nKTsKfQpmdW5jdGlvbiBhcmVhKGJib3gpIHsKICByZXR1cm4gKGJib3gubWF4TGF0IC0gYmJveC5taW5MYXQpICogKGJib3gubWF4TG5nIC0gYmJveC5taW5MbmcpOwp9CmZ1bmN0aW9uIHVuaW9uKGJib3gxLCBiYm94MikgewogIHJldHVybiB7CiAgICBtaW5MYXQ6IE1hdGgubWluKGJib3gxLm1pbkxhdCwgYmJveDIubWluTGF0KSwKICAgIG1heExhdDogTWF0aC5tYXgoYmJveDEubWF4TGF0LCBiYm94Mi5tYXhMYXQpLAogICAgbWluTG5nOiBNYXRoLm1pbihiYm94MS5taW5MbmcsIGJib3gyLm1pbkxuZyksCiAgICBtYXhMbmc6IE1hdGgubWF4KGJib3gxLm1heExuZywgYmJveDIubWF4TG5nKQogIH07Cn0KZnVuY3Rpb24gZW5sYXJnZW1lbnQoYmJveDEsIGJib3gyKSB7CiAgY29uc3QgdW5pb25Cb3ggPSB1bmlvbihiYm94MSwgYmJveDIpOwogIHJldHVybiBhcmVhKHVuaW9uQm94KSAtIGFyZWEoYmJveDEpOwp9CmNsYXNzIFJUcmVlTm9kZSB7CiAgY29uc3RydWN0b3IocnRyZWUsIG5vZGVEYXRhKSB7CiAgICB0aGlzLnJ0cmVlID0gcnRyZWU7CiAgICB0aGlzLmlkID0gbm9kZURhdGEuaWQ7CiAgICB0aGlzLmlzTGVhZiA9IG5vZGVEYXRhLmlzTGVhZjsKICAgIHRoaXMuY2hpbGRyZW4gPSBub2RlRGF0YS5jaGlsZHJlbiB8fCBbXTsKICAgIHRoaXMuYmJveCA9IG5vZGVEYXRhLmJib3g7CiAgfQogIC8qKgogICAqIFVwZGF0ZSB0aGUgYm91bmRpbmcgYm94IHRvIGNvbnRhaW4gYWxsIGNoaWxkcmVuCiAgICovCiAgdXBkYXRlQkJveCgpIHsKICAgIGlmICh0aGlzLmNoaWxkcmVuLmxlbmd0aCA9PT0gMCkgewogICAgICB0aGlzLmJib3ggPSBudWxsOwogICAgICByZXR1cm47CiAgICB9CiAgICBsZXQgbWluTGF0ID0gSW5maW5pdHksIG1heExhdCA9IC1JbmZpbml0eTsKICAgIGxldCBtaW5MbmcgPSBJbmZpbml0eSwgbWF4TG5nID0gLUluZmluaXR5OwogICAgZm9yIChjb25zdCBjaGlsZCBvZiB0aGlzLmNoaWxkcmVuKSB7CiAgICAgIGxldCBiYm94OwogICAgICBpZiAodGhpcy5pc0xlYWYpIHsKICAgICAgICBiYm94ID0gY2hpbGQuYmJveDsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBjaGlsZE5vZGUgPSB0aGlzLnJ0cmVlLl9sb2FkTm9kZShjaGlsZCk7CiAgICAgICAgYmJveCA9IGNoaWxkTm9kZS5iYm94OwogICAgICB9CiAgICAgIGlmIChiYm94KSB7CiAgICAgICAgbWluTGF0ID0gTWF0aC5taW4obWluTGF0LCBiYm94Lm1pbkxhdCk7CiAgICAgICAgbWF4TGF0ID0gTWF0aC5tYXgobWF4TGF0LCBiYm94Lm1heExhdCk7CiAgICAgICAgbWluTG5nID0gTWF0aC5taW4obWluTG5nLCBiYm94Lm1pbkxuZyk7CiAgICAgICAgbWF4TG5nID0gTWF0aC5tYXgobWF4TG5nLCBiYm94Lm1heExuZyk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuYmJveCA9IHsgbWluTGF0LCBtYXhMYXQsIG1pbkxuZywgbWF4TG5nIH07CiAgICB0aGlzLnJ0cmVlLl9zYXZlTm9kZSh0aGlzKTsKICB9CiAgLyoqCiAgICogQ29udmVydCBub2RlIHRvIHBsYWluIG9iamVjdCBmb3Igc2VyaWFsaXphdGlvbgogICAqLwogIHRvSlNPTigpIHsKICAgIHJldHVybiB7CiAgICAgIGlkOiB0aGlzLmlkLAogICAgICBpc0xlYWY6IHRoaXMuaXNMZWFmLAogICAgICBjaGlsZHJlbjogdGhpcy5jaGlsZHJlbiwKICAgICAgYmJveDogdGhpcy5iYm94CiAgICB9OwogIH0KfQpjbGFzcyBSVHJlZSB7CiAgY29uc3RydWN0b3Ioc3luY0hhbmRsZSwgbWF4RW50cmllcyA9IDkpIHsKICAgIHRoaXMuZmlsZSA9IG5ldyBCSnNvbkZpbGUoc3luY0hhbmRsZSk7CiAgICB0aGlzLm1heEVudHJpZXMgPSBtYXhFbnRyaWVzOwogICAgdGhpcy5taW5FbnRyaWVzID0gTWF0aC5tYXgoMiwgTWF0aC5jZWlsKG1heEVudHJpZXMgLyAyKSk7CiAgICB0aGlzLnJvb3RQb2ludGVyID0gbnVsbDsKICAgIHRoaXMubmV4dElkID0gMTsKICAgIHRoaXMuX3NpemUgPSAwOwogICAgdGhpcy5pc09wZW4gPSBmYWxzZTsKICB9CiAgLyoqCiAgICogT3BlbiB0aGUgUi10cmVlIChsb2FkIG9yIGluaXRpYWxpemUgbWV0YWRhdGEpCiAgICovCiAgYXN5bmMgb3BlbigpIHsKICAgIGlmICh0aGlzLmlzT3BlbikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlItdHJlZSBpcyBhbHJlYWR5IG9wZW4iKTsKICAgIH0KICAgIGNvbnN0IGZpbGVTaXplID0gdGhpcy5maWxlLmdldEZpbGVTaXplKCk7CiAgICBjb25zdCBleGlzdHMgPSBmaWxlU2l6ZSA+IDA7CiAgICBpZiAoZXhpc3RzKSB7CiAgICAgIHRoaXMuX2xvYWRGcm9tRmlsZSgpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5faW5pdGlhbGl6ZU5ld1RyZWUoKTsKICAgIH0KICAgIHRoaXMuaXNPcGVuID0gdHJ1ZTsKICB9CiAgLyoqCiAgICogQ2xvc2UgdGhlIFItdHJlZQogICAqLwogIGFzeW5jIGNsb3NlKCkgewogICAgaWYgKHRoaXMuaXNPcGVuKSB7CiAgICAgIHRoaXMuX3dyaXRlTWV0YWRhdGEoKTsKICAgICAgaWYgKHRoaXMuZmlsZSAmJiB0aGlzLmZpbGUuc3luY0FjY2Vzc0hhbmRsZSkgewogICAgICAgIHRoaXMuZmlsZS5mbHVzaCgpOwogICAgICAgIGF3YWl0IHRoaXMuZmlsZS5zeW5jQWNjZXNzSGFuZGxlLmNsb3NlKCk7CiAgICAgIH0KICAgICAgdGhpcy5pc09wZW4gPSBmYWxzZTsKICAgIH0KICB9CiAgLyoqCiAgICogSW5pdGlhbGl6ZSBhIG5ldyBlbXB0eSB0cmVlCiAgICovCiAgX2luaXRpYWxpemVOZXdUcmVlKCkgewogICAgY29uc3Qgcm9vdE5vZGUgPSBuZXcgUlRyZWVOb2RlKHRoaXMsIHsKICAgICAgaWQ6IDAsCiAgICAgIGlzTGVhZjogdHJ1ZSwKICAgICAgY2hpbGRyZW46IFtdLAogICAgICBiYm94OiBudWxsCiAgICB9KTsKICAgIHRoaXMubmV4dElkID0gMTsKICAgIHRoaXMuX3NpemUgPSAwOwogICAgdGhpcy5yb290UG9pbnRlciA9IHRoaXMuX3NhdmVOb2RlKHJvb3ROb2RlKTsKICAgIHRoaXMuX3dyaXRlTWV0YWRhdGEoKTsKICB9CiAgLyoqCiAgICogV3JpdGUgbWV0YWRhdGEgcmVjb3JkIHRvIGZpbGUKICAgKi8KICBfd3JpdGVNZXRhZGF0YSgpIHsKICAgIGNvbnN0IG1ldGFkYXRhID0gewogICAgICB2ZXJzaW9uOiAxLAogICAgICBtYXhFbnRyaWVzOiB0aGlzLm1heEVudHJpZXMsCiAgICAgIG1pbkVudHJpZXM6IHRoaXMubWluRW50cmllcywKICAgICAgc2l6ZTogdGhpcy5fc2l6ZSwKICAgICAgcm9vdFBvaW50ZXI6IHRoaXMucm9vdFBvaW50ZXIsCiAgICAgIG5leHRJZDogdGhpcy5uZXh0SWQKICAgIH07CiAgICB0aGlzLmZpbGUuYXBwZW5kKG1ldGFkYXRhKTsKICB9CiAgLyoqCiAgICogTG9hZCB0cmVlIGZyb20gZXhpc3RpbmcgZmlsZQogICAqLwogIF9sb2FkRnJvbUZpbGUoKSB7CiAgICBjb25zdCBNRVRBREFUQV9TSVpFID0gMTM1OwogICAgY29uc3QgZmlsZVNpemUgPSB0aGlzLmZpbGUuZ2V0RmlsZVNpemUoKTsKICAgIGlmIChmaWxlU2l6ZSA8IE1FVEFEQVRBX1NJWkUpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIFItdHJlZSBmaWxlIGZvcm1hdDogZmlsZSB0b28gc21hbGwgZm9yIG1ldGFkYXRhIik7CiAgICB9CiAgICBjb25zdCBtZXRhZGF0YU9mZnNldCA9IGZpbGVTaXplIC0gTUVUQURBVEFfU0laRTsKICAgIGNvbnN0IG1ldGFkYXRhID0gdGhpcy5maWxlLnJlYWQobWV0YWRhdGFPZmZzZXQpOwogICAgdGhpcy5tYXhFbnRyaWVzID0gbWV0YWRhdGEubWF4RW50cmllczsKICAgIHRoaXMubWluRW50cmllcyA9IG1ldGFkYXRhLm1pbkVudHJpZXM7CiAgICB0aGlzLl9zaXplID0gbWV0YWRhdGEuc2l6ZTsKICAgIHRoaXMucm9vdFBvaW50ZXIgPSBtZXRhZGF0YS5yb290UG9pbnRlcjsKICAgIHRoaXMubmV4dElkID0gbWV0YWRhdGEubmV4dElkOwogIH0KICAvKioKICAgKiBTYXZlIGEgbm9kZSB0byBkaXNrIGFuZCByZXR1cm4gaXRzIFBvaW50ZXIKICAgKi8KICBfc2F2ZU5vZGUobm9kZSkgewogICAgY29uc3Qgbm9kZURhdGEgPSBub2RlLnRvSlNPTigpOwogICAgY29uc3Qgb2Zmc2V0ID0gdGhpcy5maWxlLmdldEZpbGVTaXplKCk7CiAgICB0aGlzLmZpbGUuYXBwZW5kKG5vZGVEYXRhKTsKICAgIHJldHVybiBuZXcgUG9pbnRlcihvZmZzZXQpOwogIH0KICAvKioKICAgKiBMb2FkIGEgbm9kZSBmcm9tIGRpc2sgYnkgUG9pbnRlcgogICAqLwogIF9sb2FkTm9kZShwb2ludGVyKSB7CiAgICBpZiAoIShwb2ludGVyIGluc3RhbmNlb2YgUG9pbnRlcikpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBQb2ludGVyIG9iamVjdCIpOwogICAgfQogICAgY29uc3Qgb2Zmc2V0ID0gcG9pbnRlci52YWx1ZU9mKCk7CiAgICBjb25zdCBub2RlRGF0YSA9IHRoaXMuZmlsZS5yZWFkKG9mZnNldCk7CiAgICByZXR1cm4gbmV3IFJUcmVlTm9kZSh0aGlzLCBub2RlRGF0YSk7CiAgfQogIC8qKgogICAqIExvYWQgdGhlIHJvb3Qgbm9kZQogICAqLwogIF9sb2FkUm9vdCgpIHsKICAgIHJldHVybiB0aGlzLl9sb2FkTm9kZSh0aGlzLnJvb3RQb2ludGVyKTsKICB9CiAgLyoqCiAgICogSW5zZXJ0IGEgcG9pbnQgaW50byB0aGUgUi10cmVlIHdpdGggYW4gT2JqZWN0SWQKICAgKi8KICBpbnNlcnQobGF0LCBsbmcsIG9iamVjdElkKSB7CiAgICBpZiAoIXRoaXMuaXNPcGVuKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiUi10cmVlIGZpbGUgbXVzdCBiZSBvcGVuZWQgYmVmb3JlIHVzZSIpOwogICAgfQogICAgaWYgKCEob2JqZWN0SWQgaW5zdGFuY2VvZiBPYmplY3RJZCkpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJvYmplY3RJZCBtdXN0IGJlIGFuIGluc3RhbmNlIG9mIE9iamVjdElkIHRvIGluc2VydCBpbnRvIHJ0cmVlIik7CiAgICB9CiAgICBjb25zdCBiYm94ID0gewogICAgICBtaW5MYXQ6IGxhdCwKICAgICAgbWF4TGF0OiBsYXQsCiAgICAgIG1pbkxuZzogbG5nLAogICAgICBtYXhMbmc6IGxuZwogICAgfTsKICAgIGNvbnN0IGVudHJ5ID0geyBiYm94LCBsYXQsIGxuZywgb2JqZWN0SWQgfTsKICAgIGNvbnN0IHJvb3QgPSB0aGlzLl9sb2FkUm9vdCgpOwogICAgY29uc3QgcmVzdWx0ID0gdGhpcy5faW5zZXJ0KGVudHJ5LCByb290LCAxKTsKICAgIGlmIChyZXN1bHQuc3BsaXQpIHsKICAgICAgY29uc3QgbmV3Um9vdCA9IG5ldyBSVHJlZU5vZGUodGhpcywgewogICAgICAgIGlkOiB0aGlzLm5leHRJZCsrLAogICAgICAgIGlzTGVhZjogZmFsc2UsCiAgICAgICAgY2hpbGRyZW46IHJlc3VsdC5wb2ludGVycywKICAgICAgICBiYm94OiBudWxsCiAgICAgIH0pOwogICAgICBuZXdSb290LnVwZGF0ZUJCb3goKTsKICAgICAgdGhpcy5yb290UG9pbnRlciA9IHRoaXMuX3NhdmVOb2RlKG5ld1Jvb3QpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5yb290UG9pbnRlciA9IHJlc3VsdC5wb2ludGVyOwogICAgfQogICAgdGhpcy5fc2l6ZSsrOwogICAgdGhpcy5fd3JpdGVNZXRhZGF0YSgpOwogIH0KICAvKioKICAgKiBJbnRlcm5hbCBpbnNlcnQgbWV0aG9kIC0gcmV0dXJucyBzcGxpdFBvaW50ZXJzIGlmIHNwbGl0IG9jY3VycmVkLCBlbHNlIHJldHVybnMgdXBkYXRlZCBub2RlIHBvaW50ZXIKICAgKi8KICBfaW5zZXJ0KGVudHJ5LCBub2RlLCBsZXZlbCkgewogICAgaWYgKG5vZGUuaXNMZWFmKSB7CiAgICAgIG5vZGUuY2hpbGRyZW4ucHVzaChlbnRyeSk7CiAgICAgIG5vZGUudXBkYXRlQkJveCgpOwogICAgICBpZiAobm9kZS5jaGlsZHJlbi5sZW5ndGggPiB0aGlzLm1heEVudHJpZXMpIHsKICAgICAgICBjb25zdCBbcG9pbnRlcjEsIHBvaW50ZXIyXSA9IHRoaXMuX3NwbGl0KG5vZGUpOwogICAgICAgIHJldHVybiB7IHNwbGl0OiB0cnVlLCBwb2ludGVyczogW3BvaW50ZXIxLCBwb2ludGVyMl0gfTsKICAgICAgfQogICAgICBjb25zdCBwb2ludGVyID0gdGhpcy5fc2F2ZU5vZGUobm9kZSk7CiAgICAgIHJldHVybiB7IHNwbGl0OiBmYWxzZSwgcG9pbnRlciB9OwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgdGFyZ2V0UG9pbnRlciA9IHRoaXMuX2Nob29zZVN1YnRyZWUoZW50cnkuYmJveCwgbm9kZSk7CiAgICAgIGNvbnN0IHRhcmdldE5vZGUgPSB0aGlzLl9sb2FkTm9kZSh0YXJnZXRQb2ludGVyKTsKICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5faW5zZXJ0KGVudHJ5LCB0YXJnZXROb2RlLCBsZXZlbCArIDEpOwogICAgICBpZiAocmVzdWx0LnNwbGl0KSB7CiAgICAgICAgbGV0IGNoaWxkSW5kZXggPSAtMTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChub2RlLmNoaWxkcmVuW2ldLnZhbHVlT2YoKSA9PT0gdGFyZ2V0UG9pbnRlci52YWx1ZU9mKCkpIHsKICAgICAgICAgICAgY2hpbGRJbmRleCA9IGk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoY2hpbGRJbmRleCAhPT0gLTEpIHsKICAgICAgICAgIG5vZGUuY2hpbGRyZW5bY2hpbGRJbmRleF0gPSByZXN1bHQucG9pbnRlcnNbMF07CiAgICAgICAgICBub2RlLmNoaWxkcmVuLnB1c2gocmVzdWx0LnBvaW50ZXJzWzFdKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbm9kZS5jaGlsZHJlbi5wdXNoKHJlc3VsdC5wb2ludGVyc1swXSk7CiAgICAgICAgICBub2RlLmNoaWxkcmVuLnB1c2gocmVzdWx0LnBvaW50ZXJzWzFdKTsKICAgICAgICB9CiAgICAgICAgbm9kZS51cGRhdGVCQm94KCk7CiAgICAgICAgaWYgKG5vZGUuY2hpbGRyZW4ubGVuZ3RoID4gdGhpcy5tYXhFbnRyaWVzKSB7CiAgICAgICAgICBjb25zdCBbcG9pbnRlcjEsIHBvaW50ZXIyXSA9IHRoaXMuX3NwbGl0KG5vZGUpOwogICAgICAgICAgcmV0dXJuIHsgc3BsaXQ6IHRydWUsIHBvaW50ZXJzOiBbcG9pbnRlcjEsIHBvaW50ZXIyXSB9OwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBsZXQgY2hpbGRJbmRleCA9IC0xOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZS5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKG5vZGUuY2hpbGRyZW5baV0udmFsdWVPZigpID09PSB0YXJnZXRQb2ludGVyLnZhbHVlT2YoKSkgewogICAgICAgICAgICBjaGlsZEluZGV4ID0gaTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChjaGlsZEluZGV4ICE9PSAtMSkgewogICAgICAgICAgbm9kZS5jaGlsZHJlbltjaGlsZEluZGV4XSA9IHJlc3VsdC5wb2ludGVyOwogICAgICAgIH0KICAgICAgICBub2RlLnVwZGF0ZUJCb3goKTsKICAgICAgfQogICAgICBjb25zdCBwb2ludGVyID0gdGhpcy5fc2F2ZU5vZGUobm9kZSk7CiAgICAgIHJldHVybiB7IHNwbGl0OiBmYWxzZSwgcG9pbnRlciB9OwogICAgfQogIH0KICAvKioKICAgKiBDaG9vc2UgdGhlIGJlc3Qgc3VidHJlZSB0byBpbnNlcnQgYW4gZW50cnkKICAgKi8KICBfY2hvb3NlU3VidHJlZShiYm94LCBub2RlKSB7CiAgICBsZXQgbWluRW5sYXJnZW1lbnQgPSBJbmZpbml0eTsKICAgIGxldCBtaW5BcmVhID0gSW5maW5pdHk7CiAgICBsZXQgdGFyZ2V0UG9pbnRlciA9IG51bGw7CiAgICBmb3IgKGNvbnN0IGNoaWxkUG9pbnRlciBvZiBub2RlLmNoaWxkcmVuKSB7CiAgICAgIGlmICghKGNoaWxkUG9pbnRlciBpbnN0YW5jZW9mIFBvaW50ZXIpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBQb2ludGVyIGluIF9jaG9vc2VTdWJ0cmVlLCBnb3Q6ICR7dHlwZW9mIGNoaWxkUG9pbnRlcn1gKTsKICAgICAgfQogICAgICBjb25zdCBjaGlsZE5vZGUgPSB0aGlzLl9sb2FkTm9kZShjaGlsZFBvaW50ZXIpOwogICAgICBjb25zdCBlbmwgPSBlbmxhcmdlbWVudChjaGlsZE5vZGUuYmJveCwgYmJveCk7CiAgICAgIGNvbnN0IGFyID0gYXJlYShjaGlsZE5vZGUuYmJveCk7CiAgICAgIGlmIChlbmwgPCBtaW5FbmxhcmdlbWVudCB8fCBlbmwgPT09IG1pbkVubGFyZ2VtZW50ICYmIGFyIDwgbWluQXJlYSkgewogICAgICAgIG1pbkVubGFyZ2VtZW50ID0gZW5sOwogICAgICAgIG1pbkFyZWEgPSBhcjsKICAgICAgICB0YXJnZXRQb2ludGVyID0gY2hpbGRQb2ludGVyOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGFyZ2V0UG9pbnRlcjsKICB9CiAgLyoqCiAgICogU3BsaXQgYW4gb3ZlcmZsb3dpbmcgbm9kZQogICAqLwogIF9zcGxpdChub2RlKSB7CiAgICBjb25zdCBjaGlsZHJlbiA9IG5vZGUuY2hpbGRyZW47CiAgICBjb25zdCBpc0xlYWYgPSBub2RlLmlzTGVhZjsKICAgIGxldCBtYXhEaXN0ID0gLUluZmluaXR5OwogICAgbGV0IHNlZWQxSWR4ID0gMCwgc2VlZDJJZHggPSAxOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICBmb3IgKGxldCBqID0gaSArIDE7IGogPCBjaGlsZHJlbi5sZW5ndGg7IGorKykgewogICAgICAgIGxldCBiYm94MSwgYmJveDI7CiAgICAgICAgaWYgKGlzTGVhZikgewogICAgICAgICAgYmJveDEgPSBjaGlsZHJlbltpXS5iYm94OwogICAgICAgICAgYmJveDIgPSBjaGlsZHJlbltqXS5iYm94OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCBub2RlMTIgPSB0aGlzLl9sb2FkTm9kZShjaGlsZHJlbltpXSk7CiAgICAgICAgICBjb25zdCBub2RlMjIgPSB0aGlzLl9sb2FkTm9kZShjaGlsZHJlbltqXSk7CiAgICAgICAgICBiYm94MSA9IG5vZGUxMi5iYm94OwogICAgICAgICAgYmJveDIgPSBub2RlMjIuYmJveDsKICAgICAgICB9CiAgICAgICAgY29uc3QgZGlzdCA9IGFyZWEodW5pb24oYmJveDEsIGJib3gyKSk7CiAgICAgICAgaWYgKGRpc3QgPiBtYXhEaXN0KSB7CiAgICAgICAgICBtYXhEaXN0ID0gZGlzdDsKICAgICAgICAgIHNlZWQxSWR4ID0gaTsKICAgICAgICAgIHNlZWQySWR4ID0gajsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IG5vZGUxID0gbmV3IFJUcmVlTm9kZSh0aGlzLCB7CiAgICAgIGlkOiB0aGlzLm5leHRJZCsrLAogICAgICBpc0xlYWYsCiAgICAgIGNoaWxkcmVuOiBbY2hpbGRyZW5bc2VlZDFJZHhdXSwKICAgICAgYmJveDogbnVsbAogICAgfSk7CiAgICBjb25zdCBub2RlMiA9IG5ldyBSVHJlZU5vZGUodGhpcywgewogICAgICBpZDogdGhpcy5uZXh0SWQrKywKICAgICAgaXNMZWFmLAogICAgICBjaGlsZHJlbjogW2NoaWxkcmVuW3NlZWQySWR4XV0sCiAgICAgIGJib3g6IG51bGwKICAgIH0pOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICBpZiAoaSA9PT0gc2VlZDFJZHggfHwgaSA9PT0gc2VlZDJJZHgpIGNvbnRpbnVlOwogICAgICBjb25zdCBjaGlsZCA9IGNoaWxkcmVuW2ldOwogICAgICBsZXQgYmJveDsKICAgICAgaWYgKGlzTGVhZikgewogICAgICAgIGJib3ggPSBjaGlsZC5iYm94OwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGNoaWxkTm9kZSA9IHRoaXMuX2xvYWROb2RlKGNoaWxkKTsKICAgICAgICBiYm94ID0gY2hpbGROb2RlLmJib3g7CiAgICAgIH0KICAgICAgbm9kZTEudXBkYXRlQkJveCgpOwogICAgICBub2RlMi51cGRhdGVCQm94KCk7CiAgICAgIGNvbnN0IGVubDEgPSBub2RlMS5iYm94ID8gZW5sYXJnZW1lbnQobm9kZTEuYmJveCwgYmJveCkgOiAwOwogICAgICBjb25zdCBlbmwyID0gbm9kZTIuYmJveCA/IGVubGFyZ2VtZW50KG5vZGUyLmJib3gsIGJib3gpIDogMDsKICAgICAgaWYgKGVubDEgPCBlbmwyKSB7CiAgICAgICAgbm9kZTEuY2hpbGRyZW4ucHVzaChjaGlsZCk7CiAgICAgIH0gZWxzZSBpZiAoZW5sMiA8IGVubDEpIHsKICAgICAgICBub2RlMi5jaGlsZHJlbi5wdXNoKGNoaWxkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAobm9kZTEuY2hpbGRyZW4ubGVuZ3RoIDw9IG5vZGUyLmNoaWxkcmVuLmxlbmd0aCkgewogICAgICAgICAgbm9kZTEuY2hpbGRyZW4ucHVzaChjaGlsZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG5vZGUyLmNoaWxkcmVuLnB1c2goY2hpbGQpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgbm9kZTEudXBkYXRlQkJveCgpOwogICAgbm9kZTIudXBkYXRlQkJveCgpOwogICAgY29uc3QgcG9pbnRlcjEgPSB0aGlzLl9zYXZlTm9kZShub2RlMSk7CiAgICBjb25zdCBwb2ludGVyMiA9IHRoaXMuX3NhdmVOb2RlKG5vZGUyKTsKICAgIHJldHVybiBbcG9pbnRlcjEsIHBvaW50ZXIyXTsKICB9CiAgLyoqCiAgICogU2VhcmNoIGZvciBwb2ludHMgd2l0aGluIGEgYm91bmRpbmcgYm94LCByZXR1cm5pbmcgZW50cmllcyB3aXRoIGNvb3JkcwogICAqLwogIHNlYXJjaEJCb3goYmJveCkgewogICAgaWYgKCF0aGlzLmlzT3BlbikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlItdHJlZSBmaWxlIG11c3QgYmUgb3BlbmVkIGJlZm9yZSB1c2UiKTsKICAgIH0KICAgIGNvbnN0IHJlc3VsdHMgPSBbXTsKICAgIGNvbnN0IHJvb3QgPSB0aGlzLl9sb2FkUm9vdCgpOwogICAgdGhpcy5fc2VhcmNoQkJveChiYm94LCByb290LCByZXN1bHRzKTsKICAgIHJldHVybiByZXN1bHRzOwogIH0KICAvKioKICAgKiBJbnRlcm5hbCBib3VuZGluZyBib3ggc2VhcmNoCiAgICovCiAgX3NlYXJjaEJCb3goYmJveCwgbm9kZSwgcmVzdWx0cykgewogICAgaWYgKCFub2RlLmJib3ggfHwgIWludGVyc2VjdHMoYmJveCwgbm9kZS5iYm94KSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAobm9kZS5pc0xlYWYpIHsKICAgICAgZm9yIChjb25zdCBlbnRyeSBvZiBub2RlLmNoaWxkcmVuKSB7CiAgICAgICAgaWYgKGludGVyc2VjdHMoYmJveCwgZW50cnkuYmJveCkpIHsKICAgICAgICAgIHJlc3VsdHMucHVzaCh7CiAgICAgICAgICAgIG9iamVjdElkOiBlbnRyeS5vYmplY3RJZCwKICAgICAgICAgICAgbGF0OiBlbnRyeS5sYXQsCiAgICAgICAgICAgIGxuZzogZW50cnkubG5nCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZvciAoY29uc3QgY2hpbGRQb2ludGVyIG9mIG5vZGUuY2hpbGRyZW4pIHsKICAgICAgICBjb25zdCBjaGlsZE5vZGUgPSB0aGlzLl9sb2FkTm9kZShjaGlsZFBvaW50ZXIpOwogICAgICAgIHRoaXMuX3NlYXJjaEJCb3goYmJveCwgY2hpbGROb2RlLCByZXN1bHRzKTsKICAgICAgfQogICAgfQogIH0KICAvKioKICAgKiBTZWFyY2ggZm9yIHBvaW50cyB3aXRoaW4gYSByYWRpdXMgb2YgYSBsb2NhdGlvbiwgcmV0dXJuaW5nIE9iamVjdElkcyB3aXRoIGRpc3RhbmNlcwogICAqLwogIHNlYXJjaFJhZGl1cyhsYXQsIGxuZywgcmFkaXVzS20pIHsKICAgIGNvbnN0IGJib3ggPSByYWRpdXNUb0JvdW5kaW5nQm94KGxhdCwgbG5nLCByYWRpdXNLbSk7CiAgICBjb25zdCByb290ID0gdGhpcy5fbG9hZFJvb3QoKTsKICAgIGNvbnN0IGVudHJpZXMgPSBbXTsKICAgIHRoaXMuX3NlYXJjaEJCb3hFbnRyaWVzKGJib3gsIHJvb3QsIGVudHJpZXMpOwogICAgY29uc3QgcmVzdWx0cyA9IFtdOwogICAgZm9yIChjb25zdCBlbnRyeSBvZiBlbnRyaWVzKSB7CiAgICAgIGNvbnN0IGRpc3QgPSBoYXZlcnNpbmVEaXN0YW5jZShsYXQsIGxuZywgZW50cnkubGF0LCBlbnRyeS5sbmcpOwogICAgICBpZiAoZGlzdCA8PSByYWRpdXNLbSkgewogICAgICAgIHJlc3VsdHMucHVzaCh7CiAgICAgICAgICBvYmplY3RJZDogZW50cnkub2JqZWN0SWQsCiAgICAgICAgICBsYXQ6IGVudHJ5LmxhdCwKICAgICAgICAgIGxuZzogZW50cnkubG5nLAogICAgICAgICAgZGlzdGFuY2U6IGRpc3QKICAgICAgICB9KTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdHM7CiAgfQogIC8qKgogICAqIEludGVybmFsIGJvdW5kaW5nIGJveCBzZWFyY2ggdGhhdCByZXR1cm5zIGZ1bGwgZW50cmllcyAodXNlZCBieSByYWRpdXMgc2VhcmNoKQogICAqLwogIF9zZWFyY2hCQm94RW50cmllcyhiYm94LCBub2RlLCByZXN1bHRzKSB7CiAgICBpZiAoIW5vZGUuYmJveCB8fCAhaW50ZXJzZWN0cyhiYm94LCBub2RlLmJib3gpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChub2RlLmlzTGVhZikgewogICAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIG5vZGUuY2hpbGRyZW4pIHsKICAgICAgICBpZiAoaW50ZXJzZWN0cyhiYm94LCBlbnRyeS5iYm94KSkgewogICAgICAgICAgcmVzdWx0cy5wdXNoKGVudHJ5KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZvciAoY29uc3QgY2hpbGRQb2ludGVyIG9mIG5vZGUuY2hpbGRyZW4pIHsKICAgICAgICBjb25zdCBjaGlsZE5vZGUgPSB0aGlzLl9sb2FkTm9kZShjaGlsZFBvaW50ZXIpOwogICAgICAgIHRoaXMuX3NlYXJjaEJCb3hFbnRyaWVzKGJib3gsIGNoaWxkTm9kZSwgcmVzdWx0cyk7CiAgICAgIH0KICAgIH0KICB9CiAgLyoqCiAgICogUmVtb3ZlIGFuIGVudHJ5IGZyb20gdGhlIFItdHJlZSBieSBPYmplY3RJZAogICAqLwogIHJlbW92ZShvYmplY3RJZCkgewogICAgaWYgKCF0aGlzLmlzT3BlbikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlItdHJlZSBmaWxlIG11c3QgYmUgb3BlbmVkIGJlZm9yZSB1c2UiKTsKICAgIH0KICAgIGlmICghKG9iamVjdElkIGluc3RhbmNlb2YgT2JqZWN0SWQpKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigib2JqZWN0SWQgbXVzdCBiZSBhbiBpbnN0YW5jZSBvZiBPYmplY3RJZCB0byByZW1vdmUgZnJvbSBydHJlZSIpOwogICAgfQogICAgY29uc3Qgcm9vdCA9IHRoaXMuX2xvYWRSb290KCk7CiAgICBjb25zdCByZXN1bHQgPSB0aGlzLl9yZW1vdmUob2JqZWN0SWQsIHJvb3QpOwogICAgaWYgKCFyZXN1bHQuZm91bmQpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgaWYgKHJlc3VsdC51bmRlcmZsb3cgJiYgcmVzdWx0LmNoaWxkcmVuKSB7CiAgICAgIGlmIChyZXN1bHQuY2hpbGRyZW4ubGVuZ3RoID09PSAwKSB7CiAgICAgICAgY29uc3QgbmV3Um9vdCA9IG5ldyBSVHJlZU5vZGUodGhpcywgewogICAgICAgICAgaWQ6IHRoaXMubmV4dElkKyssCiAgICAgICAgICBpc0xlYWY6IHRydWUsCiAgICAgICAgICBjaGlsZHJlbjogW10sCiAgICAgICAgICBiYm94OiBudWxsCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5yb290UG9pbnRlciA9IHRoaXMuX3NhdmVOb2RlKG5ld1Jvb3QpOwogICAgICB9IGVsc2UgaWYgKHJlc3VsdC5jaGlsZHJlbi5sZW5ndGggPT09IDEgJiYgIXJlc3VsdC5pc0xlYWYpIHsKICAgICAgICB0aGlzLnJvb3RQb2ludGVyID0gcmVzdWx0LmNoaWxkcmVuWzBdOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IG5ld1Jvb3QgPSBuZXcgUlRyZWVOb2RlKHRoaXMsIHsKICAgICAgICAgIGlkOiByb290LmlkLAogICAgICAgICAgaXNMZWFmOiByZXN1bHQuaXNMZWFmLAogICAgICAgICAgY2hpbGRyZW46IHJlc3VsdC5jaGlsZHJlbiwKICAgICAgICAgIGJib3g6IG51bGwKICAgICAgICB9KTsKICAgICAgICBuZXdSb290LnVwZGF0ZUJCb3goKTsKICAgICAgICB0aGlzLnJvb3RQb2ludGVyID0gdGhpcy5fc2F2ZU5vZGUobmV3Um9vdCk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAocmVzdWx0LnBvaW50ZXIpIHsKICAgICAgdGhpcy5yb290UG9pbnRlciA9IHJlc3VsdC5wb2ludGVyOwogICAgfQogICAgdGhpcy5fc2l6ZS0tOwogICAgdGhpcy5fd3JpdGVNZXRhZGF0YSgpOwogICAgcmV0dXJuIHRydWU7CiAgfQogIC8qKgogICAqIEludGVybmFsIHJlbW92ZSBtZXRob2QKICAgKiBSZXR1cm5zOiB7IGZvdW5kOiBib29sZWFuLCB1bmRlcmZsb3c6IGJvb2xlYW4sIHBvaW50ZXI6IFBvaW50ZXIsIGNoaWxkcmVuOiBBcnJheSwgaXNMZWFmOiBib29sZWFuIH0KICAgKi8KICBfcmVtb3ZlKG9iamVjdElkLCBub2RlKSB7CiAgICBpZiAobm9kZS5pc0xlYWYpIHsKICAgICAgY29uc3QgaW5pdGlhbExlbmd0aCA9IG5vZGUuY2hpbGRyZW4ubGVuZ3RoOwogICAgICBub2RlLmNoaWxkcmVuID0gbm9kZS5jaGlsZHJlbi5maWx0ZXIoCiAgICAgICAgKGVudHJ5KSA9PiAhZW50cnkub2JqZWN0SWQuZXF1YWxzKG9iamVjdElkKQogICAgICApOwogICAgICBpZiAobm9kZS5jaGlsZHJlbi5sZW5ndGggPT09IGluaXRpYWxMZW5ndGgpIHsKICAgICAgICByZXR1cm4geyBmb3VuZDogZmFsc2UgfTsKICAgICAgfQogICAgICBub2RlLnVwZGF0ZUJCb3goKTsKICAgICAgY29uc3QgcG9pbnRlciA9IHRoaXMuX3NhdmVOb2RlKG5vZGUpOwogICAgICBjb25zdCB1bmRlcmZsb3cgPSBub2RlLmNoaWxkcmVuLmxlbmd0aCA8IHRoaXMubWluRW50cmllcyAmJiBub2RlLmNoaWxkcmVuLmxlbmd0aCA+IDA7CiAgICAgIHJldHVybiB7CiAgICAgICAgZm91bmQ6IHRydWUsCiAgICAgICAgdW5kZXJmbG93LAogICAgICAgIHBvaW50ZXIsCiAgICAgICAgY2hpbGRyZW46IG5vZGUuY2hpbGRyZW4sCiAgICAgICAgaXNMZWFmOiB0cnVlCiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICBsZXQgdXBkYXRlZENoaWxkcmVuID0gWy4uLm5vZGUuY2hpbGRyZW5dOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHVwZGF0ZWRDaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGNoaWxkUG9pbnRlciA9IHVwZGF0ZWRDaGlsZHJlbltpXTsKICAgICAgICBjb25zdCBjaGlsZE5vZGUgPSB0aGlzLl9sb2FkTm9kZShjaGlsZFBvaW50ZXIpOwogICAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuX3JlbW92ZShvYmplY3RJZCwgY2hpbGROb2RlKTsKICAgICAgICBpZiAocmVzdWx0LmZvdW5kKSB7CiAgICAgICAgICBpZiAocmVzdWx0LnVuZGVyZmxvdykgewogICAgICAgICAgICBjb25zdCBoYW5kbGVkID0gdGhpcy5faGFuZGxlVW5kZXJmbG93KG5vZGUsIGksIGNoaWxkTm9kZSwgcmVzdWx0KTsKICAgICAgICAgICAgaWYgKGhhbmRsZWQubWVyZ2VkKSB7CiAgICAgICAgICAgICAgdXBkYXRlZENoaWxkcmVuID0gaGFuZGxlZC5jaGlsZHJlbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB1cGRhdGVkQ2hpbGRyZW5baV0gPSByZXN1bHQucG9pbnRlcjsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdXBkYXRlZENoaWxkcmVuW2ldID0gcmVzdWx0LnBvaW50ZXI7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCB1cGRhdGVkTm9kZSA9IG5ldyBSVHJlZU5vZGUodGhpcywgewogICAgICAgICAgICBpZDogbm9kZS5pZCwKICAgICAgICAgICAgaXNMZWFmOiBmYWxzZSwKICAgICAgICAgICAgY2hpbGRyZW46IHVwZGF0ZWRDaGlsZHJlbiwKICAgICAgICAgICAgYmJveDogbnVsbAogICAgICAgICAgfSk7CiAgICAgICAgICB1cGRhdGVkTm9kZS51cGRhdGVCQm94KCk7CiAgICAgICAgICBjb25zdCBwb2ludGVyID0gdGhpcy5fc2F2ZU5vZGUodXBkYXRlZE5vZGUpOwogICAgICAgICAgY29uc3QgdW5kZXJmbG93ID0gdXBkYXRlZENoaWxkcmVuLmxlbmd0aCA8IHRoaXMubWluRW50cmllcyAmJiB1cGRhdGVkQ2hpbGRyZW4ubGVuZ3RoID4gMDsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGZvdW5kOiB0cnVlLAogICAgICAgICAgICB1bmRlcmZsb3csCiAgICAgICAgICAgIHBvaW50ZXIsCiAgICAgICAgICAgIGNoaWxkcmVuOiB1cGRhdGVkQ2hpbGRyZW4sCiAgICAgICAgICAgIGlzTGVhZjogZmFsc2UKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB7IGZvdW5kOiBmYWxzZSB9OwogICAgfQogIH0KICAvKioKICAgKiBIYW5kbGUgdW5kZXJmbG93IGluIGEgY2hpbGQgbm9kZSBieSBtZXJnaW5nIG9yIHJlZGlzdHJpYnV0aW5nCiAgICovCiAgX2hhbmRsZVVuZGVyZmxvdyhwYXJlbnROb2RlLCBjaGlsZEluZGV4LCBjaGlsZE5vZGUsIGNoaWxkUmVzdWx0KSB7CiAgICBjb25zdCBzaWJsaW5ncyA9IFtdOwogICAgaWYgKGNoaWxkSW5kZXggPiAwKSB7CiAgICAgIGNvbnN0IHByZXZQb2ludGVyID0gcGFyZW50Tm9kZS5jaGlsZHJlbltjaGlsZEluZGV4IC0gMV07CiAgICAgIGNvbnN0IHByZXZOb2RlID0gdGhpcy5fbG9hZE5vZGUocHJldlBvaW50ZXIpOwogICAgICBzaWJsaW5ncy5wdXNoKHsgaW5kZXg6IGNoaWxkSW5kZXggLSAxLCBub2RlOiBwcmV2Tm9kZSwgcG9pbnRlcjogcHJldlBvaW50ZXIgfSk7CiAgICB9CiAgICBpZiAoY2hpbGRJbmRleCA8IHBhcmVudE5vZGUuY2hpbGRyZW4ubGVuZ3RoIC0gMSkgewogICAgICBjb25zdCBuZXh0UG9pbnRlciA9IHBhcmVudE5vZGUuY2hpbGRyZW5bY2hpbGRJbmRleCArIDFdOwogICAgICBjb25zdCBuZXh0Tm9kZSA9IHRoaXMuX2xvYWROb2RlKG5leHRQb2ludGVyKTsKICAgICAgc2libGluZ3MucHVzaCh7IGluZGV4OiBjaGlsZEluZGV4ICsgMSwgbm9kZTogbmV4dE5vZGUsIHBvaW50ZXI6IG5leHRQb2ludGVyIH0pOwogICAgfQogICAgZm9yIChjb25zdCBzaWJsaW5nIG9mIHNpYmxpbmdzKSB7CiAgICAgIGlmIChzaWJsaW5nLm5vZGUuY2hpbGRyZW4ubGVuZ3RoID4gdGhpcy5taW5FbnRyaWVzKSB7CiAgICAgICAgY29uc3QgYWxsQ2hpbGRyZW4gPSBbCiAgICAgICAgICAuLi5jaGlsZFJlc3VsdC5jaGlsZHJlbiwKICAgICAgICAgIC4uLnNpYmxpbmcubm9kZS5jaGlsZHJlbgogICAgICAgIF07CiAgICAgICAgY29uc3QgbWlkID0gTWF0aC5jZWlsKGFsbENoaWxkcmVuLmxlbmd0aCAvIDIpOwogICAgICAgIGNvbnN0IG5ld0NoaWxkMUNoaWxkcmVuID0gYWxsQ2hpbGRyZW4uc2xpY2UoMCwgbWlkKTsKICAgICAgICBjb25zdCBuZXdDaGlsZDJDaGlsZHJlbiA9IGFsbENoaWxkcmVuLnNsaWNlKG1pZCk7CiAgICAgICAgY29uc3QgbmV3Q2hpbGQxID0gbmV3IFJUcmVlTm9kZSh0aGlzLCB7CiAgICAgICAgICBpZDogY2hpbGROb2RlLmlkLAogICAgICAgICAgaXNMZWFmOiBjaGlsZFJlc3VsdC5pc0xlYWYsCiAgICAgICAgICBjaGlsZHJlbjogbmV3Q2hpbGQxQ2hpbGRyZW4sCiAgICAgICAgICBiYm94OiBudWxsCiAgICAgICAgfSk7CiAgICAgICAgbmV3Q2hpbGQxLnVwZGF0ZUJCb3goKTsKICAgICAgICBjb25zdCBuZXdDaGlsZDIgPSBuZXcgUlRyZWVOb2RlKHRoaXMsIHsKICAgICAgICAgIGlkOiBzaWJsaW5nLm5vZGUuaWQsCiAgICAgICAgICBpc0xlYWY6IHNpYmxpbmcubm9kZS5pc0xlYWYsCiAgICAgICAgICBjaGlsZHJlbjogbmV3Q2hpbGQyQ2hpbGRyZW4sCiAgICAgICAgICBiYm94OiBudWxsCiAgICAgICAgfSk7CiAgICAgICAgbmV3Q2hpbGQyLnVwZGF0ZUJCb3goKTsKICAgICAgICBjb25zdCBwb2ludGVyMSA9IHRoaXMuX3NhdmVOb2RlKG5ld0NoaWxkMSk7CiAgICAgICAgY29uc3QgcG9pbnRlcjIgPSB0aGlzLl9zYXZlTm9kZShuZXdDaGlsZDIpOwogICAgICAgIGNvbnN0IG5ld0NoaWxkcmVuID0gWy4uLnBhcmVudE5vZGUuY2hpbGRyZW5dOwogICAgICAgIGNvbnN0IG1pbkluZGV4ID0gTWF0aC5taW4oY2hpbGRJbmRleCwgc2libGluZy5pbmRleCk7CiAgICAgICAgY29uc3QgbWF4SW5kZXggPSBNYXRoLm1heChjaGlsZEluZGV4LCBzaWJsaW5nLmluZGV4KTsKICAgICAgICBuZXdDaGlsZHJlblttaW5JbmRleF0gPSBwb2ludGVyMTsKICAgICAgICBuZXdDaGlsZHJlblttYXhJbmRleF0gPSBwb2ludGVyMjsKICAgICAgICByZXR1cm4geyBtZXJnZWQ6IHRydWUsIGNoaWxkcmVuOiBuZXdDaGlsZHJlbiB9OwogICAgICB9CiAgICB9CiAgICBpZiAoc2libGluZ3MubGVuZ3RoID4gMCkgewogICAgICBjb25zdCBzaWJsaW5nID0gc2libGluZ3NbMF07CiAgICAgIGNvbnN0IG1lcmdlZENoaWxkcmVuID0gWwogICAgICAgIC4uLmNoaWxkUmVzdWx0LmNoaWxkcmVuLAogICAgICAgIC4uLnNpYmxpbmcubm9kZS5jaGlsZHJlbgogICAgICBdOwogICAgICBjb25zdCBtZXJnZWROb2RlID0gbmV3IFJUcmVlTm9kZSh0aGlzLCB7CiAgICAgICAgaWQ6IHRoaXMubmV4dElkKyssCiAgICAgICAgaXNMZWFmOiBjaGlsZFJlc3VsdC5pc0xlYWYsCiAgICAgICAgY2hpbGRyZW46IG1lcmdlZENoaWxkcmVuLAogICAgICAgIGJib3g6IG51bGwKICAgICAgfSk7CiAgICAgIG1lcmdlZE5vZGUudXBkYXRlQkJveCgpOwogICAgICBjb25zdCBtZXJnZWRQb2ludGVyID0gdGhpcy5fc2F2ZU5vZGUobWVyZ2VkTm9kZSk7CiAgICAgIGNvbnN0IG5ld0NoaWxkcmVuID0gcGFyZW50Tm9kZS5jaGlsZHJlbi5maWx0ZXIoCiAgICAgICAgKF8sIGkpID0+IGkgIT09IGNoaWxkSW5kZXggJiYgaSAhPT0gc2libGluZy5pbmRleAogICAgICApOwogICAgICBuZXdDaGlsZHJlbi5wdXNoKG1lcmdlZFBvaW50ZXIpOwogICAgICByZXR1cm4geyBtZXJnZWQ6IHRydWUsIGNoaWxkcmVuOiBuZXdDaGlsZHJlbiB9OwogICAgfQogICAgcmV0dXJuIHsgbWVyZ2VkOiBmYWxzZSB9OwogIH0KICAvKioKICAgKiBHZXQgdGhlIG51bWJlciBvZiBlbnRyaWVzIGluIHRoZSB0cmVlCiAgICovCiAgc2l6ZSgpIHsKICAgIHJldHVybiB0aGlzLl9zaXplOwogIH0KICAvKioKICAgKiBDbGVhciBhbGwgZW50cmllcyBmcm9tIHRoZSB0cmVlIGJ5IGFwcGVuZGluZyBhIG5ldyBlbXB0eSByb290IG5vZGUKICAgKiBQcmVzZXJ2ZXMgdGhlIGFwcGVuZC1vbmx5IGZpbGUgc3RydWN0dXJlCiAgICovCiAgYXN5bmMgY2xlYXIoKSB7CiAgICBjb25zdCBuZXdSb290ID0gbmV3IFJUcmVlTm9kZSh0aGlzLCB7CiAgICAgIGlkOiB0aGlzLm5leHRJZCsrLAogICAgICBpc0xlYWY6IHRydWUsCiAgICAgIGNoaWxkcmVuOiBbXSwKICAgICAgYmJveDogbnVsbAogICAgfSk7CiAgICB0aGlzLnJvb3RQb2ludGVyID0gdGhpcy5fc2F2ZU5vZGUobmV3Um9vdCk7CiAgICB0aGlzLl9zaXplID0gMDsKICAgIHRoaXMuX3dyaXRlTWV0YWRhdGEoKTsKICB9CiAgLyoqCiAgICogQ29tcGFjdCB0aGUgUi10cmVlIGJ5IGNvcHlpbmcgdGhlIGN1cnJlbnQgcm9vdCBhbmQgYWxsIHJlYWNoYWJsZSBub2RlcyBpbnRvIGEgbmV3IGZpbGUuCiAgICogUmV0dXJucyBzaXplIG1ldHJpY3MgdG8gc2hvdyByZWNsYWltZWQgc3BhY2UuCiAgICogQHBhcmFtIHtGaWxlU3lzdGVtU3luY0FjY2Vzc0hhbmRsZX0gZGVzdFN5bmNIYW5kbGUgLSBTeW5jIGhhbmRsZSBmb3IgZGVzdGluYXRpb24gZmlsZQogICAqLwogIGFzeW5jIGNvbXBhY3QoZGVzdFN5bmNIYW5kbGUpIHsKICAgIGlmICghdGhpcy5pc09wZW4pIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJSLXRyZWUgZmlsZSBtdXN0IGJlIG9wZW5lZCBiZWZvcmUgdXNlIik7CiAgICB9CiAgICBpZiAoIWRlc3RTeW5jSGFuZGxlKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiRGVzdGluYXRpb24gc3luYyBoYW5kbGUgaXMgcmVxdWlyZWQgZm9yIGNvbXBhY3Rpb24iKTsKICAgIH0KICAgIHRoaXMuX3dyaXRlTWV0YWRhdGEoKTsKICAgIGNvbnN0IG9sZFNpemUgPSB0aGlzLmZpbGUuZ2V0RmlsZVNpemUoKTsKICAgIGNvbnN0IGRlc3QgPSBuZXcgUlRyZWUoZGVzdFN5bmNIYW5kbGUsIHRoaXMubWF4RW50cmllcyk7CiAgICBhd2FpdCBkZXN0Lm9wZW4oKTsKICAgIGRlc3QubWluRW50cmllcyA9IHRoaXMubWluRW50cmllczsKICAgIGRlc3QubmV4dElkID0gdGhpcy5uZXh0SWQ7CiAgICBkZXN0Ll9zaXplID0gdGhpcy5fc2l6ZTsKICAgIGNvbnN0IHBvaW50ZXJNYXAgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgY29uc3QgY2xvbmVOb2RlID0gKHBvaW50ZXIpID0+IHsKICAgICAgY29uc3Qgb2Zmc2V0ID0gcG9pbnRlci52YWx1ZU9mKCk7CiAgICAgIGlmIChwb2ludGVyTWFwLmhhcyhvZmZzZXQpKSB7CiAgICAgICAgcmV0dXJuIHBvaW50ZXJNYXAuZ2V0KG9mZnNldCk7CiAgICAgIH0KICAgICAgY29uc3Qgc291cmNlTm9kZSA9IHRoaXMuX2xvYWROb2RlKHBvaW50ZXIpOwogICAgICBjb25zdCBjbG9uZWRDaGlsZHJlbiA9IFtdOwogICAgICBpZiAoc291cmNlTm9kZS5pc0xlYWYpIHsKICAgICAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIHNvdXJjZU5vZGUuY2hpbGRyZW4pIHsKICAgICAgICAgIGNsb25lZENoaWxkcmVuLnB1c2goY2hpbGQpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBmb3IgKGNvbnN0IGNoaWxkUG9pbnRlciBvZiBzb3VyY2VOb2RlLmNoaWxkcmVuKSB7CiAgICAgICAgICBjb25zdCBuZXdDaGlsZFB0ciA9IGNsb25lTm9kZShjaGlsZFBvaW50ZXIpOwogICAgICAgICAgY2xvbmVkQ2hpbGRyZW4ucHVzaChuZXdDaGlsZFB0cik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IGNsb25lZE5vZGUgPSBuZXcgUlRyZWVOb2RlKGRlc3QsIHsKICAgICAgICBpZDogc291cmNlTm9kZS5pZCwKICAgICAgICBpc0xlYWY6IHNvdXJjZU5vZGUuaXNMZWFmLAogICAgICAgIGNoaWxkcmVuOiBjbG9uZWRDaGlsZHJlbiwKICAgICAgICBiYm94OiBzb3VyY2VOb2RlLmJib3gKICAgICAgfSk7CiAgICAgIGNvbnN0IG5ld1BvaW50ZXIgPSBkZXN0Ll9zYXZlTm9kZShjbG9uZWROb2RlKTsKICAgICAgcG9pbnRlck1hcC5zZXQob2Zmc2V0LCBuZXdQb2ludGVyKTsKICAgICAgcmV0dXJuIG5ld1BvaW50ZXI7CiAgICB9OwogICAgY29uc3QgbmV3Um9vdFBvaW50ZXIgPSBjbG9uZU5vZGUodGhpcy5yb290UG9pbnRlcik7CiAgICBkZXN0LnJvb3RQb2ludGVyID0gbmV3Um9vdFBvaW50ZXI7CiAgICBkZXN0Ll93cml0ZU1ldGFkYXRhKCk7CiAgICBjb25zdCBuZXdTaXplID0gZGVzdC5maWxlLmdldEZpbGVTaXplKCk7CiAgICBhd2FpdCBkZXN0LmNsb3NlKCk7CiAgICByZXR1cm4gewogICAgICBvbGRTaXplLAogICAgICBuZXdTaXplLAogICAgICBieXRlc1NhdmVkOiBNYXRoLm1heCgwLCBvbGRTaXplIC0gbmV3U2l6ZSkKICAgIH07CiAgfQp9CmNsYXNzIEdlb3NwYXRpYWxJbmRleCBleHRlbmRzIEluZGV4IHsKICBjb25zdHJ1Y3RvcihpbmRleE5hbWUsIGtleXMsIHN0b3JhZ2VGaWxlLCBvcHRpb25zID0ge30pIHsKICAgIHN1cGVyKGluZGV4TmFtZSwga2V5cywgc3RvcmFnZUZpbGUsIG9wdGlvbnMpOwogICAgdGhpcy5nZW9GaWVsZCA9IE9iamVjdC5rZXlzKGtleXMpWzBdOwogICAgdGhpcy5zdG9yYWdlRmlsZVBhdGggPSBzdG9yYWdlRmlsZTsKICAgIHRoaXMucnRyZWUgPSBudWxsOwogICAgdGhpcy5zeW5jSGFuZGxlID0gbnVsbDsKICAgIHRoaXMuaXNPcGVuID0gZmFsc2U7CiAgfQogIC8qKgogICAqIE9wZW4gdGhlIGluZGV4IGZpbGUKICAgKiBNdXN0IGJlIGNhbGxlZCBiZWZvcmUgdXNpbmcgdGhlIGluZGV4CiAgICovCiAgYXN5bmMgb3BlbigpIHsKICAgIGlmICh0aGlzLmlzT3BlbikgewogICAgICByZXR1cm47CiAgICB9CiAgICB0cnkgewogICAgICBjb25zdCBwYXRoUGFydHMgPSB0aGlzLnN0b3JhZ2VGaWxlUGF0aC5zcGxpdCgiLyIpLmZpbHRlcihCb29sZWFuKTsKICAgICAgY29uc3QgZmlsZW5hbWUgPSBwYXRoUGFydHMucG9wKCk7CiAgICAgIGlmICghZmlsZW5hbWUpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgc3RvcmFnZSBwYXRoOiAke3RoaXMuc3RvcmFnZUZpbGVQYXRofWApOwogICAgICB9CiAgICAgIGxldCBkaXJIYW5kbGUgPSBhd2FpdCBnbG9iYWxUaGlzLm5hdmlnYXRvci5zdG9yYWdlLmdldERpcmVjdG9yeSgpOwogICAgICBmb3IgKGNvbnN0IHBhcnQgb2YgcGF0aFBhcnRzKSB7CiAgICAgICAgZGlySGFuZGxlID0gYXdhaXQgZGlySGFuZGxlLmdldERpcmVjdG9yeUhhbmRsZShwYXJ0LCB7IGNyZWF0ZTogdHJ1ZSB9KTsKICAgICAgfQogICAgICBjb25zdCBmaWxlSGFuZGxlID0gYXdhaXQgZGlySGFuZGxlLmdldEZpbGVIYW5kbGUoZmlsZW5hbWUsIHsgY3JlYXRlOiB0cnVlIH0pOwogICAgICB0aGlzLnN5bmNIYW5kbGUgPSBhd2FpdCBmaWxlSGFuZGxlLmNyZWF0ZVN5bmNBY2Nlc3NIYW5kbGUoKTsKICAgICAgdGhpcy5ydHJlZSA9IG5ldyBSVHJlZSh0aGlzLnN5bmNIYW5kbGUsIDkpOwogICAgICBhd2FpdCB0aGlzLnJ0cmVlLm9wZW4oKTsKICAgICAgdGhpcy5pc09wZW4gPSB0cnVlOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGVycm9yLmNvZGUgPT09ICJFTk9FTlQiIHx8IGVycm9yLm1lc3NhZ2UgJiYgKGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoIkludmFsaWQgUi10cmVlIikgfHwgZXJyb3IubWVzc2FnZS5pbmNsdWRlcygiZmlsZSB0b28gc21hbGwiKSB8fCBlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCJGYWlsZWQgdG8gcmVhZCBtZXRhZGF0YSIpIHx8IGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoIlVua25vd24gdHlwZSBieXRlIikpKSB7CiAgICAgICAgaWYgKHRoaXMuc3luY0hhbmRsZSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgdGhpcy5zeW5jSGFuZGxlLmNsb3NlKCk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLnN5bmNIYW5kbGUgPSBudWxsOwogICAgICAgIH0KICAgICAgICBjb25zdCBwYXRoUGFydHMgPSB0aGlzLnN0b3JhZ2VGaWxlUGF0aC5zcGxpdCgiLyIpLmZpbHRlcihCb29sZWFuKTsKICAgICAgICBjb25zdCBmaWxlbmFtZSA9IHBhdGhQYXJ0cy5wb3AoKTsKICAgICAgICBpZiAoIWZpbGVuYW1lKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgc3RvcmFnZSBwYXRoOiAke3RoaXMuc3RvcmFnZUZpbGVQYXRofWApOwogICAgICAgIH0KICAgICAgICBsZXQgZGlySGFuZGxlID0gYXdhaXQgZ2xvYmFsVGhpcy5uYXZpZ2F0b3Iuc3RvcmFnZS5nZXREaXJlY3RvcnkoKTsKICAgICAgICBmb3IgKGNvbnN0IHBhcnQgb2YgcGF0aFBhcnRzKSB7CiAgICAgICAgICBkaXJIYW5kbGUgPSBhd2FpdCBkaXJIYW5kbGUuZ2V0RGlyZWN0b3J5SGFuZGxlKHBhcnQsIHsgY3JlYXRlOiB0cnVlIH0pOwogICAgICAgIH0KICAgICAgICB0cnkgewogICAgICAgICAgYXdhaXQgZGlySGFuZGxlLnJlbW92ZUVudHJ5KGZpbGVuYW1lKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGZpbGVIYW5kbGUgPSBhd2FpdCBkaXJIYW5kbGUuZ2V0RmlsZUhhbmRsZShmaWxlbmFtZSwgeyBjcmVhdGU6IHRydWUgfSk7CiAgICAgICAgdGhpcy5zeW5jSGFuZGxlID0gYXdhaXQgZmlsZUhhbmRsZS5jcmVhdGVTeW5jQWNjZXNzSGFuZGxlKCk7CiAgICAgICAgdGhpcy5ydHJlZSA9IG5ldyBSVHJlZSh0aGlzLnN5bmNIYW5kbGUsIDkpOwogICAgICAgIGF3YWl0IHRoaXMucnRyZWUub3BlbigpOwogICAgICAgIHRoaXMuaXNPcGVuID0gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgfQogICAgfQogIH0KICAvKioKICAgKiBDbG9zZSB0aGUgaW5kZXggZmlsZQogICAqLwogIGFzeW5jIGNsb3NlKCkgewogICAgaWYgKHRoaXMuaXNPcGVuKSB7CiAgICAgIHRyeSB7CiAgICAgICAgYXdhaXQgdGhpcy5ydHJlZS5jbG9zZSgpOwogICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIGlmICghZXJyb3IubWVzc2FnZSB8fCAhZXJyb3IubWVzc2FnZS5pbmNsdWRlcygiRmlsZSBpcyBub3Qgb3BlbiIpKSB7CiAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5pc09wZW4gPSBmYWxzZTsKICAgIH0KICB9CiAgLyoqCiAgICogRXh0cmFjdCBjb29yZGluYXRlcyBmcm9tIGEgR2VvSlNPTiBvYmplY3QKICAgKiBAcGFyYW0ge09iamVjdH0gZ2VvSnNvbiAtIFRoZSBHZW9KU09OIG9iamVjdAogICAqIEByZXR1cm5zIHtPYmplY3R8bnVsbH0gT2JqZWN0IHdpdGggbGF0IGFuZCBsbmcsIG9yIG51bGwgaWYgaW52YWxpZAogICAqLwogIF9leHRyYWN0Q29vcmRpbmF0ZXMoZ2VvSnNvbikgewogICAgaWYgKCFnZW9Kc29uKSByZXR1cm4gbnVsbDsKICAgIGlmIChnZW9Kc29uLnR5cGUgPT09ICJGZWF0dXJlQ29sbGVjdGlvbiIgJiYgZ2VvSnNvbi5mZWF0dXJlcyAmJiBnZW9Kc29uLmZlYXR1cmVzLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgZmVhdHVyZSA9IGdlb0pzb24uZmVhdHVyZXNbMF07CiAgICAgIGlmIChmZWF0dXJlLmdlb21ldHJ5KSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2V4dHJhY3RDb29yZGluYXRlcyhmZWF0dXJlLmdlb21ldHJ5KTsKICAgICAgfQogICAgfQogICAgaWYgKGdlb0pzb24udHlwZSA9PT0gIkZlYXR1cmUiICYmIGdlb0pzb24uZ2VvbWV0cnkpIHsKICAgICAgcmV0dXJuIHRoaXMuX2V4dHJhY3RDb29yZGluYXRlcyhnZW9Kc29uLmdlb21ldHJ5KTsKICAgIH0KICAgIGlmIChnZW9Kc29uLnR5cGUgPT09ICJQb2ludCIgJiYgZ2VvSnNvbi5jb29yZGluYXRlcykgewogICAgICBjb25zdCBbbG5nLCBsYXRdID0gZ2VvSnNvbi5jb29yZGluYXRlczsKICAgICAgaWYgKHR5cGVvZiBsbmcgPT09ICJudW1iZXIiICYmIHR5cGVvZiBsYXQgPT09ICJudW1iZXIiKSB7CiAgICAgICAgcmV0dXJuIHsgbGF0LCBsbmcgfTsKICAgICAgfQogICAgfQogICAgaWYgKGdlb0pzb24udHlwZSA9PT0gIlBvbHlnb24iICYmIGdlb0pzb24uY29vcmRpbmF0ZXMgJiYgZ2VvSnNvbi5jb29yZGluYXRlcy5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IHJpbmcgPSBnZW9Kc29uLmNvb3JkaW5hdGVzWzBdOwogICAgICBpZiAocmluZy5sZW5ndGggPiAwKSB7CiAgICAgICAgbGV0IHN1bUxhdCA9IDAsIHN1bUxuZyA9IDA7CiAgICAgICAgZm9yIChjb25zdCBjb29yZCBvZiByaW5nKSB7CiAgICAgICAgICBzdW1MbmcgKz0gY29vcmRbMF07CiAgICAgICAgICBzdW1MYXQgKz0gY29vcmRbMV07CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICBsYXQ6IHN1bUxhdCAvIHJpbmcubGVuZ3RoLAogICAgICAgICAgbG5nOiBzdW1MbmcgLyByaW5nLmxlbmd0aAogICAgICAgIH07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBudWxsOwogIH0KICAvKioKICAgKiBBZGQgYSBkb2N1bWVudCB0byB0aGUgZ2Vvc3BhdGlhbCBpbmRleAogICAqIEBwYXJhbSB7T2JqZWN0fSBkb2MgLSBUaGUgZG9jdW1lbnQgdG8gaW5kZXgKICAgKi8KICBhc3luYyBhZGQoZG9jKSB7CiAgICBpZiAoIWRvYy5faWQpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJEb2N1bWVudCBtdXN0IGhhdmUgYW4gX2lkIGZpZWxkIik7CiAgICB9CiAgICBjb25zdCBnZW9WYWx1ZSA9IGdldFByb3AoZG9jLCB0aGlzLmdlb0ZpZWxkKTsKICAgIGNvbnN0IGNvb3JkcyA9IHRoaXMuX2V4dHJhY3RDb29yZGluYXRlcyhnZW9WYWx1ZSk7CiAgICBpZiAoY29vcmRzKSB7CiAgICAgIGF3YWl0IHRoaXMucnRyZWUuaW5zZXJ0KGNvb3Jkcy5sYXQsIGNvb3Jkcy5sbmcsIGRvYy5faWQpOwogICAgfQogIH0KICAvKioKICAgKiBSZW1vdmUgYSBkb2N1bWVudCBmcm9tIHRoZSBnZW9zcGF0aWFsIGluZGV4CiAgICogQHBhcmFtIHtPYmplY3R9IGRvYyAtIFRoZSBkb2N1bWVudCB0byByZW1vdmUKICAgKi8KICBhc3luYyByZW1vdmUoZG9jKSB7CiAgICBpZiAoIWRvYy5faWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKCEoZG9jLl9pZCBpbnN0YW5jZW9mIE9iamVjdElkKSkgewogICAgICBjb25zb2xlLmVycm9yKGRvYyk7CiAgICAgIHRocm93IG5ldyBFcnJvcigiRG9jdW1lbnQgX2lkIG11c3QgYmUgYW4gT2JqZWN0SWQgdG8gcmVtb3ZlIGZyb20gZ2Vvc3BhdGlhbCBpbmRleCIpOwogICAgfQogICAgYXdhaXQgdGhpcy5ydHJlZS5yZW1vdmUoZG9jLl9pZCk7CiAgfQogIC8qKgogICAqIFF1ZXJ5IHRoZSBnZW9zcGF0aWFsIGluZGV4CiAgICogQHBhcmFtIHsqfSBxdWVyeSAtIFRoZSBxdWVyeSBvYmplY3QKICAgKiBAcmV0dXJucyB7UHJvbWlzZTxBcnJheXxudWxsPn0gQXJyYXkgb2YgZG9jdW1lbnQgSURzIG9yIG51bGwgaWYgcXVlcnkgaXMgbm90IGEgZ2Vvc3BhdGlhbCBxdWVyeQogICAqLwogIGFzeW5jIHF1ZXJ5KHF1ZXJ5KSB7CiAgICBpZiAoIXRoaXMuaXNPcGVuKSB7CiAgICAgIGF3YWl0IHRoaXMub3BlbigpOwogICAgfQogICAgaWYgKCFxdWVyeVt0aGlzLmdlb0ZpZWxkXSkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGNvbnN0IGdlb1F1ZXJ5ID0gcXVlcnlbdGhpcy5nZW9GaWVsZF07CiAgICBpZiAoZ2VvUXVlcnkuJGdlb1dpdGhpbikgewogICAgICBjb25zdCBiYm94ID0gZ2VvUXVlcnkuJGdlb1dpdGhpbjsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkoYmJveCkgJiYgYmJveC5sZW5ndGggPT09IDIpIHsKICAgICAgICBjb25zdCBtaW5Mb24gPSBiYm94WzBdWzBdOwogICAgICAgIGNvbnN0IG1heExhdCA9IGJib3hbMF1bMV07CiAgICAgICAgY29uc3QgbWF4TG9uID0gYmJveFsxXVswXTsKICAgICAgICBjb25zdCBtaW5MYXQgPSBiYm94WzFdWzFdOwogICAgICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLnJ0cmVlLnNlYXJjaEJCb3goewogICAgICAgICAgbWluTGF0LAogICAgICAgICAgbWF4TGF0LAogICAgICAgICAgbWluTG5nOiBtaW5Mb24sCiAgICAgICAgICBtYXhMbmc6IG1heExvbgogICAgICAgIH0pOwogICAgICAgIHJldHVybiByZXN1bHRzLm1hcCgoZW50cnkpID0+IGVudHJ5Lm9iamVjdElkLnRvU3RyaW5nKCkpOwogICAgICB9CiAgICB9CiAgICBpZiAoZ2VvUXVlcnkuJG5lYXIpIHsKICAgICAgY29uc3QgbmVhclF1ZXJ5ID0gZ2VvUXVlcnkuJG5lYXI7CiAgICAgIGxldCBjb29yZGluYXRlczsKICAgICAgaWYgKG5lYXJRdWVyeS4kZ2VvbWV0cnkpIHsKICAgICAgICBjb29yZGluYXRlcyA9IG5lYXJRdWVyeS4kZ2VvbWV0cnkuY29vcmRpbmF0ZXM7CiAgICAgIH0gZWxzZSBpZiAobmVhclF1ZXJ5LmNvb3JkaW5hdGVzKSB7CiAgICAgICAgY29vcmRpbmF0ZXMgPSBuZWFyUXVlcnkuY29vcmRpbmF0ZXM7CiAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShuZWFyUXVlcnkpKSB7CiAgICAgICAgY29vcmRpbmF0ZXMgPSBuZWFyUXVlcnk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgaWYgKCFjb29yZGluYXRlcyB8fCBjb29yZGluYXRlcy5sZW5ndGggPCAyKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgY29uc3QgW2xuZywgbGF0XSA9IGNvb3JkaW5hdGVzOwogICAgICBjb25zdCBtYXhEaXN0YW5jZU1ldGVycyA9IG5lYXJRdWVyeS4kbWF4RGlzdGFuY2UgfHwgMWU2OwogICAgICBjb25zdCBtYXhEaXN0YW5jZUttID0gbWF4RGlzdGFuY2VNZXRlcnMgLyAxZTM7CiAgICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLnJ0cmVlLnNlYXJjaFJhZGl1cyhsYXQsIGxuZywgbWF4RGlzdGFuY2VLbSk7CiAgICAgIHJlc3VsdHMuc29ydCgoYSwgYikgPT4gYS5kaXN0YW5jZSAtIGIuZGlzdGFuY2UpOwogICAgICByZXR1cm4gcmVzdWx0cy5tYXAoKGVudHJ5KSA9PiBlbnRyeS5vYmplY3RJZC50b1N0cmluZygpKTsKICAgIH0KICAgIGlmIChnZW9RdWVyeS4kbmVhclNwaGVyZSkgewogICAgICBjb25zdCBuZWFyUXVlcnkgPSBnZW9RdWVyeS4kbmVhclNwaGVyZTsKICAgICAgbGV0IGNvb3JkaW5hdGVzOwogICAgICBpZiAobmVhclF1ZXJ5LiRnZW9tZXRyeSkgewogICAgICAgIGNvb3JkaW5hdGVzID0gbmVhclF1ZXJ5LiRnZW9tZXRyeS5jb29yZGluYXRlczsKICAgICAgfSBlbHNlIGlmIChuZWFyUXVlcnkuY29vcmRpbmF0ZXMpIHsKICAgICAgICBjb29yZGluYXRlcyA9IG5lYXJRdWVyeS5jb29yZGluYXRlczsKICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KG5lYXJRdWVyeSkpIHsKICAgICAgICBjb29yZGluYXRlcyA9IG5lYXJRdWVyeTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICBpZiAoIWNvb3JkaW5hdGVzIHx8IGNvb3JkaW5hdGVzLmxlbmd0aCA8IDIpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICBjb25zdCBbbG5nLCBsYXRdID0gY29vcmRpbmF0ZXM7CiAgICAgIGNvbnN0IG1heERpc3RhbmNlTWV0ZXJzID0gbmVhclF1ZXJ5LiRtYXhEaXN0YW5jZSB8fCAxZTY7CiAgICAgIGNvbnN0IG1heERpc3RhbmNlS20gPSBtYXhEaXN0YW5jZU1ldGVycyAvIDFlMzsKICAgICAgY29uc3QgcmVzdWx0cyA9IGF3YWl0IHRoaXMucnRyZWUuc2VhcmNoUmFkaXVzKGxhdCwgbG5nLCBtYXhEaXN0YW5jZUttKTsKICAgICAgcmVzdWx0cy5zb3J0KChhLCBiKSA9PiBhLmRpc3RhbmNlIC0gYi5kaXN0YW5jZSk7CiAgICAgIHJldHVybiByZXN1bHRzLm1hcCgoZW50cnkpID0+IGVudHJ5Lm9iamVjdElkLnRvU3RyaW5nKCkpOwogICAgfQogICAgaWYgKGdlb1F1ZXJ5LiRnZW9JbnRlcnNlY3RzKSB7CiAgICAgIGNvbnN0IGludGVyc2VjdHNRdWVyeSA9IGdlb1F1ZXJ5LiRnZW9JbnRlcnNlY3RzOwogICAgICBsZXQgZ2VvbWV0cnk7CiAgICAgIGlmIChpbnRlcnNlY3RzUXVlcnkuJGdlb21ldHJ5KSB7CiAgICAgICAgZ2VvbWV0cnkgPSBpbnRlcnNlY3RzUXVlcnkuJGdlb21ldHJ5OwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIGlmICghZ2VvbWV0cnkgfHwgIWdlb21ldHJ5LnR5cGUpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICBpZiAoZ2VvbWV0cnkudHlwZSA9PT0gIlBvaW50IikgewogICAgICAgIGNvbnN0IFtsbmcsIGxhdF0gPSBnZW9tZXRyeS5jb29yZGluYXRlczsKICAgICAgICBjb25zdCBlcHNpbG9uID0gMWUtNDsKICAgICAgICBjb25zdCByZXN1bHRzID0gYXdhaXQgdGhpcy5ydHJlZS5zZWFyY2hCQm94KHsKICAgICAgICAgIG1pbkxhdDogbGF0IC0gZXBzaWxvbiwKICAgICAgICAgIG1heExhdDogbGF0ICsgZXBzaWxvbiwKICAgICAgICAgIG1pbkxuZzogbG5nIC0gZXBzaWxvbiwKICAgICAgICAgIG1heExuZzogbG5nICsgZXBzaWxvbgogICAgICAgIH0pOwogICAgICAgIHJldHVybiByZXN1bHRzLm1hcCgoZW50cnkpID0+IGVudHJ5Lm9iamVjdElkLnRvU3RyaW5nKCkpOwogICAgICB9IGVsc2UgaWYgKGdlb21ldHJ5LnR5cGUgPT09ICJQb2x5Z29uIikgewogICAgICAgIGNvbnN0IGNvb3JkaW5hdGVzID0gZ2VvbWV0cnkuY29vcmRpbmF0ZXM7CiAgICAgICAgaWYgKCFjb29yZGluYXRlcyB8fCBjb29yZGluYXRlcy5sZW5ndGggPT09IDApIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBjb25zdCByaW5nID0gY29vcmRpbmF0ZXNbMF07CiAgICAgICAgaWYgKCFyaW5nIHx8IHJpbmcubGVuZ3RoIDwgMykgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGxldCBtaW5MYXQgPSBJbmZpbml0eSwgbWF4TGF0ID0gLUluZmluaXR5OwogICAgICAgIGxldCBtaW5MbmcgPSBJbmZpbml0eSwgbWF4TG5nID0gLUluZmluaXR5OwogICAgICAgIGZvciAoY29uc3QgY29vcmQgb2YgcmluZykgewogICAgICAgICAgY29uc3QgW2xuZywgbGF0XSA9IGNvb3JkOwogICAgICAgICAgbWluTGF0ID0gTWF0aC5taW4obWluTGF0LCBsYXQpOwogICAgICAgICAgbWF4TGF0ID0gTWF0aC5tYXgobWF4TGF0LCBsYXQpOwogICAgICAgICAgbWluTG5nID0gTWF0aC5taW4obWluTG5nLCBsbmcpOwogICAgICAgICAgbWF4TG5nID0gTWF0aC5tYXgobWF4TG5nLCBsbmcpOwogICAgICAgIH0KICAgICAgICBjb25zdCBjYW5kaWRhdGVzID0gYXdhaXQgdGhpcy5ydHJlZS5zZWFyY2hCQm94KHsKICAgICAgICAgIG1pbkxhdCwKICAgICAgICAgIG1heExhdCwKICAgICAgICAgIG1pbkxuZywKICAgICAgICAgIG1heExuZwogICAgICAgIH0pOwogICAgICAgIGNvbnN0IHJlc3VsdHMgPSBjYW5kaWRhdGVzLmZpbHRlcigoZW50cnkpID0+IHRoaXMuX3BvaW50SW5Qb2x5Z29uKGVudHJ5LmxhdCwgZW50cnkubG5nLCByaW5nKSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdHMubWFwKChlbnRyeSkgPT4gZW50cnkub2JqZWN0SWQudG9TdHJpbmcoKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9CiAgLy8gLyoqCiAgLy8gICogQ2FsY3VsYXRlIGRpc3RhbmNlIGJldHdlZW4gdHdvIHBvaW50cyB1c2luZyBIYXZlcnNpbmUgZm9ybXVsYQogIC8vICAqIEBwYXJhbSB7bnVtYmVyfSBsYXQxIC0gTGF0aXR1ZGUgb2YgZmlyc3QgcG9pbnQKICAvLyAgKiBAcGFyYW0ge251bWJlcn0gbG5nMSAtIExvbmdpdHVkZSBvZiBmaXJzdCBwb2ludAogIC8vICAqIEBwYXJhbSB7bnVtYmVyfSBsYXQyIC0gTGF0aXR1ZGUgb2Ygc2Vjb25kIHBvaW50CiAgLy8gICogQHBhcmFtIHtudW1iZXJ9IGxuZzIgLSBMb25naXR1ZGUgb2Ygc2Vjb25kIHBvaW50CiAgLy8gICogQHJldHVybnMge251bWJlcn0gRGlzdGFuY2UgaW4ga2lsb21ldGVycwogIC8vICAqLwogIC8vIF9oYXZlcnNpbmVEaXN0YW5jZShsYXQxLCBsbmcxLCBsYXQyLCBsbmcyKSB7CiAgLy8gCWNvbnN0IFIgPSA2MzcxOyAvLyBFYXJ0aCdzIHJhZGl1cyBpbiBraWxvbWV0ZXJzCiAgLy8gCWNvbnN0IGRMYXQgPSAobGF0MiAtIGxhdDEpICogTWF0aC5QSSAvIDE4MDsKICAvLyAJY29uc3QgZExuZyA9IChsbmcyIC0gbG5nMSkgKiBNYXRoLlBJIC8gMTgwOwogIC8vIAljb25zdCBhID0gTWF0aC5zaW4oZExhdCAvIDIpICogTWF0aC5zaW4oZExhdCAvIDIpICsKICAvLyAJCU1hdGguY29zKGxhdDEgKiBNYXRoLlBJIC8gMTgwKSAqIE1hdGguY29zKGxhdDIgKiBNYXRoLlBJIC8gMTgwKSAqCiAgLy8gCQlNYXRoLnNpbihkTG5nIC8gMikgKiBNYXRoLnNpbihkTG5nIC8gMik7CiAgLy8gCWNvbnN0IGMgPSAyICogTWF0aC5hdGFuMihNYXRoLnNxcnQoYSksIE1hdGguc3FydCgxIC0gYSkpOwogIC8vIAlyZXR1cm4gUiAqIGM7CiAgLy8gfQogIC8qKgogICAqIFRlc3QgaWYgYSBwb2ludCBpcyBpbnNpZGUgYSBwb2x5Z29uIHVzaW5nIHJheSBjYXN0aW5nIGFsZ29yaXRobQogICAqIEBwYXJhbSB7bnVtYmVyfSBsYXQgLSBQb2ludCBsYXRpdHVkZQogICAqIEBwYXJhbSB7bnVtYmVyfSBsbmcgLSBQb2ludCBsb25naXR1ZGUKICAgKiBAcGFyYW0ge0FycmF5fSByaW5nIC0gUG9seWdvbiByaW5nIGFzIGFycmF5IG9mIFtsbmcsIGxhdF0gY29vcmRpbmF0ZXMKICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBwb2ludCBpcyBpbnNpZGUgcG9seWdvbgogICAqLwogIF9wb2ludEluUG9seWdvbihsYXQsIGxuZywgcmluZykgewogICAgbGV0IGluc2lkZSA9IGZhbHNlOwogICAgZm9yIChsZXQgaSA9IDAsIGogPSByaW5nLmxlbmd0aCAtIDE7IGkgPCByaW5nLmxlbmd0aDsgaiA9IGkrKykgewogICAgICBjb25zdCBbeGksIHlpXSA9IHJpbmdbaV07CiAgICAgIGNvbnN0IFt4aiwgeWpdID0gcmluZ1tqXTsKICAgICAgY29uc3QgaW50ZXJzZWN0ID0geWkgPiBsYXQgIT09IHlqID4gbGF0ICYmIGxuZyA8ICh4aiAtIHhpKSAqIChsYXQgLSB5aSkgLyAoeWogLSB5aSkgKyB4aTsKICAgICAgaWYgKGludGVyc2VjdCkgewogICAgICAgIGluc2lkZSA9ICFpbnNpZGU7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBpbnNpZGU7CiAgfQogIC8qKgogICAqIENsZWFyIGFsbCBkYXRhIGZyb20gdGhlIGluZGV4CiAgICovCiAgLy8gVE9ETzogZG9udCcgZGVsZXRlIHRoZSBmaWxlIG9yIGp1c3QgY2xlYXIgdGhlIFJUcmVlIGNvbnRlbnRzCiAgYXN5bmMgY2xlYXIoKSB7CiAgICBhd2FpdCB0aGlzLmNsb3NlKCk7CiAgICB0cnkgewogICAgICBjb25zdCBwYXRoUGFydHMgPSB0aGlzLnN0b3JhZ2VGaWxlUGF0aC5zcGxpdCgiLyIpLmZpbHRlcihCb29sZWFuKTsKICAgICAgY29uc3QgZmlsZW5hbWUgPSBwYXRoUGFydHMucG9wKCk7CiAgICAgIGxldCBkaXJIYW5kbGUgPSBhd2FpdCBnbG9iYWxUaGlzLm5hdmlnYXRvci5zdG9yYWdlLmdldERpcmVjdG9yeSgpOwogICAgICBmb3IgKGNvbnN0IHBhcnQgb2YgcGF0aFBhcnRzKSB7CiAgICAgICAgZGlySGFuZGxlID0gYXdhaXQgZGlySGFuZGxlLmdldERpcmVjdG9yeUhhbmRsZShwYXJ0LCB7IGNyZWF0ZTogZmFsc2UgfSk7CiAgICAgIH0KICAgICAgYXdhaXQgZGlySGFuZGxlLnJlbW92ZUVudHJ5KGZpbGVuYW1lKTsKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBpZiAoIWVyciB8fCBlcnIubmFtZSAhPT0gIk5vdEZvdW5kRXJyb3IiKSB7CiAgICAgICAgdGhyb3cgZXJyOwogICAgICB9CiAgICB9CiAgICBhd2FpdCB0aGlzLm9wZW4oKTsKICB9CiAgLyoqCiAgICogR2V0IGluZGV4IHNwZWNpZmljYXRpb24KICAgKi8KICBnZXRTcGVjKCkgewogICAgcmV0dXJuIHsKICAgICAgbmFtZTogdGhpcy5uYW1lLAogICAgICBrZXk6IHRoaXMua2V5cywKICAgICAgIjJkc3BoZXJlSW5kZXhWZXJzaW9uIjogMwogICAgfTsKICB9Cn0KY2xhc3MgUXVlcnlQbGFuIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMudHlwZSA9ICJmdWxsX3NjYW4iOwogICAgdGhpcy5pbmRleGVzID0gW107CiAgICB0aGlzLmluZGV4U2NhbnMgPSBbXTsKICAgIHRoaXMuZXN0aW1hdGVkQ29zdCA9IEluZmluaXR5OwogICAgdGhpcy5pbmRleE9ubHkgPSBmYWxzZTsKICB9Cn0KY2xhc3MgUXVlcnlQbGFubmVyIHsKICBjb25zdHJ1Y3RvcihpbmRleGVzKSB7CiAgICB0aGlzLmluZGV4ZXMgPSBpbmRleGVzOwogIH0KICAvKioKICAgKiBHZW5lcmF0ZSBhbiBleGVjdXRpb24gcGxhbiBmb3IgYSBxdWVyeQogICAqIEBwYXJhbSB7T2JqZWN0fSBxdWVyeSAtIE1vbmdvREIgcXVlcnkgb2JqZWN0CiAgICogQHJldHVybnMge1F1ZXJ5UGxhbn0gRXhlY3V0aW9uIHBsYW4KICAgKi8KICBwbGFuKHF1ZXJ5KSB7CiAgICBjb25zdCBwbGFuID0gbmV3IFF1ZXJ5UGxhbigpOwogICAgaWYgKCFxdWVyeSB8fCBPYmplY3Qua2V5cyhxdWVyeSkubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiBwbGFuOwogICAgfQogICAgY29uc3QgYW5hbHlzaXMgPSB0aGlzLl9hbmFseXplUXVlcnkocXVlcnkpOwogICAgaWYgKGFuYWx5c2lzLmhhc1RleHRTZWFyY2gpIHsKICAgICAgY29uc3QgdGV4dFBsYW4gPSB0aGlzLl9wbGFuVGV4dFNlYXJjaChxdWVyeSwgYW5hbHlzaXMpOwogICAgICBpZiAodGV4dFBsYW4pIHsKICAgICAgICByZXR1cm4gdGV4dFBsYW47CiAgICAgIH0KICAgIH0KICAgIGlmIChhbmFseXNpcy5oYXNHZW9RdWVyeSkgewogICAgICBjb25zdCBnZW9QbGFuID0gdGhpcy5fcGxhbkdlb1F1ZXJ5KHF1ZXJ5LCBhbmFseXNpcyk7CiAgICAgIGlmIChnZW9QbGFuKSB7CiAgICAgICAgcmV0dXJuIGdlb1BsYW47CiAgICAgIH0KICAgIH0KICAgIGlmIChhbmFseXNpcy50eXBlID09PSAiYW5kIikgewogICAgICBjb25zdCBhbmRQbGFuID0gdGhpcy5fcGxhbkFuZFF1ZXJ5KHF1ZXJ5LCBhbmFseXNpcyk7CiAgICAgIGlmIChhbmRQbGFuLnR5cGUgIT09ICJmdWxsX3NjYW4iKSB7CiAgICAgICAgcmV0dXJuIGFuZFBsYW47CiAgICAgIH0KICAgIH0KICAgIGlmIChhbmFseXNpcy50eXBlID09PSAib3IiKSB7CiAgICAgIGNvbnN0IG9yUGxhbiA9IHRoaXMuX3BsYW5PclF1ZXJ5KHF1ZXJ5LCBhbmFseXNpcyk7CiAgICAgIGlmIChvclBsYW4udHlwZSAhPT0gImZ1bGxfc2NhbiIpIHsKICAgICAgICByZXR1cm4gb3JQbGFuOwogICAgICB9CiAgICB9CiAgICBjb25zdCBzaW1wbGVQbGFuID0gdGhpcy5fcGxhblNpbXBsZVF1ZXJ5KHF1ZXJ5KTsKICAgIGlmIChzaW1wbGVQbGFuLnR5cGUgIT09ICJmdWxsX3NjYW4iKSB7CiAgICAgIHJldHVybiBzaW1wbGVQbGFuOwogICAgfQogICAgcmV0dXJuIHBsYW47CiAgfQogIC8qKgogICAqIEFuYWx5emUgcXVlcnkgc3RydWN0dXJlCiAgICogQHByaXZhdGUKICAgKi8KICBfYW5hbHl6ZVF1ZXJ5KHF1ZXJ5KSB7CiAgICBjb25zdCBhbmFseXNpcyA9IHsKICAgICAgdHlwZTogInNpbXBsZSIsCiAgICAgIC8vICdzaW1wbGUnLCAnYW5kJywgJ29yJywgJ2NvbXBsZXgnCiAgICAgIGZpZWxkczogW10sCiAgICAgIG9wZXJhdG9yczoge30sCiAgICAgIGhhc1RleHRTZWFyY2g6IGZhbHNlLAogICAgICBoYXNHZW9RdWVyeTogZmFsc2UsCiAgICAgIGNvbmRpdGlvbnM6IFtdCiAgICB9OwogICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHF1ZXJ5KTsKICAgIGlmIChrZXlzLmxlbmd0aCA9PT0gMSkgewogICAgICBjb25zdCBrZXkgPSBrZXlzWzBdOwogICAgICBpZiAoa2V5ID09PSAiJGFuZCIpIHsKICAgICAgICBhbmFseXNpcy50eXBlID0gImFuZCI7CiAgICAgICAgYW5hbHlzaXMuY29uZGl0aW9ucyA9IHF1ZXJ5LiRhbmQ7CiAgICAgICAgZm9yIChjb25zdCBjb25kaXRpb24gb2YgYW5hbHlzaXMuY29uZGl0aW9ucykgewogICAgICAgICAgY29uc3Qgc3ViQW5hbHlzaXMgPSB0aGlzLl9hbmFseXplUXVlcnkoY29uZGl0aW9uKTsKICAgICAgICAgIGFuYWx5c2lzLmZpZWxkcy5wdXNoKC4uLnN1YkFuYWx5c2lzLmZpZWxkcyk7CiAgICAgICAgICBpZiAoc3ViQW5hbHlzaXMuaGFzVGV4dFNlYXJjaCkgYW5hbHlzaXMuaGFzVGV4dFNlYXJjaCA9IHRydWU7CiAgICAgICAgICBpZiAoc3ViQW5hbHlzaXMuaGFzR2VvUXVlcnkpIGFuYWx5c2lzLmhhc0dlb1F1ZXJ5ID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFuYWx5c2lzOwogICAgICB9IGVsc2UgaWYgKGtleSA9PT0gIiRvciIpIHsKICAgICAgICBhbmFseXNpcy50eXBlID0gIm9yIjsKICAgICAgICBhbmFseXNpcy5jb25kaXRpb25zID0gcXVlcnkuJG9yOwogICAgICAgIGZvciAoY29uc3QgY29uZGl0aW9uIG9mIGFuYWx5c2lzLmNvbmRpdGlvbnMpIHsKICAgICAgICAgIGNvbnN0IHN1YkFuYWx5c2lzID0gdGhpcy5fYW5hbHl6ZVF1ZXJ5KGNvbmRpdGlvbik7CiAgICAgICAgICBhbmFseXNpcy5maWVsZHMucHVzaCguLi5zdWJBbmFseXNpcy5maWVsZHMpOwogICAgICAgICAgaWYgKHN1YkFuYWx5c2lzLmhhc1RleHRTZWFyY2gpIGFuYWx5c2lzLmhhc1RleHRTZWFyY2ggPSB0cnVlOwogICAgICAgICAgaWYgKHN1YkFuYWx5c2lzLmhhc0dlb1F1ZXJ5KSBhbmFseXNpcy5oYXNHZW9RdWVyeSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhbmFseXNpczsKICAgICAgfQogICAgfQogICAgZm9yIChjb25zdCBmaWVsZCBvZiBrZXlzKSB7CiAgICAgIGlmIChmaWVsZC5zdGFydHNXaXRoKCIkIikpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBhbmFseXNpcy5maWVsZHMucHVzaChmaWVsZCk7CiAgICAgIGNvbnN0IHZhbHVlID0gcXVlcnlbZmllbGRdOwogICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB2YWx1ZSAhPT0gbnVsbCAmJiAhQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICBjb25zdCBvcHMgPSBPYmplY3Qua2V5cyh2YWx1ZSk7CiAgICAgICAgYW5hbHlzaXMub3BlcmF0b3JzW2ZpZWxkXSA9IG9wczsKICAgICAgICBpZiAob3BzLmluY2x1ZGVzKCIkdGV4dCIpKSB7CiAgICAgICAgICBhbmFseXNpcy5oYXNUZXh0U2VhcmNoID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKG9wcy5zb21lKChvcCkgPT4gWyIkZ2VvV2l0aGluIiwgIiRnZW9JbnRlcnNlY3RzIiwgIiRuZWFyIiwgIiRuZWFyU3BoZXJlIl0uaW5jbHVkZXMob3ApKSkgewogICAgICAgICAgYW5hbHlzaXMuaGFzR2VvUXVlcnkgPSB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKGtleXMubGVuZ3RoID4gMSkgewogICAgICBhbmFseXNpcy50eXBlID0gImFuZCI7CiAgICB9CiAgICByZXR1cm4gYW5hbHlzaXM7CiAgfQogIC8qKgogICAqIFBsYW4gZm9yIHRleHQgc2VhcmNoIHF1ZXJpZXMKICAgKiBAcHJpdmF0ZQogICAqLwogIF9wbGFuVGV4dFNlYXJjaChxdWVyeSwgYW5hbHlzaXMpIHsKICAgIGZvciAoY29uc3QgW2luZGV4TmFtZSwgaW5kZXhdIG9mIHRoaXMuaW5kZXhlcykgewogICAgICBpZiAoaW5kZXggaW5zdGFuY2VvZiBUZXh0Q29sbGVjdGlvbkluZGV4KSB7CiAgICAgICAgY29uc3QgdGV4dFF1ZXJ5ID0gdGhpcy5fZXh0cmFjdFRleHRRdWVyeShxdWVyeSk7CiAgICAgICAgaWYgKHRleHRRdWVyeSkgewogICAgICAgICAgY29uc3QgcGxhbiA9IG5ldyBRdWVyeVBsYW4oKTsKICAgICAgICAgIHBsYW4udHlwZSA9ICJpbmRleF9zY2FuIjsKICAgICAgICAgIHBsYW4uaW5kZXhlcyA9IFtpbmRleE5hbWVdOwogICAgICAgICAgcGxhbi5pbmRleFNjYW5zID0gW3sgaW5kZXhOYW1lLCBpbmRleCwgdGV4dFF1ZXJ5IH1dOwogICAgICAgICAgcGxhbi5lc3RpbWF0ZWRDb3N0ID0gMTAwOwogICAgICAgICAgcGxhbi5pbmRleE9ubHkgPSB0cnVlOwogICAgICAgICAgcmV0dXJuIHBsYW47CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9CiAgLyoqCiAgICogRXh0cmFjdCAkdGV4dCBxdWVyeSBmcm9tIHF1ZXJ5IG9iamVjdAogICAqIEBwcml2YXRlCiAgICovCiAgX2V4dHJhY3RUZXh0UXVlcnkocXVlcnkpIHsKICAgIGZvciAoY29uc3QgZmllbGQgaW4gcXVlcnkpIHsKICAgICAgY29uc3QgdmFsdWUgPSBxdWVyeVtmaWVsZF07CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHZhbHVlICE9PSBudWxsICYmIHZhbHVlLiR0ZXh0KSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZS4kdGV4dCA9PT0gInN0cmluZyIgPyB2YWx1ZS4kdGV4dCA6IHZhbHVlLiR0ZXh0LiRzZWFyY2g7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBudWxsOwogIH0KICAvKioKICAgKiBQbGFuIGZvciBnZW9zcGF0aWFsIHF1ZXJpZXMKICAgKiBAcHJpdmF0ZQogICAqLwogIF9wbGFuR2VvUXVlcnkocXVlcnksIGFuYWx5c2lzKSB7CiAgICBmb3IgKGNvbnN0IFtpbmRleE5hbWUsIGluZGV4XSBvZiB0aGlzLmluZGV4ZXMpIHsKICAgICAgaWYgKGluZGV4IGluc3RhbmNlb2YgR2Vvc3BhdGlhbEluZGV4KSB7CiAgICAgICAgY29uc3QgcGxhbiA9IG5ldyBRdWVyeVBsYW4oKTsKICAgICAgICBwbGFuLnR5cGUgPSAiaW5kZXhfc2NhbiI7CiAgICAgICAgcGxhbi5pbmRleGVzID0gW2luZGV4TmFtZV07CiAgICAgICAgcGxhbi5pbmRleFNjYW5zID0gW3sgaW5kZXhOYW1lLCBpbmRleCwgcXVlcnkgfV07CiAgICAgICAgcGxhbi5lc3RpbWF0ZWRDb3N0ID0gMTAwOwogICAgICAgIHBsYW4uaW5kZXhPbmx5ID0gdHJ1ZTsKICAgICAgICByZXR1cm4gcGxhbjsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfQogIC8qKgogICAqIFBsYW4gZm9yICRhbmQgcXVlcmllcyAoaW5kZXggaW50ZXJzZWN0aW9uKQogICAqIEBwcml2YXRlCiAgICovCiAgX3BsYW5BbmRRdWVyeShxdWVyeSwgYW5hbHlzaXMpIHsKICAgIGNvbnN0IHBsYW4gPSBuZXcgUXVlcnlQbGFuKCk7CiAgICBsZXQgY29uZGl0aW9uczsKICAgIGlmIChxdWVyeS4kYW5kKSB7CiAgICAgIGNvbmRpdGlvbnMgPSBxdWVyeS4kYW5kOwogICAgfSBlbHNlIHsKICAgICAgY29uZGl0aW9ucyA9IE9iamVjdC5rZXlzKHF1ZXJ5KS5tYXAoKGZpZWxkKSA9PiAoeyBbZmllbGRdOiBxdWVyeVtmaWVsZF0gfSkpOwogICAgfQogICAgY29uc3QgaW5kZXhhYmxlQ29uZGl0aW9ucyA9IFtdOwogICAgZm9yIChjb25zdCBjb25kaXRpb24gb2YgY29uZGl0aW9ucykgewogICAgICBjb25zdCBjb25kaXRpb25QbGFuID0gdGhpcy5fcGxhblNpbXBsZVF1ZXJ5KGNvbmRpdGlvbik7CiAgICAgIGlmIChjb25kaXRpb25QbGFuLnR5cGUgPT09ICJpbmRleF9zY2FuIikgewogICAgICAgIGluZGV4YWJsZUNvbmRpdGlvbnMucHVzaChjb25kaXRpb25QbGFuLmluZGV4U2NhbnNbMF0pOwogICAgICB9CiAgICB9CiAgICBpZiAoaW5kZXhhYmxlQ29uZGl0aW9ucy5sZW5ndGggPiAxKSB7CiAgICAgIHBsYW4udHlwZSA9ICJpbmRleF9pbnRlcnNlY3Rpb24iOwogICAgICBwbGFuLmluZGV4U2NhbnMgPSBpbmRleGFibGVDb25kaXRpb25zOwogICAgICBwbGFuLmluZGV4ZXMgPSBpbmRleGFibGVDb25kaXRpb25zLm1hcCgoc2NhbikgPT4gc2Nhbi5pbmRleE5hbWUpOwogICAgICBwbGFuLmVzdGltYXRlZENvc3QgPSA1MDsKICAgICAgcmV0dXJuIHBsYW47CiAgICB9CiAgICBpZiAoaW5kZXhhYmxlQ29uZGl0aW9ucy5sZW5ndGggPT09IDEpIHsKICAgICAgcGxhbi50eXBlID0gImluZGV4X3NjYW4iOwogICAgICBwbGFuLmluZGV4U2NhbnMgPSBbaW5kZXhhYmxlQ29uZGl0aW9uc1swXV07CiAgICAgIHBsYW4uaW5kZXhlcyA9IFtpbmRleGFibGVDb25kaXRpb25zWzBdLmluZGV4TmFtZV07CiAgICAgIHBsYW4uZXN0aW1hdGVkQ29zdCA9IDUwOwogICAgICByZXR1cm4gcGxhbjsKICAgIH0KICAgIHJldHVybiBwbGFuOwogIH0KICAvKioKICAgKiBQbGFuIGZvciAkb3IgcXVlcmllcyAoaW5kZXggdW5pb24pCiAgICogQHByaXZhdGUKICAgKi8KICBfcGxhbk9yUXVlcnkocXVlcnksIGFuYWx5c2lzKSB7CiAgICBjb25zdCBwbGFuID0gbmV3IFF1ZXJ5UGxhbigpOwogICAgaWYgKCFxdWVyeS4kb3IpIHsKICAgICAgcmV0dXJuIHBsYW47CiAgICB9CiAgICBjb25zdCBjb25kaXRpb25zID0gcXVlcnkuJG9yOwogICAgY29uc3QgaW5kZXhhYmxlQ29uZGl0aW9ucyA9IFtdOwogICAgZm9yIChjb25zdCBjb25kaXRpb24gb2YgY29uZGl0aW9ucykgewogICAgICBjb25zdCBjb25kaXRpb25QbGFuID0gdGhpcy5fcGxhblNpbXBsZVF1ZXJ5KGNvbmRpdGlvbik7CiAgICAgIGlmIChjb25kaXRpb25QbGFuLnR5cGUgPT09ICJpbmRleF9zY2FuIikgewogICAgICAgIGluZGV4YWJsZUNvbmRpdGlvbnMucHVzaChjb25kaXRpb25QbGFuLmluZGV4U2NhbnNbMF0pOwogICAgICB9CiAgICB9CiAgICBpZiAoaW5kZXhhYmxlQ29uZGl0aW9ucy5sZW5ndGggPiAwKSB7CiAgICAgIHBsYW4udHlwZSA9ICJpbmRleF91bmlvbiI7CiAgICAgIHBsYW4uaW5kZXhTY2FucyA9IGluZGV4YWJsZUNvbmRpdGlvbnM7CiAgICAgIHBsYW4uaW5kZXhlcyA9IGluZGV4YWJsZUNvbmRpdGlvbnMubWFwKChzY2FuKSA9PiBzY2FuLmluZGV4TmFtZSk7CiAgICAgIHBsYW4uZXN0aW1hdGVkQ29zdCA9IDEwMCAqIGluZGV4YWJsZUNvbmRpdGlvbnMubGVuZ3RoOwogICAgICByZXR1cm4gcGxhbjsKICAgIH0KICAgIHJldHVybiBwbGFuOwogIH0KICAvKioKICAgKiBQbGFuIGZvciBzaW1wbGUgc2luZ2xlLWZpZWxkIHF1ZXJpZXMKICAgKiBAcHJpdmF0ZQogICAqLwogIF9wbGFuU2ltcGxlUXVlcnkocXVlcnkpIHsKICAgIGNvbnN0IHBsYW4gPSBuZXcgUXVlcnlQbGFuKCk7CiAgICBjb25zdCBxdWVyeUtleXMgPSBPYmplY3Qua2V5cyhxdWVyeSk7CiAgICBpZiAocXVlcnlLZXlzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gcGxhbjsKICAgIH0KICAgIGZvciAoY29uc3QgW2luZGV4TmFtZSwgaW5kZXhdIG9mIHRoaXMuaW5kZXhlcykgewogICAgICBpZiAoaW5kZXggaW5zdGFuY2VvZiBUZXh0Q29sbGVjdGlvbkluZGV4IHx8IGluZGV4IGluc3RhbmNlb2YgR2Vvc3BhdGlhbEluZGV4KSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuX2NhbkluZGV4SGFuZGxlUXVlcnkoaW5kZXgsIHF1ZXJ5KSkgewogICAgICAgIHBsYW4udHlwZSA9ICJpbmRleF9zY2FuIjsKICAgICAgICBwbGFuLmluZGV4ZXMgPSBbaW5kZXhOYW1lXTsKICAgICAgICBwbGFuLmluZGV4U2NhbnMgPSBbeyBpbmRleE5hbWUsIGluZGV4LCBxdWVyeSB9XTsKICAgICAgICBwbGFuLmVzdGltYXRlZENvc3QgPSA1MDsKICAgICAgICByZXR1cm4gcGxhbjsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHBsYW47CiAgfQogIC8qKgogICAqIEV4ZWN1dGUgYSBzaW5nbGUgaW5kZXggc2NhbiB0aGF0IHdhcyBkZWZlcnJlZCBmcm9tIHBsYW5uaW5nCiAgICogQHByaXZhdGUKICAgKi8KICBhc3luYyBfZXhlY3V0ZUluZGV4U2NhbihzY2FuKSB7CiAgICBjb25zdCB7IGluZGV4LCBxdWVyeSwgdGV4dFF1ZXJ5IH0gPSBzY2FuOwogICAgaWYgKHR5cGVvZiBpbmRleC5vcGVuID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBpbmRleC5pc09wZW4gIT09ICJ1bmRlZmluZWQiICYmICFpbmRleC5pc09wZW4pIHsKICAgICAgYXdhaXQgaW5kZXgub3BlbigpOwogICAgfQogICAgaWYgKHRleHRRdWVyeSAhPT0gdm9pZCAwKSB7CiAgICAgIHJldHVybiBhd2FpdCBpbmRleC5zZWFyY2godGV4dFF1ZXJ5KTsKICAgIH0KICAgIGlmIChxdWVyeSAhPT0gdm9pZCAwKSB7CiAgICAgIGNvbnN0IGRvY0lkcyA9IGF3YWl0IGluZGV4LnF1ZXJ5KHF1ZXJ5KTsKICAgICAgcmV0dXJuIGRvY0lkcyAhPT0gbnVsbCA/IGRvY0lkcyA6IFtdOwogICAgfQogICAgaWYgKHNjYW4uZG9jSWRzICE9PSB2b2lkIDApIHsKICAgICAgcmV0dXJuIHNjYW4uZG9jSWRzOwogICAgfQogICAgcmV0dXJuIFtdOwogIH0KICAvKioKICAgKiBDaGVjayBpZiBhbiBpbmRleCBjYW4gaGFuZGxlIGEgcXVlcnkgKHdpdGhvdXQgZXhlY3V0aW5nIGl0KQogICAqIEBwcml2YXRlCiAgICovCiAgX2NhbkluZGV4SGFuZGxlUXVlcnkoaW5kZXgsIHF1ZXJ5KSB7CiAgICBjb25zdCBxdWVyeUtleXMgPSBPYmplY3Qua2V5cyhxdWVyeSk7CiAgICBjb25zdCBpbmRleEZpZWxkcyA9IE9iamVjdC5rZXlzKGluZGV4LmtleXMpOwogICAgaWYgKGluZGV4RmllbGRzLmxlbmd0aCAhPT0gMSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBjb25zdCBmaWVsZCA9IGluZGV4RmllbGRzWzBdOwogICAgaWYgKHF1ZXJ5S2V5cy5pbmRleE9mKGZpZWxkKSA9PT0gLTEpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQogIC8qKgogICAqIEV4ZWN1dGUgYSBxdWVyeSBwbGFuIGFuZCByZXR1cm4gZG9jdW1lbnQgSURzCiAgICogQHBhcmFtIHtRdWVyeVBsYW59IHBsYW4gLSBUaGUgZXhlY3V0aW9uIHBsYW4KICAgKiBAcmV0dXJucyB7UHJvbWlzZTxBcnJheXxudWxsPn0gQXJyYXkgb2YgZG9jdW1lbnQgSURzIG9yIG51bGwgZm9yIGZ1bGwgc2NhbgogICAqLwogIGFzeW5jIGV4ZWN1dGUocGxhbikgewogICAgaWYgKHBsYW4udHlwZSA9PT0gImZ1bGxfc2NhbiIpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBpZiAocGxhbi50eXBlID09PSAiaW5kZXhfc2NhbiIpIHsKICAgICAgY29uc3Qgc2NhbiA9IHBsYW4uaW5kZXhTY2Fuc1swXTsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX2V4ZWN1dGVJbmRleFNjYW4oc2Nhbik7CiAgICB9CiAgICBpZiAocGxhbi50eXBlID09PSAiaW5kZXhfaW50ZXJzZWN0aW9uIikgewogICAgICBpZiAocGxhbi5pbmRleFNjYW5zLmxlbmd0aCA9PT0gMCkgcmV0dXJuIG51bGw7CiAgICAgIGNvbnN0IHJlc3VsdHMgPSBbXTsKICAgICAgZm9yIChjb25zdCBzY2FuIG9mIHBsYW4uaW5kZXhTY2FucykgewogICAgICAgIHJlc3VsdHMucHVzaCh7CiAgICAgICAgICBkb2NJZHM6IGF3YWl0IHRoaXMuX2V4ZWN1dGVJbmRleFNjYW4oc2NhbiksCiAgICAgICAgICBpbmRleE5hbWU6IHNjYW4uaW5kZXhOYW1lCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgY29uc3Qgc29ydGVkID0gcmVzdWx0cy5zbGljZSgpLnNvcnQoKGEsIGIpID0+IGEuZG9jSWRzLmxlbmd0aCAtIGIuZG9jSWRzLmxlbmd0aCk7CiAgICAgIGxldCByZXN1bHQgPSBuZXcgU2V0KHNvcnRlZFswXS5kb2NJZHMpOwogICAgICBmb3IgKGxldCBpID0gMTsgaSA8IHNvcnRlZC5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGN1cnJlbnRTZXQgPSBuZXcgU2V0KHNvcnRlZFtpXS5kb2NJZHMpOwogICAgICAgIHJlc3VsdCA9IG5ldyBTZXQoWy4uLnJlc3VsdF0uZmlsdGVyKChpZCkgPT4gY3VycmVudFNldC5oYXMoaWQpKSk7CiAgICAgICAgaWYgKHJlc3VsdC5zaXplID09PSAwKSBicmVhazsKICAgICAgfQogICAgICByZXR1cm4gQXJyYXkuZnJvbShyZXN1bHQpOwogICAgfQogICAgaWYgKHBsYW4udHlwZSA9PT0gImluZGV4X3VuaW9uIikgewogICAgICBjb25zdCByZXN1bHQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICBmb3IgKGNvbnN0IHNjYW4gb2YgcGxhbi5pbmRleFNjYW5zKSB7CiAgICAgICAgY29uc3QgZG9jSWRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZUluZGV4U2NhbihzY2FuKTsKICAgICAgICBkb2NJZHMuZm9yRWFjaCgoaWQpID0+IHJlc3VsdC5hZGQoaWQpKTsKICAgICAgfQogICAgICByZXR1cm4gQXJyYXkuZnJvbShyZXN1bHQpOwogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfQp9CmNsYXNzIENoYW5nZVN0cmVhbSBleHRlbmRzIGV2ZW50c0V4cG9ydHMuRXZlbnRFbWl0dGVyIHsKICBjb25zdHJ1Y3Rvcih0YXJnZXQsIHBpcGVsaW5lID0gW10sIG9wdGlvbnMgPSB7fSkgewogICAgc3VwZXIoKTsKICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0OwogICAgdGhpcy5waXBlbGluZSA9IHBpcGVsaW5lOwogICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgIHRoaXMuY2xvc2VkID0gZmFsc2U7CiAgICB0aGlzLl9saXN0ZW5lcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgdGhpcy5fY2hhbmdlQ291bnRlciA9IDA7CiAgICB0aGlzLl9zdGFydFdhdGNoaW5nKCk7CiAgfQogIC8qKgogICAqIFN0YXJ0IHdhdGNoaW5nIGZvciBjaGFuZ2VzCiAgICogQHByaXZhdGUKICAgKi8KICBfc3RhcnRXYXRjaGluZygpIHsKICAgIGlmICh0aGlzLmNsb3NlZCkgcmV0dXJuOwogICAgY29uc3QgY29sbGVjdGlvbnMgPSB0aGlzLl9nZXRDb2xsZWN0aW9uc1RvV2F0Y2goKTsKICAgIGZvciAoY29uc3QgY29sbGVjdGlvbiBvZiBjb2xsZWN0aW9ucykgewogICAgICB0aGlzLl93YXRjaENvbGxlY3Rpb24oY29sbGVjdGlvbik7CiAgICB9CiAgICBpZiAodGhpcy50YXJnZXQuY29uc3RydWN0b3IubmFtZSA9PT0gIkRCIikgewogICAgICB0aGlzLl9pbnRlcmNlcHREQkNvbGxlY3Rpb25DcmVhdGlvbigpOwogICAgfQogICAgaWYgKHRoaXMudGFyZ2V0LmNvbnN0cnVjdG9yLm5hbWUgPT09ICJNb25nb0NsaWVudCIpIHsKICAgICAgdGhpcy5faW50ZXJjZXB0Q2xpZW50REJDcmVhdGlvbigpOwogICAgfQogIH0KICAvKioKICAgKiBHZXQgY29sbGVjdGlvbnMgdG8gd2F0Y2ggYmFzZWQgb24gdGFyZ2V0IHR5cGUKICAgKiBAcHJpdmF0ZQogICAqLwogIF9nZXRDb2xsZWN0aW9uc1RvV2F0Y2goKSB7CiAgICBjb25zdCBjb2xsZWN0aW9ucyA9IFtdOwogICAgaWYgKHRoaXMudGFyZ2V0LmNvbnN0cnVjdG9yLm5hbWUgPT09ICJNb25nb0NsaWVudCIpIHsKICAgICAgdGhpcy5fbW9uaXRvckNsaWVudCgpOwogICAgICByZXR1cm4gY29sbGVjdGlvbnM7CiAgICB9CiAgICBpZiAodGhpcy50YXJnZXQuY29uc3RydWN0b3IubmFtZSA9PT0gIkRCIikgewogICAgICBjb25zdCBjb2xsZWN0aW9uTmFtZXMgPSB0aGlzLnRhcmdldC5nZXRDb2xsZWN0aW9uTmFtZXMoKTsKICAgICAgZm9yIChjb25zdCBuYW1lIG9mIGNvbGxlY3Rpb25OYW1lcykgewogICAgICAgIGNvbnN0IGNvbGxlY3Rpb24gPSB0aGlzLnRhcmdldFtuYW1lXTsKICAgICAgICBpZiAoY29sbGVjdGlvbiAmJiBjb2xsZWN0aW9uLmlzQ29sbGVjdGlvbikgewogICAgICAgICAgY29sbGVjdGlvbnMucHVzaChjb2xsZWN0aW9uKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5fbW9uaXRvckRCKCk7CiAgICB9CiAgICBpZiAodGhpcy50YXJnZXQuaXNDb2xsZWN0aW9uKSB7CiAgICAgIGNvbGxlY3Rpb25zLnB1c2godGhpcy50YXJnZXQpOwogICAgfQogICAgcmV0dXJuIGNvbGxlY3Rpb25zOwogIH0KICAvKioKICAgKiBXYXRjaCBhIHNwZWNpZmljIGNvbGxlY3Rpb24gZm9yIGNoYW5nZXMKICAgKiBAcHJpdmF0ZQogICAqLwogIF93YXRjaENvbGxlY3Rpb24oY29sbGVjdGlvbikgewogICAgaWYgKHRoaXMuY2xvc2VkKSByZXR1cm47CiAgICBpZiAoIWNvbGxlY3Rpb24pIHJldHVybjsKICAgIGlmICh0eXBlb2YgY29sbGVjdGlvbi5vbiAhPT0gImZ1bmN0aW9uIikgcmV0dXJuOwogICAgaWYgKCFjb2xsZWN0aW9uLmlzQ29sbGVjdGlvbikgcmV0dXJuOwogICAgaWYgKHRoaXMuX2xpc3RlbmVycy5oYXMoY29sbGVjdGlvbikpIHJldHVybjsKICAgIGNvbnN0IGhhbmRsZXJzID0gewogICAgICBpbnNlcnQ6IChkb2MpID0+IHRoaXMuX2VtaXRDaGFuZ2UoImluc2VydCIsIGNvbGxlY3Rpb24sIGRvYyksCiAgICAgIHVwZGF0ZTogKGRvYywgdXBkYXRlRGVzY3JpcHRpb24pID0+IHRoaXMuX2VtaXRDaGFuZ2UoInVwZGF0ZSIsIGNvbGxlY3Rpb24sIGRvYywgdXBkYXRlRGVzY3JpcHRpb24pLAogICAgICByZXBsYWNlOiAoZG9jKSA9PiB0aGlzLl9lbWl0Q2hhbmdlKCJyZXBsYWNlIiwgY29sbGVjdGlvbiwgZG9jKSwKICAgICAgZGVsZXRlOiAoZG9jKSA9PiB0aGlzLl9lbWl0Q2hhbmdlKCJkZWxldGUiLCBjb2xsZWN0aW9uLCBkb2MpCiAgICB9OwogICAgdGhpcy5fbGlzdGVuZXJzLnNldChjb2xsZWN0aW9uLCBoYW5kbGVycyk7CiAgICBjb2xsZWN0aW9uLm9uKCJpbnNlcnQiLCBoYW5kbGVycy5pbnNlcnQpOwogICAgY29sbGVjdGlvbi5vbigidXBkYXRlIiwgaGFuZGxlcnMudXBkYXRlKTsKICAgIGNvbGxlY3Rpb24ub24oInJlcGxhY2UiLCBoYW5kbGVycy5yZXBsYWNlKTsKICAgIGNvbGxlY3Rpb24ub24oImRlbGV0ZSIsIGhhbmRsZXJzLmRlbGV0ZSk7CiAgfQogIC8qKgogICAqIEVtaXQgYSBjaGFuZ2UgZXZlbnQKICAgKiBAcHJpdmF0ZQogICAqLwogIF9lbWl0Q2hhbmdlKG9wZXJhdGlvblR5cGUsIGNvbGxlY3Rpb24sIGRvYywgdXBkYXRlRGVzY3JpcHRpb24gPSBudWxsKSB7CiAgICBpZiAodGhpcy5jbG9zZWQpIHJldHVybjsKICAgIGNvbnN0IGNoYW5nZUV2ZW50ID0gdGhpcy5fY3JlYXRlQ2hhbmdlRXZlbnQoCiAgICAgIG9wZXJhdGlvblR5cGUsCiAgICAgIGNvbGxlY3Rpb24sCiAgICAgIGRvYywKICAgICAgdXBkYXRlRGVzY3JpcHRpb24KICAgICk7CiAgICBpZiAoIXRoaXMuX21hdGNoZXNQaXBlbGluZShjaGFuZ2VFdmVudCkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5lbWl0KCJjaGFuZ2UiLCBjaGFuZ2VFdmVudCk7CiAgfQogIC8qKgogICAqIENyZWF0ZSBhIE1vbmdvREItY29tcGF0aWJsZSBjaGFuZ2UgZXZlbnQgZG9jdW1lbnQKICAgKiBAcHJpdmF0ZQogICAqLwogIF9jcmVhdGVDaGFuZ2VFdmVudChvcGVyYXRpb25UeXBlLCBjb2xsZWN0aW9uLCBkb2MsIHVwZGF0ZURlc2NyaXB0aW9uKSB7CiAgICBjb25zdCBldmVudCA9IHsKICAgICAgX2lkOiB7CiAgICAgICAgX2RhdGE6IEJ1ZmZlci5mcm9tKFN0cmluZygrK3RoaXMuX2NoYW5nZUNvdW50ZXIpKS50b1N0cmluZygiYmFzZTY0IikKICAgICAgfSwKICAgICAgb3BlcmF0aW9uVHlwZSwKICAgICAgY2x1c3RlclRpbWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpLAogICAgICBuczogewogICAgICAgIGRiOiBjb2xsZWN0aW9uLmRiLmRiTmFtZSwKICAgICAgICBjb2xsOiBjb2xsZWN0aW9uLm5hbWUKICAgICAgfSwKICAgICAgZG9jdW1lbnRLZXk6IHsKICAgICAgICBfaWQ6IGRvYy5faWQKICAgICAgfQogICAgfTsKICAgIHN3aXRjaCAob3BlcmF0aW9uVHlwZSkgewogICAgICBjYXNlICJpbnNlcnQiOgogICAgICAgIGV2ZW50LmZ1bGxEb2N1bWVudCA9IGRvYzsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAidXBkYXRlIjoKICAgICAgICBldmVudC51cGRhdGVEZXNjcmlwdGlvbiA9IHVwZGF0ZURlc2NyaXB0aW9uIHx8IHsKICAgICAgICAgIHVwZGF0ZWRGaWVsZHM6IHt9LAogICAgICAgICAgcmVtb3ZlZEZpZWxkczogW10sCiAgICAgICAgICB0cnVuY2F0ZWRBcnJheXM6IFtdCiAgICAgICAgfTsKICAgICAgICBpZiAodGhpcy5vcHRpb25zLmZ1bGxEb2N1bWVudCA9PT0gInVwZGF0ZUxvb2t1cCIpIHsKICAgICAgICAgIGV2ZW50LmZ1bGxEb2N1bWVudCA9IGRvYzsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgInJlcGxhY2UiOgogICAgICAgIGV2ZW50LmZ1bGxEb2N1bWVudCA9IGRvYzsKICAgICAgICBicmVhazsKICAgIH0KICAgIHJldHVybiBldmVudDsKICB9CiAgLyoqCiAgICogQ2hlY2sgaWYgY2hhbmdlIGV2ZW50IG1hdGNoZXMgcGlwZWxpbmUgZmlsdGVycwogICAqIEBwcml2YXRlCiAgICovCiAgX21hdGNoZXNQaXBlbGluZShjaGFuZ2VFdmVudCkgewogICAgaWYgKCF0aGlzLnBpcGVsaW5lIHx8IHRoaXMucGlwZWxpbmUubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgZm9yIChjb25zdCBzdGFnZSBvZiB0aGlzLnBpcGVsaW5lKSB7CiAgICAgIGlmIChzdGFnZS4kbWF0Y2gpIHsKICAgICAgICBpZiAoIW1hdGNoZXMoY2hhbmdlRXZlbnQsIHN0YWdlLiRtYXRjaCkpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KICAvKioKICAgKiBHZXQgbmVzdGVkIHZhbHVlIGZyb20gb2JqZWN0IHVzaW5nIGRvdCBub3RhdGlvbgogICAqIEBwcml2YXRlCiAgICovCiAgX2dldE5lc3RlZFZhbHVlKG9iaiwgcGF0aCkgewogICAgcmV0dXJuIHBhdGguc3BsaXQoIi4iKS5yZWR1Y2UoKGN1cnJlbnQsIHBhcnQpID0+IGN1cnJlbnQ/LltwYXJ0XSwgb2JqKTsKICB9CiAgLyoqCiAgICogTW9uaXRvciBjbGllbnQgZm9yIG5ldyBkYXRhYmFzZXMvY29sbGVjdGlvbnMgKHNpbXBsaWZpZWQpCiAgICogQHByaXZhdGUKICAgKi8KICBfbW9uaXRvckNsaWVudCgpIHsKICB9CiAgLyoqCiAgICogSW50ZXJjZXB0IERCIGNyZWF0aW9uIG9uIGEgTW9uZ29DbGllbnQKICAgKiBAcHJpdmF0ZQogICAqLwogIF9pbnRlcmNlcHRDbGllbnREQkNyZWF0aW9uKCkgewogICAgY29uc3QgY2xpZW50ID0gdGhpcy50YXJnZXQ7CiAgICBjb25zdCBvcmlnaW5hbERiID0gY2xpZW50LmRiLmJpbmQoY2xpZW50KTsKICAgIGNvbnN0IHNlbGYyID0gdGhpczsKICAgIHRoaXMuX3dhdGNoZWREQnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgY2xpZW50LmRiID0gZnVuY3Rpb24obmFtZSwgb3B0cykgewogICAgICBjb25zdCBkYXRhYmFzZSA9IG9yaWdpbmFsRGIobmFtZSwgb3B0cyk7CiAgICAgIGNvbnN0IGRiTmFtZSA9IGRhdGFiYXNlLmRiTmFtZTsKICAgICAgaWYgKCFzZWxmMi5fd2F0Y2hlZERCcy5oYXMoZGJOYW1lKSkgewogICAgICAgIHNlbGYyLl93YXRjaGVkREJzLnNldChkYk5hbWUsIGRhdGFiYXNlKTsKICAgICAgICBjb25zdCBjb2xsZWN0aW9uTmFtZXMgPSBkYXRhYmFzZS5nZXRDb2xsZWN0aW9uTmFtZXMoKTsKICAgICAgICBmb3IgKGNvbnN0IGNvbE5hbWUgb2YgY29sbGVjdGlvbk5hbWVzKSB7CiAgICAgICAgICBjb25zdCBjb2wgPSBkYXRhYmFzZVtjb2xOYW1lXTsKICAgICAgICAgIGlmIChjb2wgJiYgY29sLmlzQ29sbGVjdGlvbiAmJiAhc2VsZjIuX2xpc3RlbmVycy5oYXMoY29sKSkgewogICAgICAgICAgICBzZWxmMi5fd2F0Y2hDb2xsZWN0aW9uKGNvbCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHNlbGYyLl9pbnRlcmNlcHREQkNvbGxlY3Rpb25DcmVhdGlvbkZvckNsaWVudChkYXRhYmFzZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGRhdGFiYXNlOwogICAgfTsKICAgIHRoaXMuX29yaWdpbmFsQ2xpZW50TWV0aG9kcyA9IHsgZGI6IG9yaWdpbmFsRGIgfTsKICB9CiAgLyoqCiAgICogSW50ZXJjZXB0IGNvbGxlY3Rpb24gY3JlYXRpb24gZm9yIGEgZGF0YWJhc2UgaW4gY2xpZW50IHdhdGNoIG1vZGUKICAgKiBAcHJpdmF0ZQogICAqLwogIF9pbnRlcmNlcHREQkNvbGxlY3Rpb25DcmVhdGlvbkZvckNsaWVudChkYikgewogICAgY29uc3Qgb3JpZ2luYWxDb2xsZWN0aW9uID0gZGIuY29sbGVjdGlvbi5iaW5kKGRiKTsKICAgIGNvbnN0IG9yaWdpbmFsQ3JlYXRlQ29sbGVjdGlvbiA9IGRiLmNyZWF0ZUNvbGxlY3Rpb24uYmluZChkYik7CiAgICBjb25zdCBzZWxmMiA9IHRoaXM7CiAgICBkYi5jb2xsZWN0aW9uID0gZnVuY3Rpb24obmFtZSkgewogICAgICBjb25zdCBjb2wgPSBvcmlnaW5hbENvbGxlY3Rpb24obmFtZSk7CiAgICAgIGlmIChjb2wgJiYgY29sLmlzQ29sbGVjdGlvbiAmJiAhc2VsZjIuX2xpc3RlbmVycy5oYXMoY29sKSkgewogICAgICAgIHNlbGYyLl93YXRjaENvbGxlY3Rpb24oY29sKTsKICAgICAgfQogICAgICByZXR1cm4gY29sOwogICAgfTsKICAgIGRiLmNyZWF0ZUNvbGxlY3Rpb24gPSBmdW5jdGlvbihuYW1lKSB7CiAgICAgIG9yaWdpbmFsQ3JlYXRlQ29sbGVjdGlvbihuYW1lKTsKICAgICAgY29uc3QgY29sID0gZGJbbmFtZV07CiAgICAgIGlmIChjb2wgJiYgY29sLmlzQ29sbGVjdGlvbiAmJiAhc2VsZjIuX2xpc3RlbmVycy5oYXMoY29sKSkgewogICAgICAgIHNlbGYyLl93YXRjaENvbGxlY3Rpb24oY29sKTsKICAgICAgfQogICAgfTsKICB9CiAgLyoqCiAgICogTW9uaXRvciBkYXRhYmFzZSBmb3IgbmV3IGNvbGxlY3Rpb25zCiAgICogQHByaXZhdGUKICAgKi8KICBfbW9uaXRvckRCKCkgewogIH0KICAvKioKICAgKiBJbnRlcmNlcHQgbmV3IGNvbGxlY3Rpb24gY3JlYXRpb24gb24gYSBEQgogICAqIEBwcml2YXRlCiAgICovCiAgX2ludGVyY2VwdERCQ29sbGVjdGlvbkNyZWF0aW9uKCkgewogICAgY29uc3QgZGIgPSB0aGlzLnRhcmdldDsKICAgIGNvbnN0IG9yaWdpbmFsQ29sbGVjdGlvbiA9IGRiLmNvbGxlY3Rpb24uYmluZChkYik7CiAgICBjb25zdCBvcmlnaW5hbENyZWF0ZUNvbGxlY3Rpb24gPSBkYi5jcmVhdGVDb2xsZWN0aW9uLmJpbmQoZGIpOwogICAgY29uc3Qgc2VsZjIgPSB0aGlzOwogICAgZGIuY29sbGVjdGlvbiA9IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgY29uc3QgY29sID0gb3JpZ2luYWxDb2xsZWN0aW9uKG5hbWUpOwogICAgICBpZiAoY29sICYmIGNvbC5pc0NvbGxlY3Rpb24gJiYgIXNlbGYyLl9saXN0ZW5lcnMuaGFzKGNvbCkpIHsKICAgICAgICBzZWxmMi5fd2F0Y2hDb2xsZWN0aW9uKGNvbCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGNvbDsKICAgIH07CiAgICBkYi5jcmVhdGVDb2xsZWN0aW9uID0gZnVuY3Rpb24obmFtZSkgewogICAgICBvcmlnaW5hbENyZWF0ZUNvbGxlY3Rpb24obmFtZSk7CiAgICAgIGNvbnN0IGNvbCA9IGRiW25hbWVdOwogICAgICBpZiAoY29sICYmIGNvbC5pc0NvbGxlY3Rpb24gJiYgIXNlbGYyLl9saXN0ZW5lcnMuaGFzKGNvbCkpIHsKICAgICAgICBzZWxmMi5fd2F0Y2hDb2xsZWN0aW9uKGNvbCk7CiAgICAgIH0KICAgIH07CiAgICB0aGlzLl9vcmlnaW5hbERCTWV0aG9kcyA9IHsgY29sbGVjdGlvbjogb3JpZ2luYWxDb2xsZWN0aW9uLCBjcmVhdGVDb2xsZWN0aW9uOiBvcmlnaW5hbENyZWF0ZUNvbGxlY3Rpb24gfTsKICB9CiAgLyoqCiAgICogQ2xvc2UgdGhlIGNoYW5nZSBzdHJlYW0KICAgKi8KICBjbG9zZSgpIHsKICAgIGlmICh0aGlzLmNsb3NlZCkgcmV0dXJuOwogICAgdGhpcy5jbG9zZWQgPSB0cnVlOwogICAgZm9yIChjb25zdCBbY29sbGVjdGlvbiwgaGFuZGxlcnNdIG9mIHRoaXMuX2xpc3RlbmVycykgewogICAgICBjb2xsZWN0aW9uLm9mZigiaW5zZXJ0IiwgaGFuZGxlcnMuaW5zZXJ0KTsKICAgICAgY29sbGVjdGlvbi5vZmYoInVwZGF0ZSIsIGhhbmRsZXJzLnVwZGF0ZSk7CiAgICAgIGNvbGxlY3Rpb24ub2ZmKCJyZXBsYWNlIiwgaGFuZGxlcnMucmVwbGFjZSk7CiAgICAgIGNvbGxlY3Rpb24ub2ZmKCJkZWxldGUiLCBoYW5kbGVycy5kZWxldGUpOwogICAgfQogICAgdGhpcy5fbGlzdGVuZXJzLmNsZWFyKCk7CiAgICBpZiAodGhpcy5fb3JpZ2luYWxEQk1ldGhvZHMgJiYgdGhpcy50YXJnZXQuY29uc3RydWN0b3IubmFtZSA9PT0gIkRCIikgewogICAgICB0aGlzLnRhcmdldC5jb2xsZWN0aW9uID0gdGhpcy5fb3JpZ2luYWxEQk1ldGhvZHMuY29sbGVjdGlvbjsKICAgICAgdGhpcy50YXJnZXQuY3JlYXRlQ29sbGVjdGlvbiA9IHRoaXMuX29yaWdpbmFsREJNZXRob2RzLmNyZWF0ZUNvbGxlY3Rpb247CiAgICB9CiAgICBpZiAodGhpcy5fb3JpZ2luYWxDbGllbnRNZXRob2RzICYmIHRoaXMudGFyZ2V0LmNvbnN0cnVjdG9yLm5hbWUgPT09ICJNb25nb0NsaWVudCIpIHsKICAgICAgdGhpcy50YXJnZXQuZGIgPSB0aGlzLl9vcmlnaW5hbENsaWVudE1ldGhvZHMuZGI7CiAgICB9CiAgICB0aGlzLmVtaXQoImNsb3NlIik7CiAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycygpOwogIH0KICAvKioKICAgKiBDaGVjayBpZiB0aGUgc3RyZWFtIGlzIGNsb3NlZAogICAqLwogIGdldCBpc0Nsb3NlZCgpIHsKICAgIHJldHVybiB0aGlzLmNsb3NlZDsKICB9CiAgLyoqCiAgICogQXN5bmMgaXRlcmF0b3Igc3VwcG9ydCBmb3IgZm9yLWF3YWl0LW9mIGxvb3BzCiAgICovCiAgYXN5bmMgKltTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKSB7CiAgICBjb25zdCBxdWV1ZSA9IFtdOwogICAgbGV0IHJlc29sdmVOZXh0ID0gbnVsbDsKICAgIGxldCBzdHJlYW1DbG9zZWQgPSBmYWxzZTsKICAgIGNvbnN0IG9uQ2hhbmdlID0gKGNoYW5nZSkgPT4gewogICAgICBpZiAocmVzb2x2ZU5leHQpIHsKICAgICAgICByZXNvbHZlTmV4dCh7IHZhbHVlOiBjaGFuZ2UsIGRvbmU6IGZhbHNlIH0pOwogICAgICAgIHJlc29sdmVOZXh0ID0gbnVsbDsKICAgICAgfSBlbHNlIHsKICAgICAgICBxdWV1ZS5wdXNoKGNoYW5nZSk7CiAgICAgIH0KICAgIH07CiAgICBjb25zdCBvbkNsb3NlID0gKCkgPT4gewogICAgICBzdHJlYW1DbG9zZWQgPSB0cnVlOwogICAgICBpZiAocmVzb2x2ZU5leHQpIHsKICAgICAgICByZXNvbHZlTmV4dCh7IGRvbmU6IHRydWUgfSk7CiAgICAgICAgcmVzb2x2ZU5leHQgPSBudWxsOwogICAgICB9CiAgICB9OwogICAgY29uc3Qgb25FcnJvciA9IChlcnJvcikgPT4gewogICAgICBpZiAocmVzb2x2ZU5leHQpIHsKICAgICAgICByZXNvbHZlTmV4dChQcm9taXNlLnJlamVjdChlcnJvcikpOwogICAgICAgIHJlc29sdmVOZXh0ID0gbnVsbDsKICAgICAgfQogICAgfTsKICAgIHRoaXMub24oImNoYW5nZSIsIG9uQ2hhbmdlKTsKICAgIHRoaXMub24oImNsb3NlIiwgb25DbG9zZSk7CiAgICB0aGlzLm9uKCJlcnJvciIsIG9uRXJyb3IpOwogICAgdHJ5IHsKICAgICAgd2hpbGUgKCFzdHJlYW1DbG9zZWQpIHsKICAgICAgICBpZiAocXVldWUubGVuZ3RoID4gMCkgewogICAgICAgICAgeWllbGQgcXVldWUuc2hpZnQoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3QgbmV4dCA9IGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgIHJlc29sdmVOZXh0ID0gcmVzb2x2ZTsKICAgICAgICAgICAgaWYgKHN0cmVhbUNsb3NlZCkgewogICAgICAgICAgICAgIHJlc29sdmUoeyBkb25lOiB0cnVlIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIGlmIChuZXh0LmRvbmUpIGJyZWFrOwogICAgICAgICAgeWllbGQgbmV4dC52YWx1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMub2ZmKCJjaGFuZ2UiLCBvbkNoYW5nZSk7CiAgICAgIHRoaXMub2ZmKCJjbG9zZSIsIG9uQ2xvc2UpOwogICAgICB0aGlzLm9mZigiZXJyb3IiLCBvbkVycm9yKTsKICAgIH0KICB9CiAgLyoqCiAgICogR2V0IG5leHQgY2hhbmdlIChmb3IgY29tcGF0aWJpbGl0eSkKICAgKi8KICBhc3luYyBuZXh0KCkgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgY29uc3Qgb25DaGFuZ2UgPSAoY2hhbmdlKSA9PiB7CiAgICAgICAgY2xlYW51cCgpOwogICAgICAgIHJlc29sdmUoY2hhbmdlKTsKICAgICAgfTsKICAgICAgY29uc3Qgb25DbG9zZSA9ICgpID0+IHsKICAgICAgICBjbGVhbnVwKCk7CiAgICAgICAgcmVzb2x2ZShudWxsKTsKICAgICAgfTsKICAgICAgY29uc3Qgb25FcnJvciA9IChlcnJvcikgPT4gewogICAgICAgIGNsZWFudXAoKTsKICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICB9OwogICAgICBjb25zdCBjbGVhbnVwID0gKCkgPT4gewogICAgICAgIHRoaXMub2ZmKCJjaGFuZ2UiLCBvbkNoYW5nZSk7CiAgICAgICAgdGhpcy5vZmYoImNsb3NlIiwgb25DbG9zZSk7CiAgICAgICAgdGhpcy5vZmYoImVycm9yIiwgb25FcnJvcik7CiAgICAgIH07CiAgICAgIGlmICh0aGlzLmNsb3NlZCkgewogICAgICAgIHJlc29sdmUobnVsbCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHRoaXMub25jZSgiY2hhbmdlIiwgb25DaGFuZ2UpOwogICAgICB0aGlzLm9uY2UoImNsb3NlIiwgb25DbG9zZSk7CiAgICAgIHRoaXMub25jZSgiZXJyb3IiLCBvbkVycm9yKTsKICAgIH0pOwogIH0KfQpjbGFzcyBDb2xsZWN0aW9uIGV4dGVuZHMgZXZlbnRzRXhwb3J0cy5FdmVudEVtaXR0ZXIgewogIGNvbnN0cnVjdG9yKGRiLCBuYW1lLCBvcHRpb25zID0ge30pIHsKICAgIHN1cGVyKCk7CiAgICB0aGlzLmRiID0gZGI7CiAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgdGhpcy5wYXRoID0gYCR7dGhpcy5kYi5iYXNlRm9sZGVyfS8ke3RoaXMuZGIuZGJOYW1lfS8ke3RoaXMubmFtZX1gOwogICAgdGhpcy5kb2N1bWVudHNQYXRoID0gYCR7dGhpcy5wYXRofS9kb2N1bWVudHMuYmpzb25gOwogICAgdGhpcy5vcmRlciA9IG9wdGlvbnMuYlBsdXNUcmVlT3JkZXIgfHwgNTA7CiAgICB0aGlzLmRvY3VtZW50cyA9IG51bGw7CiAgICB0aGlzLmluZGV4ZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgdGhpcy5faW5pdGlhbGl6ZWQgPSBmYWxzZTsKICAgIHRoaXMuaXNDb2xsZWN0aW9uID0gdHJ1ZTsKICAgIHRoaXMucXVlcnlQbGFubmVyID0gbmV3IFF1ZXJ5UGxhbm5lcih0aGlzLmluZGV4ZXMpOwogIH0KICBhc3luYyBfaW5pdGlhbGl6ZSgpIHsKICAgIGlmICh0aGlzLl9pbml0aWFsaXplZCkgcmV0dXJuOwogICAgaWYgKCFnbG9iYWxUaGlzLm5hdmlnYXRvciB8fCAhZ2xvYmFsVGhpcy5uYXZpZ2F0b3Iuc3RvcmFnZSB8fCB0eXBlb2YgZ2xvYmFsVGhpcy5uYXZpZ2F0b3Iuc3RvcmFnZS5nZXREaXJlY3RvcnkgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJPUEZTIG5vdCBhdmFpbGFibGU6IG5hdmlnYXRvci5zdG9yYWdlLmdldERpcmVjdG9yeSBpcyBtaXNzaW5nIik7CiAgICB9CiAgICBsZXQgZGlySGFuZGxlID0gYXdhaXQgdGhpcy5fZW5zdXJlRGlyZWN0b3J5Rm9yRmlsZSh0aGlzLmRvY3VtZW50c1BhdGgpOwogICAgaWYgKCFkaXJIYW5kbGUpIHsKICAgICAgZGlySGFuZGxlID0gYXdhaXQgZ2xvYmFsVGhpcy5uYXZpZ2F0b3Iuc3RvcmFnZS5nZXREaXJlY3RvcnkoKTsKICAgIH0KICAgIGNvbnN0IHBhdGhQYXJ0cyA9IHRoaXMuZG9jdW1lbnRzUGF0aC5zcGxpdCgiLyIpLmZpbHRlcihCb29sZWFuKTsKICAgIGNvbnN0IGZpbGVuYW1lID0gcGF0aFBhcnRzW3BhdGhQYXJ0cy5sZW5ndGggLSAxXTsKICAgIGlmICghZmlsZW5hbWUpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIGRvY3VtZW50cyBwYXRoOiAke3RoaXMuZG9jdW1lbnRzUGF0aH1gKTsKICAgIH0KICAgIGNvbnN0IGZpbGVIYW5kbGUgPSBhd2FpdCBkaXJIYW5kbGUuZ2V0RmlsZUhhbmRsZShmaWxlbmFtZSwgeyBjcmVhdGU6IHRydWUgfSk7CiAgICBjb25zdCBzeW5jSGFuZGxlID0gYXdhaXQgZmlsZUhhbmRsZS5jcmVhdGVTeW5jQWNjZXNzSGFuZGxlKCk7CiAgICB0aGlzLmRvY3VtZW50cyA9IG5ldyBCUGx1c1RyZWUoc3luY0hhbmRsZSwgdGhpcy5vcmRlcik7CiAgICBhd2FpdCB0aGlzLmRvY3VtZW50cy5vcGVuKCk7CiAgICBhd2FpdCB0aGlzLl9sb2FkSW5kZXhlcygpOwogICAgdGhpcy5faW5pdGlhbGl6ZWQgPSB0cnVlOwogIH0KICBhc3luYyBfZW5zdXJlRGlyZWN0b3J5Rm9yRmlsZShmaWxlUGF0aCkgewogICAgaWYgKCFmaWxlUGF0aCkgcmV0dXJuOwogICAgY29uc3QgcGF0aFBhcnRzID0gZmlsZVBhdGguc3BsaXQoIi8iKS5maWx0ZXIoQm9vbGVhbik7CiAgICBwYXRoUGFydHMucG9wKCk7CiAgICBpZiAocGF0aFBhcnRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwogICAgdHJ5IHsKICAgICAgbGV0IGRpciA9IGF3YWl0IGdsb2JhbFRoaXMubmF2aWdhdG9yLnN0b3JhZ2UuZ2V0RGlyZWN0b3J5KCk7CiAgICAgIGZvciAoY29uc3QgcGFydCBvZiBwYXRoUGFydHMpIHsKICAgICAgICBkaXIgPSBhd2FpdCBkaXIuZ2V0RGlyZWN0b3J5SGFuZGxlKHBhcnQsIHsgY3JlYXRlOiB0cnVlIH0pOwogICAgICB9CiAgICAgIHJldHVybiBkaXI7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoZXJyb3IuY29kZSAhPT0gIkVFWElTVCIpIHsKICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgfQogICAgfQogIH0KICBhc3luYyBfbG9hZEluZGV4ZXMoKSB7CiAgICBsZXQgZGlySGFuZGxlOwogICAgdHJ5IHsKICAgICAgY29uc3QgcGFydHMgPSB0aGlzLnBhdGguc3BsaXQoIi8iKS5maWx0ZXIoQm9vbGVhbik7CiAgICAgIGxldCBoYW5kbGUgPSBhd2FpdCBnbG9iYWxUaGlzLm5hdmlnYXRvci5zdG9yYWdlLmdldERpcmVjdG9yeSgpOwogICAgICBmb3IgKGNvbnN0IHBhcnQgb2YgcGFydHMpIHsKICAgICAgICBoYW5kbGUgPSBhd2FpdCBoYW5kbGUuZ2V0RGlyZWN0b3J5SGFuZGxlKHBhcnQsIHsgY3JlYXRlOiBmYWxzZSB9KTsKICAgICAgfQogICAgICBkaXJIYW5kbGUgPSBoYW5kbGU7CiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgaWYgKGVycj8ubmFtZSA9PT0gIk5vdEZvdW5kRXJyb3IiIHx8IGVycj8uY29kZSA9PT0gIkVOT0VOVCIpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdGhyb3cgZXJyOwogICAgfQogICAgZm9yIGF3YWl0IChjb25zdCBbZW50cnlOYW1lLCBlbnRyeUhhbmRsZV0gb2YgZGlySGFuZGxlLmVudHJpZXMoKSkgewogICAgICBpZiAoZW50cnlIYW5kbGUua2luZCAhPT0gImZpbGUiKSBjb250aW51ZTsKICAgICAgbGV0IHR5cGU7CiAgICAgIGlmIChlbnRyeU5hbWUuZW5kc1dpdGgoIi50ZXh0aW5kZXgtZG9jdW1lbnRzLmJqc29uIikpIHsKICAgICAgICB0eXBlID0gInRleHQiOwogICAgICB9IGVsc2UgaWYgKGVudHJ5TmFtZS5lbmRzV2l0aCgiLnJ0cmVlLmJqc29uIikpIHsKICAgICAgICB0eXBlID0gImdlb3NwYXRpYWwiOwogICAgICB9IGVsc2UgaWYgKGVudHJ5TmFtZS5lbmRzV2l0aCgiLmJwbHVzdHJlZS5ianNvbiIpKSB7CiAgICAgICAgdHlwZSA9ICJyZWd1bGFyIjsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBjb25zdCBpbmRleE5hbWUgPSBlbnRyeU5hbWUucmVwbGFjZSgvXC50ZXh0aW5kZXgtZG9jdW1lbnRzXC5ianNvbiQvLCAiIikucmVwbGFjZSgvXC5ydHJlZVwuYmpzb24kLywgIiIpLnJlcGxhY2UoL1wuYnBsdXN0cmVlXC5ianNvbiQvLCAiIik7CiAgICAgIGlmICh0aGlzLmluZGV4ZXMuaGFzKGluZGV4TmFtZSkpIGNvbnRpbnVlOwogICAgICBjb25zdCBrZXlzID0gdGhpcy5fcGFyc2VJbmRleE5hbWUoaW5kZXhOYW1lLCB0eXBlKTsKICAgICAgaWYgKCFrZXlzKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgbGV0IGluZGV4OwogICAgICBpZiAodHlwZSA9PT0gInRleHQiKSB7CiAgICAgICAgY29uc3Qgc3RvcmFnZUZpbGUgPSBhd2FpdCB0aGlzLl9nZXRJbmRleFBhdGgoaW5kZXhOYW1lLCB0eXBlKTsKICAgICAgICBpbmRleCA9IG5ldyBUZXh0Q29sbGVjdGlvbkluZGV4KGluZGV4TmFtZSwga2V5cywgc3RvcmFnZUZpbGUsIHt9KTsKICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAiZ2Vvc3BhdGlhbCIpIHsKICAgICAgICBjb25zdCBzdG9yYWdlRmlsZSA9IGF3YWl0IHRoaXMuX2dldEluZGV4UGF0aChpbmRleE5hbWUsIHR5cGUpOwogICAgICAgIGluZGV4ID0gbmV3IEdlb3NwYXRpYWxJbmRleChpbmRleE5hbWUsIGtleXMsIHN0b3JhZ2VGaWxlLCB7fSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3Qgc3RvcmFnZUZpbGUgPSBhd2FpdCB0aGlzLl9nZXRJbmRleFBhdGgoaW5kZXhOYW1lLCB0eXBlKTsKICAgICAgICBpbmRleCA9IG5ldyBSZWd1bGFyQ29sbGVjdGlvbkluZGV4KGluZGV4TmFtZSwga2V5cywgc3RvcmFnZUZpbGUsIHt9KTsKICAgICAgfQogICAgICB0cnkgewogICAgICAgIGF3YWl0IGluZGV4Lm9wZW4oKTsKICAgICAgICB0aGlzLmluZGV4ZXMuc2V0KGluZGV4TmFtZSwgaW5kZXgpOwogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBjb25zb2xlLndhcm4oYEZhaWxlZCB0byBvcGVuIGluZGV4ICR7aW5kZXhOYW1lfTpgLCBlcnIpOwogICAgICB9CiAgICB9CiAgfQogIF9wYXJzZUluZGV4TmFtZShpbmRleE5hbWUsIHR5cGUpIHsKICAgIGNvbnN0IHRva2VucyA9IGluZGV4TmFtZS5zcGxpdCgiXyIpOwogICAgaWYgKHRva2Vucy5sZW5ndGggPCAyIHx8IHRva2Vucy5sZW5ndGggJSAyICE9PSAwKSByZXR1cm4gbnVsbDsKICAgIGNvbnN0IGtleXMgPSB7fTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdG9rZW5zLmxlbmd0aDsgaSArPSAyKSB7CiAgICAgIGNvbnN0IGZpZWxkID0gdG9rZW5zW2ldOwogICAgICBjb25zdCBkaXIgPSB0b2tlbnNbaSArIDFdOwogICAgICBpZiAoIWZpZWxkIHx8IGRpciA9PT0gdm9pZCAwKSByZXR1cm4gbnVsbDsKICAgICAgaWYgKHR5cGUgPT09ICJ0ZXh0IiB8fCBkaXIgPT09ICJ0ZXh0IikgewogICAgICAgIGtleXNbZmllbGRdID0gInRleHQiOwogICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICJnZW9zcGF0aWFsIiB8fCBkaXIgPT09ICIyZHNwaGVyZSIgfHwgZGlyID09PSAiMmQiKSB7CiAgICAgICAga2V5c1tmaWVsZF0gPSBkaXIgPT09ICIyZCIgPyAiMmQiIDogIjJkc3BoZXJlIjsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBudW0gPSBOdW1iZXIoZGlyKTsKICAgICAgICBpZiAoTnVtYmVyLmlzTmFOKG51bSkgfHwgbnVtICE9PSAxICYmIG51bSAhPT0gLTEpIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBrZXlzW2ZpZWxkXSA9IG51bTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGtleXM7CiAgfQogIC8qKgogICAqIENsb3NlIGFsbCBpbmRleGVzCiAgICovCiAgYXN5bmMgY2xvc2UoKSB7CiAgICBpZiAoIXRoaXMuX2luaXRpYWxpemVkKSByZXR1cm47CiAgICBhd2FpdCB0aGlzLmRvY3VtZW50cy5jbG9zZSgpOwogICAgZm9yIChjb25zdCBbaW5kZXhOYW1lLCBpbmRleF0gb2YgdGhpcy5pbmRleGVzKSB7CiAgICAgIGF3YWl0IGluZGV4LmNsb3NlKCk7CiAgICB9CiAgfQogIC8qKgogICAqIEdlbmVyYXRlIGluZGV4IG5hbWUgZnJvbSBrZXlzCiAgICovCiAgZ2VuZXJhdGVJbmRleE5hbWUoa2V5cykgewogICAgY29uc3QgcGFydHMgPSBbXTsKICAgIGZvciAoY29uc3QgZmllbGQgaW4ga2V5cykgewogICAgICBpZiAoa2V5cy5oYXNPd25Qcm9wZXJ0eShmaWVsZCkpIHsKICAgICAgICBwYXJ0cy5wdXNoKGZpZWxkICsgIl8iICsga2V5c1tmaWVsZF0pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcGFydHMuam9pbigiXyIpOwogIH0KICAvKioKICAgKiBEZXRlcm1pbmUgaWYga2V5cyBzcGVjaWZ5IGEgdGV4dCBpbmRleAogICAqLwogIGlzVGV4dEluZGV4KGtleXMpIHsKICAgIGZvciAoY29uc3QgZmllbGQgaW4ga2V5cykgewogICAgICBpZiAoa2V5c1tmaWVsZF0gPT09ICJ0ZXh0IikgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIC8qKgogICAqIERldGVybWluZSBpZiBrZXlzIHNwZWNpZnkgYSBnZW9zcGF0aWFsIGluZGV4CiAgICovCiAgaXNHZW9zcGF0aWFsSW5kZXgoa2V5cykgewogICAgZm9yIChjb25zdCBmaWVsZCBpbiBrZXlzKSB7CiAgICAgIGlmIChrZXlzW2ZpZWxkXSA9PT0gIjJkc3BoZXJlIiB8fCBrZXlzW2ZpZWxkXSA9PT0gIjJkIikgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGFzeW5jIF9nZXRJbmRleFBhdGgoaW5kZXhOYW1lLCB0eXBlKSB7CiAgICBjb25zdCBzYW5pdGl6ZSA9ICh2YWx1ZSkgPT4gU3RyaW5nKHZhbHVlKS5yZXBsYWNlKC9bXmEtekEtWjAtOV8tXS9nLCAiXyIpOwogICAgY29uc3Qgc2FuaXRpemVkSW5kZXhOYW1lID0gc2FuaXRpemUoaW5kZXhOYW1lKTsKICAgIGlmICh0eXBlID09PSAidGV4dCIpIHsKICAgICAgcmV0dXJuIGAke3RoaXMucGF0aH0vJHtzYW5pdGl6ZWRJbmRleE5hbWV9LnRleHRpbmRleGA7CiAgICB9CiAgICBpZiAodHlwZSA9PT0gImdlb3NwYXRpYWwiKSB7CiAgICAgIHJldHVybiBgJHt0aGlzLnBhdGh9LyR7c2FuaXRpemVkSW5kZXhOYW1lfS5ydHJlZS5ianNvbmA7CiAgICB9CiAgICByZXR1cm4gYCR7dGhpcy5wYXRofS8ke3Nhbml0aXplZEluZGV4TmFtZX0uYnBsdXN0cmVlLmJqc29uYDsKICB9CiAgLyoqCiAgICogQnVpbGQvcmVidWlsZCBhbiBpbmRleAogICAqLwogIGFzeW5jIF9idWlsZEluZGV4KGluZGV4TmFtZSwga2V5cywgb3B0aW9ucyA9IHt9KSB7CiAgICBpZiAoIXRoaXMuX2luaXRpYWxpemVkKSBhd2FpdCB0aGlzLl9pbml0aWFsaXplKCk7CiAgICBsZXQgaW5kZXg7CiAgICBsZXQgc3RvcmFnZUZpbGU7CiAgICBsZXQgdHlwZTsKICAgIGlmICh0aGlzLmlzVGV4dEluZGV4KGtleXMpKSB7CiAgICAgIHR5cGUgPSAidGV4dCI7CiAgICAgIHN0b3JhZ2VGaWxlID0gYXdhaXQgdGhpcy5fZ2V0SW5kZXhQYXRoKGluZGV4TmFtZSwgdHlwZSk7CiAgICAgIGluZGV4ID0gbmV3IFRleHRDb2xsZWN0aW9uSW5kZXgoaW5kZXhOYW1lLCBrZXlzLCBzdG9yYWdlRmlsZSwgb3B0aW9ucyk7CiAgICB9IGVsc2UgaWYgKHRoaXMuaXNHZW9zcGF0aWFsSW5kZXgoa2V5cykpIHsKICAgICAgdHlwZSA9ICJnZW9zcGF0aWFsIjsKICAgICAgc3RvcmFnZUZpbGUgPSBhd2FpdCB0aGlzLl9nZXRJbmRleFBhdGgoaW5kZXhOYW1lLCB0eXBlKTsKICAgICAgaW5kZXggPSBuZXcgR2Vvc3BhdGlhbEluZGV4KGluZGV4TmFtZSwga2V5cywgc3RvcmFnZUZpbGUsIG9wdGlvbnMpOwogICAgfSBlbHNlIHsKICAgICAgdHlwZSA9ICJyZWd1bGFyIjsKICAgICAgc3RvcmFnZUZpbGUgPSBhd2FpdCB0aGlzLl9nZXRJbmRleFBhdGgoaW5kZXhOYW1lLCB0eXBlKTsKICAgICAgaW5kZXggPSBuZXcgUmVndWxhckNvbGxlY3Rpb25JbmRleChpbmRleE5hbWUsIGtleXMsIHN0b3JhZ2VGaWxlLCBvcHRpb25zKTsKICAgIH0KICAgIGF3YWl0IGluZGV4Lm9wZW4oKTsKICAgIGlmICh0eXBlb2YgaW5kZXguY2xlYXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgYXdhaXQgaW5kZXguY2xlYXIoKTsKICAgIH0KICAgIGZvciBhd2FpdCAoY29uc3QgZW50cnkgb2YgdGhpcy5kb2N1bWVudHMpIHsKICAgICAgaWYgKGVudHJ5ICYmIGVudHJ5LnZhbHVlKSB7CiAgICAgICAgYXdhaXQgaW5kZXguYWRkKGVudHJ5LnZhbHVlKTsKICAgICAgfQogICAgfQogICAgdGhpcy5pbmRleGVzLnNldChpbmRleE5hbWUsIGluZGV4KTsKICAgIHJldHVybiBpbmRleDsKICB9CiAgLyoqCiAgICogVXBkYXRlIGluZGV4ZXMgd2hlbiBhIGRvY3VtZW50IGlzIGluc2VydGVkCiAgICovCiAgYXN5bmMgdXBkYXRlSW5kZXhlc09uSW5zZXJ0KGRvYykgewogICAgY29uc3QgcHJvbWlzZXMgPSBbXTsKICAgIGZvciAoY29uc3QgW2luZGV4TmFtZSwgaW5kZXhdIG9mIHRoaXMuaW5kZXhlcykgewogICAgICBwcm9taXNlcy5wdXNoKChhc3luYyAoKSA9PiB7CiAgICAgICAgYXdhaXQgdGhpcy5fZW5zdXJlSW5kZXhPcGVuKGluZGV4KTsKICAgICAgICBhd2FpdCBpbmRleC5hZGQoZG9jKTsKICAgICAgfSkoKSk7CiAgICB9CiAgICBpZiAocHJvbWlzZXMubGVuZ3RoID4gMCkgewogICAgICBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcyk7CiAgICB9CiAgfQogIC8qKgogICAqIFVwZGF0ZSBpbmRleGVzIHdoZW4gYSBkb2N1bWVudCBpcyBkZWxldGVkCiAgICovCiAgYXN5bmMgdXBkYXRlSW5kZXhlc09uRGVsZXRlKGRvYykgewogICAgY29uc3QgcHJvbWlzZXMgPSBbXTsKICAgIGZvciAoY29uc3QgW2luZGV4TmFtZSwgaW5kZXhdIG9mIHRoaXMuaW5kZXhlcykgewogICAgICBwcm9taXNlcy5wdXNoKChhc3luYyAoKSA9PiB7CiAgICAgICAgYXdhaXQgdGhpcy5fZW5zdXJlSW5kZXhPcGVuKGluZGV4KTsKICAgICAgICBhd2FpdCBpbmRleC5yZW1vdmUoZG9jKTsKICAgICAgfSkoKSk7CiAgICB9CiAgICBpZiAocHJvbWlzZXMubGVuZ3RoID4gMCkgewogICAgICBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcyk7CiAgICB9CiAgfQogIC8qKgogICAqIEVuc3VyZSBhbiBpbmRleCBpcyBvcGVuIGJlZm9yZSB1c2luZyBpdAogICAqIEBwcml2YXRlCiAgICovCiAgYXN5bmMgX2Vuc3VyZUluZGV4T3BlbihpbmRleCkgewogICAgaWYgKGluZGV4ICYmIHR5cGVvZiBpbmRleC5vcGVuID09PSAiZnVuY3Rpb24iICYmICFpbmRleC5pc09wZW4pIHsKICAgICAgYXdhaXQgaW5kZXgub3BlbigpOwogICAgfQogIH0KICAvKioKICAgKiBRdWVyeSBwbGFubmVyIC0gYW5hbHl6ZSBxdWVyeSBhbmQgZGV0ZXJtaW5lIG9wdGltYWwgZXhlY3V0aW9uIHBsYW4KICAgKi8KICBwbGFuUXVlcnkocXVlcnkpIHsKICAgIGNvbnN0IHBsYW4gPSB0aGlzLnF1ZXJ5UGxhbm5lci5wbGFuKHF1ZXJ5KTsKICAgIHJldHVybiB7CiAgICAgIHVzZUluZGV4OiBwbGFuLnR5cGUgIT09ICJmdWxsX3NjYW4iLAogICAgICBwbGFuVHlwZTogcGxhbi50eXBlLAogICAgICBpbmRleE5hbWVzOiBwbGFuLmluZGV4ZXMsCiAgICAgIGRvY0lkczogbnVsbCwKICAgICAgLy8gRm9yY2UgZnVsbCBzY2FuIGZvciBub3cgLSB1c2UgcGxhblF1ZXJ5QXN5bmMgZm9yIGluZGV4IHJlc3VsdHMKICAgICAgZXN0aW1hdGVkQ29zdDogcGxhbi5lc3RpbWF0ZWRDb3N0LAogICAgICBpbmRleE9ubHk6IHBsYW4uaW5kZXhPbmx5IHx8IGZhbHNlCiAgICB9OwogIH0KICAvKioKICAgKiBBc3luYyB2ZXJzaW9uIG9mIHF1ZXJ5IHBsYW5uZXIgLSBmb3IgdXNlIHdpdGggYXN5bmMgaW5kZXhlcwogICAqLwogIGFzeW5jIHBsYW5RdWVyeUFzeW5jKHF1ZXJ5KSB7CiAgICBjb25zdCBwbGFuID0gdGhpcy5xdWVyeVBsYW5uZXIucGxhbihxdWVyeSk7CiAgICBjb25zdCBkb2NJZHMgPSBhd2FpdCB0aGlzLnF1ZXJ5UGxhbm5lci5leGVjdXRlKHBsYW4pOwogICAgcmV0dXJuIHsKICAgICAgdXNlSW5kZXg6IHBsYW4udHlwZSAhPT0gImZ1bGxfc2NhbiIsCiAgICAgIHBsYW5UeXBlOiBwbGFuLnR5cGUsCiAgICAgIGluZGV4TmFtZXM6IHBsYW4uaW5kZXhlcywKICAgICAgZG9jSWRzLAogICAgICBlc3RpbWF0ZWRDb3N0OiBwbGFuLmVzdGltYXRlZENvc3QsCiAgICAgIGluZGV4T25seTogcGxhbi5pbmRleE9ubHkgfHwgZmFsc2UKICAgIH07CiAgfQogIC8qKgogICAqIEdldCBhIHRleHQgaW5kZXggZm9yIHRoZSBnaXZlbiBmaWVsZAogICAqIEBwYXJhbSB7c3RyaW5nfSBmaWVsZCAtIFRoZSBmaWVsZCBuYW1lCiAgICogQHJldHVybnMge1RleHRDb2xsZWN0aW9uSW5kZXh8bnVsbH0gVGhlIHRleHQgaW5kZXggb3IgbnVsbCBpZiBub3QgZm91bmQKICAgKi8KICBnZXRUZXh0SW5kZXgoZmllbGQpIHsKICAgIGZvciAoY29uc3QgW2luZGV4TmFtZSwgaW5kZXhdIG9mIHRoaXMuaW5kZXhlcykgewogICAgICBpZiAoaW5kZXggaW5zdGFuY2VvZiBUZXh0Q29sbGVjdGlvbkluZGV4KSB7CiAgICAgICAgaWYgKGluZGV4LmluZGV4ZWRGaWVsZHMuaW5jbHVkZXMoZmllbGQpKSB7CiAgICAgICAgICByZXR1cm4gaW5kZXg7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9CiAgLy8gQ29sbGVjdGlvbiBtZXRob2RzCiAgYXN5bmMgYWdncmVnYXRlKHBpcGVsaW5lKSB7CiAgICBpZiAoIXBpcGVsaW5lIHx8ICFpc0FycmF5KHBpcGVsaW5lKSkgewogICAgICB0aHJvdyBuZXcgUXVlcnlFcnJvcigiUGlwZWxpbmUgbXVzdCBiZSBhbiBhcnJheSIsIHsKICAgICAgICBjb2xsZWN0aW9uOiB0aGlzLm5hbWUsCiAgICAgICAgY29kZTogRXJyb3JDb2Rlcy5GQUlMRURfVE9fUEFSU0UKICAgICAgfSk7CiAgICB9CiAgICBsZXQgcmVzdWx0cyA9IFtdOwogICAgY29uc3QgY3Vyc29yID0gdGhpcy5maW5kKHt9KTsKICAgIGF3YWl0IGN1cnNvci5fZW5zdXJlSW5pdGlhbGl6ZWQoKTsKICAgIHdoaWxlIChhd2FpdCBjdXJzb3IuaGFzTmV4dCgpKSB7CiAgICAgIHJlc3VsdHMucHVzaChhd2FpdCBjdXJzb3IubmV4dCgpKTsKICAgIH0KICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGlwZWxpbmUubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3Qgc3RhZ2UgPSBwaXBlbGluZVtpXTsKICAgICAgY29uc3Qgc3RhZ2VLZXlzID0gT2JqZWN0LmtleXMoc3RhZ2UpOwogICAgICBpZiAoc3RhZ2VLZXlzLmxlbmd0aCAhPT0gMSkgewogICAgICAgIHRocm93IG5ldyBRdWVyeUVycm9yKCJFYWNoIHBpcGVsaW5lIHN0YWdlIG11c3QgaGF2ZSBleGFjdGx5IG9uZSBrZXkiLCB7CiAgICAgICAgICBjb2xsZWN0aW9uOiB0aGlzLm5hbWUsCiAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLkZBSUxFRF9UT19QQVJTRQogICAgICAgIH0pOwogICAgICB9CiAgICAgIGNvbnN0IHN0YWdlVHlwZSA9IHN0YWdlS2V5c1swXTsKICAgICAgY29uc3Qgc3RhZ2VTcGVjID0gc3RhZ2Vbc3RhZ2VUeXBlXTsKICAgICAgaWYgKHN0YWdlVHlwZSA9PT0gIiRtYXRjaCIpIHsKICAgICAgICBjb25zdCBtYXRjaGVkID0gW107CiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCByZXN1bHRzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBpZiAobWF0Y2hlcyhyZXN1bHRzW2pdLCBzdGFnZVNwZWMpKSB7CiAgICAgICAgICAgIG1hdGNoZWQucHVzaChyZXN1bHRzW2pdKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmVzdWx0cyA9IG1hdGNoZWQ7CiAgICAgIH0gZWxzZSBpZiAoc3RhZ2VUeXBlID09PSAiJHByb2plY3QiKSB7CiAgICAgICAgY29uc3QgcHJvamVjdGVkID0gW107CiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCByZXN1bHRzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBwcm9qZWN0ZWQucHVzaChhcHBseVByb2plY3Rpb25XaXRoRXhwcmVzc2lvbnMoc3RhZ2VTcGVjLCByZXN1bHRzW2pdKSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdHMgPSBwcm9qZWN0ZWQ7CiAgICAgIH0gZWxzZSBpZiAoc3RhZ2VUeXBlID09PSAiJGFkZEZpZWxkcyIgfHwgc3RhZ2VUeXBlID09PSAiJHNldCIpIHsKICAgICAgICBjb25zdCBtb2RpZmllZCA9IFtdOwogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgcmVzdWx0cy5sZW5ndGg7IGorKykgewogICAgICAgICAgY29uc3QgZG9jID0gY29weShyZXN1bHRzW2pdKTsKICAgICAgICAgIGZvciAoY29uc3QgZmllbGQgaW4gc3RhZ2VTcGVjKSB7CiAgICAgICAgICAgIGNvbnN0IGV4cHIgPSBzdGFnZVNwZWNbZmllbGRdOwogICAgICAgICAgICBkb2NbZmllbGRdID0gZXZhbHVhdGVFeHByZXNzaW9uKGV4cHIsIHJlc3VsdHNbal0pOwogICAgICAgICAgfQogICAgICAgICAgbW9kaWZpZWQucHVzaChkb2MpOwogICAgICAgIH0KICAgICAgICByZXN1bHRzID0gbW9kaWZpZWQ7CiAgICAgIH0gZWxzZSBpZiAoc3RhZ2VUeXBlID09PSAiJHVuc2V0IikgewogICAgICAgIGNvbnN0IG1vZGlmaWVkID0gW107CiAgICAgICAgbGV0IGZpZWxkc1RvUmVtb3ZlID0gW107CiAgICAgICAgaWYgKHR5cGVvZiBzdGFnZVNwZWMgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICBmaWVsZHNUb1JlbW92ZSA9IFtzdGFnZVNwZWNdOwogICAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShzdGFnZVNwZWMpKSB7CiAgICAgICAgICBmaWVsZHNUb1JlbW92ZSA9IHN0YWdlU3BlYzsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBzdGFnZVNwZWMgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICBmaWVsZHNUb1JlbW92ZSA9IE9iamVjdC5rZXlzKHN0YWdlU3BlYyk7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgcmVzdWx0cy5sZW5ndGg7IGorKykgewogICAgICAgICAgY29uc3QgZG9jID0gY29weShyZXN1bHRzW2pdKTsKICAgICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgZmllbGRzVG9SZW1vdmUubGVuZ3RoOyBrKyspIHsKICAgICAgICAgICAgY29uc3QgZmllbGQgPSBmaWVsZHNUb1JlbW92ZVtrXTsKICAgICAgICAgICAgY29uc3QgcGF0aFBhcnRzID0gZmllbGQuc3BsaXQoIi4iKTsKICAgICAgICAgICAgaWYgKHBhdGhQYXJ0cy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICBkZWxldGUgZG9jW2ZpZWxkXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBsZXQgcGFyZW50ID0gZG9jOwogICAgICAgICAgICAgIGZvciAobGV0IG0gPSAwOyBtIDwgcGF0aFBhcnRzLmxlbmd0aCAtIDE7IG0rKykgewogICAgICAgICAgICAgICAgaWYgKHBhcmVudCA9PSB2b2lkIDAgfHwgcGFyZW50ID09IG51bGwpIGJyZWFrOwogICAgICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50W3BhdGhQYXJ0c1ttXV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChwYXJlbnQgIT0gdm9pZCAwICYmIHBhcmVudCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBkZWxldGUgcGFyZW50W3BhdGhQYXJ0c1twYXRoUGFydHMubGVuZ3RoIC0gMV1dOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgbW9kaWZpZWQucHVzaChkb2MpOwogICAgICAgIH0KICAgICAgICByZXN1bHRzID0gbW9kaWZpZWQ7CiAgICAgIH0gZWxzZSBpZiAoc3RhZ2VUeXBlID09PSAiJHNvcnQiKSB7CiAgICAgICAgY29uc3Qgc29ydEtleXMgPSBPYmplY3Qua2V5cyhzdGFnZVNwZWMpOwogICAgICAgIHJlc3VsdHMuc29ydChmdW5jdGlvbihhLCBiKSB7CiAgICAgICAgICBmb3IgKGxldCBrID0gMDsgayA8IHNvcnRLZXlzLmxlbmd0aDsgaysrKSB7CiAgICAgICAgICAgIGNvbnN0IGtleSA9IHNvcnRLZXlzW2tdOwogICAgICAgICAgICBpZiAoYVtrZXldID09PSB2b2lkIDAgJiYgYltrZXldICE9PSB2b2lkIDApIHJldHVybiAtMSAqIHN0YWdlU3BlY1trZXldOwogICAgICAgICAgICBpZiAoYVtrZXldICE9PSB2b2lkIDAgJiYgYltrZXldID09PSB2b2lkIDApIHJldHVybiAxICogc3RhZ2VTcGVjW2tleV07CiAgICAgICAgICAgIGlmIChhW2tleV0gPCBiW2tleV0pIHJldHVybiAtMSAqIHN0YWdlU3BlY1trZXldOwogICAgICAgICAgICBpZiAoYVtrZXldID4gYltrZXldKSByZXR1cm4gMSAqIHN0YWdlU3BlY1trZXldOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAoc3RhZ2VUeXBlID09PSAiJGxpbWl0IikgewogICAgICAgIHJlc3VsdHMgPSByZXN1bHRzLnNsaWNlKDAsIHN0YWdlU3BlYyk7CiAgICAgIH0gZWxzZSBpZiAoc3RhZ2VUeXBlID09PSAiJHNraXAiKSB7CiAgICAgICAgcmVzdWx0cyA9IHJlc3VsdHMuc2xpY2Uoc3RhZ2VTcGVjKTsKICAgICAgfSBlbHNlIGlmIChzdGFnZVR5cGUgPT09ICIkZ3JvdXAiKSB7CiAgICAgICAgY29uc3QgZ3JvdXBzID0ge307CiAgICAgICAgY29uc3QgZ3JvdXBJZCA9IHN0YWdlU3BlYy5faWQ7CiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCByZXN1bHRzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBjb25zdCBkb2MgPSByZXN1bHRzW2pdOwogICAgICAgICAgbGV0IGtleTsKICAgICAgICAgIGlmIChncm91cElkID09PSBudWxsIHx8IGdyb3VwSWQgPT09IHZvaWQgMCkgewogICAgICAgICAgICBrZXkgPSBudWxsOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAga2V5ID0gZXZhbHVhdGVFeHByZXNzaW9uKGdyb3VwSWQsIGRvYyk7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBrZXlTdHIgPSBKU09OLnN0cmluZ2lmeShrZXkpOwogICAgICAgICAgaWYgKCFncm91cHNba2V5U3RyXSkgewogICAgICAgICAgICBncm91cHNba2V5U3RyXSA9IHsKICAgICAgICAgICAgICBfaWQ6IGtleSwKICAgICAgICAgICAgICBkb2NzOiBbXSwKICAgICAgICAgICAgICBhY2N1bXVsYXRvcnM6IHt9CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICBncm91cHNba2V5U3RyXS5kb2NzLnB1c2goZG9jKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZ3JvdXBlZCA9IFtdOwogICAgICAgIGZvciAoY29uc3QgZ3JvdXBLZXkgaW4gZ3JvdXBzKSB7CiAgICAgICAgICBjb25zdCBncm91cCA9IGdyb3Vwc1tncm91cEtleV07CiAgICAgICAgICBjb25zdCByZXN1bHQgPSB7IF9pZDogZ3JvdXAuX2lkIH07CiAgICAgICAgICBmb3IgKGNvbnN0IGZpZWxkIGluIHN0YWdlU3BlYykgewogICAgICAgICAgICBpZiAoZmllbGQgPT09ICJfaWQiKSBjb250aW51ZTsKICAgICAgICAgICAgY29uc3QgYWNjdW11bGF0b3IgPSBzdGFnZVNwZWNbZmllbGRdOwogICAgICAgICAgICBjb25zdCBhY2NLZXlzID0gT2JqZWN0LmtleXMoYWNjdW11bGF0b3IpOwogICAgICAgICAgICBpZiAoYWNjS2V5cy5sZW5ndGggIT09IDEpIGNvbnRpbnVlOwogICAgICAgICAgICBjb25zdCBhY2NUeXBlID0gYWNjS2V5c1swXTsKICAgICAgICAgICAgY29uc3QgYWNjRXhwciA9IGFjY3VtdWxhdG9yW2FjY1R5cGVdOwogICAgICAgICAgICBpZiAoYWNjVHlwZSA9PT0gIiRzdW0iKSB7CiAgICAgICAgICAgICAgbGV0IHN1bSA9IDA7CiAgICAgICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBncm91cC5kb2NzLmxlbmd0aDsgaysrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24oYWNjRXhwciwgZ3JvdXAuZG9jc1trXSk7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgICAgc3VtICs9IHZhbDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsICE9PSBudWxsICYmIHZhbCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgIHN1bSArPSBOdW1iZXIodmFsKSB8fCAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXN1bHRbZmllbGRdID0gc3VtOwogICAgICAgICAgICB9IGVsc2UgaWYgKGFjY1R5cGUgPT09ICIkYXZnIikgewogICAgICAgICAgICAgIGxldCBzdW0gPSAwOwogICAgICAgICAgICAgIGxldCBjb3VudCA9IDA7CiAgICAgICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBncm91cC5kb2NzLmxlbmd0aDsgaysrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24oYWNjRXhwciwgZ3JvdXAuZG9jc1trXSk7CiAgICAgICAgICAgICAgICBpZiAodmFsICE9PSB2b2lkIDAgJiYgdmFsICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHN1bSArPSBOdW1iZXIodmFsKSB8fCAwOwogICAgICAgICAgICAgICAgICBjb3VudCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXN1bHRbZmllbGRdID0gY291bnQgPiAwID8gc3VtIC8gY291bnQgOiAwOwogICAgICAgICAgICB9IGVsc2UgaWYgKGFjY1R5cGUgPT09ICIkbWluIikgewogICAgICAgICAgICAgIGxldCBtaW4gPSB2b2lkIDA7CiAgICAgICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBncm91cC5kb2NzLmxlbmd0aDsgaysrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24oYWNjRXhwciwgZ3JvdXAuZG9jc1trXSk7CiAgICAgICAgICAgICAgICBpZiAodmFsICE9PSB2b2lkIDAgJiYgKG1pbiA9PT0gdm9pZCAwIHx8IHZhbCA8IG1pbikpIHsKICAgICAgICAgICAgICAgICAgbWluID0gdmFsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXN1bHRbZmllbGRdID0gbWluOwogICAgICAgICAgICB9IGVsc2UgaWYgKGFjY1R5cGUgPT09ICIkbWF4IikgewogICAgICAgICAgICAgIGxldCBtYXggPSB2b2lkIDA7CiAgICAgICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBncm91cC5kb2NzLmxlbmd0aDsgaysrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24oYWNjRXhwciwgZ3JvdXAuZG9jc1trXSk7CiAgICAgICAgICAgICAgICBpZiAodmFsICE9PSB2b2lkIDAgJiYgKG1heCA9PT0gdm9pZCAwIHx8IHZhbCA+IG1heCkpIHsKICAgICAgICAgICAgICAgICAgbWF4ID0gdmFsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXN1bHRbZmllbGRdID0gbWF4OwogICAgICAgICAgICB9IGVsc2UgaWYgKGFjY1R5cGUgPT09ICIkcHVzaCIpIHsKICAgICAgICAgICAgICBjb25zdCBhcnIgPSBbXTsKICAgICAgICAgICAgICBmb3IgKGxldCBrID0gMDsgayA8IGdyb3VwLmRvY3MubGVuZ3RoOyBrKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihhY2NFeHByLCBncm91cC5kb2NzW2tdKTsKICAgICAgICAgICAgICAgIGFyci5wdXNoKHZhbCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc3VsdFtmaWVsZF0gPSBhcnI7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWNjVHlwZSA9PT0gIiRhZGRUb1NldCIpIHsKICAgICAgICAgICAgICBjb25zdCBzZXQgPSB7fTsKICAgICAgICAgICAgICBmb3IgKGxldCBrID0gMDsgayA8IGdyb3VwLmRvY3MubGVuZ3RoOyBrKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihhY2NFeHByLCBncm91cC5kb2NzW2tdKTsKICAgICAgICAgICAgICAgIHNldFtKU09OLnN0cmluZ2lmeSh2YWwpXSA9IHZhbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29uc3QgYXJyID0gW107CiAgICAgICAgICAgICAgZm9yIChjb25zdCB2YWxLZXkgaW4gc2V0KSB7CiAgICAgICAgICAgICAgICBhcnIucHVzaChzZXRbdmFsS2V5XSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc3VsdFtmaWVsZF0gPSBhcnI7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWNjVHlwZSA9PT0gIiRmaXJzdCIpIHsKICAgICAgICAgICAgICBpZiAoZ3JvdXAuZG9jcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICByZXN1bHRbZmllbGRdID0gZXZhbHVhdGVFeHByZXNzaW9uKGFjY0V4cHIsIGdyb3VwLmRvY3NbMF0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChhY2NUeXBlID09PSAiJGxhc3QiKSB7CiAgICAgICAgICAgICAgaWYgKGdyb3VwLmRvY3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgcmVzdWx0W2ZpZWxkXSA9IGV2YWx1YXRlRXhwcmVzc2lvbihhY2NFeHByLCBncm91cC5kb2NzW2dyb3VwLmRvY3MubGVuZ3RoIC0gMV0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChhY2NUeXBlID09PSAiJHN0ZERldlBvcCIpIHsKICAgICAgICAgICAgICBjb25zdCB2YWx1ZXMgPSBbXTsKICAgICAgICAgICAgICBmb3IgKGxldCBrID0gMDsgayA8IGdyb3VwLmRvY3MubGVuZ3RoOyBrKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihhY2NFeHByLCBncm91cC5kb2NzW2tdKTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgICB2YWx1ZXMucHVzaCh2YWwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodmFsdWVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IG1lYW4gPSB2YWx1ZXMucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCkgLyB2YWx1ZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgY29uc3QgdmFyaWFuY2UgPSB2YWx1ZXMucmVkdWNlKChzdW0sIHZhbCkgPT4gc3VtICsgTWF0aC5wb3codmFsIC0gbWVhbiwgMiksIDApIC8gdmFsdWVzLmxlbmd0aDsKICAgICAgICAgICAgICAgIHJlc3VsdFtmaWVsZF0gPSBNYXRoLnNxcnQodmFyaWFuY2UpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXN1bHRbZmllbGRdID0gMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWNjVHlwZSA9PT0gIiRzdGREZXZTYW1wIikgewogICAgICAgICAgICAgIGNvbnN0IHZhbHVlcyA9IFtdOwogICAgICAgICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgZ3JvdXAuZG9jcy5sZW5ndGg7IGsrKykgewogICAgICAgICAgICAgICAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKGFjY0V4cHIsIGdyb3VwLmRvY3Nba10pOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWwgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICAgIHZhbHVlcy5wdXNoKHZhbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh2YWx1ZXMubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgICAgY29uc3QgbWVhbiA9IHZhbHVlcy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIHZhbHVlcy5sZW5ndGg7CiAgICAgICAgICAgICAgICBjb25zdCB2YXJpYW5jZSA9IHZhbHVlcy5yZWR1Y2UoKHN1bSwgdmFsKSA9PiBzdW0gKyBNYXRoLnBvdyh2YWwgLSBtZWFuLCAyKSwgMCkgLyAodmFsdWVzLmxlbmd0aCAtIDEpOwogICAgICAgICAgICAgICAgcmVzdWx0W2ZpZWxkXSA9IE1hdGguc3FydCh2YXJpYW5jZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlc3VsdFtmaWVsZF0gPSAwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChhY2NUeXBlID09PSAiJG1lcmdlT2JqZWN0cyIpIHsKICAgICAgICAgICAgICBjb25zdCBtZXJnZWQgPSB7fTsKICAgICAgICAgICAgICBmb3IgKGxldCBrID0gMDsgayA8IGdyb3VwLmRvY3MubGVuZ3RoOyBrKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihhY2NFeHByLCBncm91cC5kb2NzW2tdKTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsID09PSAib2JqZWN0IiAmJiB2YWwgIT09IG51bGwgJiYgIUFycmF5LmlzQXJyYXkodmFsKSkgewogICAgICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKG1lcmdlZCwgdmFsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzdWx0W2ZpZWxkXSA9IG1lcmdlZDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZ3JvdXBlZC5wdXNoKHJlc3VsdCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdHMgPSBncm91cGVkOwogICAgICB9IGVsc2UgaWYgKHN0YWdlVHlwZSA9PT0gIiRjb3VudCIpIHsKICAgICAgICByZXN1bHRzID0gW3sgW3N0YWdlU3BlY106IHJlc3VsdHMubGVuZ3RoIH1dOwogICAgICB9IGVsc2UgaWYgKHN0YWdlVHlwZSA9PT0gIiR1bndpbmQiKSB7CiAgICAgICAgY29uc3QgdW53b3VuZCA9IFtdOwogICAgICAgIGxldCBmaWVsZFBhdGggPSBzdGFnZVNwZWM7CiAgICAgICAgaWYgKHR5cGVvZiBmaWVsZFBhdGggPT09ICJzdHJpbmciICYmIGZpZWxkUGF0aC5jaGFyQXQoMCkgPT09ICIkIikgewogICAgICAgICAgZmllbGRQYXRoID0gZmllbGRQYXRoLnN1YnN0cmluZygxKTsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCByZXN1bHRzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBjb25zdCBkb2MgPSByZXN1bHRzW2pdOwogICAgICAgICAgY29uc3QgYXJyID0gZ2V0UHJvcChkb2MsIGZpZWxkUGF0aCk7CiAgICAgICAgICBpZiAoYXJyICYmIGlzQXJyYXkoYXJyKSAmJiBhcnIubGVuZ3RoID4gMCkgewogICAgICAgICAgICBmb3IgKGxldCBrID0gMDsgayA8IGFyci5sZW5ndGg7IGsrKykgewogICAgICAgICAgICAgIGNvbnN0IHVud291bmREb2MgPSBjb3B5KGRvYyk7CiAgICAgICAgICAgICAgY29uc3QgcGFydHMgPSBmaWVsZFBhdGguc3BsaXQoIi4iKTsKICAgICAgICAgICAgICBsZXQgdGFyZ2V0ID0gdW53b3VuZERvYzsKICAgICAgICAgICAgICBmb3IgKGxldCBsID0gMDsgbCA8IHBhcnRzLmxlbmd0aCAtIDE7IGwrKykgewogICAgICAgICAgICAgICAgaWYgKCF0YXJnZXRbcGFydHNbbF1dKSB7CiAgICAgICAgICAgICAgICAgIHRhcmdldFtwYXJ0c1tsXV0gPSB7fTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRhcmdldCA9IHRhcmdldFtwYXJ0c1tsXV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRhcmdldFtwYXJ0c1twYXJ0cy5sZW5ndGggLSAxXV0gPSBhcnJba107CiAgICAgICAgICAgICAgdW53b3VuZC5wdXNoKHVud291bmREb2MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJlc3VsdHMgPSB1bndvdW5kOwogICAgICB9IGVsc2UgaWYgKHN0YWdlVHlwZSA9PT0gIiRzb3J0QnlDb3VudCIpIHsKICAgICAgICBjb25zdCBncm91cHMgPSB7fTsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHJlc3VsdHMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGNvbnN0IGRvYyA9IHJlc3VsdHNbal07CiAgICAgICAgICBjb25zdCB2YWx1ZSA9IGV2YWx1YXRlRXhwcmVzc2lvbihzdGFnZVNwZWMsIGRvYyk7CiAgICAgICAgICBjb25zdCBrZXkgPSBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7CiAgICAgICAgICBpZiAoIWdyb3Vwc1trZXldKSB7CiAgICAgICAgICAgIGdyb3Vwc1trZXldID0gewogICAgICAgICAgICAgIF9pZDogdmFsdWUsCiAgICAgICAgICAgICAgY291bnQ6IDAKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIGdyb3Vwc1trZXldLmNvdW50Kys7CiAgICAgICAgfQogICAgICAgIHJlc3VsdHMgPSBPYmplY3QudmFsdWVzKGdyb3Vwcykuc29ydCgoYSwgYikgPT4gYi5jb3VudCAtIGEuY291bnQpOwogICAgICB9IGVsc2UgaWYgKHN0YWdlVHlwZSA9PT0gIiRyZXBsYWNlUm9vdCIgfHwgc3RhZ2VUeXBlID09PSAiJHJlcGxhY2VXaXRoIikgewogICAgICAgIGNvbnN0IG1vZGlmaWVkID0gW107CiAgICAgICAgY29uc3QgbmV3Um9vdFNwZWMgPSBzdGFnZVR5cGUgPT09ICIkcmVwbGFjZVJvb3QiID8gc3RhZ2VTcGVjLm5ld1Jvb3QgOiBzdGFnZVNwZWM7CiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCByZXN1bHRzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBjb25zdCBuZXdSb290ID0gZXZhbHVhdGVFeHByZXNzaW9uKG5ld1Jvb3RTcGVjLCByZXN1bHRzW2pdKTsKICAgICAgICAgIGlmICh0eXBlb2YgbmV3Um9vdCA9PT0gIm9iamVjdCIgJiYgbmV3Um9vdCAhPT0gbnVsbCAmJiAhQXJyYXkuaXNBcnJheShuZXdSb290KSkgewogICAgICAgICAgICBtb2RpZmllZC5wdXNoKG5ld1Jvb3QpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgbmV3IFF1ZXJ5RXJyb3IoIiRyZXBsYWNlUm9vdCBleHByZXNzaW9uIG11c3QgZXZhbHVhdGUgdG8gYW4gb2JqZWN0IiwgewogICAgICAgICAgICAgIGNvbGxlY3Rpb246IHRoaXMubmFtZSwKICAgICAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLkZBSUxFRF9UT19QQVJTRQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmVzdWx0cyA9IG1vZGlmaWVkOwogICAgICB9IGVsc2UgaWYgKHN0YWdlVHlwZSA9PT0gIiRzYW1wbGUiKSB7CiAgICAgICAgY29uc3Qgc2l6ZSA9IHN0YWdlU3BlYy5zaXplIHx8IDE7CiAgICAgICAgaWYgKHR5cGVvZiBzaXplICE9PSAibnVtYmVyIiB8fCBzaXplIDwgMCkgewogICAgICAgICAgdGhyb3cgbmV3IFF1ZXJ5RXJyb3IoIiRzYW1wbGUgc2l6ZSBtdXN0IGJlIGEgbm9uLW5lZ2F0aXZlIG51bWJlciIsIHsKICAgICAgICAgICAgY29sbGVjdGlvbjogdGhpcy5uYW1lLAogICAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLkZBSUxFRF9UT19QQVJTRQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHNodWZmbGVkID0gWy4uLnJlc3VsdHNdOwogICAgICAgIGZvciAobGV0IGogPSBzaHVmZmxlZC5sZW5ndGggLSAxOyBqID4gMDsgai0tKSB7CiAgICAgICAgICBjb25zdCBrID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogKGogKyAxKSk7CiAgICAgICAgICBbc2h1ZmZsZWRbal0sIHNodWZmbGVkW2tdXSA9IFtzaHVmZmxlZFtrXSwgc2h1ZmZsZWRbal1dOwogICAgICAgIH0KICAgICAgICByZXN1bHRzID0gc2h1ZmZsZWQuc2xpY2UoMCwgTWF0aC5taW4oc2l6ZSwgc2h1ZmZsZWQubGVuZ3RoKSk7CiAgICAgIH0gZWxzZSBpZiAoc3RhZ2VUeXBlID09PSAiJGJ1Y2tldCIpIHsKICAgICAgICBpZiAoIXN0YWdlU3BlYy5ncm91cEJ5IHx8ICFzdGFnZVNwZWMuYm91bmRhcmllcykgewogICAgICAgICAgdGhyb3cgbmV3IFF1ZXJ5RXJyb3IoIiRidWNrZXQgcmVxdWlyZXMgZ3JvdXBCeSBhbmQgYm91bmRhcmllcyIsIHsKICAgICAgICAgICAgY29sbGVjdGlvbjogdGhpcy5uYW1lLAogICAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLkZBSUxFRF9UT19QQVJTRQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGJvdW5kYXJpZXMgPSBzdGFnZVNwZWMuYm91bmRhcmllczsKICAgICAgICBjb25zdCBkZWZhdWx0QnVja2V0ID0gc3RhZ2VTcGVjLmRlZmF1bHQ7CiAgICAgICAgY29uc3Qgb3V0cHV0ID0gc3RhZ2VTcGVjLm91dHB1dCB8fCB7IGNvdW50OiB7ICRzdW06IDEgfSB9OwogICAgICAgIGNvbnN0IGJ1Y2tldHMgPSB7fTsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGJvdW5kYXJpZXMubGVuZ3RoIC0gMTsgaisrKSB7CiAgICAgICAgICBjb25zdCBrZXkgPSBKU09OLnN0cmluZ2lmeShib3VuZGFyaWVzW2pdKTsKICAgICAgICAgIGJ1Y2tldHNba2V5XSA9IHsKICAgICAgICAgICAgX2lkOiBib3VuZGFyaWVzW2pdLAogICAgICAgICAgICBkb2NzOiBbXQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlZmF1bHRCdWNrZXQgIT09IHZvaWQgMCkgewogICAgICAgICAgYnVja2V0c1siZGVmYXVsdCJdID0gewogICAgICAgICAgICBfaWQ6IGRlZmF1bHRCdWNrZXQsCiAgICAgICAgICAgIGRvY3M6IFtdCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHJlc3VsdHMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGNvbnN0IGRvYyA9IHJlc3VsdHNbal07CiAgICAgICAgICBjb25zdCB2YWx1ZSA9IGV2YWx1YXRlRXhwcmVzc2lvbihzdGFnZVNwZWMuZ3JvdXBCeSwgZG9jKTsKICAgICAgICAgIGxldCBwbGFjZWQgPSBmYWxzZTsKICAgICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgYm91bmRhcmllcy5sZW5ndGggLSAxOyBrKyspIHsKICAgICAgICAgICAgaWYgKHZhbHVlID49IGJvdW5kYXJpZXNba10gJiYgdmFsdWUgPCBib3VuZGFyaWVzW2sgKyAxXSkgewogICAgICAgICAgICAgIGNvbnN0IGtleSA9IEpTT04uc3RyaW5naWZ5KGJvdW5kYXJpZXNba10pOwogICAgICAgICAgICAgIGJ1Y2tldHNba2V5XS5kb2NzLnB1c2goZG9jKTsKICAgICAgICAgICAgICBwbGFjZWQgPSB0cnVlOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXBsYWNlZCAmJiBkZWZhdWx0QnVja2V0ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgYnVja2V0c1siZGVmYXVsdCJdLmRvY3MucHVzaChkb2MpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBidWNrZXRlZCA9IFtdOwogICAgICAgIGZvciAoY29uc3QgYnVja2V0S2V5IGluIGJ1Y2tldHMpIHsKICAgICAgICAgIGNvbnN0IGJ1Y2tldCA9IGJ1Y2tldHNbYnVja2V0S2V5XTsKICAgICAgICAgIGlmIChidWNrZXQuZG9jcy5sZW5ndGggPT09IDApIGNvbnRpbnVlOwogICAgICAgICAgY29uc3QgcmVzdWx0ID0geyBfaWQ6IGJ1Y2tldC5faWQgfTsKICAgICAgICAgIGZvciAoY29uc3QgZmllbGQgaW4gb3V0cHV0KSB7CiAgICAgICAgICAgIGNvbnN0IGFjY3VtdWxhdG9yID0gb3V0cHV0W2ZpZWxkXTsKICAgICAgICAgICAgY29uc3QgYWNjS2V5cyA9IE9iamVjdC5rZXlzKGFjY3VtdWxhdG9yKTsKICAgICAgICAgICAgaWYgKGFjY0tleXMubGVuZ3RoICE9PSAxKSBjb250aW51ZTsKICAgICAgICAgICAgY29uc3QgYWNjVHlwZSA9IGFjY0tleXNbMF07CiAgICAgICAgICAgIGNvbnN0IGFjY0V4cHIgPSBhY2N1bXVsYXRvclthY2NUeXBlXTsKICAgICAgICAgICAgaWYgKGFjY1R5cGUgPT09ICIkc3VtIikgewogICAgICAgICAgICAgIGxldCBzdW0gPSAwOwogICAgICAgICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgYnVja2V0LmRvY3MubGVuZ3RoOyBrKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihhY2NFeHByLCBidWNrZXQuZG9jc1trXSk7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgICAgc3VtICs9IHZhbDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsICE9PSBudWxsICYmIHZhbCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgIHN1bSArPSBOdW1iZXIodmFsKSB8fCAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXN1bHRbZmllbGRdID0gc3VtOwogICAgICAgICAgICB9IGVsc2UgaWYgKGFjY1R5cGUgPT09ICIkYXZnIikgewogICAgICAgICAgICAgIGxldCBzdW0gPSAwOwogICAgICAgICAgICAgIGxldCBjb3VudCA9IDA7CiAgICAgICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBidWNrZXQuZG9jcy5sZW5ndGg7IGsrKykgewogICAgICAgICAgICAgICAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKGFjY0V4cHIsIGJ1Y2tldC5kb2NzW2tdKTsKICAgICAgICAgICAgICAgIGlmICh2YWwgIT09IHZvaWQgMCAmJiB2YWwgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgc3VtICs9IE51bWJlcih2YWwpIHx8IDA7CiAgICAgICAgICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc3VsdFtmaWVsZF0gPSBjb3VudCA+IDAgPyBzdW0gLyBjb3VudCA6IDA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWNjVHlwZSA9PT0gIiRwdXNoIikgewogICAgICAgICAgICAgIGNvbnN0IGFyciA9IFtdOwogICAgICAgICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgYnVja2V0LmRvY3MubGVuZ3RoOyBrKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihhY2NFeHByLCBidWNrZXQuZG9jc1trXSk7CiAgICAgICAgICAgICAgICBhcnIucHVzaCh2YWwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXN1bHRbZmllbGRdID0gYXJyOwogICAgICAgICAgICB9IGVsc2UgaWYgKGFjY1R5cGUgPT09ICIkYWRkVG9TZXQiKSB7CiAgICAgICAgICAgICAgY29uc3Qgc2V0ID0ge307CiAgICAgICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBidWNrZXQuZG9jcy5sZW5ndGg7IGsrKykgewogICAgICAgICAgICAgICAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKGFjY0V4cHIsIGJ1Y2tldC5kb2NzW2tdKTsKICAgICAgICAgICAgICAgIHNldFtKU09OLnN0cmluZ2lmeSh2YWwpXSA9IHZhbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzdWx0W2ZpZWxkXSA9IE9iamVjdC52YWx1ZXMoc2V0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgYnVja2V0ZWQucHVzaChyZXN1bHQpOwogICAgICAgIH0KICAgICAgICByZXN1bHRzID0gYnVja2V0ZWQuc29ydCgoYSwgYikgPT4gewogICAgICAgICAgaWYgKGEuX2lkIDwgYi5faWQpIHJldHVybiAtMTsKICAgICAgICAgIGlmIChhLl9pZCA+IGIuX2lkKSByZXR1cm4gMTsKICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKHN0YWdlVHlwZSA9PT0gIiRidWNrZXRBdXRvIikgewogICAgICAgIGlmICghc3RhZ2VTcGVjLmdyb3VwQnkgfHwgIXN0YWdlU3BlYy5idWNrZXRzKSB7CiAgICAgICAgICB0aHJvdyBuZXcgUXVlcnlFcnJvcigiJGJ1Y2tldEF1dG8gcmVxdWlyZXMgZ3JvdXBCeSBhbmQgYnVja2V0cyIsIHsKICAgICAgICAgICAgY29sbGVjdGlvbjogdGhpcy5uYW1lLAogICAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLkZBSUxFRF9UT19QQVJTRQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG51bUJ1Y2tldHMgPSBzdGFnZVNwZWMuYnVja2V0czsKICAgICAgICBjb25zdCBvdXRwdXQgPSBzdGFnZVNwZWMub3V0cHV0IHx8IHsgY291bnQ6IHsgJHN1bTogMSB9IH07CiAgICAgICAgaWYgKHJlc3VsdHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICByZXN1bHRzID0gW107CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IHZhbHVlcyA9IHJlc3VsdHMubWFwKChkb2MpID0+ICh7CiAgICAgICAgICAgIHZhbHVlOiBldmFsdWF0ZUV4cHJlc3Npb24oc3RhZ2VTcGVjLmdyb3VwQnksIGRvYyksCiAgICAgICAgICAgIGRvYwogICAgICAgICAgfSkpLnNvcnQoKGEsIGIpID0+IHsKICAgICAgICAgICAgaWYgKGEudmFsdWUgPCBiLnZhbHVlKSByZXR1cm4gLTE7CiAgICAgICAgICAgIGlmIChhLnZhbHVlID4gYi52YWx1ZSkgcmV0dXJuIDE7CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgfSk7CiAgICAgICAgICBjb25zdCBidWNrZXRTaXplID0gTWF0aC5jZWlsKHZhbHVlcy5sZW5ndGggLyBudW1CdWNrZXRzKTsKICAgICAgICAgIGNvbnN0IGJ1Y2tldHMgPSBbXTsKICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgbnVtQnVja2V0cyAmJiBqICogYnVja2V0U2l6ZSA8IHZhbHVlcy5sZW5ndGg7IGorKykgewogICAgICAgICAgICBjb25zdCBzdGFydElkeCA9IGogKiBidWNrZXRTaXplOwogICAgICAgICAgICBjb25zdCBlbmRJZHggPSBNYXRoLm1pbigoaiArIDEpICogYnVja2V0U2l6ZSwgdmFsdWVzLmxlbmd0aCk7CiAgICAgICAgICAgIGNvbnN0IGJ1Y2tldERvY3MgPSB2YWx1ZXMuc2xpY2Uoc3RhcnRJZHgsIGVuZElkeCk7CiAgICAgICAgICAgIGlmIChidWNrZXREb2NzLmxlbmd0aCA9PT0gMCkgY29udGludWU7CiAgICAgICAgICAgIGNvbnN0IGJ1Y2tldCA9IHsKICAgICAgICAgICAgICBfaWQ6IHsKICAgICAgICAgICAgICAgIG1pbjogYnVja2V0RG9jc1swXS52YWx1ZSwKICAgICAgICAgICAgICAgIG1heDogZW5kSWR4IDwgdmFsdWVzLmxlbmd0aCA/IGJ1Y2tldERvY3NbYnVja2V0RG9jcy5sZW5ndGggLSAxXS52YWx1ZSA6IGJ1Y2tldERvY3NbYnVja2V0RG9jcy5sZW5ndGggLSAxXS52YWx1ZQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZG9jczogYnVja2V0RG9jcy5tYXAoKHYpID0+IHYuZG9jKQogICAgICAgICAgICB9OwogICAgICAgICAgICBidWNrZXRzLnB1c2goYnVja2V0KTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGJ1Y2tldGVkID0gW107CiAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGJ1Y2tldHMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgY29uc3QgYnVja2V0ID0gYnVja2V0c1tqXTsKICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0geyBfaWQ6IGJ1Y2tldC5faWQgfTsKICAgICAgICAgICAgZm9yIChjb25zdCBmaWVsZCBpbiBvdXRwdXQpIHsKICAgICAgICAgICAgICBjb25zdCBhY2N1bXVsYXRvciA9IG91dHB1dFtmaWVsZF07CiAgICAgICAgICAgICAgY29uc3QgYWNjS2V5cyA9IE9iamVjdC5rZXlzKGFjY3VtdWxhdG9yKTsKICAgICAgICAgICAgICBpZiAoYWNjS2V5cy5sZW5ndGggIT09IDEpIGNvbnRpbnVlOwogICAgICAgICAgICAgIGNvbnN0IGFjY1R5cGUgPSBhY2NLZXlzWzBdOwogICAgICAgICAgICAgIGNvbnN0IGFjY0V4cHIgPSBhY2N1bXVsYXRvclthY2NUeXBlXTsKICAgICAgICAgICAgICBpZiAoYWNjVHlwZSA9PT0gIiRzdW0iKSB7CiAgICAgICAgICAgICAgICBsZXQgc3VtID0gMDsKICAgICAgICAgICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgYnVja2V0LmRvY3MubGVuZ3RoOyBrKyspIHsKICAgICAgICAgICAgICAgICAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKGFjY0V4cHIsIGJ1Y2tldC5kb2NzW2tdKTsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWwgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICAgICAgc3VtICs9IHZhbDsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh2YWwgIT09IG51bGwgJiYgdmFsICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgICBzdW0gKz0gTnVtYmVyKHZhbCkgfHwgMDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmVzdWx0W2ZpZWxkXSA9IHN1bTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGFjY1R5cGUgPT09ICIkYXZnIikgewogICAgICAgICAgICAgICAgbGV0IHN1bSA9IDA7CiAgICAgICAgICAgICAgICBsZXQgY291bnQgPSAwOwogICAgICAgICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBidWNrZXQuZG9jcy5sZW5ndGg7IGsrKykgewogICAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24oYWNjRXhwciwgYnVja2V0LmRvY3Nba10pOwogICAgICAgICAgICAgICAgICBpZiAodmFsICE9PSB2b2lkIDAgJiYgdmFsICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgc3VtICs9IE51bWJlcih2YWwpIHx8IDA7CiAgICAgICAgICAgICAgICAgICAgY291bnQrKzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmVzdWx0W2ZpZWxkXSA9IGNvdW50ID4gMCA/IHN1bSAvIGNvdW50IDogMDsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGFjY1R5cGUgPT09ICIkcHVzaCIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFyciA9IFtdOwogICAgICAgICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBidWNrZXQuZG9jcy5sZW5ndGg7IGsrKykgewogICAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24oYWNjRXhwciwgYnVja2V0LmRvY3Nba10pOwogICAgICAgICAgICAgICAgICBhcnIucHVzaCh2YWwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmVzdWx0W2ZpZWxkXSA9IGFycjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnVja2V0ZWQucHVzaChyZXN1bHQpOwogICAgICAgICAgfQogICAgICAgICAgcmVzdWx0cyA9IGJ1Y2tldGVkOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChzdGFnZVR5cGUgPT09ICIkb3V0IikgewogICAgICAgIGNvbnN0IHRhcmdldENvbGxlY3Rpb25OYW1lID0gc3RhZ2VTcGVjOwogICAgICAgIGlmICh0eXBlb2YgdGFyZ2V0Q29sbGVjdGlvbk5hbWUgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICB0aHJvdyBuZXcgUXVlcnlFcnJvcigiJG91dCByZXF1aXJlcyBhIHN0cmluZyBjb2xsZWN0aW9uIG5hbWUiLCB7CiAgICAgICAgICAgIGNvbGxlY3Rpb246IHRoaXMubmFtZSwKICAgICAgICAgICAgY29kZTogRXJyb3JDb2Rlcy5GQUlMRURfVE9fUEFSU0UKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5kYi5jb2xsZWN0aW9ucy5oYXModGFyZ2V0Q29sbGVjdGlvbk5hbWUpKSB7CiAgICAgICAgICBhd2FpdCB0aGlzLmRiLmRyb3BDb2xsZWN0aW9uKHRhcmdldENvbGxlY3Rpb25OYW1lKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdGFyZ2V0Q29sbGVjdGlvbiA9IHRoaXMuZGJbdGFyZ2V0Q29sbGVjdGlvbk5hbWVdOwogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgcmVzdWx0cy5sZW5ndGg7IGorKykgewogICAgICAgICAgY29uc3QgZG9jID0gcmVzdWx0c1tqXTsKICAgICAgICAgIGNvbnN0IGRvY0lkID0gZG9jLl9pZDsKICAgICAgICAgIHR5cGVvZiBkb2NJZCA9PT0gIm9iamVjdCIgJiYgZG9jSWQudG9TdHJpbmcgPyBkb2NJZC50b1N0cmluZygpIDogU3RyaW5nKGRvY0lkKTsKICAgICAgICAgIGF3YWl0IHRhcmdldENvbGxlY3Rpb24uaW5zZXJ0T25lKGRvYyk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdHMgPSBbXTsKICAgICAgfSBlbHNlIGlmIChzdGFnZVR5cGUgPT09ICIkbWVyZ2UiKSB7CiAgICAgICAgbGV0IHRhcmdldENvbGxlY3Rpb25OYW1lOwogICAgICAgIGxldCBvbiA9ICJfaWQiOwogICAgICAgIGxldCB3aGVuTWF0Y2hlZCA9ICJtZXJnZSI7CiAgICAgICAgbGV0IHdoZW5Ob3RNYXRjaGVkID0gImluc2VydCI7CiAgICAgICAgaWYgKHR5cGVvZiBzdGFnZVNwZWMgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICB0YXJnZXRDb2xsZWN0aW9uTmFtZSA9IHN0YWdlU3BlYzsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBzdGFnZVNwZWMgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICB0YXJnZXRDb2xsZWN0aW9uTmFtZSA9IHN0YWdlU3BlYy5pbnRvOwogICAgICAgICAgb24gPSBzdGFnZVNwZWMub24gfHwgb247CiAgICAgICAgICB3aGVuTWF0Y2hlZCA9IHN0YWdlU3BlYy53aGVuTWF0Y2hlZCB8fCB3aGVuTWF0Y2hlZDsKICAgICAgICAgIHdoZW5Ob3RNYXRjaGVkID0gc3RhZ2VTcGVjLndoZW5Ob3RNYXRjaGVkIHx8IHdoZW5Ob3RNYXRjaGVkOwogICAgICAgIH0KICAgICAgICBpZiAoIXRhcmdldENvbGxlY3Rpb25OYW1lKSB7CiAgICAgICAgICB0aHJvdyBuZXcgUXVlcnlFcnJvcigiJG1lcmdlIHJlcXVpcmVzIGEgdGFyZ2V0IGNvbGxlY3Rpb24iLCB7CiAgICAgICAgICAgIGNvbGxlY3Rpb246IHRoaXMubmFtZSwKICAgICAgICAgICAgY29kZTogRXJyb3JDb2Rlcy5GQUlMRURfVE9fUEFSU0UKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBjb25zdCB0YXJnZXRDb2xsZWN0aW9uID0gdGhpcy5kYlt0YXJnZXRDb2xsZWN0aW9uTmFtZV07CiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCByZXN1bHRzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBjb25zdCBkb2MgPSByZXN1bHRzW2pdOwogICAgICAgICAgY29uc3QgbWF0Y2hGaWVsZCA9IHR5cGVvZiBvbiA9PT0gInN0cmluZyIgPyBvbiA6IG9uWzBdOwogICAgICAgICAgY29uc3QgbWF0Y2hWYWx1ZSA9IGdldFByb3AoZG9jLCBtYXRjaEZpZWxkKTsKICAgICAgICAgIGNvbnN0IGV4aXN0aW5nQ3Vyc29yID0gdGFyZ2V0Q29sbGVjdGlvbi5maW5kKHsgW21hdGNoRmllbGRdOiBtYXRjaFZhbHVlIH0pOwogICAgICAgICAgYXdhaXQgZXhpc3RpbmdDdXJzb3IuX2Vuc3VyZUluaXRpYWxpemVkKCk7CiAgICAgICAgICBjb25zdCBleGlzdGluZyA9IGF3YWl0IGV4aXN0aW5nQ3Vyc29yLmhhc05leHQoKSA/IGF3YWl0IGV4aXN0aW5nQ3Vyc29yLm5leHQoKSA6IG51bGw7CiAgICAgICAgICBpZiAoZXhpc3RpbmcpIHsKICAgICAgICAgICAgaWYgKHdoZW5NYXRjaGVkID09PSAicmVwbGFjZSIpIHsKICAgICAgICAgICAgICBhd2FpdCB0YXJnZXRDb2xsZWN0aW9uLnJlcGxhY2VPbmUoeyBfaWQ6IGV4aXN0aW5nLl9pZCB9LCBkb2MpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHdoZW5NYXRjaGVkID09PSAibWVyZ2UiKSB7CiAgICAgICAgICAgICAgY29uc3QgbWVyZ2VkID0gT2JqZWN0LmFzc2lnbih7fSwgZXhpc3RpbmcsIGRvYyk7CiAgICAgICAgICAgICAgYXdhaXQgdGFyZ2V0Q29sbGVjdGlvbi5yZXBsYWNlT25lKHsgX2lkOiBleGlzdGluZy5faWQgfSwgbWVyZ2VkKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh3aGVuTWF0Y2hlZCA9PT0gImtlZXBFeGlzdGluZyIpIDsKICAgICAgICAgICAgZWxzZSBpZiAod2hlbk1hdGNoZWQgPT09ICJmYWlsIikgewogICAgICAgICAgICAgIHRocm93IG5ldyBRdWVyeUVycm9yKCIkbWVyZ2UgZmFpbGVkOiBkdXBsaWNhdGUga2V5IiwgewogICAgICAgICAgICAgICAgY29sbGVjdGlvbjogdGhpcy5uYW1lLAogICAgICAgICAgICAgICAgY29kZTogRXJyb3JDb2Rlcy5EVVBMSUNBVEVfS0VZCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh3aGVuTm90TWF0Y2hlZCA9PT0gImluc2VydCIpIHsKICAgICAgICAgICAgICBhd2FpdCB0YXJnZXRDb2xsZWN0aW9uLmluc2VydE9uZShkb2MpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHdoZW5Ob3RNYXRjaGVkID09PSAiZGlzY2FyZCIpIDsKICAgICAgICAgICAgZWxzZSBpZiAod2hlbk5vdE1hdGNoZWQgPT09ICJmYWlsIikgewogICAgICAgICAgICAgIHRocm93IG5ldyBRdWVyeUVycm9yKCIkbWVyZ2UgZmFpbGVkOiBkb2N1bWVudCBub3QgZm91bmQiLCB7CiAgICAgICAgICAgICAgICBjb2xsZWN0aW9uOiB0aGlzLm5hbWUsCiAgICAgICAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLkZBSUxFRF9UT19QQVJTRQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJlc3VsdHMgPSBbXTsKICAgICAgfSBlbHNlIGlmIChzdGFnZVR5cGUgPT09ICIkbG9va3VwIikgewogICAgICAgIGlmICghc3RhZ2VTcGVjLmZyb20gfHwgIXN0YWdlU3BlYy5sb2NhbEZpZWxkIHx8ICFzdGFnZVNwZWMuZm9yZWlnbkZpZWxkIHx8ICFzdGFnZVNwZWMuYXMpIHsKICAgICAgICAgIHRocm93IG5ldyBRdWVyeUVycm9yKCIkbG9va3VwIHJlcXVpcmVzIGZyb20sIGxvY2FsRmllbGQsIGZvcmVpZ25GaWVsZCwgYW5kIGFzIiwgewogICAgICAgICAgICBjb2xsZWN0aW9uOiB0aGlzLm5hbWUsCiAgICAgICAgICAgIGNvZGU6IEVycm9yQ29kZXMuRkFJTEVEX1RPX1BBUlNFCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY29sbGVjdGlvbk5hbWVzID0gdGhpcy5kYi5nZXRDb2xsZWN0aW9uTmFtZXMoKTsKICAgICAgICBpZiAoIWNvbGxlY3Rpb25OYW1lcy5pbmNsdWRlcyhzdGFnZVNwZWMuZnJvbSkpIHsKICAgICAgICAgIHRocm93IG5ldyBRdWVyeUVycm9yKCIkbG9va3VwOiBjb2xsZWN0aW9uIG5vdCBmb3VuZDogIiArIHN0YWdlU3BlYy5mcm9tLCB7CiAgICAgICAgICAgIGNvbGxlY3Rpb246IHRoaXMubmFtZSwKICAgICAgICAgICAgY29kZTogRXJyb3JDb2Rlcy5OQU1FU1BBQ0VfTk9UX0ZPVU5ECiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZnJvbUNvbGxlY3Rpb24gPSB0aGlzLmRiW3N0YWdlU3BlYy5mcm9tXTsKICAgICAgICBjb25zdCBqb2luZWQgPSBbXTsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHJlc3VsdHMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGNvbnN0IGRvYyA9IGNvcHkocmVzdWx0c1tqXSk7CiAgICAgICAgICBjb25zdCBsb2NhbFZhbHVlID0gZ2V0UHJvcChkb2MsIHN0YWdlU3BlYy5sb2NhbEZpZWxkKTsKICAgICAgICAgIGNvbnN0IG1hdGNoZXMyID0gW107CiAgICAgICAgICBjb25zdCBmb3JlaWduQ3Vyc29yID0gZnJvbUNvbGxlY3Rpb24uZmluZCh7IFtzdGFnZVNwZWMuZm9yZWlnbkZpZWxkXTogbG9jYWxWYWx1ZSB9KTsKICAgICAgICAgIGF3YWl0IGZvcmVpZ25DdXJzb3IuX2Vuc3VyZUluaXRpYWxpemVkKCk7CiAgICAgICAgICB3aGlsZSAoYXdhaXQgZm9yZWlnbkN1cnNvci5oYXNOZXh0KCkpIHsKICAgICAgICAgICAgbWF0Y2hlczIucHVzaChhd2FpdCBmb3JlaWduQ3Vyc29yLm5leHQoKSk7CiAgICAgICAgICB9CiAgICAgICAgICBkb2Nbc3RhZ2VTcGVjLmFzXSA9IG1hdGNoZXMyOwogICAgICAgICAgam9pbmVkLnB1c2goZG9jKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0cyA9IGpvaW5lZDsKICAgICAgfSBlbHNlIGlmIChzdGFnZVR5cGUgPT09ICIkZ3JhcGhMb29rdXAiKSB7CiAgICAgICAgaWYgKCFzdGFnZVNwZWMuZnJvbSB8fCAhc3RhZ2VTcGVjLnN0YXJ0V2l0aCB8fCAhc3RhZ2VTcGVjLmNvbm5lY3RGcm9tRmllbGQgfHwgIXN0YWdlU3BlYy5jb25uZWN0VG9GaWVsZCB8fCAhc3RhZ2VTcGVjLmFzKSB7CiAgICAgICAgICB0aHJvdyBuZXcgUXVlcnlFcnJvcigiJGdyYXBoTG9va3VwIHJlcXVpcmVzIGZyb20sIHN0YXJ0V2l0aCwgY29ubmVjdEZyb21GaWVsZCwgY29ubmVjdFRvRmllbGQsIGFuZCBhcyIsIHsKICAgICAgICAgICAgY29sbGVjdGlvbjogdGhpcy5uYW1lLAogICAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLkZBSUxFRF9UT19QQVJTRQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNvbGxlY3Rpb25OYW1lcyA9IHRoaXMuZGIuZ2V0Q29sbGVjdGlvbk5hbWVzKCk7CiAgICAgICAgaWYgKCFjb2xsZWN0aW9uTmFtZXMuaW5jbHVkZXMoc3RhZ2VTcGVjLmZyb20pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgUXVlcnlFcnJvcigiJGdyYXBoTG9va3VwOiBjb2xsZWN0aW9uIG5vdCBmb3VuZDogIiArIHN0YWdlU3BlYy5mcm9tLCB7CiAgICAgICAgICAgIGNvbGxlY3Rpb246IHRoaXMubmFtZSwKICAgICAgICAgICAgY29kZTogRXJyb3JDb2Rlcy5OQU1FU1BBQ0VfTk9UX0ZPVU5ECiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZnJvbUNvbGxlY3Rpb24gPSB0aGlzLmRiW3N0YWdlU3BlYy5mcm9tXTsKICAgICAgICBjb25zdCBtYXhEZXB0aCA9IHN0YWdlU3BlYy5tYXhEZXB0aCAhPT0gdm9pZCAwID8gc3RhZ2VTcGVjLm1heERlcHRoIDogTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVI7CiAgICAgICAgY29uc3QgZGVwdGhGaWVsZCA9IHN0YWdlU3BlYy5kZXB0aEZpZWxkOwogICAgICAgIGNvbnN0IHJlc3RyaWN0U2VhcmNoV2l0aE1hdGNoID0gc3RhZ2VTcGVjLnJlc3RyaWN0U2VhcmNoV2l0aE1hdGNoOwogICAgICAgIGNvbnN0IGdyYXBoZWQgPSBbXTsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHJlc3VsdHMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGNvbnN0IGRvYyA9IGNvcHkocmVzdWx0c1tqXSk7CiAgICAgICAgICBjb25zdCBzdGFydFZhbHVlID0gZXZhbHVhdGVFeHByZXNzaW9uKHN0YWdlU3BlYy5zdGFydFdpdGgsIHJlc3VsdHNbal0pOwogICAgICAgICAgY29uc3QgdmlzaXRlZCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBjb25zdCBtYXRjaGVzMiA9IFtdOwogICAgICAgICAgY29uc3QgcXVldWUgPSBbeyB2YWx1ZTogc3RhcnRWYWx1ZSwgZGVwdGg6IDAgfV07CiAgICAgICAgICB3aGlsZSAocXVldWUubGVuZ3RoID4gMCkgewogICAgICAgICAgICBjb25zdCB7IHZhbHVlLCBkZXB0aCB9ID0gcXVldWUuc2hpZnQoKTsKICAgICAgICAgICAgaWYgKGRlcHRoID4gbWF4RGVwdGgpIGNvbnRpbnVlOwogICAgICAgICAgICBjb25zdCB2YWx1ZUtleSA9IEpTT04uc3RyaW5naWZ5KHZhbHVlKTsKICAgICAgICAgICAgaWYgKHZpc2l0ZWQuaGFzKHZhbHVlS2V5KSkgY29udGludWU7CiAgICAgICAgICAgIHZpc2l0ZWQuYWRkKHZhbHVlS2V5KTsKICAgICAgICAgICAgbGV0IHF1ZXJ5ID0geyBbc3RhZ2VTcGVjLmNvbm5lY3RUb0ZpZWxkXTogdmFsdWUgfTsKICAgICAgICAgICAgaWYgKHJlc3RyaWN0U2VhcmNoV2l0aE1hdGNoKSB7CiAgICAgICAgICAgICAgcXVlcnkgPSB7ICRhbmQ6IFtxdWVyeSwgcmVzdHJpY3RTZWFyY2hXaXRoTWF0Y2hdIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3QgY3Vyc29yMiA9IGZyb21Db2xsZWN0aW9uLmZpbmQocXVlcnkpOwogICAgICAgICAgICBhd2FpdCBjdXJzb3IyLl9lbnN1cmVJbml0aWFsaXplZCgpOwogICAgICAgICAgICB3aGlsZSAoYXdhaXQgY3Vyc29yMi5oYXNOZXh0KCkpIHsKICAgICAgICAgICAgICBjb25zdCBtYXRjaCA9IGF3YWl0IGN1cnNvcjIubmV4dCgpOwogICAgICAgICAgICAgIGNvbnN0IG1hdGNoQ29weSA9IGNvcHkobWF0Y2gpOwogICAgICAgICAgICAgIGlmIChkZXB0aEZpZWxkKSB7CiAgICAgICAgICAgICAgICBtYXRjaENvcHlbZGVwdGhGaWVsZF0gPSBkZXB0aDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbWF0Y2hlczIucHVzaChtYXRjaENvcHkpOwogICAgICAgICAgICAgIGNvbnN0IG5leHRWYWx1ZSA9IGdldFByb3AobWF0Y2gsIHN0YWdlU3BlYy5jb25uZWN0RnJvbUZpZWxkKTsKICAgICAgICAgICAgICBpZiAobmV4dFZhbHVlICE9PSB2b2lkIDAgJiYgbmV4dFZhbHVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBxdWV1ZS5wdXNoKHsgdmFsdWU6IG5leHRWYWx1ZSwgZGVwdGg6IGRlcHRoICsgMSB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGRvY1tzdGFnZVNwZWMuYXNdID0gbWF0Y2hlczI7CiAgICAgICAgICBncmFwaGVkLnB1c2goZG9jKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0cyA9IGdyYXBoZWQ7CiAgICAgIH0gZWxzZSBpZiAoc3RhZ2VUeXBlID09PSAiJGZhY2V0IikgewogICAgICAgIGlmICh0eXBlb2Ygc3RhZ2VTcGVjICE9PSAib2JqZWN0IiB8fCBBcnJheS5pc0FycmF5KHN0YWdlU3BlYykpIHsKICAgICAgICAgIHRocm93IG5ldyBRdWVyeUVycm9yKCIkZmFjZXQgcmVxdWlyZXMgYW4gb2JqZWN0IHdpdGggcGlwZWxpbmUgZGVmaW5pdGlvbnMiLCB7CiAgICAgICAgICAgIGNvbGxlY3Rpb246IHRoaXMubmFtZSwKICAgICAgICAgICAgY29kZTogRXJyb3JDb2Rlcy5GQUlMRURfVE9fUEFSU0UKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBjb25zdCBmYWNldFJlc3VsdCA9IHt9OwogICAgICAgIGZvciAoY29uc3QgZmFjZXROYW1lIGluIHN0YWdlU3BlYykgewogICAgICAgICAgY29uc3QgZmFjZXRQaXBlbGluZSA9IHN0YWdlU3BlY1tmYWNldE5hbWVdOwogICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGZhY2V0UGlwZWxpbmUpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBRdWVyeUVycm9yKCIkZmFjZXQgcGlwZWxpbmUgbXVzdCBiZSBhbiBhcnJheSIsIHsKICAgICAgICAgICAgICBjb2xsZWN0aW9uOiB0aGlzLm5hbWUsCiAgICAgICAgICAgICAgY29kZTogRXJyb3JDb2Rlcy5GQUlMRURfVE9fUEFSU0UKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBsZXQgZmFjZXRSZXN1bHRzID0gcmVzdWx0cy5tYXAoKHIpID0+IGNvcHkocikpOwogICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBmYWNldFBpcGVsaW5lLmxlbmd0aDsgaysrKSB7CiAgICAgICAgICAgIGNvbnN0IGZhY2V0U3RhZ2UgPSBmYWNldFBpcGVsaW5lW2tdOwogICAgICAgICAgICBjb25zdCBmYWNldFN0YWdlS2V5cyA9IE9iamVjdC5rZXlzKGZhY2V0U3RhZ2UpOwogICAgICAgICAgICBpZiAoZmFjZXRTdGFnZUtleXMubGVuZ3RoICE9PSAxKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFF1ZXJ5RXJyb3IoIkVhY2ggcGlwZWxpbmUgc3RhZ2UgbXVzdCBoYXZlIGV4YWN0bHkgb25lIGtleSIsIHsKICAgICAgICAgICAgICAgIGNvbGxlY3Rpb246IHRoaXMubmFtZSwKICAgICAgICAgICAgICAgIGNvZGU6IEVycm9yQ29kZXMuRkFJTEVEX1RPX1BBUlNFCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3QgZmFjZXRTdGFnZVR5cGUgPSBmYWNldFN0YWdlS2V5c1swXTsKICAgICAgICAgICAgY29uc3QgZmFjZXRTdGFnZVNwZWMgPSBmYWNldFN0YWdlW2ZhY2V0U3RhZ2VUeXBlXTsKICAgICAgICAgICAgaWYgKGZhY2V0U3RhZ2VUeXBlID09PSAiJG1hdGNoIikgewogICAgICAgICAgICAgIGNvbnN0IG1hdGNoZWQgPSBbXTsKICAgICAgICAgICAgICBmb3IgKGxldCBtID0gMDsgbSA8IGZhY2V0UmVzdWx0cy5sZW5ndGg7IG0rKykgewogICAgICAgICAgICAgICAgaWYgKG1hdGNoZXMoZmFjZXRSZXN1bHRzW21dLCBmYWNldFN0YWdlU3BlYykpIHsKICAgICAgICAgICAgICAgICAgbWF0Y2hlZC5wdXNoKGZhY2V0UmVzdWx0c1ttXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZhY2V0UmVzdWx0cyA9IG1hdGNoZWQ7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmFjZXRTdGFnZVR5cGUgPT09ICIkcHJvamVjdCIpIHsKICAgICAgICAgICAgICBjb25zdCBwcm9qZWN0ZWQgPSBbXTsKICAgICAgICAgICAgICBmb3IgKGxldCBtID0gMDsgbSA8IGZhY2V0UmVzdWx0cy5sZW5ndGg7IG0rKykgewogICAgICAgICAgICAgICAgcHJvamVjdGVkLnB1c2goYXBwbHlQcm9qZWN0aW9uV2l0aEV4cHJlc3Npb25zKGZhY2V0U3RhZ2VTcGVjLCBmYWNldFJlc3VsdHNbbV0pKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZmFjZXRSZXN1bHRzID0gcHJvamVjdGVkOwogICAgICAgICAgICB9IGVsc2UgaWYgKGZhY2V0U3RhZ2VUeXBlID09PSAiJGxpbWl0IikgewogICAgICAgICAgICAgIGZhY2V0UmVzdWx0cyA9IGZhY2V0UmVzdWx0cy5zbGljZSgwLCBmYWNldFN0YWdlU3BlYyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmFjZXRTdGFnZVR5cGUgPT09ICIkc2tpcCIpIHsKICAgICAgICAgICAgICBmYWNldFJlc3VsdHMgPSBmYWNldFJlc3VsdHMuc2xpY2UoZmFjZXRTdGFnZVNwZWMpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGZhY2V0U3RhZ2VUeXBlID09PSAiJHNvcnQiKSB7CiAgICAgICAgICAgICAgY29uc3Qgc29ydEtleXMgPSBPYmplY3Qua2V5cyhmYWNldFN0YWdlU3BlYyk7CiAgICAgICAgICAgICAgZmFjZXRSZXN1bHRzLnNvcnQoZnVuY3Rpb24oYSwgYikgewogICAgICAgICAgICAgICAgZm9yIChsZXQgbiA9IDA7IG4gPCBzb3J0S2V5cy5sZW5ndGg7IG4rKykgewogICAgICAgICAgICAgICAgICBjb25zdCBrZXkgPSBzb3J0S2V5c1tuXTsKICAgICAgICAgICAgICAgICAgaWYgKGFba2V5XSA9PT0gdm9pZCAwICYmIGJba2V5XSAhPT0gdm9pZCAwKSByZXR1cm4gLTEgKiBmYWNldFN0YWdlU3BlY1trZXldOwogICAgICAgICAgICAgICAgICBpZiAoYVtrZXldICE9PSB2b2lkIDAgJiYgYltrZXldID09PSB2b2lkIDApIHJldHVybiAxICogZmFjZXRTdGFnZVNwZWNba2V5XTsKICAgICAgICAgICAgICAgICAgaWYgKGFba2V5XSA8IGJba2V5XSkgcmV0dXJuIC0xICogZmFjZXRTdGFnZVNwZWNba2V5XTsKICAgICAgICAgICAgICAgICAgaWYgKGFba2V5XSA+IGJba2V5XSkgcmV0dXJuIDEgKiBmYWNldFN0YWdlU3BlY1trZXldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmFjZXRTdGFnZVR5cGUgPT09ICIkY291bnQiKSB7CiAgICAgICAgICAgICAgZmFjZXRSZXN1bHRzID0gW3sgW2ZhY2V0U3RhZ2VTcGVjXTogZmFjZXRSZXN1bHRzLmxlbmd0aCB9XTsKICAgICAgICAgICAgfSBlbHNlIGlmIChmYWNldFN0YWdlVHlwZSA9PT0gIiRncm91cCIpIHsKICAgICAgICAgICAgICBjb25zdCBncm91cHMgPSB7fTsKICAgICAgICAgICAgICBjb25zdCBncm91cElkID0gZmFjZXRTdGFnZVNwZWMuX2lkOwogICAgICAgICAgICAgIGZvciAobGV0IG0gPSAwOyBtIDwgZmFjZXRSZXN1bHRzLmxlbmd0aDsgbSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkb2MgPSBmYWNldFJlc3VsdHNbbV07CiAgICAgICAgICAgICAgICBsZXQga2V5OwogICAgICAgICAgICAgICAgaWYgKGdyb3VwSWQgPT09IG51bGwgfHwgZ3JvdXBJZCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgIGtleSA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBrZXkgPSBldmFsdWF0ZUV4cHJlc3Npb24oZ3JvdXBJZCwgZG9jKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnN0IGtleVN0ciA9IEpTT04uc3RyaW5naWZ5KGtleSk7CiAgICAgICAgICAgICAgICBpZiAoIWdyb3Vwc1trZXlTdHJdKSB7CiAgICAgICAgICAgICAgICAgIGdyb3Vwc1trZXlTdHJdID0gewogICAgICAgICAgICAgICAgICAgIF9pZDoga2V5LAogICAgICAgICAgICAgICAgICAgIGRvY3M6IFtdLAogICAgICAgICAgICAgICAgICAgIGFjY3VtdWxhdG9yczoge30KICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGdyb3Vwc1trZXlTdHJdLmRvY3MucHVzaChkb2MpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb25zdCBncm91cGVkID0gW107CiAgICAgICAgICAgICAgZm9yIChjb25zdCBncm91cEtleSBpbiBncm91cHMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGdyb3VwID0gZ3JvdXBzW2dyb3VwS2V5XTsKICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHsgX2lkOiBncm91cC5faWQgfTsKICAgICAgICAgICAgICAgIGZvciAoY29uc3QgZmllbGQgaW4gZmFjZXRTdGFnZVNwZWMpIHsKICAgICAgICAgICAgICAgICAgaWYgKGZpZWxkID09PSAiX2lkIikgY29udGludWU7CiAgICAgICAgICAgICAgICAgIGNvbnN0IGFjY3VtdWxhdG9yID0gZmFjZXRTdGFnZVNwZWNbZmllbGRdOwogICAgICAgICAgICAgICAgICBjb25zdCBhY2NLZXlzID0gT2JqZWN0LmtleXMoYWNjdW11bGF0b3IpOwogICAgICAgICAgICAgICAgICBpZiAoYWNjS2V5cy5sZW5ndGggIT09IDEpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICBjb25zdCBhY2NUeXBlID0gYWNjS2V5c1swXTsKICAgICAgICAgICAgICAgICAgY29uc3QgYWNjRXhwciA9IGFjY3VtdWxhdG9yW2FjY1R5cGVdOwogICAgICAgICAgICAgICAgICBpZiAoYWNjVHlwZSA9PT0gIiRzdW0iKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHN1bSA9IDA7CiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgbiA9IDA7IG4gPCBncm91cC5kb2NzLmxlbmd0aDsgbisrKSB7CiAgICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24oYWNjRXhwciwgZ3JvdXAuZG9jc1tuXSk7CiAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3VtICs9IHZhbDsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsICE9PSBudWxsICYmIHZhbCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN1bSArPSBOdW1iZXIodmFsKSB8fCAwOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXN1bHRbZmllbGRdID0gc3VtOwogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGFjY1R5cGUgPT09ICIkYXZnIikgewogICAgICAgICAgICAgICAgICAgIGxldCBzdW0gPSAwOwogICAgICAgICAgICAgICAgICAgIGxldCBjb3VudCA9IDA7CiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgbiA9IDA7IG4gPCBncm91cC5kb2NzLmxlbmd0aDsgbisrKSB7CiAgICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24oYWNjRXhwciwgZ3JvdXAuZG9jc1tuXSk7CiAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsICE9PSB2b2lkIDAgJiYgdmFsICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN1bSArPSBOdW1iZXIodmFsKSB8fCAwOwogICAgICAgICAgICAgICAgICAgICAgICBjb3VudCsrOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXN1bHRbZmllbGRdID0gY291bnQgPiAwID8gc3VtIC8gY291bnQgOiAwOwogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGFjY1R5cGUgPT09ICIkbWF4IikgewogICAgICAgICAgICAgICAgICAgIGxldCBtYXggPSB2b2lkIDA7CiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgbiA9IDA7IG4gPCBncm91cC5kb2NzLmxlbmd0aDsgbisrKSB7CiAgICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24oYWNjRXhwciwgZ3JvdXAuZG9jc1tuXSk7CiAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsICE9PSB2b2lkIDAgJiYgKG1heCA9PT0gdm9pZCAwIHx8IHZhbCA+IG1heCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWF4ID0gdmFsOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXN1bHRbZmllbGRdID0gbWF4OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBncm91cGVkLnB1c2gocmVzdWx0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZmFjZXRSZXN1bHRzID0gZ3JvdXBlZDsKICAgICAgICAgICAgfSBlbHNlIGlmIChmYWNldFN0YWdlVHlwZSA9PT0gIiRzb3J0QnlDb3VudCIpIHsKICAgICAgICAgICAgICBjb25zdCBncm91cHMgPSB7fTsKICAgICAgICAgICAgICBmb3IgKGxldCBtID0gMDsgbSA8IGZhY2V0UmVzdWx0cy5sZW5ndGg7IG0rKykgewogICAgICAgICAgICAgICAgY29uc3QgZG9jID0gZmFjZXRSZXN1bHRzW21dOwogICAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBldmFsdWF0ZUV4cHJlc3Npb24oZmFjZXRTdGFnZVNwZWMsIGRvYyk7CiAgICAgICAgICAgICAgICBjb25zdCBrZXkgPSBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7CiAgICAgICAgICAgICAgICBpZiAoIWdyb3Vwc1trZXldKSB7CiAgICAgICAgICAgICAgICAgIGdyb3Vwc1trZXldID0gewogICAgICAgICAgICAgICAgICAgIF9pZDogdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgY291bnQ6IDAKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGdyb3Vwc1trZXldLmNvdW50Kys7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZhY2V0UmVzdWx0cyA9IE9iamVjdC52YWx1ZXMoZ3JvdXBzKS5zb3J0KChhLCBiKSA9PiBiLmNvdW50IC0gYS5jb3VudCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmFjZXRTdGFnZVR5cGUgPT09ICIkc2FtcGxlIikgewogICAgICAgICAgICAgIGNvbnN0IHNpemUgPSBmYWNldFN0YWdlU3BlYy5zaXplIHx8IDE7CiAgICAgICAgICAgICAgY29uc3Qgc2h1ZmZsZWQgPSBbLi4uZmFjZXRSZXN1bHRzXTsKICAgICAgICAgICAgICBmb3IgKGxldCBtID0gc2h1ZmZsZWQubGVuZ3RoIC0gMTsgbSA+IDA7IG0tLSkgewogICAgICAgICAgICAgICAgY29uc3QgazIgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAobSArIDEpKTsKICAgICAgICAgICAgICAgIFtzaHVmZmxlZFttXSwgc2h1ZmZsZWRbazJdXSA9IFtzaHVmZmxlZFtrMl0sIHNodWZmbGVkW21dXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZmFjZXRSZXN1bHRzID0gc2h1ZmZsZWQuc2xpY2UoMCwgTWF0aC5taW4oc2l6ZSwgc2h1ZmZsZWQubGVuZ3RoKSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmFjZXRTdGFnZVR5cGUgPT09ICIkYnVja2V0IikgewogICAgICAgICAgICAgIGNvbnN0IGJvdW5kYXJpZXMgPSBmYWNldFN0YWdlU3BlYy5ib3VuZGFyaWVzOwogICAgICAgICAgICAgIGNvbnN0IGRlZmF1bHRCdWNrZXQgPSBmYWNldFN0YWdlU3BlYy5kZWZhdWx0OwogICAgICAgICAgICAgIGNvbnN0IG91dHB1dCA9IGZhY2V0U3RhZ2VTcGVjLm91dHB1dCB8fCB7IGNvdW50OiB7ICRzdW06IDEgfSB9OwogICAgICAgICAgICAgIGNvbnN0IGJ1Y2tldHMgPSB7fTsKICAgICAgICAgICAgICBmb3IgKGxldCBtID0gMDsgbSA8IGJvdW5kYXJpZXMubGVuZ3RoIC0gMTsgbSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBrZXkgPSBKU09OLnN0cmluZ2lmeShib3VuZGFyaWVzW21dKTsKICAgICAgICAgICAgICAgIGJ1Y2tldHNba2V5XSA9IHsKICAgICAgICAgICAgICAgICAgX2lkOiBib3VuZGFyaWVzW21dLAogICAgICAgICAgICAgICAgICBkb2NzOiBbXQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGRlZmF1bHRCdWNrZXQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgYnVja2V0c1siZGVmYXVsdCJdID0gewogICAgICAgICAgICAgICAgICBfaWQ6IGRlZmF1bHRCdWNrZXQsCiAgICAgICAgICAgICAgICAgIGRvY3M6IFtdCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmb3IgKGxldCBtID0gMDsgbSA8IGZhY2V0UmVzdWx0cy5sZW5ndGg7IG0rKykgewogICAgICAgICAgICAgICAgY29uc3QgZG9jID0gZmFjZXRSZXN1bHRzW21dOwogICAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBldmFsdWF0ZUV4cHJlc3Npb24oZmFjZXRTdGFnZVNwZWMuZ3JvdXBCeSwgZG9jKTsKICAgICAgICAgICAgICAgIGxldCBwbGFjZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGZvciAobGV0IG4gPSAwOyBuIDwgYm91bmRhcmllcy5sZW5ndGggLSAxOyBuKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlID49IGJvdW5kYXJpZXNbbl0gJiYgdmFsdWUgPCBib3VuZGFyaWVzW24gKyAxXSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGtleSA9IEpTT04uc3RyaW5naWZ5KGJvdW5kYXJpZXNbbl0pOwogICAgICAgICAgICAgICAgICAgIGJ1Y2tldHNba2V5XS5kb2NzLnB1c2goZG9jKTsKICAgICAgICAgICAgICAgICAgICBwbGFjZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIXBsYWNlZCAmJiBkZWZhdWx0QnVja2V0ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgYnVja2V0c1siZGVmYXVsdCJdLmRvY3MucHVzaChkb2MpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb25zdCBidWNrZXRlZCA9IFtdOwogICAgICAgICAgICAgIGZvciAoY29uc3QgYnVja2V0S2V5IGluIGJ1Y2tldHMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGJ1Y2tldCA9IGJ1Y2tldHNbYnVja2V0S2V5XTsKICAgICAgICAgICAgICAgIGlmIChidWNrZXQuZG9jcy5sZW5ndGggPT09IDApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0geyBfaWQ6IGJ1Y2tldC5faWQgfTsKICAgICAgICAgICAgICAgIGZvciAoY29uc3QgZmllbGQgaW4gb3V0cHV0KSB7CiAgICAgICAgICAgICAgICAgIGNvbnN0IGFjY3VtdWxhdG9yID0gb3V0cHV0W2ZpZWxkXTsKICAgICAgICAgICAgICAgICAgY29uc3QgYWNjS2V5cyA9IE9iamVjdC5rZXlzKGFjY3VtdWxhdG9yKTsKICAgICAgICAgICAgICAgICAgaWYgKGFjY0tleXMubGVuZ3RoICE9PSAxKSBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgY29uc3QgYWNjVHlwZSA9IGFjY0tleXNbMF07CiAgICAgICAgICAgICAgICAgIGNvbnN0IGFjY0V4cHIgPSBhY2N1bXVsYXRvclthY2NUeXBlXTsKICAgICAgICAgICAgICAgICAgaWYgKGFjY1R5cGUgPT09ICIkc3VtIikgewogICAgICAgICAgICAgICAgICAgIGxldCBzdW0gPSAwOwogICAgICAgICAgICAgICAgICAgIGZvciAobGV0IG4gPSAwOyBuIDwgYnVja2V0LmRvY3MubGVuZ3RoOyBuKyspIHsKICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihhY2NFeHByLCBidWNrZXQuZG9jc1tuXSk7CiAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3VtICs9IHZhbDsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsICE9PSBudWxsICYmIHZhbCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN1bSArPSBOdW1iZXIodmFsKSB8fCAwOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXN1bHRbZmllbGRdID0gc3VtOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBidWNrZXRlZC5wdXNoKHJlc3VsdCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZhY2V0UmVzdWx0cyA9IGJ1Y2tldGVkLnNvcnQoKGEsIGIpID0+IHsKICAgICAgICAgICAgICAgIGlmIChhLl9pZCA8IGIuX2lkKSByZXR1cm4gLTE7CiAgICAgICAgICAgICAgICBpZiAoYS5faWQgPiBiLl9pZCkgcmV0dXJuIDE7CiAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZmFjZXRSZXN1bHRbZmFjZXROYW1lXSA9IGZhY2V0UmVzdWx0czsKICAgICAgICB9CiAgICAgICAgcmVzdWx0cyA9IFtmYWNldFJlc3VsdF07CiAgICAgIH0gZWxzZSBpZiAoc3RhZ2VUeXBlID09PSAiJHJlZGFjdCIpIHsKICAgICAgICBjb25zdCByZWRhY3RlZCA9IFtdOwogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgcmVzdWx0cy5sZW5ndGg7IGorKykgewogICAgICAgICAgY29uc3QgZG9jID0gcmVzdWx0c1tqXTsKICAgICAgICAgIGNvbnN0IGRlY2lzaW9uID0gZXZhbHVhdGVFeHByZXNzaW9uKHN0YWdlU3BlYywgZG9jKTsKICAgICAgICAgIGlmIChkZWNpc2lvbiA9PT0gIiQkREVTQ0VORCIpIHsKICAgICAgICAgICAgcmVkYWN0ZWQucHVzaChkb2MpOwogICAgICAgICAgfSBlbHNlIGlmIChkZWNpc2lvbiA9PT0gIiQkUFJVTkUiKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfSBlbHNlIGlmIChkZWNpc2lvbiA9PT0gIiQkS0VFUCIpIHsKICAgICAgICAgICAgcmVkYWN0ZWQucHVzaChkb2MpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGRlY2lzaW9uKSB7CiAgICAgICAgICAgICAgcmVkYWN0ZWQucHVzaChkb2MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJlc3VsdHMgPSByZWRhY3RlZDsKICAgICAgfSBlbHNlIGlmIChzdGFnZVR5cGUgPT09ICIkZ2VvTmVhciIpIHsKICAgICAgICBpZiAoIXN0YWdlU3BlYy5uZWFyIHx8ICFzdGFnZVNwZWMuZGlzdGFuY2VGaWVsZCkgewogICAgICAgICAgdGhyb3cgbmV3IFF1ZXJ5RXJyb3IoIiRnZW9OZWFyIHJlcXVpcmVzIG5lYXIgYW5kIGRpc3RhbmNlRmllbGQiLCB7CiAgICAgICAgICAgIGNvbGxlY3Rpb246IHRoaXMubmFtZSwKICAgICAgICAgICAgY29kZTogRXJyb3JDb2Rlcy5GQUlMRURfVE9fUEFSU0UKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBjb25zdCBuZWFyID0gc3RhZ2VTcGVjLm5lYXI7CiAgICAgICAgY29uc3QgZGlzdGFuY2VGaWVsZCA9IHN0YWdlU3BlYy5kaXN0YW5jZUZpZWxkOwogICAgICAgIGNvbnN0IG1heERpc3RhbmNlID0gc3RhZ2VTcGVjLm1heERpc3RhbmNlOwogICAgICAgIGNvbnN0IG1pbkRpc3RhbmNlID0gc3RhZ2VTcGVjLm1pbkRpc3RhbmNlIHx8IDA7CiAgICAgICAgY29uc3Qgc3BoZXJpY2FsID0gc3RhZ2VTcGVjLnNwaGVyaWNhbCAhPT0gZmFsc2U7CiAgICAgICAgY29uc3Qga2V5ID0gc3RhZ2VTcGVjLmtleSB8fCAibG9jYXRpb24iOwogICAgICAgIGNvbnN0IHdpdGhEaXN0YW5jZXMgPSBbXTsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHJlc3VsdHMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGNvbnN0IGRvYyA9IGNvcHkocmVzdWx0c1tqXSk7CiAgICAgICAgICBjb25zdCBsb2NhdGlvbiA9IGdldFByb3AoZG9jLCBrZXkpOwogICAgICAgICAgaWYgKCFsb2NhdGlvbiB8fCAhQXJyYXkuaXNBcnJheShsb2NhdGlvbikgfHwgbG9jYXRpb24ubGVuZ3RoIDwgMikgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGxldCBkaXN0YW5jZTsKICAgICAgICAgIGlmIChzcGhlcmljYWwpIHsKICAgICAgICAgICAgY29uc3QgUiA9IDYzNzFlMzsKICAgICAgICAgICAgY29uc3QgbGF0MSA9IG5lYXJbMV0gKiBNYXRoLlBJIC8gMTgwOwogICAgICAgICAgICBjb25zdCBsYXQyID0gbG9jYXRpb25bMV0gKiBNYXRoLlBJIC8gMTgwOwogICAgICAgICAgICBjb25zdCBkZWx0YUxhdCA9IChsb2NhdGlvblsxXSAtIG5lYXJbMV0pICogTWF0aC5QSSAvIDE4MDsKICAgICAgICAgICAgY29uc3QgZGVsdGFMb24gPSAobG9jYXRpb25bMF0gLSBuZWFyWzBdKSAqIE1hdGguUEkgLyAxODA7CiAgICAgICAgICAgIGNvbnN0IGEgPSBNYXRoLnNpbihkZWx0YUxhdCAvIDIpICogTWF0aC5zaW4oZGVsdGFMYXQgLyAyKSArIE1hdGguY29zKGxhdDEpICogTWF0aC5jb3MobGF0MikgKiBNYXRoLnNpbihkZWx0YUxvbiAvIDIpICogTWF0aC5zaW4oZGVsdGFMb24gLyAyKTsKICAgICAgICAgICAgY29uc3QgYyA9IDIgKiBNYXRoLmF0YW4yKE1hdGguc3FydChhKSwgTWF0aC5zcXJ0KDEgLSBhKSk7CiAgICAgICAgICAgIGRpc3RhbmNlID0gUiAqIGM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCBkeCA9IGxvY2F0aW9uWzBdIC0gbmVhclswXTsKICAgICAgICAgICAgY29uc3QgZHkgPSBsb2NhdGlvblsxXSAtIG5lYXJbMV07CiAgICAgICAgICAgIGRpc3RhbmNlID0gTWF0aC5zcXJ0KGR4ICogZHggKyBkeSAqIGR5KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChkaXN0YW5jZSA+PSBtaW5EaXN0YW5jZSAmJiAoIW1heERpc3RhbmNlIHx8IGRpc3RhbmNlIDw9IG1heERpc3RhbmNlKSkgewogICAgICAgICAgICBkb2NbZGlzdGFuY2VGaWVsZF0gPSBkaXN0YW5jZTsKICAgICAgICAgICAgd2l0aERpc3RhbmNlcy5wdXNoKGRvYyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHdpdGhEaXN0YW5jZXMuc29ydCgoYSwgYikgPT4gYVtkaXN0YW5jZUZpZWxkXSAtIGJbZGlzdGFuY2VGaWVsZF0pOwogICAgICAgIGlmIChzdGFnZVNwZWMubGltaXQpIHsKICAgICAgICAgIHJlc3VsdHMgPSB3aXRoRGlzdGFuY2VzLnNsaWNlKDAsIHN0YWdlU3BlYy5saW1pdCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdHMgPSB3aXRoRGlzdGFuY2VzOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgUXVlcnlFcnJvcigiVW5zdXBwb3J0ZWQgYWdncmVnYXRpb24gc3RhZ2U6ICIgKyBzdGFnZVR5cGUsIHsKICAgICAgICAgIGNvbGxlY3Rpb246IHRoaXMubmFtZSwKICAgICAgICAgIGNvZGU6IEVycm9yQ29kZXMuRkFJTEVEX1RPX1BBUlNFCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH0KICBhc3luYyBidWxrV3JpdGUoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigiYnVsa1dyaXRlIiwgeyBjb2xsZWN0aW9uOiB0aGlzLm5hbWUgfSk7CiAgfQogIGFzeW5jIGNvdW50KCkgewogICAgaWYgKCF0aGlzLl9pbml0aWFsaXplZCkgYXdhaXQgdGhpcy5faW5pdGlhbGl6ZSgpOwogICAgbGV0IGNvdW50ID0gMDsKICAgIGZvciBhd2FpdCAoY29uc3QgXyBvZiB0aGlzLmRvY3VtZW50cykgewogICAgICBjb3VudCsrOwogICAgfQogICAgcmV0dXJuIGNvdW50OwogIH0KICBhc3luYyBjb3B5VG8oZGVzdENvbGxlY3Rpb25OYW1lKSB7CiAgICBjb25zdCBkZXN0Q29sID0gdGhpcy5kYi5nZXRDb2xsZWN0aW9uKGRlc3RDb2xsZWN0aW9uTmFtZSk7CiAgICBsZXQgbnVtQ29waWVkID0gMDsKICAgIGNvbnN0IGMgPSB0aGlzLmZpbmQoe30pOwogICAgYXdhaXQgYy5fZW5zdXJlSW5pdGlhbGl6ZWQoKTsKICAgIHdoaWxlIChhd2FpdCBjLmhhc05leHQoKSkgewogICAgICBhd2FpdCBkZXN0Q29sLmluc2VydE9uZShhd2FpdCBjLm5leHQoKSk7CiAgICAgIG51bUNvcGllZCsrOwogICAgfQogICAgcmV0dXJuIG51bUNvcGllZDsKICB9CiAgYXN5bmMgY3JlYXRlSW5kZXgoa2V5cywgb3B0aW9ucykgewogICAgaWYgKCF0aGlzLl9pbml0aWFsaXplZCkgYXdhaXQgdGhpcy5faW5pdGlhbGl6ZSgpOwogICAgaWYgKCFrZXlzIHx8IHR5cGVvZiBrZXlzICE9PSAib2JqZWN0IiB8fCBBcnJheS5pc0FycmF5KGtleXMpKSB7CiAgICAgIHRocm93IG5ldyBCYWRWYWx1ZUVycm9yKCJrZXlzIiwga2V5cywgImNyZWF0ZUluZGV4IHJlcXVpcmVzIGEga2V5IHNwZWNpZmljYXRpb24gb2JqZWN0IiwgewogICAgICAgIGNvbGxlY3Rpb246IHRoaXMubmFtZQogICAgICB9KTsKICAgIH0KICAgIGNvbnN0IGluZGV4TmFtZSA9IG9wdGlvbnMgJiYgb3B0aW9ucy5uYW1lID8gb3B0aW9ucy5uYW1lIDogdGhpcy5nZW5lcmF0ZUluZGV4TmFtZShrZXlzKTsKICAgIGlmICh0aGlzLmluZGV4ZXMuaGFzKGluZGV4TmFtZSkpIHsKICAgICAgY29uc3QgZXhpc3RpbmdJbmRleCA9IHRoaXMuaW5kZXhlcy5nZXQoaW5kZXhOYW1lKTsKICAgICAgY29uc3QgZXhpc3RpbmdLZXlzID0gSlNPTi5zdHJpbmdpZnkoZXhpc3RpbmdJbmRleC5rZXlzKTsKICAgICAgY29uc3QgbmV3S2V5cyA9IEpTT04uc3RyaW5naWZ5KGtleXMpOwogICAgICBpZiAoZXhpc3RpbmdLZXlzICE9PSBuZXdLZXlzKSB7CiAgICAgICAgdGhyb3cgbmV3IEluZGV4RXJyb3IoCiAgICAgICAgICAiSW5kZXggd2l0aCBuYW1lICciICsgaW5kZXhOYW1lICsgIicgYWxyZWFkeSBleGlzdHMgd2l0aCBhIGRpZmZlcmVudCBrZXkgc3BlY2lmaWNhdGlvbiIsCiAgICAgICAgICB7CiAgICAgICAgICAgIGNvZGU6IEVycm9yQ29kZXMuSU5ERVhfT1BUSU9OU19DT05GTElDVCwKICAgICAgICAgICAgaW5kZXg6IGluZGV4TmFtZSwKICAgICAgICAgICAgY29sbGVjdGlvbjogdGhpcy5uYW1lCiAgICAgICAgICB9CiAgICAgICAgKTsKICAgICAgfQogICAgICByZXR1cm4gaW5kZXhOYW1lOwogICAgfQogICAgYXdhaXQgdGhpcy5fYnVpbGRJbmRleChpbmRleE5hbWUsIGtleXMsIG9wdGlvbnMpOwogICAgcmV0dXJuIGluZGV4TmFtZTsKICB9CiAgZGF0YVNpemUoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigiZGF0YVNpemUiLCB7IGNvbGxlY3Rpb246IHRoaXMubmFtZSB9KTsKICB9CiAgYXN5bmMgZGVsZXRlT25lKHF1ZXJ5KSB7CiAgICBjb25zdCBkb2MgPSBhd2FpdCB0aGlzLmZpbmRPbmUocXVlcnkpOwogICAgaWYgKGRvYykgewogICAgICBhd2FpdCB0aGlzLnVwZGF0ZUluZGV4ZXNPbkRlbGV0ZShkb2MpOwogICAgICBhd2FpdCB0aGlzLmRvY3VtZW50cy5kZWxldGUoZG9jLl9pZC50b1N0cmluZygpKTsKICAgICAgdGhpcy5lbWl0KCJkZWxldGUiLCB7IF9pZDogZG9jLl9pZCB9KTsKICAgICAgcmV0dXJuIHsgZGVsZXRlZENvdW50OiAxIH07CiAgICB9IGVsc2UgewogICAgICByZXR1cm4geyBkZWxldGVkQ291bnQ6IDAgfTsKICAgIH0KICB9CiAgYXN5bmMgZGVsZXRlTWFueShxdWVyeSkgewogICAgY29uc3QgYyA9IHRoaXMuZmluZChxdWVyeSk7CiAgICBhd2FpdCBjLl9lbnN1cmVJbml0aWFsaXplZCgpOwogICAgY29uc3QgaWRzID0gW107CiAgICBjb25zdCBkb2NzID0gW107CiAgICB3aGlsZSAoYXdhaXQgYy5oYXNOZXh0KCkpIHsKICAgICAgY29uc3QgZG9jID0gYXdhaXQgYy5uZXh0KCk7CiAgICAgIGlkcy5wdXNoKGRvYy5faWQpOwogICAgICBkb2NzLnB1c2goZG9jKTsKICAgIH0KICAgIGNvbnN0IGRlbGV0ZWRDb3VudCA9IGlkcy5sZW5ndGg7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGlkcy5sZW5ndGg7IGkrKykgewogICAgICBhd2FpdCB0aGlzLnVwZGF0ZUluZGV4ZXNPbkRlbGV0ZShkb2NzW2ldKTsKICAgICAgdGhpcy5kb2N1bWVudHMuZGVsZXRlKGlkc1tpXS50b1N0cmluZygpKTsKICAgICAgdGhpcy5lbWl0KCJkZWxldGUiLCB7IF9pZDogaWRzW2ldIH0pOwogICAgfQogICAgcmV0dXJuIHsgZGVsZXRlZENvdW50IH07CiAgfQogIGFzeW5jIGRpc3RpbmN0KGZpZWxkLCBxdWVyeSkgewogICAgY29uc3QgdmFscyA9IHt9OwogICAgY29uc3QgYyA9IHRoaXMuZmluZChxdWVyeSk7CiAgICBhd2FpdCBjLl9lbnN1cmVJbml0aWFsaXplZCgpOwogICAgd2hpbGUgKGF3YWl0IGMuaGFzTmV4dCgpKSB7CiAgICAgIGNvbnN0IGQgPSBhd2FpdCBjLm5leHQoKTsKICAgICAgaWYgKGRbZmllbGRdKSB7CiAgICAgICAgdmFsc1tkW2ZpZWxkXV0gPSB0cnVlOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gT2JqZWN0LmtleXModmFscyk7CiAgfQogIGFzeW5jIGRyb3AoKSB7CiAgICBpZiAoIXRoaXMuX2luaXRpYWxpemVkKSBhd2FpdCB0aGlzLl9pbml0aWFsaXplKCk7CiAgICBmb3IgKGNvbnN0IFtfLCBpbmRleF0gb2YgdGhpcy5pbmRleGVzKSB7CiAgICAgIGlmIChpbmRleCAmJiB0eXBlb2YgaW5kZXguY2xvc2UgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICBhd2FpdCBpbmRleC5jbG9zZSgpOwogICAgICB9CiAgICB9CiAgICBpZiAodGhpcy5kb2N1bWVudHMgJiYgdHlwZW9mIHRoaXMuZG9jdW1lbnRzLmNsb3NlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIGF3YWl0IHRoaXMuZG9jdW1lbnRzLmNsb3NlKCk7CiAgICB9CiAgICBjb25zdCBwYXRoUGFydHMgPSB0aGlzLnBhdGguc3BsaXQoIi8iKS5maWx0ZXIoQm9vbGVhbik7CiAgICBjb25zdCBmaWxlbmFtZSA9IHBhdGhQYXJ0cy5wb3AoKTsKICAgIHRyeSB7CiAgICAgIGxldCBkaXIgPSBhd2FpdCBnbG9iYWxUaGlzLm5hdmlnYXRvci5zdG9yYWdlLmdldERpcmVjdG9yeSgpOwogICAgICBmb3IgKGNvbnN0IHBhcnQgb2YgcGF0aFBhcnRzKSB7CiAgICAgICAgZGlyID0gYXdhaXQgZGlyLmdldERpcmVjdG9yeUhhbmRsZShwYXJ0LCB7IGNyZWF0ZTogZmFsc2UgfSk7CiAgICAgIH0KICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCBkaXIucmVtb3ZlRW50cnkoZmlsZW5hbWUsIHsgcmVjdXJzaXZlOiB0cnVlIH0pOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgaWYgKGUubmFtZSA9PT0gIlR5cGVFcnJvciIgfHwgZS5tZXNzYWdlPy5pbmNsdWRlcygicmVjdXJzaXZlIikpIHsKICAgICAgICAgIGF3YWl0IGRpci5yZW1vdmVFbnRyeShmaWxlbmFtZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93IGU7CiAgICAgICAgfQogICAgICB9CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoZXJyb3IubmFtZSAhPT0gIk5vdEZvdW5kRXJyb3IiICYmIGVycm9yLmNvZGUgIT09ICJFTk9FTlQiKSB7CiAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuZG9jdW1lbnRzID0gbnVsbDsKICAgIHRoaXMuaW5kZXhlcy5jbGVhcigpOwogICAgdGhpcy5faW5pdGlhbGl6ZWQgPSBmYWxzZTsKICAgIHRoaXMuZGIuY29sbGVjdGlvbnMuZGVsZXRlKHRoaXMubmFtZSk7CiAgICB0aGlzLmVtaXQoImRyb3AiLCB7IGNvbGxlY3Rpb246IHRoaXMubmFtZSB9KTsKICAgIHJldHVybiB7IG9rOiAxIH07CiAgfQogIGFzeW5jIGRyb3BJbmRleChpbmRleE5hbWUpIHsKICAgIGlmICghdGhpcy5pbmRleGVzLmhhcyhpbmRleE5hbWUpKSB7CiAgICAgIHRocm93IG5ldyBJbmRleE5vdEZvdW5kRXJyb3IoaW5kZXhOYW1lLCB7IGNvbGxlY3Rpb246IHRoaXMubmFtZSB9KTsKICAgIH0KICAgIGNvbnN0IGluZGV4ID0gdGhpcy5pbmRleGVzLmdldChpbmRleE5hbWUpOwogICAgaWYgKGluZGV4ICYmIHR5cGVvZiBpbmRleC5jbGVhciA9PT0gImZ1bmN0aW9uIikgewogICAgICBhd2FpdCBpbmRleC5jbGVhcigpOwogICAgfQogICAgaWYgKGluZGV4ICYmIHR5cGVvZiBpbmRleC5jbG9zZSA9PT0gImZ1bmN0aW9uIikgewogICAgICBhd2FpdCBpbmRleC5jbG9zZSgpOwogICAgfQogICAgdGhpcy5pbmRleGVzLmRlbGV0ZShpbmRleE5hbWUpOwogICAgcmV0dXJuIHsgbkluZGV4ZXNXYXM6IHRoaXMuaW5kZXhlcy5zaXplICsgMSwgb2s6IDEgfTsKICB9CiAgYXN5bmMgZHJvcEluZGV4ZXMoKSB7CiAgICBjb25zdCBjb3VudCA9IHRoaXMuaW5kZXhlcy5zaXplOwogICAgZm9yIChjb25zdCBbXywgaW5kZXhdIG9mIHRoaXMuaW5kZXhlcykgewogICAgICBpZiAoaW5kZXggJiYgdHlwZW9mIGluZGV4LmNsZWFyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgYXdhaXQgaW5kZXguY2xlYXIoKTsKICAgICAgfQogICAgICBpZiAoaW5kZXggJiYgdHlwZW9mIGluZGV4LmNsb3NlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgYXdhaXQgaW5kZXguY2xvc2UoKTsKICAgICAgfQogICAgfQogICAgdGhpcy5pbmRleGVzLmNsZWFyKCk7CiAgICByZXR1cm4geyBuSW5kZXhlc1dhczogY291bnQsIG1zZzogIm5vbi1faWQgaW5kZXhlcyBkcm9wcGVkIiwgb2s6IDEgfTsKICB9CiAgZW5zdXJlSW5kZXgoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigiZW5zdXJlSW5kZXgiLCB7IGNvbGxlY3Rpb246IHRoaXMubmFtZSB9KTsKICB9CiAgZXhwbGFpbigpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJleHBsYWluIiwgeyBjb2xsZWN0aW9uOiB0aGlzLm5hbWUgfSk7CiAgfQogIGZpbmQocXVlcnksIHByb2plY3Rpb24pIHsKICAgIHRoaXMuX3ZhbGlkYXRlUHJvamVjdGlvbihwcm9qZWN0aW9uKTsKICAgIGNvbnN0IGRvY3VtZW50c1Byb21pc2UgPSB0aGlzLl9maW5kSW50ZXJuYWwocXVlcnksIHByb2plY3Rpb24pOwogICAgcmV0dXJuIG5ldyBDdXJzb3IoCiAgICAgIHRoaXMsCiAgICAgIHF1ZXJ5LAogICAgICBwcm9qZWN0aW9uLAogICAgICBkb2N1bWVudHNQcm9taXNlLAogICAgICBTb3J0ZWRDdXJzb3IKICAgICk7CiAgfQogIF92YWxpZGF0ZVByb2plY3Rpb24ocHJvamVjdGlvbikgewogICAgaWYgKCFwcm9qZWN0aW9uIHx8IE9iamVjdC5rZXlzKHByb2plY3Rpb24pLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwogICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHByb2plY3Rpb24pOwogICAgbGV0IGhhc0luY2x1c2lvbiA9IGZhbHNlOwogICAgbGV0IGhhc0V4Y2x1c2lvbiA9IGZhbHNlOwogICAgZm9yIChjb25zdCBrZXkgb2Yga2V5cykgewogICAgICBpZiAoa2V5ID09PSAiX2lkIikgY29udGludWU7CiAgICAgIGlmIChwcm9qZWN0aW9uW2tleV0pIGhhc0luY2x1c2lvbiA9IHRydWU7CiAgICAgIGVsc2UgaGFzRXhjbHVzaW9uID0gdHJ1ZTsKICAgICAgaWYgKGhhc0luY2x1c2lvbiAmJiBoYXNFeGNsdXNpb24pIGJyZWFrOwogICAgfQogICAgaWYgKGhhc0luY2x1c2lvbiAmJiBoYXNFeGNsdXNpb24pIHsKICAgICAgdGhyb3cgbmV3IFF1ZXJ5RXJyb3IoIkNhbm5vdCBkbyBleGNsdXNpb24gb24gZmllbGQgaW4gaW5jbHVzaW9uIHByb2plY3Rpb24iLCB7CiAgICAgICAgY29kZTogRXJyb3JDb2Rlcy5DQU5OT1RfRE9fRVhDTFVTSU9OX09OX0ZJRUxEX0lEX0lOX0lOQ0xVU0lPTl9QUk9KRUNUSU9OLAogICAgICAgIGNvbGxlY3Rpb246IHRoaXMubmFtZQogICAgICB9KTsKICAgIH0KICB9CiAgYXN5bmMgX2ZpbmRJbnRlcm5hbChxdWVyeSwgcHJvamVjdGlvbikgewogICAgaWYgKCF0aGlzLl9pbml0aWFsaXplZCkgYXdhaXQgdGhpcy5faW5pdGlhbGl6ZSgpOwogICAgY29uc3Qgbm9ybWFsaXplZFF1ZXJ5ID0gcXVlcnkgPT0gdm9pZCAwID8ge30gOiBxdWVyeTsKICAgIGNvbnN0IG5lYXJTcGVjID0gdGhpcy5fZXh0cmFjdE5lYXJTcGVjKG5vcm1hbGl6ZWRRdWVyeSk7CiAgICBjb25zdCBkb2N1bWVudHMgPSBbXTsKICAgIGNvbnN0IHNlZW4gPSB7fTsKICAgIGlmICh0aGlzLmluZGV4ZXMuc2l6ZSA+IDApIHsKICAgICAgY29uc3QgcXVlcnlQbGFuID0gYXdhaXQgdGhpcy5wbGFuUXVlcnlBc3luYyhub3JtYWxpemVkUXVlcnkpOwogICAgICBpZiAocXVlcnlQbGFuLnVzZUluZGV4ICYmIHF1ZXJ5UGxhbi5kb2NJZHMgJiYgcXVlcnlQbGFuLmRvY0lkcy5sZW5ndGggPiAwKSB7CiAgICAgICAgZm9yIChjb25zdCBkb2NJZCBvZiBxdWVyeVBsYW4uZG9jSWRzKSB7CiAgICAgICAgICBpZiAoIXNlZW5bZG9jSWRdKSB7CiAgICAgICAgICAgIGNvbnN0IGRvYyA9IGF3YWl0IHRoaXMuZG9jdW1lbnRzLnNlYXJjaChkb2NJZCk7CiAgICAgICAgICAgIGlmIChkb2MgJiYgbWF0Y2hlcyhkb2MsIG5vcm1hbGl6ZWRRdWVyeSkpIHsKICAgICAgICAgICAgICBzZWVuW2RvY0lkXSA9IHRydWU7CiAgICAgICAgICAgICAgZG9jdW1lbnRzLnB1c2goZG9jKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBmb3IgYXdhaXQgKGNvbnN0IGVudHJ5IG9mIHRoaXMuZG9jdW1lbnRzKSB7CiAgICAgICAgICBpZiAoZW50cnkgJiYgZW50cnkudmFsdWUgJiYgIXNlZW5bZW50cnkudmFsdWUuX2lkXSAmJiBtYXRjaGVzKGVudHJ5LnZhbHVlLCBub3JtYWxpemVkUXVlcnkpKSB7CiAgICAgICAgICAgIHNlZW5bZW50cnkudmFsdWUuX2lkXSA9IHRydWU7CiAgICAgICAgICAgIGRvY3VtZW50cy5wdXNoKGVudHJ5LnZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZvciBhd2FpdCAoY29uc3QgZW50cnkgb2YgdGhpcy5kb2N1bWVudHMpIHsKICAgICAgICBpZiAoZW50cnkgJiYgZW50cnkudmFsdWUgJiYgIXNlZW5bZW50cnkudmFsdWUuX2lkXSAmJiBtYXRjaGVzKGVudHJ5LnZhbHVlLCBub3JtYWxpemVkUXVlcnkpKSB7CiAgICAgICAgICBzZWVuW2VudHJ5LnZhbHVlLl9pZF0gPSB0cnVlOwogICAgICAgICAgZG9jdW1lbnRzLnB1c2goZW50cnkudmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKG5lYXJTcGVjKSB7CiAgICAgIHRoaXMuX3NvcnRCeU5lYXJEaXN0YW5jZShkb2N1bWVudHMsIG5lYXJTcGVjKTsKICAgIH0KICAgIHJldHVybiBkb2N1bWVudHM7CiAgfQogIF9leHRyYWN0TmVhclNwZWMocXVlcnkpIHsKICAgIGZvciAoY29uc3QgZmllbGQgb2YgT2JqZWN0LmtleXMocXVlcnkgfHwge30pKSB7CiAgICAgIGlmIChmaWVsZC5zdGFydHNXaXRoKCIkIikpIGNvbnRpbnVlOwogICAgICBjb25zdCB2YWx1ZSA9IHF1ZXJ5W2ZpZWxkXTsKICAgICAgaWYgKCF2YWx1ZSB8fCB0eXBlb2YgdmFsdWUgIT09ICJvYmplY3QiKSBjb250aW51ZTsKICAgICAgaWYgKHZhbHVlLiRuZWFyKSB7CiAgICAgICAgY29uc3QgY29vcmRzID0gdGhpcy5fcGFyc2VOZWFyQ29vcmRpbmF0ZXModmFsdWUuJG5lYXIpOwogICAgICAgIGlmIChjb29yZHMpIHJldHVybiB7IGZpZWxkLCAuLi5jb29yZHMgfTsKICAgICAgfQogICAgICBpZiAodmFsdWUuJG5lYXJTcGhlcmUpIHsKICAgICAgICBjb25zdCBjb29yZHMgPSB0aGlzLl9wYXJzZU5lYXJDb29yZGluYXRlcyh2YWx1ZS4kbmVhclNwaGVyZSk7CiAgICAgICAgaWYgKGNvb3JkcykgcmV0dXJuIHsgZmllbGQsIC4uLmNvb3JkcyB9OwogICAgICB9CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9CiAgX3BhcnNlTmVhckNvb3JkaW5hdGVzKHNwZWMpIHsKICAgIGxldCBjb29yZGluYXRlczsKICAgIGlmIChzcGVjICYmIHR5cGVvZiBzcGVjID09PSAib2JqZWN0IikgewogICAgICBpZiAoc3BlYy4kZ2VvbWV0cnkgJiYgc3BlYy4kZ2VvbWV0cnkuY29vcmRpbmF0ZXMpIHsKICAgICAgICBjb29yZGluYXRlcyA9IHNwZWMuJGdlb21ldHJ5LmNvb3JkaW5hdGVzOwogICAgICB9IGVsc2UgaWYgKHNwZWMuY29vcmRpbmF0ZXMpIHsKICAgICAgICBjb29yZGluYXRlcyA9IHNwZWMuY29vcmRpbmF0ZXM7CiAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShzcGVjKSkgewogICAgICAgIGNvb3JkaW5hdGVzID0gc3BlYzsKICAgICAgfQogICAgfQogICAgaWYgKCFjb29yZGluYXRlcyB8fCBjb29yZGluYXRlcy5sZW5ndGggPCAyKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgY29uc3QgW2xuZywgbGF0XSA9IGNvb3JkaW5hdGVzOwogICAgaWYgKHR5cGVvZiBsYXQgIT09ICJudW1iZXIiIHx8IHR5cGVvZiBsbmcgIT09ICJudW1iZXIiKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgcmV0dXJuIHsgbGF0LCBsbmcgfTsKICB9CiAgX2V4dHJhY3RQb2ludENvb3JkaW5hdGVzKHZhbHVlKSB7CiAgICBpZiAoIXZhbHVlKSByZXR1cm4gbnVsbDsKICAgIGlmICh2YWx1ZS50eXBlID09PSAiRmVhdHVyZUNvbGxlY3Rpb24iICYmIEFycmF5LmlzQXJyYXkodmFsdWUuZmVhdHVyZXMpICYmIHZhbHVlLmZlYXR1cmVzLmxlbmd0aCA+IDApIHsKICAgICAgcmV0dXJuIHRoaXMuX2V4dHJhY3RQb2ludENvb3JkaW5hdGVzKHZhbHVlLmZlYXR1cmVzWzBdLmdlb21ldHJ5KTsKICAgIH0KICAgIGlmICh2YWx1ZS50eXBlID09PSAiRmVhdHVyZSIgJiYgdmFsdWUuZ2VvbWV0cnkpIHsKICAgICAgcmV0dXJuIHRoaXMuX2V4dHJhY3RQb2ludENvb3JkaW5hdGVzKHZhbHVlLmdlb21ldHJ5KTsKICAgIH0KICAgIGlmICh2YWx1ZS50eXBlID09PSAiUG9pbnQiICYmIEFycmF5LmlzQXJyYXkodmFsdWUuY29vcmRpbmF0ZXMpICYmIHZhbHVlLmNvb3JkaW5hdGVzLmxlbmd0aCA+PSAyKSB7CiAgICAgIGNvbnN0IFtsbmcsIGxhdF0gPSB2YWx1ZS5jb29yZGluYXRlczsKICAgICAgaWYgKHR5cGVvZiBsYXQgPT09ICJudW1iZXIiICYmIHR5cGVvZiBsbmcgPT09ICJudW1iZXIiKSB7CiAgICAgICAgcmV0dXJuIHsgbGF0LCBsbmcgfTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfQogIF9zb3J0QnlOZWFyRGlzdGFuY2UoZG9jdW1lbnRzLCBuZWFyU3BlYykgewogICAgY29uc3QgeyBmaWVsZCwgbGF0OiB0YXJnZXRMYXQsIGxuZzogdGFyZ2V0TG5nIH0gPSBuZWFyU3BlYzsKICAgIGRvY3VtZW50cy5zb3J0KChhLCBiKSA9PiB7CiAgICAgIGNvbnN0IGFQb2ludCA9IHRoaXMuX2V4dHJhY3RQb2ludENvb3JkaW5hdGVzKGdldFByb3AoYSwgZmllbGQpKTsKICAgICAgY29uc3QgYlBvaW50ID0gdGhpcy5fZXh0cmFjdFBvaW50Q29vcmRpbmF0ZXMoZ2V0UHJvcChiLCBmaWVsZCkpOwogICAgICBjb25zdCBhRGlzdCA9IGFQb2ludCA/IHRoaXMuX2hhdmVyc2luZURpc3RhbmNlKGFQb2ludC5sYXQsIGFQb2ludC5sbmcsIHRhcmdldExhdCwgdGFyZ2V0TG5nKSA6IEluZmluaXR5OwogICAgICBjb25zdCBiRGlzdCA9IGJQb2ludCA/IHRoaXMuX2hhdmVyc2luZURpc3RhbmNlKGJQb2ludC5sYXQsIGJQb2ludC5sbmcsIHRhcmdldExhdCwgdGFyZ2V0TG5nKSA6IEluZmluaXR5OwogICAgICByZXR1cm4gYURpc3QgLSBiRGlzdDsKICAgIH0pOwogIH0KICBfaGF2ZXJzaW5lRGlzdGFuY2UobGF0MSwgbG5nMSwgbGF0MiwgbG5nMikgewogICAgY29uc3QgUiA9IDYzNzE7CiAgICBjb25zdCBkTGF0ID0gKGxhdDIgLSBsYXQxKSAqIE1hdGguUEkgLyAxODA7CiAgICBjb25zdCBkTG5nID0gKGxuZzIgLSBsbmcxKSAqIE1hdGguUEkgLyAxODA7CiAgICBjb25zdCBhID0gTWF0aC5zaW4oZExhdCAvIDIpICogTWF0aC5zaW4oZExhdCAvIDIpICsgTWF0aC5jb3MobGF0MSAqIE1hdGguUEkgLyAxODApICogTWF0aC5jb3MobGF0MiAqIE1hdGguUEkgLyAxODApICogTWF0aC5zaW4oZExuZyAvIDIpICogTWF0aC5zaW4oZExuZyAvIDIpOwogICAgY29uc3QgYyA9IDIgKiBNYXRoLmF0YW4yKE1hdGguc3FydChhKSwgTWF0aC5zcXJ0KDEgLSBhKSk7CiAgICByZXR1cm4gUiAqIGM7CiAgfQogIGZpbmRBbmRNb2RpZnkoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigiZmluZEFuZE1vZGlmeSIsIHsgY29sbGVjdGlvbjogdGhpcy5uYW1lIH0pOwogIH0KICBhc3luYyBmaW5kT25lKHF1ZXJ5LCBwcm9qZWN0aW9uKSB7CiAgICBjb25zdCBjdXJzb3IgPSB0aGlzLmZpbmQocXVlcnksIHByb2plY3Rpb24pOwogICAgYXdhaXQgY3Vyc29yLl9lbnN1cmVJbml0aWFsaXplZCgpOwogICAgaWYgKGF3YWl0IGN1cnNvci5oYXNOZXh0KCkpIHsKICAgICAgcmV0dXJuIGF3YWl0IGN1cnNvci5uZXh0KCk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICB9CiAgYXN5bmMgZmluZE9uZUFuZERlbGV0ZShmaWx0ZXIsIG9wdGlvbnMpIHsKICAgIGxldCBjID0gdGhpcy5maW5kKGZpbHRlcik7CiAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnNvcnQpIHsKICAgICAgYyA9IGMuc29ydChvcHRpb25zLnNvcnQpOwogICAgICBhd2FpdCBjLl9lbnN1cmVJbml0aWFsaXplZCgpOwogICAgfSBlbHNlIHsKICAgICAgYXdhaXQgYy5fZW5zdXJlSW5pdGlhbGl6ZWQoKTsKICAgIH0KICAgIGlmICghYXdhaXQgYy5oYXNOZXh0KCkpIHJldHVybiBudWxsOwogICAgY29uc3QgZG9jID0gYXdhaXQgYy5uZXh0KCk7CiAgICBhd2FpdCB0aGlzLmRvY3VtZW50cy5kZWxldGUoZG9jLl9pZC50b1N0cmluZygpKTsKICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMucHJvamVjdGlvbikgcmV0dXJuIGFwcGx5UHJvamVjdGlvbihvcHRpb25zLnByb2plY3Rpb24sIGRvYyk7CiAgICBlbHNlIHJldHVybiBkb2M7CiAgfQogIGFzeW5jIGZpbmRPbmVBbmRSZXBsYWNlKGZpbHRlciwgcmVwbGFjZW1lbnQsIG9wdGlvbnMpIHsKICAgIGxldCBjID0gdGhpcy5maW5kKGZpbHRlcik7CiAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnNvcnQpIHsKICAgICAgYyA9IGMuc29ydChvcHRpb25zLnNvcnQpOwogICAgICBhd2FpdCBjLl9lbnN1cmVJbml0aWFsaXplZCgpOwogICAgfSBlbHNlIHsKICAgICAgYXdhaXQgYy5fZW5zdXJlSW5pdGlhbGl6ZWQoKTsKICAgIH0KICAgIGlmICghYXdhaXQgYy5oYXNOZXh0KCkpIHJldHVybiBudWxsOwogICAgY29uc3QgZG9jID0gYXdhaXQgYy5uZXh0KCk7CiAgICByZXBsYWNlbWVudC5faWQgPSBkb2MuX2lkOwogICAgYXdhaXQgdGhpcy5kb2N1bWVudHMuYWRkKGRvYy5faWQudG9TdHJpbmcoKSwgcmVwbGFjZW1lbnQpOwogICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5yZXR1cm5OZXdEb2N1bWVudCkgewogICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnByb2plY3Rpb24pIHJldHVybiBhcHBseVByb2plY3Rpb24ob3B0aW9ucy5wcm9qZWN0aW9uLCByZXBsYWNlbWVudCk7CiAgICAgIGVsc2UgcmV0dXJuIHJlcGxhY2VtZW50OwogICAgfSBlbHNlIHsKICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5wcm9qZWN0aW9uKSByZXR1cm4gYXBwbHlQcm9qZWN0aW9uKG9wdGlvbnMucHJvamVjdGlvbiwgZG9jKTsKICAgICAgZWxzZSByZXR1cm4gZG9jOwogICAgfQogIH0KICBhc3luYyBmaW5kT25lQW5kVXBkYXRlKGZpbHRlciwgdXBkYXRlLCBvcHRpb25zKSB7CiAgICBsZXQgYyA9IHRoaXMuZmluZChmaWx0ZXIpOwogICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5zb3J0KSB7CiAgICAgIGMgPSBjLnNvcnQob3B0aW9ucy5zb3J0KTsKICAgICAgYXdhaXQgYy5fZW5zdXJlSW5pdGlhbGl6ZWQoKTsKICAgIH0gZWxzZSB7CiAgICAgIGF3YWl0IGMuX2Vuc3VyZUluaXRpYWxpemVkKCk7CiAgICB9CiAgICBpZiAoIWF3YWl0IGMuaGFzTmV4dCgpKSByZXR1cm4gbnVsbDsKICAgIGNvbnN0IGRvYyA9IGF3YWl0IGMubmV4dCgpOwogICAgY29uc3QgY2xvbmUgPSBPYmplY3QuYXNzaWduKHt9LCBkb2MpOwogICAgY29uc3QgbWF0Y2hJbmZvID0gbWF0Y2hXaXRoQXJyYXlJbmRpY2VzKGRvYywgZmlsdGVyKTsKICAgIGNvbnN0IHBvc2l0aW9uYWxNYXRjaEluZm8gPSBtYXRjaEluZm8uYXJyYXlGaWx0ZXJzOwogICAgY29uc3QgdXNlckFycmF5RmlsdGVycyA9IG9wdGlvbnMgJiYgb3B0aW9ucy5hcnJheUZpbHRlcnM7CiAgICBhcHBseVVwZGF0ZXModXBkYXRlLCBjbG9uZSwgZmFsc2UsIHBvc2l0aW9uYWxNYXRjaEluZm8sIHVzZXJBcnJheUZpbHRlcnMpOwogICAgYXdhaXQgdGhpcy5kb2N1bWVudHMuYWRkKGRvYy5faWQudG9TdHJpbmcoKSwgY2xvbmUpOwogICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5yZXR1cm5OZXdEb2N1bWVudCkgewogICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnByb2plY3Rpb24pIHJldHVybiBhcHBseVByb2plY3Rpb24ob3B0aW9ucy5wcm9qZWN0aW9uLCBjbG9uZSk7CiAgICAgIGVsc2UgcmV0dXJuIGNsb25lOwogICAgfSBlbHNlIHsKICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5wcm9qZWN0aW9uKSByZXR1cm4gYXBwbHlQcm9qZWN0aW9uKG9wdGlvbnMucHJvamVjdGlvbiwgZG9jKTsKICAgICAgZWxzZSByZXR1cm4gZG9jOwogICAgfQogIH0KICBnZXRJbmRleGVzKCkgewogICAgY29uc3QgcmVzdWx0ID0gW107CiAgICBmb3IgKGNvbnN0IFtpbmRleE5hbWUsIGluZGV4XSBvZiB0aGlzLmluZGV4ZXMpIHsKICAgICAgcmVzdWx0LnB1c2goaW5kZXguZ2V0U3BlYygpKTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGdldFNoYXJkRGlzdHJpYnV0aW9uKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoImdldFNoYXJkRGlzdHJpYnV0aW9uIiwgeyBjb2xsZWN0aW9uOiB0aGlzLm5hbWUgfSk7CiAgfQogIGdldFNoYXJkVmVyc2lvbigpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJnZXRTaGFyZFZlcnNpb24iLCB7IGNvbGxlY3Rpb246IHRoaXMubmFtZSB9KTsKICB9CiAgLy8gbm9uLW1vbmdvCiAgZ2V0U3RvcmUoKSB7CiAgICByZXR1cm4gdGhpcy5kb2N1bWVudHM7CiAgfQogIGdyb3VwKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoImdyb3VwIiwgeyBjb2xsZWN0aW9uOiB0aGlzLm5hbWUgfSk7CiAgfQogIGFzeW5jIGluc2VydChkb2MpIHsKICAgIGlmIChBcnJheSA9PSBkb2MuY29uc3RydWN0b3IpIHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuaW5zZXJ0TWFueShkb2MpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuaW5zZXJ0T25lKGRvYyk7CiAgICB9CiAgfQogIGFzeW5jIGluc2VydE9uZShkb2MpIHsKICAgIGlmICghdGhpcy5faW5pdGlhbGl6ZWQpIGF3YWl0IHRoaXMuX2luaXRpYWxpemUoKTsKICAgIGlmIChkb2MuX2lkID09IHZvaWQgMCkgZG9jLl9pZCA9IG5ldyBPYmplY3RJZCgpOwogICAgYXdhaXQgdGhpcy5kb2N1bWVudHMuYWRkKGRvYy5faWQudG9TdHJpbmcoKSwgZG9jKTsKICAgIGF3YWl0IHRoaXMudXBkYXRlSW5kZXhlc09uSW5zZXJ0KGRvYyk7CiAgICB0aGlzLmVtaXQoImluc2VydCIsIGRvYyk7CiAgICByZXR1cm4geyBpbnNlcnRlZElkOiBkb2MuX2lkIH07CiAgfQogIGFzeW5jIGluc2VydE1hbnkoZG9jcykgewogICAgaWYgKCF0aGlzLl9pbml0aWFsaXplZCkgYXdhaXQgdGhpcy5faW5pdGlhbGl6ZSgpOwogICAgY29uc3QgaW5zZXJ0ZWRJZHMgPSBbXTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZG9jcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmluc2VydE9uZShkb2NzW2ldKTsKICAgICAgaW5zZXJ0ZWRJZHMucHVzaChyZXN1bHQuaW5zZXJ0ZWRJZCk7CiAgICB9CiAgICByZXR1cm4geyBpbnNlcnRlZElkcyB9OwogIH0KICBpc0NhcHBlZCgpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJpc0NhcHBlZCIsIHsgY29sbGVjdGlvbjogdGhpcy5uYW1lIH0pOwogIH0KICBtYXBSZWR1Y2UoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigibWFwUmVkdWNlIiwgeyBjb2xsZWN0aW9uOiB0aGlzLm5hbWUgfSk7CiAgfQogIHJlSW5kZXgoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigicmVJbmRleCIsIHsgY29sbGVjdGlvbjogdGhpcy5uYW1lIH0pOwogIH0KICBhc3luYyByZXBsYWNlT25lKHF1ZXJ5LCByZXBsYWNlbWVudCwgb3B0aW9ucykgewogICAgY29uc3QgcmVzdWx0ID0ge307CiAgICBjb25zdCBjID0gdGhpcy5maW5kKHF1ZXJ5KTsKICAgIGF3YWl0IGMuX2Vuc3VyZUluaXRpYWxpemVkKCk7CiAgICByZXN1bHQubWF0Y2hlZENvdW50ID0gYXdhaXQgYy5jb3VudCgpOwogICAgaWYgKHJlc3VsdC5tYXRjaGVkQ291bnQgPT0gMCkgewogICAgICByZXN1bHQubW9kaWZpZWRDb3VudCA9IDA7CiAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMudXBzZXJ0KSB7CiAgICAgICAgY29uc3QgbmV3RG9jID0gcmVwbGFjZW1lbnQ7CiAgICAgICAgbmV3RG9jLl9pZCA9IG5ldyBPYmplY3RJZCgpOwogICAgICAgIGF3YWl0IHRoaXMuZG9jdW1lbnRzLmFkZChuZXdEb2MuX2lkLnRvU3RyaW5nKCksIG5ld0RvYyk7CiAgICAgICAgYXdhaXQgdGhpcy51cGRhdGVJbmRleGVzT25JbnNlcnQobmV3RG9jKTsKICAgICAgICB0aGlzLmVtaXQoImluc2VydCIsIG5ld0RvYyk7CiAgICAgICAgcmVzdWx0LnVwc2VydGVkSWQgPSBuZXdEb2MuX2lkOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICByZXN1bHQubW9kaWZpZWRDb3VudCA9IDE7CiAgICAgIGNvbnN0IGRvYyA9IGF3YWl0IGMubmV4dCgpOwogICAgICBhd2FpdCB0aGlzLnVwZGF0ZUluZGV4ZXNPbkRlbGV0ZShkb2MpOwogICAgICByZXBsYWNlbWVudC5faWQgPSBkb2MuX2lkOwogICAgICB0aGlzLmRvY3VtZW50cy5hZGQoZG9jLl9pZC50b1N0cmluZygpLCByZXBsYWNlbWVudCk7CiAgICAgIGF3YWl0IHRoaXMudXBkYXRlSW5kZXhlc09uSW5zZXJ0KHJlcGxhY2VtZW50KTsKICAgICAgdGhpcy5lbWl0KCJyZXBsYWNlIiwgcmVwbGFjZW1lbnQpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgYXN5bmMgcmVtb3ZlKHF1ZXJ5LCBvcHRpb25zKSB7CiAgICBjb25zdCBjID0gdGhpcy5maW5kKHF1ZXJ5KTsKICAgIGF3YWl0IGMuX2Vuc3VyZUluaXRpYWxpemVkKCk7CiAgICBpZiAoIWF3YWl0IGMuaGFzTmV4dCgpKSByZXR1cm47CiAgICBpZiAob3B0aW9ucyA9PT0gdHJ1ZSB8fCBvcHRpb25zICYmIG9wdGlvbnMuanVzdE9uZSkgewogICAgICBjb25zdCBkb2MgPSBhd2FpdCBjLm5leHQoKTsKICAgICAgYXdhaXQgdGhpcy51cGRhdGVJbmRleGVzT25EZWxldGUoZG9jKTsKICAgICAgdGhpcy5kb2N1bWVudHMuZGVsZXRlKGRvYy5faWQudG9TdHJpbmcoKSk7CiAgICB9IGVsc2UgewogICAgICB3aGlsZSAoYXdhaXQgYy5oYXNOZXh0KCkpIHsKICAgICAgICBjb25zdCBkb2MgPSBhd2FpdCBjLm5leHQoKTsKICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZUluZGV4ZXNPbkRlbGV0ZShkb2MpOwogICAgICAgIHRoaXMuZG9jdW1lbnRzLmRlbGV0ZShkb2MuX2lkLnRvU3RyaW5nKCkpOwogICAgICB9CiAgICB9CiAgfQogIHJlbmFtZUNvbGxlY3Rpb24oKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigicmVuYW1lQ29sbGVjdGlvbiIsIHsgY29sbGVjdGlvbjogdGhpcy5uYW1lIH0pOwogIH0KICBzYXZlKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoInNhdmUiLCB7IGNvbGxlY3Rpb246IHRoaXMubmFtZSB9KTsKICB9CiAgc3RhdHMoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigic3RhdHMiLCB7IGNvbGxlY3Rpb246IHRoaXMubmFtZSB9KTsKICB9CiAgc3RvcmFnZVNpemUoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigic3RvcmFnZVNpemUiLCB7IGNvbGxlY3Rpb246IHRoaXMubmFtZSB9KTsKICB9CiAgdG90YWxTaXplKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoInRvdGFsU2l6ZSIsIHsgY29sbGVjdGlvbjogdGhpcy5uYW1lIH0pOwogIH0KICB0b3RhbEluZGV4U2l6ZSgpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJ0b3RhbEluZGV4U2l6ZSIsIHsgY29sbGVjdGlvbjogdGhpcy5uYW1lIH0pOwogIH0KICBhc3luYyB1cGRhdGUocXVlcnksIHVwZGF0ZXMsIG9wdGlvbnMpIHsKICAgIGNvbnN0IGMgPSB0aGlzLmZpbmQocXVlcnkpOwogICAgYXdhaXQgYy5fZW5zdXJlSW5pdGlhbGl6ZWQoKTsKICAgIGlmIChhd2FpdCBjLmhhc05leHQoKSkgewogICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLm11bHRpKSB7CiAgICAgICAgd2hpbGUgKGF3YWl0IGMuaGFzTmV4dCgpKSB7CiAgICAgICAgICBjb25zdCBkb2MgPSBhd2FpdCBjLm5leHQoKTsKICAgICAgICAgIGNvbnN0IG1hdGNoSW5mbyA9IG1hdGNoV2l0aEFycmF5SW5kaWNlcyhkb2MsIHF1ZXJ5KTsKICAgICAgICAgIGNvbnN0IHBvc2l0aW9uYWxNYXRjaEluZm8gPSBtYXRjaEluZm8uYXJyYXlGaWx0ZXJzOwogICAgICAgICAgY29uc3QgdXNlckFycmF5RmlsdGVycyA9IG9wdGlvbnMgJiYgb3B0aW9ucy5hcnJheUZpbHRlcnM7CiAgICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZUluZGV4ZXNPbkRlbGV0ZShkb2MpOwogICAgICAgICAgYXBwbHlVcGRhdGVzKHVwZGF0ZXMsIGRvYywgZmFsc2UsIHBvc2l0aW9uYWxNYXRjaEluZm8sIHVzZXJBcnJheUZpbHRlcnMpOwogICAgICAgICAgYXdhaXQgdGhpcy5kb2N1bWVudHMuYWRkKGRvYy5faWQudG9TdHJpbmcoKSwgZG9jKTsKICAgICAgICAgIGF3YWl0IHRoaXMudXBkYXRlSW5kZXhlc09uSW5zZXJ0KGRvYyk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGRvYyA9IGF3YWl0IGMubmV4dCgpOwogICAgICAgIGNvbnN0IG1hdGNoSW5mbyA9IG1hdGNoV2l0aEFycmF5SW5kaWNlcyhkb2MsIHF1ZXJ5KTsKICAgICAgICBjb25zdCBwb3NpdGlvbmFsTWF0Y2hJbmZvID0gbWF0Y2hJbmZvLmFycmF5RmlsdGVyczsKICAgICAgICBjb25zdCB1c2VyQXJyYXlGaWx0ZXJzID0gb3B0aW9ucyAmJiBvcHRpb25zLmFycmF5RmlsdGVyczsKICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZUluZGV4ZXNPbkRlbGV0ZShkb2MpOwogICAgICAgIGFwcGx5VXBkYXRlcyh1cGRhdGVzLCBkb2MsIGZhbHNlLCBwb3NpdGlvbmFsTWF0Y2hJbmZvLCB1c2VyQXJyYXlGaWx0ZXJzKTsKICAgICAgICBhd2FpdCB0aGlzLmRvY3VtZW50cy5hZGQoZG9jLl9pZC50b1N0cmluZygpLCBkb2MpOwogICAgICAgIGF3YWl0IHRoaXMudXBkYXRlSW5kZXhlc09uSW5zZXJ0KGRvYyk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMudXBzZXJ0KSB7CiAgICAgICAgY29uc3QgbmV3RG9jID0gY3JlYXRlRG9jRnJvbVVwZGF0ZShxdWVyeSwgdXBkYXRlcywgbmV3IE9iamVjdElkKCkpOwogICAgICAgIGF3YWl0IHRoaXMuZG9jdW1lbnRzLmFkZChuZXdEb2MuX2lkLnRvU3RyaW5nKCksIG5ld0RvYyk7CiAgICAgICAgYXdhaXQgdGhpcy51cGRhdGVJbmRleGVzT25JbnNlcnQobmV3RG9jKTsKICAgICAgfQogICAgfQogIH0KICBhc3luYyB1cGRhdGVPbmUocXVlcnksIHVwZGF0ZXMsIG9wdGlvbnMpIHsKICAgIGNvbnN0IGMgPSB0aGlzLmZpbmQocXVlcnkpOwogICAgYXdhaXQgYy5fZW5zdXJlSW5pdGlhbGl6ZWQoKTsKICAgIGlmIChhd2FpdCBjLmhhc05leHQoKSkgewogICAgICBjb25zdCBkb2MgPSBhd2FpdCBjLm5leHQoKTsKICAgICAgY29uc3Qgb3JpZ2luYWxEb2MgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGRvYykpOwogICAgICBjb25zdCBtYXRjaEluZm8gPSBtYXRjaFdpdGhBcnJheUluZGljZXMoZG9jLCBxdWVyeSk7CiAgICAgIGNvbnN0IHBvc2l0aW9uYWxNYXRjaEluZm8gPSBtYXRjaEluZm8uYXJyYXlGaWx0ZXJzOwogICAgICBjb25zdCB1c2VyQXJyYXlGaWx0ZXJzID0gb3B0aW9ucyAmJiBvcHRpb25zLmFycmF5RmlsdGVyczsKICAgICAgYXdhaXQgdGhpcy51cGRhdGVJbmRleGVzT25EZWxldGUoZG9jKTsKICAgICAgYXBwbHlVcGRhdGVzKHVwZGF0ZXMsIGRvYywgZmFsc2UsIHBvc2l0aW9uYWxNYXRjaEluZm8sIHVzZXJBcnJheUZpbHRlcnMpOwogICAgICB0aGlzLmRvY3VtZW50cy5hZGQoZG9jLl9pZC50b1N0cmluZygpLCBkb2MpOwogICAgICBhd2FpdCB0aGlzLnVwZGF0ZUluZGV4ZXNPbkluc2VydChkb2MpOwogICAgICBjb25zdCB1cGRhdGVEZXNjcmlwdGlvbiA9IHRoaXMuX2dldFVwZGF0ZURlc2NyaXB0aW9uKG9yaWdpbmFsRG9jLCBkb2MpOwogICAgICB0aGlzLmVtaXQoInVwZGF0ZSIsIGRvYywgdXBkYXRlRGVzY3JpcHRpb24pOwogICAgfSBlbHNlIHsKICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy51cHNlcnQpIHsKICAgICAgICBjb25zdCBuZXdEb2MgPSBjcmVhdGVEb2NGcm9tVXBkYXRlKHF1ZXJ5LCB1cGRhdGVzLCBuZXcgT2JqZWN0SWQoKSk7CiAgICAgICAgdGhpcy5kb2N1bWVudHMuYWRkKG5ld0RvYy5faWQudG9TdHJpbmcoKSwgbmV3RG9jKTsKICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZUluZGV4ZXNPbkluc2VydChuZXdEb2MpOwogICAgICAgIHRoaXMuZW1pdCgiaW5zZXJ0IiwgbmV3RG9jKTsKICAgICAgfQogICAgfQogIH0KICBhc3luYyB1cGRhdGVNYW55KHF1ZXJ5LCB1cGRhdGVzLCBvcHRpb25zKSB7CiAgICBjb25zdCBjID0gdGhpcy5maW5kKHF1ZXJ5KTsKICAgIGF3YWl0IGMuX2Vuc3VyZUluaXRpYWxpemVkKCk7CiAgICBpZiAoYXdhaXQgYy5oYXNOZXh0KCkpIHsKICAgICAgd2hpbGUgKGF3YWl0IGMuaGFzTmV4dCgpKSB7CiAgICAgICAgY29uc3QgZG9jID0gYXdhaXQgYy5uZXh0KCk7CiAgICAgICAgY29uc3Qgb3JpZ2luYWxEb2MgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGRvYykpOwogICAgICAgIGNvbnN0IG1hdGNoSW5mbyA9IG1hdGNoV2l0aEFycmF5SW5kaWNlcyhkb2MsIHF1ZXJ5KTsKICAgICAgICBjb25zdCBwb3NpdGlvbmFsTWF0Y2hJbmZvID0gbWF0Y2hJbmZvLmFycmF5RmlsdGVyczsKICAgICAgICBjb25zdCB1c2VyQXJyYXlGaWx0ZXJzID0gb3B0aW9ucyAmJiBvcHRpb25zLmFycmF5RmlsdGVyczsKICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZUluZGV4ZXNPbkRlbGV0ZShkb2MpOwogICAgICAgIGFwcGx5VXBkYXRlcyh1cGRhdGVzLCBkb2MsIGZhbHNlLCBwb3NpdGlvbmFsTWF0Y2hJbmZvLCB1c2VyQXJyYXlGaWx0ZXJzKTsKICAgICAgICB0aGlzLmRvY3VtZW50cy5hZGQoZG9jLl9pZC50b1N0cmluZygpLCBkb2MpOwogICAgICAgIGF3YWl0IHRoaXMudXBkYXRlSW5kZXhlc09uSW5zZXJ0KGRvYyk7CiAgICAgICAgY29uc3QgdXBkYXRlRGVzY3JpcHRpb24gPSB0aGlzLl9nZXRVcGRhdGVEZXNjcmlwdGlvbihvcmlnaW5hbERvYywgZG9jKTsKICAgICAgICB0aGlzLmVtaXQoInVwZGF0ZSIsIGRvYywgdXBkYXRlRGVzY3JpcHRpb24pOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnVwc2VydCkgewogICAgICAgIGNvbnN0IG5ld0RvYyA9IGNyZWF0ZURvY0Zyb21VcGRhdGUocXVlcnksIHVwZGF0ZXMsIG5ldyBPYmplY3RJZCgpKTsKICAgICAgICB0aGlzLmRvY3VtZW50cy5hZGQobmV3RG9jLl9pZC50b1N0cmluZygpLCBuZXdEb2MpOwogICAgICAgIGF3YWl0IHRoaXMudXBkYXRlSW5kZXhlc09uSW5zZXJ0KG5ld0RvYyk7CiAgICAgICAgdGhpcy5lbWl0KCJpbnNlcnQiLCBuZXdEb2MpOwogICAgICB9CiAgICB9CiAgfQogIHZhbGlkYXRlKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoInZhbGlkYXRlIiwgeyBjb2xsZWN0aW9uOiB0aGlzLm5hbWUgfSk7CiAgfQogIC8qKgogICAqIEdlbmVyYXRlIHVwZGF0ZURlc2NyaXB0aW9uIGZvciBjaGFuZ2UgZXZlbnRzCiAgICogQ29tcGFyZXMgb3JpZ2luYWwgYW5kIHVwZGF0ZWQgZG9jdW1lbnRzIHRvIHRyYWNrIGNoYW5nZXMKICAgKi8KICBfZ2V0VXBkYXRlRGVzY3JpcHRpb24ob3JpZ2luYWxEb2MsIHVwZGF0ZWREb2MpIHsKICAgIGNvbnN0IHVwZGF0ZWRGaWVsZHMgPSB7fTsKICAgIGNvbnN0IHJlbW92ZWRGaWVsZHMgPSBbXTsKICAgIGZvciAoY29uc3Qga2V5IGluIHVwZGF0ZWREb2MpIHsKICAgICAgaWYgKGtleSA9PT0gIl9pZCIpIGNvbnRpbnVlOwogICAgICBpZiAoSlNPTi5zdHJpbmdpZnkob3JpZ2luYWxEb2Nba2V5XSkgIT09IEpTT04uc3RyaW5naWZ5KHVwZGF0ZWREb2Nba2V5XSkpIHsKICAgICAgICB1cGRhdGVkRmllbGRzW2tleV0gPSB1cGRhdGVkRG9jW2tleV07CiAgICAgIH0KICAgIH0KICAgIGZvciAoY29uc3Qga2V5IGluIG9yaWdpbmFsRG9jKSB7CiAgICAgIGlmIChrZXkgPT09ICJfaWQiKSBjb250aW51ZTsKICAgICAgaWYgKCEoa2V5IGluIHVwZGF0ZWREb2MpKSB7CiAgICAgICAgcmVtb3ZlZEZpZWxkcy5wdXNoKGtleSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB7CiAgICAgIHVwZGF0ZWRGaWVsZHMsCiAgICAgIHJlbW92ZWRGaWVsZHMsCiAgICAgIHRydW5jYXRlZEFycmF5czogW10KICAgICAgLy8gTm90IGltcGxlbWVudGVkIGluIG1pY3JvLW1vbmdvCiAgICB9OwogIH0KICAvKioKICAgKiBXYXRjaCBmb3IgY2hhbmdlcyB0byB0aGlzIGNvbGxlY3Rpb24KICAgKiBAcGFyYW0ge0FycmF5fSBwaXBlbGluZSAtIEFnZ3JlZ2F0aW9uIHBpcGVsaW5lIHRvIGZpbHRlciBjaGFuZ2VzCiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgLSBXYXRjaCBvcHRpb25zIChmdWxsRG9jdW1lbnQsIGV0Yy4pCiAgICogQHJldHVybnMge0NoYW5nZVN0cmVhbX0gQSBjaGFuZ2Ugc3RyZWFtIGluc3RhbmNlCiAgICovCiAgd2F0Y2gocGlwZWxpbmUgPSBbXSwgb3B0aW9ucyA9IHt9KSB7CiAgICByZXR1cm4gbmV3IENoYW5nZVN0cmVhbSh0aGlzLCBwaXBlbGluZSwgb3B0aW9ucyk7CiAgfQp9CmZ1bmN0aW9uIGFwcGx5UHJvamVjdGlvbldpdGhFeHByZXNzaW9ucyhwcm9qZWN0aW9uLCBkb2MpIHsKICBjb25zdCByZXN1bHQgPSB7fTsKICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMocHJvamVjdGlvbik7CiAgbGV0IGlzSW5jbHVzaW9uID0gZmFsc2U7CiAgbGV0IGhhc0NvbXB1dGVkRmllbGRzID0gZmFsc2U7CiAgZm9yIChjb25zdCBrZXkgb2Yga2V5cykgewogICAgaWYgKGtleSA9PT0gIl9pZCIpIGNvbnRpbnVlOwogICAgY29uc3QgdmFsdWUgPSBwcm9qZWN0aW9uW2tleV07CiAgICBpZiAodmFsdWUgPT09IDEgfHwgdmFsdWUgPT09IHRydWUpIHsKICAgICAgaXNJbmNsdXNpb24gPSB0cnVlOwogICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gMCB8fCB2YWx1ZSA9PT0gZmFsc2UpIDsKICAgIGVsc2UgewogICAgICBoYXNDb21wdXRlZEZpZWxkcyA9IHRydWU7CiAgICB9CiAgfQogIGlmIChoYXNDb21wdXRlZEZpZWxkcyB8fCBpc0luY2x1c2lvbikgewogICAgaWYgKHByb2plY3Rpb24uX2lkICE9PSAwICYmIHByb2plY3Rpb24uX2lkICE9PSBmYWxzZSkgewogICAgICByZXN1bHQuX2lkID0gZG9jLl9pZDsKICAgIH0KICAgIGZvciAoY29uc3Qga2V5IG9mIGtleXMpIHsKICAgICAgY29uc3QgdmFsdWUgPSBwcm9qZWN0aW9uW2tleV07CiAgICAgIGlmIChrZXkgPT09ICJfaWQiKSB7CiAgICAgICAgaWYgKHZhbHVlID09PSAwIHx8IHZhbHVlID09PSBmYWxzZSkgewogICAgICAgICAgZGVsZXRlIHJlc3VsdC5faWQ7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHZhbHVlID09PSAxIHx8IHZhbHVlID09PSB0cnVlKSB7CiAgICAgICAgcmVzdWx0W2tleV0gPSBnZXRQcm9wKGRvYywga2V5KTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXN1bHRba2V5XSA9IGV2YWx1YXRlRXhwcmVzc2lvbih2YWx1ZSwgZG9jKTsKICAgICAgfQogICAgfQogIH0gZWxzZSB7CiAgICBmb3IgKGNvbnN0IGtleSBpbiBkb2MpIHsKICAgICAgaWYgKGRvYy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgcmVzdWx0W2tleV0gPSBkb2Nba2V5XTsKICAgICAgfQogICAgfQogICAgZm9yIChjb25zdCBrZXkgb2Yga2V5cykgewogICAgICBpZiAocHJvamVjdGlvbltrZXldID09PSAwIHx8IHByb2plY3Rpb25ba2V5XSA9PT0gZmFsc2UpIHsKICAgICAgICBkZWxldGUgcmVzdWx0W2tleV07CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIHJlc3VsdDsKfQpjbGFzcyBEQiB7CiAgY29uc3RydWN0b3Iob3B0aW9ucykgewogICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHRoaXMuYmFzZUZvbGRlciA9IHRoaXMub3B0aW9ucy5iYXNlRm9sZGVyIHx8ICJtaWNyby1tb25nbyI7CiAgICB0aGlzLmRiTmFtZSA9IHRoaXMub3B0aW9ucy5kYk5hbWUgfHwgImRlZmF1bHQiOwogICAgdGhpcy5kYkZvbGRlciA9IGAke3RoaXMuYmFzZUZvbGRlcn0vJHt0aGlzLmRiTmFtZX1gOwogICAgdGhpcy5jb2xsZWN0aW9ucyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICBjb25zdCBwcm94eSA9IG5ldyBQcm94eSh0aGlzLCB7CiAgICAgIGdldCh0YXJnZXQsIHByb3BlcnR5LCByZWNlaXZlcikgewogICAgICAgIGlmIChwcm9wZXJ0eSBpbiB0YXJnZXQpIHsKICAgICAgICAgIHJldHVybiBSZWZsZWN0LmdldCh0YXJnZXQsIHByb3BlcnR5LCByZWNlaXZlcik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgcHJvcGVydHkgPT09ICJzeW1ib2wiIHx8IHByb3BlcnR5LnN0YXJ0c1dpdGgoIl8iKSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBwcm9wZXJ0eSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgIHJldHVybiB0YXJnZXQuZ2V0Q29sbGVjdGlvbihwcm9wZXJ0eSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgIH0KICAgIH0pOwogICAgdGhpcy5fcHJveHkgPSBwcm94eTsKICAgIHJldHVybiBwcm94eTsKICB9CiAgLyoqCiAgICogQ2xvc2UgYWxsIGNvbGxlY3Rpb25zCiAgICovCiAgYXN5bmMgY2xvc2UoKSB7CiAgICBmb3IgKGNvbnN0IFtfLCBjb2xsZWN0aW9uXSBvZiB0aGlzLmNvbGxlY3Rpb25zKSB7CiAgICAgIGF3YWl0IGNvbGxlY3Rpb24uY2xvc2UoKTsKICAgIH0KICB9CiAgLy8gREIgTWV0aG9kcwogIGNsb25lQ29sbGVjdGlvbigpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJjbG9uZUNvbGxlY3Rpb24iLCB7IGRhdGFiYXNlOiB0aGlzLmRiTmFtZSB9KTsKICB9CiAgY2xvbmVEYXRhYmFzZSgpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJjbG9uZURhdGFiYXNlIiwgeyBkYXRhYmFzZTogdGhpcy5kYk5hbWUgfSk7CiAgfQogIGNvbW1hbmRIZWxwKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoImNvbW1hbmRIZWxwIiwgeyBkYXRhYmFzZTogdGhpcy5kYk5hbWUgfSk7CiAgfQogIGNvcHlEYXRhYmFzZSgpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJjb3B5RGF0YWJhc2UiLCB7IGRhdGFiYXNlOiB0aGlzLmRiTmFtZSB9KTsKICB9CiAgY3JlYXRlQ29sbGVjdGlvbihuYW1lKSB7CiAgICBpZiAoIXRoaXMuY29sbGVjdGlvbnMuaGFzKG5hbWUpKSB7CiAgICAgIHRoaXMuY29sbGVjdGlvbnMuc2V0KG5hbWUsIG5ldyBDb2xsZWN0aW9uKHRoaXMsIG5hbWUpKTsKICAgIH0KICAgIHJldHVybiB7IG9rOiAxIH07CiAgfQogIGN1cnJlbnRPcCgpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJjdXJyZW50T3AiLCB7IGRhdGFiYXNlOiB0aGlzLmRiTmFtZSB9KTsKICB9CiAgYXN5bmMgZHJvcENvbGxlY3Rpb24oY29sbGVjdGlvbk5hbWUpIHsKICAgIGlmICh0aGlzLmNvbGxlY3Rpb25zLmhhcyhjb2xsZWN0aW9uTmFtZSkpIHsKICAgICAgY29uc3QgY29sbGVjdGlvbiA9IHRoaXMuY29sbGVjdGlvbnMuZ2V0KGNvbGxlY3Rpb25OYW1lKTsKICAgICAgaWYgKHR5cGVvZiBjb2xsZWN0aW9uLmRyb3AgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICBhd2FpdCBjb2xsZWN0aW9uLmRyb3AoKTsKICAgICAgfQogICAgICB0aGlzLmNvbGxlY3Rpb25zLmRlbGV0ZShjb2xsZWN0aW9uTmFtZSk7CiAgICB9CiAgfQogIGFzeW5jIGRyb3BEYXRhYmFzZSgpIHsKICAgIGZvciAoY29uc3QgW18sIGNvbGxlY3Rpb25dIG9mIHRoaXMuY29sbGVjdGlvbnMpIHsKICAgICAgYXdhaXQgY29sbGVjdGlvbi5kcm9wKCk7CiAgICB9CiAgICB0aGlzLmNvbGxlY3Rpb25zLmNsZWFyKCk7CiAgICBjb25zdCBwYXRoUGFydHMgPSB0aGlzLmRiRm9sZGVyLnNwbGl0KCIvIikuZmlsdGVyKEJvb2xlYW4pOwogICAgY29uc3QgZGJGb2xkZXIgPSBwYXRoUGFydHMucG9wKCk7CiAgICB0cnkgewogICAgICBsZXQgZGlyID0gYXdhaXQgZ2xvYmFsVGhpcy5uYXZpZ2F0b3Iuc3RvcmFnZS5nZXREaXJlY3RvcnkoKTsKICAgICAgZm9yIChjb25zdCBwYXJ0IG9mIHBhdGhQYXJ0cykgewogICAgICAgIGRpciA9IGF3YWl0IGRpci5nZXREaXJlY3RvcnlIYW5kbGUocGFydCwgeyBjcmVhdGU6IGZhbHNlIH0pOwogICAgICB9CiAgICAgIGF3YWl0IGRpci5yZW1vdmVFbnRyeShkYkZvbGRlciwgeyByZWN1cnNpdmU6IHRydWUgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoZXJyb3IubmFtZSAhPT0gIk5vdEZvdW5kRXJyb3IiICYmIGVycm9yLmNvZGUgIT09ICJFTk9FTlQiKSB7CiAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB7IG9rOiAxIH07CiAgfQogIGV2YWwoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigiZXZhbCIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICBmc3luY0xvY2soKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigiZnN5bmNMb2NrIiwgeyBkYXRhYmFzZTogdGhpcy5kYk5hbWUgfSk7CiAgfQogIGZzeW5jVW5sb2NrKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoImZzeW5jVW5sb2NrIiwgeyBkYXRhYmFzZTogdGhpcy5kYk5hbWUgfSk7CiAgfQogIGdldENvbGxlY3Rpb24obmFtZSkgewogICAgaWYgKCF0aGlzLmNvbGxlY3Rpb25zLmhhcyhuYW1lKSkgewogICAgICBjb25zdCBkYlJlZiA9IHRoaXMuX3Byb3h5IHx8IHRoaXM7CiAgICAgIHRoaXMuY29sbGVjdGlvbnMuc2V0KG5hbWUsIG5ldyBDb2xsZWN0aW9uKGRiUmVmLCBuYW1lKSk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5jb2xsZWN0aW9ucy5nZXQobmFtZSk7CiAgfQogIC8vIEFsaWFzIGZvciBnZXRDb2xsZWN0aW9uIGZvciBNb25nb0RCIEFQSSBjb21wYXRpYmlsaXR5CiAgY29sbGVjdGlvbihuYW1lKSB7CiAgICByZXR1cm4gdGhpcy5nZXRDb2xsZWN0aW9uKG5hbWUpOwogIH0KICBnZXRDb2xsZWN0aW9uSW5mb3MoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigiZ2V0Q29sbGVjdGlvbkluZm9zIiwgeyBkYXRhYmFzZTogdGhpcy5kYk5hbWUgfSk7CiAgfQogIGdldENvbGxlY3Rpb25OYW1lcygpIHsKICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMuY29sbGVjdGlvbnMua2V5cygpKTsKICB9CiAgZ2V0TGFzdEVycm9yKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoImdldExhc3RFcnJvciIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICBnZXRMYXN0RXJyb3JPYmooKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigiZ2V0TGFzdEVycm9yT2JqIiwgeyBkYXRhYmFzZTogdGhpcy5kYk5hbWUgfSk7CiAgfQogIGdldExvZ0NvbXBvbmVudHMoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigiZ2V0TG9nQ29tcG9uZW50cyIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICBnZXRNb25nbygpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJnZXRNb25nbyIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICBnZXROYW1lKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoImdldE5hbWUiLCB7IGRhdGFiYXNlOiB0aGlzLmRiTmFtZSB9KTsKICB9CiAgZ2V0UHJldkVycm9yKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoImdldFByZXZFcnJvciIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICBnZXRQcm9maWxpbmdMZXZlbCgpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJnZXRQcm9maWxpbmdMZXZlbCIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICBnZXRQcm9maWxpbmdTdGF0dXMoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigiZ2V0UHJvZmlsaW5nU3RhdHVzIiwgeyBkYXRhYmFzZTogdGhpcy5kYk5hbWUgfSk7CiAgfQogIGdldFJlcGxpY2F0aW9uSW5mbygpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJnZXRSZXBsaWNhdGlvbkluZm8iLCB7IGRhdGFiYXNlOiB0aGlzLmRiTmFtZSB9KTsKICB9CiAgZ2V0U2libGluZ0RCKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoImdldFNpYmxpbmdEQiIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICBoZWxwKCkgewogICAgY29uc29sZS5sb2coIiAgICAgICAgaGVscCBtciAgICAgICAgICAgICAgICAgICAgICBtYXByZWR1Y2UiKTsKICAgIGNvbnNvbGUubG9nKCIgICAgICAgIGRiLmZvby5maW5kKCkgICAgICAgICAgICAgICAgbGlzdCBvYmplY3RzIGluIGNvbGxlY3Rpb24gZm9vIik7CiAgICBjb25zb2xlLmxvZygiICAgICAgICBkYi5mb28uZmluZCggeyBhIDogMSB9ICkgICAgIGxpc3Qgb2JqZWN0cyBpbiBmb28gd2hlcmUgYSA9PSAxIik7CiAgICBjb25zb2xlLmxvZygiICAgICAgICBpdCAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCBvZiB0aGUgbGFzdCBsaW5lIGV2YWx1YXRlZDsgdXNlIHRvIGZ1cnRoZXIgaXRlcmF0ZSIpOwogIH0KICBob3N0SW5mbygpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJob3N0SW5mbyIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICBpc01hc3RlcigpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJpc01hc3RlciIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICBraWxsT3AoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigia2lsbE9wIiwgeyBkYXRhYmFzZTogdGhpcy5kYk5hbWUgfSk7CiAgfQogIGxpc3RDb21tYW5kcygpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJsaXN0Q29tbWFuZHMiLCB7IGRhdGFiYXNlOiB0aGlzLmRiTmFtZSB9KTsKICB9CiAgbG9hZFNlcnZlclNjcmlwdHMoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigibG9hZFNlcnZlclNjcmlwdHMiLCB7IGRhdGFiYXNlOiB0aGlzLmRiTmFtZSB9KTsKICB9CiAgbG9nb3V0KCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoImxvZ291dCIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICBwcmludENvbGxlY3Rpb25TdGF0cygpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJwcmludENvbGxlY3Rpb25TdGF0cyIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICBwcmludFJlcGxpY2F0aW9uSW5mbygpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJwcmludFJlcGxpY2F0aW9uSW5mbyIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICBwcmludFNoYXJkaW5nU3RhdHVzKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoInByaW50U2hhcmRpbmdTdGF0dXMiLCB7IGRhdGFiYXNlOiB0aGlzLmRiTmFtZSB9KTsKICB9CiAgcHJpbnRTbGF2ZVJlcGxpY2F0aW9uSW5mbygpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJwcmludFNsYXZlUmVwbGljYXRpb25JbmZvIiwgeyBkYXRhYmFzZTogdGhpcy5kYk5hbWUgfSk7CiAgfQogIHJlcGFpckRhdGFiYXNlKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoInJlcGFpckRhdGFiYXNlIiwgeyBkYXRhYmFzZTogdGhpcy5kYk5hbWUgfSk7CiAgfQogIHJlc2V0RXJyb3IoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigicmVzZXRFcnJvciIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICBydW5Db21tYW5kKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoInJ1bkNvbW1hbmQiLCB7IGRhdGFiYXNlOiB0aGlzLmRiTmFtZSB9KTsKICB9CiAgc2VydmVyQnVpbGRJbmZvKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoInNlcnZlckJ1aWxkSW5mbyIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICBzZXJ2ZXJDbWRMaW5lT3B0cygpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJzZXJ2ZXJDbWRMaW5lT3B0cyIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICBzZXJ2ZXJTdGF0dXMoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigic2VydmVyU3RhdHVzIiwgeyBkYXRhYmFzZTogdGhpcy5kYk5hbWUgfSk7CiAgfQogIHNldExvZ0xldmVsKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoInNldExvZ0xldmVsIiwgeyBkYXRhYmFzZTogdGhpcy5kYk5hbWUgfSk7CiAgfQogIHNldFByb2ZpbGluZ0xldmVsKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoInNldFByb2ZpbGluZ0xldmVsIiwgeyBkYXRhYmFzZTogdGhpcy5kYk5hbWUgfSk7CiAgfQogIHNodXRkb3duU2VydmVyKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoInNodXRkb3duU2VydmVyIiwgeyBkYXRhYmFzZTogdGhpcy5kYk5hbWUgfSk7CiAgfQogIHN0YXRzKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoInN0YXRzIiwgeyBkYXRhYmFzZTogdGhpcy5kYk5hbWUgfSk7CiAgfQogIHZlcnNpb24oKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigidmVyc2lvbiIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICB1cGdyYWRlQ2hlY2soKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigidXBncmFkZUNoZWNrIiwgeyBkYXRhYmFzZTogdGhpcy5kYk5hbWUgfSk7CiAgfQogIHVwZ3JhZGVDaGVja0FsbERCcygpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJ1cGdyYWRlQ2hlY2tBbGxEQnMiLCB7IGRhdGFiYXNlOiB0aGlzLmRiTmFtZSB9KTsKICB9CiAgLyoqCiAgICogV2F0Y2ggZm9yIGNoYW5nZXMgYWNyb3NzIGFsbCBjb2xsZWN0aW9ucyBpbiB0aGlzIGRhdGFiYXNlCiAgICogQHBhcmFtIHtBcnJheX0gcGlwZWxpbmUgLSBBZ2dyZWdhdGlvbiBwaXBlbGluZSB0byBmaWx0ZXIgY2hhbmdlcwogICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIC0gV2F0Y2ggb3B0aW9ucwogICAqIEByZXR1cm5zIHtDaGFuZ2VTdHJlYW19IEEgY2hhbmdlIHN0cmVhbSBpbnN0YW5jZQogICAqLwogIHdhdGNoKHBpcGVsaW5lID0gW10sIG9wdGlvbnMgPSB7fSkgewogICAgcmV0dXJuIG5ldyBDaGFuZ2VTdHJlYW0odGhpcywgcGlwZWxpbmUsIG9wdGlvbnMpOwogIH0KfQpjbGFzcyBTZXJ2ZXIgewogIGNvbnN0cnVjdG9yKG9wdGlvbnMgPSB7fSwgcG9zdEV2ZW50ID0gKCkgPT4gewogIH0pIHsKICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICB0aGlzLmRhdGFiYXNlcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICB0aGlzLnBvc3RFdmVudCA9IHBvc3RFdmVudDsKICAgIHRoaXMuY3Vyc29ycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICB0aGlzLmN1cnNvckNvdW50ZXIgPSAxOwogICAgdGhpcy5zdHJlYW1zID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIHRoaXMuc3RyZWFtQ291bnRlciA9IDE7CiAgfQogIGFzeW5jIGRpc3BhdGNoKHJlcXVlc3QpIHsKICAgIGNvbnN0IHsgdGFyZ2V0LCBkYXRhYmFzZSwgY29sbGVjdGlvbiwgbWV0aG9kLCBhcmdzID0gW10sIGN1cnNvcklkLCBzdHJlYW1JZCwgY3Vyc29yT3B0cyB9ID0gcmVxdWVzdDsKICAgIGlmICh0YXJnZXQgPT09ICJjdXJzb3IiKSB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9jdXJzb3JPcChjdXJzb3JJZCwgbWV0aG9kLCBhcmdzKTsKICAgIH0KICAgIGlmICh0YXJnZXQgPT09ICJjaGFuZ2VzdHJlYW0iKSB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9jaGFuZ2VTdHJlYW1PcChzdHJlYW1JZCwgbWV0aG9kLCBhcmdzKTsKICAgIH0KICAgIGlmICghdGFyZ2V0IHx8ICFkYXRhYmFzZSB8fCAhbWV0aG9kKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCByZXF1ZXN0IHBheWxvYWQiKTsKICAgIH0KICAgIGNvbnN0IGRiID0gdGhpcy5fZ2V0REIoZGF0YWJhc2UpOwogICAgaWYgKHRhcmdldCA9PT0gImRiIikgewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fY2FsbChkYiwgbWV0aG9kLCBhcmdzKTsKICAgIH0KICAgIGlmICh0YXJnZXQgPT09ICJjb2xsZWN0aW9uIikgewogICAgICBpZiAoIWNvbGxlY3Rpb24pIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNvbGxlY3Rpb24gbmFtZSByZXF1aXJlZCBmb3IgY29sbGVjdGlvbiB0YXJnZXQiKTsKICAgICAgfQogICAgICBjb25zdCBjb2wgPSBkYi5jb2xsZWN0aW9uKGNvbGxlY3Rpb24pOwogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fY2FsbChjb2wsIG1ldGhvZCwgYXJncywgY3Vyc29yT3B0cyk7CiAgICB9CiAgICB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gdGFyZ2V0OiAke3RhcmdldH1gKTsKICB9CiAgX2dldERCKGRiTmFtZSkgewogICAgaWYgKHRoaXMuZGF0YWJhc2VzLmhhcyhkYk5hbWUpKSByZXR1cm4gdGhpcy5kYXRhYmFzZXMuZ2V0KGRiTmFtZSk7CiAgICBjb25zdCBkYiA9IG5ldyBEQih7IC4uLnRoaXMub3B0aW9ucywgZGJOYW1lIH0pOwogICAgdGhpcy5kYXRhYmFzZXMuc2V0KGRiTmFtZSwgZGIpOwogICAgcmV0dXJuIGRiOwogIH0KICBhc3luYyBfY2FsbCh0YXJnZXQsIG1ldGhvZCwgYXJncywgY3Vyc29yT3B0cykgewogICAgaWYgKHR5cGVvZiB0YXJnZXRbbWV0aG9kXSAhPT0gImZ1bmN0aW9uIikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoYE1ldGhvZCAke21ldGhvZH0gbm90IGZvdW5kIG9uIHRhcmdldGApOwogICAgfQogICAgY29uc3QgcmVzdWx0ID0gdGFyZ2V0W21ldGhvZF0oLi4uYXJncyB8fCBbXSk7CiAgICBjb25zdCBhd2FpdGVkID0gcmVzdWx0ICYmIHR5cGVvZiByZXN1bHQudGhlbiA9PT0gImZ1bmN0aW9uIiA/IGF3YWl0IHJlc3VsdCA6IHJlc3VsdDsKICAgIGlmIChhd2FpdGVkICYmIHR5cGVvZiBhd2FpdGVkLmhhc05leHQgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGF3YWl0ZWQubmV4dCA9PT0gImZ1bmN0aW9uIikgewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fcmVnaXN0ZXJDdXJzb3IoYXdhaXRlZCwgY3Vyc29yT3B0cyk7CiAgICB9CiAgICBpZiAobWV0aG9kID09PSAiYWdncmVnYXRlIiAmJiBBcnJheS5pc0FycmF5KGF3YWl0ZWQpKSB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9yZWdpc3RlckFycmF5QXNDdXJzb3IoYXdhaXRlZCk7CiAgICB9CiAgICBpZiAoYXdhaXRlZCAmJiBhd2FpdGVkLmNvbnN0cnVjdG9yPy5uYW1lID09PSAiQ2hhbmdlU3RyZWFtIikgewogICAgICByZXR1cm4gdGhpcy5fcmVnaXN0ZXJDaGFuZ2VTdHJlYW0oYXdhaXRlZCk7CiAgICB9CiAgICByZXR1cm4gYXdhaXRlZDsKICB9CiAgYXN5bmMgX3JlZ2lzdGVyQ3Vyc29yKGN1cnNvciwgY3Vyc29yT3B0cyA9IHt9KSB7CiAgICBpZiAoY3Vyc29yT3B0cy5zb3J0KSBjdXJzb3IgPSBjdXJzb3Iuc29ydChjdXJzb3JPcHRzLnNvcnQpOwogICAgaWYgKGN1cnNvck9wdHMuc2tpcCkgY3Vyc29yID0gYXdhaXQgY3Vyc29yLnNraXAoY3Vyc29yT3B0cy5za2lwKTsKICAgIGlmIChjdXJzb3JPcHRzLmxpbWl0KSBjdXJzb3IgPSBhd2FpdCBjdXJzb3IubGltaXQoY3Vyc29yT3B0cy5saW1pdCk7CiAgICBpZiAoY3Vyc29yT3B0cy5taW4gJiYgY3Vyc29yLm1pbikgY3Vyc29yID0gY3Vyc29yLm1pbihjdXJzb3JPcHRzLm1pbik7CiAgICBpZiAoY3Vyc29yT3B0cy5tYXggJiYgY3Vyc29yLm1heCkgY3Vyc29yID0gY3Vyc29yLm1heChjdXJzb3JPcHRzLm1heCk7CiAgICBpZiAoY3Vyc29yT3B0cy5oaW50ICYmIGN1cnNvci5oaW50KSBjdXJzb3IgPSBjdXJzb3IuaGludChjdXJzb3JPcHRzLmhpbnQpOwogICAgaWYgKGN1cnNvck9wdHMuY29tbWVudCAmJiBjdXJzb3IuY29tbWVudCkgY3Vyc29yID0gY3Vyc29yLmNvbW1lbnQoY3Vyc29yT3B0cy5jb21tZW50KTsKICAgIGlmIChjdXJzb3JPcHRzLm1heFRpbWVNUyAmJiBjdXJzb3IubWF4VGltZU1TKSBjdXJzb3IgPSBjdXJzb3IubWF4VGltZU1TKGN1cnNvck9wdHMubWF4VGltZU1TKTsKICAgIGlmIChjdXJzb3JPcHRzLm1heFNjYW4gJiYgY3Vyc29yLm1heFNjYW4pIGN1cnNvciA9IGN1cnNvci5tYXhTY2FuKGN1cnNvck9wdHMubWF4U2Nhbik7CiAgICBpZiAoY3Vyc29yT3B0cy5yZXR1cm5LZXkgJiYgY3Vyc29yLnJldHVybktleSkgY3Vyc29yID0gY3Vyc29yLnJldHVybktleShjdXJzb3JPcHRzLnJldHVybktleSk7CiAgICBpZiAoY3Vyc29yT3B0cy5zaG93UmVjb3JkSWQgJiYgY3Vyc29yLnNob3dSZWNvcmRJZCkgY3Vyc29yID0gY3Vyc29yLnNob3dSZWNvcmRJZChjdXJzb3JPcHRzLnNob3dSZWNvcmRJZCk7CiAgICBpZiAoY3Vyc29yT3B0cy5jb2xsYXRpb24gJiYgY3Vyc29yLmNvbGxhdGlvbikgY3Vyc29yID0gY3Vyc29yLmNvbGxhdGlvbihjdXJzb3JPcHRzLmNvbGxhdGlvbik7CiAgICBjb25zdCBpZCA9IGBjdXJfJHt0aGlzLmN1cnNvckNvdW50ZXIrK31gOwogICAgY29uc3QgYmF0Y2hTaXplID0gdGhpcy5vcHRpb25zLmJhdGNoU2l6ZSB8fCAxMDA7CiAgICBjb25zdCBiYXRjaCA9IFtdOwogICAgd2hpbGUgKGJhdGNoLmxlbmd0aCA8IGJhdGNoU2l6ZSAmJiBhd2FpdCBjdXJzb3IuaGFzTmV4dCgpKSB7CiAgICAgIGJhdGNoLnB1c2goYXdhaXQgY3Vyc29yLm5leHQoKSk7CiAgICB9CiAgICBjb25zdCBleGhhdXN0ZWQgPSAhYXdhaXQgY3Vyc29yLmhhc05leHQoKTsKICAgIGlmICghZXhoYXVzdGVkKSB7CiAgICAgIHRoaXMuY3Vyc29ycy5zZXQoaWQsIGN1cnNvcik7CiAgICB9CiAgICByZXR1cm4geyBjdXJzb3JJZDogaWQsIGJhdGNoLCBleGhhdXN0ZWQsIGJhdGNoU2l6ZSB9OwogIH0KICBhc3luYyBfcmVnaXN0ZXJBcnJheUFzQ3Vyc29yKHJlc3VsdHNBcnJheSkgewogICAgY29uc3QgaWQgPSBgY3VyXyR7dGhpcy5jdXJzb3JDb3VudGVyKyt9YDsKICAgIGNvbnN0IGJhdGNoU2l6ZSA9IHRoaXMub3B0aW9ucy5iYXRjaFNpemUgfHwgMTAwOwogICAgY29uc3QgYmF0Y2ggPSByZXN1bHRzQXJyYXkuc2xpY2UoMCwgYmF0Y2hTaXplKTsKICAgIGNvbnN0IGV4aGF1c3RlZCA9IHJlc3VsdHNBcnJheS5sZW5ndGggPD0gYmF0Y2hTaXplOwogICAgaWYgKCFleGhhdXN0ZWQpIHsKICAgICAgY29uc3QgY3Vyc29yID0gewogICAgICAgIHBvc2l0aW9uOiBiYXRjaFNpemUsCiAgICAgICAgYXJyYXk6IHJlc3VsdHNBcnJheSwKICAgICAgICBhc3luYyBoYXNOZXh0KCkgewogICAgICAgICAgcmV0dXJuIHRoaXMucG9zaXRpb24gPCB0aGlzLmFycmF5Lmxlbmd0aDsKICAgICAgICB9LAogICAgICAgIGFzeW5jIG5leHQoKSB7CiAgICAgICAgICBpZiAodGhpcy5wb3NpdGlvbiA+PSB0aGlzLmFycmF5Lmxlbmd0aCkgdGhyb3cgbmV3IEVycm9yKCJObyBtb3JlIGRvY3VtZW50cyIpOwogICAgICAgICAgcmV0dXJuIHRoaXMuYXJyYXlbdGhpcy5wb3NpdGlvbisrXTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIHRoaXMuY3Vyc29ycy5zZXQoaWQsIGN1cnNvcik7CiAgICB9CiAgICByZXR1cm4geyBjdXJzb3JJZDogaWQsIGJhdGNoLCBleGhhdXN0ZWQsIGJhdGNoU2l6ZSB9OwogIH0KICBhc3luYyBfY3Vyc29yT3AoY3Vyc29ySWQsIG1ldGhvZCwgYXJncyA9IFtdKSB7CiAgICBpZiAoIWN1cnNvcklkKSB0aHJvdyBuZXcgRXJyb3IoImN1cnNvcklkIHJlcXVpcmVkIik7CiAgICBjb25zdCBjdXJzb3IgPSB0aGlzLmN1cnNvcnMuZ2V0KGN1cnNvcklkKTsKICAgIGlmICghY3Vyc29yKSB7CiAgICAgIGlmIChtZXRob2QgPT09ICJjbG9zZSIpIHJldHVybiB7IGNsb3NlZDogdHJ1ZSB9OwogICAgICB0aHJvdyBuZXcgRXJyb3IoYEN1cnNvciBub3QgZm91bmQ6ICR7Y3Vyc29ySWR9YCk7CiAgICB9CiAgICBpZiAobWV0aG9kID09PSAiY2xvc2UiKSB7CiAgICAgIHRoaXMuY3Vyc29ycy5kZWxldGUoY3Vyc29ySWQpOwogICAgICByZXR1cm4geyBjbG9zZWQ6IHRydWUgfTsKICAgIH0KICAgIGlmIChtZXRob2QgPT09ICJnZXRNb3JlIikgewogICAgICBjb25zdCBvcHRzID0gYXJncz8uWzBdIHx8IHt9OwogICAgICBjb25zdCBiYXRjaFNpemUgPSBvcHRzLmJhdGNoU2l6ZSB8fCAxMDA7CiAgICAgIGNvbnN0IGJhdGNoID0gW107CiAgICAgIHdoaWxlIChiYXRjaC5sZW5ndGggPCBiYXRjaFNpemUgJiYgYXdhaXQgY3Vyc29yLmhhc05leHQoKSkgewogICAgICAgIGJhdGNoLnB1c2goYXdhaXQgY3Vyc29yLm5leHQoKSk7CiAgICAgIH0KICAgICAgY29uc3QgZXhoYXVzdGVkID0gIWF3YWl0IGN1cnNvci5oYXNOZXh0KCk7CiAgICAgIGlmIChleGhhdXN0ZWQpIHsKICAgICAgICB0aGlzLmN1cnNvcnMuZGVsZXRlKGN1cnNvcklkKTsKICAgICAgfQogICAgICByZXR1cm4geyBiYXRjaCwgZXhoYXVzdGVkLCBiYXRjaFNpemUgfTsKICAgIH0KICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biBjdXJzb3IgbWV0aG9kOiAke21ldGhvZH1gKTsKICB9CiAgX3JlZ2lzdGVyQ2hhbmdlU3RyZWFtKHN0cmVhbSkgewogICAgY29uc3QgaWQgPSBgY3NfJHt0aGlzLnN0cmVhbUNvdW50ZXIrK31gOwogICAgY29uc3QgaGFuZGxlcnMgPSB7CiAgICAgIGNoYW5nZTogKGNoYW5nZSkgPT4gdGhpcy5wb3N0RXZlbnQoewogICAgICAgIHR5cGU6ICJldmVudCIsCiAgICAgICAgZXZlbnQ6ICJjaGFuZ2VTdHJlYW0iLAogICAgICAgIHBheWxvYWQ6IHsgc3RyZWFtSWQ6IGlkLCB0eXBlOiAiY2hhbmdlIiwgZGF0YTogY2hhbmdlIH0KICAgICAgfSksCiAgICAgIGVycm9yOiAoZXJyKSA9PiB0aGlzLnBvc3RFdmVudCh7CiAgICAgICAgdHlwZTogImV2ZW50IiwKICAgICAgICBldmVudDogImNoYW5nZVN0cmVhbSIsCiAgICAgICAgcGF5bG9hZDogeyBzdHJlYW1JZDogaWQsIHR5cGU6ICJlcnJvciIsIGRhdGE6IHsKICAgICAgICAgIG5hbWU6IGVycj8ubmFtZSwKICAgICAgICAgIG1lc3NhZ2U6IGVycj8ubWVzc2FnZSwKICAgICAgICAgIHN0YWNrOiBlcnI/LnN0YWNrCiAgICAgICAgfSB9CiAgICAgIH0pLAogICAgICBjbG9zZTogKCkgPT4gdGhpcy5wb3N0RXZlbnQoewogICAgICAgIHR5cGU6ICJldmVudCIsCiAgICAgICAgZXZlbnQ6ICJjaGFuZ2VTdHJlYW0iLAogICAgICAgIHBheWxvYWQ6IHsgc3RyZWFtSWQ6IGlkLCB0eXBlOiAiY2xvc2UiIH0KICAgICAgfSkKICAgIH07CiAgICBzdHJlYW0ub24oImNoYW5nZSIsIGhhbmRsZXJzLmNoYW5nZSk7CiAgICBzdHJlYW0ub24oImVycm9yIiwgaGFuZGxlcnMuZXJyb3IpOwogICAgc3RyZWFtLm9uKCJjbG9zZSIsIGhhbmRsZXJzLmNsb3NlKTsKICAgIHRoaXMuc3RyZWFtcy5zZXQoaWQsIHsgc3RyZWFtLCBoYW5kbGVycyB9KTsKICAgIHJldHVybiB7IHN0cmVhbUlkOiBpZCB9OwogIH0KICBhc3luYyBfY2hhbmdlU3RyZWFtT3Aoc3RyZWFtSWQsIG1ldGhvZCkgewogICAgaWYgKCFzdHJlYW1JZCkgdGhyb3cgbmV3IEVycm9yKCJzdHJlYW1JZCByZXF1aXJlZCIpOwogICAgY29uc3QgZW50cnkgPSB0aGlzLnN0cmVhbXMuZ2V0KHN0cmVhbUlkKTsKICAgIGlmICghZW50cnkpIHJldHVybiB7IGNsb3NlZDogdHJ1ZSB9OwogICAgaWYgKG1ldGhvZCA9PT0gImNsb3NlIikgewogICAgICBjb25zdCB7IHN0cmVhbSwgaGFuZGxlcnMgfSA9IGVudHJ5OwogICAgICBzdHJlYW0ub2ZmKCJjaGFuZ2UiLCBoYW5kbGVycy5jaGFuZ2UpOwogICAgICBzdHJlYW0ub2ZmKCJlcnJvciIsIGhhbmRsZXJzLmVycm9yKTsKICAgICAgc3RyZWFtLm9mZigiY2xvc2UiLCBoYW5kbGVycy5jbG9zZSk7CiAgICAgIGlmICh0eXBlb2Ygc3RyZWFtLmNsb3NlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgYXdhaXQgc3RyZWFtLmNsb3NlKCk7CiAgICAgIH0KICAgICAgdGhpcy5zdHJlYW1zLmRlbGV0ZShzdHJlYW1JZCk7CiAgICAgIHJldHVybiB7IGNsb3NlZDogdHJ1ZSB9OwogICAgfQogICAgdGhyb3cgbmV3IEVycm9yKGBVbmtub3duIGNoYW5nZSBzdHJlYW0gbWV0aG9kOiAke21ldGhvZH1gKTsKICB9Cn0KZnVuY3Rpb24gc2VyaWFsaXplUGF5bG9hZChvYmopIHsKICBpZiAob2JqID09PSBudWxsIHx8IG9iaiA9PT0gdm9pZCAwKSByZXR1cm4gb2JqOwogIGlmIChvYmogaW5zdGFuY2VvZiBPYmplY3RJZCkgewogICAgcmV0dXJuIHsgX19vYmplY3RJZDogb2JqLnRvU3RyaW5nKCkgfTsKICB9CiAgaWYgKEFycmF5LmlzQXJyYXkob2JqKSkgewogICAgcmV0dXJuIG9iai5tYXAoc2VyaWFsaXplUGF5bG9hZCk7CiAgfQogIGlmICh0eXBlb2Ygb2JqID09PSAib2JqZWN0IikgewogICAgY29uc3QgcmVzdWx0ID0ge307CiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhvYmopKSB7CiAgICAgIHJlc3VsdFtrZXldID0gc2VyaWFsaXplUGF5bG9hZCh2YWx1ZSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICByZXR1cm4gb2JqOwp9CmZ1bmN0aW9uIGRlc2VyaWFsaXplUGF5bG9hZChvYmopIHsKICBpZiAob2JqID09PSBudWxsIHx8IG9iaiA9PT0gdm9pZCAwKSByZXR1cm4gb2JqOwogIGlmICh0eXBlb2Ygb2JqID09PSAib2JqZWN0IiAmJiBvYmouX19vYmplY3RJZCkgewogICAgcmV0dXJuIG5ldyBPYmplY3RJZChvYmouX19vYmplY3RJZCk7CiAgfQogIGlmIChBcnJheS5pc0FycmF5KG9iaikpIHsKICAgIHJldHVybiBvYmoubWFwKGRlc2VyaWFsaXplUGF5bG9hZCk7CiAgfQogIGlmICh0eXBlb2Ygb2JqID09PSAib2JqZWN0IikgewogICAgY29uc3QgcmVzdWx0ID0ge307CiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhvYmopKSB7CiAgICAgIHJlc3VsdFtrZXldID0gZGVzZXJpYWxpemVQYXlsb2FkKHZhbHVlKTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHJldHVybiBvYmo7Cn0KY29uc3QgaXNOb2RlID0gdHlwZW9mIHByb2Nlc3MgIT09ICJ1bmRlZmluZWQiICYmICEhcHJvY2Vzcy52ZXJzaW9ucz8ubm9kZTsKbGV0IHNlcnZlcjsKbGV0IGluaXRQcm9taXNlID0gbnVsbDsKaWYgKGlzTm9kZSkgewogIGluaXRQcm9taXNlID0gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiB7CiAgICBjb25zdCBpbXBvcnRGdW5jID0gbmV3IEZ1bmN0aW9uKCJzcGVjIiwgInJldHVybiBpbXBvcnQoc3BlYykiKTsKICAgIHJldHVybiBQcm9taXNlLmFsbChbCiAgICAgIGltcG9ydEZ1bmMoInBhdGgiKSwKICAgICAgaW1wb3J0RnVuYygidXJsIiksCiAgICAgIGltcG9ydEZ1bmMoIm5vZGUtb3BmcyIpCiAgICBdKTsKICB9KS50aGVuKChbcGF0aE1vZHVsZSwgdXJsTW9kdWxlLCBvcGZzTW9kdWxlXSkgPT4gewogICAgY29uc3QgcGF0aCA9IHBhdGhNb2R1bGUuZGVmYXVsdDsKICAgIGNvbnN0IHsgZmlsZVVSTFRvUGF0aCB9ID0gdXJsTW9kdWxlOwogICAgY29uc3QgeyBTdG9yYWdlTWFuYWdlciB9ID0gb3Bmc01vZHVsZTsKICAgIGNvbnN0IF9fZmlsZW5hbWUgPSBmaWxlVVJMVG9QYXRoKGltcG9ydC5tZXRhLnVybCk7CiAgICBjb25zdCBfX2Rpcm5hbWUgPSBwYXRoLmRpcm5hbWUoX19maWxlbmFtZSk7CiAgICBjb25zdCBwcm9qZWN0Um9vdCA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICIuLiIpOwogICAgY29uc3Qgb3Bmc0RpciA9IHBhdGguam9pbihwcm9qZWN0Um9vdCwgIi5vcGZzIik7CiAgICBjb25zdCBjdXN0b21TdG9yYWdlID0gbmV3IFN0b3JhZ2VNYW5hZ2VyKG9wZnNEaXIpOwogICAgY29uc3Qgb3Bmc05hdmlnYXRvciA9IHsKICAgICAgc3RvcmFnZTogewogICAgICAgIGdldERpcmVjdG9yeTogKCkgPT4gY3VzdG9tU3RvcmFnZS5nZXREaXJlY3RvcnkoKQogICAgICB9CiAgICB9OwogICAgaWYgKHR5cGVvZiBnbG9iYWxUaGlzLm5hdmlnYXRvciA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgZ2xvYmFsVGhpcy5uYXZpZ2F0b3IgPSBvcGZzTmF2aWdhdG9yOwogICAgfSBlbHNlIHsKICAgICAgZ2xvYmFsVGhpcy5uYXZpZ2F0b3Iuc3RvcmFnZSA9IG9wZnNOYXZpZ2F0b3Iuc3RvcmFnZTsKICAgIH0KICB9KS5jYXRjaCgoKSA9PiB7CiAgfSk7Cn0KZnVuY3Rpb24gY3JlYXRlU2VydmVyKHBvc3QpIHsKICBpZiAoIXNlcnZlcikgewogICAgc2VydmVyID0gbmV3IFNlcnZlcih7fSwgcG9zdCk7CiAgfQogIHJldHVybiBzZXJ2ZXI7Cn0KYXN5bmMgZnVuY3Rpb24gaGFuZGxlTWVzc2FnZShtZXNzYWdlLCBwb3N0KSB7CiAgaWYgKCFtZXNzYWdlIHx8IG1lc3NhZ2UudHlwZSAhPT0gInJlcXVlc3QiKSByZXR1cm47CiAgaWYgKGluaXRQcm9taXNlKSB7CiAgICBhd2FpdCBpbml0UHJvbWlzZTsKICB9CiAgY29uc3QgeyBpZCwgcGF5bG9hZCB9ID0gbWVzc2FnZTsKICBjb25zdCBkZXNlcmlhbGl6ZWRQYXlsb2FkID0gZGVzZXJpYWxpemVQYXlsb2FkKHBheWxvYWQpOwogIGNvbnN0IHNydiA9IGNyZWF0ZVNlcnZlcihwb3N0KTsKICB0cnkgewogICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc3J2LmRpc3BhdGNoKGRlc2VyaWFsaXplZFBheWxvYWQpOwogICAgY29uc3Qgc2VyaWFsaXplZFJlc3VsdCA9IHNlcmlhbGl6ZVBheWxvYWQocmVzdWx0KTsKICAgIHBvc3QoeyB0eXBlOiAicmVzcG9uc2UiLCBpZCwgc3VjY2VzczogdHJ1ZSwgcmVzdWx0OiBzZXJpYWxpemVkUmVzdWx0IH0pOwogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICBwb3N0KHsKICAgICAgdHlwZTogInJlc3BvbnNlIiwKICAgICAgaWQsCiAgICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgICBlcnJvcjogewogICAgICAgIG5hbWU6IGVycm9yPy5uYW1lLAogICAgICAgIG1lc3NhZ2U6IGVycm9yPy5tZXNzYWdlLAogICAgICAgIHN0YWNrOiBlcnJvcj8uc3RhY2sKICAgICAgfQogICAgfSk7CiAgfQp9CmFzeW5jIGZ1bmN0aW9uIGluaXRpYWxpemVXb3JrZXIoKSB7CiAgaWYgKGlzTm9kZSkgewogICAgY29uc3QgeyBwYXJlbnRQb3J0IH0gPSBhd2FpdCBpbXBvcnQoIndvcmtlcl90aHJlYWRzIik7CiAgICBjb25zdCBwb3N0ID0gKHJlc3ApID0+IHBhcmVudFBvcnQucG9zdE1lc3NhZ2UocmVzcCk7CiAgICBwYXJlbnRQb3J0Lm9uKCJtZXNzYWdlIiwgKG1zZykgPT4gaGFuZGxlTWVzc2FnZShtc2csIHBvc3QpKTsKICB9IGVsc2UgewogICAgY29uc3QgcG9zdCA9IChyZXNwKSA9PiBzZWxmLnBvc3RNZXNzYWdlKHJlc3ApOwogICAgc2VsZi5vbm1lc3NhZ2UgPSAoZXZlbnQpID0+IGhhbmRsZU1lc3NhZ2UoZXZlbnQuZGF0YSwgcG9zdCk7CiAgfQp9CmluaXRpYWxpemVXb3JrZXIoKS5jYXRjaCgoZXJyKSA9PiB7CiAgY29uc29sZS5lcnJvcigiV29ya2VyIGluaXRpYWxpemF0aW9uIGZhaWxlZDoiLCBlcnIpOwogIGlmICh0eXBlb2YgcHJvY2VzcyAhPT0gInVuZGVmaW5lZCIpIHsKICAgIHByb2Nlc3MuZXhpdCgxKTsKICB9IGVsc2UgewogICAgc2VsZi5wb3N0TWVzc2FnZSh7IHR5cGU6ICJlcnJvciIsIGVycm9yOiBlcnIubWVzc2FnZSB9KTsKICB9Cn0pOwovLyMgc291cmNlTWFwcGluZ1VSTD1taWNyby1tb25nby1zZXJ2ZXItd29ya2VyLmpzLm1hcAo=",import.meta.url))}const Z=new g(A,{workerData:I.workerData});return new xI(Z)}sendRequest(I,g={}){const C=this._nextId++,A=vI(I),Z={type:"request",id:C,payload:A};return new Promise((I,A)=>{let l;g.timeout&&(l=setTimeout(()=>{this._pending.delete(C),A(new Error(`Worker request timed out after ${g.timeout}ms`))},g.timeout)),this._pending.set(C,{resolve:I,reject:A,timeoutHandle:l}),this._post(Z)})}async terminate(){this._terminating=!0;for(const[I,g]of this._pending.entries())clearTimeout(g.timeoutHandle);this._pending.clear(),await this._terminateImpl()}_handleMessage(I){const g=I?.data??I;if(g){if("response"===g.type){const I=this._pending.get(g.id);if(!I)return;if(this._pending.delete(g.id),clearTimeout(I.timeoutHandle),g.success){const C=zI(g.result);I.resolve(C)}else{const C=new Error(g.error?.message||"Worker error");g.error?.name&&(C.name=g.error.name),g.error?.stack&&(C.stack=g.error.stack),g.error?.code&&(C.code=g.error.code),I.reject(C)}return}if("event"===g.type){const I=zI(g.payload);this.emit("event",g.event,I)}}}_handleError(I){if(!this._terminating){for(const[g,C]of this._pending.entries())clearTimeout(C.timeoutHandle),C.reject(I);this._pending.clear(),this.emit("error",I)}}_attach(){throw new Error("Not implemented")}_post(){throw new Error("Not implemented")}_terminateImpl(){throw new Error("Not implemented")}}class QI extends rI{constructor(I={}){const g=globalThis.Worker;if(!g)throw new Error("Worker API is not available in this environment");super(new g(I.workerUrl||"/build/micro-mongo-server-worker.js",{type:"module"}))}_attach(){this.worker.onmessage=this._handleMessage,this.worker.onerror=this._handleError}_post(I){this.worker.postMessage(I)}_terminateImpl(){this.worker.terminate()}}class xI extends rI{constructor(I){super(I)}_attach(){this.worker.on("message",this._handleMessage),this.worker.on("error",this._handleError),this.worker.on("exit",I=>{0===I||this._terminating||this._handleError(new Error(`Worker stopped with exit code ${I}`))})}_post(I){this.worker.postMessage(I)}_terminateImpl(){return this.worker.terminate()}}const UI=/* @__PURE__ */Object.freeze(/* @__PURE__ */Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));export{u as BadValueError,H as BulkWriteError,W as CannotCreateIndexError,kI as ChangeStream,h as CursorError,y as CursorNotFoundError,c as DuplicateKeyError,A as ErrorCodes,i as IndexError,B as IndexExistsError,m as IndexNotFoundError,Y as InvalidNamespaceError,S as MongoClient,G as MongoDriverError,Z as MongoError,R as MongoNetworkError,l as MongoServerError,X as NamespaceError,s as NamespaceNotFoundError,K as NotImplementedError,N as ObjectId,a as OperationNotSupportedError,o as QueryError,V as TypeMismatchError,d as ValidationError,rI as WorkerBridge,b as WriteError};
//# sourceMappingURL=micro-mongo-client.min.js.map
