var I,g={exports:{}};var C=function(){if(I)return g.exports;I=1;var C,A="object"==typeof Reflect?Reflect:null,l=A&&"function"==typeof A.apply?A.apply:function(I,g,C){return Function.prototype.apply.call(I,g,C)};C=A&&"function"==typeof A.ownKeys?A.ownKeys:Object.getOwnPropertySymbols?function(I){return Object.getOwnPropertyNames(I).concat(Object.getOwnPropertySymbols(I))}:function(I){return Object.getOwnPropertyNames(I)};var Z=Number.isNaN||function(I){return I!=I};function G(){G.init.call(this)}g.exports=G,g.exports.once=function(I,g){return new Promise(function(C,A){function l(C){I.removeListener(g,Z),A(C)}function Z(){"function"==typeof I.removeListener&&I.removeListener("error",l),C([].slice.call(arguments))}X(I,g,Z,{once:!0}),"error"!==g&&function(I,g,C){"function"==typeof I.on&&X(I,"error",g,C)}(I,l,{once:!0})})},G.EventEmitter=G,G.prototype._events=void 0,G.prototype._eventsCount=0,G.prototype._maxListeners=void 0;var b=10;function c(I){if("function"!=typeof I)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof I)}function d(I){return void 0===I._maxListeners?G.defaultMaxListeners:I._maxListeners}function i(I,g,C,A){var l,Z,G,b;if(c(C),void 0===(Z=I._events)?(Z=I._events=/* @__PURE__ */Object.create(null),I._eventsCount=0):(void 0!==Z.newListener&&(I.emit("newListener",g,C.listener?C.listener:C),Z=I._events),G=Z[g]),void 0===G)G=Z[g]=C,++I._eventsCount;else if("function"==typeof G?G=Z[g]=A?[C,G]:[G,C]:A?G.unshift(C):G.push(C),(l=d(I))>0&&G.length>l&&!G.warned){G.warned=!0;var i=new Error("Possible EventEmitter memory leak detected. "+G.length+" "+String(g)+" listeners added. Use emitter.setMaxListeners() to increase limit");i.name="MaxListenersExceededWarning",i.emitter=I,i.type=g,i.count=G.length,b=i,console&&console.warn&&console.warn(b)}return I}function m(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function B(I,g,C){var A={fired:!1,wrapFn:void 0,target:I,type:g,listener:C},l=m.bind(A);return l.listener=C,A.wrapFn=l,l}function W(I,g,C){var A=I._events;if(void 0===A)return[];var l=A[g];return void 0===l?[]:"function"==typeof l?C?[l.listener||l]:[l]:C?function(I){for(var g=new Array(I.length),C=0;C<g.length;++C)g[C]=I[C].listener||I[C];return g}(l):o(l,l.length)}function V(I){var g=this._events;if(void 0!==g){var C=g[I];if("function"==typeof C)return 1;if(void 0!==C)return C.length}return 0}function o(I,g){for(var C=new Array(g),A=0;A<g;++A)C[A]=I[A];return C}function X(I,g,C,A){if("function"==typeof I.on)A.once?I.once(g,C):I.on(g,C);else{if("function"!=typeof I.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof I);I.addEventListener(g,function l(Z){A.once&&I.removeEventListener(g,l),C(Z)})}}return Object.defineProperty(G,"defaultMaxListeners",{enumerable:!0,get:function(){return b},set:function(I){if("number"!=typeof I||I<0||Z(I))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+I+".");b=I}}),G.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=/* @__PURE__ */Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},G.prototype.setMaxListeners=function(I){if("number"!=typeof I||I<0||Z(I))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+I+".");return this._maxListeners=I,this},G.prototype.getMaxListeners=function(){return d(this)},G.prototype.emit=function(I){for(var g=[],C=1;C<arguments.length;C++)g.push(arguments[C]);var A="error"===I,Z=this._events;if(void 0!==Z)A=A&&void 0===Z.error;else if(!A)return!1;if(A){var G;if(g.length>0&&(G=g[0]),G instanceof Error)throw G;var b=new Error("Unhandled error."+(G?" ("+G.message+")":""));throw b.context=G,b}var c=Z[I];if(void 0===c)return!1;if("function"==typeof c)l(c,this,g);else{var d=c.length,i=o(c,d);for(C=0;C<d;++C)l(i[C],this,g)}return!0},G.prototype.addListener=function(I,g){return i(this,I,g,!1)},G.prototype.on=G.prototype.addListener,G.prototype.prependListener=function(I,g){return i(this,I,g,!0)},G.prototype.once=function(I,g){return c(g),this.on(I,B(this,I,g)),this},G.prototype.prependOnceListener=function(I,g){return c(g),this.prependListener(I,B(this,I,g)),this},G.prototype.removeListener=function(I,g){var C,A,l,Z,G;if(c(g),void 0===(A=this._events))return this;if(void 0===(C=A[I]))return this;if(C===g||C.listener===g)0===--this._eventsCount?this._events=/* @__PURE__ */Object.create(null):(delete A[I],A.removeListener&&this.emit("removeListener",I,C.listener||g));else if("function"!=typeof C){for(l=-1,Z=C.length-1;Z>=0;Z--)if(C[Z]===g||C[Z].listener===g){G=C[Z].listener,l=Z;break}if(l<0)return this;0===l?C.shift():function(I,g){for(;g+1<I.length;g++)I[g]=I[g+1];I.pop()}(C,l),1===C.length&&(A[I]=C[0]),void 0!==A.removeListener&&this.emit("removeListener",I,G||g)}return this},G.prototype.off=G.prototype.removeListener,G.prototype.removeAllListeners=function(I){var g,C,A;if(void 0===(C=this._events))return this;if(void 0===C.removeListener)return 0===arguments.length?(this._events=/* @__PURE__ */Object.create(null),this._eventsCount=0):void 0!==C[I]&&(0===--this._eventsCount?this._events=/* @__PURE__ */Object.create(null):delete C[I]),this;if(0===arguments.length){var l,Z=Object.keys(C);for(A=0;A<Z.length;++A)"removeListener"!==(l=Z[A])&&this.removeAllListeners(l);return this.removeAllListeners("removeListener"),this._events=/* @__PURE__ */Object.create(null),this._eventsCount=0,this}if("function"==typeof(g=C[I]))this.removeListener(I,g);else if(void 0!==g)for(A=g.length-1;A>=0;A--)this.removeListener(I,g[A]);return this},G.prototype.listeners=function(I){return W(this,I,!0)},G.prototype.rawListeners=function(I){return W(this,I,!1)},G.listenerCount=function(I,g){return"function"==typeof I.listenerCount?I.listenerCount(g):V.call(I,g)},G.prototype.listenerCount=V,G.prototype.eventNames=function(){return this._eventsCount>0?C(this._events):[]},g.exports}();const A={OK:0,INTERNAL_ERROR:1,BAD_VALUE:2,NO_SUCH_KEY:4,GRAPH_CONTAINS_CYCLE:5,HOST_UNREACHABLE:6,HOST_NOT_FOUND:7,UNKNOWN_ERROR:8,FAILED_TO_PARSE:17287,CANNOT_MUTATE_OBJECT:10,USER_NOT_FOUND:11,UNSUPPORTED_FORMAT:12,UNAUTHORIZED:13,TYPE_MISMATCH:14,OVERFLOW:15,INVALID_LENGTH:16,PROTOCOL_ERROR:17,AUTHENTICATION_FAILED:18,ILLEGAL_OPERATION:20,NAMESPACE_NOT_FOUND:26,INDEX_NOT_FOUND:27,PATH_NOT_VIABLE:28,CANNOT_CREATE_INDEX:67,INDEX_ALREADY_EXISTS:68,INDEX_EXISTS:68,COMMAND_NOT_FOUND:59,NAMESPACE_EXISTS:48,INVALID_NAMESPACE:73,INDEX_OPTIONS_CONFLICT:85,INVALID_INDEX_SPECIFICATION_OPTION:197,WRITE_CONFLICT:112,DUPLICATE_KEY:11e3,DUPLICATE_KEY_UPDATE:11001,DOCUMENT_VALIDATION_FAILURE:121,BAD_QUERY:2,CANNOT_INDEX_PARALLEL_ARRAYS:171,CURSOR_NOT_FOUND:43,COLLECTION_IS_EMPTY:26,CANNOT_DO_EXCLUSION_ON_FIELD_ID_IN_INCLUSION_PROJECTION:31254,NOT_IMPLEMENTED:999,OPERATION_NOT_SUPPORTED:998};class l extends Error{constructor(I,g={}){super(I),this.name="MongoError",this.code=g.code||A.UNKNOWN_ERROR,this.codeName=this._getCodeName(this.code),this.$err=I,g.collection&&(this.collection=g.collection),g.database&&(this.database=g.database),g.operation&&(this.operation=g.operation),g.query&&(this.query=g.query),g.document&&(this.document=g.document),g.field&&(this.field=g.field),g.index&&(this.index=g.index),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}_getCodeName(I){return{0:"OK",1:"InternalError",2:"BadValue",4:"NoSuchKey",5:"GraphContainsCycle",6:"HostUnreachable",7:"HostNotFound",8:"UnknownError",10:"CannotMutateObject",11:"UserNotFound",12:"UnsupportedFormat",13:"Unauthorized",14:"TypeMismatch",15:"Overflow",16:"InvalidLength",17:"ProtocolError",18:"AuthenticationFailed",20:"IllegalOperation",26:"NamespaceNotFound",27:"IndexNotFound",28:"PathNotViable",43:"CursorNotFound",48:"NamespaceExists",59:"CommandNotFound",67:"CannotCreateIndex",68:"IndexExists",73:"InvalidNamespace",85:"IndexOptionsConflict",112:"WriteConflict",121:"DocumentValidationFailure",171:"CannotIndexParallelArrays",197:"InvalidIndexSpecificationOption",998:"OperationNotSupported",999:"NotImplemented",11e3:"DuplicateKey",11001:"DuplicateKeyUpdate",17287:"FailedToParse"}[I]||"UnknownError"}toJSON(){const I={name:this.name,message:this.message,code:this.code,codeName:this.codeName};return this.collection&&(I.collection=this.collection),this.database&&(I.database=this.database),this.operation&&(I.operation=this.operation),this.index&&(I.index=this.index),this.indexName&&(I.indexName=this.indexName),this.field&&(I.field=this.field),this.query&&(I.query=this.query),this.document&&(I.document=this.document),this.namespace&&(I.namespace=this.namespace),this.cursorId&&(I.cursorId=this.cursorId),this.feature&&(I.feature=this.feature),this.keyPattern&&(I.keyPattern=this.keyPattern),this.keyValue&&(I.keyValue=this.keyValue),this.writeErrors&&(I.writeErrors=this.writeErrors),I}}class Z extends l{constructor(I,g={}){super(I,g),this.name="MongoServerError"}}class G extends l{constructor(I,g={}){super(I,g),this.name="MongoDriverError",this.code=g.code||A.INTERNAL_ERROR}}class b extends l{constructor(I,g={}){super(I,g),this.name="WriteError",this.code=g.code||A.WRITE_CONFLICT}}class c extends b{constructor(I,g={}){const C=JSON.stringify(I);super(`E11000 duplicate key error${g.collection?` collection: ${g.collection}`:""} index: ${C} dup key: ${C}`,{...g,code:A.DUPLICATE_KEY}),this.name="DuplicateKeyError",this.keyPattern=I,this.keyValue=g.keyValue||I}}class d extends l{constructor(I,g={}){super(I,g),this.name="ValidationError",this.code=g.code||A.DOCUMENT_VALIDATION_FAILURE,this.validationErrors=g.validationErrors||[]}}class i extends l{constructor(I,g={}){super(I,g),this.name="IndexError"}}class m extends i{constructor(I,g={}){super(`Index with name '${I}' already exists`,{...g,code:A.INDEX_EXISTS}),this.name="IndexExistsError",this.indexName=I}}class B extends i{constructor(I,g={}){super(`Index '${I}' not found`,{...g,code:A.INDEX_NOT_FOUND,index:I}),this.name="IndexNotFoundError",this.indexName=I}}class W extends i{constructor(I,g={}){super(`Cannot create index: ${I}`,{...g,code:A.CANNOT_CREATE_INDEX}),this.name="CannotCreateIndexError"}}class V extends l{constructor(I,g={}){super(I,g),this.name="QueryError",this.code=g.code||A.BAD_QUERY}}class o extends l{constructor(I,g,C,l={}){super(`Type mismatch for field '${I}': expected ${g}, got ${C}`,{...l,code:A.TYPE_MISMATCH,field:I}),this.name="TypeMismatchError",this.expectedType=g,this.actualType=C}}class X extends l{constructor(I,g={}){super(I,g),this.name="NamespaceError"}}class s extends X{constructor(I,g={}){super(`Namespace '${I}' not found`,{...g,code:A.NAMESPACE_NOT_FOUND}),this.name="NamespaceNotFoundError",this.namespace=I}}class h extends X{constructor(I,g,C={}){"object"!=typeof g||C||(C=g,g=void 0);super(g?`Invalid namespace '${I}': ${g}`:`Invalid namespace '${I}'`,{...C,code:A.INVALID_NAMESPACE}),this.name="InvalidNamespaceError",this.namespace=I}}class Y extends l{constructor(I,g={}){super(I,g),this.name="CursorError"}}class y extends Y{constructor(I,g={}){super(`Cursor ${I} not found`,{...g,code:A.CURSOR_NOT_FOUND}),this.name="CursorNotFoundError",this.cursorId=I}}class K extends l{constructor(I,g={}){super(`${I} is not implemented in micro-mongo`,{...g,code:A.NOT_IMPLEMENTED}),this.name="NotImplementedError",this.feature=I}}class R extends l{constructor(I,g,C={}){"object"!=typeof g||C||(C=g,g=void 0);super(g?`Operation '${I}' is not supported: ${g}`:`Operation '${I}' is not supported`,{...C,code:A.OPERATION_NOT_SUPPORTED,operation:I}),this.name="OperationNotSupportedError"}}class u extends l{constructor(I,g,C,l={}){super(`Bad value for field '${I}': ${C}`,{...l,code:A.BAD_VALUE,field:I}),this.name="BadValueError",this.value=g}}class a extends l{constructor(I=[],g={}){super(`Bulk write operation error: ${I.length} error(s)`,g),this.name="BulkWriteError",this.writeErrors=I,this.code=g.code||A.WRITE_CONFLICT}}class H extends l{constructor(I,g={}){super(I,g),this.name="MongoNetworkError",this.code=g.code||A.HOST_UNREACHABLE}}class n extends C.EventEmitter{static create({bridge:I,database:g,collection:C,streamId:A,pipeline:l=[],options:Z={}}){const G=new n({bridge:I,streamId:A});if(!A){let A,b;null==g?(A="client",b="watch"):null==C?(A="db",b="watch"):(A="collection",b="watch"),I.sendRequest({target:A,database:g,collection:C,method:b,args:[l,Z]}).then(I=>{I&&I.streamId&&(G.streamId=I.streamId)}).catch(()=>{})}return G}constructor({bridge:I,streamId:g}){super(),this.bridge=I,this.streamId=g,this.closed=!1,this._pendingNext=[],this._onEvent=this._onEvent.bind(this),this.bridge.on("event",this._onEvent)}_onEvent(I,g){if("changeStream"!==I)return;if(!g||g.streamId!==this.streamId)return;const{type:C,data:A}=g;"change"===C&&this.emit("change",A),"error"===C&&this.emit("error",A),"close"===C&&(this.emit("close"),this._cleanup())}_cleanup(){this.bridge.off("event",this._onEvent)}async close(){if(!this.closed){this.closed=!0;for(const I of this._pendingNext)I.resolve(null);this._pendingNext=[],this.bridge.sendRequest({target:"changestream",streamId:this.streamId,method:"close"}).catch(()=>{}),this.emit("close"),this._cleanup()}}async next(){return this.closed?null:new Promise((I,g)=>{const C=g=>{this._removePending(Z),this.off("change",C),this.off("error",A),this.off("close",l),I(g)},A=I=>{this._removePending(Z),this.off("change",C),this.off("error",A),this.off("close",l),g(I)},l=()=>{this._removePending(Z),this.off("change",C),this.off("error",A),this.off("close",l),I(null)},Z={resolve:I,reject:g};this._pendingNext.push(Z),this.on("change",C),this.on("error",A),this.on("close",l)})}_removePending(I){const g=this._pendingNext.indexOf(I);-1!==g&&this._pendingNext.splice(g,1)}async*[Symbol.asyncIterator](){for(;!this.closed;){const I=await this.next();if(null===I)break;yield I}}}class p{constructor({bridge:I,cursorId:g,batch:C=[],exhausted:A=!1,batchSize:l=100,requestPromise:Z,requestPayload:G}){this.bridge=I,this.cursorId=g,this.buffer=Array.isArray(C)?C:[],this.exhausted=A||!1,this._batchSize=l,this._requestPromise=Z||null,this._requestPayload=G||null,this._initialized=!Z&&!G}async _ensureInitialized(){if(!this._initialized)if(this._requestPayload){const I={};void 0!==this._limit&&(I.limit=this._limit),void 0!==this._skip&&(I.skip=this._skip),void 0!==this._sort&&(I.sort=this._sort),void 0!==this._min&&(I.min=this._min),void 0!==this._max&&(I.max=this._max),void 0!==this._hint&&(I.hint=this._hint),void 0!==this._comment&&(I.comment=this._comment),void 0!==this._maxTimeMS&&(I.maxTimeMS=this._maxTimeMS),void 0!==this._maxScan&&(I.maxScan=this._maxScan),void 0!==this._returnKey&&(I.returnKey=this._returnKey),void 0!==this._showRecordId&&(I.showRecordId=this._showRecordId),void 0!==this._collation&&(I.collation=this._collation),this._requestPayload.cursorOpts=I;const g=await this.bridge.sendRequest(this._requestPayload);this.cursorId=g.cursorId,this.buffer=g.batch||[],this.exhausted=g.exhausted||!1,this._batchSize=g.batchSize||100,this._requestPayload=null,this._initialized=!0}else if(this._requestPromise){const I=await this._requestPromise;this.cursorId=I.cursorId,this.buffer=I.batch||[],this.exhausted=I.exhausted||!1,this._batchSize=I.batchSize||100,this._requestPromise=null,this._initialized=!0}}async hasNext(){return!this._closed&&(await this._ensureInitialized(),this.buffer.length>0||!this.exhausted&&(await this._getMore(),this.buffer.length>0))}async next(){return await this.hasNext()?this.buffer.shift():null}async toArray(){await this._ensureInitialized();const I=[...this.buffer];for(this.buffer=[];!this.exhausted;)await this._getMore(),I.push(...this.buffer),this.buffer=[];return I}async count(){return(await this.toArray()).length}limit(I){return this._limit=I,this}skip(I){return this._skip=I,this}sort(I){return this._sort=I,this}batchSize(I){return this._batchSize=I,this}async close(){return this._closed=!0,await this._closeRemote(),!1}isClosed(){return this._closed||!1}comment(I){return this._comment=I,this}hint(I){return this._hint=I,this}explain(I="queryPlanner"){const g={queryPlanner:{plannerVersion:1,namespace:"unknown",indexFilterSet:!1,parsedQuery:{},winningPlan:{stage:"COLLSCAN"}},ok:1};return"executionStats"!==I&&"allPlansExecution"!==I||(g.executionStats={executionSuccess:!0,nReturned:0,executionTimeMillis:0}),g}async itcount(){let I=0;for(;await this.hasNext();)await this.next(),I++;return I}size(){return this.buffer.length}min(I){return this._min=I,this._minIndexBounds=I,this}max(I){return this._max=I,this._maxIndexBounds=I,this}maxTimeMS(I){return this._maxTimeMS=I,this}maxScan(I){return this._maxScan=I,this}noCursorTimeout(){return this._noCursorTimeout=!0,this}objsLeftInBatch(){return this.buffer.length}pretty(){return this._pretty=!0,this}readConcern(I){return this._readConcern=I,this}readPref(I,g){return this._readPref={mode:I,tagSet:g},this}returnKey(I=!0){return this._returnKey=I,this}showRecordId(I=!0){return this._showRecordId=I,this}allowDiskUse(I=!0){return this._allowDiskUse=I,this}collation(I){return this._collation=I,this}async forEach(I){for(;await this.hasNext();){const g=await this.next();await I(g)}}async map(I){const g=[];for(;await this.hasNext();){const C=await this.next();g.push(await I(C))}return g}async*[Symbol.asyncIterator](){for(;await this.hasNext();)yield await this.next()}async _getMore(){if(this.exhausted)return;const I=await this.bridge.sendRequest({target:"cursor",cursorId:this.cursorId,method:"getMore",args:[{batchSize:this._batchSize}]});this.buffer=I?.batch||[],this.exhausted=!!I?.exhausted,this.exhausted&&await this._closeRemote()}async _closeRemote(){if(this.cursorId){try{await this.bridge.sendRequest({target:"cursor",cursorId:this.cursorId,method:"close"})}catch(I){}this.cursorId=null}}}class e{constructor({dbName:I,name:g,bridge:C,db:A}){return this.dbName=I,this.name=g,this.bridge=C,this._db=A,this.indexes=[],new Proxy(this,{get:(I,g,C)=>g in I?Reflect.get(I,g,C):"symbol"==typeof g||String(g).startsWith("_")?void 0:"watch"===g?(...g)=>I._watch(...g):"find"===g||"aggregate"===g?(...C)=>I._cursorMethod(String(g),C):(...C)=>I._call(String(g),C)})}_cursorMethod(I,g=[]){"find"===I&&g.length>=2&&this._validateProjection(g[1]);const C={target:"collection",database:this.dbName,collection:this.name,method:I,args:g},A=new p({bridge:this.bridge,requestPayload:C});return"aggregate"===I&&(A.then=function(I,g){return this.toArray().then(I,g)}),A}_validateProjection(I){if(!I||0===Object.keys(I).length)return;const g=Object.keys(I);let C=!1,l=!1;for(const A of g)if("_id"!==A&&(I[A]?C=!0:l=!0,C&&l))break;if(C&&l)throw new V("Cannot do exclusion on field in inclusion projection",{code:A.CANNOT_DO_EXCLUSION_ON_FIELD_ID_IN_INCLUSION_PROJECTION,collection:this.name})}_call(I,g=[]){return this.bridge.sendRequest({target:"collection",database:this.dbName,collection:this.name,method:I,args:g}).then(C=>{if(C&&C.cursorId)return new p({bridge:this.bridge,cursorId:C.cursorId,batch:C.batch,exhausted:C.exhausted,batchSize:C.batchSize});if("copyTo"===I&&g.length>0&&this._db&&this._db.collection(g[0]),"createIndex"===I){const I=g[0],C=g[1]||{},A=C.name||Object.entries(I).map(([I,g])=>`${I}_${g}`).join("_");this.indexes.find(I=>I.name===A)||this.indexes.push({name:A,key:I,...C})}if("dropIndex"===I){const I=g[0];this.indexes=this.indexes.filter(g=>g.name!==I)}return"dropIndexes"===I&&(this.indexes=[]),"drop"===I&&(this.indexes=[]),C})}getIndexes(){return this.indexes}_watch(I=[],g={}){return n.create({bridge:this.bridge,database:this.dbName,collection:this.name,pipeline:I,options:g})}}class t{constructor({dbName:I,bridge:g,options:C={}}){this.dbName=I,this.bridge=g,this.options=C,this.collections=/* @__PURE__ */new Map;const A=/* @__PURE__ */new Set(["getCollectionNames","getCollectionInfos","createCollection","dropCollection","dropDatabase","collection","getCollection","watch"]);return this._methodNames=A,new Proxy(this,{get:(I,g,C)=>g in I?Reflect.get(I,g,C):"symbol"==typeof g||String(g).startsWith("_")?void 0:A.has(g)?"createCollection"===g?(...A)=>{const l=A[0];return I.collection(l,C),I._call(String(g),A)}:"dropCollection"===g?(...C)=>{const A=C[0];return I.collections.delete(A),I._call(String(g),C)}:"dropDatabase"===g?(...C)=>(I.collections.clear(),I._call(String(g),C)):"watch"===g?(...g)=>I._watch(...g):(...C)=>I._call(String(g),C):I.collection(g,C)})}collection(I,g){if(this.collections.has(I))return this.collections.get(I);const C=new e({dbName:this.dbName,name:I,bridge:this.bridge,db:g||this});return this.collections.set(I,C),C}getCollectionNames(){return Array.from(this.collections.keys())}async close(){}_call(I,g=[]){return this.bridge.sendRequest({target:"db",database:this.dbName,method:I,args:g}).then(I=>I&&I.streamId?n.create({bridge:this.bridge,database:this.dbName,collection:null,streamId:I.streamId}):I)}_watch(I=[],g={}){return n.create({bridge:this.bridge,database:this.dbName,collection:null,pipeline:I,options:g})}}class N extends C.EventEmitter{constructor(I="mongodb://localhost:27017",g={}){if(super(),this.uri=I,this.options=Object.freeze({...g}),this._isConnected=!1,this._defaultDb=this._parseDefaultDbName(I),this._databases=/* @__PURE__ */new Map,!g.workerBridge)throw new Error("workerBridge is required. Create one with: const bridge = await WorkerBridge.create()");this._bridge=g.workerBridge,this._ownsBridge=!1}static async connect(I,g={}){const C=new N(I,g);return await C.connect(),C}async connect(){return this._isConnected||(this._isConnected=!0,this.emit("open",this)),this}db(I,g={}){const C=I||this._defaultDb;if(!C)throw new Error("No database name provided and no default in connection string");if(this._databases.has(C))return this._databases.get(C);const A=new t({dbName:C,bridge:this._bridge,options:{...this.options,...g}});return this._databases.set(C,A),A}async close(){this._bridge&&this._ownsBridge&&(await this._bridge.terminate(),this._bridge=null),this._isConnected=!1,this.emit("close")}async close(I=!1){if(this._isConnected){for(const[I,g]of this._databases)await g.close();this._databases.clear(),this._isConnected=!1,this.emit("close")}}startSession(I={}){return{id:crypto.randomUUID(),endSession:()=>{},withTransaction:async I=>await I(this)}}async withSession(I,g){const C=this.startSession("function"==typeof I?{}:I),A="function"==typeof I?I:g;try{return await A(C)}finally{C.endSession()}}get readConcern(){return this.options.readConcern}get writeConcern(){return this.options.writeConcern}get readPreference(){return this.options.readPreference}watch(I=[],g={}){return n.create({bridge:this._bridge,database:null,collection:null,pipeline:I,options:g})}_parseDefaultDbName(I){const g=I.match(/\/([^/?]+)/);return g?g[1]:null}_parseUriParams(I){const g={},C=I.indexOf("?");if(-1===C)return g;const A=I.substring(C+1).split("&");for(const l of A){const[I,C]=l.split("=");I&&("true"===C?g[I]=!0:"false"===C?g[I]=!1:isNaN(C)?g[I]=decodeURIComponent(C||""):g[I]=Number(C))}return g}}class F{constructor(I){if(null==I)this.id=F.generate();else if("string"==typeof I){if(!F.isValid(I))throw new Error(`Argument passed in must be a string of 24 hex characters, got: ${I}`);this.id=I.toLowerCase()}else if(I instanceof Uint8Array&&12===I.length)this.id=Array.from(I).map(I=>I.toString(16).padStart(2,"0")).join("");else{if(!(I instanceof F))throw new Error("Argument passed in must be a string of 24 hex characters or an ObjectId");this.id=I.id}}toString(){return this.id}toHexString(){return this.id}getTimestamp(){const I=parseInt(this.id.substring(0,8),16);return new Date(1e3*I)}equals(I){if(!(I instanceof F))throw new Error("Can only compare with another ObjectId");return this.id===I.id}compare(I){if(!(I instanceof F))throw new Error("Can only compare with another ObjectId");return this.id.localeCompare(I.id)}toJSON(){return this.id}inspect(){return`ObjectId("${this.id}")`}toBytes(){const I=new Uint8Array(12);for(let g=0;g<12;g++)I[g]=parseInt(this.id.substring(2*g,2*g+2),16);return I}static isValid(I){return!!I&&("string"==typeof I&&(24===I.length&&/^[0-9a-fA-F]{24}$/.test(I)))}static createFromTime(I){const g=("00000000"+Math.floor(I/1e3).toString(16)).slice(-8);return new F(g+"0000000000000000")}static generate(){const I=Math.floor(Date.now()/1e3),g="undefined"!=typeof crypto&&crypto.getRandomValues?new Uint8Array(8):null;let C="";if(g){crypto.getRandomValues(g);for(let I=0;I<g.length;I++)C+=("0"+g[I].toString(16)).slice(-2)}else C=Math.random().toString(16).slice(2).padEnd(8,"0").slice(0,8)+Math.random().toString(16).slice(2).padEnd(8,"0").slice(0,8);return(("00000000"+I.toString(16)).slice(-8)+C).slice(0,24)}}function S(I,g){return I instanceof F||g instanceof F?I instanceof F&&g instanceof F||I instanceof F&&"string"==typeof g?I.equals(g):g instanceof F&&"string"==typeof I&&g.equals(I):I==g}function J(I,g){for(var C=g.split("."),A=I[C[0]],l=1;l<C.length;l++){if(null==A||null==A)return A;var Z=C[l],G=parseInt(Z,10);A=w(A)&&!isNaN(G)&&G>=0&&G<A.length?A[G]:A[Z]}return A}function w(I){return Array==I.constructor}function k(I,g){for(var C=0;C<g.length;C++)if(S(g[C],I))return!0;return!1}function v(I,g){if(I.length!=g.length)return!1;for(var C=0;C<I.length;C++)if(!S(I[C],g[C])){if(typeof I[C]!=typeof g[C])return!1;if("object"==typeof I[C]&&null!==I[C]){if(w(I[C])){if(!v(I[C],g[C]))return!1}else if(!z(I[C],g[C]))return!1}else if(!S(I[C],g[C]))return!1}return!0}function z(I,g){for(var C in I)if(I.hasOwnProperty(C)){if(!g.hasOwnProperty(C))return!1;if(!S(I[C],g[C])){if(typeof I[C]!=typeof g[C])return!1;if("object"==typeof I[C]&&null!==I[C]){if(w(I[C])){if(!v(I[C],g[C]))return!1}else if(!z(I[C],g[C]))return!1}else if(!S(I[C],g[C]))return!1}}for(var C in g)if(g.hasOwnProperty(C)&&!I.hasOwnProperty(C))return!1;return!0}const r={ational:"ate",tional:"tion",enci:"ence",anci:"ance",izer:"ize",bli:"ble",alli:"al",entli:"ent",eli:"e",ousli:"ous",ization:"ize",ation:"ate",ator:"ate",alism:"al",iveness:"ive",fulness:"ful",ousness:"ous",aliti:"al",iviti:"ive",biliti:"ble",logi:"log"},Q={icate:"ic",ative:"",alize:"al",iciti:"ic",ical:"ic",ful:"",ness:""},x="[aeiouy]",U="([^aeiou][^aeiouy]*)",T="("+x+"[aeiou]*)",j=new RegExp("^"+U+"?"+T+U),L=new RegExp("^"+U+"?"+T+U+T+"?$"),M=new RegExp("^"+U+"?("+T+U+"){2,}"),D=new RegExp("^"+U+"?"+x),f=new RegExp("^"+U+x+"[^aeiouwxy]$"),O=/ll$/,P=/^(.+?)e$/,E=/^(.+?)y$/,q=/^(.+?(s|t))(ion)$/,_=/^(.+?)(ed|ing)$/,$=/(at|bl|iz)$/,II=/^(.+?)eed$/,gI=/^.+?[^s]s$/,CI=/^.+?(ss|i)es$/,AI=/([^aeiouylsz])\1$/,lI=/^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$/,ZI=/^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/,GI=/^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$/;const bI=/* @__PURE__ */new Set(["a","about","after","all","also","am","an","and","another","any","are","around","as","at","be","because","been","before","being","between","both","but","by","came","can","come","could","did","do","each","for","from","get","got","has","had","he","have","her","here","him","himself","his","how","i","if","in","into","is","it","like","make","many","me","might","more","most","much","must","my","never","now","of","on","only","or","other","our","out","over","said","same","see","should","since","some","still","such","take","than","that","the","their","them","then","there","these","they","this","those","through","to","too","under","up","very","was","way","we","well","were","what","where","which","while","who","with","would","you","your"]);function cI(I,g){if(null==I)return I;if("boolean"==typeof I||"number"==typeof I)return I;if("string"==typeof I)return I.startsWith("$$")?"$$KEEP"===I||"$$PRUNE"===I||"$$DESCEND"===I?I:J(g,I.substring(2)):"$"===I.charAt(0)?J(g,I.substring(1)):I;if("object"==typeof I){if(Array.isArray(I))return I.map(I=>cI(I,g));const C=Object.keys(I);if(0===C.length)return I;const A=C[0];if("$"===A.charAt(0)){return function(I,g,C){switch(I){case"$add":return function(I,g){if(!Array.isArray(I))return null;let C=0;for(const A of I){const I=cI(A,g);I instanceof Date?C+=I.getTime():"number"==typeof I&&(C+=I)}return C}(g,C);case"$subtract":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=cI(I[0],g),A=cI(I[1],g);if(C instanceof Date&&A instanceof Date)return C.getTime()-A.getTime();if(C instanceof Date&&"number"==typeof A)return new Date(C.getTime()-A);if("number"==typeof C&&"number"==typeof A)return C-A;return null}(g,C);case"$multiply":return function(I,g){if(!Array.isArray(I))return null;let C=1;for(const A of I){const I=cI(A,g);"number"==typeof I&&(C*=I)}return C}(g,C);case"$divide":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=cI(I[0],g),A=cI(I[1],g);if("number"==typeof C&&"number"==typeof A&&0!==A)return C/A;return null}(g,C);case"$mod":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=cI(I[0],g),A=cI(I[1],g);if("number"==typeof C&&"number"==typeof A&&0!==A)return C%A;return null}(g,C);case"$pow":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=cI(I[0],g),A=cI(I[1],g);if("number"==typeof C&&"number"==typeof A)return Math.pow(C,A);return null}(g,C);case"$sqrt":return function(I,g){const C=cI(I,g);if("number"==typeof C&&C>=0)return Math.sqrt(C);return null}(g,C);case"$abs":return function(I,g){const C=cI(I,g);if("number"==typeof C)return Math.abs(C);return null}(g,C);case"$ceil":return function(I,g){const C=cI(I,g);if("number"==typeof C)return Math.ceil(C);return null}(g,C);case"$floor":return function(I,g){const C=cI(I,g);if("number"==typeof C)return Math.floor(C);return null}(g,C);case"$trunc":return function(I,g){const C=cI(I,g);if("number"==typeof C)return Math.trunc(C);return null}(g,C);case"$round":return function(I,g){const C=cI(Array.isArray(I)?I[0]:I,g),A=Array.isArray(I)&&void 0!==I[1]?cI(I[1],g):0;if("number"==typeof C&&"number"==typeof A){const I=Math.pow(10,A);return Math.round(C*I)/I}return null}(g,C);case"$concat":return function(I,g){if(!Array.isArray(I))return null;let C="";for(const A of I){const I=cI(A,g);null!=I&&(C+=String(I))}return C}(g,C);case"$substr":return function(I,g){if(!Array.isArray(I)||I.length<3)return null;const C=String(cI(I[0],g)||""),A=cI(I[1],g),l=cI(I[2],g);if("number"==typeof A&&"number"==typeof l)return C.substr(A,l);return null}(g,C);case"$toLower":return function(I,g){const C=cI(I,g);return null!=C?String(C).toLowerCase():""}(g,C);case"$toUpper":return function(I,g){const C=cI(I,g);return null!=C?String(C).toUpperCase():""}(g,C);case"$trim":return function(I,g){const C=cI("object"==typeof I&&I.input?I.input:I,g),A=I.chars?cI(I.chars,g):null;let l=null!=C?String(C):"";if(A){const I=new RegExp(`^[${dI(A)}]+|[${dI(A)}]+$`,"g");return l.replace(I,"")}return l.trim()}(g,C);case"$ltrim":return function(I,g){const C=cI("object"==typeof I&&I.input?I.input:I,g),A=I.chars?cI(I.chars,g):null;let l=null!=C?String(C):"";if(A){const I=new RegExp(`^[${dI(A)}]+`,"g");return l.replace(I,"")}return l.replace(/^\s+/,"")}(g,C);case"$rtrim":return function(I,g){const C=cI("object"==typeof I&&I.input?I.input:I,g),A=I.chars?cI(I.chars,g):null;let l=null!=C?String(C):"";if(A){const I=new RegExp(`[${dI(A)}]+$`,"g");return l.replace(I,"")}return l.replace(/\s+$/,"")}(g,C);case"$split":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=String(cI(I[0],g)||""),A=String(cI(I[1],g)||"");return C.split(A)}(g,C);case"$strLenCP":return function(I,g){const C=cI(I,g);return null!=C?String(C).length:0}(g,C);case"$strcasecmp":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=String(cI(I[0],g)||"").toLowerCase(),A=String(cI(I[1],g)||"").toLowerCase();return C<A?-1:C>A?1:0}(g,C);case"$indexOfCP":return function(I,g){if(!Array.isArray(I)||I.length<2)return null;const C=String(cI(I[0],g)||""),A=String(cI(I[1],g)||""),l=void 0!==I[2]?cI(I[2],g):0,Z=void 0!==I[3]?cI(I[3],g):C.length,G=C.substring(l,Z).indexOf(A);return-1===G?-1:G+l}(g,C);case"$replaceOne":return function(I,g){const C=String(cI(I.input,g)||""),A=String(cI(I.find,g)||""),l=String(cI(I.replacement,g)||"");return C.replace(A,l)}(g,C);case"$replaceAll":return function(I,g){const C=String(cI(I.input,g)||""),A=String(cI(I.find,g)||""),l=String(cI(I.replacement,g)||"");return C.split(A).join(l)}(g,C);case"$cmp":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=cI(I[0],g),A=cI(I[1],g);return C<A?-1:C>A?1:0}(g,C);case"$eq":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=cI(I[0],g),A=cI(I[1],g);return C===A}(g,C);case"$ne":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=cI(I[0],g),A=cI(I[1],g);return C!==A}(g,C);case"$gt":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=cI(I[0],g),A=cI(I[1],g);return C>A}(g,C);case"$gte":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=cI(I[0],g),A=cI(I[1],g);return C>=A}(g,C);case"$lt":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=cI(I[0],g),A=cI(I[1],g);return C<A}(g,C);case"$lte":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=cI(I[0],g),A=cI(I[1],g);return C<=A}(g,C);case"$and":return function(I,g){if(!Array.isArray(I))return null;for(const C of I){if(!cI(C,g))return!1}return!0}(g,C);case"$or":return function(I,g){if(!Array.isArray(I))return null;for(const C of I){if(cI(C,g))return!0}return!1}(g,C);case"$not":return function(I,g){const C=cI(Array.isArray(I)?I[0]:I,g);return!C}(g,C);case"$cond":return function(I,g){let C,A,l;if(Array.isArray(I)){if(3!==I.length)return null;[C,A,l]=I}else{if("object"!=typeof I)return null;C=I.if,A=I.then,l=I.else}const Z=cI(C,g);return cI(Z?A:l,g)}(g,C);case"$ifNull":return function(I,g){if(!Array.isArray(I)||I.length<2)return null;for(let C=0;C<I.length;C++){const A=cI(I[C],g);if(null!=A)return A}return null}(g,C);case"$switch":return function(I,g){if("object"!=typeof I||!Array.isArray(I.branches))return null;for(const C of I.branches){if(cI(C.case,g))return cI(C.then,g)}return void 0!==I.default?cI(I.default,g):null}(g,C);case"$year":return function(I,g){const C=cI(I,g);if(C instanceof Date)return C.getUTCFullYear();return null}(g,C);case"$month":return function(I,g){const C=cI(I,g);if(C instanceof Date)return C.getUTCMonth()+1;return null}(g,C);case"$dayOfMonth":return function(I,g){const C=cI(I,g);if(C instanceof Date)return C.getUTCDate();return null}(g,C);case"$dayOfWeek":return function(I,g){const C=cI(I,g);if(C instanceof Date)return C.getUTCDay()+1;return null}(g,C);case"$dayOfYear":return function(I,g){const C=cI(I,g);if(C instanceof Date){const I=new Date(Date.UTC(C.getUTCFullYear(),0,0)),g=C-I,A=864e5;return Math.floor(g/A)}return null}(g,C);case"$hour":return function(I,g){const C=cI(I,g);if(C instanceof Date)return C.getUTCHours();return null}(g,C);case"$minute":return function(I,g){const C=cI(I,g);if(C instanceof Date)return C.getUTCMinutes();return null}(g,C);case"$second":return function(I,g){const C=cI(I,g);if(C instanceof Date)return C.getUTCSeconds();return null}(g,C);case"$millisecond":return function(I,g){const C=cI(I,g);if(C instanceof Date)return C.getUTCMilliseconds();return null}(g,C);case"$week":return function(I,g){const C=cI(I,g);if(C instanceof Date){const I=new Date(Date.UTC(C.getUTCFullYear(),0,1));return Math.ceil(((C-I)/864e5+I.getUTCDay()+1)/7)-1}return null}(g,C);case"$isoWeek":return function(I,g){const C=cI(I,g);if(C instanceof Date){const I=new Date(C.valueOf()),g=(C.getUTCDay()+6)%7;I.setUTCDate(I.getUTCDate()-g+3);const A=I.valueOf();return I.setUTCMonth(0,1),4!==I.getUTCDay()&&I.setUTCMonth(0,1+(4-I.getUTCDay()+7)%7),1+Math.ceil((A-I)/6048e5)}return null}(g,C);case"$isoWeekYear":return function(I,g){const C=cI(I,g);if(C instanceof Date){const I=new Date(C.valueOf());return I.setUTCDate(I.getUTCDate()-(C.getUTCDay()+6)%7+3),I.getUTCFullYear()}return null}(g,C);case"$dateToString":return function(I,g){const C=I.format?cI(I.format,g):"%Y-%m-%dT%H:%M:%S.%LZ",A=cI(I.date,g);return A instanceof Date?C.replace("%Y",A.getUTCFullYear()).replace("%m",String(A.getUTCMonth()+1).padStart(2,"0")).replace("%d",String(A.getUTCDate()).padStart(2,"0")).replace("%H",String(A.getUTCHours()).padStart(2,"0")).replace("%M",String(A.getUTCMinutes()).padStart(2,"0")).replace("%S",String(A.getUTCSeconds()).padStart(2,"0")).replace("%L",String(A.getUTCMilliseconds()).padStart(3,"0")):null}(g,C);case"$toDate":return function(I,g){const C=cI(I,g);if(C instanceof Date)return C;if("string"==typeof C||"number"==typeof C){const I=new Date(C);return isNaN(I.getTime())?null:I}return null}(g,C);case"$arrayElemAt":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=cI(I[0],g),A=cI(I[1],g);if(!Array.isArray(C)||"number"!=typeof A)return null;const l=A<0?C.length+A:A;return C[l]}(g,C);case"$concatArrays":return function(I,g){if(!Array.isArray(I))return null;const C=[];for(const A of I){const I=cI(A,g);Array.isArray(I)&&C.push(...I)}return C}(g,C);case"$filter":return function(I,g){const C=cI(I.input,g),A=I.as||"this",l=I.cond;return Array.isArray(C)?C.filter(I=>{const C={...g,[A]:I};return cI(l,C)}):null}(g,C);case"$in":return function(I,g){if(!Array.isArray(I)||2!==I.length)return null;const C=cI(I[0],g),A=cI(I[1],g);return!!Array.isArray(A)&&A.includes(C)}(g,C);case"$indexOfArray":return function(I,g){if(!Array.isArray(I)||I.length<2)return null;const C=cI(I[0],g),A=cI(I[1],g),l=void 0!==I[2]?cI(I[2],g):0,Z=void 0!==I[3]?cI(I[3],g):C.length;if(!Array.isArray(C))return null;for(let G=l;G<Z&&G<C.length;G++)if(C[G]===A)return G;return-1}(g,C);case"$isArray":return function(I,g){const C=cI(I,g);return Array.isArray(C)}(g,C);case"$map":return function(I,g){const C=cI(I.input,g),A=I.as||"this",l=I.in;return Array.isArray(C)?C.map(I=>{const C={...g,[A]:I};return cI(l,C)}):null}(g,C);case"$reduce":return function(I,g){const C=cI(I.input,g),A=cI(I.initialValue,g),l=I.in;if(!Array.isArray(C))return null;let Z=A;for(const G of C){Z=cI(l,{...g,value:Z,this:G})}return Z}(g,C);case"$size":return function(I,g){const C=cI(I,g);return Array.isArray(C)?C.length:null}(g,C);case"$slice":return function(I,g){if(!Array.isArray(I)||I.length<2)return null;const C=cI(I[0],g);if(!Array.isArray(C))return null;if(2===I.length){const A=cI(I[1],g);return A>=0?C.slice(0,A):C.slice(A)}{const A=cI(I[1],g),l=cI(I[2],g);return C.slice(A,A+l)}}(g,C);case"$reverseArray":return function(I,g){const C=cI(I,g);return Array.isArray(C)?C.slice().reverse():null}(g,C);case"$zip":return function(I,g){const C=I.inputs?cI(I.inputs,g):null,A=I.useLongestLength||!1,l=I.defaults;if(!Array.isArray(C))return null;const Z=C.map(I=>cI(I,g));if(!Z.every(I=>Array.isArray(I)))return null;const G=Math.max(...Z.map(I=>I.length)),b=A?G:Math.min(...Z.map(I=>I.length)),c=[];for(let d=0;d<b;d++){const I=[];for(let g=0;g<Z.length;g++)d<Z[g].length?I.push(Z[g][d]):l&&g<l.length?I.push(l[g]):I.push(null);c.push(I)}return c}(g,C);case"$type":return function(I,g){const C=cI(I,g);return null===C?"null":void 0===C?"missing":"boolean"==typeof C?"bool":"number"==typeof C?Number.isInteger(C)?"int":"double":"string"==typeof C?"string":C instanceof Date?"date":Array.isArray(C)?"array":"object"==typeof C?"object":"unknown"}(g,C);case"$convert":return function(I,g){const C=cI(I.input,g),A=I.to,l=I.onError,Z=I.onNull;if(null===C)return void 0!==Z?cI(Z,g):null;try{switch(A){case"double":case"decimal":return parseFloat(C);case"int":case"long":return parseInt(C);case"bool":return Boolean(C);case"string":return String(C);case"date":return new Date(C);default:return C}}catch(G){return void 0!==l?cI(l,g):null}}(g,C);case"$toBool":return function(I,g){const C=cI(I,g);return Boolean(C)}(g,C);case"$toDecimal":return function(I,g){const C=cI(I,g);return parseFloat(C)}(g,C);case"$toDouble":return function(I,g){const C=cI(I,g);return parseFloat(C)}(g,C);case"$toInt":return function(I,g){const C=cI(I,g);return parseInt(C)}(g,C);case"$toLong":return function(I,g){const C=cI(I,g);return parseInt(C)}(g,C);case"$toString":return function(I,g){const C=cI(I,g);return null==C?null:String(C)}(g,C);case"$objectToArray":return function(I,g){const C=cI(I,g);if("object"!=typeof C||null===C||Array.isArray(C))return null;return Object.keys(C).map(I=>({k:I,v:C[I]}))}(g,C);case"$arrayToObject":return function(I,g){const C=cI(I,g);if(!Array.isArray(C))return null;const A={};for(const l of C)Array.isArray(l)&&2===l.length?A[l[0]]=l[1]:"object"==typeof l&&void 0!==l.k&&void 0!==l.v&&(A[l.k]=l.v);return A}(g,C);case"$mergeObjects":return function(I,g){if(!Array.isArray(I))return cI(I,g);const C={};for(const A of I){const I=cI(A,g);"object"!=typeof I||null===I||Array.isArray(I)||Object.assign(C,I)}return C}(g,C);case"$literal":return g;default:throw new Error(`Unsupported aggregation operator: ${I}`)}}(A,I[A],g)}{const A={};for(const l of C)A[l]=cI(I[l],g);return A}}return I}function dI(I){return I.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}const iI={1:"double",2:"string",3:"object",4:"array",5:"binData",6:"undefined",7:"objectId",8:"bool",9:"date",10:"null",11:"regex",13:"javascript",15:"javascriptWithScope",16:"int",17:"timestamp",18:"long",19:"decimal",127:"maxKey","-1":"minKey"},mI=Object.entries(iI).reduce((I,[g,C])=>(I[C]=parseInt(g),I),{});function BI(I,g){if(w(g)){for(let C=0;C<g.length;C++)if(BI(I,g[C]))return!0;return!1}const C="number"==typeof g?g:mI[g],A=iI[C]||g;return null===I?"null"===A||10===C:void 0===I?"undefined"===A||6===C:"number"==typeof I?Number.isInteger(I)?"int"===A||16===C:"double"===A||1===C:"string"==typeof I?"string"===A||2===C:"boolean"==typeof I?"bool"===A||8===C:I instanceof Date?"date"===A||9===C:I instanceof F?"objectId"===A||7===C:I instanceof RegExp?"regex"===A||11===C:w(I)?"array"===A||4===C:"object"==typeof I?"object"===A||3===C:typeof I===g}function WI(I){if(w(I)){let g=0;for(let C=0;C<I.length;C++)g|=1<<I[C];return g}return"number"==typeof I?I:0}function VI(I,g){if("number"!=typeof I)return!1;const C=WI(g);return(I&C)===C}function oI(I,g){if("number"!=typeof I)return!1;return 0===(I&WI(g))}function XI(I,g){if("number"!=typeof I)return!1;return 0!==(I&WI(g))}function sI(I,g){if("number"!=typeof I)return!1;const C=WI(g);return(I&C)!==C}function hI(I,g){if(g.type){const C=w(I)?"array":null===I?"null":typeof I;if(g.type!==C)return!1}if(g.required&&w(g.required))for(let C=0;C<g.required.length;C++)if(!(g.required[C]in I))return!1;if(g.properties)for(const C in g.properties){if(!(C in I))return!1;const A=g.properties[C];if(!hI(I[C],A))return!1}if(void 0!==g.minimum&&"number"==typeof I&&I<g.minimum)return!1;if(void 0!==g.maximum&&"number"==typeof I&&I>g.maximum)return!1;if(void 0!==g.minLength&&"string"==typeof I&&I.length<g.minLength)return!1;if(void 0!==g.maxLength&&"string"==typeof I&&I.length>g.maxLength)return!1;if(g.pattern&&"string"==typeof I){if(!new RegExp(g.pattern).test(I))return!1}return!(g.enum&&w(g.enum)&&!g.enum.includes(I))}function YI(I,g){return I instanceof F&&g instanceof F?I.equals(g):I==g}function yI(I,g,C){let A=I,l=g;switch(I instanceof F&&(A=I.toString()),g instanceof F&&(l=g.toString()),C){case">":return A>l;case">=":return A>=l;case"<":return A<l;case"<=":return A<=l;default:return!1}}function KI(I,g){if(void 0===I)return!1;if(null===I)return g(I);if(w(I)){for(var C=0;C<I.length;C++)if(g(I[C]))return!0;return!1}return g(I)}function RI(I){if("string"!=typeof I)return[];const g=function(I){return"string"!=typeof I?[]:I.toLowerCase().split(/\W+/).filter(I=>I.length>0).filter(I=>!bI.has(I))}(I);return g.map(I=>function(I){let g=String(I).toLowerCase();if(g.length<3)return g;let C,A=!1;return 121===g.codePointAt(0)&&(A=!0,g="Y"+g.slice(1)),CI.test(g)?g=g.slice(0,-2):gI.test(g)&&(g=g.slice(0,-1)),(C=II.exec(g))?j.test(C[1])&&(g=g.slice(0,-1)):(C=_.exec(g))&&D.test(C[1])&&(g=C[1],$.test(g)?g+="e":AI.test(g)?g=g.slice(0,-1):f.test(g)&&(g+="e")),(C=E.exec(g))&&D.test(C[1])&&(g=C[1]+"i"),(C=lI.exec(g))&&j.test(C[1])&&(g=C[1]+r[C[2]]),(C=ZI.exec(g))&&j.test(C[1])&&(g=C[1]+Q[C[2]]),(C=GI.exec(g))?M.test(C[1])&&(g=C[1]):(C=q.exec(g))&&M.test(C[1])&&(g=C[1]),(C=P.exec(g))&&(M.test(C[1])||L.test(C[1])&&!f.test(C[1]))&&(g=C[1]),O.test(g)&&M.test(g)&&(g=g.slice(0,-1)),A&&(g="y"+g.slice(1)),g}(I))}function uI(I,g){if("string"!=typeof I)return!1;const C=new Set(RI(I));return RI(g).some(I=>C.has(I))}function aI(I,g){try{if(!Array.isArray(g)||2!==g.length)return!1;const C=g[0][0],A=g[0][1],l=g[1][0];return HI(I,C,l,g[1][1],A)}catch(C){return!1}}function HI(I,g,C,A,l){if(!I)return!1;if("FeatureCollection"===I.type&&I.features&&I.features.length>0){for(const Z of I.features)if(Z.geometry&&!HI(Z.geometry,g,C,A,l))return!1;return!0}if("Feature"===I.type&&I.geometry)return HI(I.geometry,g,C,A,l);if("Point"===I.type&&I.coordinates){const[Z,G]=I.coordinates;if("number"==typeof Z&&"number"==typeof G)return Z>=g&&Z<=C&&G>=A&&G<=l}if("Polygon"===I.type&&I.coordinates&&I.coordinates.length>0){for(const Z of I.coordinates)for(const I of Z){const Z=I[0],G=I[1];if(Z<g||Z>C||G<A||G>l)return!1}return!0}return!1}function nI(I){if(!I)return null;if("FeatureCollection"===I.type&&I.features&&I.features.length>0){const g=I.features[0];if(g.geometry)return nI(g.geometry)}if("Feature"===I.type&&I.geometry)return nI(I.geometry);if("Point"===I.type&&I.coordinates){const[g,C]=I.coordinates;if("number"==typeof g&&"number"==typeof C)return{lat:C,lng:g}}if("Polygon"===I.type&&I.coordinates&&I.coordinates.length>0){const g=I.coordinates[0];if(g.length>0){let I=0,C=0;for(const A of g)C+=A[0],I+=A[1];return{lat:I/g.length,lng:C/g.length}}}return null}function pI(I,g,C,A){const l=(C-I)*Math.PI/180,Z=(A-g)*Math.PI/180,G=Math.sin(l/2)*Math.sin(l/2)+Math.cos(I*Math.PI/180)*Math.cos(C*Math.PI/180)*Math.sin(Z/2)*Math.sin(Z/2);return 6371*(2*Math.atan2(Math.sqrt(G),Math.sqrt(1-G)))}function eI(I,g,C,A){const l=nI(I);if(!l)return!1;return 1e3*pI(l.lat,l.lng,C,g)<=A}function tI(I,g){if(!I||!g)return!1;const C=nI(g);if(!C)return!1;const A=nI(I);if(!A)return!1;if("Polygon"===g.type&&"Point"===I.type)return NI(A.lng,A.lat,g.coordinates[0]);if("Polygon"===I.type&&"Point"===g.type){const C=g.coordinates;return NI(C[0],C[1],I.coordinates[0])}if("Point"===I.type&&"Point"===g.type){return pI(A.lat,A.lng,C.lat,C.lng)<.001}return!1}function NI(I,g,C){let A=!1;for(let l=0,Z=C.length-1;l<C.length;Z=l++){const G=C[l][0],b=C[l][1],c=C[Z][0],d=C[Z][1];b>g!=d>g&&I<(c-G)*(g-b)/(d-b)+G&&(A=!A)}return A}function FI(I,g){var C=Object.keys(g)[0],A=g[C];if("$"!=C.charAt(0))return SI(I,C,A);if("$and"==C)return JI(I,A);if("$or"==C)return function(I,g){for(var C=0;C<g.length;C++)if(FI(I,g[C]))return!0;return!1}(I,A);if("$not"==C)return function(I,g){return!FI(I,g)}(I,A);if("$nor"==C)return function(I,g){for(var C=0;C<g.length;C++)if(FI(I,g[C]))return!1;return!0}(I,A);if("$where"==C)return function(I,g){if("function"==typeof g)try{return g.call(I)}catch(C){return!1}else if("string"==typeof g)try{return new Function("return "+g).call(I)}catch(C){return!1}return!1}(I,A);if("$comment"==C)return!0;if("$jsonSchema"==C)return hI(I,A);if("$text"==C){return function(I,g){return!(!I||"object"!=typeof I)&&function I(C){if("string"==typeof C)return uI(C,g);if("object"!=typeof C||null===C)return!1;if(w(C)){for(let g=0;g<C.length;g++)if(I(C[g]))return!0;return!1}for(const g in C)if(C.hasOwnProperty(g)&&I(C[g]))return!0;return!1}(I)}(I,A.$search||A)}if("$expr"!=C)throw{$err:"Can't canonicalize query: BadValue unknown top level operator: "+C,code:17287};try{return cI(A,I)}catch(l){return!1}}function SI(I,g,C){var A=function(I,g){for(var C=g.split("."),A=[I],l=0;l<C.length;l++){for(var Z=C[l],G=parseInt(Z,10),b=[],c=0;c<A.length;c++){var d=A[c];if(null!=d&&null!=d)if(w(d)&&!isNaN(G)&&G>=0)G<d.length&&b.push(d[G]);else if(w(d))for(var i=0;i<d.length;i++)null!=d[i]&&null!=d[i]&&"object"==typeof d[i]&&b.push(d[i][Z]);else"object"==typeof d&&b.push(d[Z])}A=b}if(0!==(A=A.filter(function(I){return void 0!==I})).length)return 1===A.length?A[0]:A}(I,g);if("string"==typeof C)return KI(A,function(I){return YI(I,C)});if("number"==typeof C)return KI(A,function(I){return YI(I,C)});if("boolean"==typeof C)return KI(A,function(I){return YI(I,C)});if(C instanceof F)return KI(A,function(I){return YI(I,C)});if("object"==typeof C){if(C instanceof RegExp)return null!=A&&KI(A,function(I){return I&&I.match(C)});if(w(C))return null!=A&&KI(A,function(I){return I&&v(I,C)});var l=Object.keys(C);if("$"==l[0].charAt(0)){for(var Z=0;Z<l.length;Z++){var G=Object.keys(C)[Z],b=C[G];if("$eq"==G){if(!KI(A,function(I){return YI(I,b)}))return!1}else if("$gt"==G){if(!KI(A,function(I){return yI(I,b,">")}))return!1}else if("$gte"==G){if(!KI(A,function(I){return yI(I,b,">=")}))return!1}else if("$lt"==G){if(!KI(A,function(I){return yI(I,b,"<")}))return!1}else if("$lte"==G){if(!KI(A,function(I){return yI(I,b,"<=")}))return!1}else if("$ne"==G){if(!KI(A,function(I){return!YI(I,b)}))return!1}else if("$in"==G){if(!KI(A,function(I){return k(I,b)}))return!1}else if("$nin"==G){if(KI(A,function(I){return k(I,b)}))return!1}else if("$exists"==G){var c=J(I,g);if(b?null==c:null!=c)return!1}else if("$type"==G){if(void 0===A){if(6!==("number"==typeof b?b:mI[b]))return!1}else if(!BI(A,b))return!1}else if("$mod"==G){if(2!=b.length)throw{$err:"Can't canonicalize query: BadValue malformed mod, not enough elements",code:17287};if(!KI(A,function(I){return null!=I&&I%b[0]==b[1]}))return!1}else if("$regex"==G){var d=b,i=C.$options||"",m="string"==typeof d?new RegExp(d,i):d;if(!KI(A,function(I){return null!=I&&m.test(I)}))return!1}else{if("$options"==G)continue;if("$text"==G){if(!KI(A,function(I){return null!=I&&uI(I,b)}))return!1}else if("$expr"==G)try{if(!cI(b,I))return!1}catch(R){return!1}else if("$geoWithin"==G){if(!KI(A,function(I){return null!=I&&aI(I,b)}))return!1}else if("$near"==G||"$nearSphere"==G){let I;if(b.$geometry?I=b.$geometry.coordinates:b.coordinates?I=b.coordinates:Array.isArray(b)&&(I=b),!(I&&I.length>=2))return!1;{const[g,C]=I,l=b.$maxDistance||1e6;if(!KI(A,function(I){return null!=I&&eI(I,g,C,l)}))return!1}}else if("$geoIntersects"==G){const I=b.$geometry||b;if(!KI(A,function(g){return null!=g&&tI(g,I)}))return!1}else if("$not"==G){if(SI(I,g,b))return!1}else if("$all"==G){if(null==(W=J(I,g))||!w(W))return!1;for(var B=0;B<b.length;B++)if(!k(b[B],W))return!1}else if("$elemMatch"==G){var W;if(null==(W=J(I,g))||!w(W))return!1;var V=!1;for(B=0;B<W.length;B++){var o=W[B];if("object"!=typeof o||w(o)){for(var X=!0,s=Object.keys(b),h=0;h<s.length;h++){var Y=s[h],y=b[Y];("$gte"!=Y||o>=y)&&("$gt"!=Y||o>y)&&("$lte"!=Y||o<=y)&&("$lt"!=Y||o<y)?"$eq"==Y&&o!=y||"$ne"==Y&&o==y?X=!1:"$in"!=Y||k(o,y)?"$nin"==Y&&k(o,y)&&(X=!1):X=!1:X=!1}if(X){V=!0;break}}else if(wI(o,b)){V=!0;break}}if(!V)return!1}else if("$size"==G){var K=J(I,g);if(null==K||!w(K))return!1;if(K.length!=b)return!1}else if("$bitsAllSet"==G){if(!KI(A,function(I){return VI(I,b)}))return!1}else if("$bitsAllClear"==G){if(!KI(A,function(I){return oI(I,b)}))return!1}else if("$bitsAnySet"==G){if(!KI(A,function(I){return XI(I,b)}))return!1}else{if("$bitsAnyClear"!=G)throw{$err:"Can't canonicalize query: BadValue unknown operator: "+G,code:17287};if(!KI(A,function(I){return sI(I,b)}))return!1}}}return!0}return J(I,g)&&z(J(I,g),C)}}function JI(I,g){for(var C=0;C<g.length;C++)if(!FI(I,g[C]))return!1;return!0}function wI(I,g){return JI(I,function(I){var g=[];for(var C in I)if(I.hasOwnProperty(C)){var A={};A[C]=I[C],g.push(A)}return g}(g))}class kI extends C.EventEmitter{constructor(I,g=[],C={}){super(),this.target=I,this.pipeline=g,this.options=C,this.closed=!1,this._listeners=/* @__PURE__ */new Map,this._changeCounter=0,this._startWatching()}_startWatching(){if(this.closed)return;const I=this._getCollectionsToWatch();for(const g of I)this._watchCollection(g);"Server"===this.target.constructor.name&&this._interceptServerDBCreation(),"DB"===this.target.constructor.name&&this._interceptDBCollectionCreation(),"MongoClient"===this.target.constructor.name&&this._interceptClientDBCreation()}_getCollectionsToWatch(){const I=[];if("Server"===this.target.constructor.name){for(const[g,C]of this.target.databases){const g=C.getCollectionNames();for(const A of g){const g=C[A];g&&g.isCollection&&I.push(g)}}return I}if("MongoClient"===this.target.constructor.name)return this._monitorClient(),I;if("DB"===this.target.constructor.name){const g=this.target.getCollectionNames();for(const C of g){const g=this.target[C];g&&g.isCollection&&I.push(g)}this._monitorDB()}return this.target.isCollection&&I.push(this.target),I}_watchCollection(I){if(this.closed)return;if(!I)return;if("function"!=typeof I.on)return;if(!I.isCollection)return;if(this._listeners.has(I))return;const g={insert:g=>this._emitChange("insert",I,g),update:(g,C)=>this._emitChange("update",I,g,C),replace:g=>this._emitChange("replace",I,g),delete:g=>this._emitChange("delete",I,g)};this._listeners.set(I,g),I.on("insert",g.insert),I.on("update",g.update),I.on("replace",g.replace),I.on("delete",g.delete)}_emitChange(I,g,C,A=null){if(this.closed)return;const l=this._createChangeEvent(I,g,C,A);this._matchesPipeline(l)&&this.emit("change",l)}_createChangeEvent(I,g,C,A){const l={_id:{_data:btoa(String(++this._changeCounter))},operationType:I,clusterTime:/* @__PURE__ */new Date,ns:{db:g.db.dbName,coll:g.name},documentKey:{_id:C._id}};switch(I){case"insert":case"replace":l.fullDocument=C;break;case"update":l.updateDescription=A||{updatedFields:{},removedFields:[],truncatedArrays:[]},"updateLookup"===this.options.fullDocument&&(l.fullDocument=C)}return l}_matchesPipeline(I){if(!this.pipeline||0===this.pipeline.length)return!0;for(const g of this.pipeline)if(g.$match&&!wI(I,g.$match))return!1;return!0}_getNestedValue(I,g){return g.split(".").reduce((I,g)=>I?.[g],I)}_monitorClient(){}_interceptClientDBCreation(){const I=this.target,g=I.db.bind(I),C=this;this._watchedDBs=/* @__PURE__ */new Map,I.db=function(I,A){const l=g(I,A),Z=l.dbName;if(!C._watchedDBs.has(Z)){C._watchedDBs.set(Z,l);const I=l.getCollectionNames();for(const g of I){const I=l[g];I&&I.isCollection&&!C._listeners.has(I)&&C._watchCollection(I)}C._interceptDBCollectionCreationForClient(l)}return l},this._originalClientMethods={db:g}}_interceptServerDBCreation(){const I=this.target,g=I._getDB.bind(I),C=this;this._watchedDBs=/* @__PURE__ */new Map,I._getDB=function(I){const A=g(I);if(!C._watchedDBs.has(I)){C._watchedDBs.set(I,A);const g=A.getCollectionNames();for(const I of g){const g=A[I];g&&g.isCollection&&!C._listeners.has(g)&&C._watchCollection(g)}C._interceptDBCollectionCreationForServer(A)}return A},this._originalServerMethods={_getDB:g}}_interceptDBCollectionCreationForServer(I){const g=I.collection.bind(I),C=I.createCollection.bind(I),A=this;I.collection=function(I){const C=g(I);return C&&C.isCollection&&!A._listeners.has(C)&&A._watchCollection(C),C},I.createCollection=function(g){C(g);const l=I[g];l&&l.isCollection&&!A._listeners.has(l)&&A._watchCollection(l)}}_interceptDBCollectionCreationForClient(I){const g=I.collection.bind(I),C=I.createCollection.bind(I),A=this;I.collection=function(I){const C=g(I);return C&&C.isCollection&&!A._listeners.has(C)&&A._watchCollection(C),C},I.createCollection=function(g){C(g);const l=I[g];l&&l.isCollection&&!A._listeners.has(l)&&A._watchCollection(l)}}_monitorDB(){}_interceptDBCollectionCreation(){const I=this.target,g=I.collection.bind(I),C=I.createCollection.bind(I),A=this;I.collection=function(I){const C=g(I);return C&&C.isCollection&&!A._listeners.has(C)&&A._watchCollection(C),C},I.createCollection=function(g){C(g);const l=I[g];l&&l.isCollection&&!A._listeners.has(l)&&A._watchCollection(l)},this._originalDBMethods={collection:g,createCollection:C}}close(){if(!this.closed){this.closed=!0;for(const[I,g]of this._listeners)I.off("insert",g.insert),I.off("update",g.update),I.off("replace",g.replace),I.off("delete",g.delete);this._listeners.clear(),this._originalServerMethods&&"Server"===this.target.constructor.name&&(this.target._getDB=this._originalServerMethods._getDB),this._originalDBMethods&&"DB"===this.target.constructor.name&&(this.target.collection=this._originalDBMethods.collection,this.target.createCollection=this._originalDBMethods.createCollection),this._originalClientMethods&&"MongoClient"===this.target.constructor.name&&(this.target.db=this._originalClientMethods.db),this.emit("close"),this.removeAllListeners()}}get isClosed(){return this.closed}async*[Symbol.asyncIterator](){const I=[];let g=null,C=!1;const A=C=>{g?(g({value:C,done:!1}),g=null):I.push(C)},l=()=>{C=!0,g&&(g({done:!0}),g=null)},Z=I=>{g&&(g(Promise.reject(I)),g=null)};this.on("change",A),this.on("close",l),this.on("error",Z);try{for(;!C;)if(I.length>0)yield I.shift();else{const I=await new Promise(I=>{g=I,C&&I({done:!0})});if(I.done)break;yield I.value}}finally{this.off("change",A),this.off("close",l),this.off("error",Z)}}async next(){return new Promise((I,g)=>{const C=g=>{Z(),I(g)},A=()=>{Z(),I(null)},l=I=>{Z(),g(I)},Z=()=>{this.off("change",C),this.off("close",A),this.off("error",l)};this.closed?I(null):(this.once("change",C),this.once("close",A),this.once("error",l))})}}function vI(I){if(null==I)return I;if("function"==typeof I)return{__function:I.toString()};if(I instanceof F)return{__objectId:I.toString()};if(I instanceof Date)return{__date:I.toISOString()};if(Array.isArray(I))return I.map(vI);if("object"==typeof I){const g={};for(const[C,A]of Object.entries(I))g[C]=vI(A);return g}return I}function zI(I){if(null==I)return I;if("object"==typeof I&&I.__function)return"string"==typeof I.__function?`(${I.__function}).call(this)`:void 0;if("object"==typeof I&&I.__objectId)return new F(I.__objectId);if("object"==typeof I&&I.__date)return new Date(I.__date);if(Array.isArray(I))return I.map(zI);if("object"==typeof I){const g={};for(const[C,A]of Object.entries(I))g[C]=zI(A);return g}return I}class rI extends C.EventEmitter{constructor(I){super(),this.worker=I,this._nextId=1,this._pending=/* @__PURE__ */new Map,this._terminating=!1,this._handleMessage=this._handleMessage.bind(this),this._handleError=this._handleError.bind(this),this._attach()}static async create(I={}){if("undefined"!=typeof window&&void 0!==globalThis.Worker)return new QI(I);const{Worker:g}=await Promise.resolve().then(()=>UI),{fileURLToPath:C}=await Promise.resolve().then(()=>UI);let A=I.workerPath;if(!A){A=C(new URL("data:text/javascript;base64,dmFyIGV2ZW50cyA9IHsgZXhwb3J0czoge30gfTsKdmFyIGhhc1JlcXVpcmVkRXZlbnRzOwpmdW5jdGlvbiByZXF1aXJlRXZlbnRzKCkgewogIGlmIChoYXNSZXF1aXJlZEV2ZW50cykgcmV0dXJuIGV2ZW50cy5leHBvcnRzOwogIGhhc1JlcXVpcmVkRXZlbnRzID0gMTsKICB2YXIgUiA9IHR5cGVvZiBSZWZsZWN0ID09PSAib2JqZWN0IiA/IFJlZmxlY3QgOiBudWxsOwogIHZhciBSZWZsZWN0QXBwbHkgPSBSICYmIHR5cGVvZiBSLmFwcGx5ID09PSAiZnVuY3Rpb24iID8gUi5hcHBseSA6IGZ1bmN0aW9uIFJlZmxlY3RBcHBseTIodGFyZ2V0LCByZWNlaXZlciwgYXJncykgewogICAgcmV0dXJuIEZ1bmN0aW9uLnByb3RvdHlwZS5hcHBseS5jYWxsKHRhcmdldCwgcmVjZWl2ZXIsIGFyZ3MpOwogIH07CiAgdmFyIFJlZmxlY3RPd25LZXlzOwogIGlmIChSICYmIHR5cGVvZiBSLm93bktleXMgPT09ICJmdW5jdGlvbiIpIHsKICAgIFJlZmxlY3RPd25LZXlzID0gUi5vd25LZXlzOwogIH0gZWxzZSBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgUmVmbGVjdE93bktleXMgPSBmdW5jdGlvbiBSZWZsZWN0T3duS2V5czIodGFyZ2V0KSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyh0YXJnZXQpLmNvbmNhdChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKHRhcmdldCkpOwogICAgfTsKICB9IGVsc2UgewogICAgUmVmbGVjdE93bktleXMgPSBmdW5jdGlvbiBSZWZsZWN0T3duS2V5czIodGFyZ2V0KSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyh0YXJnZXQpOwogICAgfTsKICB9CiAgZnVuY3Rpb24gUHJvY2Vzc0VtaXRXYXJuaW5nKHdhcm5pbmcpIHsKICAgIGlmIChjb25zb2xlICYmIGNvbnNvbGUud2FybikgY29uc29sZS53YXJuKHdhcm5pbmcpOwogIH0KICB2YXIgTnVtYmVySXNOYU4gPSBOdW1iZXIuaXNOYU4gfHwgZnVuY3Rpb24gTnVtYmVySXNOYU4yKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgIT09IHZhbHVlOwogIH07CiAgZnVuY3Rpb24gRXZlbnRFbWl0dGVyKCkgewogICAgRXZlbnRFbWl0dGVyLmluaXQuY2FsbCh0aGlzKTsKICB9CiAgZXZlbnRzLmV4cG9ydHMgPSBFdmVudEVtaXR0ZXI7CiAgZXZlbnRzLmV4cG9ydHMub25jZSA9IG9uY2U7CiAgRXZlbnRFbWl0dGVyLkV2ZW50RW1pdHRlciA9IEV2ZW50RW1pdHRlcjsKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLl9ldmVudHMgPSB2b2lkIDA7CiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5fZXZlbnRzQ291bnQgPSAwOwogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUuX21heExpc3RlbmVycyA9IHZvaWQgMDsKICB2YXIgZGVmYXVsdE1heExpc3RlbmVycyA9IDEwOwogIGZ1bmN0aW9uIGNoZWNrTGlzdGVuZXIobGlzdGVuZXIpIHsKICAgIGlmICh0eXBlb2YgbGlzdGVuZXIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignVGhlICJsaXN0ZW5lciIgYXJndW1lbnQgbXVzdCBiZSBvZiB0eXBlIEZ1bmN0aW9uLiBSZWNlaXZlZCB0eXBlICcgKyB0eXBlb2YgbGlzdGVuZXIpOwogICAgfQogIH0KICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRXZlbnRFbWl0dGVyLCAiZGVmYXVsdE1heExpc3RlbmVycyIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gZGVmYXVsdE1heExpc3RlbmVyczsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uKGFyZykgewogICAgICBpZiAodHlwZW9mIGFyZyAhPT0gIm51bWJlciIgfHwgYXJnIDwgMCB8fCBOdW1iZXJJc05hTihhcmcpKSB7CiAgICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ1RoZSB2YWx1ZSBvZiAiZGVmYXVsdE1heExpc3RlbmVycyIgaXMgb3V0IG9mIHJhbmdlLiBJdCBtdXN0IGJlIGEgbm9uLW5lZ2F0aXZlIG51bWJlci4gUmVjZWl2ZWQgJyArIGFyZyArICIuIik7CiAgICAgIH0KICAgICAgZGVmYXVsdE1heExpc3RlbmVycyA9IGFyZzsKICAgIH0KICB9KTsKICBFdmVudEVtaXR0ZXIuaW5pdCA9IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXMuX2V2ZW50cyA9PT0gdm9pZCAwIHx8IHRoaXMuX2V2ZW50cyA9PT0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpLl9ldmVudHMpIHsKICAgICAgdGhpcy5fZXZlbnRzID0gLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIHRoaXMuX2V2ZW50c0NvdW50ID0gMDsKICAgIH0KICAgIHRoaXMuX21heExpc3RlbmVycyA9IHRoaXMuX21heExpc3RlbmVycyB8fCB2b2lkIDA7CiAgfTsKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLnNldE1heExpc3RlbmVycyA9IGZ1bmN0aW9uIHNldE1heExpc3RlbmVycyhuKSB7CiAgICBpZiAodHlwZW9mIG4gIT09ICJudW1iZXIiIHx8IG4gPCAwIHx8IE51bWJlcklzTmFOKG4pKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdUaGUgdmFsdWUgb2YgIm4iIGlzIG91dCBvZiByYW5nZS4gSXQgbXVzdCBiZSBhIG5vbi1uZWdhdGl2ZSBudW1iZXIuIFJlY2VpdmVkICcgKyBuICsgIi4iKTsKICAgIH0KICAgIHRoaXMuX21heExpc3RlbmVycyA9IG47CiAgICByZXR1cm4gdGhpczsKICB9OwogIGZ1bmN0aW9uIF9nZXRNYXhMaXN0ZW5lcnModGhhdCkgewogICAgaWYgKHRoYXQuX21heExpc3RlbmVycyA9PT0gdm9pZCAwKQogICAgICByZXR1cm4gRXZlbnRFbWl0dGVyLmRlZmF1bHRNYXhMaXN0ZW5lcnM7CiAgICByZXR1cm4gdGhhdC5fbWF4TGlzdGVuZXJzOwogIH0KICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLmdldE1heExpc3RlbmVycyA9IGZ1bmN0aW9uIGdldE1heExpc3RlbmVycygpIHsKICAgIHJldHVybiBfZ2V0TWF4TGlzdGVuZXJzKHRoaXMpOwogIH07CiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5lbWl0ID0gZnVuY3Rpb24gZW1pdCh0eXBlKSB7CiAgICB2YXIgYXJncyA9IFtdOwogICAgZm9yICh2YXIgaSA9IDE7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIGFyZ3MucHVzaChhcmd1bWVudHNbaV0pOwogICAgdmFyIGRvRXJyb3IgPSB0eXBlID09PSAiZXJyb3IiOwogICAgdmFyIGV2ZW50czIgPSB0aGlzLl9ldmVudHM7CiAgICBpZiAoZXZlbnRzMiAhPT0gdm9pZCAwKQogICAgICBkb0Vycm9yID0gZG9FcnJvciAmJiBldmVudHMyLmVycm9yID09PSB2b2lkIDA7CiAgICBlbHNlIGlmICghZG9FcnJvcikKICAgICAgcmV0dXJuIGZhbHNlOwogICAgaWYgKGRvRXJyb3IpIHsKICAgICAgdmFyIGVyOwogICAgICBpZiAoYXJncy5sZW5ndGggPiAwKQogICAgICAgIGVyID0gYXJnc1swXTsKICAgICAgaWYgKGVyIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgICB0aHJvdyBlcjsKICAgICAgfQogICAgICB2YXIgZXJyID0gbmV3IEVycm9yKCJVbmhhbmRsZWQgZXJyb3IuIiArIChlciA/ICIgKCIgKyBlci5tZXNzYWdlICsgIikiIDogIiIpKTsKICAgICAgZXJyLmNvbnRleHQgPSBlcjsKICAgICAgdGhyb3cgZXJyOwogICAgfQogICAgdmFyIGhhbmRsZXIgPSBldmVudHMyW3R5cGVdOwogICAgaWYgKGhhbmRsZXIgPT09IHZvaWQgMCkKICAgICAgcmV0dXJuIGZhbHNlOwogICAgaWYgKHR5cGVvZiBoYW5kbGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIFJlZmxlY3RBcHBseShoYW5kbGVyLCB0aGlzLCBhcmdzKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBsZW4gPSBoYW5kbGVyLmxlbmd0aDsKICAgICAgdmFyIGxpc3RlbmVycyA9IGFycmF5Q2xvbmUoaGFuZGxlciwgbGVuKTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47ICsraSkKICAgICAgICBSZWZsZWN0QXBwbHkobGlzdGVuZXJzW2ldLCB0aGlzLCBhcmdzKTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH07CiAgZnVuY3Rpb24gX2FkZExpc3RlbmVyKHRhcmdldCwgdHlwZSwgbGlzdGVuZXIsIHByZXBlbmQpIHsKICAgIHZhciBtOwogICAgdmFyIGV2ZW50czI7CiAgICB2YXIgZXhpc3Rpbmc7CiAgICBjaGVja0xpc3RlbmVyKGxpc3RlbmVyKTsKICAgIGV2ZW50czIgPSB0YXJnZXQuX2V2ZW50czsKICAgIGlmIChldmVudHMyID09PSB2b2lkIDApIHsKICAgICAgZXZlbnRzMiA9IHRhcmdldC5fZXZlbnRzID0gLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIHRhcmdldC5fZXZlbnRzQ291bnQgPSAwOwogICAgfSBlbHNlIHsKICAgICAgaWYgKGV2ZW50czIubmV3TGlzdGVuZXIgIT09IHZvaWQgMCkgewogICAgICAgIHRhcmdldC5lbWl0KAogICAgICAgICAgIm5ld0xpc3RlbmVyIiwKICAgICAgICAgIHR5cGUsCiAgICAgICAgICBsaXN0ZW5lci5saXN0ZW5lciA/IGxpc3RlbmVyLmxpc3RlbmVyIDogbGlzdGVuZXIKICAgICAgICApOwogICAgICAgIGV2ZW50czIgPSB0YXJnZXQuX2V2ZW50czsKICAgICAgfQogICAgICBleGlzdGluZyA9IGV2ZW50czJbdHlwZV07CiAgICB9CiAgICBpZiAoZXhpc3RpbmcgPT09IHZvaWQgMCkgewogICAgICBleGlzdGluZyA9IGV2ZW50czJbdHlwZV0gPSBsaXN0ZW5lcjsKICAgICAgKyt0YXJnZXQuX2V2ZW50c0NvdW50OwogICAgfSBlbHNlIHsKICAgICAgaWYgKHR5cGVvZiBleGlzdGluZyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIGV4aXN0aW5nID0gZXZlbnRzMlt0eXBlXSA9IHByZXBlbmQgPyBbbGlzdGVuZXIsIGV4aXN0aW5nXSA6IFtleGlzdGluZywgbGlzdGVuZXJdOwogICAgICB9IGVsc2UgaWYgKHByZXBlbmQpIHsKICAgICAgICBleGlzdGluZy51bnNoaWZ0KGxpc3RlbmVyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBleGlzdGluZy5wdXNoKGxpc3RlbmVyKTsKICAgICAgfQogICAgICBtID0gX2dldE1heExpc3RlbmVycyh0YXJnZXQpOwogICAgICBpZiAobSA+IDAgJiYgZXhpc3RpbmcubGVuZ3RoID4gbSAmJiAhZXhpc3Rpbmcud2FybmVkKSB7CiAgICAgICAgZXhpc3Rpbmcud2FybmVkID0gdHJ1ZTsKICAgICAgICB2YXIgdyA9IG5ldyBFcnJvcigiUG9zc2libGUgRXZlbnRFbWl0dGVyIG1lbW9yeSBsZWFrIGRldGVjdGVkLiAiICsgZXhpc3RpbmcubGVuZ3RoICsgIiAiICsgU3RyaW5nKHR5cGUpICsgIiBsaXN0ZW5lcnMgYWRkZWQuIFVzZSBlbWl0dGVyLnNldE1heExpc3RlbmVycygpIHRvIGluY3JlYXNlIGxpbWl0Iik7CiAgICAgICAgdy5uYW1lID0gIk1heExpc3RlbmVyc0V4Y2VlZGVkV2FybmluZyI7CiAgICAgICAgdy5lbWl0dGVyID0gdGFyZ2V0OwogICAgICAgIHcudHlwZSA9IHR5cGU7CiAgICAgICAgdy5jb3VudCA9IGV4aXN0aW5nLmxlbmd0aDsKICAgICAgICBQcm9jZXNzRW1pdFdhcm5pbmcodyk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0YXJnZXQ7CiAgfQogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUuYWRkTGlzdGVuZXIgPSBmdW5jdGlvbiBhZGRMaXN0ZW5lcih0eXBlLCBsaXN0ZW5lcikgewogICAgcmV0dXJuIF9hZGRMaXN0ZW5lcih0aGlzLCB0eXBlLCBsaXN0ZW5lciwgZmFsc2UpOwogIH07CiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5vbiA9IEV2ZW50RW1pdHRlci5wcm90b3R5cGUuYWRkTGlzdGVuZXI7CiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5wcmVwZW5kTGlzdGVuZXIgPSBmdW5jdGlvbiBwcmVwZW5kTGlzdGVuZXIodHlwZSwgbGlzdGVuZXIpIHsKICAgIHJldHVybiBfYWRkTGlzdGVuZXIodGhpcywgdHlwZSwgbGlzdGVuZXIsIHRydWUpOwogIH07CiAgZnVuY3Rpb24gb25jZVdyYXBwZXIoKSB7CiAgICBpZiAoIXRoaXMuZmlyZWQpIHsKICAgICAgdGhpcy50YXJnZXQucmVtb3ZlTGlzdGVuZXIodGhpcy50eXBlLCB0aGlzLndyYXBGbik7CiAgICAgIHRoaXMuZmlyZWQgPSB0cnVlOwogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkKICAgICAgICByZXR1cm4gdGhpcy5saXN0ZW5lci5jYWxsKHRoaXMudGFyZ2V0KTsKICAgICAgcmV0dXJuIHRoaXMubGlzdGVuZXIuYXBwbHkodGhpcy50YXJnZXQsIGFyZ3VtZW50cyk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIF9vbmNlV3JhcCh0YXJnZXQsIHR5cGUsIGxpc3RlbmVyKSB7CiAgICB2YXIgc3RhdGUgPSB7IGZpcmVkOiBmYWxzZSwgd3JhcEZuOiB2b2lkIDAsIHRhcmdldCwgdHlwZSwgbGlzdGVuZXIgfTsKICAgIHZhciB3cmFwcGVkID0gb25jZVdyYXBwZXIuYmluZChzdGF0ZSk7CiAgICB3cmFwcGVkLmxpc3RlbmVyID0gbGlzdGVuZXI7CiAgICBzdGF0ZS53cmFwRm4gPSB3cmFwcGVkOwogICAgcmV0dXJuIHdyYXBwZWQ7CiAgfQogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUub25jZSA9IGZ1bmN0aW9uIG9uY2UyKHR5cGUsIGxpc3RlbmVyKSB7CiAgICBjaGVja0xpc3RlbmVyKGxpc3RlbmVyKTsKICAgIHRoaXMub24odHlwZSwgX29uY2VXcmFwKHRoaXMsIHR5cGUsIGxpc3RlbmVyKSk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUucHJlcGVuZE9uY2VMaXN0ZW5lciA9IGZ1bmN0aW9uIHByZXBlbmRPbmNlTGlzdGVuZXIodHlwZSwgbGlzdGVuZXIpIHsKICAgIGNoZWNrTGlzdGVuZXIobGlzdGVuZXIpOwogICAgdGhpcy5wcmVwZW5kTGlzdGVuZXIodHlwZSwgX29uY2VXcmFwKHRoaXMsIHR5cGUsIGxpc3RlbmVyKSk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUucmVtb3ZlTGlzdGVuZXIgPSBmdW5jdGlvbiByZW1vdmVMaXN0ZW5lcih0eXBlLCBsaXN0ZW5lcikgewogICAgdmFyIGxpc3QsIGV2ZW50czIsIHBvc2l0aW9uLCBpLCBvcmlnaW5hbExpc3RlbmVyOwogICAgY2hlY2tMaXN0ZW5lcihsaXN0ZW5lcik7CiAgICBldmVudHMyID0gdGhpcy5fZXZlbnRzOwogICAgaWYgKGV2ZW50czIgPT09IHZvaWQgMCkKICAgICAgcmV0dXJuIHRoaXM7CiAgICBsaXN0ID0gZXZlbnRzMlt0eXBlXTsKICAgIGlmIChsaXN0ID09PSB2b2lkIDApCiAgICAgIHJldHVybiB0aGlzOwogICAgaWYgKGxpc3QgPT09IGxpc3RlbmVyIHx8IGxpc3QubGlzdGVuZXIgPT09IGxpc3RlbmVyKSB7CiAgICAgIGlmICgtLXRoaXMuX2V2ZW50c0NvdW50ID09PSAwKQogICAgICAgIHRoaXMuX2V2ZW50cyA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICBlbHNlIHsKICAgICAgICBkZWxldGUgZXZlbnRzMlt0eXBlXTsKICAgICAgICBpZiAoZXZlbnRzMi5yZW1vdmVMaXN0ZW5lcikKICAgICAgICAgIHRoaXMuZW1pdCgicmVtb3ZlTGlzdGVuZXIiLCB0eXBlLCBsaXN0Lmxpc3RlbmVyIHx8IGxpc3RlbmVyKTsKICAgICAgfQogICAgfSBlbHNlIGlmICh0eXBlb2YgbGlzdCAhPT0gImZ1bmN0aW9uIikgewogICAgICBwb3NpdGlvbiA9IC0xOwogICAgICBmb3IgKGkgPSBsaXN0Lmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgaWYgKGxpc3RbaV0gPT09IGxpc3RlbmVyIHx8IGxpc3RbaV0ubGlzdGVuZXIgPT09IGxpc3RlbmVyKSB7CiAgICAgICAgICBvcmlnaW5hbExpc3RlbmVyID0gbGlzdFtpXS5saXN0ZW5lcjsKICAgICAgICAgIHBvc2l0aW9uID0gaTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAocG9zaXRpb24gPCAwKQogICAgICAgIHJldHVybiB0aGlzOwogICAgICBpZiAocG9zaXRpb24gPT09IDApCiAgICAgICAgbGlzdC5zaGlmdCgpOwogICAgICBlbHNlIHsKICAgICAgICBzcGxpY2VPbmUobGlzdCwgcG9zaXRpb24pOwogICAgICB9CiAgICAgIGlmIChsaXN0Lmxlbmd0aCA9PT0gMSkKICAgICAgICBldmVudHMyW3R5cGVdID0gbGlzdFswXTsKICAgICAgaWYgKGV2ZW50czIucmVtb3ZlTGlzdGVuZXIgIT09IHZvaWQgMCkKICAgICAgICB0aGlzLmVtaXQoInJlbW92ZUxpc3RlbmVyIiwgdHlwZSwgb3JpZ2luYWxMaXN0ZW5lciB8fCBsaXN0ZW5lcik7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9OwogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUub2ZmID0gRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5yZW1vdmVMaXN0ZW5lcjsKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLnJlbW92ZUFsbExpc3RlbmVycyA9IGZ1bmN0aW9uIHJlbW92ZUFsbExpc3RlbmVycyh0eXBlKSB7CiAgICB2YXIgbGlzdGVuZXJzLCBldmVudHMyLCBpOwogICAgZXZlbnRzMiA9IHRoaXMuX2V2ZW50czsKICAgIGlmIChldmVudHMyID09PSB2b2lkIDApCiAgICAgIHJldHVybiB0aGlzOwogICAgaWYgKGV2ZW50czIucmVtb3ZlTGlzdGVuZXIgPT09IHZvaWQgMCkgewogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHRoaXMuX2V2ZW50cyA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICAgIHRoaXMuX2V2ZW50c0NvdW50ID0gMDsKICAgICAgfSBlbHNlIGlmIChldmVudHMyW3R5cGVdICE9PSB2b2lkIDApIHsKICAgICAgICBpZiAoLS10aGlzLl9ldmVudHNDb3VudCA9PT0gMCkKICAgICAgICAgIHRoaXMuX2V2ZW50cyA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICAgIGVsc2UKICAgICAgICAgIGRlbGV0ZSBldmVudHMyW3R5cGVdOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHsKICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhldmVudHMyKTsKICAgICAgdmFyIGtleTsKICAgICAgZm9yIChpID0gMDsgaSA8IGtleXMubGVuZ3RoOyArK2kpIHsKICAgICAgICBrZXkgPSBrZXlzW2ldOwogICAgICAgIGlmIChrZXkgPT09ICJyZW1vdmVMaXN0ZW5lciIpIGNvbnRpbnVlOwogICAgICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKGtleSk7CiAgICAgIH0KICAgICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoInJlbW92ZUxpc3RlbmVyIik7CiAgICAgIHRoaXMuX2V2ZW50cyA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICB0aGlzLl9ldmVudHNDb3VudCA9IDA7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgbGlzdGVuZXJzID0gZXZlbnRzMlt0eXBlXTsKICAgIGlmICh0eXBlb2YgbGlzdGVuZXJzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIodHlwZSwgbGlzdGVuZXJzKTsKICAgIH0gZWxzZSBpZiAobGlzdGVuZXJzICE9PSB2b2lkIDApIHsKICAgICAgZm9yIChpID0gbGlzdGVuZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCBsaXN0ZW5lcnNbaV0pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9OwogIGZ1bmN0aW9uIF9saXN0ZW5lcnModGFyZ2V0LCB0eXBlLCB1bndyYXApIHsKICAgIHZhciBldmVudHMyID0gdGFyZ2V0Ll9ldmVudHM7CiAgICBpZiAoZXZlbnRzMiA9PT0gdm9pZCAwKQogICAgICByZXR1cm4gW107CiAgICB2YXIgZXZsaXN0ZW5lciA9IGV2ZW50czJbdHlwZV07CiAgICBpZiAoZXZsaXN0ZW5lciA9PT0gdm9pZCAwKQogICAgICByZXR1cm4gW107CiAgICBpZiAodHlwZW9mIGV2bGlzdGVuZXIgPT09ICJmdW5jdGlvbiIpCiAgICAgIHJldHVybiB1bndyYXAgPyBbZXZsaXN0ZW5lci5saXN0ZW5lciB8fCBldmxpc3RlbmVyXSA6IFtldmxpc3RlbmVyXTsKICAgIHJldHVybiB1bndyYXAgPyB1bndyYXBMaXN0ZW5lcnMoZXZsaXN0ZW5lcikgOiBhcnJheUNsb25lKGV2bGlzdGVuZXIsIGV2bGlzdGVuZXIubGVuZ3RoKTsKICB9CiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5saXN0ZW5lcnMgPSBmdW5jdGlvbiBsaXN0ZW5lcnModHlwZSkgewogICAgcmV0dXJuIF9saXN0ZW5lcnModGhpcywgdHlwZSwgdHJ1ZSk7CiAgfTsKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLnJhd0xpc3RlbmVycyA9IGZ1bmN0aW9uIHJhd0xpc3RlbmVycyh0eXBlKSB7CiAgICByZXR1cm4gX2xpc3RlbmVycyh0aGlzLCB0eXBlLCBmYWxzZSk7CiAgfTsKICBFdmVudEVtaXR0ZXIubGlzdGVuZXJDb3VudCA9IGZ1bmN0aW9uKGVtaXR0ZXIsIHR5cGUpIHsKICAgIGlmICh0eXBlb2YgZW1pdHRlci5saXN0ZW5lckNvdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHJldHVybiBlbWl0dGVyLmxpc3RlbmVyQ291bnQodHlwZSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbGlzdGVuZXJDb3VudC5jYWxsKGVtaXR0ZXIsIHR5cGUpOwogICAgfQogIH07CiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5saXN0ZW5lckNvdW50ID0gbGlzdGVuZXJDb3VudDsKICBmdW5jdGlvbiBsaXN0ZW5lckNvdW50KHR5cGUpIHsKICAgIHZhciBldmVudHMyID0gdGhpcy5fZXZlbnRzOwogICAgaWYgKGV2ZW50czIgIT09IHZvaWQgMCkgewogICAgICB2YXIgZXZsaXN0ZW5lciA9IGV2ZW50czJbdHlwZV07CiAgICAgIGlmICh0eXBlb2YgZXZsaXN0ZW5lciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHJldHVybiAxOwogICAgICB9IGVsc2UgaWYgKGV2bGlzdGVuZXIgIT09IHZvaWQgMCkgewogICAgICAgIHJldHVybiBldmxpc3RlbmVyLmxlbmd0aDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIDA7CiAgfQogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUuZXZlbnROYW1lcyA9IGZ1bmN0aW9uIGV2ZW50TmFtZXMoKSB7CiAgICByZXR1cm4gdGhpcy5fZXZlbnRzQ291bnQgPiAwID8gUmVmbGVjdE93bktleXModGhpcy5fZXZlbnRzKSA6IFtdOwogIH07CiAgZnVuY3Rpb24gYXJyYXlDbG9uZShhcnIsIG4pIHsKICAgIHZhciBjb3B5MiA9IG5ldyBBcnJheShuKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbjsgKytpKQogICAgICBjb3B5MltpXSA9IGFycltpXTsKICAgIHJldHVybiBjb3B5MjsKICB9CiAgZnVuY3Rpb24gc3BsaWNlT25lKGxpc3QsIGluZGV4KSB7CiAgICBmb3IgKDsgaW5kZXggKyAxIDwgbGlzdC5sZW5ndGg7IGluZGV4KyspCiAgICAgIGxpc3RbaW5kZXhdID0gbGlzdFtpbmRleCArIDFdOwogICAgbGlzdC5wb3AoKTsKICB9CiAgZnVuY3Rpb24gdW53cmFwTGlzdGVuZXJzKGFycikgewogICAgdmFyIHJldCA9IG5ldyBBcnJheShhcnIubGVuZ3RoKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmV0Lmxlbmd0aDsgKytpKSB7CiAgICAgIHJldFtpXSA9IGFycltpXS5saXN0ZW5lciB8fCBhcnJbaV07CiAgICB9CiAgICByZXR1cm4gcmV0OwogIH0KICBmdW5jdGlvbiBvbmNlKGVtaXR0ZXIsIG5hbWUpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgZnVuY3Rpb24gZXJyb3JMaXN0ZW5lcihlcnIpIHsKICAgICAgICBlbWl0dGVyLnJlbW92ZUxpc3RlbmVyKG5hbWUsIHJlc29sdmVyKTsKICAgICAgICByZWplY3QoZXJyKTsKICAgICAgfQogICAgICBmdW5jdGlvbiByZXNvbHZlcigpIHsKICAgICAgICBpZiAodHlwZW9mIGVtaXR0ZXIucmVtb3ZlTGlzdGVuZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIGVtaXR0ZXIucmVtb3ZlTGlzdGVuZXIoImVycm9yIiwgZXJyb3JMaXN0ZW5lcik7CiAgICAgICAgfQogICAgICAgIHJlc29sdmUoW10uc2xpY2UuY2FsbChhcmd1bWVudHMpKTsKICAgICAgfQogICAgICBldmVudFRhcmdldEFnbm9zdGljQWRkTGlzdGVuZXIoZW1pdHRlciwgbmFtZSwgcmVzb2x2ZXIsIHsgb25jZTogdHJ1ZSB9KTsKICAgICAgaWYgKG5hbWUgIT09ICJlcnJvciIpIHsKICAgICAgICBhZGRFcnJvckhhbmRsZXJJZkV2ZW50RW1pdHRlcihlbWl0dGVyLCBlcnJvckxpc3RlbmVyLCB7IG9uY2U6IHRydWUgfSk7CiAgICAgIH0KICAgIH0pOwogIH0KICBmdW5jdGlvbiBhZGRFcnJvckhhbmRsZXJJZkV2ZW50RW1pdHRlcihlbWl0dGVyLCBoYW5kbGVyLCBmbGFncykgewogICAgaWYgKHR5cGVvZiBlbWl0dGVyLm9uID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIGV2ZW50VGFyZ2V0QWdub3N0aWNBZGRMaXN0ZW5lcihlbWl0dGVyLCAiZXJyb3IiLCBoYW5kbGVyLCBmbGFncyk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGV2ZW50VGFyZ2V0QWdub3N0aWNBZGRMaXN0ZW5lcihlbWl0dGVyLCBuYW1lLCBsaXN0ZW5lciwgZmxhZ3MpIHsKICAgIGlmICh0eXBlb2YgZW1pdHRlci5vbiA9PT0gImZ1bmN0aW9uIikgewogICAgICBpZiAoZmxhZ3Mub25jZSkgewogICAgICAgIGVtaXR0ZXIub25jZShuYW1lLCBsaXN0ZW5lcik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZW1pdHRlci5vbihuYW1lLCBsaXN0ZW5lcik7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAodHlwZW9mIGVtaXR0ZXIuYWRkRXZlbnRMaXN0ZW5lciA9PT0gImZ1bmN0aW9uIikgewogICAgICBlbWl0dGVyLmFkZEV2ZW50TGlzdGVuZXIobmFtZSwgZnVuY3Rpb24gd3JhcExpc3RlbmVyKGFyZykgewogICAgICAgIGlmIChmbGFncy5vbmNlKSB7CiAgICAgICAgICBlbWl0dGVyLnJlbW92ZUV2ZW50TGlzdGVuZXIobmFtZSwgd3JhcExpc3RlbmVyKTsKICAgICAgICB9CiAgICAgICAgbGlzdGVuZXIoYXJnKTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdUaGUgImVtaXR0ZXIiIGFyZ3VtZW50IG11c3QgYmUgb2YgdHlwZSBFdmVudEVtaXR0ZXIuIFJlY2VpdmVkIHR5cGUgJyArIHR5cGVvZiBlbWl0dGVyKTsKICAgIH0KICB9CiAgcmV0dXJuIGV2ZW50cy5leHBvcnRzOwp9CnZhciBldmVudHNFeHBvcnRzID0gcmVxdWlyZUV2ZW50cygpOwpjb25zdCBUWVBFID0gewogIE5VTEw6IDAsCiAgRkFMU0U6IDEsCiAgVFJVRTogMiwKICBJTlQ6IDMsCiAgRkxPQVQ6IDQsCiAgU1RSSU5HOiA1LAogIE9JRDogNiwKICBEQVRFOiA3LAogIFBPSU5URVI6IDgsCiAgQklOQVJZOiA5LAogIEFSUkFZOiAxNiwKICBPQkpFQ1Q6IDE3Cn07CmNsYXNzIE9iamVjdElkIHsKICBjb25zdHJ1Y3RvcihpZCkgewogICAgaWYgKGlkID09PSB2b2lkIDAgfHwgaWQgPT09IG51bGwpIHsKICAgICAgdGhpcy5pZCA9IE9iamVjdElkLmdlbmVyYXRlKCk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBpZCA9PT0gInN0cmluZyIpIHsKICAgICAgaWYgKCFPYmplY3RJZC5pc1ZhbGlkKGlkKSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihgQXJndW1lbnQgcGFzc2VkIGluIG11c3QgYmUgYSBzdHJpbmcgb2YgMjQgaGV4IGNoYXJhY3RlcnMsIGdvdDogJHtpZH1gKTsKICAgICAgfQogICAgICB0aGlzLmlkID0gaWQudG9Mb3dlckNhc2UoKTsKICAgIH0gZWxzZSBpZiAoaWQgaW5zdGFuY2VvZiBVaW50OEFycmF5ICYmIGlkLmxlbmd0aCA9PT0gMTIpIHsKICAgICAgdGhpcy5pZCA9IEFycmF5LmZyb20oaWQpLm1hcCgoYikgPT4gYi50b1N0cmluZygxNikucGFkU3RhcnQoMiwgIjAiKSkuam9pbigiIik7CiAgICB9IGVsc2UgaWYgKGlkIGluc3RhbmNlb2YgT2JqZWN0SWQpIHsKICAgICAgdGhpcy5pZCA9IGlkLmlkOwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGBBcmd1bWVudCBwYXNzZWQgaW4gbXVzdCBiZSBhIHN0cmluZyBvZiAyNCBoZXggY2hhcmFjdGVycyBvciBhbiBPYmplY3RJZGApOwogICAgfQogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBPYmplY3RJZCBhcyBhIDI0LWNoYXJhY3RlciBoZXggc3RyaW5nCiAgICovCiAgdG9TdHJpbmcoKSB7CiAgICByZXR1cm4gdGhpcy5pZDsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgT2JqZWN0SWQgYXMgYSAyNC1jaGFyYWN0ZXIgaGV4IHN0cmluZyAoYWxpYXMgZm9yIHRvU3RyaW5nKQogICAqLwogIHRvSGV4U3RyaW5nKCkgewogICAgcmV0dXJuIHRoaXMuaWQ7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIHRpbWVzdGFtcCBwb3J0aW9uIG9mIHRoZSBPYmplY3RJZCBhcyBhIERhdGUKICAgKi8KICBnZXRUaW1lc3RhbXAoKSB7CiAgICBjb25zdCB0aW1lc3RhbXAgPSBwYXJzZUludCh0aGlzLmlkLnN1YnN0cmluZygwLCA4KSwgMTYpOwogICAgcmV0dXJuIG5ldyBEYXRlKHRpbWVzdGFtcCAqIDFlMyk7CiAgfQogIGVxdWFscyhvdGhlcikgewogICAgaWYgKCEob3RoZXIgaW5zdGFuY2VvZiBPYmplY3RJZCkpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW4gb25seSBjb21wYXJlIHdpdGggYW5vdGhlciBPYmplY3RJZCIpOwogICAgfQogICAgcmV0dXJuIHRoaXMuaWQgPT09IG90aGVyLmlkOwogIH0KICAvKioKICAgKiBDb21wYXJlcyB0aGlzIE9iamVjdElkIHdpdGggYW5vdGhlciBmb3IgZXF1YWxpdHkKICAgKi8KICBjb21wYXJlKG90aGVyKSB7CiAgICBpZiAoIShvdGhlciBpbnN0YW5jZW9mIE9iamVjdElkKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbiBvbmx5IGNvbXBhcmUgd2l0aCBhbm90aGVyIE9iamVjdElkIik7CiAgICB9CiAgICByZXR1cm4gdGhpcy5pZC5sb2NhbGVDb21wYXJlKG90aGVyLmlkKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgT2JqZWN0SWQgaW4gSlNPTiBmb3JtYXQgKGFzIGhleCBzdHJpbmcpCiAgICovCiAgdG9KU09OKCkgewogICAgcmV0dXJuIHRoaXMuaWQ7CiAgfQogIC8qKgogICAqIEN1c3RvbSBpbnNwZWN0IGZvciBOb2RlLmpzIGNvbnNvbGUubG9nCiAgICovCiAgaW5zcGVjdCgpIHsKICAgIHJldHVybiBgT2JqZWN0SWQoIiR7dGhpcy5pZH0iKWA7CiAgfQogIHRvQnl0ZXMoKSB7CiAgICBjb25zdCBieXRlcyA9IG5ldyBVaW50OEFycmF5KDEyKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTI7IGkrKykgewogICAgICBieXRlc1tpXSA9IHBhcnNlSW50KHRoaXMuaWQuc3Vic3RyaW5nKGkgKiAyLCBpICogMiArIDIpLCAxNik7CiAgICB9CiAgICByZXR1cm4gYnl0ZXM7CiAgfQogIC8qKgogICAqIFZhbGlkYXRlcyBpZiBhIHN0cmluZyBpcyBhIHZhbGlkIE9iamVjdElkIGhleCBzdHJpbmcKICAgKi8KICBzdGF0aWMgaXNWYWxpZChpZCkgewogICAgaWYgKCFpZCkgcmV0dXJuIGZhbHNlOwogICAgaWYgKHR5cGVvZiBpZCAhPT0gInN0cmluZyIpIHJldHVybiBmYWxzZTsKICAgIGlmIChpZC5sZW5ndGggIT09IDI0KSByZXR1cm4gZmFsc2U7CiAgICByZXR1cm4gL15bMC05YS1mQS1GXXsyNH0kLy50ZXN0KGlkKTsKICB9CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBPYmplY3RJZCBmcm9tIGEgdGltZXN0YW1wCiAgICovCiAgc3RhdGljIGNyZWF0ZUZyb21UaW1lKHRpbWVzdGFtcCkgewogICAgY29uc3QgdHMgPSBNYXRoLmZsb29yKHRpbWVzdGFtcCAvIDFlMyk7CiAgICBjb25zdCB0c0hleCA9ICgiMDAwMDAwMDAiICsgdHMudG9TdHJpbmcoMTYpKS5zbGljZSgtOCk7CiAgICBjb25zdCB0YWlsID0gIjAwMDAwMDAwMDAwMDAwMDAiOwogICAgcmV0dXJuIG5ldyBPYmplY3RJZCh0c0hleCArIHRhaWwpOwogIH0KICAvKioKICAgKiBHZW5lcmF0ZXMgYSBuZXcgT2JqZWN0SWQgaGV4IHN0cmluZwogICAqIEZvcm1hdDogOC1jaGFyIHRpbWVzdGFtcCAoNCBieXRlcykgKyAxNi1jaGFyIHJhbmRvbSBkYXRhICg4IGJ5dGVzKQogICAqLwogIHN0YXRpYyBnZW5lcmF0ZSgpIHsKICAgIGNvbnN0IHRzID0gTWF0aC5mbG9vcihEYXRlLm5vdygpIC8gMWUzKTsKICAgIGNvbnN0IHJhbmQgPSB0eXBlb2YgY3J5cHRvICE9PSAidW5kZWZpbmVkIiAmJiBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzID8gbmV3IFVpbnQ4QXJyYXkoOCkgOiBudWxsOwogICAgbGV0IHRhaWwgPSAiIjsKICAgIGlmIChyYW5kKSB7CiAgICAgIGNyeXB0by5nZXRSYW5kb21WYWx1ZXMocmFuZCk7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmFuZC5sZW5ndGg7IGkrKykgewogICAgICAgIHRhaWwgKz0gKCIwIiArIHJhbmRbaV0udG9TdHJpbmcoMTYpKS5zbGljZSgtMik7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHRhaWwgPSBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDE2KS5zbGljZSgyKS5wYWRFbmQoOCwgIjAiKS5zbGljZSgwLCA4KSArIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMTYpLnNsaWNlKDIpLnBhZEVuZCg4LCAiMCIpLnNsaWNlKDAsIDgpOwogICAgfQogICAgY29uc3QgdHNIZXggPSAoIjAwMDAwMDAwIiArIHRzLnRvU3RyaW5nKDE2KSkuc2xpY2UoLTgpOwogICAgcmV0dXJuICh0c0hleCArIHRhaWwpLnNsaWNlKDAsIDI0KTsKICB9Cn0KY2xhc3MgUG9pbnRlciB7CiAgY29uc3RydWN0b3Iob2Zmc2V0KSB7CiAgICBpZiAob2Zmc2V0ID09PSB2b2lkIDAgfHwgb2Zmc2V0ID09PSBudWxsKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiUG9pbnRlciBvZmZzZXQgbXVzdCBiZSBhIG51bWJlciIpOwogICAgfQogICAgaWYgKHR5cGVvZiBvZmZzZXQgIT09ICJudW1iZXIiKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiUG9pbnRlciBvZmZzZXQgbXVzdCBiZSBhIG51bWJlciIpOwogICAgfQogICAgaWYgKCFOdW1iZXIuaXNJbnRlZ2VyKG9mZnNldCkpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJQb2ludGVyIG9mZnNldCBtdXN0IGJlIGFuIGludGVnZXIiKTsKICAgIH0KICAgIGlmIChvZmZzZXQgPCAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiUG9pbnRlciBvZmZzZXQgbXVzdCBiZSBub24tbmVnYXRpdmUiKTsKICAgIH0KICAgIGlmIChvZmZzZXQgPiBOdW1iZXIuTUFYX1NBRkVfSU5URUdFUikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlBvaW50ZXIgb2Zmc2V0IGV4Y2VlZHMgbWF4aW11bSBzYWZlIGludGVnZXIiKTsKICAgIH0KICAgIHRoaXMub2Zmc2V0ID0gb2Zmc2V0OwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBwb2ludGVyIG9mZnNldCBhcyBhIG51bWJlcgogICAqLwogIHZhbHVlT2YoKSB7CiAgICByZXR1cm4gdGhpcy5vZmZzZXQ7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIHBvaW50ZXIgb2Zmc2V0IGFzIGEgc3RyaW5nCiAgICovCiAgdG9TdHJpbmcoKSB7CiAgICByZXR1cm4gdGhpcy5vZmZzZXQudG9TdHJpbmcoKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgcG9pbnRlciBpbiBKU09OIGZvcm1hdCAoYXMgbnVtYmVyKQogICAqLwogIHRvSlNPTigpIHsKICAgIHJldHVybiB0aGlzLm9mZnNldDsKICB9CiAgLyoqCiAgICogQ3VzdG9tIGluc3BlY3QgZm9yIE5vZGUuanMgY29uc29sZS5sb2cKICAgKi8KICBpbnNwZWN0KCkgewogICAgcmV0dXJuIGBQb2ludGVyKCR7dGhpcy5vZmZzZXR9KWA7CiAgfQogIC8qKgogICAqIENvbXBhcmVzIHRoaXMgUG9pbnRlciB3aXRoIGFub3RoZXIgZm9yIGVxdWFsaXR5CiAgICovCiAgZXF1YWxzKG90aGVyKSB7CiAgICBpZiAoIShvdGhlciBpbnN0YW5jZW9mIFBvaW50ZXIpKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHJldHVybiB0aGlzLm9mZnNldCA9PT0gb3RoZXIub2Zmc2V0OwogIH0KfQpmdW5jdGlvbiBlbmNvZGUodmFsdWUpIHsKICBjb25zdCBidWZmZXJzID0gW107CiAgZnVuY3Rpb24gZW5jb2RlVmFsdWUodmFsKSB7CiAgICBpZiAodmFsID09PSBudWxsKSB7CiAgICAgIGJ1ZmZlcnMucHVzaChuZXcgVWludDhBcnJheShbVFlQRS5OVUxMXSkpOwogICAgfSBlbHNlIGlmICh2YWwgPT09IGZhbHNlKSB7CiAgICAgIGJ1ZmZlcnMucHVzaChuZXcgVWludDhBcnJheShbVFlQRS5GQUxTRV0pKTsKICAgIH0gZWxzZSBpZiAodmFsID09PSB0cnVlKSB7CiAgICAgIGJ1ZmZlcnMucHVzaChuZXcgVWludDhBcnJheShbVFlQRS5UUlVFXSkpOwogICAgfSBlbHNlIGlmICh2YWwgaW5zdGFuY2VvZiBPYmplY3RJZCkgewogICAgICBidWZmZXJzLnB1c2gobmV3IFVpbnQ4QXJyYXkoW1RZUEUuT0lEXSkpOwogICAgICBidWZmZXJzLnB1c2godmFsLnRvQnl0ZXMoKSk7CiAgICB9IGVsc2UgaWYgKHZhbCBpbnN0YW5jZW9mIERhdGUpIHsKICAgICAgYnVmZmVycy5wdXNoKG5ldyBVaW50OEFycmF5KFtUWVBFLkRBVEVdKSk7CiAgICAgIGNvbnN0IGJ1ZmZlciA9IG5ldyBBcnJheUJ1ZmZlcig4KTsKICAgICAgY29uc3QgdmlldyA9IG5ldyBEYXRhVmlldyhidWZmZXIpOwogICAgICB2aWV3LnNldEJpZ0ludDY0KDAsIEJpZ0ludCh2YWwuZ2V0VGltZSgpKSwgdHJ1ZSk7CiAgICAgIGJ1ZmZlcnMucHVzaChuZXcgVWludDhBcnJheShidWZmZXIpKTsKICAgIH0gZWxzZSBpZiAodmFsIGluc3RhbmNlb2YgUG9pbnRlcikgewogICAgICBidWZmZXJzLnB1c2gobmV3IFVpbnQ4QXJyYXkoW1RZUEUuUE9JTlRFUl0pKTsKICAgICAgY29uc3QgYnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKDgpOwogICAgICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KGJ1ZmZlcik7CiAgICAgIHZpZXcuc2V0QmlnVWludDY0KDAsIEJpZ0ludCh2YWwub2Zmc2V0KSwgdHJ1ZSk7CiAgICAgIGJ1ZmZlcnMucHVzaChuZXcgVWludDhBcnJheShidWZmZXIpKTsKICAgIH0gZWxzZSBpZiAodmFsIGluc3RhbmNlb2YgVWludDhBcnJheSkgewogICAgICBidWZmZXJzLnB1c2gobmV3IFVpbnQ4QXJyYXkoW1RZUEUuQklOQVJZXSkpOwogICAgICBjb25zdCBsZW5ndGhCdWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIoNCk7CiAgICAgIGNvbnN0IGxlbmd0aFZpZXcgPSBuZXcgRGF0YVZpZXcobGVuZ3RoQnVmZmVyKTsKICAgICAgbGVuZ3RoVmlldy5zZXRVaW50MzIoMCwgdmFsLmxlbmd0aCwgdHJ1ZSk7CiAgICAgIGJ1ZmZlcnMucHVzaChuZXcgVWludDhBcnJheShsZW5ndGhCdWZmZXIpKTsKICAgICAgYnVmZmVycy5wdXNoKHZhbCk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWwgPT09ICJudW1iZXIiKSB7CiAgICAgIGlmIChOdW1iZXIuaXNJbnRlZ2VyKHZhbCkgJiYgTnVtYmVyLmlzU2FmZUludGVnZXIodmFsKSkgewogICAgICAgIGJ1ZmZlcnMucHVzaChuZXcgVWludDhBcnJheShbVFlQRS5JTlRdKSk7CiAgICAgICAgY29uc3QgYnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKDgpOwogICAgICAgIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcoYnVmZmVyKTsKICAgICAgICB2aWV3LnNldEJpZ0ludDY0KDAsIEJpZ0ludCh2YWwpLCB0cnVlKTsKICAgICAgICBidWZmZXJzLnB1c2gobmV3IFVpbnQ4QXJyYXkoYnVmZmVyKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYnVmZmVycy5wdXNoKG5ldyBVaW50OEFycmF5KFtUWVBFLkZMT0FUXSkpOwogICAgICAgIGNvbnN0IGJ1ZmZlciA9IG5ldyBBcnJheUJ1ZmZlcig4KTsKICAgICAgICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KGJ1ZmZlcik7CiAgICAgICAgdmlldy5zZXRGbG9hdDY0KDAsIHZhbCwgdHJ1ZSk7CiAgICAgICAgYnVmZmVycy5wdXNoKG5ldyBVaW50OEFycmF5KGJ1ZmZlcikpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWwgPT09ICJzdHJpbmciKSB7CiAgICAgIGJ1ZmZlcnMucHVzaChuZXcgVWludDhBcnJheShbVFlQRS5TVFJJTkddKSk7CiAgICAgIGNvbnN0IGVuY29kZWQgPSBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUodmFsKTsKICAgICAgY29uc3QgbGVuZ3RoQnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKDQpOwogICAgICBjb25zdCBsZW5ndGhWaWV3ID0gbmV3IERhdGFWaWV3KGxlbmd0aEJ1ZmZlcik7CiAgICAgIGxlbmd0aFZpZXcuc2V0VWludDMyKDAsIGVuY29kZWQubGVuZ3RoLCB0cnVlKTsKICAgICAgYnVmZmVycy5wdXNoKG5ldyBVaW50OEFycmF5KGxlbmd0aEJ1ZmZlcikpOwogICAgICBidWZmZXJzLnB1c2goZW5jb2RlZCk7CiAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkodmFsKSkgewogICAgICBjb25zdCB0ZW1wQnVmZmVycyA9IFtdOwogICAgICBjb25zdCBsZW5ndGhCdWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIoNCk7CiAgICAgIGNvbnN0IGxlbmd0aFZpZXcgPSBuZXcgRGF0YVZpZXcobGVuZ3RoQnVmZmVyKTsKICAgICAgbGVuZ3RoVmlldy5zZXRVaW50MzIoMCwgdmFsLmxlbmd0aCwgdHJ1ZSk7CiAgICAgIHRlbXBCdWZmZXJzLnB1c2gobmV3IFVpbnQ4QXJyYXkobGVuZ3RoQnVmZmVyKSk7CiAgICAgIGNvbnN0IHN0YXJ0TGVuZ3RoID0gYnVmZmVycy5sZW5ndGg7CiAgICAgIGZvciAoY29uc3QgaXRlbSBvZiB2YWwpIHsKICAgICAgICBlbmNvZGVWYWx1ZShpdGVtKTsKICAgICAgfQogICAgICBjb25zdCBlbGVtZW50QnVmZmVycyA9IGJ1ZmZlcnMuc3BsaWNlKHN0YXJ0TGVuZ3RoKTsKICAgICAgdGVtcEJ1ZmZlcnMucHVzaCguLi5lbGVtZW50QnVmZmVycyk7CiAgICAgIGNvbnN0IGNvbnRlbnRTaXplID0gdGVtcEJ1ZmZlcnMucmVkdWNlKChzdW0sIGJ1ZikgPT4gc3VtICsgYnVmLmxlbmd0aCwgMCk7CiAgICAgIGJ1ZmZlcnMucHVzaChuZXcgVWludDhBcnJheShbVFlQRS5BUlJBWV0pKTsKICAgICAgY29uc3Qgc2l6ZUJ1ZmZlciA9IG5ldyBBcnJheUJ1ZmZlcig0KTsKICAgICAgY29uc3Qgc2l6ZVZpZXcgPSBuZXcgRGF0YVZpZXcoc2l6ZUJ1ZmZlcik7CiAgICAgIHNpemVWaWV3LnNldFVpbnQzMigwLCBjb250ZW50U2l6ZSwgdHJ1ZSk7CiAgICAgIGJ1ZmZlcnMucHVzaChuZXcgVWludDhBcnJheShzaXplQnVmZmVyKSk7CiAgICAgIGJ1ZmZlcnMucHVzaCguLi50ZW1wQnVmZmVycyk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWwgPT09ICJvYmplY3QiKSB7CiAgICAgIGNvbnN0IHRlbXBCdWZmZXJzID0gW107CiAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyh2YWwpOwogICAgICBjb25zdCBsZW5ndGhCdWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIoNCk7CiAgICAgIGNvbnN0IGxlbmd0aFZpZXcgPSBuZXcgRGF0YVZpZXcobGVuZ3RoQnVmZmVyKTsKICAgICAgbGVuZ3RoVmlldy5zZXRVaW50MzIoMCwga2V5cy5sZW5ndGgsIHRydWUpOwogICAgICB0ZW1wQnVmZmVycy5wdXNoKG5ldyBVaW50OEFycmF5KGxlbmd0aEJ1ZmZlcikpOwogICAgICBjb25zdCBzdGFydExlbmd0aCA9IGJ1ZmZlcnMubGVuZ3RoOwogICAgICBmb3IgKGNvbnN0IGtleSBvZiBrZXlzKSB7CiAgICAgICAgY29uc3QgZW5jb2RlZCA9IG5ldyBUZXh0RW5jb2RlcigpLmVuY29kZShrZXkpOwogICAgICAgIGNvbnN0IGtleUxlbmd0aEJ1ZmZlciA9IG5ldyBBcnJheUJ1ZmZlcig0KTsKICAgICAgICBjb25zdCBrZXlMZW5ndGhWaWV3ID0gbmV3IERhdGFWaWV3KGtleUxlbmd0aEJ1ZmZlcik7CiAgICAgICAga2V5TGVuZ3RoVmlldy5zZXRVaW50MzIoMCwgZW5jb2RlZC5sZW5ndGgsIHRydWUpOwogICAgICAgIGJ1ZmZlcnMucHVzaChuZXcgVWludDhBcnJheShrZXlMZW5ndGhCdWZmZXIpKTsKICAgICAgICBidWZmZXJzLnB1c2goZW5jb2RlZCk7CiAgICAgICAgZW5jb2RlVmFsdWUodmFsW2tleV0pOwogICAgICB9CiAgICAgIGNvbnN0IGt2QnVmZmVycyA9IGJ1ZmZlcnMuc3BsaWNlKHN0YXJ0TGVuZ3RoKTsKICAgICAgdGVtcEJ1ZmZlcnMucHVzaCguLi5rdkJ1ZmZlcnMpOwogICAgICBjb25zdCBjb250ZW50U2l6ZSA9IHRlbXBCdWZmZXJzLnJlZHVjZSgoc3VtLCBidWYpID0+IHN1bSArIGJ1Zi5sZW5ndGgsIDApOwogICAgICBidWZmZXJzLnB1c2gobmV3IFVpbnQ4QXJyYXkoW1RZUEUuT0JKRUNUXSkpOwogICAgICBjb25zdCBzaXplQnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKDQpOwogICAgICBjb25zdCBzaXplVmlldyA9IG5ldyBEYXRhVmlldyhzaXplQnVmZmVyKTsKICAgICAgc2l6ZVZpZXcuc2V0VWludDMyKDAsIGNvbnRlbnRTaXplLCB0cnVlKTsKICAgICAgYnVmZmVycy5wdXNoKG5ldyBVaW50OEFycmF5KHNpemVCdWZmZXIpKTsKICAgICAgYnVmZmVycy5wdXNoKC4uLnRlbXBCdWZmZXJzKTsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5zdXBwb3J0ZWQgdHlwZTogJHt0eXBlb2YgdmFsfWApOwogICAgfQogIH0KICBlbmNvZGVWYWx1ZSh2YWx1ZSk7CiAgY29uc3QgdG90YWxMZW5ndGggPSBidWZmZXJzLnJlZHVjZSgoc3VtLCBidWYpID0+IHN1bSArIGJ1Zi5sZW5ndGgsIDApOwogIGNvbnN0IHJlc3VsdCA9IG5ldyBVaW50OEFycmF5KHRvdGFsTGVuZ3RoKTsKICBsZXQgb2Zmc2V0ID0gMDsKICBmb3IgKGNvbnN0IGJ1ZiBvZiBidWZmZXJzKSB7CiAgICByZXN1bHQuc2V0KGJ1Ziwgb2Zmc2V0KTsKICAgIG9mZnNldCArPSBidWYubGVuZ3RoOwogIH0KICByZXR1cm4gcmVzdWx0Owp9CmZ1bmN0aW9uIGRlY29kZShkYXRhKSB7CiAgbGV0IG9mZnNldCA9IDA7CiAgZnVuY3Rpb24gZGVjb2RlVmFsdWUoKSB7CiAgICBpZiAob2Zmc2V0ID49IGRhdGEubGVuZ3RoKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCBlbmQgb2YgZGF0YSIpOwogICAgfQogICAgY29uc3QgdHlwZSA9IGRhdGFbb2Zmc2V0KytdOwogICAgc3dpdGNoICh0eXBlKSB7CiAgICAgIGNhc2UgVFlQRS5OVUxMOgogICAgICAgIHJldHVybiBudWxsOwogICAgICBjYXNlIFRZUEUuRkFMU0U6CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICBjYXNlIFRZUEUuVFJVRToKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgY2FzZSBUWVBFLklOVDogewogICAgICAgIGlmIChvZmZzZXQgKyA0ID4gZGF0YS5sZW5ndGgpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCBlbmQgb2YgZGF0YSBmb3IgSU5UIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCArIG9mZnNldCwgOCk7CiAgICAgICAgY29uc3QgdmFsdWUgPSB2aWV3LmdldEJpZ0ludDY0KDAsIHRydWUpOwogICAgICAgIG9mZnNldCArPSA4OwogICAgICAgIGlmICh2YWx1ZSA8IEJpZ0ludChOdW1iZXIuTUlOX1NBRkVfSU5URUdFUikgfHwgdmFsdWUgPiBCaWdJbnQoTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkRlY29kZWQgaW50ZWdlciBleGNlZWRzIHNhZmUgcmFuZ2UiKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIE51bWJlcih2YWx1ZSk7CiAgICAgIH0KICAgICAgY2FzZSBUWVBFLkZMT0FUOiB7CiAgICAgICAgaWYgKG9mZnNldCArIDggPiBkYXRhLmxlbmd0aCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmV4cGVjdGVkIGVuZCBvZiBkYXRhIGZvciBGTE9BVCIpOwogICAgICAgIH0KICAgICAgICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KGRhdGEuYnVmZmVyLCBkYXRhLmJ5dGVPZmZzZXQgKyBvZmZzZXQsIDgpOwogICAgICAgIGNvbnN0IHZhbHVlID0gdmlldy5nZXRGbG9hdDY0KDAsIHRydWUpOwogICAgICAgIG9mZnNldCArPSA4OwogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogICAgICBjYXNlIFRZUEUuU1RSSU5HOiB7CiAgICAgICAgaWYgKG9mZnNldCArIDQgPiBkYXRhLmxlbmd0aCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmV4cGVjdGVkIGVuZCBvZiBkYXRhIGZvciBTVFJJTkcgbGVuZ3RoIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aFZpZXcgPSBuZXcgRGF0YVZpZXcoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCArIG9mZnNldCwgNCk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gbGVuZ3RoVmlldy5nZXRVaW50MzIoMCwgdHJ1ZSk7CiAgICAgICAgb2Zmc2V0ICs9IDQ7CiAgICAgICAgaWYgKG9mZnNldCArIGxlbmd0aCA+IGRhdGEubGVuZ3RoKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuZXhwZWN0ZWQgZW5kIG9mIGRhdGEgZm9yIFNUUklORyBjb250ZW50Iik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHN0cmluZ0RhdGEgPSBkYXRhLnNsaWNlKG9mZnNldCwgb2Zmc2V0ICsgbGVuZ3RoKTsKICAgICAgICBvZmZzZXQgKz0gbGVuZ3RoOwogICAgICAgIHJldHVybiBuZXcgVGV4dERlY29kZXIoKS5kZWNvZGUoc3RyaW5nRGF0YSk7CiAgICAgIH0KICAgICAgY2FzZSBUWVBFLk9JRDogewogICAgICAgIGlmIChvZmZzZXQgKyAxMiA+IGRhdGEubGVuZ3RoKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuZXhwZWN0ZWQgZW5kIG9mIGRhdGEgZm9yIE9JRCIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBvaWRCeXRlcyA9IGRhdGEuc2xpY2Uob2Zmc2V0LCBvZmZzZXQgKyAxMik7CiAgICAgICAgb2Zmc2V0ICs9IDEyOwogICAgICAgIHJldHVybiBuZXcgT2JqZWN0SWQob2lkQnl0ZXMpOwogICAgICB9CiAgICAgIGNhc2UgVFlQRS5EQVRFOiB7CiAgICAgICAgaWYgKG9mZnNldCArIDggPiBkYXRhLmxlbmd0aCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmV4cGVjdGVkIGVuZCBvZiBkYXRhIGZvciBEQVRFIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCArIG9mZnNldCwgOCk7CiAgICAgICAgY29uc3QgdGltZXN0YW1wID0gdmlldy5nZXRCaWdJbnQ2NCgwLCB0cnVlKTsKICAgICAgICBvZmZzZXQgKz0gODsKICAgICAgICByZXR1cm4gbmV3IERhdGUoTnVtYmVyKHRpbWVzdGFtcCkpOwogICAgICB9CiAgICAgIGNhc2UgVFlQRS5QT0lOVEVSOiB7CiAgICAgICAgaWYgKG9mZnNldCArIDggPiBkYXRhLmxlbmd0aCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmV4cGVjdGVkIGVuZCBvZiBkYXRhIGZvciBQT0lOVEVSIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCArIG9mZnNldCwgOCk7CiAgICAgICAgY29uc3QgcG9pbnRlck9mZnNldCA9IHZpZXcuZ2V0QmlnVWludDY0KDAsIHRydWUpOwogICAgICAgIG9mZnNldCArPSA4OwogICAgICAgIGlmIChwb2ludGVyT2Zmc2V0ID4gQmlnSW50KE51bWJlci5NQVhfU0FGRV9JTlRFR0VSKSkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJQb2ludGVyIG9mZnNldCBvdXQgb2YgdmFsaWQgcmFuZ2UiKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBQb2ludGVyKE51bWJlcihwb2ludGVyT2Zmc2V0KSk7CiAgICAgIH0KICAgICAgY2FzZSBUWVBFLkJJTkFSWTogewogICAgICAgIGlmIChvZmZzZXQgKyA0ID4gZGF0YS5sZW5ndGgpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCBlbmQgb2YgZGF0YSBmb3IgQklOQVJZIGxlbmd0aCIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGhWaWV3ID0gbmV3IERhdGFWaWV3KGRhdGEuYnVmZmVyLCBkYXRhLmJ5dGVPZmZzZXQgKyBvZmZzZXQsIDQpOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGxlbmd0aFZpZXcuZ2V0VWludDMyKDAsIHRydWUpOwogICAgICAgIG9mZnNldCArPSA0OwogICAgICAgIGlmIChvZmZzZXQgKyBsZW5ndGggPiBkYXRhLmxlbmd0aCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmV4cGVjdGVkIGVuZCBvZiBkYXRhIGZvciBCSU5BUlkgY29udGVudCIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBiaW5hcnlEYXRhID0gZGF0YS5zbGljZShvZmZzZXQsIG9mZnNldCArIGxlbmd0aCk7CiAgICAgICAgb2Zmc2V0ICs9IGxlbmd0aDsKICAgICAgICByZXR1cm4gYmluYXJ5RGF0YTsKICAgICAgfQogICAgICBjYXNlIFRZUEUuQVJSQVk6IHsKICAgICAgICBpZiAob2Zmc2V0ICsgNCA+IGRhdGEubGVuZ3RoKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuZXhwZWN0ZWQgZW5kIG9mIGRhdGEgZm9yIEFSUkFZIHNpemUiKTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc2l6ZVZpZXcgPSBuZXcgRGF0YVZpZXcoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCArIG9mZnNldCwgNCk7CiAgICAgICAgY29uc3Qgc2l6ZSA9IHNpemVWaWV3LmdldFVpbnQzMigwLCB0cnVlKTsKICAgICAgICBvZmZzZXQgKz0gNDsKICAgICAgICBpZiAob2Zmc2V0ICsgc2l6ZSA+IGRhdGEubGVuZ3RoKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuZXhwZWN0ZWQgZW5kIG9mIGRhdGEgZm9yIEFSUkFZIGNvbnRlbnQiKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbGVuZ3RoVmlldyA9IG5ldyBEYXRhVmlldyhkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0ICsgb2Zmc2V0LCA0KTsKICAgICAgICBjb25zdCBsZW5ndGggPSBsZW5ndGhWaWV3LmdldFVpbnQzMigwLCB0cnVlKTsKICAgICAgICBvZmZzZXQgKz0gNDsKICAgICAgICBjb25zdCBhcnIgPSBbXTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBhcnIucHVzaChkZWNvZGVWYWx1ZSgpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFycjsKICAgICAgfQogICAgICBjYXNlIFRZUEUuT0JKRUNUOiB7CiAgICAgICAgaWYgKG9mZnNldCArIDQgPiBkYXRhLmxlbmd0aCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmV4cGVjdGVkIGVuZCBvZiBkYXRhIGZvciBPQkpFQ1Qgc2l6ZSIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBzaXplVmlldyA9IG5ldyBEYXRhVmlldyhkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0ICsgb2Zmc2V0LCA0KTsKICAgICAgICBjb25zdCBzaXplID0gc2l6ZVZpZXcuZ2V0VWludDMyKDAsIHRydWUpOwogICAgICAgIG9mZnNldCArPSA0OwogICAgICAgIGlmIChvZmZzZXQgKyBzaXplID4gZGF0YS5sZW5ndGgpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCBlbmQgb2YgZGF0YSBmb3IgT0JKRUNUIGNvbnRlbnQiKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbGVuZ3RoVmlldyA9IG5ldyBEYXRhVmlldyhkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0ICsgb2Zmc2V0LCA0KTsKICAgICAgICBjb25zdCBsZW5ndGggPSBsZW5ndGhWaWV3LmdldFVpbnQzMigwLCB0cnVlKTsKICAgICAgICBvZmZzZXQgKz0gNDsKICAgICAgICBjb25zdCBvYmogPSB7fTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAob2Zmc2V0ICsgNCA+IGRhdGEubGVuZ3RoKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCBlbmQgb2YgZGF0YSBmb3IgT0JKRUNUIGtleSBsZW5ndGgiKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGtleUxlbmd0aFZpZXcgPSBuZXcgRGF0YVZpZXcoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCArIG9mZnNldCwgNCk7CiAgICAgICAgICBjb25zdCBrZXlMZW5ndGggPSBrZXlMZW5ndGhWaWV3LmdldFVpbnQzMigwLCB0cnVlKTsKICAgICAgICAgIG9mZnNldCArPSA0OwogICAgICAgICAgaWYgKG9mZnNldCArIGtleUxlbmd0aCA+IGRhdGEubGVuZ3RoKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCBlbmQgb2YgZGF0YSBmb3IgT0JKRUNUIGtleSIpOwogICAgICAgICAgfQogICAgICAgICAgY29uc3Qga2V5RGF0YSA9IGRhdGEuc2xpY2Uob2Zmc2V0LCBvZmZzZXQgKyBrZXlMZW5ndGgpOwogICAgICAgICAgb2Zmc2V0ICs9IGtleUxlbmd0aDsKICAgICAgICAgIGNvbnN0IGtleSA9IG5ldyBUZXh0RGVjb2RlcigpLmRlY29kZShrZXlEYXRhKTsKICAgICAgICAgIG9ialtrZXldID0gZGVjb2RlVmFsdWUoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9iajsKICAgICAgfQogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biB0eXBlIGJ5dGU6IDB4JHt0eXBlLnRvU3RyaW5nKDE2KX1gKTsKICAgIH0KICB9CiAgcmV0dXJuIGRlY29kZVZhbHVlKCk7Cn0KY2xhc3MgQkpzb25GaWxlIHsKICBjb25zdHJ1Y3RvcihzeW5jQWNjZXNzSGFuZGxlKSB7CiAgICBpZiAoIXN5bmNBY2Nlc3NIYW5kbGUpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJGaWxlU3lzdGVtU3luY0FjY2Vzc0hhbmRsZSBpcyByZXF1aXJlZCIpOwogICAgfQogICAgdGhpcy5zeW5jQWNjZXNzSGFuZGxlID0gc3luY0FjY2Vzc0hhbmRsZTsKICB9CiAgLyoqCiAgICogUmVhZCBhIHJhbmdlIG9mIGJ5dGVzIGZyb20gdGhlIGZpbGUKICAgKi8KICAjcmVhZFJhbmdlKHN0YXJ0LCBsZW5ndGgpIHsKICAgIGNvbnN0IGJ1ZmZlciA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCk7CiAgICBjb25zdCBieXRlc1JlYWQgPSB0aGlzLnN5bmNBY2Nlc3NIYW5kbGUucmVhZChidWZmZXIsIHsgYXQ6IHN0YXJ0IH0pOwogICAgaWYgKGJ5dGVzUmVhZCA8IGxlbmd0aCkgewogICAgICByZXR1cm4gYnVmZmVyLnNsaWNlKDAsIGJ5dGVzUmVhZCk7CiAgICB9CiAgICByZXR1cm4gYnVmZmVyOwogIH0KICAvKioKICAgKiBHZXQgdGhlIGN1cnJlbnQgZmlsZSBzaXplCiAgICovCiAgZ2V0RmlsZVNpemUoKSB7CiAgICByZXR1cm4gdGhpcy5zeW5jQWNjZXNzSGFuZGxlLmdldFNpemUoKTsKICB9CiAgLyoqCiAgICogV3JpdGUgZGF0YSB0byBmaWxlLCB0cnVuY2F0aW5nIGV4aXN0aW5nIGNvbnRlbnQKICAgKiBAcGFyYW0geyp9IGRhdGEgLSBEYXRhIHRvIGVuY29kZSBhbmQgd3JpdGUKICAgKi8KICB3cml0ZShkYXRhKSB7CiAgICBjb25zdCBiaW5hcnlEYXRhID0gZW5jb2RlKGRhdGEpOwogICAgdGhpcy5zeW5jQWNjZXNzSGFuZGxlLnRydW5jYXRlKDApOwogICAgdGhpcy5zeW5jQWNjZXNzSGFuZGxlLndyaXRlKGJpbmFyeURhdGEsIHsgYXQ6IDAgfSk7CiAgfQogIC8qKgogICAqIFJlYWQgYW5kIGRlY29kZSBkYXRhIGZyb20gZmlsZSBzdGFydGluZyBhdCBvcHRpb25hbCBwb2ludGVyIG9mZnNldAogICAqIEBwYXJhbSB7UG9pbnRlcn0gcG9pbnRlciAtIE9wdGlvbmFsIG9mZnNldCB0byBzdGFydCByZWFkaW5nIGZyb20gKGRlZmF1bHQ6IDApCiAgICogQHJldHVybnMgeyp9IC0gRGVjb2RlZCBkYXRhCiAgICovCiAgcmVhZChwb2ludGVyID0gbmV3IFBvaW50ZXIoMCkpIHsKICAgIGNvbnN0IGZpbGVTaXplID0gdGhpcy5nZXRGaWxlU2l6ZSgpOwogICAgaWYgKGZpbGVTaXplID09PSAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiRmlsZSBpcyBlbXB0eSIpOwogICAgfQogICAgY29uc3QgcG9pbnRlclZhbHVlID0gcG9pbnRlci52YWx1ZU9mKCk7CiAgICBpZiAocG9pbnRlclZhbHVlIDwgMCB8fCBwb2ludGVyVmFsdWUgPj0gZmlsZVNpemUpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGBQb2ludGVyIG9mZnNldCAke3BvaW50ZXJ9IG91dCBvZiBmaWxlIGJvdW5kcyBbMCwgJHtmaWxlU2l6ZX0pYCk7CiAgICB9CiAgICBjb25zdCBiaW5hcnlEYXRhID0gdGhpcy4jcmVhZFJhbmdlKHBvaW50ZXJWYWx1ZSwgZmlsZVNpemUgLSBwb2ludGVyVmFsdWUpOwogICAgcmV0dXJuIGRlY29kZShiaW5hcnlEYXRhKTsKICB9CiAgLyoqCiAgICogQXBwZW5kIGRhdGEgdG8gZmlsZSB3aXRob3V0IHRydW5jYXRpbmcgZXhpc3RpbmcgY29udGVudAogICAqIEBwYXJhbSB7Kn0gZGF0YSAtIERhdGEgdG8gZW5jb2RlIGFuZCBhcHBlbmQKICAgKi8KICBhcHBlbmQoZGF0YSkgewogICAgY29uc3QgYmluYXJ5RGF0YSA9IGVuY29kZShkYXRhKTsKICAgIGNvbnN0IGV4aXN0aW5nU2l6ZSA9IHRoaXMuZ2V0RmlsZVNpemUoKTsKICAgIHRoaXMuc3luY0FjY2Vzc0hhbmRsZS53cml0ZShiaW5hcnlEYXRhLCB7IGF0OiBleGlzdGluZ1NpemUgfSk7CiAgfQogIC8qKgogICAqIEV4cGxpY2l0bHkgZmx1c2ggYW55IHBlbmRpbmcgd3JpdGVzIHRvIGRpc2sKICAgKi8KICBmbHVzaCgpIHsKICAgIHRoaXMuc3luY0FjY2Vzc0hhbmRsZS5mbHVzaCgpOwogIH0KICAvKioKICAgKiBHZW5lcmF0b3IgdG8gc2NhbiB0aHJvdWdoIGFsbCByZWNvcmRzIGluIHRoZSBmaWxlCiAgICogRWFjaCByZWNvcmQgaXMgZGVjb2RlZCBhbmQgeWllbGRlZCBvbmUgYXQgYSB0aW1lCiAgICovCiAgKnNjYW4oKSB7CiAgICBjb25zdCBmaWxlU2l6ZSA9IHRoaXMuZ2V0RmlsZVNpemUoKTsKICAgIGlmIChmaWxlU2l6ZSA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBsZXQgb2Zmc2V0ID0gMDsKICAgIHdoaWxlIChvZmZzZXQgPCBmaWxlU2l6ZSkgewogICAgICBjb25zdCBnZXRWYWx1ZVNpemUgPSAocmVhZFBvc2l0aW9uKSA9PiB7CiAgICAgICAgbGV0IHRlbXBEYXRhID0gdGhpcy4jcmVhZFJhbmdlKHJlYWRQb3NpdGlvbiwgMSk7CiAgICAgICAgY29uc3QgdHlwZSA9IHRlbXBEYXRhWzBdOwogICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgY2FzZSBUWVBFLk5VTEw6CiAgICAgICAgICBjYXNlIFRZUEUuRkFMU0U6CiAgICAgICAgICBjYXNlIFRZUEUuVFJVRToKICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICBjYXNlIFRZUEUuSU5UOgogICAgICAgICAgY2FzZSBUWVBFLkZMT0FUOgogICAgICAgICAgY2FzZSBUWVBFLkRBVEU6CiAgICAgICAgICBjYXNlIFRZUEUuUE9JTlRFUjoKICAgICAgICAgICAgcmV0dXJuIDEgKyA4OwogICAgICAgICAgY2FzZSBUWVBFLk9JRDoKICAgICAgICAgICAgcmV0dXJuIDEgKyAxMjsKICAgICAgICAgIGNhc2UgVFlQRS5TVFJJTkc6IHsKICAgICAgICAgICAgdGVtcERhdGEgPSB0aGlzLiNyZWFkUmFuZ2UocmVhZFBvc2l0aW9uICsgMSwgNCk7CiAgICAgICAgICAgIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcodGVtcERhdGEuYnVmZmVyLCB0ZW1wRGF0YS5ieXRlT2Zmc2V0LCA0KTsKICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gdmlldy5nZXRVaW50MzIoMCwgdHJ1ZSk7CiAgICAgICAgICAgIHJldHVybiAxICsgNCArIGxlbmd0aDsKICAgICAgICAgIH0KICAgICAgICAgIGNhc2UgVFlQRS5CSU5BUlk6IHsKICAgICAgICAgICAgdGVtcERhdGEgPSB0aGlzLiNyZWFkUmFuZ2UocmVhZFBvc2l0aW9uICsgMSwgNCk7CiAgICAgICAgICAgIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcodGVtcERhdGEuYnVmZmVyLCB0ZW1wRGF0YS5ieXRlT2Zmc2V0LCA0KTsKICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gdmlldy5nZXRVaW50MzIoMCwgdHJ1ZSk7CiAgICAgICAgICAgIHJldHVybiAxICsgNCArIGxlbmd0aDsKICAgICAgICAgIH0KICAgICAgICAgIGNhc2UgVFlQRS5BUlJBWTogewogICAgICAgICAgICB0ZW1wRGF0YSA9IHRoaXMuI3JlYWRSYW5nZShyZWFkUG9zaXRpb24gKyAxLCA0KTsKICAgICAgICAgICAgY29uc3QgdmlldyA9IG5ldyBEYXRhVmlldyh0ZW1wRGF0YS5idWZmZXIsIHRlbXBEYXRhLmJ5dGVPZmZzZXQsIDQpOwogICAgICAgICAgICBjb25zdCBzaXplID0gdmlldy5nZXRVaW50MzIoMCwgdHJ1ZSk7CiAgICAgICAgICAgIHJldHVybiAxICsgNCArIHNpemU7CiAgICAgICAgICB9CiAgICAgICAgICBjYXNlIFRZUEUuT0JKRUNUOiB7CiAgICAgICAgICAgIHRlbXBEYXRhID0gdGhpcy4jcmVhZFJhbmdlKHJlYWRQb3NpdGlvbiArIDEsIDQpOwogICAgICAgICAgICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KHRlbXBEYXRhLmJ1ZmZlciwgdGVtcERhdGEuYnl0ZU9mZnNldCwgNCk7CiAgICAgICAgICAgIGNvbnN0IHNpemUgPSB2aWV3LmdldFVpbnQzMigwLCB0cnVlKTsKICAgICAgICAgICAgcmV0dXJuIDEgKyA0ICsgc2l6ZTsKICAgICAgICAgIH0KICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biB0eXBlIGJ5dGU6IDB4JHt0eXBlLnRvU3RyaW5nKDE2KX1gKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIGNvbnN0IHZhbHVlU2l6ZSA9IGdldFZhbHVlU2l6ZShvZmZzZXQpOwogICAgICBjb25zdCB2YWx1ZURhdGEgPSB0aGlzLiNyZWFkUmFuZ2Uob2Zmc2V0LCB2YWx1ZVNpemUpOwogICAgICBvZmZzZXQgKz0gdmFsdWVTaXplOwogICAgICB5aWVsZCBkZWNvZGUodmFsdWVEYXRhKTsKICAgIH0KICB9Cn0KZnVuY3Rpb24gdmFsdWVzRXF1YWwkMShhLCBiKSB7CiAgaWYgKGEgaW5zdGFuY2VvZiBPYmplY3RJZCB8fCBiIGluc3RhbmNlb2YgT2JqZWN0SWQpIHsKICAgIGlmIChhIGluc3RhbmNlb2YgT2JqZWN0SWQgJiYgYiBpbnN0YW5jZW9mIE9iamVjdElkKSB7CiAgICAgIHJldHVybiBhLmVxdWFscyhiKTsKICAgIH0KICAgIGlmIChhIGluc3RhbmNlb2YgT2JqZWN0SWQgJiYgdHlwZW9mIGIgPT09ICJzdHJpbmciKSB7CiAgICAgIHJldHVybiBhLmVxdWFscyhiKTsKICAgIH0KICAgIGlmIChiIGluc3RhbmNlb2YgT2JqZWN0SWQgJiYgdHlwZW9mIGEgPT09ICJzdHJpbmciKSB7CiAgICAgIHJldHVybiBiLmVxdWFscyhhKTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CiAgcmV0dXJuIGEgPT0gYjsKfQpmdW5jdGlvbiBjb3B5KG8pIHsKICBpZiAobyBpbnN0YW5jZW9mIE9iamVjdElkKSB7CiAgICByZXR1cm4gbmV3IE9iamVjdElkKG8uaWQpOwogIH0KICB2YXIgb3V0LCB2LCBrZXk7CiAgb3V0ID0gQXJyYXkuaXNBcnJheShvKSA/IFtdIDoge307CiAgZm9yIChrZXkgaW4gbykgewogICAgdiA9IG9ba2V5XTsKICAgIG91dFtrZXldID0gdHlwZW9mIHYgPT09ICJvYmplY3QiICYmIHYgIT09IG51bGwgPyBjb3B5KHYpIDogdjsKICB9CiAgcmV0dXJuIG91dDsKfQpmdW5jdGlvbiBnZXRQcm9wKG9iaiwgbmFtZSkgewogIHZhciBwYXRoID0gbmFtZS5zcGxpdCgiLiIpOwogIHZhciByZXN1bHQgPSBvYmpbcGF0aFswXV07CiAgZm9yICh2YXIgaSA9IDE7IGkgPCBwYXRoLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAocmVzdWx0ID09IHZvaWQgMCB8fCByZXN1bHQgPT0gbnVsbCkgcmV0dXJuIHJlc3VsdDsKICAgIHZhciBwYXRoU2VnbWVudCA9IHBhdGhbaV07CiAgICB2YXIgbnVtZXJpY0luZGV4ID0gcGFyc2VJbnQocGF0aFNlZ21lbnQsIDEwKTsKICAgIGlmIChpc0FycmF5KHJlc3VsdCkgJiYgIWlzTmFOKG51bWVyaWNJbmRleCkgJiYgbnVtZXJpY0luZGV4ID49IDAgJiYgbnVtZXJpY0luZGV4IDwgcmVzdWx0Lmxlbmd0aCkgewogICAgICByZXN1bHQgPSByZXN1bHRbbnVtZXJpY0luZGV4XTsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3VsdCA9IHJlc3VsdFtwYXRoU2VnbWVudF07CiAgICB9CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KZnVuY3Rpb24gZ2V0RmllbGRWYWx1ZXMob2JqLCBuYW1lKSB7CiAgdmFyIHBhdGggPSBuYW1lLnNwbGl0KCIuIik7CiAgdmFyIHJlc3VsdHMgPSBbb2JqXTsKICBmb3IgKHZhciBpID0gMDsgaSA8IHBhdGgubGVuZ3RoOyBpKyspIHsKICAgIHZhciBwYXRoU2VnbWVudCA9IHBhdGhbaV07CiAgICB2YXIgbnVtZXJpY0luZGV4ID0gcGFyc2VJbnQocGF0aFNlZ21lbnQsIDEwKTsKICAgIHZhciBuZXdSZXN1bHRzID0gW107CiAgICBmb3IgKHZhciBqID0gMDsgaiA8IHJlc3VsdHMubGVuZ3RoOyBqKyspIHsKICAgICAgdmFyIGN1cnJlbnQgPSByZXN1bHRzW2pdOwogICAgICBpZiAoY3VycmVudCA9PSB2b2lkIDAgfHwgY3VycmVudCA9PSBudWxsKSBjb250aW51ZTsKICAgICAgaWYgKGlzQXJyYXkoY3VycmVudCkgJiYgIWlzTmFOKG51bWVyaWNJbmRleCkgJiYgbnVtZXJpY0luZGV4ID49IDApIHsKICAgICAgICBpZiAobnVtZXJpY0luZGV4IDwgY3VycmVudC5sZW5ndGgpIHsKICAgICAgICAgIG5ld1Jlc3VsdHMucHVzaChjdXJyZW50W251bWVyaWNJbmRleF0pOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChpc0FycmF5KGN1cnJlbnQpKSB7CiAgICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCBjdXJyZW50Lmxlbmd0aDsgaysrKSB7CiAgICAgICAgICBpZiAoY3VycmVudFtrXSAhPSB2b2lkIDAgJiYgY3VycmVudFtrXSAhPSBudWxsICYmIHR5cGVvZiBjdXJyZW50W2tdID09PSAib2JqZWN0IikgewogICAgICAgICAgICBuZXdSZXN1bHRzLnB1c2goY3VycmVudFtrXVtwYXRoU2VnbWVudF0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICh0eXBlb2YgY3VycmVudCA9PT0gIm9iamVjdCIpIHsKICAgICAgICBuZXdSZXN1bHRzLnB1c2goY3VycmVudFtwYXRoU2VnbWVudF0pOwogICAgICB9CiAgICB9CiAgICByZXN1bHRzID0gbmV3UmVzdWx0czsKICB9CiAgcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKGZ1bmN0aW9uKHYpIHsKICAgIHJldHVybiB2ICE9PSB2b2lkIDA7CiAgfSk7CiAgaWYgKHJlc3VsdHMubGVuZ3RoID09PSAwKSByZXR1cm4gdm9pZCAwOwogIGlmIChyZXN1bHRzLmxlbmd0aCA9PT0gMSkgcmV0dXJuIHJlc3VsdHNbMF07CiAgcmV0dXJuIHJlc3VsdHM7Cn0KZnVuY3Rpb24gc2V0UHJvcChvYmosIG5hbWUsIHZhbHVlKSB7CiAgaWYgKG5hbWUuaW5kZXhPZigiJFtdIikgIT09IC0xKSB7CiAgICByZXR1cm4gc2V0UHJvcFdpdGhBbGxQb3NpdGlvbmFsKG9iaiwgbmFtZSwgdmFsdWUpOwogIH0KICB2YXIgcGF0aCA9IG5hbWUuc3BsaXQoIi4iKTsKICB2YXIgY3VycmVudCA9IG9iajsKICBmb3IgKHZhciBpID0gMDsgaSA8IHBhdGgubGVuZ3RoIC0gMTsgaSsrKSB7CiAgICB2YXIgcGF0aFNlZ21lbnQgPSBwYXRoW2ldOwogICAgdmFyIG51bWVyaWNJbmRleCA9IHBhcnNlSW50KHBhdGhTZWdtZW50LCAxMCk7CiAgICBpZiAoaXNBcnJheShjdXJyZW50KSAmJiAhaXNOYU4obnVtZXJpY0luZGV4KSAmJiBudW1lcmljSW5kZXggPj0gMCkgewogICAgICB3aGlsZSAoY3VycmVudC5sZW5ndGggPD0gbnVtZXJpY0luZGV4KSB7CiAgICAgICAgY3VycmVudC5wdXNoKHZvaWQgMCk7CiAgICAgIH0KICAgICAgaWYgKGN1cnJlbnRbbnVtZXJpY0luZGV4XSA9PSB2b2lkIDAgfHwgY3VycmVudFtudW1lcmljSW5kZXhdID09IG51bGwpIHsKICAgICAgICB2YXIgbmV4dFNlZ21lbnQgPSBwYXRoW2kgKyAxXTsKICAgICAgICB2YXIgbmV4dE51bWVyaWMgPSBwYXJzZUludChuZXh0U2VnbWVudCwgMTApOwogICAgICAgIGlmICghaXNOYU4obmV4dE51bWVyaWMpICYmIG5leHROdW1lcmljID49IDApIHsKICAgICAgICAgIGN1cnJlbnRbbnVtZXJpY0luZGV4XSA9IFtdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjdXJyZW50W251bWVyaWNJbmRleF0gPSB7fTsKICAgICAgICB9CiAgICAgIH0KICAgICAgY3VycmVudCA9IGN1cnJlbnRbbnVtZXJpY0luZGV4XTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChjdXJyZW50W3BhdGhTZWdtZW50XSA9PSB2b2lkIDAgfHwgY3VycmVudFtwYXRoU2VnbWVudF0gPT0gbnVsbCkgewogICAgICAgIHZhciBuZXh0U2VnbWVudCA9IHBhdGhbaSArIDFdOwogICAgICAgIHZhciBuZXh0TnVtZXJpYyA9IHBhcnNlSW50KG5leHRTZWdtZW50LCAxMCk7CiAgICAgICAgaWYgKCFpc05hTihuZXh0TnVtZXJpYykgJiYgbmV4dE51bWVyaWMgPj0gMCkgewogICAgICAgICAgY3VycmVudFtwYXRoU2VnbWVudF0gPSBbXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY3VycmVudFtwYXRoU2VnbWVudF0gPSB7fTsKICAgICAgICB9CiAgICAgIH0KICAgICAgY3VycmVudCA9IGN1cnJlbnRbcGF0aFNlZ21lbnRdOwogICAgfQogIH0KICB2YXIgbGFzdFNlZ21lbnQgPSBwYXRoW3BhdGgubGVuZ3RoIC0gMV07CiAgdmFyIGxhc3ROdW1lcmljSW5kZXggPSBwYXJzZUludChsYXN0U2VnbWVudCwgMTApOwogIGlmIChpc0FycmF5KGN1cnJlbnQpICYmICFpc05hTihsYXN0TnVtZXJpY0luZGV4KSAmJiBsYXN0TnVtZXJpY0luZGV4ID49IDApIHsKICAgIHdoaWxlIChjdXJyZW50Lmxlbmd0aCA8PSBsYXN0TnVtZXJpY0luZGV4KSB7CiAgICAgIGN1cnJlbnQucHVzaCh2b2lkIDApOwogICAgfQogICAgY3VycmVudFtsYXN0TnVtZXJpY0luZGV4XSA9IHZhbHVlOwogIH0gZWxzZSB7CiAgICBjdXJyZW50W2xhc3RTZWdtZW50XSA9IHZhbHVlOwogIH0KfQpmdW5jdGlvbiBzZXRQcm9wV2l0aEFsbFBvc2l0aW9uYWwob2JqLCBuYW1lLCB2YWx1ZSkgewogIHZhciBwYXRoID0gbmFtZS5zcGxpdCgiLiIpOwogIHZhciBjdXJyZW50ID0gb2JqOwogIGZvciAodmFyIGkgPSAwOyBpIDwgcGF0aC5sZW5ndGg7IGkrKykgewogICAgdmFyIHBhdGhTZWdtZW50ID0gcGF0aFtpXTsKICAgIGlmIChwYXRoU2VnbWVudCA9PT0gIiRbXSIpIHsKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGN1cnJlbnQpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgcG9zaXRpb25hbCBvcGVyYXRvciBkaWQgbm90IGZpbmQgdGhlIG1hdGNoIG5lZWRlZCBmcm9tIHRoZSBxdWVyeS4iKTsKICAgICAgfQogICAgICB2YXIgcmVtYWluaW5nUGF0aCA9IHBhdGguc2xpY2UoaSArIDEpLmpvaW4oIi4iKTsKICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBjdXJyZW50Lmxlbmd0aDsgaisrKSB7CiAgICAgICAgaWYgKHJlbWFpbmluZ1BhdGgpIHsKICAgICAgICAgIHNldFByb3AoY3VycmVudFtqXSwgcmVtYWluaW5nUGF0aCwgdmFsdWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjdXJyZW50W2pdID0gdmFsdWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBudW1lcmljSW5kZXggPSBwYXJzZUludChwYXRoU2VnbWVudCwgMTApOwogICAgaWYgKGlzQXJyYXkoY3VycmVudCkgJiYgIWlzTmFOKG51bWVyaWNJbmRleCkgJiYgbnVtZXJpY0luZGV4ID49IDApIHsKICAgICAgY3VycmVudCA9IGN1cnJlbnRbbnVtZXJpY0luZGV4XTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChjdXJyZW50W3BhdGhTZWdtZW50XSA9PSB2b2lkIDAgfHwgY3VycmVudFtwYXRoU2VnbWVudF0gPT0gbnVsbCkgewogICAgICAgIHZhciBuZXh0U2VnbWVudCA9IGkgKyAxIDwgcGF0aC5sZW5ndGggPyBwYXRoW2kgKyAxXSA6IG51bGw7CiAgICAgICAgaWYgKG5leHRTZWdtZW50ID09PSAiJFtdIikgewogICAgICAgICAgY3VycmVudFtwYXRoU2VnbWVudF0gPSBbXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIG5leHROdW1lcmljID0gcGFyc2VJbnQobmV4dFNlZ21lbnQsIDEwKTsKICAgICAgICAgIGlmICghaXNOYU4obmV4dE51bWVyaWMpICYmIG5leHROdW1lcmljID49IDApIHsKICAgICAgICAgICAgY3VycmVudFtwYXRoU2VnbWVudF0gPSBbXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGN1cnJlbnRbcGF0aFNlZ21lbnRdID0ge307CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGN1cnJlbnQgPSBjdXJyZW50W3BhdGhTZWdtZW50XTsKICAgIH0KICB9Cn0KZnVuY3Rpb24gaXNBcnJheShvKSB7CiAgcmV0dXJuIEFycmF5ID09IG8uY29uc3RydWN0b3I7Cn0KZnVuY3Rpb24gdG9BcnJheShvYmopIHsKICB2YXIgYXJyID0gW107CiAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgIHZhciBlbCA9IHt9OwogICAgICBlbFtrZXldID0gb2JqW2tleV07CiAgICAgIGFyci5wdXNoKGVsKTsKICAgIH0KICB9CiAgcmV0dXJuIGFycjsKfQpmdW5jdGlvbiBpc0luKHZhbCwgdmFsdWVzKSB7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCB2YWx1ZXMubGVuZ3RoOyBpKyspIHsKICAgIGlmICh2YWx1ZXNFcXVhbCQxKHZhbHVlc1tpXSwgdmFsKSkgcmV0dXJuIHRydWU7CiAgfQogIHJldHVybiBmYWxzZTsKfQpmdW5jdGlvbiBhcnJheU1hdGNoZXMoeCwgeSkgewogIGlmICh4Lmxlbmd0aCAhPSB5Lmxlbmd0aCkgcmV0dXJuIGZhbHNlOwogIGZvciAodmFyIGkgPSAwOyBpIDwgeC5sZW5ndGg7IGkrKykgewogICAgaWYgKHZhbHVlc0VxdWFsJDEoeFtpXSwgeVtpXSkpIGNvbnRpbnVlOwogICAgaWYgKHR5cGVvZiB4W2ldICE9IHR5cGVvZiB5W2ldKSByZXR1cm4gZmFsc2U7CiAgICBpZiAodHlwZW9mIHhbaV0gPT0gIm9iamVjdCIgJiYgeFtpXSAhPT0gbnVsbCkgewogICAgICBpZiAoaXNBcnJheSh4W2ldKSkgewogICAgICAgIGlmICghYXJyYXlNYXRjaGVzKHhbaV0sIHlbaV0pKSByZXR1cm4gZmFsc2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKCFvYmplY3RNYXRjaGVzKHhbaV0sIHlbaV0pKSByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmICghdmFsdWVzRXF1YWwkMSh4W2ldLCB5W2ldKSkgcmV0dXJuIGZhbHNlOwogICAgfQogIH0KICByZXR1cm4gdHJ1ZTsKfQpmdW5jdGlvbiBvYmplY3RNYXRjaGVzKHgsIHkpIHsKICBmb3IgKHZhciBwIGluIHgpIHsKICAgIGlmICgheC5oYXNPd25Qcm9wZXJ0eShwKSkgY29udGludWU7CiAgICBpZiAoIXkuaGFzT3duUHJvcGVydHkocCkpIHJldHVybiBmYWxzZTsKICAgIGlmICh2YWx1ZXNFcXVhbCQxKHhbcF0sIHlbcF0pKSBjb250aW51ZTsKICAgIGlmICh0eXBlb2YgeFtwXSAhPSB0eXBlb2YgeVtwXSkgcmV0dXJuIGZhbHNlOwogICAgaWYgKHR5cGVvZiB4W3BdID09ICJvYmplY3QiICYmIHhbcF0gIT09IG51bGwpIHsKICAgICAgaWYgKGlzQXJyYXkoeFtwXSkpIHsKICAgICAgICBpZiAoIWFycmF5TWF0Y2hlcyh4W3BdLCB5W3BdKSkgcmV0dXJuIGZhbHNlOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICghb2JqZWN0TWF0Y2hlcyh4W3BdLCB5W3BdKSkgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAoIXZhbHVlc0VxdWFsJDEoeFtwXSwgeVtwXSkpIHJldHVybiBmYWxzZTsKICAgIH0KICB9CiAgZm9yICh2YXIgcCBpbiB5KSB7CiAgICBpZiAoeS5oYXNPd25Qcm9wZXJ0eShwKSAmJiAheC5oYXNPd25Qcm9wZXJ0eShwKSkgcmV0dXJuIGZhbHNlOwogIH0KICByZXR1cm4gdHJ1ZTsKfQpmdW5jdGlvbiBhcHBseVByb2plY3Rpb24ocHJvamVjdGlvbiwgZG9jKSB7CiAgdmFyIHJlc3VsdCA9IHt9OwogIHZhciBrZXlzID0gT2JqZWN0LmtleXMocHJvamVjdGlvbik7CiAgaWYgKGtleXMubGVuZ3RoID09IDApIHJldHVybiBkb2M7CiAgdmFyIGhhc0luY2x1c2lvbiA9IGZhbHNlOwogIHZhciBoYXNFeGNsdXNpb24gPSBmYWxzZTsKICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgIGlmIChrZXlzW2ldID09PSAiX2lkIikgY29udGludWU7CiAgICBpZiAocHJvamVjdGlvbltrZXlzW2ldXSkgaGFzSW5jbHVzaW9uID0gdHJ1ZTsKICAgIGVsc2UgaGFzRXhjbHVzaW9uID0gdHJ1ZTsKICB9CiAgaWYgKGhhc0luY2x1c2lvbiAmJiBoYXNFeGNsdXNpb24pIHsKICAgIHRocm93IHsgJGVycjogIkNhbid0IGNhbm9uaWNhbGl6ZSBxdWVyeTogQmFkVmFsdWUgUHJvamVjdGlvbiBjYW5ub3QgaGF2ZSBhIG1peCBvZiBpbmNsdXNpb24gYW5kIGV4Y2x1c2lvbi4iLCBjb2RlOiAxNzI4NyB9OwogIH0KICBpZiAocHJvamVjdGlvbltrZXlzWzBdXSB8fCBoYXNJbmNsdXNpb24pIHsKICAgIGlmIChwcm9qZWN0aW9uLl9pZCAhPT0gMCkgewogICAgICByZXN1bHQuX2lkID0gZG9jLl9pZDsKICAgIH0KICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICBpZiAoa2V5c1tpXSA9PT0gIl9pZCIpIGNvbnRpbnVlOwogICAgICBpZiAoIXByb2plY3Rpb25ba2V5c1tpXV0pIGNvbnRpbnVlOwogICAgICB2YXIgZmllbGRQYXRoID0ga2V5c1tpXTsKICAgICAgdmFyIHZhbHVlID0gZ2V0UHJvcChkb2MsIGZpZWxkUGF0aCk7CiAgICAgIGlmICh2YWx1ZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgc2V0UHJvcChyZXN1bHQsIGZpZWxkUGF0aCwgdmFsdWUpOwogICAgICB9CiAgICB9CiAgfSBlbHNlIHsKICAgIGZvciAodmFyIGtleSBpbiBkb2MpIHsKICAgICAgaWYgKGRvYy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgdmFyIHZhbCA9IGRvY1trZXldOwogICAgICAgIGlmICh0eXBlb2YgdmFsID09PSAib2JqZWN0IiAmJiB2YWwgIT09IG51bGwgJiYgIWlzQXJyYXkodmFsKSkgewogICAgICAgICAgcmVzdWx0W2tleV0gPSBjb3B5KHZhbCk7CiAgICAgICAgfSBlbHNlIGlmIChpc0FycmF5KHZhbCkpIHsKICAgICAgICAgIHJlc3VsdFtrZXldID0gdmFsLnNsaWNlKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdFtrZXldID0gdmFsOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChwcm9qZWN0aW9uW2tleXNbaV1dKSBjb250aW51ZTsKICAgICAgdmFyIGZpZWxkUGF0aCA9IGtleXNbaV07CiAgICAgIHZhciBwYXRoUGFydHMgPSBmaWVsZFBhdGguc3BsaXQoIi4iKTsKICAgICAgaWYgKHBhdGhQYXJ0cy5sZW5ndGggPT09IDEpIHsKICAgICAgICBkZWxldGUgcmVzdWx0W2ZpZWxkUGF0aF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHBhcmVudCA9IHJlc3VsdDsKICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHBhdGhQYXJ0cy5sZW5ndGggLSAxOyBqKyspIHsKICAgICAgICAgIGlmIChwYXJlbnQgPT0gdm9pZCAwIHx8IHBhcmVudCA9PSBudWxsKSBicmVhazsKICAgICAgICAgIHBhcmVudCA9IHBhcmVudFtwYXRoUGFydHNbal1dOwogICAgICAgIH0KICAgICAgICBpZiAocGFyZW50ICE9IHZvaWQgMCAmJiBwYXJlbnQgIT0gbnVsbCkgewogICAgICAgICAgZGVsZXRlIHBhcmVudFtwYXRoUGFydHNbcGF0aFBhcnRzLmxlbmd0aCAtIDFdXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIHJlc3VsdDsKfQpjb25zdCBFcnJvckNvZGVzID0gewogIEJBRF9WQUxVRTogMiwKICBVTktOT1dOX0VSUk9SOiA4LAogIEZBSUxFRF9UT19QQVJTRTogMTcyODcsCiAgLy8gVXNpbmcgdGVzdC1jb21wYXRpYmxlIGVycm9yIGNvZGUKICBOQU1FU1BBQ0VfTk9UX0ZPVU5EOiAyNiwKICBJTkRFWF9OT1RfRk9VTkQ6IDI3LAogIElOREVYX09QVElPTlNfQ09ORkxJQ1Q6IDg1LAogIERVUExJQ0FURV9LRVk6IDExZTMsCiAgLy8gUXVlcnkgZXJyb3JzCiAgQkFEX1FVRVJZOiAyLAogIENBTk5PVF9ET19FWENMVVNJT05fT05fRklFTERfSURfSU5fSU5DTFVTSU9OX1BST0pFQ1RJT046IDMxMjU0LAogIC8vIE5vdCBpbXBsZW1lbnRlZCAoY3VzdG9tIGNvZGUpCiAgTk9UX0lNUExFTUVOVEVEOiA5OTkKfTsKY2xhc3MgTW9uZ29FcnJvciBleHRlbmRzIEVycm9yIHsKICBjb25zdHJ1Y3RvcihtZXNzYWdlLCBvcHRpb25zID0ge30pIHsKICAgIHN1cGVyKG1lc3NhZ2UpOwogICAgdGhpcy5uYW1lID0gIk1vbmdvRXJyb3IiOwogICAgdGhpcy5jb2RlID0gb3B0aW9ucy5jb2RlIHx8IEVycm9yQ29kZXMuVU5LTk9XTl9FUlJPUjsKICAgIHRoaXMuY29kZU5hbWUgPSB0aGlzLl9nZXRDb2RlTmFtZSh0aGlzLmNvZGUpOwogICAgdGhpcy4kZXJyID0gbWVzc2FnZTsKICAgIGlmIChvcHRpb25zLmNvbGxlY3Rpb24pIHRoaXMuY29sbGVjdGlvbiA9IG9wdGlvbnMuY29sbGVjdGlvbjsKICAgIGlmIChvcHRpb25zLmRhdGFiYXNlKSB0aGlzLmRhdGFiYXNlID0gb3B0aW9ucy5kYXRhYmFzZTsKICAgIGlmIChvcHRpb25zLm9wZXJhdGlvbikgdGhpcy5vcGVyYXRpb24gPSBvcHRpb25zLm9wZXJhdGlvbjsKICAgIGlmIChvcHRpb25zLnF1ZXJ5KSB0aGlzLnF1ZXJ5ID0gb3B0aW9ucy5xdWVyeTsKICAgIGlmIChvcHRpb25zLmRvY3VtZW50KSB0aGlzLmRvY3VtZW50ID0gb3B0aW9ucy5kb2N1bWVudDsKICAgIGlmIChvcHRpb25zLmZpZWxkKSB0aGlzLmZpZWxkID0gb3B0aW9ucy5maWVsZDsKICAgIGlmIChvcHRpb25zLmluZGV4KSB0aGlzLmluZGV4ID0gb3B0aW9ucy5pbmRleDsKICAgIGlmIChFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSkgewogICAgICBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSh0aGlzLCB0aGlzLmNvbnN0cnVjdG9yKTsKICAgIH0KICB9CiAgX2dldENvZGVOYW1lKGNvZGUpIHsKICAgIGNvbnN0IGNvZGVUb05hbWUgPSB7CiAgICAgIDA6ICJPSyIsCiAgICAgIDE6ICJJbnRlcm5hbEVycm9yIiwKICAgICAgMjogIkJhZFZhbHVlIiwKICAgICAgNDogIk5vU3VjaEtleSIsCiAgICAgIDU6ICJHcmFwaENvbnRhaW5zQ3ljbGUiLAogICAgICA2OiAiSG9zdFVucmVhY2hhYmxlIiwKICAgICAgNzogIkhvc3ROb3RGb3VuZCIsCiAgICAgIDg6ICJVbmtub3duRXJyb3IiLAogICAgICAxMDogIkNhbm5vdE11dGF0ZU9iamVjdCIsCiAgICAgIDExOiAiVXNlck5vdEZvdW5kIiwKICAgICAgMTI6ICJVbnN1cHBvcnRlZEZvcm1hdCIsCiAgICAgIDEzOiAiVW5hdXRob3JpemVkIiwKICAgICAgMTQ6ICJUeXBlTWlzbWF0Y2giLAogICAgICAxNTogIk92ZXJmbG93IiwKICAgICAgMTY6ICJJbnZhbGlkTGVuZ3RoIiwKICAgICAgMTc6ICJQcm90b2NvbEVycm9yIiwKICAgICAgMTg6ICJBdXRoZW50aWNhdGlvbkZhaWxlZCIsCiAgICAgIDIwOiAiSWxsZWdhbE9wZXJhdGlvbiIsCiAgICAgIDI2OiAiTmFtZXNwYWNlTm90Rm91bmQiLAogICAgICAyNzogIkluZGV4Tm90Rm91bmQiLAogICAgICAyODogIlBhdGhOb3RWaWFibGUiLAogICAgICA0MzogIkN1cnNvck5vdEZvdW5kIiwKICAgICAgNDg6ICJOYW1lc3BhY2VFeGlzdHMiLAogICAgICA1OTogIkNvbW1hbmROb3RGb3VuZCIsCiAgICAgIDY3OiAiQ2Fubm90Q3JlYXRlSW5kZXgiLAogICAgICA2ODogIkluZGV4RXhpc3RzIiwKICAgICAgNzM6ICJJbnZhbGlkTmFtZXNwYWNlIiwKICAgICAgODU6ICJJbmRleE9wdGlvbnNDb25mbGljdCIsCiAgICAgIDExMjogIldyaXRlQ29uZmxpY3QiLAogICAgICAxMjE6ICJEb2N1bWVudFZhbGlkYXRpb25GYWlsdXJlIiwKICAgICAgMTcxOiAiQ2Fubm90SW5kZXhQYXJhbGxlbEFycmF5cyIsCiAgICAgIDE5NzogIkludmFsaWRJbmRleFNwZWNpZmljYXRpb25PcHRpb24iLAogICAgICA5OTg6ICJPcGVyYXRpb25Ob3RTdXBwb3J0ZWQiLAogICAgICA5OTk6ICJOb3RJbXBsZW1lbnRlZCIsCiAgICAgIDExZTM6ICJEdXBsaWNhdGVLZXkiLAogICAgICAxMTAwMTogIkR1cGxpY2F0ZUtleVVwZGF0ZSIsCiAgICAgIDE3Mjg3OiAiRmFpbGVkVG9QYXJzZSIKICAgIH07CiAgICByZXR1cm4gY29kZVRvTmFtZVtjb2RlXSB8fCAiVW5rbm93bkVycm9yIjsKICB9CiAgdG9KU09OKCkgewogICAgY29uc3QganNvbiA9IHsKICAgICAgbmFtZTogdGhpcy5uYW1lLAogICAgICBtZXNzYWdlOiB0aGlzLm1lc3NhZ2UsCiAgICAgIGNvZGU6IHRoaXMuY29kZSwKICAgICAgY29kZU5hbWU6IHRoaXMuY29kZU5hbWUKICAgIH07CiAgICBpZiAodGhpcy5jb2xsZWN0aW9uKSBqc29uLmNvbGxlY3Rpb24gPSB0aGlzLmNvbGxlY3Rpb247CiAgICBpZiAodGhpcy5kYXRhYmFzZSkganNvbi5kYXRhYmFzZSA9IHRoaXMuZGF0YWJhc2U7CiAgICBpZiAodGhpcy5vcGVyYXRpb24pIGpzb24ub3BlcmF0aW9uID0gdGhpcy5vcGVyYXRpb247CiAgICBpZiAodGhpcy5pbmRleCkganNvbi5pbmRleCA9IHRoaXMuaW5kZXg7CiAgICBpZiAodGhpcy5pbmRleE5hbWUpIGpzb24uaW5kZXhOYW1lID0gdGhpcy5pbmRleE5hbWU7CiAgICBpZiAodGhpcy5maWVsZCkganNvbi5maWVsZCA9IHRoaXMuZmllbGQ7CiAgICBpZiAodGhpcy5xdWVyeSkganNvbi5xdWVyeSA9IHRoaXMucXVlcnk7CiAgICBpZiAodGhpcy5kb2N1bWVudCkganNvbi5kb2N1bWVudCA9IHRoaXMuZG9jdW1lbnQ7CiAgICBpZiAodGhpcy5uYW1lc3BhY2UpIGpzb24ubmFtZXNwYWNlID0gdGhpcy5uYW1lc3BhY2U7CiAgICBpZiAodGhpcy5jdXJzb3JJZCkganNvbi5jdXJzb3JJZCA9IHRoaXMuY3Vyc29ySWQ7CiAgICBpZiAodGhpcy5mZWF0dXJlKSBqc29uLmZlYXR1cmUgPSB0aGlzLmZlYXR1cmU7CiAgICBpZiAodGhpcy5rZXlQYXR0ZXJuKSBqc29uLmtleVBhdHRlcm4gPSB0aGlzLmtleVBhdHRlcm47CiAgICBpZiAodGhpcy5rZXlWYWx1ZSkganNvbi5rZXlWYWx1ZSA9IHRoaXMua2V5VmFsdWU7CiAgICBpZiAodGhpcy53cml0ZUVycm9ycykganNvbi53cml0ZUVycm9ycyA9IHRoaXMud3JpdGVFcnJvcnM7CiAgICByZXR1cm4ganNvbjsKICB9Cn0KY2xhc3MgSW5kZXhFcnJvciBleHRlbmRzIE1vbmdvRXJyb3IgewogIGNvbnN0cnVjdG9yKG1lc3NhZ2UsIG9wdGlvbnMgPSB7fSkgewogICAgc3VwZXIobWVzc2FnZSwgb3B0aW9ucyk7CiAgICB0aGlzLm5hbWUgPSAiSW5kZXhFcnJvciI7CiAgfQp9CmNsYXNzIEluZGV4Tm90Rm91bmRFcnJvciBleHRlbmRzIEluZGV4RXJyb3IgewogIGNvbnN0cnVjdG9yKGluZGV4TmFtZSwgb3B0aW9ucyA9IHt9KSB7CiAgICBzdXBlcihgSW5kZXggJyR7aW5kZXhOYW1lfScgbm90IGZvdW5kYCwgewogICAgICAuLi5vcHRpb25zLAogICAgICBjb2RlOiBFcnJvckNvZGVzLklOREVYX05PVF9GT1VORCwKICAgICAgaW5kZXg6IGluZGV4TmFtZQogICAgfSk7CiAgICB0aGlzLm5hbWUgPSAiSW5kZXhOb3RGb3VuZEVycm9yIjsKICAgIHRoaXMuaW5kZXhOYW1lID0gaW5kZXhOYW1lOwogIH0KfQpjbGFzcyBRdWVyeUVycm9yIGV4dGVuZHMgTW9uZ29FcnJvciB7CiAgY29uc3RydWN0b3IobWVzc2FnZSwgb3B0aW9ucyA9IHt9KSB7CiAgICBzdXBlcihtZXNzYWdlLCBvcHRpb25zKTsKICAgIHRoaXMubmFtZSA9ICJRdWVyeUVycm9yIjsKICAgIHRoaXMuY29kZSA9IG9wdGlvbnMuY29kZSB8fCBFcnJvckNvZGVzLkJBRF9RVUVSWTsKICB9Cn0KY2xhc3MgTm90SW1wbGVtZW50ZWRFcnJvciBleHRlbmRzIE1vbmdvRXJyb3IgewogIGNvbnN0cnVjdG9yKGZlYXR1cmUsIG9wdGlvbnMgPSB7fSkgewogICAgc3VwZXIoYCR7ZmVhdHVyZX0gaXMgbm90IGltcGxlbWVudGVkIGluIG1pY3JvLW1vbmdvYCwgewogICAgICAuLi5vcHRpb25zLAogICAgICBjb2RlOiBFcnJvckNvZGVzLk5PVF9JTVBMRU1FTlRFRAogICAgfSk7CiAgICB0aGlzLm5hbWUgPSAiTm90SW1wbGVtZW50ZWRFcnJvciI7CiAgICB0aGlzLmZlYXR1cmUgPSBmZWF0dXJlOwogIH0KfQpjbGFzcyBCYWRWYWx1ZUVycm9yIGV4dGVuZHMgTW9uZ29FcnJvciB7CiAgY29uc3RydWN0b3IoZmllbGQsIHZhbHVlLCByZWFzb24sIG9wdGlvbnMgPSB7fSkgewogICAgc3VwZXIoYEJhZCB2YWx1ZSBmb3IgZmllbGQgJyR7ZmllbGR9JzogJHtyZWFzb259YCwgewogICAgICAuLi5vcHRpb25zLAogICAgICBjb2RlOiBFcnJvckNvZGVzLkJBRF9WQUxVRSwKICAgICAgZmllbGQKICAgIH0pOwogICAgdGhpcy5uYW1lID0gIkJhZFZhbHVlRXJyb3IiOwogICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogIH0KfQpjbGFzcyBDdXJzb3IgewogIGNvbnN0cnVjdG9yKGNvbGxlY3Rpb24sIHF1ZXJ5LCBwcm9qZWN0aW9uLCBkb2N1bWVudHNPclByb21pc2UsIFNvcnRlZEN1cnNvcjIpIHsKICAgIHRoaXMuY29sbGVjdGlvbiA9IGNvbGxlY3Rpb247CiAgICB0aGlzLnF1ZXJ5ID0gcXVlcnk7CiAgICB0aGlzLnByb2plY3Rpb24gPSBwcm9qZWN0aW9uOwogICAgdGhpcy5fZG9jdW1lbnRzUHJvbWlzZSA9IGRvY3VtZW50c09yUHJvbWlzZSBpbnN0YW5jZW9mIFByb21pc2UgPyBkb2N1bWVudHNPclByb21pc2UgOiBQcm9taXNlLnJlc29sdmUoZG9jdW1lbnRzT3JQcm9taXNlKTsKICAgIHRoaXMuZG9jdW1lbnRzID0gbnVsbDsKICAgIHRoaXMuX2luaXRpYWxpemVkID0gZmFsc2U7CiAgICB0aGlzLlNvcnRlZEN1cnNvciA9IFNvcnRlZEN1cnNvcjI7CiAgICBpZiAocHJvamVjdGlvbiAmJiBPYmplY3Qua2V5cyhwcm9qZWN0aW9uKS5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhwcm9qZWN0aW9uKTsKICAgICAgbGV0IGhhc0luY2x1c2lvbiA9IGZhbHNlOwogICAgICBsZXQgaGFzRXhjbHVzaW9uID0gZmFsc2U7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChrZXlzW2ldID09PSAiX2lkIikgY29udGludWU7CiAgICAgICAgaWYgKHByb2plY3Rpb25ba2V5c1tpXV0pIGhhc0luY2x1c2lvbiA9IHRydWU7CiAgICAgICAgZWxzZSBoYXNFeGNsdXNpb24gPSB0cnVlOwogICAgICB9CiAgICAgIGlmIChoYXNJbmNsdXNpb24gJiYgaGFzRXhjbHVzaW9uKSB7CiAgICAgICAgdGhyb3cgbmV3IFF1ZXJ5RXJyb3IoIkNhbid0IGNhbm9uaWNhbGl6ZSBxdWVyeTogQmFkVmFsdWUgUHJvamVjdGlvbiBjYW5ub3QgaGF2ZSBhIG1peCBvZiBpbmNsdXNpb24gYW5kIGV4Y2x1c2lvbi4iLCB7CiAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLkZBSUxFRF9UT19QQVJTRSwKICAgICAgICAgIGNvbGxlY3Rpb246IGNvbGxlY3Rpb24ubmFtZQogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgICB0aGlzLnBvcyA9IDA7CiAgICB0aGlzLl9saW1pdCA9IDA7CiAgICB0aGlzLl9za2lwID0gMDsKICAgIHRoaXMuX2Nsb3NlZCA9IGZhbHNlOwogIH0KICAvKioKICAgKiBFbnN1cmUgZG9jdW1lbnRzIGFyZSBsb2FkZWQgZnJvbSB0aGUgcHJvbWlzZQogICAqIEBwcml2YXRlCiAgICovCiAgYXN5bmMgX2Vuc3VyZUluaXRpYWxpemVkKCkgewogICAgaWYgKCF0aGlzLl9pbml0aWFsaXplZCkgewogICAgICB0aGlzLmRvY3VtZW50cyA9IGF3YWl0IHRoaXMuX2RvY3VtZW50c1Byb21pc2U7CiAgICAgIHRoaXMuX2luaXRpYWxpemVkID0gdHJ1ZTsKICAgIH0KICB9CiAgYmF0Y2hTaXplKHNpemUpIHsKICAgIHRoaXMuX2JhdGNoU2l6ZSA9IHNpemU7CiAgICByZXR1cm4gdGhpczsKICB9CiAgY2xvc2UoKSB7CiAgICB0aGlzLl9jbG9zZWQgPSB0cnVlOwogICAgaWYgKHRoaXMuZG9jdW1lbnRzKSB7CiAgICAgIHRoaXMucG9zID0gdGhpcy5kb2N1bWVudHMubGVuZ3RoOwogICAgfQogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgY29tbWVudChjb21tZW50U3RyaW5nKSB7CiAgICB0aGlzLl9jb21tZW50ID0gY29tbWVudFN0cmluZzsKICAgIHJldHVybiB0aGlzOwogIH0KICBhc3luYyBjb3VudCgpIHsKICAgIGF3YWl0IHRoaXMuX2Vuc3VyZUluaXRpYWxpemVkKCk7CiAgICByZXR1cm4gdGhpcy5kb2N1bWVudHMubGVuZ3RoOwogIH0KICBleHBsYWluKHZlcmJvc2l0eSA9ICJxdWVyeVBsYW5uZXIiKSB7CiAgICByZXR1cm4gewogICAgICBxdWVyeVBsYW5uZXI6IHsKICAgICAgICBwbGFubmVyVmVyc2lvbjogMSwKICAgICAgICBuYW1lc3BhY2U6IGAke3RoaXMuY29sbGVjdGlvbi5kYj8ubmFtZSB8fCAiZGIifS4ke3RoaXMuY29sbGVjdGlvbi5uYW1lfWAsCiAgICAgICAgaW5kZXhGaWx0ZXJTZXQ6IGZhbHNlLAogICAgICAgIHBhcnNlZFF1ZXJ5OiB0aGlzLnF1ZXJ5LAogICAgICAgIHdpbm5pbmdQbGFuOiB7CiAgICAgICAgICBzdGFnZTogIkNPTExTQ0FOIiwKICAgICAgICAgIGZpbHRlcjogdGhpcy5xdWVyeSwKICAgICAgICAgIGRpcmVjdGlvbjogImZvcndhcmQiCiAgICAgICAgfQogICAgICB9LAogICAgICBleGVjdXRpb25TdGF0czogdmVyYm9zaXR5ID09PSAiZXhlY3V0aW9uU3RhdHMiIHx8IHZlcmJvc2l0eSA9PT0gImFsbFBsYW5zRXhlY3V0aW9uIiA/IHsKICAgICAgICBleGVjdXRpb25TdWNjZXNzOiB0cnVlLAogICAgICAgIG5SZXR1cm5lZDogdGhpcy5kb2N1bWVudHMgPyB0aGlzLmRvY3VtZW50cy5sZW5ndGggOiAwLAogICAgICAgIGV4ZWN1dGlvblRpbWVNaWxsaXM6IDAsCiAgICAgICAgdG90YWxLZXlzRXhhbWluZWQ6IDAsCiAgICAgICAgdG90YWxEb2NzRXhhbWluZWQ6IHRoaXMuZG9jdW1lbnRzID8gdGhpcy5kb2N1bWVudHMubGVuZ3RoIDogMAogICAgICB9IDogdm9pZCAwLAogICAgICBvazogMQogICAgfTsKICB9CiAgYXN5bmMgZm9yRWFjaChmbikgewogICAgYXdhaXQgdGhpcy5fZW5zdXJlSW5pdGlhbGl6ZWQoKTsKICAgIHdoaWxlIChhd2FpdCB0aGlzLmhhc05leHQoKSkgewogICAgICBhd2FpdCBmbihhd2FpdCB0aGlzLm5leHQoKSk7CiAgICB9CiAgfQogIGFzeW5jIGhhc05leHQoKSB7CiAgICBpZiAodGhpcy5fY2xvc2VkKSByZXR1cm4gZmFsc2U7CiAgICBhd2FpdCB0aGlzLl9lbnN1cmVJbml0aWFsaXplZCgpOwogICAgaWYgKHRoaXMucG9zID09PSAwICYmIHRoaXMuX3NraXAgPiAwKSB7CiAgICAgIHRoaXMucG9zID0gTWF0aC5taW4odGhpcy5fc2tpcCwgdGhpcy5kb2N1bWVudHMubGVuZ3RoKTsKICAgIH0KICAgIGxldCBlZmZlY3RpdmVNYXg7CiAgICBpZiAodGhpcy5fbGltaXQgPiAwKSB7CiAgICAgIGVmZmVjdGl2ZU1heCA9IE1hdGgubWluKHRoaXMuX3NraXAgKyB0aGlzLl9saW1pdCwgdGhpcy5kb2N1bWVudHMubGVuZ3RoKTsKICAgIH0gZWxzZSB7CiAgICAgIGVmZmVjdGl2ZU1heCA9IHRoaXMuZG9jdW1lbnRzLmxlbmd0aDsKICAgIH0KICAgIHJldHVybiB0aGlzLnBvcyA8IGVmZmVjdGl2ZU1heDsKICB9CiAgaGludChpbmRleCkgewogICAgdGhpcy5faGludCA9IGluZGV4OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGFzeW5jIGl0Y291bnQoKSB7CiAgICBhd2FpdCB0aGlzLl9lbnN1cmVJbml0aWFsaXplZCgpOwogICAgbGV0IGNvdW50ID0gMDsKICAgIHdoaWxlIChhd2FpdCB0aGlzLmhhc05leHQoKSkgewogICAgICBhd2FpdCB0aGlzLm5leHQoKTsKICAgICAgY291bnQrKzsKICAgIH0KICAgIHJldHVybiBjb3VudDsKICB9CiAgbGltaXQoX21heCkgewogICAgdGhpcy5fbGltaXQgPSBfbWF4OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGFzeW5jIG1hcChmbikgewogICAgYXdhaXQgdGhpcy5fZW5zdXJlSW5pdGlhbGl6ZWQoKTsKICAgIGNvbnN0IHJlc3VsdHMgPSBbXTsKICAgIHdoaWxlIChhd2FpdCB0aGlzLmhhc05leHQoKSkgewogICAgICByZXN1bHRzLnB1c2goYXdhaXQgZm4oYXdhaXQgdGhpcy5uZXh0KCkpKTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH0KICBtYXhTY2FuKG1heFNjYW4pIHsKICAgIHRoaXMuX21heFNjYW4gPSBtYXhTY2FuOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIG1heFRpbWVNUyhtcykgewogICAgdGhpcy5fbWF4VGltZU1TID0gbXM7CiAgICByZXR1cm4gdGhpczsKICB9CiAgbWF4KGluZGV4Qm91bmRzKSB7CiAgICB0aGlzLl9tYXhJbmRleEJvdW5kcyA9IGluZGV4Qm91bmRzOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIG1pbihpbmRleEJvdW5kcykgewogICAgdGhpcy5fbWluSW5kZXhCb3VuZHMgPSBpbmRleEJvdW5kczsKICAgIHJldHVybiB0aGlzOwogIH0KICBhc3luYyBuZXh0KCkgewogICAgaWYgKCFhd2FpdCB0aGlzLmhhc05leHQoKSkgewogICAgICB0aHJvdyBuZXcgUXVlcnlFcnJvcigiRXJyb3I6IGVycm9yIGhhc05leHQ6IGZhbHNlIiwgewogICAgICAgIGNvbGxlY3Rpb246IHRoaXMuY29sbGVjdGlvbi5uYW1lCiAgICAgIH0pOwogICAgfQogICAgY29uc3QgcmVzdWx0ID0gdGhpcy5kb2N1bWVudHNbdGhpcy5wb3MrK107CiAgICBpZiAodGhpcy5wcm9qZWN0aW9uKSB7CiAgICAgIHJldHVybiBhcHBseVByb2plY3Rpb24odGhpcy5wcm9qZWN0aW9uLCByZXN1bHQpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgbm9DdXJzb3JUaW1lb3V0KCkgewogICAgdGhpcy5fbm9DdXJzb3JUaW1lb3V0ID0gdHJ1ZTsKICAgIHJldHVybiB0aGlzOwogIH0KICBvYmpzTGVmdEluQmF0Y2goKSB7CiAgICBpZiAoIXRoaXMuZG9jdW1lbnRzKSByZXR1cm4gMDsKICAgIHJldHVybiB0aGlzLnNpemUoKTsKICB9CiAgcHJldHR5KCkgewogICAgdGhpcy5fcHJldHR5ID0gdHJ1ZTsKICAgIHJldHVybiB0aGlzOwogIH0KICByZWFkQ29uY2VybihsZXZlbCkgewogICAgdGhpcy5fcmVhZENvbmNlcm4gPSBsZXZlbDsKICAgIHJldHVybiB0aGlzOwogIH0KICByZWFkUHJlZihtb2RlLCB0YWdTZXQpIHsKICAgIHRoaXMuX3JlYWRQcmVmID0geyBtb2RlLCB0YWdTZXQgfTsKICAgIHJldHVybiB0aGlzOwogIH0KICByZXR1cm5LZXkoZW5hYmxlZCA9IHRydWUpIHsKICAgIHRoaXMuX3JldHVybktleSA9IGVuYWJsZWQ7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2hvd1JlY29yZElkKGVuYWJsZWQgPSB0cnVlKSB7CiAgICB0aGlzLl9zaG93UmVjb3JkSWQgPSBlbmFibGVkOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNpemUoKSB7CiAgICBpZiAoIXRoaXMuZG9jdW1lbnRzKSByZXR1cm4gMDsKICAgIGNvbnN0IHJlbWFpbmluZyA9IHRoaXMuZG9jdW1lbnRzLmxlbmd0aCAtIHRoaXMucG9zOwogICAgaWYgKHRoaXMuX2xpbWl0ID4gMCkgewogICAgICBjb25zdCBtYXhQb3MgPSB0aGlzLl9za2lwICsgdGhpcy5fbGltaXQ7CiAgICAgIHJldHVybiBNYXRoLm1pbihtYXhQb3MgLSB0aGlzLnBvcywgcmVtYWluaW5nKTsKICAgIH0KICAgIHJldHVybiByZW1haW5pbmc7CiAgfQogIHNraXAobnVtKSB7CiAgICB0aGlzLl9za2lwID0gbnVtOwogICAgaWYgKHRoaXMucG9zID09PSAwKSB7CiAgICAgIGlmICh0aGlzLmRvY3VtZW50cykgewogICAgICAgIHRoaXMucG9zID0gTWF0aC5taW4obnVtLCB0aGlzLmRvY3VtZW50cy5sZW5ndGgpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgaXNDbG9zZWQoKSB7CiAgICByZXR1cm4gdGhpcy5fY2xvc2VkID09PSB0cnVlOwogIH0KICBzbmFwc2hvdCgpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJzbmFwc2hvdCIpOwogIH0KICBzb3J0KHMpIHsKICAgIHJldHVybiBuZXcgdGhpcy5Tb3J0ZWRDdXJzb3IodGhpcy5jb2xsZWN0aW9uLCB0aGlzLnF1ZXJ5LCB0aGlzLCBzKTsKICB9CiAgYWxsb3dEaXNrVXNlKGVuYWJsZWQgPSB0cnVlKSB7CiAgICB0aGlzLl9hbGxvd0Rpc2tVc2UgPSBlbmFibGVkOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGNvbGxhdGlvbihjb2xsYXRpb25Eb2N1bWVudCkgewogICAgdGhpcy5fY29sbGF0aW9uID0gY29sbGF0aW9uRG9jdW1lbnQ7CiAgICByZXR1cm4gdGhpczsKICB9CiAgdGFpbGFibGUoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigidGFpbGFibGUiKTsKICB9CiAgYXN5bmMgdG9BcnJheSgpIHsKICAgIGF3YWl0IHRoaXMuX2Vuc3VyZUluaXRpYWxpemVkKCk7CiAgICBjb25zdCByZXN1bHRzID0gW107CiAgICB3aGlsZSAoYXdhaXQgdGhpcy5oYXNOZXh0KCkpIHsKICAgICAgcmVzdWx0cy5wdXNoKGF3YWl0IHRoaXMubmV4dCgpKTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH0KICAvLyBTdXBwb3J0IGZvciBhc3luYyBpdGVyYXRpb24gKGZvciBhd2FpdC4uLm9mKQogIGFzeW5jICpbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCkgewogICAgYXdhaXQgdGhpcy5fZW5zdXJlSW5pdGlhbGl6ZWQoKTsKICAgIHdoaWxlIChhd2FpdCB0aGlzLmhhc05leHQoKSkgewogICAgICB5aWVsZCBhd2FpdCB0aGlzLm5leHQoKTsKICAgIH0KICB9Cn0KY2xhc3MgU29ydGVkQ3Vyc29yIHsKICBjb25zdHJ1Y3Rvcihjb2xsZWN0aW9uLCBxdWVyeSwgY3Vyc29yLCBzb3J0KSB7CiAgICB0aGlzLmNvbGxlY3Rpb24gPSBjb2xsZWN0aW9uOwogICAgdGhpcy5xdWVyeSA9IHF1ZXJ5OwogICAgdGhpcy5zb3J0U3BlYyA9IHNvcnQ7CiAgICB0aGlzLnBvcyA9IDA7CiAgICB0aGlzLl9jdXJzb3IgPSBjdXJzb3I7CiAgICB0aGlzLl9zb3J0ID0gc29ydDsKICAgIHRoaXMuX2luaXRpYWxpemVkID0gZmFsc2U7CiAgICB0aGlzLml0ZW1zID0gbnVsbDsKICB9CiAgYXN5bmMgX2Vuc3VyZUluaXRpYWxpemVkKCkgewogICAgaWYgKHRoaXMuX2luaXRpYWxpemVkKSByZXR1cm47CiAgICBhd2FpdCB0aGlzLl9jdXJzb3IuX2Vuc3VyZUluaXRpYWxpemVkKCk7CiAgICB0aGlzLml0ZW1zID0gW107CiAgICB3aGlsZSAoYXdhaXQgdGhpcy5fY3Vyc29yLmhhc05leHQoKSkgewogICAgICB0aGlzLml0ZW1zLnB1c2goYXdhaXQgdGhpcy5fY3Vyc29yLm5leHQoKSk7CiAgICB9CiAgICBjb25zdCBzb3J0S2V5cyA9IE9iamVjdC5rZXlzKHRoaXMuX3NvcnQpOwogICAgdGhpcy5pdGVtcy5zb3J0KChmdW5jdGlvbihhLCBiKSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc29ydEtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoYVtzb3J0S2V5c1tpXV0gPT0gdm9pZCAwICYmIGJbc29ydEtleXNbaV1dICE9IHZvaWQgMCkgcmV0dXJuIC0xICogdGhpcy5fc29ydFtzb3J0S2V5c1tpXV07CiAgICAgICAgaWYgKGFbc29ydEtleXNbaV1dICE9IHZvaWQgMCAmJiBiW3NvcnRLZXlzW2ldXSA9PSB2b2lkIDApIHJldHVybiAxICogdGhpcy5fc29ydFtzb3J0S2V5c1tpXV07CiAgICAgICAgaWYgKGFbc29ydEtleXNbaV1dIDwgYltzb3J0S2V5c1tpXV0pIHJldHVybiAtMSAqIHRoaXMuX3NvcnRbc29ydEtleXNbaV1dOwogICAgICAgIGlmIChhW3NvcnRLZXlzW2ldXSA+IGJbc29ydEtleXNbaV1dKSByZXR1cm4gMSAqIHRoaXMuX3NvcnRbc29ydEtleXNbaV1dOwogICAgICB9CiAgICAgIHJldHVybiAwOwogICAgfSkuYmluZCh0aGlzKSk7CiAgICB0aGlzLl9pbml0aWFsaXplZCA9IHRydWU7CiAgfQogIGJhdGNoU2l6ZSgpIHsKICAgIHRocm93ICJOb3QgSW1wbGVtZW50ZWQiOwogIH0KICBjbG9zZSgpIHsKICAgIHRocm93ICJOb3QgSW1wbGVtZW50ZWQiOwogIH0KICBjb21tZW50KCkgewogICAgdGhyb3cgIk5vdCBJbXBsZW1lbnRlZCI7CiAgfQogIGFzeW5jIGNvdW50KCkgewogICAgYXdhaXQgdGhpcy5fZW5zdXJlSW5pdGlhbGl6ZWQoKTsKICAgIHJldHVybiB0aGlzLml0ZW1zLmxlbmd0aDsKICB9CiAgZXhwbGFpbigpIHsKICAgIHRocm93ICJOb3QgSW1wbGVtZW50ZWQiOwogIH0KICBhc3luYyBmb3JFYWNoKGZuKSB7CiAgICBhd2FpdCB0aGlzLl9lbnN1cmVJbml0aWFsaXplZCgpOwogICAgd2hpbGUgKGF3YWl0IHRoaXMuaGFzTmV4dCgpKSB7CiAgICAgIGF3YWl0IGZuKGF3YWl0IHRoaXMubmV4dCgpKTsKICAgIH0KICB9CiAgYXN5bmMgaGFzTmV4dCgpIHsKICAgIGF3YWl0IHRoaXMuX2Vuc3VyZUluaXRpYWxpemVkKCk7CiAgICByZXR1cm4gdGhpcy5wb3MgPCB0aGlzLml0ZW1zLmxlbmd0aDsKICB9CiAgaGludCgpIHsKICAgIHRocm93ICJOb3QgSW1wbGVtZW50ZWQiOwogIH0KICBpdGNvdW50KCkgewogICAgdGhyb3cgIk5vdCBJbXBsZW1lbnRlZCI7CiAgfQogIGFzeW5jIGxpbWl0KG1heCkgewogICAgYXdhaXQgdGhpcy5fZW5zdXJlSW5pdGlhbGl6ZWQoKTsKICAgIHRoaXMuaXRlbXMgPSB0aGlzLml0ZW1zLnNsaWNlKDAsIG1heCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgYXN5bmMgbWFwKGZuKSB7CiAgICBhd2FpdCB0aGlzLl9lbnN1cmVJbml0aWFsaXplZCgpOwogICAgY29uc3QgcmVzdWx0cyA9IFtdOwogICAgd2hpbGUgKGF3YWl0IHRoaXMuaGFzTmV4dCgpKSB7CiAgICAgIHJlc3VsdHMucHVzaChhd2FpdCBmbihhd2FpdCB0aGlzLm5leHQoKSkpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdHM7CiAgfQogIG1heFNjYW4oKSB7CiAgICB0aHJvdyAiTm90IEltcGxlbWVudGVkIjsKICB9CiAgbWF4VGltZU1TKCkgewogICAgdGhyb3cgIk5vdCBJbXBsZW1lbnRlZCI7CiAgfQogIG1heCgpIHsKICAgIHRocm93ICJOb3QgSW1wbGVtZW50ZWQiOwogIH0KICBtaW4oKSB7CiAgICB0aHJvdyAiTm90IEltcGxlbWVudGVkIjsKICB9CiAgYXN5bmMgbmV4dCgpIHsKICAgIGF3YWl0IHRoaXMuX2Vuc3VyZUluaXRpYWxpemVkKCk7CiAgICByZXR1cm4gdGhpcy5pdGVtc1t0aGlzLnBvcysrXTsKICB9CiAgbm9DdXJzb3JUaW1lb3V0KCkgewogICAgdGhyb3cgIk5vdCBJbXBsZW1lbnRlZCI7CiAgfQogIG9ianNMZWZ0SW5CYXRjaCgpIHsKICAgIHRocm93ICJOb3QgSW1wbGVtZW50ZWQiOwogIH0KICBwcmV0dHkoKSB7CiAgICB0aHJvdyAiTm90IEltcGxlbWVudGVkIjsKICB9CiAgcmVhZENvbmNlcm4oKSB7CiAgICB0aHJvdyAiTm90IEltcGxlbWVudGVkIjsKICB9CiAgcmVhZFByZWYoKSB7CiAgICB0aHJvdyAiTm90IEltcGxlbWVudGVkIjsKICB9CiAgcmV0dXJuS2V5KCkgewogICAgdGhyb3cgIk5vdCBJbXBsZW1lbnRlZCI7CiAgfQogIHNob3dSZWNvcmRJZCgpIHsKICAgIHRocm93ICJOb3QgSW1wbGVtZW50ZWQiOwogIH0KICBzaXplKCkgewogICAgdGhyb3cgIk5vdCBJbXBsZW1lbnRlZCI7CiAgfQogIGFzeW5jIHNraXAobnVtKSB7CiAgICBhd2FpdCB0aGlzLl9lbnN1cmVJbml0aWFsaXplZCgpOwogICAgd2hpbGUgKG51bSA+IDApIHsKICAgICAgYXdhaXQgdGhpcy5uZXh0KCk7CiAgICAgIG51bS0tOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNuYXBzaG90KCkgewogICAgdGhyb3cgIk5vdCBJbXBsZW1lbnRlZCI7CiAgfQogIHNvcnQocykgewogICAgcmV0dXJuIG5ldyBTb3J0ZWRDdXJzb3IodGhpcy5jb2xsZWN0aW9uLCB0aGlzLnF1ZXJ5LCB0aGlzLCBzKTsKICB9CiAgdGFpbGFibGUoKSB7CiAgICB0aHJvdyAiTm90IEltcGxlbWVudGVkIjsKICB9CiAgYXN5bmMgdG9BcnJheSgpIHsKICAgIGF3YWl0IHRoaXMuX2Vuc3VyZUluaXRpYWxpemVkKCk7CiAgICBjb25zdCByZXN1bHRzID0gW107CiAgICB3aGlsZSAoYXdhaXQgdGhpcy5oYXNOZXh0KCkpIHsKICAgICAgcmVzdWx0cy5wdXNoKHRoaXMubmV4dCgpKTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH0KICAvLyBTdXBwb3J0IGZvciBhc3luYyBpdGVyYXRpb24gKGZvciBhd2FpdC4uLm9mKQogIGFzeW5jICpbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCkgewogICAgYXdhaXQgdGhpcy5fZW5zdXJlSW5pdGlhbGl6ZWQoKTsKICAgIHdoaWxlIChhd2FpdCB0aGlzLmhhc05leHQoKSkgewogICAgICB5aWVsZCBhd2FpdCB0aGlzLm5leHQoKTsKICAgIH0KICB9Cn0KY29uc3Qgc3RlcDJsaXN0ID0gewogIGF0aW9uYWw6ICJhdGUiLAogIHRpb25hbDogInRpb24iLAogIGVuY2k6ICJlbmNlIiwKICBhbmNpOiAiYW5jZSIsCiAgaXplcjogIml6ZSIsCiAgYmxpOiAiYmxlIiwKICBhbGxpOiAiYWwiLAogIGVudGxpOiAiZW50IiwKICBlbGk6ICJlIiwKICBvdXNsaTogIm91cyIsCiAgaXphdGlvbjogIml6ZSIsCiAgYXRpb246ICJhdGUiLAogIGF0b3I6ICJhdGUiLAogIGFsaXNtOiAiYWwiLAogIGl2ZW5lc3M6ICJpdmUiLAogIGZ1bG5lc3M6ICJmdWwiLAogIG91c25lc3M6ICJvdXMiLAogIGFsaXRpOiAiYWwiLAogIGl2aXRpOiAiaXZlIiwKICBiaWxpdGk6ICJibGUiLAogIGxvZ2k6ICJsb2ciCn07CmNvbnN0IHN0ZXAzbGlzdCA9IHsKICBpY2F0ZTogImljIiwKICBhdGl2ZTogIiIsCiAgYWxpemU6ICJhbCIsCiAgaWNpdGk6ICJpYyIsCiAgaWNhbDogImljIiwKICBmdWw6ICIiLAogIG5lc3M6ICIiCn07CmNvbnN0IGNvbnNvbmFudCA9ICJbXmFlaW91XSI7CmNvbnN0IHZvd2VsID0gIlthZWlvdXldIjsKY29uc3QgY29uc29uYW50cyA9ICIoIiArIGNvbnNvbmFudCArICJbXmFlaW91eV0qKSI7CmNvbnN0IHZvd2VscyA9ICIoIiArIHZvd2VsICsgIlthZWlvdV0qKSI7CmNvbnN0IGd0MCA9IG5ldyBSZWdFeHAoIl4iICsgY29uc29uYW50cyArICI/IiArIHZvd2VscyArIGNvbnNvbmFudHMpOwpjb25zdCBlcTEgPSBuZXcgUmVnRXhwKAogICJeIiArIGNvbnNvbmFudHMgKyAiPyIgKyB2b3dlbHMgKyBjb25zb25hbnRzICsgdm93ZWxzICsgIj8kIgopOwpjb25zdCBndDEgPSBuZXcgUmVnRXhwKCJeIiArIGNvbnNvbmFudHMgKyAiPygiICsgdm93ZWxzICsgY29uc29uYW50cyArICIpezIsfSIpOwpjb25zdCB2b3dlbEluU3RlbSA9IG5ldyBSZWdFeHAoIl4iICsgY29uc29uYW50cyArICI/IiArIHZvd2VsKTsKY29uc3QgY29uc29uYW50TGlrZSA9IG5ldyBSZWdFeHAoIl4iICsgY29uc29uYW50cyArIHZvd2VsICsgIlteYWVpb3V3eHldJCIpOwpjb25zdCBzZnhMbCA9IC9sbCQvOwpjb25zdCBzZnhFID0gL14oLis/KWUkLzsKY29uc3Qgc2Z4WSA9IC9eKC4rPyl5JC87CmNvbnN0IHNmeElvbiA9IC9eKC4rPyhzfHQpKShpb24pJC87CmNvbnN0IHNmeEVkT3JJbmcgPSAvXiguKz8pKGVkfGluZykkLzsKY29uc3Qgc2Z4QXRPckJsT3JJeiA9IC8oYXR8Ymx8aXopJC87CmNvbnN0IHNmeEVFRCA9IC9eKC4rPyllZWQkLzsKY29uc3Qgc2Z4UyA9IC9eLis/W15zXXMkLzsKY29uc3Qgc2Z4U3Nlc09ySWVzID0gL14uKz8oc3N8aSllcyQvOwpjb25zdCBzZnhNdWx0aUNvbnNvbmFudExpa2UgPSAvKFteYWVpb3V5bHN6XSlcMSQvOwpjb25zdCBzdGVwMiA9IC9eKC4rPykoYXRpb25hbHx0aW9uYWx8ZW5jaXxhbmNpfGl6ZXJ8YmxpfGFsbGl8ZW50bGl8ZWxpfG91c2xpfGl6YXRpb258YXRpb258YXRvcnxhbGlzbXxpdmVuZXNzfGZ1bG5lc3N8b3VzbmVzc3xhbGl0aXxpdml0aXxiaWxpdGl8bG9naSkkLzsKY29uc3Qgc3RlcDMgPSAvXiguKz8pKGljYXRlfGF0aXZlfGFsaXplfGljaXRpfGljYWx8ZnVsfG5lc3MpJC87CmNvbnN0IHN0ZXA0ID0gL14oLis/KShhbHxhbmNlfGVuY2V8ZXJ8aWN8YWJsZXxpYmxlfGFudHxlbWVudHxtZW50fGVudHxvdXxpc218YXRlfGl0aXxvdXN8aXZlfGl6ZSkkLzsKZnVuY3Rpb24gc3RlbW1lcih2YWx1ZSkgewogIGxldCByZXN1bHQgPSBTdHJpbmcodmFsdWUpLnRvTG93ZXJDYXNlKCk7CiAgaWYgKHJlc3VsdC5sZW5ndGggPCAzKSB7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBsZXQgZmlyc3RDaGFyYWN0ZXJXYXNMb3dlckNhc2VZID0gZmFsc2U7CiAgaWYgKHJlc3VsdC5jb2RlUG9pbnRBdCgwKSA9PT0gMTIxKSB7CiAgICBmaXJzdENoYXJhY3Rlcldhc0xvd2VyQ2FzZVkgPSB0cnVlOwogICAgcmVzdWx0ID0gIlkiICsgcmVzdWx0LnNsaWNlKDEpOwogIH0KICBpZiAoc2Z4U3Nlc09ySWVzLnRlc3QocmVzdWx0KSkgewogICAgcmVzdWx0ID0gcmVzdWx0LnNsaWNlKDAsIC0yKTsKICB9IGVsc2UgaWYgKHNmeFMudGVzdChyZXN1bHQpKSB7CiAgICByZXN1bHQgPSByZXN1bHQuc2xpY2UoMCwgLTEpOwogIH0KICBsZXQgbWF0Y2g7CiAgaWYgKG1hdGNoID0gc2Z4RUVELmV4ZWMocmVzdWx0KSkgewogICAgaWYgKGd0MC50ZXN0KG1hdGNoWzFdKSkgewogICAgICByZXN1bHQgPSByZXN1bHQuc2xpY2UoMCwgLTEpOwogICAgfQogIH0gZWxzZSBpZiAoKG1hdGNoID0gc2Z4RWRPckluZy5leGVjKHJlc3VsdCkpICYmIHZvd2VsSW5TdGVtLnRlc3QobWF0Y2hbMV0pKSB7CiAgICByZXN1bHQgPSBtYXRjaFsxXTsKICAgIGlmIChzZnhBdE9yQmxPckl6LnRlc3QocmVzdWx0KSkgewogICAgICByZXN1bHQgKz0gImUiOwogICAgfSBlbHNlIGlmIChzZnhNdWx0aUNvbnNvbmFudExpa2UudGVzdChyZXN1bHQpKSB7CiAgICAgIHJlc3VsdCA9IHJlc3VsdC5zbGljZSgwLCAtMSk7CiAgICB9IGVsc2UgaWYgKGNvbnNvbmFudExpa2UudGVzdChyZXN1bHQpKSB7CiAgICAgIHJlc3VsdCArPSAiZSI7CiAgICB9CiAgfQogIGlmICgobWF0Y2ggPSBzZnhZLmV4ZWMocmVzdWx0KSkgJiYgdm93ZWxJblN0ZW0udGVzdChtYXRjaFsxXSkpIHsKICAgIHJlc3VsdCA9IG1hdGNoWzFdICsgImkiOwogIH0KICBpZiAoKG1hdGNoID0gc3RlcDIuZXhlYyhyZXN1bHQpKSAmJiBndDAudGVzdChtYXRjaFsxXSkpIHsKICAgIHJlc3VsdCA9IG1hdGNoWzFdICsgc3RlcDJsaXN0W21hdGNoWzJdXTsKICB9CiAgaWYgKChtYXRjaCA9IHN0ZXAzLmV4ZWMocmVzdWx0KSkgJiYgZ3QwLnRlc3QobWF0Y2hbMV0pKSB7CiAgICByZXN1bHQgPSBtYXRjaFsxXSArIHN0ZXAzbGlzdFttYXRjaFsyXV07CiAgfQogIGlmIChtYXRjaCA9IHN0ZXA0LmV4ZWMocmVzdWx0KSkgewogICAgaWYgKGd0MS50ZXN0KG1hdGNoWzFdKSkgewogICAgICByZXN1bHQgPSBtYXRjaFsxXTsKICAgIH0KICB9IGVsc2UgaWYgKChtYXRjaCA9IHNmeElvbi5leGVjKHJlc3VsdCkpICYmIGd0MS50ZXN0KG1hdGNoWzFdKSkgewogICAgcmVzdWx0ID0gbWF0Y2hbMV07CiAgfQogIGlmICgobWF0Y2ggPSBzZnhFLmV4ZWMocmVzdWx0KSkgJiYgKGd0MS50ZXN0KG1hdGNoWzFdKSB8fCBlcTEudGVzdChtYXRjaFsxXSkgJiYgIWNvbnNvbmFudExpa2UudGVzdChtYXRjaFsxXSkpKSB7CiAgICByZXN1bHQgPSBtYXRjaFsxXTsKICB9CiAgaWYgKHNmeExsLnRlc3QocmVzdWx0KSAmJiBndDEudGVzdChyZXN1bHQpKSB7CiAgICByZXN1bHQgPSByZXN1bHQuc2xpY2UoMCwgLTEpOwogIH0KICBpZiAoZmlyc3RDaGFyYWN0ZXJXYXNMb3dlckNhc2VZKSB7CiAgICByZXN1bHQgPSAieSIgKyByZXN1bHQuc2xpY2UoMSk7CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KY2xhc3MgTm9kZURhdGEgewogIC8qKgogICAqIENyZWF0ZXMgYSBub2RlIGRhdGEgb2JqZWN0IGZvciBzZXJpYWxpemF0aW9uCiAgICogQHBhcmFtIHtudW1iZXJ9IGlkIC0gVW5pcXVlIG5vZGUgSUQKICAgKiBAcGFyYW0ge2Jvb2xlYW59IGlzTGVhZiAtIExlYWYgZmxhZwogICAqIEBwYXJhbSB7QXJyYXl9IGtleXMgLSBLZXkgYXJyYXkKICAgKiBAcGFyYW0ge0FycmF5fSB2YWx1ZXMgLSBWYWx1ZSBhcnJheSAobGVhZiBub2RlcykKICAgKiBAcGFyYW0ge0FycmF5fSBjaGlsZHJlbiAtIENoaWxkIHBvaW50ZXJzIChpbnRlcm5hbCBub2RlcykKICAgKiBAcGFyYW0ge1BvaW50ZXJ9IG5leHQgLSBQb2ludGVyIHRvIG5leHQgbGVhZgogICAqLwogIGNvbnN0cnVjdG9yKGlkLCBpc0xlYWYsIGtleXMsIHZhbHVlcywgY2hpbGRyZW4sIG5leHQpIHsKICAgIHRoaXMuaWQgPSBpZDsKICAgIHRoaXMuaXNMZWFmID0gaXNMZWFmOwogICAgdGhpcy5rZXlzID0ga2V5czsKICAgIHRoaXMudmFsdWVzID0gdmFsdWVzOwogICAgdGhpcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgZm9yIChsZXQgdiBvZiBjaGlsZHJlbikgewogICAgICBpZiAoISh2IGluc3RhbmNlb2YgUG9pbnRlcikpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNoaWxkcmVuIG11c3QgYmUgUG9pbnRlciBvYmplY3RzIik7CiAgICAgIH0KICAgIH0KICAgIHRoaXMubmV4dCA9IG5leHQ7CiAgfQp9CmNsYXNzIEJQbHVzVHJlZSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhIG5ldyBwZXJzaXN0ZW50IEIrIHRyZWUKICAgKiBAcGFyYW0ge0ZpbGVTeXN0ZW1TeW5jQWNjZXNzSGFuZGxlfSBzeW5jSGFuZGxlIC0gU3luYyBhY2Nlc3MgaGFuZGxlIHRvIHN0b3JhZ2UgZmlsZQogICAqIEBwYXJhbSB7bnVtYmVyfSBvcmRlciAtIFRyZWUgb3JkZXIgKGRlZmF1bHQ6IDMpCiAgICovCiAgY29uc3RydWN0b3Ioc3luY0hhbmRsZSwgb3JkZXIgPSAzKSB7CiAgICBpZiAob3JkZXIgPCAzKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiQisgdHJlZSBvcmRlciBtdXN0IGJlIGF0IGxlYXN0IDMiKTsKICAgIH0KICAgIHRoaXMuZmlsZSA9IG5ldyBCSnNvbkZpbGUoc3luY0hhbmRsZSk7CiAgICB0aGlzLm9yZGVyID0gb3JkZXI7CiAgICB0aGlzLm1pbktleXMgPSBNYXRoLmNlaWwob3JkZXIgLyAyKSAtIDE7CiAgICB0aGlzLmlzT3BlbiA9IGZhbHNlOwogICAgdGhpcy5yb290UG9pbnRlciA9IG51bGw7CiAgICB0aGlzLm5leHROb2RlSWQgPSAwOwogICAgdGhpcy5fc2l6ZSA9IDA7CiAgfQogIC8qKgogICAqIE9wZW4gdGhlIHRyZWUgKGxvYWQgb3IgaW5pdGlhbGl6ZSBtZXRhZGF0YSkKICAgKi8KICBhc3luYyBvcGVuKCkgewogICAgaWYgKHRoaXMuaXNPcGVuKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVHJlZSBpcyBhbHJlYWR5IG9wZW4iKTsKICAgIH0KICAgIGNvbnN0IGZpbGVTaXplID0gdGhpcy5maWxlLmdldEZpbGVTaXplKCk7CiAgICBjb25zdCBleGlzdHMgPSBmaWxlU2l6ZSA+IDA7CiAgICBpZiAoZXhpc3RzKSB7CiAgICAgIHRoaXMuX2xvYWRNZXRhZGF0YSgpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5faW5pdGlhbGl6ZU5ld1RyZWUoKTsKICAgIH0KICAgIHRoaXMuaXNPcGVuID0gdHJ1ZTsKICB9CiAgLyoqCiAgICogQ2xvc2UgdGhlIHRyZWUgYW5kIHNhdmUgbWV0YWRhdGEKICAgKi8KICBhc3luYyBjbG9zZSgpIHsKICAgIGlmICh0aGlzLmlzT3BlbikgewogICAgICBpZiAodGhpcy5maWxlICYmIHRoaXMuZmlsZS5zeW5jQWNjZXNzSGFuZGxlKSB7CiAgICAgICAgdGhpcy5maWxlLmZsdXNoKCk7CiAgICAgICAgYXdhaXQgdGhpcy5maWxlLnN5bmNBY2Nlc3NIYW5kbGUuY2xvc2UoKTsKICAgICAgfQogICAgICB0aGlzLmlzT3BlbiA9IGZhbHNlOwogICAgfQogIH0KICAvKioKICAgKiBJbml0aWFsaXplIGEgbmV3IGVtcHR5IHRyZWUKICAgKi8KICBfaW5pdGlhbGl6ZU5ld1RyZWUoKSB7CiAgICBjb25zdCByb290Tm9kZSA9IG5ldyBOb2RlRGF0YSgwLCB0cnVlLCBbXSwgW10sIFtdLCBudWxsKTsKICAgIHRoaXMubmV4dE5vZGVJZCA9IDE7CiAgICB0aGlzLl9zaXplID0gMDsKICAgIGNvbnN0IHJvb3RQb2ludGVyID0gdGhpcy5fc2F2ZU5vZGUocm9vdE5vZGUpOwogICAgdGhpcy5yb290UG9pbnRlciA9IHJvb3RQb2ludGVyOwogICAgdGhpcy5fc2F2ZU1ldGFkYXRhKCk7CiAgfQogIC8qKgogICAqIFNhdmUgbWV0YWRhdGEgdG8gZmlsZQogICAqLwogIF9zYXZlTWV0YWRhdGEoKSB7CiAgICBjb25zdCBtZXRhZGF0YSA9IHsKICAgICAgdmVyc2lvbjogMSwKICAgICAgbWF4RW50cmllczogdGhpcy5vcmRlciwKICAgICAgLy8gUmVuYW1lZCB0byBtYXRjaCBSVHJlZSBzaXplCiAgICAgIG1pbkVudHJpZXM6IHRoaXMubWluS2V5cywKICAgICAgLy8gUmVuYW1lZCB0byBtYXRjaCBSVHJlZSBzaXplCiAgICAgIHNpemU6IHRoaXMuX3NpemUsCiAgICAgIHJvb3RQb2ludGVyOiB0aGlzLnJvb3RQb2ludGVyLAogICAgICBuZXh0SWQ6IHRoaXMubmV4dE5vZGVJZAogICAgICAvLyBSZW5hbWVkIHRvIG1hdGNoIFJUcmVlIHNpemUKICAgIH07CiAgICB0aGlzLmZpbGUuYXBwZW5kKG1ldGFkYXRhKTsKICB9CiAgLyoqCiAgICogTG9hZCBtZXRhZGF0YSBmcm9tIGZpbGUKICAgKi8KICBfbG9hZE1ldGFkYXRhKCkgewogICAgY29uc3QgZmlsZVNpemUgPSB0aGlzLmZpbGUuZ2V0RmlsZVNpemUoKTsKICAgIGNvbnN0IE1FVEFEQVRBX1NJWkUgPSAxMzU7CiAgICBpZiAoZmlsZVNpemUgPCBNRVRBREFUQV9TSVpFKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCB0cmVlIGZpbGUiKTsKICAgIH0KICAgIGNvbnN0IG1ldGFkYXRhT2Zmc2V0ID0gZmlsZVNpemUgLSBNRVRBREFUQV9TSVpFOwogICAgY29uc3QgbWV0YWRhdGEgPSB0aGlzLmZpbGUucmVhZChtZXRhZGF0YU9mZnNldCk7CiAgICBpZiAoIW1ldGFkYXRhIHx8IHR5cGVvZiBtZXRhZGF0YS5tYXhFbnRyaWVzID09PSAidW5kZWZpbmVkIikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byByZWFkIG1ldGFkYXRhOiBtaXNzaW5nIHJlcXVpcmVkIGZpZWxkc2ApOwogICAgfQogICAgdGhpcy5vcmRlciA9IG1ldGFkYXRhLm1heEVudHJpZXM7CiAgICB0aGlzLm1pbktleXMgPSBtZXRhZGF0YS5taW5FbnRyaWVzOwogICAgdGhpcy5fc2l6ZSA9IG1ldGFkYXRhLnNpemU7CiAgICB0aGlzLm5leHROb2RlSWQgPSBtZXRhZGF0YS5uZXh0SWQ7CiAgICB0aGlzLnJvb3RQb2ludGVyID0gbWV0YWRhdGEucm9vdFBvaW50ZXI7CiAgfQogIC8qKgogICAqIFNhdmUgYSBub2RlIHRvIGRpc2sKICAgKi8KICBfc2F2ZU5vZGUobm9kZSkgewogICAgY29uc3Qgb2Zmc2V0ID0gdGhpcy5maWxlLmdldEZpbGVTaXplKCk7CiAgICB0aGlzLmZpbGUuYXBwZW5kKG5vZGUpOwogICAgcmV0dXJuIG5ldyBQb2ludGVyKG9mZnNldCk7CiAgfQogIC8qKgogICAqIExvYWQgYSBub2RlIGZyb20gZGlzawogICAqLwogIF9sb2FkTm9kZShwb2ludGVyKSB7CiAgICBpZiAoIShwb2ludGVyIGluc3RhbmNlb2YgUG9pbnRlcikpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBQb2ludGVyIG9iamVjdCIpOwogICAgfQogICAgY29uc3QgZGF0YSA9IHRoaXMuZmlsZS5yZWFkKHBvaW50ZXIpOwogICAgcmV0dXJuIG5ldyBOb2RlRGF0YSgKICAgICAgZGF0YS5pZCwKICAgICAgZGF0YS5pc0xlYWYsCiAgICAgIGRhdGEua2V5cywKICAgICAgZGF0YS52YWx1ZXMsCiAgICAgIGRhdGEuY2hpbGRyZW4sCiAgICAgIGRhdGEubmV4dAogICAgKTsKICB9CiAgLyoqCiAgICogTG9hZCByb290IG5vZGUKICAgKi8KICBfbG9hZFJvb3QoKSB7CiAgICByZXR1cm4gdGhpcy5fbG9hZE5vZGUodGhpcy5yb290UG9pbnRlcik7CiAgfQogIC8qKgogICAqIFNlYXJjaCBmb3IgYSBrZXkKICAgKi8KICBzZWFyY2goa2V5KSB7CiAgICBjb25zdCByb290ID0gdGhpcy5fbG9hZFJvb3QoKTsKICAgIHJldHVybiB0aGlzLl9zZWFyY2hOb2RlKHJvb3QsIGtleSk7CiAgfQogIC8qKgogICAqIEludGVybmFsIHNlYXJjaAogICAqLwogIF9zZWFyY2hOb2RlKG5vZGUsIGtleSkgewogICAgaWYgKG5vZGUuaXNMZWFmKSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZS5rZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKGtleSA9PT0gbm9kZS5rZXlzW2ldKSB7CiAgICAgICAgICByZXR1cm4gbm9kZS52YWx1ZXNbaV07CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9IGVsc2UgewogICAgICBsZXQgaSA9IDA7CiAgICAgIHdoaWxlIChpIDwgbm9kZS5rZXlzLmxlbmd0aCAmJiBrZXkgPj0gbm9kZS5rZXlzW2ldKSB7CiAgICAgICAgaSsrOwogICAgICB9CiAgICAgIGNvbnN0IGNoaWxkID0gdGhpcy5fbG9hZE5vZGUobm9kZS5jaGlsZHJlbltpXSk7CiAgICAgIHJldHVybiB0aGlzLl9zZWFyY2hOb2RlKGNoaWxkLCBrZXkpOwogICAgfQogIH0KICAvKioKICAgKiBJbnNlcnQgYSBrZXktdmFsdWUgcGFpcgogICAqLwogIGFkZChrZXksIHZhbHVlKSB7CiAgICBjb25zdCByb290ID0gdGhpcy5fbG9hZFJvb3QoKTsKICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuX2FkZFRvTm9kZShyb290LCBrZXksIHZhbHVlKTsKICAgIGxldCBuZXdSb290OwogICAgaWYgKHJlc3VsdC5uZXdOb2RlKSB7CiAgICAgIG5ld1Jvb3QgPSByZXN1bHQubmV3Tm9kZTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IGxlZnRQb2ludGVyID0gdGhpcy5fc2F2ZU5vZGUocmVzdWx0LmxlZnQpOwogICAgICBjb25zdCByaWdodFBvaW50ZXIgPSB0aGlzLl9zYXZlTm9kZShyZXN1bHQucmlnaHQpOwogICAgICBuZXdSb290ID0gbmV3IE5vZGVEYXRhKAogICAgICAgIHRoaXMubmV4dE5vZGVJZCsrLAogICAgICAgIGZhbHNlLAogICAgICAgIFtyZXN1bHQuc3BsaXRLZXldLAogICAgICAgIFtdLAogICAgICAgIFtsZWZ0UG9pbnRlciwgcmlnaHRQb2ludGVyXSwKICAgICAgICBudWxsCiAgICAgICk7CiAgICB9CiAgICBjb25zdCByb290UG9pbnRlciA9IHRoaXMuX3NhdmVOb2RlKG5ld1Jvb3QpOwogICAgdGhpcy5yb290UG9pbnRlciA9IHJvb3RQb2ludGVyOwogICAgdGhpcy5fc2l6ZSsrOwogICAgdGhpcy5fc2F2ZU1ldGFkYXRhKCk7CiAgfQogIC8qKgogICAqIEludGVybmFsIGFkZAogICAqLwogIF9hZGRUb05vZGUobm9kZSwga2V5LCB2YWx1ZSkgewogICAgaWYgKG5vZGUuaXNMZWFmKSB7CiAgICAgIGNvbnN0IGtleXMgPSBbLi4ubm9kZS5rZXlzXTsKICAgICAgY29uc3QgdmFsdWVzID0gWy4uLm5vZGUudmFsdWVzXTsKICAgICAgY29uc3QgZXhpc3RpbmdJZHggPSBrZXlzLmluZGV4T2Yoa2V5KTsKICAgICAgaWYgKGV4aXN0aW5nSWR4ICE9PSAtMSkgewogICAgICAgIHZhbHVlc1tleGlzdGluZ0lkeF0gPSB2YWx1ZTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgbmV3Tm9kZTogbmV3IE5vZGVEYXRhKG5vZGUuaWQsIHRydWUsIGtleXMsIHZhbHVlcywgW10sIG51bGwpCiAgICAgICAgfTsKICAgICAgfQogICAgICBsZXQgaW5zZXJ0SWR4ID0gMDsKICAgICAgd2hpbGUgKGluc2VydElkeCA8IGtleXMubGVuZ3RoICYmIGtleSA+IGtleXNbaW5zZXJ0SWR4XSkgewogICAgICAgIGluc2VydElkeCsrOwogICAgICB9CiAgICAgIGtleXMuc3BsaWNlKGluc2VydElkeCwgMCwga2V5KTsKICAgICAgdmFsdWVzLnNwbGljZShpbnNlcnRJZHgsIDAsIHZhbHVlKTsKICAgICAgaWYgKGtleXMubGVuZ3RoIDwgdGhpcy5vcmRlcikgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBuZXdOb2RlOiBuZXcgTm9kZURhdGEobm9kZS5pZCwgdHJ1ZSwga2V5cywgdmFsdWVzLCBbXSwgbnVsbCkKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IG1pZCA9IE1hdGguY2VpbChrZXlzLmxlbmd0aCAvIDIpOwogICAgICAgIGNvbnN0IGxlZnRLZXlzID0ga2V5cy5zbGljZSgwLCBtaWQpOwogICAgICAgIGNvbnN0IGxlZnRWYWx1ZXMgPSB2YWx1ZXMuc2xpY2UoMCwgbWlkKTsKICAgICAgICBjb25zdCByaWdodEtleXMgPSBrZXlzLnNsaWNlKG1pZCk7CiAgICAgICAgY29uc3QgcmlnaHRWYWx1ZXMgPSB2YWx1ZXMuc2xpY2UobWlkKTsKICAgICAgICBjb25zdCByaWdodE5vZGUgPSBuZXcgTm9kZURhdGEodGhpcy5uZXh0Tm9kZUlkKyssIHRydWUsIHJpZ2h0S2V5cywgcmlnaHRWYWx1ZXMsIFtdLCBudWxsKTsKICAgICAgICBjb25zdCBsZWZ0Tm9kZSA9IG5ldyBOb2RlRGF0YShub2RlLmlkLCB0cnVlLCBsZWZ0S2V5cywgbGVmdFZhbHVlcywgW10sIG51bGwpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBsZWZ0OiBsZWZ0Tm9kZSwKICAgICAgICAgIHJpZ2h0OiByaWdodE5vZGUsCiAgICAgICAgICBzcGxpdEtleTogcmlnaHRLZXlzWzBdCiAgICAgICAgfTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY29uc3Qga2V5cyA9IFsuLi5ub2RlLmtleXNdOwogICAgICBjb25zdCBjaGlsZHJlbiA9IFsuLi5ub2RlLmNoaWxkcmVuXTsKICAgICAgbGV0IGNoaWxkSWR4ID0gMDsKICAgICAgd2hpbGUgKGNoaWxkSWR4IDwga2V5cy5sZW5ndGggJiYga2V5ID49IGtleXNbY2hpbGRJZHhdKSB7CiAgICAgICAgY2hpbGRJZHgrKzsKICAgICAgfQogICAgICBjb25zdCBjaGlsZE5vZGUgPSB0aGlzLl9sb2FkTm9kZShjaGlsZHJlbltjaGlsZElkeF0pOwogICAgICBjb25zdCByZXN1bHQgPSB0aGlzLl9hZGRUb05vZGUoY2hpbGROb2RlLCBrZXksIHZhbHVlKTsKICAgICAgaWYgKHJlc3VsdC5uZXdOb2RlKSB7CiAgICAgICAgY29uc3QgbmV3Q2hpbGRQb2ludGVyID0gdGhpcy5fc2F2ZU5vZGUocmVzdWx0Lm5ld05vZGUpOwogICAgICAgIGNoaWxkcmVuW2NoaWxkSWR4XSA9IG5ld0NoaWxkUG9pbnRlcjsKICAgICAgICByZXR1cm4gewogICAgICAgICAgbmV3Tm9kZTogbmV3IE5vZGVEYXRhKG5vZGUuaWQsIGZhbHNlLCBrZXlzLCBbXSwgY2hpbGRyZW4sIG51bGwpCiAgICAgICAgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBsZWZ0UG9pbnRlciA9IHRoaXMuX3NhdmVOb2RlKHJlc3VsdC5sZWZ0KTsKICAgICAgICBjb25zdCByaWdodFBvaW50ZXIgPSB0aGlzLl9zYXZlTm9kZShyZXN1bHQucmlnaHQpOwogICAgICAgIGtleXMuc3BsaWNlKGNoaWxkSWR4LCAwLCByZXN1bHQuc3BsaXRLZXkpOwogICAgICAgIGNoaWxkcmVuLnNwbGljZShjaGlsZElkeCwgMSwgbGVmdFBvaW50ZXIsIHJpZ2h0UG9pbnRlcik7CiAgICAgICAgaWYgKGtleXMubGVuZ3RoIDwgdGhpcy5vcmRlcikgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgbmV3Tm9kZTogbmV3IE5vZGVEYXRhKG5vZGUuaWQsIGZhbHNlLCBrZXlzLCBbXSwgY2hpbGRyZW4sIG51bGwpCiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCBtaWQgPSBNYXRoLmNlaWwoa2V5cy5sZW5ndGggLyAyKSAtIDE7CiAgICAgICAgICBjb25zdCBzcGxpdEtleSA9IGtleXNbbWlkXTsKICAgICAgICAgIGNvbnN0IGxlZnRLZXlzID0ga2V5cy5zbGljZSgwLCBtaWQpOwogICAgICAgICAgY29uc3QgcmlnaHRLZXlzID0ga2V5cy5zbGljZShtaWQgKyAxKTsKICAgICAgICAgIGNvbnN0IGxlZnRDaGlsZHJlbiA9IGNoaWxkcmVuLnNsaWNlKDAsIG1pZCArIDEpOwogICAgICAgICAgY29uc3QgcmlnaHRDaGlsZHJlbiA9IGNoaWxkcmVuLnNsaWNlKG1pZCArIDEpOwogICAgICAgICAgY29uc3QgbGVmdE5vZGUgPSBuZXcgTm9kZURhdGEobm9kZS5pZCwgZmFsc2UsIGxlZnRLZXlzLCBbXSwgbGVmdENoaWxkcmVuLCBudWxsKTsKICAgICAgICAgIGNvbnN0IHJpZ2h0Tm9kZSA9IG5ldyBOb2RlRGF0YSh0aGlzLm5leHROb2RlSWQrKywgZmFsc2UsIHJpZ2h0S2V5cywgW10sIHJpZ2h0Q2hpbGRyZW4sIG51bGwpOwogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgbGVmdDogbGVmdE5vZGUsCiAgICAgICAgICAgIHJpZ2h0OiByaWdodE5vZGUsCiAgICAgICAgICAgIHNwbGl0S2V5CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICAvKioKICAgKiBEZWxldGUgYSBrZXkKICAgKi8KICBkZWxldGUoa2V5KSB7CiAgICBjb25zdCByb290ID0gdGhpcy5fbG9hZFJvb3QoKTsKICAgIGNvbnN0IG5ld1Jvb3QgPSB0aGlzLl9kZWxldGVGcm9tTm9kZShyb290LCBrZXkpOwogICAgaWYgKCFuZXdSb290KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGxldCBmaW5hbFJvb3QgPSBuZXdSb290OwogICAgaWYgKGZpbmFsUm9vdC5rZXlzLmxlbmd0aCA9PT0gMCAmJiAhZmluYWxSb290LmlzTGVhZiAmJiBmaW5hbFJvb3QuY2hpbGRyZW4ubGVuZ3RoID4gMCkgewogICAgICBmaW5hbFJvb3QgPSB0aGlzLl9sb2FkTm9kZShmaW5hbFJvb3QuY2hpbGRyZW5bMF0pOwogICAgfQogICAgY29uc3Qgcm9vdFBvaW50ZXIgPSB0aGlzLl9zYXZlTm9kZShmaW5hbFJvb3QpOwogICAgdGhpcy5yb290UG9pbnRlciA9IHJvb3RQb2ludGVyOwogICAgdGhpcy5fc2l6ZS0tOwogICAgdGhpcy5fc2F2ZU1ldGFkYXRhKCk7CiAgfQogIC8qKgogICAqIEludGVybmFsIGRlbGV0ZQogICAqLwogIF9kZWxldGVGcm9tTm9kZShub2RlLCBrZXkpIHsKICAgIGlmIChub2RlLmlzTGVhZikgewogICAgICBjb25zdCBrZXlJbmRleCA9IG5vZGUua2V5cy5pbmRleE9mKGtleSk7CiAgICAgIGlmIChrZXlJbmRleCA9PT0gLTEpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICBjb25zdCBuZXdLZXlzID0gWy4uLm5vZGUua2V5c107CiAgICAgIGNvbnN0IG5ld1ZhbHVlcyA9IFsuLi5ub2RlLnZhbHVlc107CiAgICAgIG5ld0tleXMuc3BsaWNlKGtleUluZGV4LCAxKTsKICAgICAgbmV3VmFsdWVzLnNwbGljZShrZXlJbmRleCwgMSk7CiAgICAgIHJldHVybiBuZXcgTm9kZURhdGEobm9kZS5pZCwgdHJ1ZSwgbmV3S2V5cywgbmV3VmFsdWVzLCBbXSwgbm9kZS5uZXh0KTsKICAgIH0gZWxzZSB7CiAgICAgIGxldCBpID0gMDsKICAgICAgd2hpbGUgKGkgPCBub2RlLmtleXMubGVuZ3RoICYmIGtleSA+PSBub2RlLmtleXNbaV0pIHsKICAgICAgICBpKys7CiAgICAgIH0KICAgICAgY29uc3QgY2hpbGROb2RlID0gdGhpcy5fbG9hZE5vZGUobm9kZS5jaGlsZHJlbltpXSk7CiAgICAgIGNvbnN0IG5ld0NoaWxkID0gdGhpcy5fZGVsZXRlRnJvbU5vZGUoY2hpbGROb2RlLCBrZXkpOwogICAgICBpZiAoIW5ld0NoaWxkKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgY29uc3QgbmV3Q2hpbGRyZW4gPSBbLi4ubm9kZS5jaGlsZHJlbl07CiAgICAgIGNvbnN0IG5ld0NoaWxkUG9pbnRlciA9IHRoaXMuX3NhdmVOb2RlKG5ld0NoaWxkKTsKICAgICAgbmV3Q2hpbGRyZW5baV0gPSBuZXdDaGlsZFBvaW50ZXI7CiAgICAgIHJldHVybiBuZXcgTm9kZURhdGEobm9kZS5pZCwgZmFsc2UsIFsuLi5ub2RlLmtleXNdLCBbXSwgbmV3Q2hpbGRyZW4sIG51bGwpOwogICAgfQogIH0KICAvKioKICAgKiBHZXQgYWxsIGVudHJpZXMgYXMgYXJyYXkKICAgKi8KICB0b0FycmF5KCkgewogICAgY29uc3QgcmVzdWx0ID0gW107CiAgICB0aGlzLl9jb2xsZWN0QWxsRW50cmllcyh0aGlzLl9sb2FkUm9vdCgpLCByZXN1bHQpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgLyoqCiAgICogQXN5bmMgaXRlcmF0b3IgZm9yIGVmZmljaWVudGx5IHRyYXZlcnNpbmcgYWxsIGVudHJpZXMgd2l0aG91dCBsb2FkaW5nIGV2ZXJ5dGhpbmcgaW50byBtZW1vcnkKICAgKiBFbmFibGVzIHVzYWdlOiBgZm9yIGF3YWl0IChjb25zdCBlbnRyeSBvZiB0cmVlKSB7IC4uLiB9YAogICAqIEVhY2ggZW50cnkgaGFzIHNoYXBlOiB7IGtleSwgdmFsdWUgfQogICAqLwogIGFzeW5jICpbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCkgewogICAgaWYgKCF0aGlzLmlzT3BlbikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlRyZWUgbXVzdCBiZSBvcGVuIGJlZm9yZSBpdGVyYXRpb24iKTsKICAgIH0KICAgIGlmICh0aGlzLl9zaXplID09PSAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHlpZWxkKiB0aGlzLl9pdGVyYXRlTm9kZSh0aGlzLl9sb2FkUm9vdCgpKTsKICB9CiAgLyoqCiAgICogSGVscGVyIGdlbmVyYXRvciB0byByZWN1cnNpdmVseSBpdGVyYXRlIHRocm91Z2ggYSBub2RlCiAgICogQHByaXZhdGUKICAgKi8KICAqX2l0ZXJhdGVOb2RlKG5vZGUpIHsKICAgIGlmIChub2RlLmlzTGVhZikgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUua2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIHlpZWxkIHsKICAgICAgICAgIGtleTogbm9kZS5rZXlzW2ldLAogICAgICAgICAgdmFsdWU6IG5vZGUudmFsdWVzW2ldCiAgICAgICAgfTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZm9yIChjb25zdCBjaGlsZFBvaW50ZXIgb2Ygbm9kZS5jaGlsZHJlbikgewogICAgICAgIGNvbnN0IGNoaWxkID0gdGhpcy5fbG9hZE5vZGUoY2hpbGRQb2ludGVyKTsKICAgICAgICB5aWVsZCogdGhpcy5faXRlcmF0ZU5vZGUoY2hpbGQpOwogICAgICB9CiAgICB9CiAgfQogIC8qKgogICAqIENvbGxlY3QgYWxsIGVudHJpZXMgaW4gc29ydGVkIG9yZGVyIGJ5IHRyYXZlcnNpbmcgdHJlZQogICAqIEBwcml2YXRlCiAgICovCiAgX2NvbGxlY3RBbGxFbnRyaWVzKG5vZGUsIHJlc3VsdCkgewogICAgaWYgKG5vZGUuaXNMZWFmKSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZS5rZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcmVzdWx0LnB1c2goewogICAgICAgICAga2V5OiBub2RlLmtleXNbaV0sCiAgICAgICAgICB2YWx1ZTogbm9kZS52YWx1ZXNbaV0KICAgICAgICB9KTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZm9yIChjb25zdCBjaGlsZFBvaW50ZXIgb2Ygbm9kZS5jaGlsZHJlbikgewogICAgICAgIGNvbnN0IGNoaWxkID0gdGhpcy5fbG9hZE5vZGUoY2hpbGRQb2ludGVyKTsKICAgICAgICB0aGlzLl9jb2xsZWN0QWxsRW50cmllcyhjaGlsZCwgcmVzdWx0KTsKICAgICAgfQogICAgfQogIH0KICAvKioKICAgKiBHZXQgdHJlZSBzaXplCiAgICovCiAgc2l6ZSgpIHsKICAgIHJldHVybiB0aGlzLl9zaXplOwogIH0KICAvKioKICAgKiBDaGVjayBpZiBlbXB0eQogICAqLwogIGlzRW1wdHkoKSB7CiAgICByZXR1cm4gdGhpcy5fc2l6ZSA9PT0gMDsKICB9CiAgLyoqCiAgICogUmFuZ2Ugc2VhcmNoCiAgICovCiAgcmFuZ2VTZWFyY2gobWluS2V5LCBtYXhLZXkpIHsKICAgIGNvbnN0IHJlc3VsdCA9IFtdOwogICAgdGhpcy5fcmFuZ2VTZWFyY2hOb2RlKHRoaXMuX2xvYWRSb290KCksIG1pbktleSwgbWF4S2V5LCByZXN1bHQpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgLyoqCiAgICogUmFuZ2Ugc2VhcmNoIGhlbHBlciB0aGF0IHRyYXZlcnNlcyB0cmVlCiAgICogQHByaXZhdGUKICAgKi8KICBfcmFuZ2VTZWFyY2hOb2RlKG5vZGUsIG1pbktleSwgbWF4S2V5LCByZXN1bHQpIHsKICAgIGlmIChub2RlLmlzTGVhZikgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUua2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChub2RlLmtleXNbaV0gPj0gbWluS2V5ICYmIG5vZGUua2V5c1tpXSA8PSBtYXhLZXkpIHsKICAgICAgICAgIHJlc3VsdC5wdXNoKHsKICAgICAgICAgICAga2V5OiBub2RlLmtleXNbaV0sCiAgICAgICAgICAgIHZhbHVlOiBub2RlLnZhbHVlc1tpXQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBmb3IgKGNvbnN0IGNoaWxkUG9pbnRlciBvZiBub2RlLmNoaWxkcmVuKSB7CiAgICAgICAgY29uc3QgY2hpbGQgPSB0aGlzLl9sb2FkTm9kZShjaGlsZFBvaW50ZXIpOwogICAgICAgIHRoaXMuX3JhbmdlU2VhcmNoTm9kZShjaGlsZCwgbWluS2V5LCBtYXhLZXksIHJlc3VsdCk7CiAgICAgIH0KICAgIH0KICB9CiAgLyoqCiAgICogR2V0IHRyZWUgaGVpZ2h0CiAgICovCiAgZ2V0SGVpZ2h0KCkgewogICAgbGV0IGhlaWdodCA9IDA7CiAgICBsZXQgY3VycmVudCA9IHRoaXMuX2xvYWRSb290KCk7CiAgICB3aGlsZSAoIWN1cnJlbnQuaXNMZWFmKSB7CiAgICAgIGhlaWdodCsrOwogICAgICBjdXJyZW50ID0gdGhpcy5fbG9hZE5vZGUoY3VycmVudC5jaGlsZHJlblswXSk7CiAgICB9CiAgICByZXR1cm4gaGVpZ2h0OwogIH0KICAvKioKICAgKiBDb21wYWN0IHRoZSB0cmVlIGJ5IGNvcHlpbmcgYWxsIGxpdmUgZW50cmllcyBpbnRvIGEgbmV3IGZpbGUuCiAgICogUmV0dXJucyBzaXplIG1ldHJpY3Mgc28gY2FsbGVycyBjYW4gc2VlIGhvdyBtdWNoIHNwYWNlIHdhcyByZWNsYWltZWQuCiAgICogQHBhcmFtIHtGaWxlU3lzdGVtU3luY0FjY2Vzc0hhbmRsZX0gZGVzdFN5bmNIYW5kbGUgLSBTeW5jIGhhbmRsZSBmb3IgZGVzdGluYXRpb24gZmlsZQogICAqIEByZXR1cm5zIHtQcm9taXNlPHtvbGRTaXplOm51bWJlcixuZXdTaXplOm51bWJlcixieXRlc1NhdmVkOm51bWJlcn0+fQogICAqLwogIGFzeW5jIGNvbXBhY3QoZGVzdFN5bmNIYW5kbGUpIHsKICAgIGlmICghdGhpcy5pc09wZW4pIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJUcmVlIGZpbGUgaXMgbm90IG9wZW4iKTsKICAgIH0KICAgIGlmICghZGVzdFN5bmNIYW5kbGUpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJEZXN0aW5hdGlvbiBzeW5jIGhhbmRsZSBpcyByZXF1aXJlZCBmb3IgY29tcGFjdGlvbiIpOwogICAgfQogICAgY29uc3Qgb2xkU2l6ZSA9IHRoaXMuZmlsZS5nZXRGaWxlU2l6ZSgpOwogICAgY29uc3QgZW50cmllcyA9IHRoaXMudG9BcnJheSgpOwogICAgY29uc3QgbmV3VHJlZSA9IG5ldyBCUGx1c1RyZWUoZGVzdFN5bmNIYW5kbGUsIHRoaXMub3JkZXIpOwogICAgYXdhaXQgbmV3VHJlZS5vcGVuKCk7CiAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIGVudHJpZXMpIHsKICAgICAgYXdhaXQgbmV3VHJlZS5hZGQoZW50cnkua2V5LCBlbnRyeS52YWx1ZSk7CiAgICB9CiAgICBjb25zdCBuZXdTaXplID0gbmV3VHJlZS5maWxlLmdldEZpbGVTaXplKCk7CiAgICBhd2FpdCBuZXdUcmVlLmNsb3NlKCk7CiAgICByZXR1cm4gewogICAgICBvbGRTaXplLAogICAgICBuZXdTaXplLAogICAgICBieXRlc1NhdmVkOiBNYXRoLm1heCgwLCBvbGRTaXplIC0gbmV3U2l6ZSkKICAgIH07CiAgfQp9CmNvbnN0IFNUT1BXT1JEUyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsKICAiYSIsCiAgImFib3V0IiwKICAiYWZ0ZXIiLAogICJhbGwiLAogICJhbHNvIiwKICAiYW0iLAogICJhbiIsCiAgImFuZCIsCiAgImFub3RoZXIiLAogICJhbnkiLAogICJhcmUiLAogICJhcm91bmQiLAogICJhcyIsCiAgImF0IiwKICAiYmUiLAogICJiZWNhdXNlIiwKICAiYmVlbiIsCiAgImJlZm9yZSIsCiAgImJlaW5nIiwKICAiYmV0d2VlbiIsCiAgImJvdGgiLAogICJidXQiLAogICJieSIsCiAgImNhbWUiLAogICJjYW4iLAogICJjb21lIiwKICAiY291bGQiLAogICJkaWQiLAogICJkbyIsCiAgImVhY2giLAogICJmb3IiLAogICJmcm9tIiwKICAiZ2V0IiwKICAiZ290IiwKICAiaGFzIiwKICAiaGFkIiwKICAiaGUiLAogICJoYXZlIiwKICAiaGVyIiwKICAiaGVyZSIsCiAgImhpbSIsCiAgImhpbXNlbGYiLAogICJoaXMiLAogICJob3ciLAogICJpIiwKICAiaWYiLAogICJpbiIsCiAgImludG8iLAogICJpcyIsCiAgIml0IiwKICAibGlrZSIsCiAgIm1ha2UiLAogICJtYW55IiwKICAibWUiLAogICJtaWdodCIsCiAgIm1vcmUiLAogICJtb3N0IiwKICAibXVjaCIsCiAgIm11c3QiLAogICJteSIsCiAgIm5ldmVyIiwKICAibm93IiwKICAib2YiLAogICJvbiIsCiAgIm9ubHkiLAogICJvciIsCiAgIm90aGVyIiwKICAib3VyIiwKICAib3V0IiwKICAib3ZlciIsCiAgInNhaWQiLAogICJzYW1lIiwKICAic2VlIiwKICAic2hvdWxkIiwKICAic2luY2UiLAogICJzb21lIiwKICAic3RpbGwiLAogICJzdWNoIiwKICAidGFrZSIsCiAgInRoYW4iLAogICJ0aGF0IiwKICAidGhlIiwKICAidGhlaXIiLAogICJ0aGVtIiwKICAidGhlbiIsCiAgInRoZXJlIiwKICAidGhlc2UiLAogICJ0aGV5IiwKICAidGhpcyIsCiAgInRob3NlIiwKICAidGhyb3VnaCIsCiAgInRvIiwKICAidG9vIiwKICAidW5kZXIiLAogICJ1cCIsCiAgInZlcnkiLAogICJ3YXMiLAogICJ3YXkiLAogICJ3ZSIsCiAgIndlbGwiLAogICJ3ZXJlIiwKICAid2hhdCIsCiAgIndoZXJlIiwKICAid2hpY2giLAogICJ3aGlsZSIsCiAgIndobyIsCiAgIndpdGgiLAogICJ3b3VsZCIsCiAgInlvdSIsCiAgInlvdXIiCl0pOwpmdW5jdGlvbiB0b2tlbml6ZSh0ZXh0MikgewogIGlmICh0eXBlb2YgdGV4dDIgIT09ICJzdHJpbmciKSB7CiAgICByZXR1cm4gW107CiAgfQogIGNvbnN0IHdvcmRzID0gdGV4dDIudG9Mb3dlckNhc2UoKS5zcGxpdCgvXFcrLykuZmlsdGVyKCh3b3JkKSA9PiB3b3JkLmxlbmd0aCA+IDApOwogIHJldHVybiB3b3Jkcy5maWx0ZXIoKHdvcmQpID0+ICFTVE9QV09SRFMuaGFzKHdvcmQpKTsKfQpjbGFzcyBUZXh0SW5kZXggewogIGNvbnN0cnVjdG9yKG9wdGlvbnMgPSB7fSkgewogICAgY29uc3QgewogICAgICBvcmRlciA9IDE2LAogICAgICB0cmVlcwogICAgfSA9IG9wdGlvbnM7CiAgICB0aGlzLm9yZGVyID0gb3JkZXI7CiAgICB0aGlzLmluZGV4ID0gdHJlZXM/LmluZGV4IHx8IG51bGw7CiAgICB0aGlzLmRvY3VtZW50VGVybXMgPSB0cmVlcz8uZG9jdW1lbnRUZXJtcyB8fCBudWxsOwogICAgdGhpcy5kb2N1bWVudExlbmd0aHMgPSB0cmVlcz8uZG9jdW1lbnRMZW5ndGhzIHx8IG51bGw7CiAgICB0aGlzLmlzT3BlbiA9IGZhbHNlOwogIH0KICBhc3luYyBvcGVuKCkgewogICAgaWYgKHRoaXMuaXNPcGVuKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVGV4dEluZGV4IGlzIGFscmVhZHkgb3BlbiIpOwogICAgfQogICAgaWYgKCF0aGlzLmluZGV4IHx8ICF0aGlzLmRvY3VtZW50VGVybXMgfHwgIXRoaXMuZG9jdW1lbnRMZW5ndGhzKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVHJlZXMgbXVzdCBiZSBpbml0aWFsaXplZCBiZWZvcmUgb3BlbmluZyIpOwogICAgfQogICAgYXdhaXQgUHJvbWlzZS5hbGwoWwogICAgICB0aGlzLmluZGV4Lm9wZW4oKSwKICAgICAgdGhpcy5kb2N1bWVudFRlcm1zLm9wZW4oKSwKICAgICAgdGhpcy5kb2N1bWVudExlbmd0aHMub3BlbigpCiAgICBdKTsKICAgIHRoaXMuaXNPcGVuID0gdHJ1ZTsKICB9CiAgYXN5bmMgY2xvc2UoKSB7CiAgICBpZiAoIXRoaXMuaXNPcGVuKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGF3YWl0IFByb21pc2UuYWxsKFsKICAgICAgdGhpcy5pbmRleC5jbG9zZSgpLAogICAgICB0aGlzLmRvY3VtZW50VGVybXMuY2xvc2UoKSwKICAgICAgdGhpcy5kb2N1bWVudExlbmd0aHMuY2xvc2UoKQogICAgXSk7CiAgICB0aGlzLmlzT3BlbiA9IGZhbHNlOwogIH0KICBfZW5zdXJlT3BlbigpIHsKICAgIGlmICghdGhpcy5pc09wZW4pIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJUZXh0SW5kZXggaXMgbm90IG9wZW4iKTsKICAgIH0KICB9CiAgLyoqCiAgICogQWRkIHRlcm1zIGZyb20gdGV4dCB0byB0aGUgaW5kZXggZm9yIGEgZ2l2ZW4gZG9jdW1lbnQgSUQKICAgKiBAcGFyYW0ge3N0cmluZ30gZG9jSWQgLSBUaGUgZG9jdW1lbnQgaWRlbnRpZmllcgogICAqIEBwYXJhbSB7c3RyaW5nfSB0ZXh0IC0gVGhlIHRleHQgY29udGVudCB0byBpbmRleAogICAqLwogIGFzeW5jIGFkZChkb2NJZCwgdGV4dDIpIHsKICAgIHRoaXMuX2Vuc3VyZU9wZW4oKTsKICAgIGlmICghZG9jSWQpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJEb2N1bWVudCBJRCBpcyByZXF1aXJlZCIpOwogICAgfQogICAgY29uc3Qgd29yZHMgPSB0b2tlbml6ZSh0ZXh0Mik7CiAgICBjb25zdCB0ZXJtRnJlcXVlbmN5ID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIHdvcmRzLmZvckVhY2goKHdvcmQpID0+IHsKICAgICAgY29uc3Qgc3RlbSA9IHN0ZW1tZXIod29yZCk7CiAgICAgIHRlcm1GcmVxdWVuY3kuc2V0KHN0ZW0sICh0ZXJtRnJlcXVlbmN5LmdldChzdGVtKSB8fCAwKSArIDEpOwogICAgfSk7CiAgICBmb3IgKGNvbnN0IFtzdGVtLCBmcmVxdWVuY3ldIG9mIHRlcm1GcmVxdWVuY3kuZW50cmllcygpKSB7CiAgICAgIGNvbnN0IHBvc3RpbmdzID0gYXdhaXQgdGhpcy5pbmRleC5zZWFyY2goc3RlbSkgfHwge307CiAgICAgIHBvc3RpbmdzW2RvY0lkXSA9IGZyZXF1ZW5jeTsKICAgICAgYXdhaXQgdGhpcy5pbmRleC5hZGQoc3RlbSwgcG9zdGluZ3MpOwogICAgfQogICAgY29uc3QgZXhpc3RpbmdUZXJtcyA9IGF3YWl0IHRoaXMuZG9jdW1lbnRUZXJtcy5zZWFyY2goZG9jSWQpIHx8IHt9OwogICAgY29uc3QgbWVyZ2VkVGVybXMgPSB7IC4uLmV4aXN0aW5nVGVybXMgfTsKICAgIHRlcm1GcmVxdWVuY3kuZm9yRWFjaCgoZnJlcXVlbmN5LCBzdGVtKSA9PiB7CiAgICAgIG1lcmdlZFRlcm1zW3N0ZW1dID0gZnJlcXVlbmN5OwogICAgfSk7CiAgICBjb25zdCBkb2NMZW5ndGggPSBPYmplY3QudmFsdWVzKG1lcmdlZFRlcm1zKS5yZWR1Y2UoKHN1bSwgY291bnQpID0+IHN1bSArIGNvdW50LCAwKTsKICAgIGF3YWl0IHRoaXMuZG9jdW1lbnRUZXJtcy5hZGQoZG9jSWQsIG1lcmdlZFRlcm1zKTsKICAgIGF3YWl0IHRoaXMuZG9jdW1lbnRMZW5ndGhzLmFkZChkb2NJZCwgZG9jTGVuZ3RoKTsKICB9CiAgLyoqCiAgICogUmVtb3ZlIGFsbCBpbmRleGVkIHRlcm1zIGZvciBhIGdpdmVuIGRvY3VtZW50IElECiAgICogQHBhcmFtIHtzdHJpbmd9IGRvY0lkIC0gVGhlIGRvY3VtZW50IGlkZW50aWZpZXIgdG8gcmVtb3ZlCiAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgZG9jdW1lbnQgd2FzIGZvdW5kIGFuZCByZW1vdmVkLCBmYWxzZSBvdGhlcndpc2UKICAgKi8KICBhc3luYyByZW1vdmUoZG9jSWQpIHsKICAgIHRoaXMuX2Vuc3VyZU9wZW4oKTsKICAgIGNvbnN0IHRlcm1zID0gYXdhaXQgdGhpcy5kb2N1bWVudFRlcm1zLnNlYXJjaChkb2NJZCk7CiAgICBpZiAoIXRlcm1zKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGZvciAoY29uc3QgW3Rlcm1dIG9mIE9iamVjdC5lbnRyaWVzKHRlcm1zKSkgewogICAgICBjb25zdCBwb3N0aW5ncyA9IGF3YWl0IHRoaXMuaW5kZXguc2VhcmNoKHRlcm0pIHx8IHt9OwogICAgICBkZWxldGUgcG9zdGluZ3NbZG9jSWRdOwogICAgICBpZiAoT2JqZWN0LmtleXMocG9zdGluZ3MpLmxlbmd0aCA9PT0gMCkgewogICAgICAgIGF3YWl0IHRoaXMuaW5kZXguZGVsZXRlKHRlcm0pOwogICAgICB9IGVsc2UgewogICAgICAgIGF3YWl0IHRoaXMuaW5kZXguYWRkKHRlcm0sIHBvc3RpbmdzKTsKICAgICAgfQogICAgfQogICAgYXdhaXQgdGhpcy5kb2N1bWVudFRlcm1zLmRlbGV0ZShkb2NJZCk7CiAgICBhd2FpdCB0aGlzLmRvY3VtZW50TGVuZ3Rocy5kZWxldGUoZG9jSWQpOwogICAgcmV0dXJuIHRydWU7CiAgfQogIC8qKgogICAqIFF1ZXJ5IHRoZSBpbmRleCBmb3IgZG9jdW1lbnRzIGNvbnRhaW5pbmcgdGhlIGdpdmVuIHRlcm1zIHdpdGggcmVsZXZhbmNlIHNjb3JpbmcKICAgKiBAcGFyYW0ge3N0cmluZ30gcXVlcnlUZXh0IC0gVGhlIHNlYXJjaCBxdWVyeSB0ZXh0CiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgLSBRdWVyeSBvcHRpb25zCiAgICogQHBhcmFtIHtib29sZWFufSBvcHRpb25zLnNjb3JlZCAtIElmIHRydWUsIHJldHVybiBzY29yZWQgcmVzdWx0czsgaWYgZmFsc2UsIHJldHVybiBqdXN0IElEcyAoZGVmYXVsdDogdHJ1ZSkKICAgKiBAcGFyYW0ge2Jvb2xlYW59IG9wdGlvbnMucmVxdWlyZUFsbCAtIElmIHRydWUsIHJlcXVpcmUgQUxMIHRlcm1zOyBpZiBmYWxzZSwgcmFuayBieSByZWxldmFuY2UgKGRlZmF1bHQ6IGZhbHNlKQogICAqIEByZXR1cm5zIHtBcnJheX0gQXJyYXkgb2YgZG9jdW1lbnQgSURzIChpZiBzY29yZWQ9ZmFsc2UpIG9yIG9iamVjdHMgd2l0aCB7aWQsIHNjb3JlfSAoaWYgc2NvcmVkPXRydWUpCiAgICovCiAgYXN5bmMgcXVlcnkocXVlcnlUZXh0LCBvcHRpb25zID0geyBzY29yZWQ6IHRydWUsIHJlcXVpcmVBbGw6IGZhbHNlIH0pIHsKICAgIHRoaXMuX2Vuc3VyZU9wZW4oKTsKICAgIGNvbnN0IHdvcmRzID0gdG9rZW5pemUocXVlcnlUZXh0KTsKICAgIGlmICh3b3Jkcy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIFtdOwogICAgfQogICAgY29uc3Qgc3RlbW1lZFRlcm1zID0gd29yZHMubWFwKCh3b3JkKSA9PiBzdGVtbWVyKHdvcmQpKTsKICAgIGNvbnN0IHVuaXF1ZVRlcm1zID0gWy4uLm5ldyBTZXQoc3RlbW1lZFRlcm1zKV07CiAgICBpZiAob3B0aW9ucy5yZXF1aXJlQWxsKSB7CiAgICAgIGNvbnN0IGRvY1NldHMgPSBbXTsKICAgICAgZm9yIChjb25zdCB0ZXJtIG9mIHVuaXF1ZVRlcm1zKSB7CiAgICAgICAgY29uc3QgdGVybURvY3MgPSBhd2FpdCB0aGlzLmluZGV4LnNlYXJjaCh0ZXJtKTsKICAgICAgICBkb2NTZXRzLnB1c2gobmV3IFNldChPYmplY3Qua2V5cyh0ZXJtRG9jcyB8fCB7fSkpKTsKICAgICAgfQogICAgICBpZiAoZG9jU2V0cy5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgICAgY29uc3QgaW50ZXJzZWN0aW9uID0gbmV3IFNldChkb2NTZXRzWzBdKTsKICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBkb2NTZXRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgZm9yIChjb25zdCBkb2NJZCBvZiBbLi4uaW50ZXJzZWN0aW9uXSkgewogICAgICAgICAgaWYgKCFkb2NTZXRzW2ldLmhhcyhkb2NJZCkpIHsKICAgICAgICAgICAgaW50ZXJzZWN0aW9uLmRlbGV0ZShkb2NJZCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBBcnJheS5mcm9tKGludGVyc2VjdGlvbik7CiAgICB9CiAgICBjb25zdCBkb2NMZW5ndGhFbnRyaWVzID0gYXdhaXQgdGhpcy5kb2N1bWVudExlbmd0aHMudG9BcnJheSgpOwogICAgY29uc3QgZG9jTGVuZ3RoTWFwID0gbmV3IE1hcChkb2NMZW5ndGhFbnRyaWVzLm1hcCgoeyBrZXksIHZhbHVlIH0pID0+IFtTdHJpbmcoa2V5KSwgdmFsdWUgfHwgMV0pKTsKICAgIGNvbnN0IHRvdGFsRG9jcyA9IGRvY0xlbmd0aEVudHJpZXMubGVuZ3RoOwogICAgY29uc3QgaWRmID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIGZvciAoY29uc3QgdGVybSBvZiB1bmlxdWVUZXJtcykgewogICAgICBjb25zdCB0ZXJtRG9jcyA9IGF3YWl0IHRoaXMuaW5kZXguc2VhcmNoKHRlcm0pOwogICAgICBjb25zdCBkb2NzV2l0aFRlcm0gPSB0ZXJtRG9jcyA/IE9iamVjdC5rZXlzKHRlcm1Eb2NzKS5sZW5ndGggOiAwOwogICAgICBpZiAoZG9jc1dpdGhUZXJtID4gMCkgewogICAgICAgIGlkZi5zZXQodGVybSwgTWF0aC5sb2codG90YWxEb2NzIC8gZG9jc1dpdGhUZXJtKSk7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IGRvY1Njb3JlcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICBmb3IgKGNvbnN0IHRlcm0gb2YgdW5pcXVlVGVybXMpIHsKICAgICAgY29uc3QgdGVybURvY3MgPSBhd2FpdCB0aGlzLmluZGV4LnNlYXJjaCh0ZXJtKTsKICAgICAgaWYgKCF0ZXJtRG9jcykgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGZvciAoY29uc3QgW2RvY0lkLCB0ZXJtRnJlcV0gb2YgT2JqZWN0LmVudHJpZXModGVybURvY3MpKSB7CiAgICAgICAgY29uc3QgZG9jTGVuZ3RoID0gZG9jTGVuZ3RoTWFwLmdldChkb2NJZCkgfHwgMTsKICAgICAgICBjb25zdCB0ZiA9IHRlcm1GcmVxIC8gZG9jTGVuZ3RoOwogICAgICAgIGNvbnN0IHRlcm1JZGYgPSBpZGYuZ2V0KHRlcm0pIHx8IDA7CiAgICAgICAgY29uc3QgcHJldiA9IGRvY1Njb3Jlcy5nZXQoZG9jSWQpIHx8IDA7CiAgICAgICAgZG9jU2NvcmVzLnNldChkb2NJZCwgcHJldiArIHRmICogdGVybUlkZik7CiAgICAgIH0KICAgIH0KICAgIGZvciAoY29uc3QgW2RvY0lkLCBzY29yZV0gb2YgZG9jU2NvcmVzLmVudHJpZXMoKSkgewogICAgICBjb25zdCBkb2NUZXJtcyA9IGF3YWl0IHRoaXMuZG9jdW1lbnRUZXJtcy5zZWFyY2goZG9jSWQpIHx8IHt9OwogICAgICBjb25zdCBtYXRjaGluZ1Rlcm1zID0gdW5pcXVlVGVybXMuZmlsdGVyKCh0ZXJtKSA9PiAhIWRvY1Rlcm1zW3Rlcm1dKS5sZW5ndGg7CiAgICAgIGNvbnN0IGNvdmVyYWdlID0gbWF0Y2hpbmdUZXJtcyAvIHVuaXF1ZVRlcm1zLmxlbmd0aDsKICAgICAgZG9jU2NvcmVzLnNldChkb2NJZCwgc2NvcmUgKiAoMSArIGNvdmVyYWdlKSk7CiAgICB9CiAgICBjb25zdCByZXN1bHRzID0gQXJyYXkuZnJvbShkb2NTY29yZXMuZW50cmllcygpKS5tYXAoKFtpZCwgc2NvcmVdKSA9PiAoeyBpZCwgc2NvcmUgfSkpLnNvcnQoKGEsIGIpID0+IGIuc2NvcmUgLSBhLnNjb3JlKTsKICAgIGlmIChvcHRpb25zLnNjb3JlZCA9PT0gZmFsc2UpIHsKICAgICAgcmV0dXJuIHJlc3VsdHMubWFwKChyKSA9PiByLmlkKTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH0KICAvKioKICAgKiBHZXQgdGhlIG51bWJlciBvZiB1bmlxdWUgdGVybXMgaW4gdGhlIGluZGV4CiAgICogQHJldHVybnMge251bWJlcn0gTnVtYmVyIG9mIHVuaXF1ZSB0ZXJtcwogICAqLwogIGFzeW5jIGdldFRlcm1Db3VudCgpIHsKICAgIHRoaXMuX2Vuc3VyZU9wZW4oKTsKICAgIGNvbnN0IHRlcm1zID0gYXdhaXQgdGhpcy5pbmRleC50b0FycmF5KCk7CiAgICByZXR1cm4gdGVybXMubGVuZ3RoOwogIH0KICAvKioKICAgKiBHZXQgdGhlIG51bWJlciBvZiBkb2N1bWVudHMgaW4gdGhlIGluZGV4CiAgICogQHJldHVybnMge251bWJlcn0gTnVtYmVyIG9mIGluZGV4ZWQgZG9jdW1lbnRzCiAgICovCiAgYXN5bmMgZ2V0RG9jdW1lbnRDb3VudCgpIHsKICAgIHRoaXMuX2Vuc3VyZU9wZW4oKTsKICAgIGNvbnN0IGRvY3MgPSBhd2FpdCB0aGlzLmRvY3VtZW50VGVybXMudG9BcnJheSgpOwogICAgcmV0dXJuIGRvY3MubGVuZ3RoOwogIH0KICAvKioKICAgKiBDbGVhciBhbGwgZGF0YSBmcm9tIHRoZSBpbmRleAogICAqLwogIGFzeW5jIGNsZWFyKCkgewogICAgdGhpcy5fZW5zdXJlT3BlbigpOwogICAgY29uc3QgW3Rlcm1zLCBkb2NzLCBsZW5ndGhzXSA9IGF3YWl0IFByb21pc2UuYWxsKFsKICAgICAgdGhpcy5pbmRleC50b0FycmF5KCksCiAgICAgIHRoaXMuZG9jdW1lbnRUZXJtcy50b0FycmF5KCksCiAgICAgIHRoaXMuZG9jdW1lbnRMZW5ndGhzLnRvQXJyYXkoKQogICAgXSk7CiAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIHRlcm1zKSB7CiAgICAgIGF3YWl0IHRoaXMuaW5kZXguZGVsZXRlKGVudHJ5LmtleSk7CiAgICB9CiAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIGRvY3MpIHsKICAgICAgYXdhaXQgdGhpcy5kb2N1bWVudFRlcm1zLmRlbGV0ZShlbnRyeS5rZXkpOwogICAgfQogICAgZm9yIChjb25zdCBlbnRyeSBvZiBsZW5ndGhzKSB7CiAgICAgIGF3YWl0IHRoaXMuZG9jdW1lbnRMZW5ndGhzLmRlbGV0ZShlbnRyeS5rZXkpOwogICAgfQogIH0KICAvKioKICAgKiBDb21wYWN0IGFsbCBpbnRlcm5hbCBCKyB0cmVlcyB1c2luZyBwcm92aWRlZCBkZXN0aW5hdGlvbiB0cmVlIGluc3RhbmNlcy4KICAgKiBUaGUgZGVzdGluYXRpb24gdHJlZXMgc2hvdWxkIGJlIGZyZXNobHkgY3JlYXRlZCAodW5vcGVuZWQpIHdpdGggbmV3IHN5bmMgaGFuZGxlcy4KICAgKiBBZnRlciBjb21wYWN0aW9uIGNvbXBsZXRlcywgdGhlIGRlc3RpbmF0aW9uIHN5bmMgaGFuZGxlcyB3aWxsIGJlIGNsb3NlZC4KICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAtIENvbXBhY3Rpb24gb3B0aW9ucyAgCiAgICogQHBhcmFtIHtCUGx1c1RyZWV9IG9wdGlvbnMuaW5kZXggLSBGcmVzaCBkZXN0aW5hdGlvbiB0cmVlIGZvciBpbmRleCBkYXRhCiAgICogQHBhcmFtIHtCUGx1c1RyZWV9IG9wdGlvbnMuZG9jdW1lbnRUZXJtcyAtIEZyZXNoIGRlc3RpbmF0aW9uIHRyZWUgZm9yIGRvY3VtZW50IHRlcm1zCiAgICogQHBhcmFtIHtCUGx1c1RyZWV9IG9wdGlvbnMuZG9jdW1lbnRMZW5ndGhzIC0gRnJlc2ggZGVzdGluYXRpb24gdHJlZSBmb3IgZG9jdW1lbnQgbGVuZ3RocwogICAqIEByZXR1cm5zIHtQcm9taXNlPHt0ZXJtczogb2JqZWN0LCBkb2N1bWVudHM6IG9iamVjdCwgbGVuZ3Roczogb2JqZWN0fT59CiAgICovCiAgYXN5bmMgY29tcGFjdCh7IGluZGV4OiBkZXN0SW5kZXgsIGRvY3VtZW50VGVybXM6IGRlc3REb2NUZXJtcywgZG9jdW1lbnRMZW5ndGhzOiBkZXN0RG9jTGVuZ3RocyB9KSB7CiAgICB0aGlzLl9lbnN1cmVPcGVuKCk7CiAgICBpZiAoIWRlc3RJbmRleCB8fCAhZGVzdERvY1Rlcm1zIHx8ICFkZXN0RG9jTGVuZ3RocykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIkRlc3RpbmF0aW9uIHRyZWVzIG11c3QgYmUgcHJvdmlkZWQgZm9yIGNvbXBhY3Rpb24iKTsKICAgIH0KICAgIGNvbnN0IHRlcm1zUmVzdWx0ID0gYXdhaXQgdGhpcy5pbmRleC5jb21wYWN0KGRlc3RJbmRleC5maWxlLnN5bmNBY2Nlc3NIYW5kbGUpOwogICAgY29uc3QgZG9jdW1lbnRzUmVzdWx0ID0gYXdhaXQgdGhpcy5kb2N1bWVudFRlcm1zLmNvbXBhY3QoZGVzdERvY1Rlcm1zLmZpbGUuc3luY0FjY2Vzc0hhbmRsZSk7CiAgICBjb25zdCBsZW5ndGhzUmVzdWx0ID0gYXdhaXQgdGhpcy5kb2N1bWVudExlbmd0aHMuY29tcGFjdChkZXN0RG9jTGVuZ3Rocy5maWxlLnN5bmNBY2Nlc3NIYW5kbGUpOwogICAgYXdhaXQgdGhpcy5jbG9zZSgpOwogICAgdGhpcy5pc09wZW4gPSBmYWxzZTsKICAgIHJldHVybiB7CiAgICAgIHRlcm1zOiB0ZXJtc1Jlc3VsdCwKICAgICAgZG9jdW1lbnRzOiBkb2N1bWVudHNSZXN1bHQsCiAgICAgIGxlbmd0aHM6IGxlbmd0aHNSZXN1bHQKICAgIH07CiAgfQp9CmZ1bmN0aW9uIGV2YWx1YXRlRXhwcmVzc2lvbihleHByLCBkb2MpIHsKICBpZiAoZXhwciA9PT0gbnVsbCB8fCBleHByID09PSB2b2lkIDApIHsKICAgIHJldHVybiBleHByOwogIH0KICBpZiAodHlwZW9mIGV4cHIgPT09ICJib29sZWFuIiB8fCB0eXBlb2YgZXhwciA9PT0gIm51bWJlciIpIHsKICAgIHJldHVybiBleHByOwogIH0KICBpZiAodHlwZW9mIGV4cHIgPT09ICJzdHJpbmciKSB7CiAgICBpZiAoZXhwci5zdGFydHNXaXRoKCIkJCIpKSB7CiAgICAgIGlmIChleHByID09PSAiJCRLRUVQIiB8fCBleHByID09PSAiJCRQUlVORSIgfHwgZXhwciA9PT0gIiQkREVTQ0VORCIpIHsKICAgICAgICByZXR1cm4gZXhwcjsKICAgICAgfQogICAgICByZXR1cm4gZ2V0UHJvcChkb2MsIGV4cHIuc3Vic3RyaW5nKDIpKTsKICAgIH0gZWxzZSBpZiAoZXhwci5jaGFyQXQoMCkgPT09ICIkIikgewogICAgICByZXR1cm4gZ2V0UHJvcChkb2MsIGV4cHIuc3Vic3RyaW5nKDEpKTsKICAgIH0KICAgIHJldHVybiBleHByOwogIH0KICBpZiAodHlwZW9mIGV4cHIgPT09ICJvYmplY3QiKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheShleHByKSkgewogICAgICByZXR1cm4gZXhwci5tYXAoKGl0ZW0pID0+IGV2YWx1YXRlRXhwcmVzc2lvbihpdGVtLCBkb2MpKTsKICAgIH0KICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhleHByKTsKICAgIGlmIChrZXlzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gZXhwcjsKICAgIH0KICAgIGNvbnN0IG9wZXJhdG9yID0ga2V5c1swXTsKICAgIGlmIChvcGVyYXRvci5jaGFyQXQoMCkgPT09ICIkIikgewogICAgICBjb25zdCBvcGVyYW5kID0gZXhwcltvcGVyYXRvcl07CiAgICAgIHJldHVybiBldmFsdWF0ZU9wZXJhdG9yKG9wZXJhdG9yLCBvcGVyYW5kLCBkb2MpOwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgcmVzdWx0ID0ge307CiAgICAgIGZvciAoY29uc3Qga2V5IG9mIGtleXMpIHsKICAgICAgICByZXN1bHRba2V5XSA9IGV2YWx1YXRlRXhwcmVzc2lvbihleHByW2tleV0sIGRvYyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICB9CiAgcmV0dXJuIGV4cHI7Cn0KZnVuY3Rpb24gZXZhbHVhdGVPcGVyYXRvcihvcGVyYXRvciwgb3BlcmFuZCwgZG9jKSB7CiAgc3dpdGNoIChvcGVyYXRvcikgewogICAgLy8gQXJpdGhtZXRpYyBvcGVyYXRvcnMKICAgIGNhc2UgIiRhZGQiOgogICAgICByZXR1cm4gZXZhbEFkZChvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJHN1YnRyYWN0IjoKICAgICAgcmV0dXJuIGV2YWxTdWJ0cmFjdChvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJG11bHRpcGx5IjoKICAgICAgcmV0dXJuIGV2YWxNdWx0aXBseShvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJGRpdmlkZSI6CiAgICAgIHJldHVybiBldmFsRGl2aWRlKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkbW9kIjoKICAgICAgcmV0dXJuIGV2YWxNb2Qob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRwb3ciOgogICAgICByZXR1cm4gZXZhbFBvdyhvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJHNxcnQiOgogICAgICByZXR1cm4gZXZhbFNxcnQob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRhYnMiOgogICAgICByZXR1cm4gZXZhbEFicyhvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJGNlaWwiOgogICAgICByZXR1cm4gZXZhbENlaWwob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRmbG9vciI6CiAgICAgIHJldHVybiBldmFsRmxvb3Iob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiR0cnVuYyI6CiAgICAgIHJldHVybiBldmFsVHJ1bmMob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRyb3VuZCI6CiAgICAgIHJldHVybiBldmFsUm91bmQob3BlcmFuZCwgZG9jKTsKICAgIC8vIFN0cmluZyBvcGVyYXRvcnMKICAgIGNhc2UgIiRjb25jYXQiOgogICAgICByZXR1cm4gZXZhbENvbmNhdChvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJHN1YnN0ciI6CiAgICAgIHJldHVybiBldmFsU3Vic3RyKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkdG9Mb3dlciI6CiAgICAgIHJldHVybiBldmFsVG9Mb3dlcihvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJHRvVXBwZXIiOgogICAgICByZXR1cm4gZXZhbFRvVXBwZXIob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiR0cmltIjoKICAgICAgcmV0dXJuIGV2YWxUcmltKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkbHRyaW0iOgogICAgICByZXR1cm4gZXZhbEx0cmltKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkcnRyaW0iOgogICAgICByZXR1cm4gZXZhbFJ0cmltKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkc3BsaXQiOgogICAgICByZXR1cm4gZXZhbFNwbGl0KG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkc3RyTGVuQ1AiOgogICAgICByZXR1cm4gZXZhbFN0ckxlbkNQKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkc3RyY2FzZWNtcCI6CiAgICAgIHJldHVybiBldmFsU3RyY2FzZWNtcChvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJGluZGV4T2ZDUCI6CiAgICAgIHJldHVybiBldmFsSW5kZXhPZkNQKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkcmVwbGFjZU9uZSI6CiAgICAgIHJldHVybiBldmFsUmVwbGFjZU9uZShvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJHJlcGxhY2VBbGwiOgogICAgICByZXR1cm4gZXZhbFJlcGxhY2VBbGwob3BlcmFuZCwgZG9jKTsKICAgIC8vIENvbXBhcmlzb24gb3BlcmF0b3JzCiAgICBjYXNlICIkY21wIjoKICAgICAgcmV0dXJuIGV2YWxDbXAob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRlcSI6CiAgICAgIHJldHVybiBldmFsRXEob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRuZSI6CiAgICAgIHJldHVybiBldmFsTmUob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRndCI6CiAgICAgIHJldHVybiBldmFsR3Qob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRndGUiOgogICAgICByZXR1cm4gZXZhbEd0ZShvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJGx0IjoKICAgICAgcmV0dXJuIGV2YWxMdChvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJGx0ZSI6CiAgICAgIHJldHVybiBldmFsTHRlKG9wZXJhbmQsIGRvYyk7CiAgICAvLyBMb2dpY2FsIG9wZXJhdG9ycwogICAgY2FzZSAiJGFuZCI6CiAgICAgIHJldHVybiBldmFsQW5kKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkb3IiOgogICAgICByZXR1cm4gZXZhbE9yKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkbm90IjoKICAgICAgcmV0dXJuIGV2YWxOb3Qob3BlcmFuZCwgZG9jKTsKICAgIC8vIENvbmRpdGlvbmFsIG9wZXJhdG9ycwogICAgY2FzZSAiJGNvbmQiOgogICAgICByZXR1cm4gZXZhbENvbmQob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRpZk51bGwiOgogICAgICByZXR1cm4gZXZhbElmTnVsbChvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJHN3aXRjaCI6CiAgICAgIHJldHVybiBldmFsU3dpdGNoKG9wZXJhbmQsIGRvYyk7CiAgICAvLyBEYXRlIG9wZXJhdG9ycwogICAgY2FzZSAiJHllYXIiOgogICAgICByZXR1cm4gZXZhbFllYXIob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRtb250aCI6CiAgICAgIHJldHVybiBldmFsTW9udGgob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRkYXlPZk1vbnRoIjoKICAgICAgcmV0dXJuIGV2YWxEYXlPZk1vbnRoKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkZGF5T2ZXZWVrIjoKICAgICAgcmV0dXJuIGV2YWxEYXlPZldlZWsob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRkYXlPZlllYXIiOgogICAgICByZXR1cm4gZXZhbERheU9mWWVhcihvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJGhvdXIiOgogICAgICByZXR1cm4gZXZhbEhvdXIob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRtaW51dGUiOgogICAgICByZXR1cm4gZXZhbE1pbnV0ZShvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJHNlY29uZCI6CiAgICAgIHJldHVybiBldmFsU2Vjb25kKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkbWlsbGlzZWNvbmQiOgogICAgICByZXR1cm4gZXZhbE1pbGxpc2Vjb25kKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkd2VlayI6CiAgICAgIHJldHVybiBldmFsV2VlayhvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJGlzb1dlZWsiOgogICAgICByZXR1cm4gZXZhbElzb1dlZWsob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRpc29XZWVrWWVhciI6CiAgICAgIHJldHVybiBldmFsSXNvV2Vla1llYXIob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRkYXRlVG9TdHJpbmciOgogICAgICByZXR1cm4gZXZhbERhdGVUb1N0cmluZyhvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJHRvRGF0ZSI6CiAgICAgIHJldHVybiBldmFsVG9EYXRlKG9wZXJhbmQsIGRvYyk7CiAgICAvLyBBcnJheSBvcGVyYXRvcnMKICAgIGNhc2UgIiRhcnJheUVsZW1BdCI6CiAgICAgIHJldHVybiBldmFsQXJyYXlFbGVtQXQob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRjb25jYXRBcnJheXMiOgogICAgICByZXR1cm4gZXZhbENvbmNhdEFycmF5cyhvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJGZpbHRlciI6CiAgICAgIHJldHVybiBldmFsRmlsdGVyKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkaW4iOgogICAgICByZXR1cm4gZXZhbEluKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkaW5kZXhPZkFycmF5IjoKICAgICAgcmV0dXJuIGV2YWxJbmRleE9mQXJyYXkob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRpc0FycmF5IjoKICAgICAgcmV0dXJuIGV2YWxJc0FycmF5KG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkbWFwIjoKICAgICAgcmV0dXJuIGV2YWxNYXAob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRyZWR1Y2UiOgogICAgICByZXR1cm4gZXZhbFJlZHVjZShvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJHNpemUiOgogICAgICByZXR1cm4gZXZhbFNpemUob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRzbGljZSI6CiAgICAgIHJldHVybiBldmFsU2xpY2Uob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRyZXZlcnNlQXJyYXkiOgogICAgICByZXR1cm4gZXZhbFJldmVyc2VBcnJheShvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJHppcCI6CiAgICAgIHJldHVybiBldmFsWmlwKG9wZXJhbmQsIGRvYyk7CiAgICAvLyBUeXBlIG9wZXJhdG9ycwogICAgY2FzZSAiJHR5cGUiOgogICAgICByZXR1cm4gZXZhbFR5cGUob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRjb252ZXJ0IjoKICAgICAgcmV0dXJuIGV2YWxDb252ZXJ0KG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkdG9Cb29sIjoKICAgICAgcmV0dXJuIGV2YWxUb0Jvb2wob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiR0b0RlY2ltYWwiOgogICAgICByZXR1cm4gZXZhbFRvRGVjaW1hbChvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJHRvRG91YmxlIjoKICAgICAgcmV0dXJuIGV2YWxUb0RvdWJsZShvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJHRvSW50IjoKICAgICAgcmV0dXJuIGV2YWxUb0ludChvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJHRvTG9uZyI6CiAgICAgIHJldHVybiBldmFsVG9Mb25nKG9wZXJhbmQsIGRvYyk7CiAgICBjYXNlICIkdG9TdHJpbmciOgogICAgICByZXR1cm4gZXZhbFRvU3RyaW5nKG9wZXJhbmQsIGRvYyk7CiAgICAvLyBPYmplY3Qgb3BlcmF0b3JzCiAgICBjYXNlICIkb2JqZWN0VG9BcnJheSI6CiAgICAgIHJldHVybiBldmFsT2JqZWN0VG9BcnJheShvcGVyYW5kLCBkb2MpOwogICAgY2FzZSAiJGFycmF5VG9PYmplY3QiOgogICAgICByZXR1cm4gZXZhbEFycmF5VG9PYmplY3Qob3BlcmFuZCwgZG9jKTsKICAgIGNhc2UgIiRtZXJnZU9iamVjdHMiOgogICAgICByZXR1cm4gZXZhbE1lcmdlT2JqZWN0cyhvcGVyYW5kLCBkb2MpOwogICAgLy8gTGl0ZXJhbCBvcGVyYXRvcgogICAgY2FzZSAiJGxpdGVyYWwiOgogICAgICByZXR1cm4gb3BlcmFuZDsKICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5zdXBwb3J0ZWQgYWdncmVnYXRpb24gb3BlcmF0b3I6ICR7b3BlcmF0b3J9YCk7CiAgfQp9CmZ1bmN0aW9uIGV2YWxBZGQob3BlcmFuZHMsIGRvYykgewogIGlmICghQXJyYXkuaXNBcnJheShvcGVyYW5kcykpIHJldHVybiBudWxsOwogIGxldCBzdW0gPSAwOwogIGZvciAoY29uc3Qgb3BlcmFuZCBvZiBvcGVyYW5kcykgewogICAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgICBpZiAodmFsIGluc3RhbmNlb2YgRGF0ZSkgewogICAgICBzdW0gKz0gdmFsLmdldFRpbWUoKTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gIm51bWJlciIpIHsKICAgICAgc3VtICs9IHZhbDsKICAgIH0KICB9CiAgcmV0dXJuIHN1bTsKfQpmdW5jdGlvbiBldmFsU3VidHJhY3Qob3BlcmFuZHMsIGRvYykgewogIGlmICghQXJyYXkuaXNBcnJheShvcGVyYW5kcykgfHwgb3BlcmFuZHMubGVuZ3RoICE9PSAyKSByZXR1cm4gbnVsbDsKICBjb25zdCB2YWwxID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmRzWzBdLCBkb2MpOwogIGNvbnN0IHZhbDIgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMV0sIGRvYyk7CiAgaWYgKHZhbDEgaW5zdGFuY2VvZiBEYXRlICYmIHZhbDIgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICByZXR1cm4gdmFsMS5nZXRUaW1lKCkgLSB2YWwyLmdldFRpbWUoKTsKICB9IGVsc2UgaWYgKHZhbDEgaW5zdGFuY2VvZiBEYXRlICYmIHR5cGVvZiB2YWwyID09PSAibnVtYmVyIikgewogICAgcmV0dXJuIG5ldyBEYXRlKHZhbDEuZ2V0VGltZSgpIC0gdmFsMik7CiAgfSBlbHNlIGlmICh0eXBlb2YgdmFsMSA9PT0gIm51bWJlciIgJiYgdHlwZW9mIHZhbDIgPT09ICJudW1iZXIiKSB7CiAgICByZXR1cm4gdmFsMSAtIHZhbDI7CiAgfQogIHJldHVybiBudWxsOwp9CmZ1bmN0aW9uIGV2YWxNdWx0aXBseShvcGVyYW5kcywgZG9jKSB7CiAgaWYgKCFBcnJheS5pc0FycmF5KG9wZXJhbmRzKSkgcmV0dXJuIG51bGw7CiAgbGV0IHByb2R1Y3QgPSAxOwogIGZvciAoY29uc3Qgb3BlcmFuZCBvZiBvcGVyYW5kcykgewogICAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgICBpZiAodHlwZW9mIHZhbCA9PT0gIm51bWJlciIpIHsKICAgICAgcHJvZHVjdCAqPSB2YWw7CiAgICB9CiAgfQogIHJldHVybiBwcm9kdWN0Owp9CmZ1bmN0aW9uIGV2YWxEaXZpZGUob3BlcmFuZHMsIGRvYykgewogIGlmICghQXJyYXkuaXNBcnJheShvcGVyYW5kcykgfHwgb3BlcmFuZHMubGVuZ3RoICE9PSAyKSByZXR1cm4gbnVsbDsKICBjb25zdCB2YWwxID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmRzWzBdLCBkb2MpOwogIGNvbnN0IHZhbDIgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMV0sIGRvYyk7CiAgaWYgKHR5cGVvZiB2YWwxID09PSAibnVtYmVyIiAmJiB0eXBlb2YgdmFsMiA9PT0gIm51bWJlciIgJiYgdmFsMiAhPT0gMCkgewogICAgcmV0dXJuIHZhbDEgLyB2YWwyOwogIH0KICByZXR1cm4gbnVsbDsKfQpmdW5jdGlvbiBldmFsTW9kKG9wZXJhbmRzLCBkb2MpIHsKICBpZiAoIUFycmF5LmlzQXJyYXkob3BlcmFuZHMpIHx8IG9wZXJhbmRzLmxlbmd0aCAhPT0gMikgcmV0dXJuIG51bGw7CiAgY29uc3QgdmFsMSA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1swXSwgZG9jKTsKICBjb25zdCB2YWwyID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmRzWzFdLCBkb2MpOwogIGlmICh0eXBlb2YgdmFsMSA9PT0gIm51bWJlciIgJiYgdHlwZW9mIHZhbDIgPT09ICJudW1iZXIiICYmIHZhbDIgIT09IDApIHsKICAgIHJldHVybiB2YWwxICUgdmFsMjsKICB9CiAgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gZXZhbFBvdyhvcGVyYW5kcywgZG9jKSB7CiAgaWYgKCFBcnJheS5pc0FycmF5KG9wZXJhbmRzKSB8fCBvcGVyYW5kcy5sZW5ndGggIT09IDIpIHJldHVybiBudWxsOwogIGNvbnN0IGJhc2UgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMF0sIGRvYyk7CiAgY29uc3QgZXhwb25lbnQgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMV0sIGRvYyk7CiAgaWYgKHR5cGVvZiBiYXNlID09PSAibnVtYmVyIiAmJiB0eXBlb2YgZXhwb25lbnQgPT09ICJudW1iZXIiKSB7CiAgICByZXR1cm4gTWF0aC5wb3coYmFzZSwgZXhwb25lbnQpOwogIH0KICByZXR1cm4gbnVsbDsKfQpmdW5jdGlvbiBldmFsU3FydChvcGVyYW5kLCBkb2MpIHsKICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZCwgZG9jKTsKICBpZiAodHlwZW9mIHZhbCA9PT0gIm51bWJlciIgJiYgdmFsID49IDApIHsKICAgIHJldHVybiBNYXRoLnNxcnQodmFsKTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gZXZhbEFicyhvcGVyYW5kLCBkb2MpIHsKICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZCwgZG9jKTsKICBpZiAodHlwZW9mIHZhbCA9PT0gIm51bWJlciIpIHsKICAgIHJldHVybiBNYXRoLmFicyh2YWwpOwogIH0KICByZXR1cm4gbnVsbDsKfQpmdW5jdGlvbiBldmFsQ2VpbChvcGVyYW5kLCBkb2MpIHsKICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZCwgZG9jKTsKICBpZiAodHlwZW9mIHZhbCA9PT0gIm51bWJlciIpIHsKICAgIHJldHVybiBNYXRoLmNlaWwodmFsKTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gZXZhbEZsb29yKG9wZXJhbmQsIGRvYykgewogIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLCBkb2MpOwogIGlmICh0eXBlb2YgdmFsID09PSAibnVtYmVyIikgewogICAgcmV0dXJuIE1hdGguZmxvb3IodmFsKTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gZXZhbFRydW5jKG9wZXJhbmQsIGRvYykgewogIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLCBkb2MpOwogIGlmICh0eXBlb2YgdmFsID09PSAibnVtYmVyIikgewogICAgcmV0dXJuIE1hdGgudHJ1bmModmFsKTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gZXZhbFJvdW5kKG9wZXJhbmRzLCBkb2MpIHsKICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24oQXJyYXkuaXNBcnJheShvcGVyYW5kcykgPyBvcGVyYW5kc1swXSA6IG9wZXJhbmRzLCBkb2MpOwogIGNvbnN0IHBsYWNlID0gQXJyYXkuaXNBcnJheShvcGVyYW5kcykgJiYgb3BlcmFuZHNbMV0gIT09IHZvaWQgMCA/IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1sxXSwgZG9jKSA6IDA7CiAgaWYgKHR5cGVvZiB2YWwgPT09ICJudW1iZXIiICYmIHR5cGVvZiBwbGFjZSA9PT0gIm51bWJlciIpIHsKICAgIGNvbnN0IG11bHRpcGxpZXIgPSBNYXRoLnBvdygxMCwgcGxhY2UpOwogICAgcmV0dXJuIE1hdGgucm91bmQodmFsICogbXVsdGlwbGllcikgLyBtdWx0aXBsaWVyOwogIH0KICByZXR1cm4gbnVsbDsKfQpmdW5jdGlvbiBldmFsQ29uY2F0KG9wZXJhbmRzLCBkb2MpIHsKICBpZiAoIUFycmF5LmlzQXJyYXkob3BlcmFuZHMpKSByZXR1cm4gbnVsbDsKICBsZXQgcmVzdWx0ID0gIiI7CiAgZm9yIChjb25zdCBvcGVyYW5kIG9mIG9wZXJhbmRzKSB7CiAgICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZCwgZG9jKTsKICAgIGlmICh2YWwgIT09IG51bGwgJiYgdmFsICE9PSB2b2lkIDApIHsKICAgICAgcmVzdWx0ICs9IFN0cmluZyh2YWwpOwogICAgfQogIH0KICByZXR1cm4gcmVzdWx0Owp9CmZ1bmN0aW9uIGV2YWxTdWJzdHIob3BlcmFuZHMsIGRvYykgewogIGlmICghQXJyYXkuaXNBcnJheShvcGVyYW5kcykgfHwgb3BlcmFuZHMubGVuZ3RoIDwgMykgcmV0dXJuIG51bGw7CiAgY29uc3Qgc3RyID0gU3RyaW5nKGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1swXSwgZG9jKSB8fCAiIik7CiAgY29uc3Qgc3RhcnQgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMV0sIGRvYyk7CiAgY29uc3QgbGVuZ3RoID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmRzWzJdLCBkb2MpOwogIGlmICh0eXBlb2Ygc3RhcnQgPT09ICJudW1iZXIiICYmIHR5cGVvZiBsZW5ndGggPT09ICJudW1iZXIiKSB7CiAgICByZXR1cm4gc3RyLnN1YnN0cihzdGFydCwgbGVuZ3RoKTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gZXZhbFRvTG93ZXIob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgcmV0dXJuIHZhbCAhPT0gbnVsbCAmJiB2YWwgIT09IHZvaWQgMCA/IFN0cmluZyh2YWwpLnRvTG93ZXJDYXNlKCkgOiAiIjsKfQpmdW5jdGlvbiBldmFsVG9VcHBlcihvcGVyYW5kLCBkb2MpIHsKICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZCwgZG9jKTsKICByZXR1cm4gdmFsICE9PSBudWxsICYmIHZhbCAhPT0gdm9pZCAwID8gU3RyaW5nKHZhbCkudG9VcHBlckNhc2UoKSA6ICIiOwp9CmZ1bmN0aW9uIGV2YWxUcmltKG9wZXJhbmQsIGRvYykgewogIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbih0eXBlb2Ygb3BlcmFuZCA9PT0gIm9iamVjdCIgJiYgb3BlcmFuZC5pbnB1dCA/IG9wZXJhbmQuaW5wdXQgOiBvcGVyYW5kLCBkb2MpOwogIGNvbnN0IGNoYXJzID0gb3BlcmFuZC5jaGFycyA/IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLmNoYXJzLCBkb2MpIDogbnVsbDsKICBsZXQgc3RyID0gdmFsICE9PSBudWxsICYmIHZhbCAhPT0gdm9pZCAwID8gU3RyaW5nKHZhbCkgOiAiIjsKICBpZiAoY2hhcnMpIHsKICAgIGNvbnN0IGNoYXJzUmVnZXggPSBuZXcgUmVnRXhwKGBeWyR7ZXNjYXBlUmVnZXgoY2hhcnMpfV0rfFske2VzY2FwZVJlZ2V4KGNoYXJzKX1dKyRgLCAiZyIpOwogICAgcmV0dXJuIHN0ci5yZXBsYWNlKGNoYXJzUmVnZXgsICIiKTsKICB9CiAgcmV0dXJuIHN0ci50cmltKCk7Cn0KZnVuY3Rpb24gZXZhbEx0cmltKG9wZXJhbmQsIGRvYykgewogIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbih0eXBlb2Ygb3BlcmFuZCA9PT0gIm9iamVjdCIgJiYgb3BlcmFuZC5pbnB1dCA/IG9wZXJhbmQuaW5wdXQgOiBvcGVyYW5kLCBkb2MpOwogIGNvbnN0IGNoYXJzID0gb3BlcmFuZC5jaGFycyA/IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLmNoYXJzLCBkb2MpIDogbnVsbDsKICBsZXQgc3RyID0gdmFsICE9PSBudWxsICYmIHZhbCAhPT0gdm9pZCAwID8gU3RyaW5nKHZhbCkgOiAiIjsKICBpZiAoY2hhcnMpIHsKICAgIGNvbnN0IGNoYXJzUmVnZXggPSBuZXcgUmVnRXhwKGBeWyR7ZXNjYXBlUmVnZXgoY2hhcnMpfV0rYCwgImciKTsKICAgIHJldHVybiBzdHIucmVwbGFjZShjaGFyc1JlZ2V4LCAiIik7CiAgfQogIHJldHVybiBzdHIucmVwbGFjZSgvXlxzKy8sICIiKTsKfQpmdW5jdGlvbiBldmFsUnRyaW0ob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKHR5cGVvZiBvcGVyYW5kID09PSAib2JqZWN0IiAmJiBvcGVyYW5kLmlucHV0ID8gb3BlcmFuZC5pbnB1dCA6IG9wZXJhbmQsIGRvYyk7CiAgY29uc3QgY2hhcnMgPSBvcGVyYW5kLmNoYXJzID8gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQuY2hhcnMsIGRvYykgOiBudWxsOwogIGxldCBzdHIgPSB2YWwgIT09IG51bGwgJiYgdmFsICE9PSB2b2lkIDAgPyBTdHJpbmcodmFsKSA6ICIiOwogIGlmIChjaGFycykgewogICAgY29uc3QgY2hhcnNSZWdleCA9IG5ldyBSZWdFeHAoYFske2VzY2FwZVJlZ2V4KGNoYXJzKX1dKyRgLCAiZyIpOwogICAgcmV0dXJuIHN0ci5yZXBsYWNlKGNoYXJzUmVnZXgsICIiKTsKICB9CiAgcmV0dXJuIHN0ci5yZXBsYWNlKC9ccyskLywgIiIpOwp9CmZ1bmN0aW9uIGV2YWxTcGxpdChvcGVyYW5kcywgZG9jKSB7CiAgaWYgKCFBcnJheS5pc0FycmF5KG9wZXJhbmRzKSB8fCBvcGVyYW5kcy5sZW5ndGggIT09IDIpIHJldHVybiBudWxsOwogIGNvbnN0IHN0ciA9IFN0cmluZyhldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMF0sIGRvYykgfHwgIiIpOwogIGNvbnN0IGRlbGltaXRlciA9IFN0cmluZyhldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMV0sIGRvYykgfHwgIiIpOwogIHJldHVybiBzdHIuc3BsaXQoZGVsaW1pdGVyKTsKfQpmdW5jdGlvbiBldmFsU3RyTGVuQ1Aob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgcmV0dXJuIHZhbCAhPT0gbnVsbCAmJiB2YWwgIT09IHZvaWQgMCA/IFN0cmluZyh2YWwpLmxlbmd0aCA6IDA7Cn0KZnVuY3Rpb24gZXZhbFN0cmNhc2VjbXAob3BlcmFuZHMsIGRvYykgewogIGlmICghQXJyYXkuaXNBcnJheShvcGVyYW5kcykgfHwgb3BlcmFuZHMubGVuZ3RoICE9PSAyKSByZXR1cm4gbnVsbDsKICBjb25zdCBzdHIxID0gU3RyaW5nKGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1swXSwgZG9jKSB8fCAiIikudG9Mb3dlckNhc2UoKTsKICBjb25zdCBzdHIyID0gU3RyaW5nKGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1sxXSwgZG9jKSB8fCAiIikudG9Mb3dlckNhc2UoKTsKICBpZiAoc3RyMSA8IHN0cjIpIHJldHVybiAtMTsKICBpZiAoc3RyMSA+IHN0cjIpIHJldHVybiAxOwogIHJldHVybiAwOwp9CmZ1bmN0aW9uIGV2YWxJbmRleE9mQ1Aob3BlcmFuZHMsIGRvYykgewogIGlmICghQXJyYXkuaXNBcnJheShvcGVyYW5kcykgfHwgb3BlcmFuZHMubGVuZ3RoIDwgMikgcmV0dXJuIG51bGw7CiAgY29uc3Qgc3RyID0gU3RyaW5nKGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1swXSwgZG9jKSB8fCAiIik7CiAgY29uc3Qgc3Vic3RyID0gU3RyaW5nKGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1sxXSwgZG9jKSB8fCAiIik7CiAgY29uc3Qgc3RhcnQgPSBvcGVyYW5kc1syXSAhPT0gdm9pZCAwID8gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmRzWzJdLCBkb2MpIDogMDsKICBjb25zdCBlbmQgPSBvcGVyYW5kc1szXSAhPT0gdm9pZCAwID8gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmRzWzNdLCBkb2MpIDogc3RyLmxlbmd0aDsKICBjb25zdCBzZWFyY2hTdHIgPSBzdHIuc3Vic3RyaW5nKHN0YXJ0LCBlbmQpOwogIGNvbnN0IGluZGV4ID0gc2VhcmNoU3RyLmluZGV4T2Yoc3Vic3RyKTsKICByZXR1cm4gaW5kZXggPT09IC0xID8gLTEgOiBpbmRleCArIHN0YXJ0Owp9CmZ1bmN0aW9uIGV2YWxSZXBsYWNlT25lKG9wZXJhbmQsIGRvYykgewogIGNvbnN0IGlucHV0ID0gU3RyaW5nKGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLmlucHV0LCBkb2MpIHx8ICIiKTsKICBjb25zdCBmaW5kID0gU3RyaW5nKGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLmZpbmQsIGRvYykgfHwgIiIpOwogIGNvbnN0IHJlcGxhY2VtZW50ID0gU3RyaW5nKGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLnJlcGxhY2VtZW50LCBkb2MpIHx8ICIiKTsKICByZXR1cm4gaW5wdXQucmVwbGFjZShmaW5kLCByZXBsYWNlbWVudCk7Cn0KZnVuY3Rpb24gZXZhbFJlcGxhY2VBbGwob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgaW5wdXQgPSBTdHJpbmcoZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQuaW5wdXQsIGRvYykgfHwgIiIpOwogIGNvbnN0IGZpbmQgPSBTdHJpbmcoZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQuZmluZCwgZG9jKSB8fCAiIik7CiAgY29uc3QgcmVwbGFjZW1lbnQgPSBTdHJpbmcoZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQucmVwbGFjZW1lbnQsIGRvYykgfHwgIiIpOwogIHJldHVybiBpbnB1dC5zcGxpdChmaW5kKS5qb2luKHJlcGxhY2VtZW50KTsKfQpmdW5jdGlvbiBlc2NhcGVSZWdleChzdHIpIHsKICByZXR1cm4gc3RyLnJlcGxhY2UoL1suKis/XiR7fSgpfFtcXVxcXS9nLCAiXFwkJiIpOwp9CmZ1bmN0aW9uIGV2YWxDbXAob3BlcmFuZHMsIGRvYykgewogIGlmICghQXJyYXkuaXNBcnJheShvcGVyYW5kcykgfHwgb3BlcmFuZHMubGVuZ3RoICE9PSAyKSByZXR1cm4gbnVsbDsKICBjb25zdCB2YWwxID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmRzWzBdLCBkb2MpOwogIGNvbnN0IHZhbDIgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMV0sIGRvYyk7CiAgaWYgKHZhbDEgPCB2YWwyKSByZXR1cm4gLTE7CiAgaWYgKHZhbDEgPiB2YWwyKSByZXR1cm4gMTsKICByZXR1cm4gMDsKfQpmdW5jdGlvbiBldmFsRXEob3BlcmFuZHMsIGRvYykgewogIGlmICghQXJyYXkuaXNBcnJheShvcGVyYW5kcykgfHwgb3BlcmFuZHMubGVuZ3RoICE9PSAyKSByZXR1cm4gbnVsbDsKICBjb25zdCB2YWwxID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmRzWzBdLCBkb2MpOwogIGNvbnN0IHZhbDIgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMV0sIGRvYyk7CiAgcmV0dXJuIHZhbDEgPT09IHZhbDI7Cn0KZnVuY3Rpb24gZXZhbE5lKG9wZXJhbmRzLCBkb2MpIHsKICBpZiAoIUFycmF5LmlzQXJyYXkob3BlcmFuZHMpIHx8IG9wZXJhbmRzLmxlbmd0aCAhPT0gMikgcmV0dXJuIG51bGw7CiAgY29uc3QgdmFsMSA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1swXSwgZG9jKTsKICBjb25zdCB2YWwyID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmRzWzFdLCBkb2MpOwogIHJldHVybiB2YWwxICE9PSB2YWwyOwp9CmZ1bmN0aW9uIGV2YWxHdChvcGVyYW5kcywgZG9jKSB7CiAgaWYgKCFBcnJheS5pc0FycmF5KG9wZXJhbmRzKSB8fCBvcGVyYW5kcy5sZW5ndGggIT09IDIpIHJldHVybiBudWxsOwogIGNvbnN0IHZhbDEgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMF0sIGRvYyk7CiAgY29uc3QgdmFsMiA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1sxXSwgZG9jKTsKICByZXR1cm4gdmFsMSA+IHZhbDI7Cn0KZnVuY3Rpb24gZXZhbEd0ZShvcGVyYW5kcywgZG9jKSB7CiAgaWYgKCFBcnJheS5pc0FycmF5KG9wZXJhbmRzKSB8fCBvcGVyYW5kcy5sZW5ndGggIT09IDIpIHJldHVybiBudWxsOwogIGNvbnN0IHZhbDEgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMF0sIGRvYyk7CiAgY29uc3QgdmFsMiA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1sxXSwgZG9jKTsKICByZXR1cm4gdmFsMSA+PSB2YWwyOwp9CmZ1bmN0aW9uIGV2YWxMdChvcGVyYW5kcywgZG9jKSB7CiAgaWYgKCFBcnJheS5pc0FycmF5KG9wZXJhbmRzKSB8fCBvcGVyYW5kcy5sZW5ndGggIT09IDIpIHJldHVybiBudWxsOwogIGNvbnN0IHZhbDEgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMF0sIGRvYyk7CiAgY29uc3QgdmFsMiA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1sxXSwgZG9jKTsKICByZXR1cm4gdmFsMSA8IHZhbDI7Cn0KZnVuY3Rpb24gZXZhbEx0ZShvcGVyYW5kcywgZG9jKSB7CiAgaWYgKCFBcnJheS5pc0FycmF5KG9wZXJhbmRzKSB8fCBvcGVyYW5kcy5sZW5ndGggIT09IDIpIHJldHVybiBudWxsOwogIGNvbnN0IHZhbDEgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMF0sIGRvYyk7CiAgY29uc3QgdmFsMiA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1sxXSwgZG9jKTsKICByZXR1cm4gdmFsMSA8PSB2YWwyOwp9CmZ1bmN0aW9uIGV2YWxBbmQob3BlcmFuZHMsIGRvYykgewogIGlmICghQXJyYXkuaXNBcnJheShvcGVyYW5kcykpIHJldHVybiBudWxsOwogIGZvciAoY29uc3Qgb3BlcmFuZCBvZiBvcGVyYW5kcykgewogICAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgICBpZiAoIXZhbCkgcmV0dXJuIGZhbHNlOwogIH0KICByZXR1cm4gdHJ1ZTsKfQpmdW5jdGlvbiBldmFsT3Iob3BlcmFuZHMsIGRvYykgewogIGlmICghQXJyYXkuaXNBcnJheShvcGVyYW5kcykpIHJldHVybiBudWxsOwogIGZvciAoY29uc3Qgb3BlcmFuZCBvZiBvcGVyYW5kcykgewogICAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgICBpZiAodmFsKSByZXR1cm4gdHJ1ZTsKICB9CiAgcmV0dXJuIGZhbHNlOwp9CmZ1bmN0aW9uIGV2YWxOb3Qob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKEFycmF5LmlzQXJyYXkob3BlcmFuZCkgPyBvcGVyYW5kWzBdIDogb3BlcmFuZCwgZG9jKTsKICByZXR1cm4gIXZhbDsKfQpmdW5jdGlvbiBldmFsQ29uZChvcGVyYW5kLCBkb2MpIHsKICBsZXQgaWZFeHByLCB0aGVuRXhwciwgZWxzZUV4cHI7CiAgaWYgKEFycmF5LmlzQXJyYXkob3BlcmFuZCkpIHsKICAgIGlmIChvcGVyYW5kLmxlbmd0aCAhPT0gMykgcmV0dXJuIG51bGw7CiAgICBbaWZFeHByLCB0aGVuRXhwciwgZWxzZUV4cHJdID0gb3BlcmFuZDsKICB9IGVsc2UgaWYgKHR5cGVvZiBvcGVyYW5kID09PSAib2JqZWN0IikgewogICAgaWZFeHByID0gb3BlcmFuZC5pZjsKICAgIHRoZW5FeHByID0gb3BlcmFuZC50aGVuOwogICAgZWxzZUV4cHIgPSBvcGVyYW5kLmVsc2U7CiAgfSBlbHNlIHsKICAgIHJldHVybiBudWxsOwogIH0KICBjb25zdCBjb25kaXRpb24gPSBldmFsdWF0ZUV4cHJlc3Npb24oaWZFeHByLCBkb2MpOwogIHJldHVybiBjb25kaXRpb24gPyBldmFsdWF0ZUV4cHJlc3Npb24odGhlbkV4cHIsIGRvYykgOiBldmFsdWF0ZUV4cHJlc3Npb24oZWxzZUV4cHIsIGRvYyk7Cn0KZnVuY3Rpb24gZXZhbElmTnVsbChvcGVyYW5kcywgZG9jKSB7CiAgaWYgKCFBcnJheS5pc0FycmF5KG9wZXJhbmRzKSB8fCBvcGVyYW5kcy5sZW5ndGggPCAyKSByZXR1cm4gbnVsbDsKICBmb3IgKGxldCBpID0gMDsgaSA8IG9wZXJhbmRzLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbaV0sIGRvYyk7CiAgICBpZiAodmFsICE9PSBudWxsICYmIHZhbCAhPT0gdm9pZCAwKSB7CiAgICAgIHJldHVybiB2YWw7CiAgICB9CiAgfQogIHJldHVybiBudWxsOwp9CmZ1bmN0aW9uIGV2YWxTd2l0Y2gob3BlcmFuZCwgZG9jKSB7CiAgaWYgKHR5cGVvZiBvcGVyYW5kICE9PSAib2JqZWN0IiB8fCAhQXJyYXkuaXNBcnJheShvcGVyYW5kLmJyYW5jaGVzKSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIGZvciAoY29uc3QgYnJhbmNoIG9mIG9wZXJhbmQuYnJhbmNoZXMpIHsKICAgIGNvbnN0IGNhc2VSZXN1bHQgPSBldmFsdWF0ZUV4cHJlc3Npb24oYnJhbmNoLmNhc2UsIGRvYyk7CiAgICBpZiAoY2FzZVJlc3VsdCkgewogICAgICByZXR1cm4gZXZhbHVhdGVFeHByZXNzaW9uKGJyYW5jaC50aGVuLCBkb2MpOwogICAgfQogIH0KICByZXR1cm4gb3BlcmFuZC5kZWZhdWx0ICE9PSB2b2lkIDAgPyBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZC5kZWZhdWx0LCBkb2MpIDogbnVsbDsKfQpmdW5jdGlvbiBldmFsWWVhcihvcGVyYW5kLCBkb2MpIHsKICBjb25zdCBkYXRlID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgaWYgKGRhdGUgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICByZXR1cm4gZGF0ZS5nZXRVVENGdWxsWWVhcigpOwogIH0KICByZXR1cm4gbnVsbDsKfQpmdW5jdGlvbiBldmFsTW9udGgob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgZGF0ZSA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLCBkb2MpOwogIGlmIChkYXRlIGluc3RhbmNlb2YgRGF0ZSkgewogICAgcmV0dXJuIGRhdGUuZ2V0VVRDTW9udGgoKSArIDE7CiAgfQogIHJldHVybiBudWxsOwp9CmZ1bmN0aW9uIGV2YWxEYXlPZk1vbnRoKG9wZXJhbmQsIGRvYykgewogIGNvbnN0IGRhdGUgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZCwgZG9jKTsKICBpZiAoZGF0ZSBpbnN0YW5jZW9mIERhdGUpIHsKICAgIHJldHVybiBkYXRlLmdldFVUQ0RhdGUoKTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gZXZhbERheU9mV2VlayhvcGVyYW5kLCBkb2MpIHsKICBjb25zdCBkYXRlID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgaWYgKGRhdGUgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICByZXR1cm4gZGF0ZS5nZXRVVENEYXkoKSArIDE7CiAgfQogIHJldHVybiBudWxsOwp9CmZ1bmN0aW9uIGV2YWxEYXlPZlllYXIob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgZGF0ZSA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLCBkb2MpOwogIGlmIChkYXRlIGluc3RhbmNlb2YgRGF0ZSkgewogICAgY29uc3Qgc3RhcnQgPSBuZXcgRGF0ZShEYXRlLlVUQyhkYXRlLmdldFVUQ0Z1bGxZZWFyKCksIDAsIDApKTsKICAgIGNvbnN0IGRpZmYgPSBkYXRlIC0gc3RhcnQ7CiAgICBjb25zdCBvbmVEYXkgPSAxZTMgKiA2MCAqIDYwICogMjQ7CiAgICByZXR1cm4gTWF0aC5mbG9vcihkaWZmIC8gb25lRGF5KTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gZXZhbEhvdXIob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgZGF0ZSA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLCBkb2MpOwogIGlmIChkYXRlIGluc3RhbmNlb2YgRGF0ZSkgewogICAgcmV0dXJuIGRhdGUuZ2V0VVRDSG91cnMoKTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gZXZhbE1pbnV0ZShvcGVyYW5kLCBkb2MpIHsKICBjb25zdCBkYXRlID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgaWYgKGRhdGUgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICByZXR1cm4gZGF0ZS5nZXRVVENNaW51dGVzKCk7CiAgfQogIHJldHVybiBudWxsOwp9CmZ1bmN0aW9uIGV2YWxTZWNvbmQob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgZGF0ZSA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLCBkb2MpOwogIGlmIChkYXRlIGluc3RhbmNlb2YgRGF0ZSkgewogICAgcmV0dXJuIGRhdGUuZ2V0VVRDU2Vjb25kcygpOwogIH0KICByZXR1cm4gbnVsbDsKfQpmdW5jdGlvbiBldmFsTWlsbGlzZWNvbmQob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgZGF0ZSA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLCBkb2MpOwogIGlmIChkYXRlIGluc3RhbmNlb2YgRGF0ZSkgewogICAgcmV0dXJuIGRhdGUuZ2V0VVRDTWlsbGlzZWNvbmRzKCk7CiAgfQogIHJldHVybiBudWxsOwp9CmZ1bmN0aW9uIGV2YWxXZWVrKG9wZXJhbmQsIGRvYykgewogIGNvbnN0IGRhdGUgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZCwgZG9jKTsKICBpZiAoZGF0ZSBpbnN0YW5jZW9mIERhdGUpIHsKICAgIGNvbnN0IG9uZWphbiA9IG5ldyBEYXRlKERhdGUuVVRDKGRhdGUuZ2V0VVRDRnVsbFllYXIoKSwgMCwgMSkpOwogICAgY29uc3Qgd2VlayA9IE1hdGguY2VpbCgoKGRhdGUgLSBvbmVqYW4pIC8gODY0ZTUgKyBvbmVqYW4uZ2V0VVRDRGF5KCkgKyAxKSAvIDcpOwogICAgcmV0dXJuIHdlZWsgLSAxOwogIH0KICByZXR1cm4gbnVsbDsKfQpmdW5jdGlvbiBldmFsSXNvV2VlayhvcGVyYW5kLCBkb2MpIHsKICBjb25zdCBkYXRlID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgaWYgKGRhdGUgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICBjb25zdCB0YXJnZXQgPSBuZXcgRGF0ZShkYXRlLnZhbHVlT2YoKSk7CiAgICBjb25zdCBkYXlOciA9IChkYXRlLmdldFVUQ0RheSgpICsgNikgJSA3OwogICAgdGFyZ2V0LnNldFVUQ0RhdGUodGFyZ2V0LmdldFVUQ0RhdGUoKSAtIGRheU5yICsgMyk7CiAgICBjb25zdCBmaXJzdFRodXJzZGF5ID0gdGFyZ2V0LnZhbHVlT2YoKTsKICAgIHRhcmdldC5zZXRVVENNb250aCgwLCAxKTsKICAgIGlmICh0YXJnZXQuZ2V0VVRDRGF5KCkgIT09IDQpIHsKICAgICAgdGFyZ2V0LnNldFVUQ01vbnRoKDAsIDEgKyAoNCAtIHRhcmdldC5nZXRVVENEYXkoKSArIDcpICUgNyk7CiAgICB9CiAgICByZXR1cm4gMSArIE1hdGguY2VpbCgoZmlyc3RUaHVyc2RheSAtIHRhcmdldCkgLyA2MDQ4ZTUpOwogIH0KICByZXR1cm4gbnVsbDsKfQpmdW5jdGlvbiBldmFsSXNvV2Vla1llYXIob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgZGF0ZSA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLCBkb2MpOwogIGlmIChkYXRlIGluc3RhbmNlb2YgRGF0ZSkgewogICAgY29uc3QgdGFyZ2V0ID0gbmV3IERhdGUoZGF0ZS52YWx1ZU9mKCkpOwogICAgdGFyZ2V0LnNldFVUQ0RhdGUodGFyZ2V0LmdldFVUQ0RhdGUoKSAtIChkYXRlLmdldFVUQ0RheSgpICsgNikgJSA3ICsgMyk7CiAgICByZXR1cm4gdGFyZ2V0LmdldFVUQ0Z1bGxZZWFyKCk7CiAgfQogIHJldHVybiBudWxsOwp9CmZ1bmN0aW9uIGV2YWxEYXRlVG9TdHJpbmcob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgZm9ybWF0ID0gb3BlcmFuZC5mb3JtYXQgPyBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZC5mb3JtYXQsIGRvYykgOiAiJVktJW0tJWRUJUg6JU06JVMuJUxaIjsKICBjb25zdCBkYXRlID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQuZGF0ZSwgZG9jKTsKICBpZiAoIShkYXRlIGluc3RhbmNlb2YgRGF0ZSkpIHJldHVybiBudWxsOwogIHJldHVybiBmb3JtYXQucmVwbGFjZSgiJVkiLCBkYXRlLmdldFVUQ0Z1bGxZZWFyKCkpLnJlcGxhY2UoIiVtIiwgU3RyaW5nKGRhdGUuZ2V0VVRDTW9udGgoKSArIDEpLnBhZFN0YXJ0KDIsICIwIikpLnJlcGxhY2UoIiVkIiwgU3RyaW5nKGRhdGUuZ2V0VVRDRGF0ZSgpKS5wYWRTdGFydCgyLCAiMCIpKS5yZXBsYWNlKCIlSCIsIFN0cmluZyhkYXRlLmdldFVUQ0hvdXJzKCkpLnBhZFN0YXJ0KDIsICIwIikpLnJlcGxhY2UoIiVNIiwgU3RyaW5nKGRhdGUuZ2V0VVRDTWludXRlcygpKS5wYWRTdGFydCgyLCAiMCIpKS5yZXBsYWNlKCIlUyIsIFN0cmluZyhkYXRlLmdldFVUQ1NlY29uZHMoKSkucGFkU3RhcnQoMiwgIjAiKSkucmVwbGFjZSgiJUwiLCBTdHJpbmcoZGF0ZS5nZXRVVENNaWxsaXNlY29uZHMoKSkucGFkU3RhcnQoMywgIjAiKSk7Cn0KZnVuY3Rpb24gZXZhbFRvRGF0ZShvcGVyYW5kLCBkb2MpIHsKICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZCwgZG9jKTsKICBpZiAodmFsIGluc3RhbmNlb2YgRGF0ZSkgcmV0dXJuIHZhbDsKICBpZiAodHlwZW9mIHZhbCA9PT0gInN0cmluZyIgfHwgdHlwZW9mIHZhbCA9PT0gIm51bWJlciIpIHsKICAgIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZSh2YWwpOwogICAgcmV0dXJuIGlzTmFOKGRhdGUuZ2V0VGltZSgpKSA/IG51bGwgOiBkYXRlOwogIH0KICByZXR1cm4gbnVsbDsKfQpmdW5jdGlvbiBldmFsQXJyYXlFbGVtQXQob3BlcmFuZHMsIGRvYykgewogIGlmICghQXJyYXkuaXNBcnJheShvcGVyYW5kcykgfHwgb3BlcmFuZHMubGVuZ3RoICE9PSAyKSByZXR1cm4gbnVsbDsKICBjb25zdCBhcnIgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMF0sIGRvYyk7CiAgY29uc3QgaWR4ID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmRzWzFdLCBkb2MpOwogIGlmICghQXJyYXkuaXNBcnJheShhcnIpIHx8IHR5cGVvZiBpZHggIT09ICJudW1iZXIiKSByZXR1cm4gbnVsbDsKICBjb25zdCBpbmRleCA9IGlkeCA8IDAgPyBhcnIubGVuZ3RoICsgaWR4IDogaWR4OwogIHJldHVybiBhcnJbaW5kZXhdOwp9CmZ1bmN0aW9uIGV2YWxDb25jYXRBcnJheXMob3BlcmFuZHMsIGRvYykgewogIGlmICghQXJyYXkuaXNBcnJheShvcGVyYW5kcykpIHJldHVybiBudWxsOwogIGNvbnN0IHJlc3VsdCA9IFtdOwogIGZvciAoY29uc3Qgb3BlcmFuZCBvZiBvcGVyYW5kcykgewogICAgY29uc3QgYXJyID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgICBpZiAoQXJyYXkuaXNBcnJheShhcnIpKSB7CiAgICAgIHJlc3VsdC5wdXNoKC4uLmFycik7CiAgICB9CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KZnVuY3Rpb24gZXZhbEZpbHRlcihvcGVyYW5kLCBkb2MpIHsKICBjb25zdCBpbnB1dCA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLmlucHV0LCBkb2MpOwogIGNvbnN0IGFzVmFyID0gb3BlcmFuZC5hcyB8fCAidGhpcyI7CiAgY29uc3QgY29uZCA9IG9wZXJhbmQuY29uZDsKICBpZiAoIUFycmF5LmlzQXJyYXkoaW5wdXQpKSByZXR1cm4gbnVsbDsKICByZXR1cm4gaW5wdXQuZmlsdGVyKChpdGVtKSA9PiB7CiAgICBjb25zdCBpdGVtRG9jID0geyAuLi5kb2MsIFthc1Zhcl06IGl0ZW0gfTsKICAgIHJldHVybiBldmFsdWF0ZUV4cHJlc3Npb24oY29uZCwgaXRlbURvYyk7CiAgfSk7Cn0KZnVuY3Rpb24gZXZhbEluKG9wZXJhbmRzLCBkb2MpIHsKICBpZiAoIUFycmF5LmlzQXJyYXkob3BlcmFuZHMpIHx8IG9wZXJhbmRzLmxlbmd0aCAhPT0gMikgcmV0dXJuIG51bGw7CiAgY29uc3QgdmFsdWUgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMF0sIGRvYyk7CiAgY29uc3QgYXJyID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmRzWzFdLCBkb2MpOwogIGlmICghQXJyYXkuaXNBcnJheShhcnIpKSByZXR1cm4gZmFsc2U7CiAgcmV0dXJuIGFyci5pbmNsdWRlcyh2YWx1ZSk7Cn0KZnVuY3Rpb24gZXZhbEluZGV4T2ZBcnJheShvcGVyYW5kcywgZG9jKSB7CiAgaWYgKCFBcnJheS5pc0FycmF5KG9wZXJhbmRzKSB8fCBvcGVyYW5kcy5sZW5ndGggPCAyKSByZXR1cm4gbnVsbDsKICBjb25zdCBhcnIgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMF0sIGRvYyk7CiAgY29uc3Qgc2VhcmNoID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmRzWzFdLCBkb2MpOwogIGNvbnN0IHN0YXJ0ID0gb3BlcmFuZHNbMl0gIT09IHZvaWQgMCA/IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1syXSwgZG9jKSA6IDA7CiAgY29uc3QgZW5kID0gb3BlcmFuZHNbM10gIT09IHZvaWQgMCA/IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1szXSwgZG9jKSA6IGFyci5sZW5ndGg7CiAgaWYgKCFBcnJheS5pc0FycmF5KGFycikpIHJldHVybiBudWxsOwogIGZvciAobGV0IGkgPSBzdGFydDsgaSA8IGVuZCAmJiBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAoYXJyW2ldID09PSBzZWFyY2gpIHJldHVybiBpOwogIH0KICByZXR1cm4gLTE7Cn0KZnVuY3Rpb24gZXZhbElzQXJyYXkob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgcmV0dXJuIEFycmF5LmlzQXJyYXkodmFsKTsKfQpmdW5jdGlvbiBldmFsTWFwKG9wZXJhbmQsIGRvYykgewogIGNvbnN0IGlucHV0ID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQuaW5wdXQsIGRvYyk7CiAgY29uc3QgYXNWYXIgPSBvcGVyYW5kLmFzIHx8ICJ0aGlzIjsKICBjb25zdCBpbkV4cHIgPSBvcGVyYW5kLmluOwogIGlmICghQXJyYXkuaXNBcnJheShpbnB1dCkpIHJldHVybiBudWxsOwogIHJldHVybiBpbnB1dC5tYXAoKGl0ZW0pID0+IHsKICAgIGNvbnN0IGl0ZW1Eb2MgPSB7IC4uLmRvYywgW2FzVmFyXTogaXRlbSB9OwogICAgcmV0dXJuIGV2YWx1YXRlRXhwcmVzc2lvbihpbkV4cHIsIGl0ZW1Eb2MpOwogIH0pOwp9CmZ1bmN0aW9uIGV2YWxSZWR1Y2Uob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgaW5wdXQgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZC5pbnB1dCwgZG9jKTsKICBjb25zdCBpbml0aWFsVmFsdWUgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZC5pbml0aWFsVmFsdWUsIGRvYyk7CiAgY29uc3QgaW5FeHByID0gb3BlcmFuZC5pbjsKICBpZiAoIUFycmF5LmlzQXJyYXkoaW5wdXQpKSByZXR1cm4gbnVsbDsKICBsZXQgdmFsdWUgPSBpbml0aWFsVmFsdWU7CiAgZm9yIChjb25zdCBpdGVtIG9mIGlucHV0KSB7CiAgICBjb25zdCBpdGVtRG9jID0geyAuLi5kb2MsIHZhbHVlLCB0aGlzOiBpdGVtIH07CiAgICB2YWx1ZSA9IGV2YWx1YXRlRXhwcmVzc2lvbihpbkV4cHIsIGl0ZW1Eb2MpOwogIH0KICByZXR1cm4gdmFsdWU7Cn0KZnVuY3Rpb24gZXZhbFNpemUob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgYXJyID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgcmV0dXJuIEFycmF5LmlzQXJyYXkoYXJyKSA/IGFyci5sZW5ndGggOiBudWxsOwp9CmZ1bmN0aW9uIGV2YWxTbGljZShvcGVyYW5kcywgZG9jKSB7CiAgaWYgKCFBcnJheS5pc0FycmF5KG9wZXJhbmRzKSB8fCBvcGVyYW5kcy5sZW5ndGggPCAyKSByZXR1cm4gbnVsbDsKICBjb25zdCBhcnIgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMF0sIGRvYyk7CiAgaWYgKCFBcnJheS5pc0FycmF5KGFycikpIHJldHVybiBudWxsOwogIGlmIChvcGVyYW5kcy5sZW5ndGggPT09IDIpIHsKICAgIGNvbnN0IG4gPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMV0sIGRvYyk7CiAgICByZXR1cm4gbiA+PSAwID8gYXJyLnNsaWNlKDAsIG4pIDogYXJyLnNsaWNlKG4pOwogIH0gZWxzZSB7CiAgICBjb25zdCBwb3NpdGlvbiA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kc1sxXSwgZG9jKTsKICAgIGNvbnN0IG4gPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHNbMl0sIGRvYyk7CiAgICByZXR1cm4gYXJyLnNsaWNlKHBvc2l0aW9uLCBwb3NpdGlvbiArIG4pOwogIH0KfQpmdW5jdGlvbiBldmFsUmV2ZXJzZUFycmF5KG9wZXJhbmQsIGRvYykgewogIGNvbnN0IGFyciA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLCBkb2MpOwogIHJldHVybiBBcnJheS5pc0FycmF5KGFycikgPyBhcnIuc2xpY2UoKS5yZXZlcnNlKCkgOiBudWxsOwp9CmZ1bmN0aW9uIGV2YWxaaXAob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgaW5wdXRzID0gb3BlcmFuZC5pbnB1dHMgPyBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZC5pbnB1dHMsIGRvYykgOiBudWxsOwogIGNvbnN0IHVzZUxvbmdlc3RMZW5ndGggPSBvcGVyYW5kLnVzZUxvbmdlc3RMZW5ndGggfHwgZmFsc2U7CiAgY29uc3QgZGVmYXVsdHMgPSBvcGVyYW5kLmRlZmF1bHRzOwogIGlmICghQXJyYXkuaXNBcnJheShpbnB1dHMpKSByZXR1cm4gbnVsbDsKICBjb25zdCBhcnJheXMgPSBpbnB1dHMubWFwKChpbnB1dCkgPT4gZXZhbHVhdGVFeHByZXNzaW9uKGlucHV0LCBkb2MpKTsKICBpZiAoIWFycmF5cy5ldmVyeSgoYXJyKSA9PiBBcnJheS5pc0FycmF5KGFycikpKSByZXR1cm4gbnVsbDsKICBjb25zdCBtYXhMZW5ndGggPSBNYXRoLm1heCguLi5hcnJheXMubWFwKChhcnIpID0+IGFyci5sZW5ndGgpKTsKICBjb25zdCBsZW5ndGggPSB1c2VMb25nZXN0TGVuZ3RoID8gbWF4TGVuZ3RoIDogTWF0aC5taW4oLi4uYXJyYXlzLm1hcCgoYXJyKSA9PiBhcnIubGVuZ3RoKSk7CiAgY29uc3QgcmVzdWx0ID0gW107CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgY29uc3QgdHVwbGUgPSBbXTsKICAgIGZvciAobGV0IGogPSAwOyBqIDwgYXJyYXlzLmxlbmd0aDsgaisrKSB7CiAgICAgIGlmIChpIDwgYXJyYXlzW2pdLmxlbmd0aCkgewogICAgICAgIHR1cGxlLnB1c2goYXJyYXlzW2pdW2ldKTsKICAgICAgfSBlbHNlIGlmIChkZWZhdWx0cyAmJiBqIDwgZGVmYXVsdHMubGVuZ3RoKSB7CiAgICAgICAgdHVwbGUucHVzaChkZWZhdWx0c1tqXSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdHVwbGUucHVzaChudWxsKTsKICAgICAgfQogICAgfQogICAgcmVzdWx0LnB1c2godHVwbGUpOwogIH0KICByZXR1cm4gcmVzdWx0Owp9CmZ1bmN0aW9uIGV2YWxUeXBlKG9wZXJhbmQsIGRvYykgewogIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLCBkb2MpOwogIGlmICh2YWwgPT09IG51bGwpIHJldHVybiAibnVsbCI7CiAgaWYgKHZhbCA9PT0gdm9pZCAwKSByZXR1cm4gIm1pc3NpbmciOwogIGlmICh0eXBlb2YgdmFsID09PSAiYm9vbGVhbiIpIHJldHVybiAiYm9vbCI7CiAgaWYgKHR5cGVvZiB2YWwgPT09ICJudW1iZXIiKSByZXR1cm4gTnVtYmVyLmlzSW50ZWdlcih2YWwpID8gImludCIgOiAiZG91YmxlIjsKICBpZiAodHlwZW9mIHZhbCA9PT0gInN0cmluZyIpIHJldHVybiAic3RyaW5nIjsKICBpZiAodmFsIGluc3RhbmNlb2YgRGF0ZSkgcmV0dXJuICJkYXRlIjsKICBpZiAoQXJyYXkuaXNBcnJheSh2YWwpKSByZXR1cm4gImFycmF5IjsKICBpZiAodHlwZW9mIHZhbCA9PT0gIm9iamVjdCIpIHJldHVybiAib2JqZWN0IjsKICByZXR1cm4gInVua25vd24iOwp9CmZ1bmN0aW9uIGV2YWxDb252ZXJ0KG9wZXJhbmQsIGRvYykgewogIGNvbnN0IGlucHV0ID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQuaW5wdXQsIGRvYyk7CiAgY29uc3QgdG8gPSBvcGVyYW5kLnRvOwogIGNvbnN0IG9uRXJyb3IgPSBvcGVyYW5kLm9uRXJyb3I7CiAgY29uc3Qgb25OdWxsID0gb3BlcmFuZC5vbk51bGw7CiAgaWYgKGlucHV0ID09PSBudWxsKSB7CiAgICByZXR1cm4gb25OdWxsICE9PSB2b2lkIDAgPyBldmFsdWF0ZUV4cHJlc3Npb24ob25OdWxsLCBkb2MpIDogbnVsbDsKICB9CiAgdHJ5IHsKICAgIHN3aXRjaCAodG8pIHsKICAgICAgY2FzZSAiZG91YmxlIjoKICAgICAgY2FzZSAiZGVjaW1hbCI6CiAgICAgICAgcmV0dXJuIHBhcnNlRmxvYXQoaW5wdXQpOwogICAgICBjYXNlICJpbnQiOgogICAgICBjYXNlICJsb25nIjoKICAgICAgICByZXR1cm4gcGFyc2VJbnQoaW5wdXQpOwogICAgICBjYXNlICJib29sIjoKICAgICAgICByZXR1cm4gQm9vbGVhbihpbnB1dCk7CiAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgcmV0dXJuIFN0cmluZyhpbnB1dCk7CiAgICAgIGNhc2UgImRhdGUiOgogICAgICAgIHJldHVybiBuZXcgRGF0ZShpbnB1dCk7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIGlucHV0OwogICAgfQogIH0gY2F0Y2ggKGUpIHsKICAgIHJldHVybiBvbkVycm9yICE9PSB2b2lkIDAgPyBldmFsdWF0ZUV4cHJlc3Npb24ob25FcnJvciwgZG9jKSA6IG51bGw7CiAgfQp9CmZ1bmN0aW9uIGV2YWxUb0Jvb2wob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgcmV0dXJuIEJvb2xlYW4odmFsKTsKfQpmdW5jdGlvbiBldmFsVG9EZWNpbWFsKG9wZXJhbmQsIGRvYykgewogIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLCBkb2MpOwogIHJldHVybiBwYXJzZUZsb2F0KHZhbCk7Cn0KZnVuY3Rpb24gZXZhbFRvRG91YmxlKG9wZXJhbmQsIGRvYykgewogIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLCBkb2MpOwogIHJldHVybiBwYXJzZUZsb2F0KHZhbCk7Cn0KZnVuY3Rpb24gZXZhbFRvSW50KG9wZXJhbmQsIGRvYykgewogIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLCBkb2MpOwogIHJldHVybiBwYXJzZUludCh2YWwpOwp9CmZ1bmN0aW9uIGV2YWxUb0xvbmcob3BlcmFuZCwgZG9jKSB7CiAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgcmV0dXJuIHBhcnNlSW50KHZhbCk7Cn0KZnVuY3Rpb24gZXZhbFRvU3RyaW5nKG9wZXJhbmQsIGRvYykgewogIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihvcGVyYW5kLCBkb2MpOwogIGlmICh2YWwgPT09IG51bGwgfHwgdmFsID09PSB2b2lkIDApIHJldHVybiBudWxsOwogIHJldHVybiBTdHJpbmcodmFsKTsKfQpmdW5jdGlvbiBldmFsT2JqZWN0VG9BcnJheShvcGVyYW5kLCBkb2MpIHsKICBjb25zdCBvYmogPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZCwgZG9jKTsKICBpZiAodHlwZW9mIG9iaiAhPT0gIm9iamVjdCIgfHwgb2JqID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkob2JqKSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiBPYmplY3Qua2V5cyhvYmopLm1hcCgoa2V5KSA9PiAoeyBrOiBrZXksIHY6IG9ialtrZXldIH0pKTsKfQpmdW5jdGlvbiBldmFsQXJyYXlUb09iamVjdChvcGVyYW5kLCBkb2MpIHsKICBjb25zdCBhcnIgPSBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZCwgZG9jKTsKICBpZiAoIUFycmF5LmlzQXJyYXkoYXJyKSkgcmV0dXJuIG51bGw7CiAgY29uc3QgcmVzdWx0ID0ge307CiAgZm9yIChjb25zdCBpdGVtIG9mIGFycikgewogICAgaWYgKEFycmF5LmlzQXJyYXkoaXRlbSkgJiYgaXRlbS5sZW5ndGggPT09IDIpIHsKICAgICAgcmVzdWx0W2l0ZW1bMF1dID0gaXRlbVsxXTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIGl0ZW0gPT09ICJvYmplY3QiICYmIGl0ZW0uayAhPT0gdm9pZCAwICYmIGl0ZW0udiAhPT0gdm9pZCAwKSB7CiAgICAgIHJlc3VsdFtpdGVtLmtdID0gaXRlbS52OwogICAgfQogIH0KICByZXR1cm4gcmVzdWx0Owp9CmZ1bmN0aW9uIGV2YWxNZXJnZU9iamVjdHMob3BlcmFuZHMsIGRvYykgewogIGlmICghQXJyYXkuaXNBcnJheShvcGVyYW5kcykpIHsKICAgIHJldHVybiBldmFsdWF0ZUV4cHJlc3Npb24ob3BlcmFuZHMsIGRvYyk7CiAgfQogIGNvbnN0IHJlc3VsdCA9IHt9OwogIGZvciAoY29uc3Qgb3BlcmFuZCBvZiBvcGVyYW5kcykgewogICAgY29uc3Qgb2JqID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgICBpZiAodHlwZW9mIG9iaiA9PT0gIm9iamVjdCIgJiYgb2JqICE9PSBudWxsICYmICFBcnJheS5pc0FycmF5KG9iaikpIHsKICAgICAgT2JqZWN0LmFzc2lnbihyZXN1bHQsIG9iaik7CiAgICB9CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KY29uc3QgQlNPTl9UWVBFUyA9IHsKICAxOiAiZG91YmxlIiwKICAyOiAic3RyaW5nIiwKICAzOiAib2JqZWN0IiwKICA0OiAiYXJyYXkiLAogIDU6ICJiaW5EYXRhIiwKICA2OiAidW5kZWZpbmVkIiwKICA3OiAib2JqZWN0SWQiLAogIDg6ICJib29sIiwKICA5OiAiZGF0ZSIsCiAgMTA6ICJudWxsIiwKICAxMTogInJlZ2V4IiwKICAxMzogImphdmFzY3JpcHQiLAogIDE1OiAiamF2YXNjcmlwdFdpdGhTY29wZSIsCiAgMTY6ICJpbnQiLAogIDE3OiAidGltZXN0YW1wIiwKICAxODogImxvbmciLAogIDE5OiAiZGVjaW1hbCIsCiAgMTI3OiAibWF4S2V5IiwKICAiLTEiOiAibWluS2V5Igp9Owpjb25zdCBUWVBFX0FMSUFTRVMgPSBPYmplY3QuZW50cmllcyhCU09OX1RZUEVTKS5yZWR1Y2UoKGFjYywgW2NvZGUsIG5hbWVdKSA9PiB7CiAgYWNjW25hbWVdID0gcGFyc2VJbnQoY29kZSk7CiAgcmV0dXJuIGFjYzsKfSwge30pOwpmdW5jdGlvbiBtYXRjaGVzVHlwZSh2YWx1ZSwgdHlwZVNwZWMpIHsKICBpZiAoaXNBcnJheSh0eXBlU3BlYykpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdHlwZVNwZWMubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKG1hdGNoZXNUeXBlKHZhbHVlLCB0eXBlU3BlY1tpXSkpIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KICBjb25zdCB0eXBlQ29kZSA9IHR5cGVvZiB0eXBlU3BlYyA9PT0gIm51bWJlciIgPyB0eXBlU3BlYyA6IFRZUEVfQUxJQVNFU1t0eXBlU3BlY107CiAgY29uc3QgdHlwZU5hbWUgPSBCU09OX1RZUEVTW3R5cGVDb2RlXSB8fCB0eXBlU3BlYzsKICBpZiAodmFsdWUgPT09IG51bGwpIHJldHVybiB0eXBlTmFtZSA9PT0gIm51bGwiIHx8IHR5cGVDb2RlID09PSAxMDsKICBpZiAodmFsdWUgPT09IHZvaWQgMCkgcmV0dXJuIHR5cGVOYW1lID09PSAidW5kZWZpbmVkIiB8fCB0eXBlQ29kZSA9PT0gNjsKICBpZiAodHlwZW9mIHZhbHVlID09PSAibnVtYmVyIikgewogICAgaWYgKE51bWJlci5pc0ludGVnZXIodmFsdWUpKSByZXR1cm4gdHlwZU5hbWUgPT09ICJpbnQiIHx8IHR5cGVDb2RlID09PSAxNjsKICAgIHJldHVybiB0eXBlTmFtZSA9PT0gImRvdWJsZSIgfHwgdHlwZUNvZGUgPT09IDE7CiAgfQogIGlmICh0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciKSByZXR1cm4gdHlwZU5hbWUgPT09ICJzdHJpbmciIHx8IHR5cGVDb2RlID09PSAyOwogIGlmICh0eXBlb2YgdmFsdWUgPT09ICJib29sZWFuIikgcmV0dXJuIHR5cGVOYW1lID09PSAiYm9vbCIgfHwgdHlwZUNvZGUgPT09IDg7CiAgaWYgKHZhbHVlIGluc3RhbmNlb2YgRGF0ZSkgcmV0dXJuIHR5cGVOYW1lID09PSAiZGF0ZSIgfHwgdHlwZUNvZGUgPT09IDk7CiAgaWYgKHZhbHVlIGluc3RhbmNlb2YgT2JqZWN0SWQpIHJldHVybiB0eXBlTmFtZSA9PT0gIm9iamVjdElkIiB8fCB0eXBlQ29kZSA9PT0gNzsKICBpZiAodmFsdWUgaW5zdGFuY2VvZiBSZWdFeHApIHJldHVybiB0eXBlTmFtZSA9PT0gInJlZ2V4IiB8fCB0eXBlQ29kZSA9PT0gMTE7CiAgaWYgKGlzQXJyYXkodmFsdWUpKSByZXR1cm4gdHlwZU5hbWUgPT09ICJhcnJheSIgfHwgdHlwZUNvZGUgPT09IDQ7CiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIpIHJldHVybiB0eXBlTmFtZSA9PT0gIm9iamVjdCIgfHwgdHlwZUNvZGUgPT09IDM7CiAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gdHlwZVNwZWM7Cn0KZnVuY3Rpb24gdG9CaXRNYXNrKHBvc2l0aW9ucykgewogIGlmIChpc0FycmF5KHBvc2l0aW9ucykpIHsKICAgIGxldCBtYXNrID0gMDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9zaXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgIG1hc2sgfD0gMSA8PCBwb3NpdGlvbnNbaV07CiAgICB9CiAgICByZXR1cm4gbWFzazsKICB9IGVsc2UgaWYgKHR5cGVvZiBwb3NpdGlvbnMgPT09ICJudW1iZXIiKSB7CiAgICByZXR1cm4gcG9zaXRpb25zOwogIH0KICByZXR1cm4gMDsKfQpmdW5jdGlvbiBtYXRjaGVzQml0c0FsbFNldCh2YWx1ZSwgcG9zaXRpb25zKSB7CiAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gIm51bWJlciIpIHJldHVybiBmYWxzZTsKICBjb25zdCBtYXNrID0gdG9CaXRNYXNrKHBvc2l0aW9ucyk7CiAgcmV0dXJuICh2YWx1ZSAmIG1hc2spID09PSBtYXNrOwp9CmZ1bmN0aW9uIG1hdGNoZXNCaXRzQWxsQ2xlYXIodmFsdWUsIHBvc2l0aW9ucykgewogIGlmICh0eXBlb2YgdmFsdWUgIT09ICJudW1iZXIiKSByZXR1cm4gZmFsc2U7CiAgY29uc3QgbWFzayA9IHRvQml0TWFzayhwb3NpdGlvbnMpOwogIHJldHVybiAodmFsdWUgJiBtYXNrKSA9PT0gMDsKfQpmdW5jdGlvbiBtYXRjaGVzQml0c0FueVNldCh2YWx1ZSwgcG9zaXRpb25zKSB7CiAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gIm51bWJlciIpIHJldHVybiBmYWxzZTsKICBjb25zdCBtYXNrID0gdG9CaXRNYXNrKHBvc2l0aW9ucyk7CiAgcmV0dXJuICh2YWx1ZSAmIG1hc2spICE9PSAwOwp9CmZ1bmN0aW9uIG1hdGNoZXNCaXRzQW55Q2xlYXIodmFsdWUsIHBvc2l0aW9ucykgewogIGlmICh0eXBlb2YgdmFsdWUgIT09ICJudW1iZXIiKSByZXR1cm4gZmFsc2U7CiAgY29uc3QgbWFzayA9IHRvQml0TWFzayhwb3NpdGlvbnMpOwogIHJldHVybiAodmFsdWUgJiBtYXNrKSAhPT0gbWFzazsKfQpmdW5jdGlvbiB2YWxpZGF0ZUpzb25TY2hlbWEoZG9jLCBzY2hlbWEpIHsKICBpZiAoc2NoZW1hLnR5cGUpIHsKICAgIGNvbnN0IGRvY1R5cGUgPSBpc0FycmF5KGRvYykgPyAiYXJyYXkiIDogZG9jID09PSBudWxsID8gIm51bGwiIDogdHlwZW9mIGRvYzsKICAgIGlmIChzY2hlbWEudHlwZSAhPT0gZG9jVHlwZSkgcmV0dXJuIGZhbHNlOwogIH0KICBpZiAoc2NoZW1hLnJlcXVpcmVkICYmIGlzQXJyYXkoc2NoZW1hLnJlcXVpcmVkKSkgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzY2hlbWEucmVxdWlyZWQubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKCEoc2NoZW1hLnJlcXVpcmVkW2ldIGluIGRvYykpIHJldHVybiBmYWxzZTsKICAgIH0KICB9CiAgaWYgKHNjaGVtYS5wcm9wZXJ0aWVzKSB7CiAgICBmb3IgKGNvbnN0IGtleSBpbiBzY2hlbWEucHJvcGVydGllcykgewogICAgICBpZiAoIShrZXkgaW4gZG9jKSkgcmV0dXJuIGZhbHNlOwogICAgICBjb25zdCBwcm9wU2NoZW1hID0gc2NoZW1hLnByb3BlcnRpZXNba2V5XTsKICAgICAgaWYgKCF2YWxpZGF0ZUpzb25TY2hlbWEoZG9jW2tleV0sIHByb3BTY2hlbWEpKSByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQogIGlmIChzY2hlbWEubWluaW11bSAhPT0gdm9pZCAwICYmIHR5cGVvZiBkb2MgPT09ICJudW1iZXIiKSB7CiAgICBpZiAoZG9jIDwgc2NoZW1hLm1pbmltdW0pIHJldHVybiBmYWxzZTsKICB9CiAgaWYgKHNjaGVtYS5tYXhpbXVtICE9PSB2b2lkIDAgJiYgdHlwZW9mIGRvYyA9PT0gIm51bWJlciIpIHsKICAgIGlmIChkb2MgPiBzY2hlbWEubWF4aW11bSkgcmV0dXJuIGZhbHNlOwogIH0KICBpZiAoc2NoZW1hLm1pbkxlbmd0aCAhPT0gdm9pZCAwICYmIHR5cGVvZiBkb2MgPT09ICJzdHJpbmciKSB7CiAgICBpZiAoZG9jLmxlbmd0aCA8IHNjaGVtYS5taW5MZW5ndGgpIHJldHVybiBmYWxzZTsKICB9CiAgaWYgKHNjaGVtYS5tYXhMZW5ndGggIT09IHZvaWQgMCAmJiB0eXBlb2YgZG9jID09PSAic3RyaW5nIikgewogICAgaWYgKGRvYy5sZW5ndGggPiBzY2hlbWEubWF4TGVuZ3RoKSByZXR1cm4gZmFsc2U7CiAgfQogIGlmIChzY2hlbWEucGF0dGVybiAmJiB0eXBlb2YgZG9jID09PSAic3RyaW5nIikgewogICAgY29uc3QgcmVnZXggPSBuZXcgUmVnRXhwKHNjaGVtYS5wYXR0ZXJuKTsKICAgIGlmICghcmVnZXgudGVzdChkb2MpKSByZXR1cm4gZmFsc2U7CiAgfQogIGlmIChzY2hlbWEuZW51bSAmJiBpc0FycmF5KHNjaGVtYS5lbnVtKSkgewogICAgaWYgKCFzY2hlbWEuZW51bS5pbmNsdWRlcyhkb2MpKSByZXR1cm4gZmFsc2U7CiAgfQogIHJldHVybiB0cnVlOwp9CmZ1bmN0aW9uIHZhbHVlc0VxdWFsKGEsIGIpIHsKICBpZiAoYSBpbnN0YW5jZW9mIE9iamVjdElkICYmIGIgaW5zdGFuY2VvZiBPYmplY3RJZCkgewogICAgcmV0dXJuIGEuZXF1YWxzKGIpOwogIH0KICByZXR1cm4gYSA9PSBiOwp9CmZ1bmN0aW9uIGNvbXBhcmVWYWx1ZXMoYSwgYiwgb3BlcmF0b3IpIHsKICBsZXQgYVZhbCA9IGE7CiAgbGV0IGJWYWwgPSBiOwogIGlmIChhIGluc3RhbmNlb2YgT2JqZWN0SWQpIHsKICAgIGFWYWwgPSBhLnRvU3RyaW5nKCk7CiAgfQogIGlmIChiIGluc3RhbmNlb2YgT2JqZWN0SWQpIHsKICAgIGJWYWwgPSBiLnRvU3RyaW5nKCk7CiAgfQogIHN3aXRjaCAob3BlcmF0b3IpIHsKICAgIGNhc2UgIj4iOgogICAgICByZXR1cm4gYVZhbCA+IGJWYWw7CiAgICBjYXNlICI+PSI6CiAgICAgIHJldHVybiBhVmFsID49IGJWYWw7CiAgICBjYXNlICI8IjoKICAgICAgcmV0dXJuIGFWYWwgPCBiVmFsOwogICAgY2FzZSAiPD0iOgogICAgICByZXR1cm4gYVZhbCA8PSBiVmFsOwogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuIGZhbHNlOwogIH0KfQpmdW5jdGlvbiBmaWVsZFZhbHVlTWF0Y2hlcyhmaWVsZFZhbHVlLCBjaGVja0ZuKSB7CiAgaWYgKGZpZWxkVmFsdWUgPT09IHZvaWQgMCkgcmV0dXJuIGZhbHNlOwogIGlmIChmaWVsZFZhbHVlID09PSBudWxsKSByZXR1cm4gY2hlY2tGbihmaWVsZFZhbHVlKTsKICBpZiAoaXNBcnJheShmaWVsZFZhbHVlKSkgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmaWVsZFZhbHVlLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChjaGVja0ZuKGZpZWxkVmFsdWVbaV0pKSByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CiAgcmV0dXJuIGNoZWNrRm4oZmllbGRWYWx1ZSk7Cn0KZnVuY3Rpb24gdG9rZW5pemVUZXh0KHRleHQyKSB7CiAgaWYgKHR5cGVvZiB0ZXh0MiAhPT0gInN0cmluZyIpIHJldHVybiBbXTsKICBjb25zdCB3b3JkcyA9IHRva2VuaXplKHRleHQyKTsKICByZXR1cm4gd29yZHMubWFwKCh3KSA9PiBzdGVtbWVyKHcpKTsKfQpmdW5jdGlvbiB0ZXh0KHByb3AsIHF1ZXJ5VGV4dCkgewogIGlmICh0eXBlb2YgcHJvcCAhPT0gInN0cmluZyIpIHJldHVybiBmYWxzZTsKICBjb25zdCBwcm9wVG9rZW5zID0gbmV3IFNldCh0b2tlbml6ZVRleHQocHJvcCkpOwogIGNvbnN0IHF1ZXJ5VG9rZW5zID0gdG9rZW5pemVUZXh0KHF1ZXJ5VGV4dCk7CiAgcmV0dXJuIHF1ZXJ5VG9rZW5zLnNvbWUoKHRlcm0pID0+IHByb3BUb2tlbnMuaGFzKHRlcm0pKTsKfQpmdW5jdGlvbiB0ZXh0U2VhcmNoRG9jdW1lbnQoZG9jLCBzZWFyY2hUZXh0KSB7CiAgaWYgKCFkb2MgfHwgdHlwZW9mIGRvYyAhPT0gIm9iamVjdCIpIHJldHVybiBmYWxzZTsKICBmdW5jdGlvbiBzZWFyY2hPYmplY3Qob2JqKSB7CiAgICBpZiAodHlwZW9mIG9iaiA9PT0gInN0cmluZyIpIHsKICAgICAgcmV0dXJuIHRleHQob2JqLCBzZWFyY2hUZXh0KTsKICAgIH0KICAgIGlmICh0eXBlb2Ygb2JqICE9PSAib2JqZWN0IiB8fCBvYmogPT09IG51bGwpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgaWYgKGlzQXJyYXkob2JqKSkgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG9iai5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChzZWFyY2hPYmplY3Qob2JqW2ldKSkgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgZm9yIChjb25zdCBrZXkgaW4gb2JqKSB7CiAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgIGlmIChzZWFyY2hPYmplY3Qob2JqW2tleV0pKSByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KICByZXR1cm4gc2VhcmNoT2JqZWN0KGRvYyk7Cn0KZnVuY3Rpb24gZ2VvV2l0aGluKHByb3AsIHF1ZXJ5KSB7CiAgdHJ5IHsKICAgIGlmICghQXJyYXkuaXNBcnJheShxdWVyeSkgfHwgcXVlcnkubGVuZ3RoICE9PSAyKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGNvbnN0IG1pbkxvbiA9IHF1ZXJ5WzBdWzBdOwogICAgY29uc3QgbWF4TGF0ID0gcXVlcnlbMF1bMV07CiAgICBjb25zdCBtYXhMb24gPSBxdWVyeVsxXVswXTsKICAgIGNvbnN0IG1pbkxhdCA9IHF1ZXJ5WzFdWzFdOwogICAgcmV0dXJuIGlzR2VvbWV0cnlXaXRoaW5CQm94KHByb3AsIG1pbkxvbiwgbWF4TG9uLCBtaW5MYXQsIG1heExhdCk7CiAgfSBjYXRjaCAoZSkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KfQpmdW5jdGlvbiBpc0dlb21ldHJ5V2l0aGluQkJveChnZW9Kc29uLCBtaW5Mb24sIG1heExvbiwgbWluTGF0LCBtYXhMYXQpIHsKICBpZiAoIWdlb0pzb24pIHJldHVybiBmYWxzZTsKICBpZiAoZ2VvSnNvbi50eXBlID09PSAiRmVhdHVyZUNvbGxlY3Rpb24iICYmIGdlb0pzb24uZmVhdHVyZXMgJiYgZ2VvSnNvbi5mZWF0dXJlcy5sZW5ndGggPiAwKSB7CiAgICBmb3IgKGNvbnN0IGZlYXR1cmUgb2YgZ2VvSnNvbi5mZWF0dXJlcykgewogICAgICBpZiAoZmVhdHVyZS5nZW9tZXRyeSkgewogICAgICAgIGlmICghaXNHZW9tZXRyeVdpdGhpbkJCb3goZmVhdHVyZS5nZW9tZXRyeSwgbWluTG9uLCBtYXhMb24sIG1pbkxhdCwgbWF4TGF0KSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQogIGlmIChnZW9Kc29uLnR5cGUgPT09ICJGZWF0dXJlIiAmJiBnZW9Kc29uLmdlb21ldHJ5KSB7CiAgICByZXR1cm4gaXNHZW9tZXRyeVdpdGhpbkJCb3goZ2VvSnNvbi5nZW9tZXRyeSwgbWluTG9uLCBtYXhMb24sIG1pbkxhdCwgbWF4TGF0KTsKICB9CiAgaWYgKGdlb0pzb24udHlwZSA9PT0gIlBvaW50IiAmJiBnZW9Kc29uLmNvb3JkaW5hdGVzKSB7CiAgICBjb25zdCBbbG5nLCBsYXRdID0gZ2VvSnNvbi5jb29yZGluYXRlczsKICAgIGlmICh0eXBlb2YgbG5nID09PSAibnVtYmVyIiAmJiB0eXBlb2YgbGF0ID09PSAibnVtYmVyIikgewogICAgICByZXR1cm4gbG5nID49IG1pbkxvbiAmJiBsbmcgPD0gbWF4TG9uICYmIGxhdCA+PSBtaW5MYXQgJiYgbGF0IDw9IG1heExhdDsKICAgIH0KICB9CiAgaWYgKGdlb0pzb24udHlwZSA9PT0gIlBvbHlnb24iICYmIGdlb0pzb24uY29vcmRpbmF0ZXMgJiYgZ2VvSnNvbi5jb29yZGluYXRlcy5sZW5ndGggPiAwKSB7CiAgICBmb3IgKGNvbnN0IHJpbmcgb2YgZ2VvSnNvbi5jb29yZGluYXRlcykgewogICAgICBmb3IgKGNvbnN0IGNvb3JkIG9mIHJpbmcpIHsKICAgICAgICBjb25zdCBsbmcgPSBjb29yZFswXTsKICAgICAgICBjb25zdCBsYXQgPSBjb29yZFsxXTsKICAgICAgICBpZiAobG5nIDwgbWluTG9uIHx8IGxuZyA+IG1heExvbiB8fCBsYXQgPCBtaW5MYXQgfHwgbGF0ID4gbWF4TGF0KSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgcmV0dXJuIGZhbHNlOwp9CmZ1bmN0aW9uIGV4dHJhY3RDb29yZGluYXRlc0Zyb21HZW9KU09OKGdlb0pzb24pIHsKICBpZiAoIWdlb0pzb24pIHJldHVybiBudWxsOwogIGlmIChnZW9Kc29uLnR5cGUgPT09ICJGZWF0dXJlQ29sbGVjdGlvbiIgJiYgZ2VvSnNvbi5mZWF0dXJlcyAmJiBnZW9Kc29uLmZlYXR1cmVzLmxlbmd0aCA+IDApIHsKICAgIGNvbnN0IGZlYXR1cmUgPSBnZW9Kc29uLmZlYXR1cmVzWzBdOwogICAgaWYgKGZlYXR1cmUuZ2VvbWV0cnkpIHsKICAgICAgcmV0dXJuIGV4dHJhY3RDb29yZGluYXRlc0Zyb21HZW9KU09OKGZlYXR1cmUuZ2VvbWV0cnkpOwogICAgfQogIH0KICBpZiAoZ2VvSnNvbi50eXBlID09PSAiRmVhdHVyZSIgJiYgZ2VvSnNvbi5nZW9tZXRyeSkgewogICAgcmV0dXJuIGV4dHJhY3RDb29yZGluYXRlc0Zyb21HZW9KU09OKGdlb0pzb24uZ2VvbWV0cnkpOwogIH0KICBpZiAoZ2VvSnNvbi50eXBlID09PSAiUG9pbnQiICYmIGdlb0pzb24uY29vcmRpbmF0ZXMpIHsKICAgIGNvbnN0IFtsbmcsIGxhdF0gPSBnZW9Kc29uLmNvb3JkaW5hdGVzOwogICAgaWYgKHR5cGVvZiBsbmcgPT09ICJudW1iZXIiICYmIHR5cGVvZiBsYXQgPT09ICJudW1iZXIiKSB7CiAgICAgIHJldHVybiB7IGxhdCwgbG5nIH07CiAgICB9CiAgfQogIGlmIChnZW9Kc29uLnR5cGUgPT09ICJQb2x5Z29uIiAmJiBnZW9Kc29uLmNvb3JkaW5hdGVzICYmIGdlb0pzb24uY29vcmRpbmF0ZXMubGVuZ3RoID4gMCkgewogICAgY29uc3QgcmluZyA9IGdlb0pzb24uY29vcmRpbmF0ZXNbMF07CiAgICBpZiAocmluZy5sZW5ndGggPiAwKSB7CiAgICAgIGxldCBzdW1MYXQgPSAwLCBzdW1MbmcgPSAwOwogICAgICBmb3IgKGNvbnN0IGNvb3JkIG9mIHJpbmcpIHsKICAgICAgICBzdW1MbmcgKz0gY29vcmRbMF07CiAgICAgICAgc3VtTGF0ICs9IGNvb3JkWzFdOwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgbGF0OiBzdW1MYXQgLyByaW5nLmxlbmd0aCwKICAgICAgICBsbmc6IHN1bUxuZyAvIHJpbmcubGVuZ3RoCiAgICAgIH07CiAgICB9CiAgfQogIHJldHVybiBudWxsOwp9CmZ1bmN0aW9uIGhhdmVyc2luZURpc3RhbmNlJDEobGF0MSwgbG5nMSwgbGF0MiwgbG5nMikgewogIGNvbnN0IFIgPSA2MzcxOwogIGNvbnN0IGRMYXQgPSAobGF0MiAtIGxhdDEpICogTWF0aC5QSSAvIDE4MDsKICBjb25zdCBkTG5nID0gKGxuZzIgLSBsbmcxKSAqIE1hdGguUEkgLyAxODA7CiAgY29uc3QgYSA9IE1hdGguc2luKGRMYXQgLyAyKSAqIE1hdGguc2luKGRMYXQgLyAyKSArIE1hdGguY29zKGxhdDEgKiBNYXRoLlBJIC8gMTgwKSAqIE1hdGguY29zKGxhdDIgKiBNYXRoLlBJIC8gMTgwKSAqIE1hdGguc2luKGRMbmcgLyAyKSAqIE1hdGguc2luKGRMbmcgLyAyKTsKICBjb25zdCBjID0gMiAqIE1hdGguYXRhbjIoTWF0aC5zcXJ0KGEpLCBNYXRoLnNxcnQoMSAtIGEpKTsKICByZXR1cm4gUiAqIGM7Cn0KZnVuY3Rpb24gaXNOZWFyKGdlb0pzb24sIHJlZkxuZywgcmVmTGF0LCBtYXhEaXN0YW5jZU1ldGVycykgewogIGNvbnN0IGNvb3JkcyA9IGV4dHJhY3RDb29yZGluYXRlc0Zyb21HZW9KU09OKGdlb0pzb24pOwogIGlmICghY29vcmRzKSByZXR1cm4gZmFsc2U7CiAgY29uc3QgZGlzdGFuY2VLbSA9IGhhdmVyc2luZURpc3RhbmNlJDEoY29vcmRzLmxhdCwgY29vcmRzLmxuZywgcmVmTGF0LCByZWZMbmcpOwogIGNvbnN0IGRpc3RhbmNlTSA9IGRpc3RhbmNlS20gKiAxZTM7CiAgcmV0dXJuIGRpc3RhbmNlTSA8PSBtYXhEaXN0YW5jZU1ldGVyczsKfQpmdW5jdGlvbiBnZW9JbnRlcnNlY3RzKGdlb0pzb24sIHF1ZXJ5R2VvKSB7CiAgaWYgKCFnZW9Kc29uIHx8ICFxdWVyeUdlbykgcmV0dXJuIGZhbHNlOwogIGNvbnN0IHF1ZXJ5Q29vcmRzID0gZXh0cmFjdENvb3JkaW5hdGVzRnJvbUdlb0pTT04ocXVlcnlHZW8pOwogIGlmICghcXVlcnlDb29yZHMpIHJldHVybiBmYWxzZTsKICBjb25zdCBkb2NDb29yZHMgPSBleHRyYWN0Q29vcmRpbmF0ZXNGcm9tR2VvSlNPTihnZW9Kc29uKTsKICBpZiAoIWRvY0Nvb3JkcykgcmV0dXJuIGZhbHNlOwogIGlmIChxdWVyeUdlby50eXBlID09PSAiUG9seWdvbiIgJiYgZ2VvSnNvbi50eXBlID09PSAiUG9pbnQiKSB7CiAgICByZXR1cm4gcG9pbnRJblBvbHlnb24oZG9jQ29vcmRzLmxuZywgZG9jQ29vcmRzLmxhdCwgcXVlcnlHZW8uY29vcmRpbmF0ZXNbMF0pOwogIH0KICBpZiAoZ2VvSnNvbi50eXBlID09PSAiUG9seWdvbiIgJiYgcXVlcnlHZW8udHlwZSA9PT0gIlBvaW50IikgewogICAgY29uc3QgcXVlcnlQdCA9IHF1ZXJ5R2VvLmNvb3JkaW5hdGVzOwogICAgcmV0dXJuIHBvaW50SW5Qb2x5Z29uKHF1ZXJ5UHRbMF0sIHF1ZXJ5UHRbMV0sIGdlb0pzb24uY29vcmRpbmF0ZXNbMF0pOwogIH0KICBpZiAoZ2VvSnNvbi50eXBlID09PSAiUG9pbnQiICYmIHF1ZXJ5R2VvLnR5cGUgPT09ICJQb2ludCIpIHsKICAgIGNvbnN0IGRpc3QgPSBoYXZlcnNpbmVEaXN0YW5jZSQxKGRvY0Nvb3Jkcy5sYXQsIGRvY0Nvb3Jkcy5sbmcsIHF1ZXJ5Q29vcmRzLmxhdCwgcXVlcnlDb29yZHMubG5nKTsKICAgIHJldHVybiBkaXN0IDwgMWUtMzsKICB9CiAgcmV0dXJuIGZhbHNlOwp9CmZ1bmN0aW9uIHBvaW50SW5Qb2x5Z29uKGxuZywgbGF0LCByaW5nKSB7CiAgbGV0IGluc2lkZSA9IGZhbHNlOwogIGZvciAobGV0IGkgPSAwLCBqID0gcmluZy5sZW5ndGggLSAxOyBpIDwgcmluZy5sZW5ndGg7IGogPSBpKyspIHsKICAgIGNvbnN0IHhpID0gcmluZ1tpXVswXSwgeWkgPSByaW5nW2ldWzFdOwogICAgY29uc3QgeGogPSByaW5nW2pdWzBdLCB5aiA9IHJpbmdbal1bMV07CiAgICBjb25zdCBpbnRlcnNlY3QgPSB5aSA+IGxhdCAhPT0geWogPiBsYXQgJiYgbG5nIDwgKHhqIC0geGkpICogKGxhdCAtIHlpKSAvICh5aiAtIHlpKSArIHhpOwogICAgaWYgKGludGVyc2VjdCkgaW5zaWRlID0gIWluc2lkZTsKICB9CiAgcmV0dXJuIGluc2lkZTsKfQpmdW5jdGlvbiB3aGVyZShkb2MsIHZhbHVlKSB7CiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gImZ1bmN0aW9uIikgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIHZhbHVlLmNhbGwoZG9jKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAic3RyaW5nIikgewogICAgdHJ5IHsKICAgICAgdmFyIGZuID0gbmV3IEZ1bmN0aW9uKCJyZXR1cm4gIiArIHZhbHVlKTsKICAgICAgcmV0dXJuIGZuLmNhbGwoZG9jKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0KICByZXR1cm4gZmFsc2U7Cn0KZnVuY3Rpb24gdGxNYXRjaGVzKGRvYywgcXVlcnkpIHsKICB2YXIga2V5ID0gT2JqZWN0LmtleXMocXVlcnkpWzBdOwogIHZhciB2YWx1ZSA9IHF1ZXJ5W2tleV07CiAgaWYgKGtleS5jaGFyQXQoMCkgPT0gIiQiKSB7CiAgICBpZiAoa2V5ID09ICIkYW5kIikgcmV0dXJuIGFuZChkb2MsIHZhbHVlKTsKICAgIGVsc2UgaWYgKGtleSA9PSAiJG9yIikgcmV0dXJuIG9yKGRvYywgdmFsdWUpOwogICAgZWxzZSBpZiAoa2V5ID09ICIkbm90IikgcmV0dXJuIG5vdChkb2MsIHZhbHVlKTsKICAgIGVsc2UgaWYgKGtleSA9PSAiJG5vciIpIHJldHVybiBub3IoZG9jLCB2YWx1ZSk7CiAgICBlbHNlIGlmIChrZXkgPT0gIiR3aGVyZSIpIHJldHVybiB3aGVyZShkb2MsIHZhbHVlKTsKICAgIGVsc2UgaWYgKGtleSA9PSAiJGNvbW1lbnQiKSByZXR1cm4gdHJ1ZTsKICAgIGVsc2UgaWYgKGtleSA9PSAiJGpzb25TY2hlbWEiKSByZXR1cm4gdmFsaWRhdGVKc29uU2NoZW1hKGRvYywgdmFsdWUpOwogICAgZWxzZSBpZiAoa2V5ID09ICIkdGV4dCIpIHsKICAgICAgY29uc3Qgc2VhcmNoVGV4dCA9IHZhbHVlLiRzZWFyY2ggfHwgdmFsdWU7CiAgICAgIHJldHVybiB0ZXh0U2VhcmNoRG9jdW1lbnQoZG9jLCBzZWFyY2hUZXh0KTsKICAgIH0gZWxzZSBpZiAoa2V5ID09ICIkZXhwciIpIHsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gZXZhbHVhdGVFeHByZXNzaW9uKHZhbHVlLCBkb2MpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9IGVsc2UgdGhyb3cgeyAkZXJyOiAiQ2FuJ3QgY2Fub25pY2FsaXplIHF1ZXJ5OiBCYWRWYWx1ZSB1bmtub3duIHRvcCBsZXZlbCBvcGVyYXRvcjogIiArIGtleSwgY29kZTogMTcyODcgfTsKICB9IGVsc2UgewogICAgcmV0dXJuIG9wTWF0Y2hlcyhkb2MsIGtleSwgdmFsdWUpOwogIH0KfQpmdW5jdGlvbiBvcE1hdGNoZXMoZG9jLCBrZXksIHZhbHVlKSB7CiAgdmFyIGZpZWxkVmFsdWUgPSBnZXRGaWVsZFZhbHVlcyhkb2MsIGtleSk7CiAgaWYgKHR5cGVvZiB2YWx1ZSA9PSAic3RyaW5nIikgcmV0dXJuIGZpZWxkVmFsdWVNYXRjaGVzKGZpZWxkVmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgIHJldHVybiB2YWx1ZXNFcXVhbCh2LCB2YWx1ZSk7CiAgfSk7CiAgZWxzZSBpZiAodHlwZW9mIHZhbHVlID09ICJudW1iZXIiKSByZXR1cm4gZmllbGRWYWx1ZU1hdGNoZXMoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgcmV0dXJuIHZhbHVlc0VxdWFsKHYsIHZhbHVlKTsKICB9KTsKICBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT0gImJvb2xlYW4iKSByZXR1cm4gZmllbGRWYWx1ZU1hdGNoZXMoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgcmV0dXJuIHZhbHVlc0VxdWFsKHYsIHZhbHVlKTsKICB9KTsKICBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIE9iamVjdElkKSByZXR1cm4gZmllbGRWYWx1ZU1hdGNoZXMoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgcmV0dXJuIHZhbHVlc0VxdWFsKHYsIHZhbHVlKTsKICB9KTsKICBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT0gIm9iamVjdCIpIHsKICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFJlZ0V4cCkgcmV0dXJuIGZpZWxkVmFsdWUgIT0gdm9pZCAwICYmIGZpZWxkVmFsdWVNYXRjaGVzKGZpZWxkVmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgICAgcmV0dXJuIHYgJiYgdi5tYXRjaCh2YWx1ZSk7CiAgICB9KTsKICAgIGVsc2UgaWYgKGlzQXJyYXkodmFsdWUpKSByZXR1cm4gZmllbGRWYWx1ZSAhPSB2b2lkIDAgJiYgZmllbGRWYWx1ZU1hdGNoZXMoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgICByZXR1cm4gdiAmJiBhcnJheU1hdGNoZXModiwgdmFsdWUpOwogICAgfSk7CiAgICBlbHNlIHsKICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyh2YWx1ZSk7CiAgICAgIGlmIChrZXlzWzBdLmNoYXJBdCgwKSA9PSAiJCIpIHsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBvcGVyYXRvciA9IE9iamVjdC5rZXlzKHZhbHVlKVtpXTsKICAgICAgICAgIHZhciBvcGVyYW5kID0gdmFsdWVbb3BlcmF0b3JdOwogICAgICAgICAgaWYgKG9wZXJhdG9yID09ICIkZXEiKSB7CiAgICAgICAgICAgIGlmICghZmllbGRWYWx1ZU1hdGNoZXMoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgIHJldHVybiB2YWx1ZXNFcXVhbCh2LCBvcGVyYW5kKTsKICAgICAgICAgICAgfSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSBpZiAob3BlcmF0b3IgPT0gIiRndCIpIHsKICAgICAgICAgICAgaWYgKCFmaWVsZFZhbHVlTWF0Y2hlcyhmaWVsZFZhbHVlLCBmdW5jdGlvbih2KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNvbXBhcmVWYWx1ZXModiwgb3BlcmFuZCwgIj4iKTsKICAgICAgICAgICAgfSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSBpZiAob3BlcmF0b3IgPT0gIiRndGUiKSB7CiAgICAgICAgICAgIGlmICghZmllbGRWYWx1ZU1hdGNoZXMoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgIHJldHVybiBjb21wYXJlVmFsdWVzKHYsIG9wZXJhbmQsICI+PSIpOwogICAgICAgICAgICB9KSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJGx0IikgewogICAgICAgICAgICBpZiAoIWZpZWxkVmFsdWVNYXRjaGVzKGZpZWxkVmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgICByZXR1cm4gY29tcGFyZVZhbHVlcyh2LCBvcGVyYW5kLCAiPCIpOwogICAgICAgICAgICB9KSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJGx0ZSIpIHsKICAgICAgICAgICAgaWYgKCFmaWVsZFZhbHVlTWF0Y2hlcyhmaWVsZFZhbHVlLCBmdW5jdGlvbih2KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNvbXBhcmVWYWx1ZXModiwgb3BlcmFuZCwgIjw9Iik7CiAgICAgICAgICAgIH0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgaWYgKG9wZXJhdG9yID09ICIkbmUiKSB7CiAgICAgICAgICAgIGlmICghZmllbGRWYWx1ZU1hdGNoZXMoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgIHJldHVybiAhdmFsdWVzRXF1YWwodiwgb3BlcmFuZCk7CiAgICAgICAgICAgIH0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgaWYgKG9wZXJhdG9yID09ICIkaW4iKSB7CiAgICAgICAgICAgIGlmICghZmllbGRWYWx1ZU1hdGNoZXMoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgIHJldHVybiBpc0luKHYsIG9wZXJhbmQpOwogICAgICAgICAgICB9KSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJG5pbiIpIHsKICAgICAgICAgICAgaWYgKGZpZWxkVmFsdWVNYXRjaGVzKGZpZWxkVmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgICByZXR1cm4gaXNJbih2LCBvcGVyYW5kKTsKICAgICAgICAgICAgfSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSBpZiAob3BlcmF0b3IgPT0gIiRleGlzdHMiKSB7CiAgICAgICAgICAgIHZhciByYXdWYWx1ZSA9IGdldFByb3AoZG9jLCBrZXkpOwogICAgICAgICAgICBpZiAob3BlcmFuZCA/IHJhd1ZhbHVlID09IHZvaWQgMCA6IHJhd1ZhbHVlICE9IHZvaWQgMCkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJHR5cGUiKSB7CiAgICAgICAgICAgIGlmIChmaWVsZFZhbHVlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICBjb25zdCBleHBlY3RlZFR5cGVDb2RlID0gdHlwZW9mIG9wZXJhbmQgPT09ICJudW1iZXIiID8gb3BlcmFuZCA6IFRZUEVfQUxJQVNFU1tvcGVyYW5kXTsKICAgICAgICAgICAgICBpZiAoZXhwZWN0ZWRUeXBlQ29kZSAhPT0gNikgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmICghbWF0Y2hlc1R5cGUoZmllbGRWYWx1ZSwgb3BlcmFuZCkpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJG1vZCIpIHsKICAgICAgICAgICAgaWYgKG9wZXJhbmQubGVuZ3RoICE9IDIpIHRocm93IHsgJGVycjogIkNhbid0IGNhbm9uaWNhbGl6ZSBxdWVyeTogQmFkVmFsdWUgbWFsZm9ybWVkIG1vZCwgbm90IGVub3VnaCBlbGVtZW50cyIsIGNvZGU6IDE3Mjg3IH07CiAgICAgICAgICAgIGlmICghZmllbGRWYWx1ZU1hdGNoZXMoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgIHJldHVybiB2ICE9IHZvaWQgMCAmJiB2ICUgb3BlcmFuZFswXSA9PSBvcGVyYW5kWzFdOwogICAgICAgICAgICB9KSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJHJlZ2V4IikgewogICAgICAgICAgICB2YXIgcGF0dGVybiA9IG9wZXJhbmQ7CiAgICAgICAgICAgIHZhciBmbGFncyA9IHZhbHVlLiRvcHRpb25zIHx8ICIiOwogICAgICAgICAgICB2YXIgcmVnZXggPSB0eXBlb2YgcGF0dGVybiA9PT0gInN0cmluZyIgPyBuZXcgUmVnRXhwKHBhdHRlcm4sIGZsYWdzKSA6IHBhdHRlcm47CiAgICAgICAgICAgIGlmICghZmllbGRWYWx1ZU1hdGNoZXMoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgIHJldHVybiB2ICE9IHZvaWQgMCAmJiByZWdleC50ZXN0KHYpOwogICAgICAgICAgICB9KSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJG9wdGlvbnMiKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJHRleHQiKSB7CiAgICAgICAgICAgIGlmICghZmllbGRWYWx1ZU1hdGNoZXMoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgIHJldHVybiB2ICE9IHZvaWQgMCAmJiB0ZXh0KHYsIG9wZXJhbmQpOwogICAgICAgICAgICB9KSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJGV4cHIiKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gZXZhbHVhdGVFeHByZXNzaW9uKG9wZXJhbmQsIGRvYyk7CiAgICAgICAgICAgICAgaWYgKCFyZXN1bHQpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJGdlb1dpdGhpbiIpIHsKICAgICAgICAgICAgaWYgKCFmaWVsZFZhbHVlTWF0Y2hlcyhmaWVsZFZhbHVlLCBmdW5jdGlvbih2KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHYgIT0gdm9pZCAwICYmIGdlb1dpdGhpbih2LCBvcGVyYW5kKTsKICAgICAgICAgICAgfSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSBpZiAob3BlcmF0b3IgPT0gIiRuZWFyIiB8fCBvcGVyYXRvciA9PSAiJG5lYXJTcGhlcmUiKSB7CiAgICAgICAgICAgIGxldCBjb29yZGluYXRlczsKICAgICAgICAgICAgaWYgKG9wZXJhbmQuJGdlb21ldHJ5KSB7CiAgICAgICAgICAgICAgY29vcmRpbmF0ZXMgPSBvcGVyYW5kLiRnZW9tZXRyeS5jb29yZGluYXRlczsKICAgICAgICAgICAgfSBlbHNlIGlmIChvcGVyYW5kLmNvb3JkaW5hdGVzKSB7CiAgICAgICAgICAgICAgY29vcmRpbmF0ZXMgPSBvcGVyYW5kLmNvb3JkaW5hdGVzOwogICAgICAgICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkob3BlcmFuZCkpIHsKICAgICAgICAgICAgICBjb29yZGluYXRlcyA9IG9wZXJhbmQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNvb3JkaW5hdGVzICYmIGNvb3JkaW5hdGVzLmxlbmd0aCA+PSAyKSB7CiAgICAgICAgICAgICAgY29uc3QgW2xuZywgbGF0XSA9IGNvb3JkaW5hdGVzOwogICAgICAgICAgICAgIGNvbnN0IG1heERpc3RhbmNlTWV0ZXJzID0gb3BlcmFuZC4kbWF4RGlzdGFuY2UgfHwgMWU2OwogICAgICAgICAgICAgIGlmICghZmllbGRWYWx1ZU1hdGNoZXMoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgICAgcmV0dXJuIHYgIT0gdm9pZCAwICYmIGlzTmVhcih2LCBsbmcsIGxhdCwgbWF4RGlzdGFuY2VNZXRlcnMpOwogICAgICAgICAgICAgIH0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKG9wZXJhdG9yID09ICIkZ2VvSW50ZXJzZWN0cyIpIHsKICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBvcGVyYW5kLiRnZW9tZXRyeSB8fCBvcGVyYW5kOwogICAgICAgICAgICBpZiAoIWZpZWxkVmFsdWVNYXRjaGVzKGZpZWxkVmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgICByZXR1cm4gdiAhPSB2b2lkIDAgJiYgZ2VvSW50ZXJzZWN0cyh2LCBnZW9tZXRyeSk7CiAgICAgICAgICAgIH0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgaWYgKG9wZXJhdG9yID09ICIkbm90IikgewogICAgICAgICAgICBpZiAob3BNYXRjaGVzKGRvYywga2V5LCBvcGVyYW5kKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJGFsbCIpIHsKICAgICAgICAgICAgdmFyIGFycmF5RmllbGRWYWx1ZSA9IGdldFByb3AoZG9jLCBrZXkpOwogICAgICAgICAgICBpZiAoYXJyYXlGaWVsZFZhbHVlID09IHZvaWQgMCB8fCAhaXNBcnJheShhcnJheUZpZWxkVmFsdWUpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgb3BlcmFuZC5sZW5ndGg7IGorKykgewogICAgICAgICAgICAgIGlmICghaXNJbihvcGVyYW5kW2pdLCBhcnJheUZpZWxkVmFsdWUpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAob3BlcmF0b3IgPT0gIiRlbGVtTWF0Y2giKSB7CiAgICAgICAgICAgIHZhciBhcnJheUZpZWxkVmFsdWUgPSBnZXRQcm9wKGRvYywga2V5KTsKICAgICAgICAgICAgaWYgKGFycmF5RmllbGRWYWx1ZSA9PSB2b2lkIDAgfHwgIWlzQXJyYXkoYXJyYXlGaWVsZFZhbHVlKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB2YXIgZm91bmQgPSBmYWxzZTsKICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBhcnJheUZpZWxkVmFsdWUubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICB2YXIgZWxlbWVudCA9IGFycmF5RmllbGRWYWx1ZVtqXTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGVsZW1lbnQgPT09ICJvYmplY3QiICYmICFpc0FycmF5KGVsZW1lbnQpKSB7CiAgICAgICAgICAgICAgICBpZiAobWF0Y2hlcyhlbGVtZW50LCBvcGVyYW5kKSkgewogICAgICAgICAgICAgICAgICBmb3VuZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2hlc1ByaW1pdGl2ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB2YXIgb3BLZXlzID0gT2JqZWN0LmtleXMob3BlcmFuZCk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBrID0gMDsgayA8IG9wS2V5cy5sZW5ndGg7IGsrKykgewogICAgICAgICAgICAgICAgICB2YXIgb3AgPSBvcEtleXNba107CiAgICAgICAgICAgICAgICAgIHZhciBvcFZhbHVlID0gb3BlcmFuZFtvcF07CiAgICAgICAgICAgICAgICAgIGlmIChvcCA9PSAiJGd0ZSIgJiYgIShlbGVtZW50ID49IG9wVmFsdWUpKSBtYXRjaGVzUHJpbWl0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG9wID09ICIkZ3QiICYmICEoZWxlbWVudCA+IG9wVmFsdWUpKSBtYXRjaGVzUHJpbWl0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG9wID09ICIkbHRlIiAmJiAhKGVsZW1lbnQgPD0gb3BWYWx1ZSkpIG1hdGNoZXNQcmltaXRpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgZWxzZSBpZiAob3AgPT0gIiRsdCIgJiYgIShlbGVtZW50IDwgb3BWYWx1ZSkpIG1hdGNoZXNQcmltaXRpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgZWxzZSBpZiAob3AgPT0gIiRlcSIgJiYgIShlbGVtZW50ID09IG9wVmFsdWUpKSBtYXRjaGVzUHJpbWl0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG9wID09ICIkbmUiICYmICEoZWxlbWVudCAhPSBvcFZhbHVlKSkgbWF0Y2hlc1ByaW1pdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICBlbHNlIGlmIChvcCA9PSAiJGluIiAmJiAhaXNJbihlbGVtZW50LCBvcFZhbHVlKSkgbWF0Y2hlc1ByaW1pdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICBlbHNlIGlmIChvcCA9PSAiJG5pbiIgJiYgaXNJbihlbGVtZW50LCBvcFZhbHVlKSkgbWF0Y2hlc1ByaW1pdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG1hdGNoZXNQcmltaXRpdmUpIHsKICAgICAgICAgICAgICAgICAgZm91bmQgPSB0cnVlOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFmb3VuZCkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJHNpemUiKSB7CiAgICAgICAgICAgIHZhciBzaXplRmllbGRWYWx1ZSA9IGdldFByb3AoZG9jLCBrZXkpOwogICAgICAgICAgICBpZiAoc2l6ZUZpZWxkVmFsdWUgPT0gdm9pZCAwIHx8ICFpc0FycmF5KHNpemVGaWVsZFZhbHVlKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBpZiAoc2l6ZUZpZWxkVmFsdWUubGVuZ3RoICE9IG9wZXJhbmQpIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSBpZiAob3BlcmF0b3IgPT0gIiRiaXRzQWxsU2V0IikgewogICAgICAgICAgICBpZiAoIWZpZWxkVmFsdWVNYXRjaGVzKGZpZWxkVmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgICByZXR1cm4gbWF0Y2hlc0JpdHNBbGxTZXQodiwgb3BlcmFuZCk7CiAgICAgICAgICAgIH0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgaWYgKG9wZXJhdG9yID09ICIkYml0c0FsbENsZWFyIikgewogICAgICAgICAgICBpZiAoIWZpZWxkVmFsdWVNYXRjaGVzKGZpZWxkVmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgICByZXR1cm4gbWF0Y2hlc0JpdHNBbGxDbGVhcih2LCBvcGVyYW5kKTsKICAgICAgICAgICAgfSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSBpZiAob3BlcmF0b3IgPT0gIiRiaXRzQW55U2V0IikgewogICAgICAgICAgICBpZiAoIWZpZWxkVmFsdWVNYXRjaGVzKGZpZWxkVmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgICByZXR1cm4gbWF0Y2hlc0JpdHNBbnlTZXQodiwgb3BlcmFuZCk7CiAgICAgICAgICAgIH0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgaWYgKG9wZXJhdG9yID09ICIkYml0c0FueUNsZWFyIikgewogICAgICAgICAgICBpZiAoIWZpZWxkVmFsdWVNYXRjaGVzKGZpZWxkVmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgICByZXR1cm4gbWF0Y2hlc0JpdHNBbnlDbGVhcih2LCBvcGVyYW5kKTsKICAgICAgICAgICAgfSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IHsgJGVycjogIkNhbid0IGNhbm9uaWNhbGl6ZSBxdWVyeTogQmFkVmFsdWUgdW5rbm93biBvcGVyYXRvcjogIiArIG9wZXJhdG9yLCBjb2RlOiAxNzI4NyB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZ2V0UHJvcChkb2MsIGtleSkgJiYgb2JqZWN0TWF0Y2hlcyhnZXRQcm9wKGRvYywga2V5KSwgdmFsdWUpOwogICAgICB9CiAgICB9CiAgfQp9CmZ1bmN0aW9uIG5vdChkb2MsIHZhbHVlKSB7CiAgcmV0dXJuICF0bE1hdGNoZXMoZG9jLCB2YWx1ZSk7Cn0KZnVuY3Rpb24gYW5kKGRvYywgZWxzKSB7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbHMubGVuZ3RoOyBpKyspIHsKICAgIGlmICghdGxNYXRjaGVzKGRvYywgZWxzW2ldKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQogIHJldHVybiB0cnVlOwp9CmZ1bmN0aW9uIG9yKGRvYywgZWxzKSB7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbHMubGVuZ3RoOyBpKyspIHsKICAgIGlmICh0bE1hdGNoZXMoZG9jLCBlbHNbaV0pKSByZXR1cm4gdHJ1ZTsKICB9CiAgcmV0dXJuIGZhbHNlOwp9CmZ1bmN0aW9uIG5vcihkb2MsIGVscykgewogIGZvciAodmFyIGkgPSAwOyBpIDwgZWxzLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAodGxNYXRjaGVzKGRvYywgZWxzW2ldKSkgcmV0dXJuIGZhbHNlOwogIH0KICByZXR1cm4gdHJ1ZTsKfQpmdW5jdGlvbiBtYXRjaGVzKGRvYywgcXVlcnkpIHsKICByZXR1cm4gYW5kKGRvYywgdG9BcnJheShxdWVyeSkpOwp9CmZ1bmN0aW9uIG1hdGNoV2l0aEFycmF5SW5kaWNlcyhkb2MsIHF1ZXJ5KSB7CiAgY29uc3QgYXJyYXlGaWx0ZXJzID0ge307CiAgY29uc3QgbWF0Y2hlZCA9IGFuZFdpdGhUcmFja2luZyhkb2MsIHRvQXJyYXkocXVlcnkpLCBhcnJheUZpbHRlcnMpOwogIHJldHVybiB7IG1hdGNoZWQsIGFycmF5RmlsdGVycyB9Owp9CmZ1bmN0aW9uIGFuZFdpdGhUcmFja2luZyhkb2MsIGVscywgYXJyYXlGaWx0ZXJzKSB7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbHMubGVuZ3RoOyBpKyspIHsKICAgIGlmICghdGxNYXRjaGVzV2l0aFRyYWNraW5nKGRvYywgZWxzW2ldLCBhcnJheUZpbHRlcnMpKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9CiAgcmV0dXJuIHRydWU7Cn0KZnVuY3Rpb24gdGxNYXRjaGVzV2l0aFRyYWNraW5nKGRvYywgcXVlcnksIGFycmF5RmlsdGVycykgewogIHZhciBrZXkgPSBPYmplY3Qua2V5cyhxdWVyeSlbMF07CiAgdmFyIHZhbHVlID0gcXVlcnlba2V5XTsKICBpZiAoa2V5LmNoYXJBdCgwKSA9PSAiJCIpIHsKICAgIGlmIChrZXkgPT0gIiRhbmQiKSByZXR1cm4gYW5kV2l0aFRyYWNraW5nKGRvYywgdmFsdWUsIGFycmF5RmlsdGVycyk7CiAgICBlbHNlIGlmIChrZXkgPT0gIiRvciIpIHJldHVybiBvcldpdGhUcmFja2luZyhkb2MsIHZhbHVlLCBhcnJheUZpbHRlcnMpOwogICAgZWxzZSBpZiAoa2V5ID09ICIkbm90IikgewogICAgICByZXR1cm4gIXRsTWF0Y2hlcyhkb2MsIHZhbHVlKTsKICAgIH0gZWxzZSBpZiAoa2V5ID09ICIkbm9yIikgcmV0dXJuIG5vcldpdGhUcmFja2luZyhkb2MsIHZhbHVlLCBhcnJheUZpbHRlcnMpOwogICAgZWxzZSBpZiAoa2V5ID09ICIkd2hlcmUiKSByZXR1cm4gd2hlcmUoZG9jLCB2YWx1ZSk7CiAgICBlbHNlIGlmIChrZXkgPT0gIiRjb21tZW50IikgcmV0dXJuIHRydWU7CiAgICBlbHNlIGlmIChrZXkgPT0gIiRqc29uU2NoZW1hIikgcmV0dXJuIHZhbGlkYXRlSnNvblNjaGVtYShkb2MsIHZhbHVlKTsKICAgIGVsc2UgaWYgKGtleSA9PSAiJGV4cHIiKSB7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIGV2YWx1YXRlRXhwcmVzc2lvbih2YWx1ZSwgZG9jKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfSBlbHNlIHRocm93IHsgJGVycjogIkNhbid0IGNhbm9uaWNhbGl6ZSBxdWVyeTogQmFkVmFsdWUgdW5rbm93biB0b3AgbGV2ZWwgb3BlcmF0b3I6ICIgKyBrZXksIGNvZGU6IDE3Mjg3IH07CiAgfSBlbHNlIHsKICAgIHJldHVybiBvcE1hdGNoZXNXaXRoVHJhY2tpbmcoZG9jLCBrZXksIHZhbHVlLCBhcnJheUZpbHRlcnMpOwogIH0KfQpmdW5jdGlvbiBvcldpdGhUcmFja2luZyhkb2MsIGVscywgYXJyYXlGaWx0ZXJzKSB7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbHMubGVuZ3RoOyBpKyspIHsKICAgIGlmICh0bE1hdGNoZXNXaXRoVHJhY2tpbmcoZG9jLCBlbHNbaV0sIGFycmF5RmlsdGVycykpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQogIHJldHVybiBmYWxzZTsKfQpmdW5jdGlvbiBub3JXaXRoVHJhY2tpbmcoZG9jLCBlbHMsIGFycmF5RmlsdGVycykgewogIGZvciAodmFyIGkgPSAwOyBpIDwgZWxzLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAodGxNYXRjaGVzV2l0aFRyYWNraW5nKGRvYywgZWxzW2ldLCBhcnJheUZpbHRlcnMpKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9CiAgcmV0dXJuIHRydWU7Cn0KZnVuY3Rpb24gb3BNYXRjaGVzV2l0aFRyYWNraW5nKGRvYywga2V5LCB2YWx1ZSwgYXJyYXlGaWx0ZXJzKSB7CiAgY29uc3QgYmFzZUZpZWxkID0ga2V5LnNwbGl0KCIuIilbMF07CiAgY29uc3QgZmllbGRWYWx1ZSA9IGdldEZpZWxkVmFsdWVzKGRvYywga2V5KTsKICBjb25zdCB0cmFja01hdGNoaW5nSW5kZXggPSAoZmllbGRWYWx1ZTIsIGNoZWNrRm4pID0+IHsKICAgIGlmIChmaWVsZFZhbHVlMiA9PT0gdm9pZCAwKSByZXR1cm4gZmFsc2U7CiAgICBpZiAoZmllbGRWYWx1ZTIgPT09IG51bGwpIHJldHVybiBjaGVja0ZuKGZpZWxkVmFsdWUyKTsKICAgIGlmIChpc0FycmF5KGZpZWxkVmFsdWUyKSkgewogICAgICBjb25zdCBiYXNlVmFsdWUgPSBnZXRQcm9wKGRvYywgYmFzZUZpZWxkKTsKICAgICAgaWYgKGlzQXJyYXkoYmFzZVZhbHVlKSkgewogICAgICAgIGZvciAodmFyIGkyID0gMDsgaTIgPCBmaWVsZFZhbHVlMi5sZW5ndGg7IGkyKyspIHsKICAgICAgICAgIGlmIChjaGVja0ZuKGZpZWxkVmFsdWUyW2kyXSkpIHsKICAgICAgICAgICAgYXJyYXlGaWx0ZXJzW2tleV0gPSBpMjsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGZpZWxkVmFsdWVNYXRjaGVzKGZpZWxkVmFsdWUyLCBjaGVja0ZuKTsKICB9OwogIGlmICh0eXBlb2YgdmFsdWUgPT0gInN0cmluZyIpIHJldHVybiB0cmFja01hdGNoaW5nSW5kZXgoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgcmV0dXJuIHZhbHVlc0VxdWFsKHYsIHZhbHVlKTsKICB9KTsKICBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT0gIm51bWJlciIpIHJldHVybiB0cmFja01hdGNoaW5nSW5kZXgoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgcmV0dXJuIHZhbHVlc0VxdWFsKHYsIHZhbHVlKTsKICB9KTsKICBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT0gImJvb2xlYW4iKSByZXR1cm4gdHJhY2tNYXRjaGluZ0luZGV4KGZpZWxkVmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgIHJldHVybiB2YWx1ZXNFcXVhbCh2LCB2YWx1ZSk7CiAgfSk7CiAgZWxzZSBpZiAodmFsdWUgaW5zdGFuY2VvZiBPYmplY3RJZCkgcmV0dXJuIHRyYWNrTWF0Y2hpbmdJbmRleChmaWVsZFZhbHVlLCBmdW5jdGlvbih2KSB7CiAgICByZXR1cm4gdmFsdWVzRXF1YWwodiwgdmFsdWUpOwogIH0pOwogIGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PSAib2JqZWN0IikgewogICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgUmVnRXhwKSByZXR1cm4gZmllbGRWYWx1ZSAhPSB2b2lkIDAgJiYgdHJhY2tNYXRjaGluZ0luZGV4KGZpZWxkVmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgICAgcmV0dXJuIHYgJiYgdi5tYXRjaCh2YWx1ZSk7CiAgICB9KTsKICAgIGVsc2UgaWYgKGlzQXJyYXkodmFsdWUpKSByZXR1cm4gZmllbGRWYWx1ZSAhPSB2b2lkIDAgJiYgdHJhY2tNYXRjaGluZ0luZGV4KGZpZWxkVmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgICAgcmV0dXJuIHYgJiYgYXJyYXlNYXRjaGVzKHYsIHZhbHVlKTsKICAgIH0pOwogICAgZWxzZSB7CiAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXModmFsdWUpOwogICAgICBpZiAoa2V5c1swXS5jaGFyQXQoMCkgPT0gIiQiKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgb3BlcmF0b3IgPSBrZXlzW2ldOwogICAgICAgICAgdmFyIG9wZXJhbmQgPSB2YWx1ZVtvcGVyYXRvcl07CiAgICAgICAgICBpZiAob3BlcmF0b3IgPT0gIiRlcSIpIHsKICAgICAgICAgICAgaWYgKCF0cmFja01hdGNoaW5nSW5kZXgoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgIHJldHVybiB2YWx1ZXNFcXVhbCh2LCBvcGVyYW5kKTsKICAgICAgICAgICAgfSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSBpZiAob3BlcmF0b3IgPT0gIiRndCIpIHsKICAgICAgICAgICAgaWYgKCF0cmFja01hdGNoaW5nSW5kZXgoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgIHJldHVybiBjb21wYXJlVmFsdWVzKHYsIG9wZXJhbmQsICI+Iik7CiAgICAgICAgICAgIH0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgaWYgKG9wZXJhdG9yID09ICIkZ3RlIikgewogICAgICAgICAgICBpZiAoIXRyYWNrTWF0Y2hpbmdJbmRleChmaWVsZFZhbHVlLCBmdW5jdGlvbih2KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNvbXBhcmVWYWx1ZXModiwgb3BlcmFuZCwgIj49Iik7CiAgICAgICAgICAgIH0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgaWYgKG9wZXJhdG9yID09ICIkbHQiKSB7CiAgICAgICAgICAgIGlmICghdHJhY2tNYXRjaGluZ0luZGV4KGZpZWxkVmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgICByZXR1cm4gY29tcGFyZVZhbHVlcyh2LCBvcGVyYW5kLCAiPCIpOwogICAgICAgICAgICB9KSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJGx0ZSIpIHsKICAgICAgICAgICAgaWYgKCF0cmFja01hdGNoaW5nSW5kZXgoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgIHJldHVybiBjb21wYXJlVmFsdWVzKHYsIG9wZXJhbmQsICI8PSIpOwogICAgICAgICAgICB9KSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJG5lIikgewogICAgICAgICAgICBpZiAoIXRyYWNrTWF0Y2hpbmdJbmRleChmaWVsZFZhbHVlLCBmdW5jdGlvbih2KSB7CiAgICAgICAgICAgICAgcmV0dXJuICF2YWx1ZXNFcXVhbCh2LCBvcGVyYW5kKTsKICAgICAgICAgICAgfSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSBpZiAob3BlcmF0b3IgPT0gIiRpbiIpIHsKICAgICAgICAgICAgaWYgKCF0cmFja01hdGNoaW5nSW5kZXgoZmllbGRWYWx1ZSwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgIHJldHVybiBpc0luKHYsIG9wZXJhbmQpOwogICAgICAgICAgICB9KSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAiJG5pbiIpIHsKICAgICAgICAgICAgaWYgKHRyYWNrTWF0Y2hpbmdJbmRleChmaWVsZFZhbHVlLCBmdW5jdGlvbih2KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGlzSW4odiwgb3BlcmFuZCk7CiAgICAgICAgICAgIH0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgaWYgKG9wZXJhdG9yID09ICIkZWxlbU1hdGNoIikgewogICAgICAgICAgICB2YXIgYXJyYXlGaWVsZFZhbHVlID0gZ2V0UHJvcChkb2MsIGtleSk7CiAgICAgICAgICAgIGlmIChhcnJheUZpZWxkVmFsdWUgPT0gdm9pZCAwIHx8ICFpc0FycmF5KGFycmF5RmllbGRWYWx1ZSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBhcnJheUZpZWxkVmFsdWUubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICB2YXIgZWxlbWVudCA9IGFycmF5RmllbGRWYWx1ZVtqXTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGVsZW1lbnQgPT09ICJvYmplY3QiICYmICFpc0FycmF5KGVsZW1lbnQpKSB7CiAgICAgICAgICAgICAgICBpZiAobWF0Y2hlcyhlbGVtZW50LCBvcGVyYW5kKSkgewogICAgICAgICAgICAgICAgICBhcnJheUZpbHRlcnNba2V5XSA9IGo7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2hlc1ByaW1pdGl2ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB2YXIgb3BLZXlzID0gT2JqZWN0LmtleXMob3BlcmFuZCk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBrID0gMDsgayA8IG9wS2V5cy5sZW5ndGg7IGsrKykgewogICAgICAgICAgICAgICAgICB2YXIgb3AgPSBvcEtleXNba107CiAgICAgICAgICAgICAgICAgIHZhciBvcFZhbHVlID0gb3BlcmFuZFtvcF07CiAgICAgICAgICAgICAgICAgIGlmIChvcCA9PSAiJGd0ZSIgJiYgIShlbGVtZW50ID49IG9wVmFsdWUpKSBtYXRjaGVzUHJpbWl0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG9wID09ICIkZ3QiICYmICEoZWxlbWVudCA+IG9wVmFsdWUpKSBtYXRjaGVzUHJpbWl0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG9wID09ICIkbHRlIiAmJiAhKGVsZW1lbnQgPD0gb3BWYWx1ZSkpIG1hdGNoZXNQcmltaXRpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgZWxzZSBpZiAob3AgPT0gIiRsdCIgJiYgIShlbGVtZW50IDwgb3BWYWx1ZSkpIG1hdGNoZXNQcmltaXRpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgZWxzZSBpZiAob3AgPT0gIiRlcSIgJiYgZWxlbWVudCAhPSBvcFZhbHVlKSBtYXRjaGVzUHJpbWl0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG9wID09ICIkbmUiICYmIGVsZW1lbnQgPT0gb3BWYWx1ZSkgbWF0Y2hlc1ByaW1pdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG1hdGNoZXNQcmltaXRpdmUpIHsKICAgICAgICAgICAgICAgICAgYXJyYXlGaWx0ZXJzW2tleV0gPSBqOwogICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKCFvcE1hdGNoZXMoZG9jLCBrZXksIHZhbHVlKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmllbGRWYWx1ZSAhPSB2b2lkIDAgJiYgdHJhY2tNYXRjaGluZ0luZGV4KGZpZWxkVmFsdWUsIGZ1bmN0aW9uKHYpIHsKICAgICAgICAgIHJldHVybiBvYmplY3RNYXRjaGVzKHYsIHZhbHVlKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gZmFsc2U7Cn0KZnVuY3Rpb24gZXh0cmFjdEZpbHRlcmVkUG9zaXRpb25hbElkZW50aWZpZXIocGF0aFNlZ21lbnQpIHsKICBjb25zdCBtYXRjaCA9IHBhdGhTZWdtZW50Lm1hdGNoKC9eXCRcWyhbXlxdXSspXF0kLyk7CiAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiBudWxsOwp9CmZ1bmN0aW9uIHBhcnNlRmllbGRQYXRoKGZpZWxkUGF0aCkgewogIGNvbnN0IHNlZ21lbnRzID0gZmllbGRQYXRoLnNwbGl0KCIuIik7CiAgcmV0dXJuIHNlZ21lbnRzLm1hcCgoc2VnbWVudCkgPT4gewogICAgY29uc3QgaWRlbnRpZmllciA9IGV4dHJhY3RGaWx0ZXJlZFBvc2l0aW9uYWxJZGVudGlmaWVyKHNlZ21lbnQpOwogICAgcmV0dXJuIHsKICAgICAgc2VnbWVudCwKICAgICAgaXNGaWx0ZXJlZFBvc2l0aW9uYWw6IGlkZW50aWZpZXIgIT09IG51bGwsCiAgICAgIGlkZW50aWZpZXIKICAgIH07CiAgfSk7Cn0KZnVuY3Rpb24gYXBwbHlUb0ZpbHRlcmVkQXJyYXlFbGVtZW50cyhkb2MsIHBhcnNlZFBhdGgsIHZhbHVlLCBvcGVyYXRpb24sIGFycmF5RmlsdGVycykgewogIGZ1bmN0aW9uIHRyYXZlcnNlKGN1cnJlbnQsIHBhdGhJbmRleCwgZmlsdGVyQ29udGV4dCkgewogICAgaWYgKHBhdGhJbmRleCA+PSBwYXJzZWRQYXRoLmxlbmd0aCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBwYXRoSW5mbyA9IHBhcnNlZFBhdGhbcGF0aEluZGV4XTsKICAgIGNvbnN0IGlzTGFzdFNlZ21lbnQgPSBwYXRoSW5kZXggPT09IHBhcnNlZFBhdGgubGVuZ3RoIC0gMTsKICAgIGlmIChwYXRoSW5mby5pc0ZpbHRlcmVkUG9zaXRpb25hbCkgewogICAgICBjb25zdCBpZGVudGlmaWVyID0gcGF0aEluZm8uaWRlbnRpZmllcjsKICAgICAgY29uc3QgZmlsdGVyID0gYXJyYXlGaWx0ZXJzID8gYXJyYXlGaWx0ZXJzLmZpbmQoKGYpID0+IHsKICAgICAgICBjb25zdCBmaWx0ZXJLZXlzID0gT2JqZWN0LmtleXMoZik7CiAgICAgICAgcmV0dXJuIGZpbHRlcktleXMuc29tZSgoa2V5KSA9PiBrZXkuc3RhcnRzV2l0aChpZGVudGlmaWVyICsgIi4iKSB8fCBrZXkgPT09IGlkZW50aWZpZXIpOwogICAgICB9KSA6IG51bGw7CiAgICAgIGlmICghYXJyYXlGaWx0ZXJzKSB7CiAgICAgICAgaWYgKCFjdXJyZW50W3BhdGhJbmZvLnNlZ21lbnRdKSB7CiAgICAgICAgICBjb25zdCBuZXh0UGF0aCA9IHBhcnNlZFBhdGhbcGF0aEluZGV4ICsgMV07CiAgICAgICAgICBpZiAobmV4dFBhdGggJiYgbmV4dFBhdGguaXNGaWx0ZXJlZFBvc2l0aW9uYWwpIHsKICAgICAgICAgICAgY3VycmVudFtwYXRoSW5mby5zZWdtZW50XSA9IFtdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY3VycmVudFtwYXRoSW5mby5zZWdtZW50XSA9IHt9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaXNMYXN0U2VnbWVudCkgewogICAgICAgICAgYXBwbHlPcGVyYXRpb25Ub1ZhbHVlKGN1cnJlbnQsIHBhdGhJbmZvLnNlZ21lbnQsIHZhbHVlLCBvcGVyYXRpb24pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0cmF2ZXJzZShjdXJyZW50W3BhdGhJbmZvLnNlZ21lbnRdLCBwYXRoSW5kZXggKyAxKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmICghaXNBcnJheShjdXJyZW50KSkgewogICAgICAgIGlmICghY3VycmVudFtwYXRoSW5mby5zZWdtZW50XSkgewogICAgICAgICAgY3VycmVudFtwYXRoSW5mby5zZWdtZW50XSA9IHt9OwogICAgICAgIH0KICAgICAgICBpZiAoaXNMYXN0U2VnbWVudCkgewogICAgICAgICAgYXBwbHlPcGVyYXRpb25Ub1ZhbHVlKGN1cnJlbnQsIHBhdGhJbmZvLnNlZ21lbnQsIHZhbHVlLCBvcGVyYXRpb24pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0cmF2ZXJzZShjdXJyZW50W3BhdGhJbmZvLnNlZ21lbnRdLCBwYXRoSW5kZXggKyAxKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY3VycmVudC5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGVsZW1lbnQgPSBjdXJyZW50W2ldOwogICAgICAgIGxldCBzaG91bGRVcGRhdGUgPSB0cnVlOwogICAgICAgIGlmIChmaWx0ZXIpIHsKICAgICAgICAgIGxldCB0cmFuc2Zvcm1lZEZpbHRlciA9IHt9OwogICAgICAgICAgbGV0IGhhc0RpcmVjdE1hdGNoID0gZmFsc2U7CiAgICAgICAgICBPYmplY3Qua2V5cyhmaWx0ZXIpLmZvckVhY2goKGtleSkgPT4gewogICAgICAgICAgICBpZiAoa2V5LnN0YXJ0c1dpdGgoaWRlbnRpZmllciArICIuIikpIHsKICAgICAgICAgICAgICBjb25zdCBmaWVsZFBhdGggPSBrZXkuc3Vic3RyaW5nKGlkZW50aWZpZXIubGVuZ3RoICsgMSk7CiAgICAgICAgICAgICAgdHJhbnNmb3JtZWRGaWx0ZXJbZmllbGRQYXRoXSA9IGZpbHRlcltrZXldOwogICAgICAgICAgICB9IGVsc2UgaWYgKGtleSA9PT0gaWRlbnRpZmllcikgewogICAgICAgICAgICAgIHRyYW5zZm9ybWVkRmlsdGVyID0gZmlsdGVyW2tleV07CiAgICAgICAgICAgICAgaGFzRGlyZWN0TWF0Y2ggPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIGlmIChoYXNEaXJlY3RNYXRjaCkgewogICAgICAgICAgICBjb25zdCB0ZXN0RG9jID0geyB2YWx1ZTogZWxlbWVudCB9OwogICAgICAgICAgICBjb25zdCB0ZXN0RmlsdGVyID0geyB2YWx1ZTogdHJhbnNmb3JtZWRGaWx0ZXIgfTsKICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gbWF0Y2hlcyh0ZXN0RG9jLCB0ZXN0RmlsdGVyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IG1hdGNoZXMoZWxlbWVudCwgdHJhbnNmb3JtZWRGaWx0ZXIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoc2hvdWxkVXBkYXRlKSB7CiAgICAgICAgICBpZiAoaXNMYXN0U2VnbWVudCkgewogICAgICAgICAgICBhcHBseU9wZXJhdGlvblRvVmFsdWUoY3VycmVudCwgaSwgdmFsdWUsIG9wZXJhdGlvbik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoZWxlbWVudCAhPT0gbnVsbCAmJiBlbGVtZW50ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0cmF2ZXJzZShjdXJyZW50W2ldLCBwYXRoSW5kZXggKyAxKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKGN1cnJlbnRbcGF0aEluZm8uc2VnbWVudF0gPT09IHZvaWQgMCB8fCBjdXJyZW50W3BhdGhJbmZvLnNlZ21lbnRdID09PSBudWxsKSB7CiAgICAgICAgaWYgKCFpc0xhc3RTZWdtZW50KSB7CiAgICAgICAgICBjb25zdCBuZXh0UGF0aCA9IHBhcnNlZFBhdGhbcGF0aEluZGV4ICsgMV07CiAgICAgICAgICBpZiAobmV4dFBhdGggJiYgbmV4dFBhdGguaXNGaWx0ZXJlZFBvc2l0aW9uYWwpIHsKICAgICAgICAgICAgY3VycmVudFtwYXRoSW5mby5zZWdtZW50XSA9IFtdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY3VycmVudFtwYXRoSW5mby5zZWdtZW50XSA9IHt9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoaXNMYXN0U2VnbWVudCkgewogICAgICAgIGFwcGx5T3BlcmF0aW9uVG9WYWx1ZShjdXJyZW50LCBwYXRoSW5mby5zZWdtZW50LCB2YWx1ZSwgb3BlcmF0aW9uKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoY3VycmVudFtwYXRoSW5mby5zZWdtZW50XSAhPT0gdm9pZCAwICYmIGN1cnJlbnRbcGF0aEluZm8uc2VnbWVudF0gIT09IG51bGwpIHsKICAgICAgICAgIHRyYXZlcnNlKGN1cnJlbnRbcGF0aEluZm8uc2VnbWVudF0sIHBhdGhJbmRleCArIDEpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICB0cmF2ZXJzZShkb2MsIDApOwp9CmZ1bmN0aW9uIGFwcGx5T3BlcmF0aW9uVG9WYWx1ZShjb250YWluZXIsIGtleSwgdmFsdWUsIG9wZXJhdGlvbikgewogIHN3aXRjaCAob3BlcmF0aW9uKSB7CiAgICBjYXNlICIkc2V0IjoKICAgICAgY29udGFpbmVyW2tleV0gPSB2YWx1ZTsKICAgICAgYnJlYWs7CiAgICBjYXNlICIkaW5jIjoKICAgICAgaWYgKGNvbnRhaW5lcltrZXldID09PSB2b2lkIDApIGNvbnRhaW5lcltrZXldID0gMDsKICAgICAgY29udGFpbmVyW2tleV0gKz0gdmFsdWU7CiAgICAgIGJyZWFrOwogICAgY2FzZSAiJG11bCI6CiAgICAgIGNvbnRhaW5lcltrZXldID0gY29udGFpbmVyW2tleV0gKiB2YWx1ZTsKICAgICAgYnJlYWs7CiAgICBjYXNlICIkbWluIjoKICAgICAgY29udGFpbmVyW2tleV0gPSBNYXRoLm1pbihjb250YWluZXJba2V5XSwgdmFsdWUpOwogICAgICBicmVhazsKICAgIGNhc2UgIiRtYXgiOgogICAgICBjb250YWluZXJba2V5XSA9IE1hdGgubWF4KGNvbnRhaW5lcltrZXldLCB2YWx1ZSk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAiJHVuc2V0IjoKICAgICAgZGVsZXRlIGNvbnRhaW5lcltrZXldOwogICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgIGNvbnRhaW5lcltrZXldID0gdmFsdWU7CiAgfQp9CmZ1bmN0aW9uIGhhc0ZpbHRlcmVkUG9zaXRpb25hbE9wZXJhdG9yKGZpZWxkUGF0aCkgewogIHJldHVybiAvXCRcW1teXF1dK1xdLy50ZXN0KGZpZWxkUGF0aCk7Cn0KZnVuY3Rpb24gaGFzQWxsUG9zaXRpb25hbChmaWVsZCkgewogIHJldHVybiBmaWVsZC5pbmRleE9mKCIkW10iKSAhPT0gLTE7Cn0KZnVuY3Rpb24gYXBwbHlUb0FsbFBvc2l0aW9uYWwoZG9jLCBmaWVsZCwgdXBkYXRlRm4pIHsKICB2YXIgcGF0aCA9IGZpZWxkLnNwbGl0KCIuIik7CiAgdmFyIGN1cnJlbnQgPSBkb2M7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXRoLmxlbmd0aDsgaSsrKSB7CiAgICB2YXIgcGF0aFNlZ21lbnQgPSBwYXRoW2ldOwogICAgaWYgKHBhdGhTZWdtZW50ID09PSAiJFtdIikgewogICAgICBpZiAoIUFycmF5LmlzQXJyYXkoY3VycmVudCkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIHJlbWFpbmluZ1BhdGggPSBwYXRoLnNsaWNlKGkgKyAxKS5qb2luKCIuIik7CiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgY3VycmVudC5sZW5ndGg7IGorKykgewogICAgICAgIGlmIChyZW1haW5pbmdQYXRoKSB7CiAgICAgICAgICBpZiAocmVtYWluaW5nUGF0aC5pbmRleE9mKCIkW10iKSAhPT0gLTEpIHsKICAgICAgICAgICAgYXBwbHlUb0FsbFBvc2l0aW9uYWwoY3VycmVudFtqXSwgcmVtYWluaW5nUGF0aCwgdXBkYXRlRm4pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRWYWx1ZSA9IGdldFByb3AoY3VycmVudFtqXSwgcmVtYWluaW5nUGF0aCk7CiAgICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IHVwZGF0ZUZuKGN1cnJlbnRWYWx1ZSk7CiAgICAgICAgICAgIHNldFByb3AoY3VycmVudFtqXSwgcmVtYWluaW5nUGF0aCwgbmV3VmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjdXJyZW50W2pdID0gdXBkYXRlRm4oY3VycmVudFtqXSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChjdXJyZW50ID09IG51bGwgfHwgY3VycmVudCA9PSB2b2lkIDApIHJldHVybjsKICAgIGN1cnJlbnQgPSBjdXJyZW50W3BhdGhTZWdtZW50XTsKICB9Cn0KZnVuY3Rpb24gcmVwbGFjZVBvc2l0aW9uYWxPcGVyYXRvcihmaWVsZFBhdGgsIGFycmF5RmlsdGVycykgewogIGlmICghYXJyYXlGaWx0ZXJzIHx8ICFmaWVsZFBhdGguaW5jbHVkZXMoIiQiKSkgewogICAgcmV0dXJuIGZpZWxkUGF0aDsKICB9CiAgY29uc3QgcGFydHMgPSBmaWVsZFBhdGguc3BsaXQoIi4iKTsKICBjb25zdCBkb2xsYXJJbmRleCA9IHBhcnRzLmluZGV4T2YoIiQiKTsKICBpZiAoZG9sbGFySW5kZXggPT09IC0xKSB7CiAgICByZXR1cm4gZmllbGRQYXRoOwogIH0KICBjb25zdCBwYXRoQmVmb3JlRG9sbGFyID0gcGFydHMuc2xpY2UoMCwgZG9sbGFySW5kZXgpLmpvaW4oIi4iKTsKICBsZXQgbWF0Y2hlZEluZGV4ID0gbnVsbDsKICBmb3IgKGNvbnN0IGZpbHRlclBhdGggaW4gYXJyYXlGaWx0ZXJzKSB7CiAgICBpZiAoZmlsdGVyUGF0aCA9PT0gcGF0aEJlZm9yZURvbGxhciB8fCBmaWx0ZXJQYXRoLnN0YXJ0c1dpdGgocGF0aEJlZm9yZURvbGxhciArICIuIikpIHsKICAgICAgbWF0Y2hlZEluZGV4ID0gYXJyYXlGaWx0ZXJzW2ZpbHRlclBhdGhdOwogICAgICBicmVhazsKICAgIH0KICB9CiAgaWYgKG1hdGNoZWRJbmRleCAhPT0gbnVsbCAmJiBtYXRjaGVkSW5kZXggIT09IHZvaWQgMCkgewogICAgcGFydHNbZG9sbGFySW5kZXhdID0gbWF0Y2hlZEluZGV4LnRvU3RyaW5nKCk7CiAgICByZXR1cm4gcGFydHMuam9pbigiLiIpOwogIH0KICByZXR1cm4gZmllbGRQYXRoOwp9CmZ1bmN0aW9uIGFwcGx5VXBkYXRlcyh1cGRhdGVzLCBkb2MsIHNldE9uSW5zZXJ0LCBwb3NpdGlvbmFsTWF0Y2hJbmZvLCB1c2VyQXJyYXlGaWx0ZXJzKSB7CiAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyh1cGRhdGVzKTsKICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgIHZhciBrZXkgPSBrZXlzW2ldOwogICAgdmFyIHZhbHVlID0gdXBkYXRlc1trZXldOwogICAgaWYgKGtleSA9PSAiJGluYyIpIHsKICAgICAgdmFyIGZpZWxkcyA9IE9iamVjdC5rZXlzKHZhbHVlKTsKICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBmaWVsZHMubGVuZ3RoOyBqKyspIHsKICAgICAgICB2YXIgZmllbGQgPSByZXBsYWNlUG9zaXRpb25hbE9wZXJhdG9yKGZpZWxkc1tqXSwgcG9zaXRpb25hbE1hdGNoSW5mbyk7CiAgICAgICAgdmFyIGFtb3VudCA9IHZhbHVlW2ZpZWxkc1tqXV07CiAgICAgICAgaWYgKGhhc0ZpbHRlcmVkUG9zaXRpb25hbE9wZXJhdG9yKGZpZWxkKSkgewogICAgICAgICAgaWYgKCF1c2VyQXJyYXlGaWx0ZXJzKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiYXJyYXlGaWx0ZXJzIG9wdGlvbiBpcyByZXF1aXJlZCB3aGVuIHVzaW5nIGZpbHRlcmVkIHBvc2l0aW9uYWwgb3BlcmF0b3IgJFs8aWRlbnRpZmllcj5dIik7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBwYXJzZWRQYXRoID0gcGFyc2VGaWVsZFBhdGgoZmllbGQpOwogICAgICAgICAgYXBwbHlUb0ZpbHRlcmVkQXJyYXlFbGVtZW50cyhkb2MsIHBhcnNlZFBhdGgsIGFtb3VudCwgIiRpbmMiLCB1c2VyQXJyYXlGaWx0ZXJzKTsKICAgICAgICB9IGVsc2UgaWYgKGhhc0FsbFBvc2l0aW9uYWwoZmllbGQpKSB7CiAgICAgICAgICBhcHBseVRvQWxsUG9zaXRpb25hbChkb2MsIGZpZWxkLCBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgICAgcmV0dXJuICh2YWwgPT09IHZvaWQgMCA/IDAgOiB2YWwpICsgYW1vdW50OwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBjdXJyZW50VmFsdWUgPSBnZXRQcm9wKGRvYywgZmllbGQpOwogICAgICAgICAgaWYgKGN1cnJlbnRWYWx1ZSA9PSB2b2lkIDApIGN1cnJlbnRWYWx1ZSA9IDA7CiAgICAgICAgICBzZXRQcm9wKGRvYywgZmllbGQsIGN1cnJlbnRWYWx1ZSArIGFtb3VudCk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgaWYgKGtleSA9PSAiJG11bCIpIHsKICAgICAgdmFyIGZpZWxkcyA9IE9iamVjdC5rZXlzKHZhbHVlKTsKICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBmaWVsZHMubGVuZ3RoOyBqKyspIHsKICAgICAgICB2YXIgZmllbGQgPSByZXBsYWNlUG9zaXRpb25hbE9wZXJhdG9yKGZpZWxkc1tqXSwgcG9zaXRpb25hbE1hdGNoSW5mbyk7CiAgICAgICAgdmFyIGFtb3VudCA9IHZhbHVlW2ZpZWxkc1tqXV07CiAgICAgICAgaWYgKGhhc0ZpbHRlcmVkUG9zaXRpb25hbE9wZXJhdG9yKGZpZWxkKSkgewogICAgICAgICAgaWYgKCF1c2VyQXJyYXlGaWx0ZXJzKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiYXJyYXlGaWx0ZXJzIG9wdGlvbiBpcyByZXF1aXJlZCB3aGVuIHVzaW5nIGZpbHRlcmVkIHBvc2l0aW9uYWwgb3BlcmF0b3IgJFs8aWRlbnRpZmllcj5dIik7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBwYXJzZWRQYXRoID0gcGFyc2VGaWVsZFBhdGgoZmllbGQpOwogICAgICAgICAgYXBwbHlUb0ZpbHRlcmVkQXJyYXlFbGVtZW50cyhkb2MsIHBhcnNlZFBhdGgsIGFtb3VudCwgIiRtdWwiLCB1c2VyQXJyYXlGaWx0ZXJzKTsKICAgICAgICB9IGVsc2UgaWYgKGhhc0FsbFBvc2l0aW9uYWwoZmllbGQpKSB7CiAgICAgICAgICBhcHBseVRvQWxsUG9zaXRpb25hbChkb2MsIGZpZWxkLCBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgICAgcmV0dXJuIHZhbCAqIGFtb3VudDsKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgY3VycmVudFZhbHVlID0gZ2V0UHJvcChkb2MsIGZpZWxkKTsKICAgICAgICAgIGlmIChjdXJyZW50VmFsdWUgPT0gdm9pZCAwKSBjdXJyZW50VmFsdWUgPSAwOwogICAgICAgICAgc2V0UHJvcChkb2MsIGZpZWxkLCBjdXJyZW50VmFsdWUgKiBhbW91bnQpOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIGlmIChrZXkgPT0gIiRyZW5hbWUiKSB7CiAgICAgIHZhciBmaWVsZHMgPSBPYmplY3Qua2V5cyh2YWx1ZSk7CiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgZmllbGRzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgdmFyIGZpZWxkID0gcmVwbGFjZVBvc2l0aW9uYWxPcGVyYXRvcihmaWVsZHNbal0sIHBvc2l0aW9uYWxNYXRjaEluZm8pOwogICAgICAgIHZhciBuZXdOYW1lID0gcmVwbGFjZVBvc2l0aW9uYWxPcGVyYXRvcih2YWx1ZVtmaWVsZHNbal1dLCBwb3NpdGlvbmFsTWF0Y2hJbmZvKTsKICAgICAgICBkb2NbbmV3TmFtZV0gPSBkb2NbZmllbGRdOwogICAgICAgIGRlbGV0ZSBkb2NbZmllbGRdOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGtleSA9PSAiJHNldE9uSW5zZXJ0IiAmJiBzZXRPbkluc2VydCkgewogICAgICB2YXIgZmllbGRzID0gT2JqZWN0LmtleXModmFsdWUpOwogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGZpZWxkcy5sZW5ndGg7IGorKykgewogICAgICAgIHZhciBmaWVsZCA9IHJlcGxhY2VQb3NpdGlvbmFsT3BlcmF0b3IoZmllbGRzW2pdLCBwb3NpdGlvbmFsTWF0Y2hJbmZvKTsKICAgICAgICBkb2NbZmllbGRdID0gdmFsdWVbZmllbGRzW2pdXTsKICAgICAgfQogICAgfSBlbHNlIGlmIChrZXkgPT0gIiRzZXQiKSB7CiAgICAgIHZhciBmaWVsZHMgPSBPYmplY3Qua2V5cyh2YWx1ZSk7CiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgZmllbGRzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgdmFyIGZpZWxkID0gcmVwbGFjZVBvc2l0aW9uYWxPcGVyYXRvcihmaWVsZHNbal0sIHBvc2l0aW9uYWxNYXRjaEluZm8pOwogICAgICAgIGlmIChoYXNGaWx0ZXJlZFBvc2l0aW9uYWxPcGVyYXRvcihmaWVsZCkpIHsKICAgICAgICAgIGlmICghdXNlckFycmF5RmlsdGVycykgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImFycmF5RmlsdGVycyBvcHRpb24gaXMgcmVxdWlyZWQgd2hlbiB1c2luZyBmaWx0ZXJlZCBwb3NpdGlvbmFsIG9wZXJhdG9yICRbPGlkZW50aWZpZXI+XSIpOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgcGFyc2VkUGF0aCA9IHBhcnNlRmllbGRQYXRoKGZpZWxkKTsKICAgICAgICAgIGFwcGx5VG9GaWx0ZXJlZEFycmF5RWxlbWVudHMoZG9jLCBwYXJzZWRQYXRoLCB2YWx1ZVtmaWVsZHNbal1dLCAiJHNldCIsIHVzZXJBcnJheUZpbHRlcnMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZXRQcm9wKGRvYywgZmllbGQsIHZhbHVlW2ZpZWxkc1tqXV0pOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIGlmIChrZXkgPT0gIiR1bnNldCIpIHsKICAgICAgdmFyIGZpZWxkcyA9IE9iamVjdC5rZXlzKHZhbHVlKTsKICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBmaWVsZHMubGVuZ3RoOyBqKyspIHsKICAgICAgICB2YXIgZmllbGQgPSByZXBsYWNlUG9zaXRpb25hbE9wZXJhdG9yKGZpZWxkc1tqXSwgcG9zaXRpb25hbE1hdGNoSW5mbyk7CiAgICAgICAgZGVsZXRlIGRvY1tmaWVsZF07CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoa2V5ID09ICIkbWluIikgewogICAgICB2YXIgZmllbGRzID0gT2JqZWN0LmtleXModmFsdWUpOwogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGZpZWxkcy5sZW5ndGg7IGorKykgewogICAgICAgIHZhciBmaWVsZCA9IHJlcGxhY2VQb3NpdGlvbmFsT3BlcmF0b3IoZmllbGRzW2pdLCBwb3NpdGlvbmFsTWF0Y2hJbmZvKTsKICAgICAgICB2YXIgYW1vdW50ID0gdmFsdWVbZmllbGRzW2pdXTsKICAgICAgICBpZiAoaGFzRmlsdGVyZWRQb3NpdGlvbmFsT3BlcmF0b3IoZmllbGQpKSB7CiAgICAgICAgICBpZiAoIXVzZXJBcnJheUZpbHRlcnMpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJhcnJheUZpbHRlcnMgb3B0aW9uIGlzIHJlcXVpcmVkIHdoZW4gdXNpbmcgZmlsdGVyZWQgcG9zaXRpb25hbCBvcGVyYXRvciAkWzxpZGVudGlmaWVyPl0iKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHBhcnNlZFBhdGggPSBwYXJzZUZpZWxkUGF0aChmaWVsZCk7CiAgICAgICAgICBhcHBseVRvRmlsdGVyZWRBcnJheUVsZW1lbnRzKGRvYywgcGFyc2VkUGF0aCwgYW1vdW50LCAiJG1pbiIsIHVzZXJBcnJheUZpbHRlcnMpOwogICAgICAgIH0gZWxzZSBpZiAoaGFzQWxsUG9zaXRpb25hbChmaWVsZCkpIHsKICAgICAgICAgIGFwcGx5VG9BbGxQb3NpdGlvbmFsKGRvYywgZmllbGQsIGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgICByZXR1cm4gTWF0aC5taW4odmFsLCBhbW91bnQpOwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBjdXJyZW50VmFsdWUgPSBnZXRQcm9wKGRvYywgZmllbGQpOwogICAgICAgICAgc2V0UHJvcChkb2MsIGZpZWxkLCBNYXRoLm1pbihjdXJyZW50VmFsdWUsIGFtb3VudCkpOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIGlmIChrZXkgPT0gIiRtYXgiKSB7CiAgICAgIHZhciBmaWVsZHMgPSBPYmplY3Qua2V5cyh2YWx1ZSk7CiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgZmllbGRzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgdmFyIGZpZWxkID0gcmVwbGFjZVBvc2l0aW9uYWxPcGVyYXRvcihmaWVsZHNbal0sIHBvc2l0aW9uYWxNYXRjaEluZm8pOwogICAgICAgIHZhciBhbW91bnQgPSB2YWx1ZVtmaWVsZHNbal1dOwogICAgICAgIGlmIChoYXNGaWx0ZXJlZFBvc2l0aW9uYWxPcGVyYXRvcihmaWVsZCkpIHsKICAgICAgICAgIGlmICghdXNlckFycmF5RmlsdGVycykgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImFycmF5RmlsdGVycyBvcHRpb24gaXMgcmVxdWlyZWQgd2hlbiB1c2luZyBmaWx0ZXJlZCBwb3NpdGlvbmFsIG9wZXJhdG9yICRbPGlkZW50aWZpZXI+XSIpOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgcGFyc2VkUGF0aCA9IHBhcnNlRmllbGRQYXRoKGZpZWxkKTsKICAgICAgICAgIGFwcGx5VG9GaWx0ZXJlZEFycmF5RWxlbWVudHMoZG9jLCBwYXJzZWRQYXRoLCBhbW91bnQsICIkbWF4IiwgdXNlckFycmF5RmlsdGVycyk7CiAgICAgICAgfSBlbHNlIGlmIChoYXNBbGxQb3NpdGlvbmFsKGZpZWxkKSkgewogICAgICAgICAgYXBwbHlUb0FsbFBvc2l0aW9uYWwoZG9jLCBmaWVsZCwgZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgIHJldHVybiBNYXRoLm1heCh2YWwsIGFtb3VudCk7CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGN1cnJlbnRWYWx1ZSA9IGdldFByb3AoZG9jLCBmaWVsZCk7CiAgICAgICAgICBzZXRQcm9wKGRvYywgZmllbGQsIE1hdGgubWF4KGN1cnJlbnRWYWx1ZSwgYW1vdW50KSk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgaWYgKGtleSA9PSAiJGN1cnJlbnREYXRlIikgewogICAgICB2YXIgZmllbGRzID0gT2JqZWN0LmtleXModmFsdWUpOwogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGZpZWxkcy5sZW5ndGg7IGorKykgewogICAgICAgIHZhciBmaWVsZCA9IHJlcGxhY2VQb3NpdGlvbmFsT3BlcmF0b3IoZmllbGRzW2pdLCBwb3NpdGlvbmFsTWF0Y2hJbmZvKTsKICAgICAgICB2YXIgdHlwZVNwZWMgPSB2YWx1ZVtmaWVsZHNbal1dOwogICAgICAgIGlmICh0eXBlU3BlYyA9PT0gdHJ1ZSB8fCB0eXBlb2YgdHlwZVNwZWMgPT09ICJvYmplY3QiICYmIHR5cGVTcGVjLiR0eXBlID09PSAiZGF0ZSIpIHsKICAgICAgICAgIHNldFByb3AoZG9jLCBmaWVsZCwgLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZXRQcm9wKGRvYywgZmllbGQsIC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoa2V5ID09ICIkYWRkVG9TZXQiKSB7CiAgICAgIHZhciBmaWVsZHMgPSBPYmplY3Qua2V5cyh2YWx1ZSk7CiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgZmllbGRzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgdmFyIGZpZWxkID0gcmVwbGFjZVBvc2l0aW9uYWxPcGVyYXRvcihmaWVsZHNbal0sIHBvc2l0aW9uYWxNYXRjaEluZm8pOwogICAgICAgIHZhciBhZGRWYWx1ZSA9IHZhbHVlW2ZpZWxkc1tqXV07CiAgICAgICAgdmFyIGN1cnJlbnRBcnJheSA9IGdldFByb3AoZG9jLCBmaWVsZCk7CiAgICAgICAgaWYgKGN1cnJlbnRBcnJheSAmJiBBcnJheS5pc0FycmF5KGN1cnJlbnRBcnJheSkpIHsKICAgICAgICAgIGN1cnJlbnRBcnJheS5wdXNoKGFkZFZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoa2V5ID09ICIkcG9wIikgewogICAgICB2YXIgZmllbGRzID0gT2JqZWN0LmtleXModmFsdWUpOwogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGZpZWxkcy5sZW5ndGg7IGorKykgewogICAgICAgIHZhciBmaWVsZCA9IHJlcGxhY2VQb3NpdGlvbmFsT3BlcmF0b3IoZmllbGRzW2pdLCBwb3NpdGlvbmFsTWF0Y2hJbmZvKTsKICAgICAgICB2YXIgcG9wVmFsdWUgPSB2YWx1ZVtmaWVsZHNbal1dOwogICAgICAgIHZhciBjdXJyZW50QXJyYXkgPSBnZXRQcm9wKGRvYywgZmllbGQpOwogICAgICAgIGlmIChjdXJyZW50QXJyYXkgJiYgQXJyYXkuaXNBcnJheShjdXJyZW50QXJyYXkpKSB7CiAgICAgICAgICBpZiAocG9wVmFsdWUgPT0gMSkgewogICAgICAgICAgICBjdXJyZW50QXJyYXkucG9wKCk7CiAgICAgICAgICB9IGVsc2UgaWYgKHBvcFZhbHVlID09IC0xKSB7CiAgICAgICAgICAgIGN1cnJlbnRBcnJheS5zaGlmdCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIGlmIChrZXkgPT0gIiRwdWxsIikgewogICAgICB2YXIgZmllbGRzID0gT2JqZWN0LmtleXModmFsdWUpOwogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGZpZWxkcy5sZW5ndGg7IGorKykgewogICAgICAgIHZhciBmaWVsZCA9IHJlcGxhY2VQb3NpdGlvbmFsT3BlcmF0b3IoZmllbGRzW2pdLCBwb3NpdGlvbmFsTWF0Y2hJbmZvKTsKICAgICAgICB2YXIgY29uZGl0aW9uID0gdmFsdWVbZmllbGRzW2pdXTsKICAgICAgICB2YXIgc3JjID0gZ2V0UHJvcChkb2MsIGZpZWxkKTsKICAgICAgICBpZiAoc3JjID09IHZvaWQgMCB8fCAhQXJyYXkuaXNBcnJheShzcmMpKSBjb250aW51ZTsKICAgICAgICB2YXIgbm90UmVtb3ZlZCA9IFtdOwogICAgICAgIGZvciAodmFyIGsgPSAwOyBrIDwgc3JjLmxlbmd0aDsgaysrKSB7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IHNyY1trXTsKICAgICAgICAgIHZhciBzaG91bGRSZW1vdmUgPSBmYWxzZTsKICAgICAgICAgIGlmICh0eXBlb2YgY29uZGl0aW9uID09PSAib2JqZWN0IiAmJiBjb25kaXRpb24gIT09IG51bGwgJiYgIUFycmF5LmlzQXJyYXkoY29uZGl0aW9uKSkgewogICAgICAgICAgICBpZiAodHlwZW9mIGVsZW1lbnQgPT09ICJvYmplY3QiICYmIGVsZW1lbnQgIT09IG51bGwgJiYgIUFycmF5LmlzQXJyYXkoZWxlbWVudCkpIHsKICAgICAgICAgICAgICBzaG91bGRSZW1vdmUgPSBtYXRjaGVzKGVsZW1lbnQsIGNvbmRpdGlvbik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHRlbXBEb2MgPSB7IF9fdGVtcDogZWxlbWVudCB9OwogICAgICAgICAgICAgIHNob3VsZFJlbW92ZSA9IG9wTWF0Y2hlcyh0ZW1wRG9jLCAiX190ZW1wIiwgY29uZGl0aW9uKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2hvdWxkUmVtb3ZlID0gZWxlbWVudCA9PSBjb25kaXRpb247CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXNob3VsZFJlbW92ZSkgbm90UmVtb3ZlZC5wdXNoKGVsZW1lbnQpOwogICAgICAgIH0KICAgICAgICBzZXRQcm9wKGRvYywgZmllbGQsIG5vdFJlbW92ZWQpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGtleSA9PSAiJHB1bGxBbGwiKSB7CiAgICAgIHZhciBmaWVsZHMgPSBPYmplY3Qua2V5cyh2YWx1ZSk7CiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgZmllbGRzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgdmFyIGZpZWxkID0gcmVwbGFjZVBvc2l0aW9uYWxPcGVyYXRvcihmaWVsZHNbal0sIHBvc2l0aW9uYWxNYXRjaEluZm8pOwogICAgICAgIHZhciBzcmMgPSBnZXRQcm9wKGRvYywgZmllbGQpOwogICAgICAgIHZhciB0b1JlbW92ZSA9IHZhbHVlW2ZpZWxkc1tqXV07CiAgICAgICAgdmFyIG5vdFJlbW92ZWQgPSBbXTsKICAgICAgICBmb3IgKHZhciBrID0gMDsgayA8IHNyYy5sZW5ndGg7IGsrKykgewogICAgICAgICAgdmFyIHJlbW92ZWQgPSBmYWxzZTsKICAgICAgICAgIGZvciAodmFyIGwgPSAwOyBsIDwgdG9SZW1vdmUubGVuZ3RoOyBsKyspIHsKICAgICAgICAgICAgaWYgKHNyY1trXSA9PSB0b1JlbW92ZVtsXSkgewogICAgICAgICAgICAgIHJlbW92ZWQgPSB0cnVlOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXJlbW92ZWQpIG5vdFJlbW92ZWQucHVzaChzcmNba10pOwogICAgICAgIH0KICAgICAgICBzZXRQcm9wKGRvYywgZmllbGQsIG5vdFJlbW92ZWQpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGtleSA9PSAiJHB1c2hBbGwiKSB7CiAgICAgIHZhciBmaWVsZHMgPSBPYmplY3Qua2V5cyh2YWx1ZSk7CiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgZmllbGRzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgdmFyIGZpZWxkID0gcmVwbGFjZVBvc2l0aW9uYWxPcGVyYXRvcihmaWVsZHNbal0sIHBvc2l0aW9uYWxNYXRjaEluZm8pOwogICAgICAgIHZhciB2YWx1ZXMgPSB2YWx1ZVtmaWVsZHNbal1dOwogICAgICAgIHZhciBjdXJyZW50QXJyYXkgPSBnZXRQcm9wKGRvYywgZmllbGQpOwogICAgICAgIGlmIChjdXJyZW50QXJyYXkgJiYgQXJyYXkuaXNBcnJheShjdXJyZW50QXJyYXkpKSB7CiAgICAgICAgICBmb3IgKHZhciBrID0gMDsgayA8IHZhbHVlcy5sZW5ndGg7IGsrKykgewogICAgICAgICAgICBjdXJyZW50QXJyYXkucHVzaCh2YWx1ZXNba10pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIGlmIChrZXkgPT0gIiRwdXNoIikgewogICAgICB2YXIgZmllbGRzID0gT2JqZWN0LmtleXModmFsdWUpOwogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGZpZWxkcy5sZW5ndGg7IGorKykgewogICAgICAgIHZhciBmaWVsZCA9IHJlcGxhY2VQb3NpdGlvbmFsT3BlcmF0b3IoZmllbGRzW2pdLCBwb3NpdGlvbmFsTWF0Y2hJbmZvKTsKICAgICAgICB2YXIgcHVzaFZhbHVlID0gdmFsdWVbZmllbGRzW2pdXTsKICAgICAgICB2YXIgaXNNb2RpZmllclB1c2ggPSBwdXNoVmFsdWUgIT09IG51bGwgJiYgdHlwZW9mIHB1c2hWYWx1ZSA9PT0gIm9iamVjdCIgJiYgKHB1c2hWYWx1ZS4kZWFjaCAhPT0gdm9pZCAwIHx8IHB1c2hWYWx1ZS4kcG9zaXRpb24gIT09IHZvaWQgMCB8fCBwdXNoVmFsdWUuJHNsaWNlICE9PSB2b2lkIDAgfHwgcHVzaFZhbHVlLiRzb3J0ICE9PSB2b2lkIDApOwogICAgICAgIGlmIChpc01vZGlmaWVyUHVzaCkgewogICAgICAgICAgdmFyIGN1cnJlbnRBcnJheSA9IGdldFByb3AoZG9jLCBmaWVsZCk7CiAgICAgICAgICBpZiAoIWN1cnJlbnRBcnJheSkgewogICAgICAgICAgICBjdXJyZW50QXJyYXkgPSBbXTsKICAgICAgICAgICAgc2V0UHJvcChkb2MsIGZpZWxkLCBjdXJyZW50QXJyYXkpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHZhbHVlc1RvUHVzaCA9IHB1c2hWYWx1ZS4kZWFjaCAhPT0gdm9pZCAwID8gcHVzaFZhbHVlLiRlYWNoIDogW3B1c2hWYWx1ZV07CiAgICAgICAgICB2YXIgcG9zaXRpb24gPSBwdXNoVmFsdWUuJHBvc2l0aW9uICE9PSB2b2lkIDAgPyBwdXNoVmFsdWUuJHBvc2l0aW9uIDogY3VycmVudEFycmF5Lmxlbmd0aDsKICAgICAgICAgIGlmIChwb3NpdGlvbiA8IDApIHsKICAgICAgICAgICAgcG9zaXRpb24gPSBNYXRoLm1heCgwLCBjdXJyZW50QXJyYXkubGVuZ3RoICsgcG9zaXRpb24pOwogICAgICAgICAgfQogICAgICAgICAgY3VycmVudEFycmF5LnNwbGljZShwb3NpdGlvbiwgMCwgLi4udmFsdWVzVG9QdXNoKTsKICAgICAgICAgIGlmIChwdXNoVmFsdWUuJHNvcnQgIT09IHZvaWQgMCkgewogICAgICAgICAgICB2YXIgc29ydFNwZWMgPSBwdXNoVmFsdWUuJHNvcnQ7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygc29ydFNwZWMgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgY3VycmVudEFycmF5LnNvcnQoZnVuY3Rpb24oYSwgYikgewogICAgICAgICAgICAgICAgaWYgKGEgPCBiKSByZXR1cm4gc29ydFNwZWMgPiAwID8gLTEgOiAxOwogICAgICAgICAgICAgICAgaWYgKGEgPiBiKSByZXR1cm4gc29ydFNwZWMgPiAwID8gMSA6IC0xOwogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHNvcnRTcGVjID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgIGN1cnJlbnRBcnJheS5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICAgICAgICAgIHZhciBzb3J0S2V5cyA9IE9iamVjdC5rZXlzKHNvcnRTcGVjKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGsyID0gMDsgazIgPCBzb3J0S2V5cy5sZW5ndGg7IGsyKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIHNvcnRLZXkgPSBzb3J0S2V5c1trMl07CiAgICAgICAgICAgICAgICAgIHZhciBzb3J0RGlyID0gc29ydFNwZWNbc29ydEtleV07CiAgICAgICAgICAgICAgICAgIHZhciBhVmFsID0gZ2V0UHJvcChhLCBzb3J0S2V5KTsKICAgICAgICAgICAgICAgICAgdmFyIGJWYWwgPSBnZXRQcm9wKGIsIHNvcnRLZXkpOwogICAgICAgICAgICAgICAgICBpZiAoYVZhbCA8IGJWYWwpIHJldHVybiBzb3J0RGlyID4gMCA/IC0xIDogMTsKICAgICAgICAgICAgICAgICAgaWYgKGFWYWwgPiBiVmFsKSByZXR1cm4gc29ydERpciA+IDAgPyAxIDogLTE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHB1c2hWYWx1ZS4kc2xpY2UgIT09IHZvaWQgMCkgewogICAgICAgICAgICB2YXIgc2xpY2VWYWx1ZSA9IHB1c2hWYWx1ZS4kc2xpY2U7CiAgICAgICAgICAgIGlmIChzbGljZVZhbHVlIDwgMCkgewogICAgICAgICAgICAgIHZhciBzbGljZWQgPSBjdXJyZW50QXJyYXkuc2xpY2Uoc2xpY2VWYWx1ZSk7CiAgICAgICAgICAgICAgc2V0UHJvcChkb2MsIGZpZWxkLCBzbGljZWQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHNsaWNlVmFsdWUgPT09IDApIHsKICAgICAgICAgICAgICBzZXRQcm9wKGRvYywgZmllbGQsIFtdKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgc2xpY2VkID0gY3VycmVudEFycmF5LnNsaWNlKDAsIHNsaWNlVmFsdWUpOwogICAgICAgICAgICAgIHNldFByb3AoZG9jLCBmaWVsZCwgc2xpY2VkKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgY3VycmVudEFycmF5ID0gZ2V0UHJvcChkb2MsIGZpZWxkKTsKICAgICAgICAgIGlmIChjdXJyZW50QXJyYXkgJiYgQXJyYXkuaXNBcnJheShjdXJyZW50QXJyYXkpKSB7CiAgICAgICAgICAgIGN1cnJlbnRBcnJheS5wdXNoKHB1c2hWYWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgaWYgKGtleSA9PSAiJGJpdCIpIHsKICAgICAgdmFyIGZpZWxkcyA9IE9iamVjdC5rZXlzKHZhbHVlKTsKICAgICAgdmFyIGZpZWxkID0gcmVwbGFjZVBvc2l0aW9uYWxPcGVyYXRvcihmaWVsZHNbMF0sIHBvc2l0aW9uYWxNYXRjaEluZm8pOwogICAgICB2YXIgb3BlcmF0aW9uID0gdmFsdWVbZmllbGRzWzBdXTsKICAgICAgdmFyIG9wZXJhdG9yID0gT2JqZWN0LmtleXMob3BlcmF0aW9uKVswXTsKICAgICAgdmFyIG9wZXJhbmQgPSBvcGVyYXRpb25bb3BlcmF0b3JdOwogICAgICB2YXIgY3VycmVudFZhbHVlID0gZ2V0UHJvcChkb2MsIGZpZWxkKTsKICAgICAgaWYgKG9wZXJhdG9yID09ICJhbmQiKSB7CiAgICAgICAgc2V0UHJvcChkb2MsIGZpZWxkLCBjdXJyZW50VmFsdWUgJiBvcGVyYW5kKTsKICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAib3IiKSB7CiAgICAgICAgc2V0UHJvcChkb2MsIGZpZWxkLCBjdXJyZW50VmFsdWUgfCBvcGVyYW5kKTsKICAgICAgfSBlbHNlIGlmIChvcGVyYXRvciA9PSAieG9yIikgewogICAgICAgIHNldFByb3AoZG9jLCBmaWVsZCwgY3VycmVudFZhbHVlIF4gb3BlcmFuZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgInVua25vd24gJGJpdCBvcGVyYXRvcjogIiArIG9wZXJhdG9yOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB0aHJvdyAidW5rbm93biB1cGRhdGUgb3BlcmF0b3I6ICIgKyBrZXk7CiAgICB9CiAgfQp9CmZ1bmN0aW9uIGNyZWF0ZURvY0Zyb21VcGRhdGUocXVlcnksIHVwZGF0ZXMsIGlkKSB7CiAgdmFyIG5ld0RvYyA9IHsgX2lkOiBpZCB9OwogIHZhciBvbmx5RmllbGRzID0gdHJ1ZTsKICB2YXIgdXBkYXRlS2V5cyA9IE9iamVjdC5rZXlzKHVwZGF0ZXMpOwogIGZvciAodmFyIGkgPSAwOyBpIDwgdXBkYXRlS2V5cy5sZW5ndGg7IGkrKykgewogICAgaWYgKHVwZGF0ZUtleXNbaV0uY2hhckF0KDApID09ICIkIikgewogICAgICBvbmx5RmllbGRzID0gZmFsc2U7CiAgICAgIGJyZWFrOwogICAgfQogIH0KICBpZiAob25seUZpZWxkcykgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB1cGRhdGVLZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIG5ld0RvY1t1cGRhdGVLZXlzW2ldXSA9IHVwZGF0ZXNbdXBkYXRlS2V5c1tpXV07CiAgICB9CiAgfSBlbHNlIHsKICAgIHZhciBxdWVyeUtleXMgPSBPYmplY3Qua2V5cyhxdWVyeSk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHF1ZXJ5S2V5cy5sZW5ndGg7IGkrKykgewogICAgICBuZXdEb2NbcXVlcnlLZXlzW2ldXSA9IHF1ZXJ5W3F1ZXJ5S2V5c1tpXV07CiAgICB9CiAgICBhcHBseVVwZGF0ZXModXBkYXRlcywgbmV3RG9jLCB0cnVlKTsKICB9CiAgcmV0dXJuIG5ld0RvYzsKfQpjbGFzcyBJbmRleCB7CiAgY29uc3RydWN0b3IobmFtZSwga2V5cywgc3RvcmFnZSwgb3B0aW9ucyA9IHt9KSB7CiAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgdGhpcy5rZXlzID0ga2V5czsKICAgIHRoaXMuc3RvcmFnZSA9IHN0b3JhZ2U7CiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogIH0KICAvKioKICAgKiBBZGQgYSBkb2N1bWVudCB0byB0aGUgaW5kZXgKICAgKiBAcGFyYW0ge09iamVjdH0gZG9jIC0gVGhlIGRvY3VtZW50IHRvIGluZGV4CiAgICovCiAgYWRkKGRvYykgewogICAgdGhyb3cgbmV3IEVycm9yKCJhZGQoKSBtdXN0IGJlIGltcGxlbWVudGVkIGJ5IHN1YmNsYXNzIik7CiAgfQogIC8qKgogICAqIFJlbW92ZSBhIGRvY3VtZW50IGZyb20gdGhlIGluZGV4CiAgICogQHBhcmFtIHtPYmplY3R9IGRvYyAtIFRoZSBkb2N1bWVudCB0byByZW1vdmUKICAgKi8KICByZW1vdmUoZG9jKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoInJlbW92ZSgpIG11c3QgYmUgaW1wbGVtZW50ZWQgYnkgc3ViY2xhc3MiKTsKICB9CiAgLyoqCiAgICogVXBkYXRlIGEgZG9jdW1lbnQgaW4gdGhlIGluZGV4IChyZW1vdmUgb2xkLCBhZGQgbmV3KQogICAqIEBwYXJhbSB7T2JqZWN0fSBvbGREb2MgLSBUaGUgb2xkIGRvY3VtZW50CiAgICogQHBhcmFtIHtPYmplY3R9IG5ld0RvYyAtIFRoZSBuZXcgZG9jdW1lbnQKICAgKi8KICB1cGRhdGUob2xkRG9jLCBuZXdEb2MpIHsKICAgIHRoaXMucmVtb3ZlKG9sZERvYyk7CiAgICB0aGlzLmFkZChuZXdEb2MpOwogIH0KICAvKioKICAgKiBRdWVyeSB0aGUgaW5kZXgKICAgKiBAcGFyYW0geyp9IHF1ZXJ5IC0gVGhlIHF1ZXJ5IHRvIGV4ZWN1dGUKICAgKiBAcmV0dXJucyB7QXJyYXl9IEFycmF5IG9mIGRvY3VtZW50IElEcyBvciBudWxsIGlmIGluZGV4IGNhbm5vdCBzYXRpc2Z5IHF1ZXJ5CiAgICovCiAgcXVlcnkocXVlcnkpIHsKICAgIHRocm93IG5ldyBFcnJvcigicXVlcnkoKSBtdXN0IGJlIGltcGxlbWVudGVkIGJ5IHN1YmNsYXNzIik7CiAgfQogIC8qKgogICAqIENsZWFyIGFsbCBkYXRhIGZyb20gdGhlIGluZGV4CiAgICovCiAgY2xlYXIoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoImNsZWFyKCkgbXVzdCBiZSBpbXBsZW1lbnRlZCBieSBzdWJjbGFzcyIpOwogIH0KICAvKioKICAgKiBHZXQgaW5kZXggc3BlY2lmaWNhdGlvbiAoZm9yIGdldEluZGV4ZXMoKSkKICAgKi8KICBnZXRTcGVjKCkgewogICAgcmV0dXJuIHsKICAgICAgbmFtZTogdGhpcy5uYW1lLAogICAgICBrZXk6IHRoaXMua2V5cwogICAgfTsKICB9Cn0KY29uc3QgVkVSU0lPTl9NRVRBREFUQV9TVUZGSVggPSAiLnZlcnNpb24uanNvbiI7CmNvbnN0IFZFUlNJT05fU1VGRklYID0gIi52IjsKY29uc3QgREVGQVVMVF9DT01QQUNUSU9OX01JTl9CWVRFUyA9IDE2ICogMTAyNDsKZnVuY3Rpb24gYnVpbGRWZXJzaW9uZWRQYXRoKGJhc2VQYXRoLCB2ZXJzaW9uKSB7CiAgY29uc3QgbnVtZXJpY1ZlcnNpb24gPSBOdW1iZXIodmVyc2lvbik7CiAgaWYgKCFOdW1iZXIuaXNGaW5pdGUobnVtZXJpY1ZlcnNpb24pKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgdmVyc2lvbiB2YWx1ZTogJHt2ZXJzaW9ufWApOwogIH0KICBpZiAobnVtZXJpY1ZlcnNpb24gPCAwKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoYFZlcnNpb24gbXVzdCBiZSBub24tbmVnYXRpdmU6ICR7bnVtZXJpY1ZlcnNpb259YCk7CiAgfQogIGlmIChudW1lcmljVmVyc2lvbiA9PT0gMCkgewogICAgcmV0dXJuIGJhc2VQYXRoOwogIH0KICByZXR1cm4gYCR7YmFzZVBhdGh9JHtWRVJTSU9OX1NVRkZJWH0ke251bWVyaWNWZXJzaW9ufWA7Cn0KZnVuY3Rpb24gbm9ybWFsaXplTWV0YWRhdGEoZGF0YSkgewogIGNvbnN0IG1ldGFkYXRhID0geyBjdXJyZW50VmVyc2lvbjogMCwgcmVmQ291bnRzOiB7fSB9OwogIGlmICghZGF0YSB8fCB0eXBlb2YgZGF0YSAhPT0gIm9iamVjdCIpIHJldHVybiBtZXRhZGF0YTsKICBjb25zdCB2ZXJzaW9uID0gTnVtYmVyKGRhdGEuY3VycmVudFZlcnNpb24pOwogIG1ldGFkYXRhLmN1cnJlbnRWZXJzaW9uID0gTnVtYmVyLmlzRmluaXRlKHZlcnNpb24pID8gdmVyc2lvbiA6IDA7CiAgaWYgKGRhdGEucmVmQ291bnRzICYmIHR5cGVvZiBkYXRhLnJlZkNvdW50cyA9PT0gIm9iamVjdCIpIHsKICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKGRhdGEucmVmQ291bnRzKSkgewogICAgICBjb25zdCBjb3VudCA9IE51bWJlcih2YWx1ZSk7CiAgICAgIGlmIChOdW1iZXIuaXNGaW5pdGUoY291bnQpICYmIGNvdW50ID4gMCkgewogICAgICAgIG1ldGFkYXRhLnJlZkNvdW50c1tTdHJpbmcoa2V5KV0gPSBjb3VudDsKICAgICAgfSBlbHNlIGlmICghTnVtYmVyLmlzRmluaXRlKGNvdW50KSB8fCBjb3VudCA8IDApIHsKICAgICAgICBjb25zb2xlLndhcm4oYElnbm9yaW5nIGludmFsaWQgcmVmIGNvdW50IGZvciB2ZXJzaW9uICR7a2V5fTogJHt2YWx1ZX1gKTsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gbWV0YWRhdGE7Cn0KZnVuY3Rpb24gc3BsaXRQYXRoKGZpbGVQYXRoKSB7CiAgY29uc3QgcGFydHMgPSBmaWxlUGF0aC5zcGxpdCgiLyIpLmZpbHRlcihCb29sZWFuKTsKICBjb25zdCBmaWxlbmFtZSA9IHBhcnRzLnBvcCgpOwogIGlmICghZmlsZW5hbWUpIHsKICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBzdG9yYWdlIHBhdGg6ICR7ZmlsZVBhdGh9YCk7CiAgfQogIHJldHVybiB7IHBhcnRzLCBmaWxlbmFtZSB9Owp9CmFzeW5jIGZ1bmN0aW9uIGdldERpcmVjdG9yeUhhbmRsZShwYXRoUGFydHMsIGNyZWF0ZSkgewogIGxldCBkaXIgPSBhd2FpdCBnbG9iYWxUaGlzLm5hdmlnYXRvci5zdG9yYWdlLmdldERpcmVjdG9yeSgpOwogIGZvciAoY29uc3QgcGFydCBvZiBwYXRoUGFydHMpIHsKICAgIGRpciA9IGF3YWl0IGRpci5nZXREaXJlY3RvcnlIYW5kbGUocGFydCwgeyBjcmVhdGUgfSk7CiAgfQogIHJldHVybiBkaXI7Cn0KYXN5bmMgZnVuY3Rpb24gZW5zdXJlRGlyZWN0b3J5Rm9yRmlsZShmaWxlUGF0aCkgewogIGNvbnN0IHsgcGFydHMgfSA9IHNwbGl0UGF0aChmaWxlUGF0aCk7CiAgaWYgKHBhcnRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwogIGF3YWl0IGdldERpcmVjdG9yeUhhbmRsZShwYXJ0cywgdHJ1ZSk7Cn0KYXN5bmMgZnVuY3Rpb24gZ2V0RmlsZUhhbmRsZShmaWxlUGF0aCwgeyBjcmVhdGUgfSA9IHt9KSB7CiAgY29uc3QgeyBwYXJ0cywgZmlsZW5hbWUgfSA9IHNwbGl0UGF0aChmaWxlUGF0aCk7CiAgY29uc3QgZGlyID0gYXdhaXQgZ2V0RGlyZWN0b3J5SGFuZGxlKHBhcnRzLCAhIWNyZWF0ZSk7CiAgcmV0dXJuIGRpci5nZXRGaWxlSGFuZGxlKGZpbGVuYW1lLCB7IGNyZWF0ZSB9KTsKfQphc3luYyBmdW5jdGlvbiByZWFkTWV0YWRhdGEoYmFzZVBhdGgpIHsKICBjb25zdCBtZXRhZGF0YVBhdGggPSBgJHtiYXNlUGF0aH0ke1ZFUlNJT05fTUVUQURBVEFfU1VGRklYfWA7CiAgdHJ5IHsKICAgIGNvbnN0IGZpbGVIYW5kbGUgPSBhd2FpdCBnZXRGaWxlSGFuZGxlKG1ldGFkYXRhUGF0aCwgeyBjcmVhdGU6IGZhbHNlIH0pOwogICAgY29uc3QgZmlsZSA9IGF3YWl0IGZpbGVIYW5kbGUuZ2V0RmlsZSgpOwogICAgY29uc3QgdGV4dDIgPSBhd2FpdCBmaWxlLnRleHQoKTsKICAgIGlmICghdGV4dDIgfHwgdGV4dDIudHJpbSgpID09PSAiIikgewogICAgICByZXR1cm4gbm9ybWFsaXplTWV0YWRhdGEoKTsKICAgIH0KICAgIHJldHVybiBub3JtYWxpemVNZXRhZGF0YShKU09OLnBhcnNlKHRleHQyKSk7CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGlmIChlcnJvcj8ubmFtZSA9PT0gIk5vdEZvdW5kRXJyb3IiIHx8IGVycm9yPy5jb2RlID09PSAiRU5PRU5UIikgewogICAgICByZXR1cm4gbm9ybWFsaXplTWV0YWRhdGEoKTsKICAgIH0KICAgIHRocm93IGVycm9yOwogIH0KfQphc3luYyBmdW5jdGlvbiB3cml0ZU1ldGFkYXRhKGJhc2VQYXRoLCBtZXRhZGF0YSkgewogIGNvbnN0IG1ldGFkYXRhUGF0aCA9IGAke2Jhc2VQYXRofSR7VkVSU0lPTl9NRVRBREFUQV9TVUZGSVh9YDsKICBhd2FpdCBlbnN1cmVEaXJlY3RvcnlGb3JGaWxlKG1ldGFkYXRhUGF0aCk7CiAgY29uc3QgZmlsZUhhbmRsZSA9IGF3YWl0IGdldEZpbGVIYW5kbGUobWV0YWRhdGFQYXRoLCB7IGNyZWF0ZTogdHJ1ZSB9KTsKICBjb25zdCB3cml0YWJsZSA9IGF3YWl0IGZpbGVIYW5kbGUuY3JlYXRlV3JpdGFibGUoKTsKICBhd2FpdCB3cml0YWJsZS53cml0ZShKU09OLnN0cmluZ2lmeShtZXRhZGF0YSkpOwogIGF3YWl0IHdyaXRhYmxlLmNsb3NlKCk7Cn0KYXN5bmMgZnVuY3Rpb24gZGVsZXRlVmVyc2lvbmVkRmlsZXMoYmFzZVBhdGgsIHZlcnNpb24sIHN1ZmZpeGVzKSB7CiAgY29uc3QgdmVyc2lvbmVkQmFzZSA9IGJ1aWxkVmVyc2lvbmVkUGF0aChiYXNlUGF0aCwgdmVyc2lvbik7CiAgZm9yIChjb25zdCBzdWZmaXggb2Ygc3VmZml4ZXMpIHsKICAgIGNvbnN0IGZpbGVQYXRoID0gc3VmZml4ID8gYCR7dmVyc2lvbmVkQmFzZX0ke3N1ZmZpeH1gIDogdmVyc2lvbmVkQmFzZTsKICAgIGF3YWl0IHJlbW92ZUZpbGUoZmlsZVBhdGgpOwogIH0KfQphc3luYyBmdW5jdGlvbiBjbGVhbnVwVmVyc2lvbklmVW5yZWZlcmVuY2VkKGJhc2VQYXRoLCB2ZXJzaW9uLCBtZXRhZGF0YSwgc3VmZml4ZXMpIHsKICBpZiAodmVyc2lvbiA9PT0gbWV0YWRhdGEuY3VycmVudFZlcnNpb24pIHJldHVybjsKICBjb25zdCBrZXkgPSBTdHJpbmcodmVyc2lvbik7CiAgaWYgKG1ldGFkYXRhLnJlZkNvdW50c1trZXldKSByZXR1cm47CiAgYXdhaXQgZGVsZXRlVmVyc2lvbmVkRmlsZXMoYmFzZVBhdGgsIHZlcnNpb24sIHN1ZmZpeGVzKTsKfQphc3luYyBmdW5jdGlvbiBhY3F1aXJlVmVyc2lvbmVkUGF0aChiYXNlUGF0aCkgewogIGNvbnN0IG1ldGFkYXRhID0gYXdhaXQgcmVhZE1ldGFkYXRhKGJhc2VQYXRoKTsKICBjb25zdCBjdXJyZW50VmVyc2lvbiA9IG1ldGFkYXRhLmN1cnJlbnRWZXJzaW9uOwogIGNvbnN0IGtleSA9IFN0cmluZyhjdXJyZW50VmVyc2lvbik7CiAgbWV0YWRhdGEucmVmQ291bnRzW2tleV0gPSAobWV0YWRhdGEucmVmQ291bnRzW2tleV0gfHwgMCkgKyAxOwogIGF3YWl0IHdyaXRlTWV0YWRhdGEoYmFzZVBhdGgsIG1ldGFkYXRhKTsKICByZXR1cm4gewogICAgdmVyc2lvbjogY3VycmVudFZlcnNpb24sCiAgICBwYXRoOiBidWlsZFZlcnNpb25lZFBhdGgoYmFzZVBhdGgsIGN1cnJlbnRWZXJzaW9uKQogIH07Cn0KYXN5bmMgZnVuY3Rpb24gcmVsZWFzZVZlcnNpb25lZFBhdGgoYmFzZVBhdGgsIHZlcnNpb24sIHsgc3VmZml4ZXMgPSBbIiJdIH0gPSB7fSkgewogIGNvbnN0IG1ldGFkYXRhID0gYXdhaXQgcmVhZE1ldGFkYXRhKGJhc2VQYXRoKTsKICBjb25zdCBrZXkgPSBTdHJpbmcodmVyc2lvbik7CiAgaWYgKG1ldGFkYXRhLnJlZkNvdW50c1trZXldKSB7CiAgICBtZXRhZGF0YS5yZWZDb3VudHNba2V5XSAtPSAxOwogICAgaWYgKG1ldGFkYXRhLnJlZkNvdW50c1trZXldIDw9IDApIHsKICAgICAgZGVsZXRlIG1ldGFkYXRhLnJlZkNvdW50c1trZXldOwogICAgfQogIH0KICBhd2FpdCBjbGVhbnVwVmVyc2lvbklmVW5yZWZlcmVuY2VkKGJhc2VQYXRoLCB2ZXJzaW9uLCBtZXRhZGF0YSwgc3VmZml4ZXMpOwogIGF3YWl0IHdyaXRlTWV0YWRhdGEoYmFzZVBhdGgsIG1ldGFkYXRhKTsKfQphc3luYyBmdW5jdGlvbiBwcm9tb3RlVmVyc2lvbihiYXNlUGF0aCwgbmV3VmVyc2lvbiwgb2xkVmVyc2lvbiwgeyBzdWZmaXhlcyA9IFsiIl0gfSA9IHt9KSB7CiAgY29uc3QgbWV0YWRhdGEgPSBhd2FpdCByZWFkTWV0YWRhdGEoYmFzZVBhdGgpOwogIGNvbnN0IG5leHRWZXJzaW9uID0gTnVtYmVyKG5ld1ZlcnNpb24pOwogIG1ldGFkYXRhLmN1cnJlbnRWZXJzaW9uID0gTnVtYmVyLmlzRmluaXRlKG5leHRWZXJzaW9uKSA/IG5leHRWZXJzaW9uIDogbWV0YWRhdGEuY3VycmVudFZlcnNpb247CiAgY29uc3Qga2V5ID0gU3RyaW5nKG1ldGFkYXRhLmN1cnJlbnRWZXJzaW9uKTsKICBpZiAoIW1ldGFkYXRhLnJlZkNvdW50c1trZXldKSB7CiAgICBtZXRhZGF0YS5yZWZDb3VudHNba2V5XSA9IDA7CiAgfQogIGF3YWl0IGNsZWFudXBWZXJzaW9uSWZVbnJlZmVyZW5jZWQoYmFzZVBhdGgsIG9sZFZlcnNpb24sIG1ldGFkYXRhLCBzdWZmaXhlcyk7CiAgYXdhaXQgd3JpdGVNZXRhZGF0YShiYXNlUGF0aCwgbWV0YWRhdGEpOwp9CmFzeW5jIGZ1bmN0aW9uIGdldEN1cnJlbnRWZXJzaW9uKGJhc2VQYXRoKSB7CiAgY29uc3QgbWV0YWRhdGEgPSBhd2FpdCByZWFkTWV0YWRhdGEoYmFzZVBhdGgpOwogIHJldHVybiBtZXRhZGF0YS5jdXJyZW50VmVyc2lvbjsKfQphc3luYyBmdW5jdGlvbiByZW1vdmVGaWxlKGZpbGVQYXRoKSB7CiAgdHJ5IHsKICAgIGNvbnN0IHsgcGFydHMsIGZpbGVuYW1lIH0gPSBzcGxpdFBhdGgoZmlsZVBhdGgpOwogICAgY29uc3QgZGlyID0gYXdhaXQgZ2V0RGlyZWN0b3J5SGFuZGxlKHBhcnRzLCBmYWxzZSk7CiAgICBhd2FpdCBkaXIucmVtb3ZlRW50cnkoZmlsZW5hbWUpOwogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICBpZiAoZXJyb3I/Lm5hbWUgPT09ICJOb3RGb3VuZEVycm9yIiB8fCBlcnJvcj8uY29kZSA9PT0gIkVOT0VOVCIpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhyb3cgZXJyb3I7CiAgfQp9CmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVN5bmNBY2Nlc3NIYW5kbGUoZmlsZVBhdGgsIHsgcmVzZXQgPSBmYWxzZSB9ID0ge30pIHsKICBpZiAocmVzZXQpIHsKICAgIGF3YWl0IHJlbW92ZUZpbGUoZmlsZVBhdGgpOwogIH0KICBhd2FpdCBlbnN1cmVEaXJlY3RvcnlGb3JGaWxlKGZpbGVQYXRoKTsKICBjb25zdCBmaWxlSGFuZGxlID0gYXdhaXQgZ2V0RmlsZUhhbmRsZShmaWxlUGF0aCwgeyBjcmVhdGU6IHRydWUgfSk7CiAgcmV0dXJuIGZpbGVIYW5kbGUuY3JlYXRlU3luY0FjY2Vzc0hhbmRsZSgpOwp9CmNsYXNzIFJlZ3VsYXJDb2xsZWN0aW9uSW5kZXggZXh0ZW5kcyBJbmRleCB7CiAgY29uc3RydWN0b3IobmFtZSwga2V5cywgc3RvcmFnZUZpbGVQYXRoLCBvcHRpb25zID0ge30pIHsKICAgIHN1cGVyKG5hbWUsIGtleXMsIHN0b3JhZ2VGaWxlUGF0aCwgb3B0aW9ucyk7CiAgICB0aGlzLnN0b3JhZ2VGaWxlUGF0aCA9IHN0b3JhZ2VGaWxlUGF0aDsKICAgIHRoaXMuc3RvcmFnZVZlcnNpb25lZFBhdGggPSBudWxsOwogICAgdGhpcy5zdG9yYWdlVmVyc2lvbiA9IDA7CiAgICB0aGlzLl9yZWxlYXNlU3RvcmFnZSA9IG51bGw7CiAgICB0aGlzLmRhdGEgPSBudWxsOwogICAgdGhpcy5zeW5jSGFuZGxlID0gbnVsbDsKICAgIHRoaXMuaXNPcGVuID0gZmFsc2U7CiAgfQogIC8qKgogICAqIE9wZW4gdGhlIGluZGV4IGZpbGUKICAgKiBNdXN0IGJlIGNhbGxlZCBiZWZvcmUgdXNpbmcgdGhlIGluZGV4CiAgICovCiAgYXN5bmMgb3BlbigpIHsKICAgIGlmICh0aGlzLmlzT3BlbikgewogICAgICByZXR1cm47CiAgICB9CiAgICB0cnkgewogICAgICBjb25zdCB7IHZlcnNpb24sIHBhdGg6IHZlcnNpb25lZFBhdGggfSA9IGF3YWl0IGFjcXVpcmVWZXJzaW9uZWRQYXRoKHRoaXMuc3RvcmFnZUZpbGVQYXRoKTsKICAgICAgdGhpcy5zdG9yYWdlVmVyc2lvbiA9IHZlcnNpb247CiAgICAgIHRoaXMuc3RvcmFnZVZlcnNpb25lZFBhdGggPSB2ZXJzaW9uZWRQYXRoOwogICAgICB0aGlzLl9yZWxlYXNlU3RvcmFnZSA9ICgpID0+IHJlbGVhc2VWZXJzaW9uZWRQYXRoKHRoaXMuc3RvcmFnZUZpbGVQYXRoLCB2ZXJzaW9uKTsKICAgICAgY29uc3QgcGF0aFBhcnRzID0gdGhpcy5zdG9yYWdlVmVyc2lvbmVkUGF0aC5zcGxpdCgiLyIpLmZpbHRlcihCb29sZWFuKTsKICAgICAgY29uc3QgZmlsZW5hbWUgPSBwYXRoUGFydHMucG9wKCk7CiAgICAgIGlmICghZmlsZW5hbWUpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgc3RvcmFnZSBwYXRoOiAke3RoaXMuc3RvcmFnZVZlcnNpb25lZFBhdGh9YCk7CiAgICAgIH0KICAgICAgbGV0IGRpckhhbmRsZSA9IGF3YWl0IGdsb2JhbFRoaXMubmF2aWdhdG9yLnN0b3JhZ2UuZ2V0RGlyZWN0b3J5KCk7CiAgICAgIGZvciAoY29uc3QgcGFydCBvZiBwYXRoUGFydHMpIHsKICAgICAgICBkaXJIYW5kbGUgPSBhd2FpdCBkaXJIYW5kbGUuZ2V0RGlyZWN0b3J5SGFuZGxlKHBhcnQsIHsgY3JlYXRlOiB0cnVlIH0pOwogICAgICB9CiAgICAgIGNvbnN0IGZpbGVIYW5kbGUgPSBhd2FpdCBkaXJIYW5kbGUuZ2V0RmlsZUhhbmRsZShmaWxlbmFtZSwgeyBjcmVhdGU6IHRydWUgfSk7CiAgICAgIHRoaXMuc3luY0hhbmRsZSA9IGF3YWl0IGZpbGVIYW5kbGUuY3JlYXRlU3luY0FjY2Vzc0hhbmRsZSgpOwogICAgICB0aGlzLmRhdGEgPSBuZXcgQlBsdXNUcmVlKHRoaXMuc3luY0hhbmRsZSwgNTApOwogICAgICBhd2FpdCB0aGlzLmRhdGEub3BlbigpOwogICAgICB0aGlzLmlzT3BlbiA9IHRydWU7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoZXJyb3IubWVzc2FnZSAmJiAoZXJyb3IubWVzc2FnZS5pbmNsdWRlcygiVW5rbm93biB0eXBlIGJ5dGUiKSB8fCBlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCJGYWlsZWQgdG8gcmVhZCBtZXRhZGF0YSIpIHx8IGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoIkludmFsaWQgdHJlZSBmaWxlIikpKSB7CiAgICAgICAgaWYgKHRoaXMuc3luY0hhbmRsZSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgdGhpcy5zeW5jSGFuZGxlLmNsb3NlKCk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLnN5bmNIYW5kbGUgPSBudWxsOwogICAgICAgIH0KICAgICAgICBjb25zdCBwYXRoUGFydHMgPSB0aGlzLnN0b3JhZ2VWZXJzaW9uZWRQYXRoLnNwbGl0KCIvIikuZmlsdGVyKEJvb2xlYW4pOwogICAgICAgIGNvbnN0IGZpbGVuYW1lID0gcGF0aFBhcnRzLnBvcCgpOwogICAgICAgIGlmICghZmlsZW5hbWUpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBzdG9yYWdlIHBhdGg6ICR7dGhpcy5zdG9yYWdlVmVyc2lvbmVkUGF0aH1gKTsKICAgICAgICB9CiAgICAgICAgbGV0IGRpckhhbmRsZSA9IGF3YWl0IGdsb2JhbFRoaXMubmF2aWdhdG9yLnN0b3JhZ2UuZ2V0RGlyZWN0b3J5KCk7CiAgICAgICAgZm9yIChjb25zdCBwYXJ0IG9mIHBhdGhQYXJ0cykgewogICAgICAgICAgZGlySGFuZGxlID0gYXdhaXQgZGlySGFuZGxlLmdldERpcmVjdG9yeUhhbmRsZShwYXJ0LCB7IGNyZWF0ZTogdHJ1ZSB9KTsKICAgICAgICB9CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGF3YWl0IGRpckhhbmRsZS5yZW1vdmVFbnRyeShmaWxlbmFtZSk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIH0KICAgICAgICBjb25zdCBmaWxlSGFuZGxlID0gYXdhaXQgZGlySGFuZGxlLmdldEZpbGVIYW5kbGUoZmlsZW5hbWUsIHsgY3JlYXRlOiB0cnVlIH0pOwogICAgICAgIHRoaXMuc3luY0hhbmRsZSA9IGF3YWl0IGZpbGVIYW5kbGUuY3JlYXRlU3luY0FjY2Vzc0hhbmRsZSgpOwogICAgICAgIHRoaXMuZGF0YSA9IG5ldyBCUGx1c1RyZWUodGhpcy5zeW5jSGFuZGxlLCA1MCk7CiAgICAgICAgYXdhaXQgdGhpcy5kYXRhLm9wZW4oKTsKICAgICAgICB0aGlzLmlzT3BlbiA9IHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgIH0KICAgIH0KICB9CiAgLyoqCiAgICogQ2xvc2UgdGhlIGluZGV4IGZpbGUKICAgKi8KICBhc3luYyBjbG9zZSgpIHsKICAgIGlmICghdGhpcy5pc09wZW4pIHsKICAgICAgaWYgKHRoaXMuX3JlbGVhc2VTdG9yYWdlKSB7CiAgICAgICAgYXdhaXQgdGhpcy5fcmVsZWFzZVN0b3JhZ2UoKTsKICAgICAgICB0aGlzLl9yZWxlYXNlU3RvcmFnZSA9IG51bGw7CiAgICAgIH0KICAgICAgcmV0dXJuOwogICAgfQogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5fbWF5YmVDb21wYWN0KCk7CiAgICAgIGF3YWl0IHRoaXMuZGF0YS5jbG9zZSgpOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKCFlcnJvci5tZXNzYWdlIHx8ICFlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCJGaWxlIGlzIG5vdCBvcGVuIikpIHsKICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgfQogICAgfQogICAgdGhpcy5pc09wZW4gPSBmYWxzZTsKICAgIGlmICh0aGlzLl9yZWxlYXNlU3RvcmFnZSkgewogICAgICBhd2FpdCB0aGlzLl9yZWxlYXNlU3RvcmFnZSgpOwogICAgICB0aGlzLl9yZWxlYXNlU3RvcmFnZSA9IG51bGw7CiAgICB9CiAgfQogIGFzeW5jIF9tYXliZUNvbXBhY3QoKSB7CiAgICBpZiAoIXRoaXMuZGF0YSB8fCAhdGhpcy5kYXRhLmZpbGUpIHJldHVybjsKICAgIGNvbnN0IGN1cnJlbnRWZXJzaW9uID0gYXdhaXQgZ2V0Q3VycmVudFZlcnNpb24odGhpcy5zdG9yYWdlRmlsZVBhdGgpOwogICAgaWYgKGN1cnJlbnRWZXJzaW9uICE9PSB0aGlzLnN0b3JhZ2VWZXJzaW9uKSByZXR1cm47CiAgICBjb25zdCBmaWxlU2l6ZSA9IHRoaXMuZGF0YS5maWxlLmdldEZpbGVTaXplKCk7CiAgICBpZiAoIWZpbGVTaXplIHx8IGZpbGVTaXplIDwgREVGQVVMVF9DT01QQUNUSU9OX01JTl9CWVRFUykgcmV0dXJuOwogICAgY29uc3QgbmV4dFZlcnNpb24gPSBjdXJyZW50VmVyc2lvbiArIDE7CiAgICBjb25zdCBjb21wYWN0UGF0aCA9IGJ1aWxkVmVyc2lvbmVkUGF0aCh0aGlzLnN0b3JhZ2VGaWxlUGF0aCwgbmV4dFZlcnNpb24pOwogICAgY29uc3QgZGVzdFN5bmNIYW5kbGUgPSBhd2FpdCBjcmVhdGVTeW5jQWNjZXNzSGFuZGxlKGNvbXBhY3RQYXRoLCB7IHJlc2V0OiB0cnVlIH0pOwogICAgYXdhaXQgdGhpcy5kYXRhLmNvbXBhY3QoZGVzdFN5bmNIYW5kbGUpOwogICAgYXdhaXQgcHJvbW90ZVZlcnNpb24odGhpcy5zdG9yYWdlRmlsZVBhdGgsIG5leHRWZXJzaW9uLCBjdXJyZW50VmVyc2lvbik7CiAgfQogIC8qKgogICAqIEV4dHJhY3QgaW5kZXgga2V5IHZhbHVlIGZyb20gYSBkb2N1bWVudAogICAqLwogIGV4dHJhY3RJbmRleEtleShkb2MpIHsKICAgIGNvbnN0IGtleUZpZWxkcyA9IE9iamVjdC5rZXlzKHRoaXMua2V5cyk7CiAgICBpZiAoa2V5RmllbGRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIG51bGw7CiAgICBpZiAoa2V5RmllbGRzLmxlbmd0aCA9PT0gMSkgewogICAgICBjb25zdCBmaWVsZCA9IGtleUZpZWxkc1swXTsKICAgICAgY29uc3QgdmFsdWUgPSBnZXRQcm9wKGRvYywgZmllbGQpOwogICAgICBpZiAodmFsdWUgPT09IHZvaWQgMCkgcmV0dXJuIG51bGw7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICAgIGNvbnN0IGtleVBhcnRzID0gW107CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleUZpZWxkcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCB2YWx1ZSA9IGdldFByb3AoZG9jLCBrZXlGaWVsZHNbaV0pOwogICAgICBpZiAodmFsdWUgPT09IHZvaWQgMCkgcmV0dXJuIG51bGw7CiAgICAgIGtleVBhcnRzLnB1c2goCiAgICAgICAgdmFsdWUKICAgICAgICAvKkpTT04uc3RyaW5naWZ5KHZhbHVlKSAqLwogICAgICApOwogICAgfQogICAgcmV0dXJuIGtleVBhcnRzLmpvaW4oIlwwIik7CiAgfQogIC8qKgogICAqIEFkZCBhIGRvY3VtZW50IHRvIHRoZSBpbmRleAogICAgKiAKICAgKiBAcGFyYW0ge09iamVjdH0gZG9jIC0gVGhlIGRvY3VtZW50IHRvIGluZGV4CiAgICovCiAgYXN5bmMgYWRkKGRvYykgewogICAgaWYgKCF0aGlzLmlzT3BlbikgewogICAgICBhd2FpdCB0aGlzLm9wZW4oKTsKICAgIH0KICAgIGNvbnN0IGluZGV4S2V5ID0gdGhpcy5leHRyYWN0SW5kZXhLZXkoZG9jKTsKICAgIGlmIChpbmRleEtleSAhPT0gbnVsbCkgewogICAgICBjb25zdCBkb2NJZCA9IGRvYy5faWQudG9TdHJpbmcoKTsKICAgICAgY29uc3QgZXhpc3RpbmcgPSBhd2FpdCB0aGlzLmRhdGEuc2VhcmNoKGluZGV4S2V5KTsKICAgICAgbGV0IGRvY0lkczsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZXhpc3RpbmcpKSB7CiAgICAgICAgaWYgKCFleGlzdGluZy5pbmNsdWRlcyhkb2NJZCkpIHsKICAgICAgICAgIGRvY0lkcyA9IFsuLi5leGlzdGluZywgZG9jSWRdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGV4aXN0aW5nKSB7CiAgICAgICAgZG9jSWRzID0gZXhpc3RpbmcgPT09IGRvY0lkID8gW2V4aXN0aW5nXSA6IFtleGlzdGluZywgZG9jSWRdOwogICAgICB9IGVsc2UgewogICAgICAgIGRvY0lkcyA9IFtkb2NJZF07CiAgICAgIH0KICAgICAgYXdhaXQgdGhpcy5kYXRhLmFkZChpbmRleEtleSwgZG9jSWRzKTsKICAgIH0KICB9CiAgLyoqCiAgICogUmVtb3ZlIGEgZG9jdW1lbnQgZnJvbSB0aGUgaW5kZXgKICAgICogCiAgICogQHBhcmFtIHtPYmplY3R9IGRvYyAtIFRoZSBkb2N1bWVudCB0byByZW1vdmUKICAgKi8KICBhc3luYyByZW1vdmUoZG9jKSB7CiAgICBpZiAoIXRoaXMuaXNPcGVuKSB7CiAgICAgIGF3YWl0IHRoaXMub3BlbigpOwogICAgfQogICAgY29uc3QgaW5kZXhLZXkgPSB0aGlzLmV4dHJhY3RJbmRleEtleShkb2MpOwogICAgaWYgKGluZGV4S2V5ICE9PSBudWxsKSB7CiAgICAgIGNvbnN0IGRvY0lkID0gZG9jLl9pZC50b1N0cmluZygpOwogICAgICBjb25zdCBleGlzdGluZyA9IGF3YWl0IHRoaXMuZGF0YS5zZWFyY2goaW5kZXhLZXkpOwogICAgICBpZiAoQXJyYXkuaXNBcnJheShleGlzdGluZykpIHsKICAgICAgICBjb25zdCBmaWx0ZXJlZCA9IGV4aXN0aW5nLmZpbHRlcigoaWQpID0+IGlkICE9PSBkb2NJZCk7CiAgICAgICAgaWYgKGZpbHRlcmVkLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGF3YWl0IHRoaXMuZGF0YS5hZGQoaW5kZXhLZXksIGZpbHRlcmVkKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYXdhaXQgdGhpcy5kYXRhLmRlbGV0ZShpbmRleEtleSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGV4aXN0aW5nID09PSBkb2NJZCkgewogICAgICAgIGF3YWl0IHRoaXMuZGF0YS5kZWxldGUoaW5kZXhLZXkpOwogICAgICB9CiAgICB9CiAgfQogIC8qKgogICAqIFF1ZXJ5IHRoZSBpbmRleAogICAgKiAKICAgKiBAcGFyYW0geyp9IHF1ZXJ5IC0gVGhlIHF1ZXJ5IG9iamVjdAogICAqIEByZXR1cm5zIHtQcm9taXNlPEFycmF5fG51bGw+fSBBcnJheSBvZiBkb2N1bWVudCBJRHMgb3IgbnVsbCBpZiBpbmRleCBjYW5ub3Qgc2F0aXNmeSBxdWVyeQogICAqLwogIGFzeW5jIHF1ZXJ5KHF1ZXJ5KSB7CiAgICBjb25zdCBxdWVyeUtleXMgPSBPYmplY3Qua2V5cyhxdWVyeSk7CiAgICBjb25zdCBpbmRleEZpZWxkcyA9IE9iamVjdC5rZXlzKHRoaXMua2V5cyk7CiAgICBpZiAoaW5kZXhGaWVsZHMubGVuZ3RoICE9PSAxKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgY29uc3QgZmllbGQgPSBpbmRleEZpZWxkc1swXTsKICAgIGlmIChxdWVyeUtleXMuaW5kZXhPZihmaWVsZCkgPT09IC0xKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgY29uc3QgcXVlcnlWYWx1ZSA9IHF1ZXJ5W2ZpZWxkXTsKICAgIGlmICh0eXBlb2YgcXVlcnlWYWx1ZSAhPT0gIm9iamVjdCIgfHwgcXVlcnlWYWx1ZSA9PT0gbnVsbCkgewogICAgICBjb25zdCBpbmRleEtleSA9IHF1ZXJ5VmFsdWU7CiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuZGF0YS5zZWFyY2goaW5kZXhLZXkpOwogICAgICByZXR1cm4gcmVzdWx0IHx8IFtdOwogICAgfQogICAgaWYgKHR5cGVvZiBxdWVyeVZhbHVlID09PSAib2JqZWN0IiAmJiAhQXJyYXkuaXNBcnJheShxdWVyeVZhbHVlKSkgewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fcXVlcnlXaXRoT3BlcmF0b3JzKGZpZWxkLCBxdWVyeVZhbHVlKTsKICAgIH0KICAgIHJldHVybiBudWxsOwogIH0KICAvKioKICAgKiBRdWVyeSBpbmRleCB3aXRoIGNvbXBhcmlzb24gb3BlcmF0b3JzCiAgICAqIAogICAqIEBwcml2YXRlCiAgICovCiAgYXN5bmMgX3F1ZXJ5V2l0aE9wZXJhdG9ycyhmaWVsZCwgb3BlcmF0b3JzKSB7CiAgICBjb25zdCBvcHMgPSBPYmplY3Qua2V5cyhvcGVyYXRvcnMpOwogICAgY29uc3QgcmVzdWx0cyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICBjb25zdCBoYXNSYW5nZU9wID0gb3BzLnNvbWUoKG9wKSA9PiBbIiRndCIsICIkZ3RlIiwgIiRsdCIsICIkbHRlIl0uaW5jbHVkZXMob3ApKTsKICAgIGlmIChoYXNSYW5nZU9wKSB7CiAgICAgIGNvbnN0IGhhc0d0ID0gb3BzLmluY2x1ZGVzKCIkZ3QiKSB8fCBvcHMuaW5jbHVkZXMoIiRndGUiKTsKICAgICAgY29uc3QgaGFzTHQgPSBvcHMuaW5jbHVkZXMoIiRsdCIpIHx8IG9wcy5pbmNsdWRlcygiJGx0ZSIpOwogICAgICBpZiAoaGFzR3QgJiYgaGFzTHQpIHsKICAgICAgICBjb25zdCBtaW5WYWx1ZSA9IG9wcy5pbmNsdWRlcygiJGd0ZSIpID8gb3BlcmF0b3JzWyIkZ3RlIl0gOiBvcHMuaW5jbHVkZXMoIiRndCIpID8gb3BlcmF0b3JzWyIkZ3QiXSA6IC1JbmZpbml0eTsKICAgICAgICBjb25zdCBtYXhWYWx1ZSA9IG9wcy5pbmNsdWRlcygiJGx0ZSIpID8gb3BlcmF0b3JzWyIkbHRlIl0gOiBvcHMuaW5jbHVkZXMoIiRsdCIpID8gb3BlcmF0b3JzWyIkbHQiXSA6IEluZmluaXR5OwogICAgICAgIGNvbnN0IHJhbmdlUmVzdWx0cyA9IGF3YWl0IHRoaXMuZGF0YS5yYW5nZVNlYXJjaChtaW5WYWx1ZSwgbWF4VmFsdWUpOwogICAgICAgIGZvciAoY29uc3QgZW50cnkgb2YgcmFuZ2VSZXN1bHRzKSB7CiAgICAgICAgICBjb25zdCBrZXlWYWx1ZSA9IGVudHJ5LmtleTsKICAgICAgICAgIGNvbnN0IHZhbHVlID0gZW50cnkudmFsdWU7CiAgICAgICAgICBsZXQgbWF0Y2hlczIgPSB0cnVlOwogICAgICAgICAgaWYgKG9wcy5pbmNsdWRlcygiJGd0IikgJiYgIShrZXlWYWx1ZSA+IG9wZXJhdG9yc1siJGd0Il0pKSBtYXRjaGVzMiA9IGZhbHNlOwogICAgICAgICAgaWYgKG9wcy5pbmNsdWRlcygiJGd0ZSIpICYmICEoa2V5VmFsdWUgPj0gb3BlcmF0b3JzWyIkZ3RlIl0pKSBtYXRjaGVzMiA9IGZhbHNlOwogICAgICAgICAgaWYgKG9wcy5pbmNsdWRlcygiJGx0IikgJiYgIShrZXlWYWx1ZSA8IG9wZXJhdG9yc1siJGx0Il0pKSBtYXRjaGVzMiA9IGZhbHNlOwogICAgICAgICAgaWYgKG9wcy5pbmNsdWRlcygiJGx0ZSIpICYmICEoa2V5VmFsdWUgPD0gb3BlcmF0b3JzWyIkbHRlIl0pKSBtYXRjaGVzMiA9IGZhbHNlOwogICAgICAgICAgaWYgKG1hdGNoZXMyICYmIHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgIHZhbHVlLmZvckVhY2goKGlkKSA9PiByZXN1bHRzLmFkZChpZCkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc3VsdHMuYWRkKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gQXJyYXkuZnJvbShyZXN1bHRzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBhbGxFbnRyaWVzID0gYXdhaXQgdGhpcy5kYXRhLnRvQXJyYXkoKTsKICAgICAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIGFsbEVudHJpZXMpIHsKICAgICAgICAgIGNvbnN0IGtleVZhbHVlID0gZW50cnkua2V5OwogICAgICAgICAgY29uc3QgdmFsdWUgPSBlbnRyeS52YWx1ZTsKICAgICAgICAgIGxldCBtYXRjaGVzMiA9IHRydWU7CiAgICAgICAgICBmb3IgKGNvbnN0IG9wIG9mIG9wcykgewogICAgICAgICAgICBjb25zdCBvcGVyYW5kID0gb3BlcmF0b3JzW29wXTsKICAgICAgICAgICAgaWYgKG9wID09PSAiJGd0IiAmJiAhKGtleVZhbHVlID4gb3BlcmFuZCkpIG1hdGNoZXMyID0gZmFsc2U7CiAgICAgICAgICAgIGVsc2UgaWYgKG9wID09PSAiJGd0ZSIgJiYgIShrZXlWYWx1ZSA+PSBvcGVyYW5kKSkgbWF0Y2hlczIgPSBmYWxzZTsKICAgICAgICAgICAgZWxzZSBpZiAob3AgPT09ICIkbHQiICYmICEoa2V5VmFsdWUgPCBvcGVyYW5kKSkgbWF0Y2hlczIgPSBmYWxzZTsKICAgICAgICAgICAgZWxzZSBpZiAob3AgPT09ICIkbHRlIiAmJiAhKGtleVZhbHVlIDw9IG9wZXJhbmQpKSBtYXRjaGVzMiA9IGZhbHNlOwogICAgICAgICAgICBlbHNlIGlmIChvcCA9PT0gIiRlcSIgJiYgIShrZXlWYWx1ZSA9PT0gb3BlcmFuZCkpIG1hdGNoZXMyID0gZmFsc2U7CiAgICAgICAgICAgIGVsc2UgaWYgKG9wID09PSAiJG5lIiAmJiAhKGtleVZhbHVlICE9PSBvcGVyYW5kKSkgbWF0Y2hlczIgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChtYXRjaGVzMiAmJiB2YWx1ZSkgewogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICB2YWx1ZS5mb3JFYWNoKChpZCkgPT4gcmVzdWx0cy5hZGQoaWQpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXN1bHRzLmFkZCh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIEFycmF5LmZyb20ocmVzdWx0cyk7CiAgICAgIH0KICAgIH0KICAgIGlmIChvcHMuaW5jbHVkZXMoIiRpbiIpKSB7CiAgICAgIGNvbnN0IHZhbHVlcyA9IG9wZXJhdG9yc1siJGluIl07CiAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlcykpIHsKICAgICAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIHZhbHVlcykgewogICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5kYXRhLnNlYXJjaCh2YWx1ZSk7CiAgICAgICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHJlc3VsdCkpIHsKICAgICAgICAgICAgICByZXN1bHQuZm9yRWFjaCgoaWQpID0+IHJlc3VsdHMuYWRkKGlkKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzdWx0cy5hZGQocmVzdWx0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gQXJyYXkuZnJvbShyZXN1bHRzKTsKICAgICAgfQogICAgfQogICAgaWYgKG9wcy5pbmNsdWRlcygiJGVxIikpIHsKICAgICAgY29uc3QgdmFsdWUgPSBvcGVyYXRvcnNbIiRlcSJdOwogICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmRhdGEuc2VhcmNoKHZhbHVlKTsKICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgIHJldHVybiBBcnJheS5pc0FycmF5KHJlc3VsdCkgPyByZXN1bHQgOiBbcmVzdWx0XTsKICAgICAgfQogICAgICByZXR1cm4gW107CiAgICB9CiAgICBpZiAob3BzLmluY2x1ZGVzKCIkbmUiKSkgewogICAgICBjb25zdCBleGNsdWRlVmFsdWUgPSBvcGVyYXRvcnNbIiRuZSJdOwogICAgICBjb25zdCBhbGxFbnRyaWVzID0gYXdhaXQgdGhpcy5kYXRhLnRvQXJyYXkoKTsKICAgICAgZm9yIChjb25zdCBlbnRyeSBvZiBhbGxFbnRyaWVzKSB7CiAgICAgICAgaWYgKGVudHJ5LmtleSAhPT0gZXhjbHVkZVZhbHVlICYmIGVudHJ5LnZhbHVlKSB7CiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShlbnRyeS52YWx1ZSkpIHsKICAgICAgICAgICAgZW50cnkudmFsdWUuZm9yRWFjaCgoaWQpID0+IHJlc3VsdHMuYWRkKGlkKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXN1bHRzLmFkZChlbnRyeS52YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBBcnJheS5mcm9tKHJlc3VsdHMpOwogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfQogIC8qKgogICAqIENsZWFyIGFsbCBlbnRyaWVzIGZyb20gdGhlIGluZGV4CiAgICovCiAgYXN5bmMgY2xlYXIoKSB7CiAgICBpZiAodGhpcy5pc09wZW4pIHsKICAgICAgYXdhaXQgdGhpcy5jbG9zZSgpOwogICAgfQogICAgY29uc3QgY3VycmVudFZlcnNpb24gPSBhd2FpdCBnZXRDdXJyZW50VmVyc2lvbih0aGlzLnN0b3JhZ2VGaWxlUGF0aCk7CiAgICBjb25zdCB0YXJnZXRQYXRoID0gYnVpbGRWZXJzaW9uZWRQYXRoKHRoaXMuc3RvcmFnZUZpbGVQYXRoLCBjdXJyZW50VmVyc2lvbik7CiAgICBjb25zdCBwYXRoUGFydHMgPSB0YXJnZXRQYXRoLnNwbGl0KCIvIikuZmlsdGVyKEJvb2xlYW4pOwogICAgY29uc3QgZmlsZW5hbWUgPSBwYXRoUGFydHMucG9wKCk7CiAgICBsZXQgZGlySGFuZGxlID0gYXdhaXQgZ2xvYmFsVGhpcy5uYXZpZ2F0b3Iuc3RvcmFnZS5nZXREaXJlY3RvcnkoKTsKICAgIGZvciAoY29uc3QgcGFydCBvZiBwYXRoUGFydHMpIHsKICAgICAgZGlySGFuZGxlID0gYXdhaXQgZGlySGFuZGxlLmdldERpcmVjdG9yeUhhbmRsZShwYXJ0LCB7IGNyZWF0ZTogdHJ1ZSB9KTsKICAgIH0KICAgIHRyeSB7CiAgICAgIGF3YWl0IGRpckhhbmRsZS5yZW1vdmVFbnRyeShmaWxlbmFtZSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICB9CiAgICBhd2FpdCB0aGlzLm9wZW4oKTsKICB9Cn0KY29uc3QgVEVYVF9JTkRFWF9TVUZGSVhFUyA9IFsiLXRlcm1zLmJqc29uIiwgIi1kb2N1bWVudHMuYmpzb24iLCAiLWxlbmd0aHMuYmpzb24iXTsKY2xhc3MgVGV4dENvbGxlY3Rpb25JbmRleCBleHRlbmRzIEluZGV4IHsKICBjb25zdHJ1Y3RvcihuYW1lLCBrZXlzLCBzdG9yYWdlLCBvcHRpb25zID0ge30pIHsKICAgIHN1cGVyKG5hbWUsIGtleXMsIHN0b3JhZ2UpOwogICAgdGhpcy5zdG9yYWdlQmFzZVBhdGggPSBzdG9yYWdlOwogICAgdGhpcy5zdG9yYWdlVmVyc2lvbiA9IDA7CiAgICB0aGlzLnZlcnNpb25lZEJhc2VQYXRoID0gbnVsbDsKICAgIHRoaXMuX3JlbGVhc2VTdG9yYWdlID0gbnVsbDsKICAgIHRoaXMudGV4dEluZGV4ID0gbnVsbDsKICAgIHRoaXMuc3luY0hhbmRsZXMgPSBbXTsKICAgIHRoaXMuaXNPcGVuID0gZmFsc2U7CiAgICB0aGlzLmluZGV4ZWRGaWVsZHMgPSBbXTsKICAgIGZvciAoY29uc3QgZmllbGQgaW4ga2V5cykgewogICAgICBpZiAoa2V5c1tmaWVsZF0gPT09ICJ0ZXh0IikgewogICAgICAgIHRoaXMuaW5kZXhlZEZpZWxkcy5wdXNoKGZpZWxkKTsKICAgICAgfQogICAgfQogICAgaWYgKHRoaXMuaW5kZXhlZEZpZWxkcy5sZW5ndGggPT09IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdUZXh0IGluZGV4IG11c3QgaGF2ZSBhdCBsZWFzdCBvbmUgZmllbGQgd2l0aCB0eXBlICJ0ZXh0IicpOwogICAgfQogIH0KICAvKioKICAgKiBPcGVuIHRoZSBpbmRleCBmaWxlcwogICAqIE11c3QgYmUgY2FsbGVkIGJlZm9yZSB1c2luZyB0aGUgaW5kZXgKICAgKi8KICBhc3luYyBvcGVuKCkgewogICAgaWYgKHRoaXMuaXNPcGVuKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRyeSB7CiAgICAgIGNvbnN0IHsgdmVyc2lvbiwgcGF0aDogdmVyc2lvbmVkQmFzZVBhdGggfSA9IGF3YWl0IGFjcXVpcmVWZXJzaW9uZWRQYXRoKHRoaXMuc3RvcmFnZUJhc2VQYXRoKTsKICAgICAgdGhpcy5zdG9yYWdlVmVyc2lvbiA9IHZlcnNpb247CiAgICAgIHRoaXMudmVyc2lvbmVkQmFzZVBhdGggPSB2ZXJzaW9uZWRCYXNlUGF0aDsKICAgICAgdGhpcy5fcmVsZWFzZVN0b3JhZ2UgPSAoKSA9PiByZWxlYXNlVmVyc2lvbmVkUGF0aCh0aGlzLnN0b3JhZ2VCYXNlUGF0aCwgdmVyc2lvbiwgeyBzdWZmaXhlczogVEVYVF9JTkRFWF9TVUZGSVhFUyB9KTsKICAgICAgY29uc3QgaW5kZXhUcmVlID0gYXdhaXQgdGhpcy5fY3JlYXRlQlBsdXNUcmVlKHRoaXMuX2dldEFjdGl2ZUJhc2VQYXRoKCkgKyAiLXRlcm1zLmJqc29uIik7CiAgICAgIGNvbnN0IGRvY1Rlcm1zVHJlZSA9IGF3YWl0IHRoaXMuX2NyZWF0ZUJQbHVzVHJlZSh0aGlzLl9nZXRBY3RpdmVCYXNlUGF0aCgpICsgIi1kb2N1bWVudHMuYmpzb24iKTsKICAgICAgY29uc3QgbGVuZ3Roc1RyZWUgPSBhd2FpdCB0aGlzLl9jcmVhdGVCUGx1c1RyZWUodGhpcy5fZ2V0QWN0aXZlQmFzZVBhdGgoKSArICItbGVuZ3Rocy5ianNvbiIpOwogICAgICB0aGlzLnRleHRJbmRleCA9IG5ldyBUZXh0SW5kZXgoewogICAgICAgIG9yZGVyOiAxNiwKICAgICAgICB0cmVlczogewogICAgICAgICAgaW5kZXg6IGluZGV4VHJlZSwKICAgICAgICAgIGRvY3VtZW50VGVybXM6IGRvY1Rlcm1zVHJlZSwKICAgICAgICAgIGRvY3VtZW50TGVuZ3RoczogbGVuZ3Roc1RyZWUKICAgICAgICB9CiAgICAgIH0pOwogICAgICBhd2FpdCB0aGlzLnRleHRJbmRleC5vcGVuKCk7CiAgICAgIHRoaXMuaXNPcGVuID0gdHJ1ZTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChlcnJvci5jb2RlID09PSAiRU5PRU5UIiB8fCBlcnJvci5tZXNzYWdlICYmIChlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCJGYWlsZWQgdG8gcmVhZCBtZXRhZGF0YSIpIHx8IGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoIm1pc3NpbmcgcmVxdWlyZWQgZmllbGRzIikgfHwgZXJyb3IubWVzc2FnZS5pbmNsdWRlcygiVW5rbm93biB0eXBlIGJ5dGUiKSB8fCBlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCJJbnZhbGlkIikgfHwgZXJyb3IubWVzc2FnZS5pbmNsdWRlcygiZmlsZSB0b28gc21hbGwiKSkpIHsKICAgICAgICBhd2FpdCB0aGlzLl9jbG9zZVN5bmNIYW5kbGVzKCk7CiAgICAgICAgYXdhaXQgdGhpcy5fZGVsZXRlSW5kZXhGaWxlcygpOwogICAgICAgIGF3YWl0IHRoaXMuX2Vuc3VyZURpcmVjdG9yeUZvckZpbGUodGhpcy5fZ2V0QWN0aXZlQmFzZVBhdGgoKSArICItdGVybXMuYmpzb24iKTsKICAgICAgICBjb25zdCBpbmRleFRyZWUgPSBhd2FpdCB0aGlzLl9jcmVhdGVCUGx1c1RyZWUodGhpcy5fZ2V0QWN0aXZlQmFzZVBhdGgoKSArICItdGVybXMuYmpzb24iKTsKICAgICAgICBjb25zdCBkb2NUZXJtc1RyZWUgPSBhd2FpdCB0aGlzLl9jcmVhdGVCUGx1c1RyZWUodGhpcy5fZ2V0QWN0aXZlQmFzZVBhdGgoKSArICItZG9jdW1lbnRzLmJqc29uIik7CiAgICAgICAgY29uc3QgbGVuZ3Roc1RyZWUgPSBhd2FpdCB0aGlzLl9jcmVhdGVCUGx1c1RyZWUodGhpcy5fZ2V0QWN0aXZlQmFzZVBhdGgoKSArICItbGVuZ3Rocy5ianNvbiIpOwogICAgICAgIHRoaXMudGV4dEluZGV4ID0gbmV3IFRleHRJbmRleCh7CiAgICAgICAgICBvcmRlcjogMTYsCiAgICAgICAgICB0cmVlczogewogICAgICAgICAgICBpbmRleDogaW5kZXhUcmVlLAogICAgICAgICAgICBkb2N1bWVudFRlcm1zOiBkb2NUZXJtc1RyZWUsCiAgICAgICAgICAgIGRvY3VtZW50TGVuZ3RoczogbGVuZ3Roc1RyZWUKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBhd2FpdCB0aGlzLnRleHRJbmRleC5vcGVuKCk7CiAgICAgICAgdGhpcy5pc09wZW4gPSB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IGVycm9yOwogICAgICB9CiAgICB9CiAgfQogIGFzeW5jIF9jcmVhdGVCUGx1c1RyZWUoZmlsZVBhdGgpIHsKICAgIGNvbnN0IHBhdGhQYXJ0cyA9IGZpbGVQYXRoLnNwbGl0KCIvIikuZmlsdGVyKEJvb2xlYW4pOwogICAgY29uc3QgZmlsZW5hbWUgPSBwYXRoUGFydHMucG9wKCk7CiAgICBpZiAoIWZpbGVuYW1lKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBzdG9yYWdlIHBhdGg6ICR7ZmlsZVBhdGh9YCk7CiAgICB9CiAgICBsZXQgZGlySGFuZGxlID0gYXdhaXQgZ2xvYmFsVGhpcy5uYXZpZ2F0b3Iuc3RvcmFnZS5nZXREaXJlY3RvcnkoKTsKICAgIGZvciAoY29uc3QgcGFydCBvZiBwYXRoUGFydHMpIHsKICAgICAgZGlySGFuZGxlID0gYXdhaXQgZGlySGFuZGxlLmdldERpcmVjdG9yeUhhbmRsZShwYXJ0LCB7IGNyZWF0ZTogdHJ1ZSB9KTsKICAgIH0KICAgIGNvbnN0IGZpbGVIYW5kbGUgPSBhd2FpdCBkaXJIYW5kbGUuZ2V0RmlsZUhhbmRsZShmaWxlbmFtZSwgeyBjcmVhdGU6IHRydWUgfSk7CiAgICBjb25zdCBzeW5jSGFuZGxlID0gYXdhaXQgZmlsZUhhbmRsZS5jcmVhdGVTeW5jQWNjZXNzSGFuZGxlKCk7CiAgICB0aGlzLnN5bmNIYW5kbGVzLnB1c2goc3luY0hhbmRsZSk7CiAgICByZXR1cm4gbmV3IEJQbHVzVHJlZShzeW5jSGFuZGxlLCAxNik7CiAgfQogIGFzeW5jIF9jbG9zZVN5bmNIYW5kbGVzKCkgewogICAgZm9yIChjb25zdCBoYW5kbGUgb2YgdGhpcy5zeW5jSGFuZGxlcykgewogICAgICB0cnkgewogICAgICAgIGF3YWl0IGhhbmRsZS5jbG9zZSgpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuc3luY0hhbmRsZXMgPSBbXTsKICB9CiAgX2dldEFjdGl2ZUJhc2VQYXRoKCkgewogICAgcmV0dXJuIHRoaXMudmVyc2lvbmVkQmFzZVBhdGggfHwgdGhpcy5zdG9yYWdlQmFzZVBhdGg7CiAgfQogIGFzeW5jIF9kZWxldGVJbmRleEZpbGVzKGJhc2VQYXRoID0gdGhpcy5fZ2V0QWN0aXZlQmFzZVBhdGgoKSkgewogICAgZm9yIChjb25zdCBzdWZmaXggb2YgVEVYVF9JTkRFWF9TVUZGSVhFUykgewogICAgICBhd2FpdCB0aGlzLl9kZWxldGVGaWxlKGJhc2VQYXRoICsgc3VmZml4KTsKICAgIH0KICB9CiAgYXN5bmMgX2RlbGV0ZUZpbGUoZmlsZVBhdGgpIHsKICAgIGlmICghZmlsZVBhdGgpIHJldHVybjsKICAgIHRyeSB7CiAgICAgIGNvbnN0IHBhdGhQYXJ0cyA9IGZpbGVQYXRoLnNwbGl0KCIvIikuZmlsdGVyKEJvb2xlYW4pOwogICAgICBjb25zdCBmaWxlbmFtZSA9IHBhdGhQYXJ0cy5wb3AoKTsKICAgICAgaWYgKCFmaWxlbmFtZSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBzdG9yYWdlIHBhdGg6ICR7ZmlsZVBhdGh9YCk7CiAgICAgIH0KICAgICAgbGV0IGRpciA9IGF3YWl0IGdsb2JhbFRoaXMubmF2aWdhdG9yLnN0b3JhZ2UuZ2V0RGlyZWN0b3J5KCk7CiAgICAgIGZvciAoY29uc3QgcGFydCBvZiBwYXRoUGFydHMpIHsKICAgICAgICBkaXIgPSBhd2FpdCBkaXIuZ2V0RGlyZWN0b3J5SGFuZGxlKHBhcnQsIHsgY3JlYXRlOiBmYWxzZSB9KTsKICAgICAgfQogICAgICBhd2FpdCBkaXIucmVtb3ZlRW50cnkoZmlsZW5hbWUpOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIH0KICB9CiAgYXN5bmMgX2Vuc3VyZURpcmVjdG9yeUZvckZpbGUoZmlsZVBhdGgpIHsKICAgIGlmICghZmlsZVBhdGgpIHJldHVybjsKICAgIGNvbnN0IHBhdGhQYXJ0cyA9IGZpbGVQYXRoLnNwbGl0KCIvIikuZmlsdGVyKEJvb2xlYW4pOwogICAgcGF0aFBhcnRzLnBvcCgpOwogICAgaWYgKHBhdGhQYXJ0cy5sZW5ndGggPT09IDApIHJldHVybjsKICAgIHRyeSB7CiAgICAgIGxldCBkaXIgPSBhd2FpdCBnbG9iYWxUaGlzLm5hdmlnYXRvci5zdG9yYWdlLmdldERpcmVjdG9yeSgpOwogICAgICBmb3IgKGNvbnN0IHBhcnQgb2YgcGF0aFBhcnRzKSB7CiAgICAgICAgZGlyID0gYXdhaXQgZGlyLmdldERpcmVjdG9yeUhhbmRsZShwYXJ0LCB7IGNyZWF0ZTogdHJ1ZSB9KTsKICAgICAgfQogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGVycm9yLmNvZGUgIT09ICJFRVhJU1QiKSB7CiAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgIH0KICAgIH0KICB9CiAgLyoqCiAgICogQ2xvc2UgdGhlIGluZGV4IGZpbGVzCiAgICovCiAgYXN5bmMgY2xvc2UoKSB7CiAgICBpZiAodGhpcy5pc09wZW4pIHsKICAgICAgYXdhaXQgdGhpcy5fbWF5YmVDb21wYWN0KCk7CiAgICAgIGlmICh0aGlzLnRleHRJbmRleD8uaXNPcGVuKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGF3YWl0IHRoaXMudGV4dEluZGV4LmNsb3NlKCk7CiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgIGlmICghZXJyb3IubWVzc2FnZSB8fCAhZXJyb3IubWVzc2FnZS5pbmNsdWRlcygiRmlsZSBpcyBub3Qgb3BlbiIpKSB7CiAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLmlzT3BlbiA9IGZhbHNlOwogICAgfQogICAgaWYgKHRoaXMuX3JlbGVhc2VTdG9yYWdlKSB7CiAgICAgIGF3YWl0IHRoaXMuX3JlbGVhc2VTdG9yYWdlKCk7CiAgICAgIHRoaXMuX3JlbGVhc2VTdG9yYWdlID0gbnVsbDsKICAgIH0KICB9CiAgYXN5bmMgX21heWJlQ29tcGFjdCgpIHsKICAgIGlmICghdGhpcy50ZXh0SW5kZXg/LmluZGV4Py5maWxlIHx8ICF0aGlzLnRleHRJbmRleD8uZG9jdW1lbnRUZXJtcz8uZmlsZSB8fCAhdGhpcy50ZXh0SW5kZXg/LmRvY3VtZW50TGVuZ3Rocz8uZmlsZSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBjb25zdCBjdXJyZW50VmVyc2lvbiA9IGF3YWl0IGdldEN1cnJlbnRWZXJzaW9uKHRoaXMuc3RvcmFnZUJhc2VQYXRoKTsKICAgIGlmIChjdXJyZW50VmVyc2lvbiAhPT0gdGhpcy5zdG9yYWdlVmVyc2lvbikgcmV0dXJuIGZhbHNlOwogICAgY29uc3QgdG90YWxTaXplID0gdGhpcy50ZXh0SW5kZXguaW5kZXguZmlsZS5nZXRGaWxlU2l6ZSgpICsgdGhpcy50ZXh0SW5kZXguZG9jdW1lbnRUZXJtcy5maWxlLmdldEZpbGVTaXplKCkgKyB0aGlzLnRleHRJbmRleC5kb2N1bWVudExlbmd0aHMuZmlsZS5nZXRGaWxlU2l6ZSgpOwogICAgaWYgKCF0b3RhbFNpemUgfHwgdG90YWxTaXplIDwgREVGQVVMVF9DT01QQUNUSU9OX01JTl9CWVRFUykgcmV0dXJuIGZhbHNlOwogICAgY29uc3QgbmV4dFZlcnNpb24gPSBjdXJyZW50VmVyc2lvbiArIDE7CiAgICBjb25zdCBjb21wYWN0QmFzZSA9IGJ1aWxkVmVyc2lvbmVkUGF0aCh0aGlzLnN0b3JhZ2VCYXNlUGF0aCwgbmV4dFZlcnNpb24pOwogICAgY29uc3QgaW5kZXhIYW5kbGUgPSBhd2FpdCBjcmVhdGVTeW5jQWNjZXNzSGFuZGxlKGAke2NvbXBhY3RCYXNlfS10ZXJtcy5ianNvbmAsIHsgcmVzZXQ6IHRydWUgfSk7CiAgICBjb25zdCBkb2NUZXJtc0hhbmRsZSA9IGF3YWl0IGNyZWF0ZVN5bmNBY2Nlc3NIYW5kbGUoYCR7Y29tcGFjdEJhc2V9LWRvY3VtZW50cy5ianNvbmAsIHsgcmVzZXQ6IHRydWUgfSk7CiAgICBjb25zdCBsZW5ndGhzSGFuZGxlID0gYXdhaXQgY3JlYXRlU3luY0FjY2Vzc0hhbmRsZShgJHtjb21wYWN0QmFzZX0tbGVuZ3Rocy5ianNvbmAsIHsgcmVzZXQ6IHRydWUgfSk7CiAgICBjb25zdCBpbmRleFRyZWUgPSBuZXcgQlBsdXNUcmVlKGluZGV4SGFuZGxlLCAxNik7CiAgICBjb25zdCBkb2NUZXJtc1RyZWUgPSBuZXcgQlBsdXNUcmVlKGRvY1Rlcm1zSGFuZGxlLCAxNik7CiAgICBjb25zdCBsZW5ndGhzVHJlZSA9IG5ldyBCUGx1c1RyZWUobGVuZ3Roc0hhbmRsZSwgMTYpOwogICAgYXdhaXQgdGhpcy50ZXh0SW5kZXguY29tcGFjdCh7CiAgICAgIGluZGV4OiBpbmRleFRyZWUsCiAgICAgIGRvY3VtZW50VGVybXM6IGRvY1Rlcm1zVHJlZSwKICAgICAgZG9jdW1lbnRMZW5ndGhzOiBsZW5ndGhzVHJlZQogICAgfSk7CiAgICBhd2FpdCBwcm9tb3RlVmVyc2lvbih0aGlzLnN0b3JhZ2VCYXNlUGF0aCwgbmV4dFZlcnNpb24sIGN1cnJlbnRWZXJzaW9uLCB7IHN1ZmZpeGVzOiBURVhUX0lOREVYX1NVRkZJWEVTIH0pOwogICAgYXdhaXQgdGhpcy5fY2xvc2VTeW5jSGFuZGxlcygpOwogICAgcmV0dXJuIHRydWU7CiAgfQogIC8qKgogICAqIEV4dHJhY3QgdGV4dCBjb250ZW50IGZyb20gYSBkb2N1bWVudCBmb3IgdGhlIGluZGV4ZWQgZmllbGRzCiAgICogQHBhcmFtIHtPYmplY3R9IGRvYyAtIFRoZSBkb2N1bWVudAogICAqIEByZXR1cm5zIHtzdHJpbmd9IENvbWJpbmVkIHRleHQgZnJvbSBhbGwgaW5kZXhlZCBmaWVsZHMKICAgKi8KICBfZXh0cmFjdFRleHQoZG9jKSB7CiAgICBjb25zdCB0ZXh0UGFydHMgPSBbXTsKICAgIGZvciAoY29uc3QgZmllbGQgb2YgdGhpcy5pbmRleGVkRmllbGRzKSB7CiAgICAgIGNvbnN0IHZhbHVlID0gZ2V0UHJvcChkb2MsIGZpZWxkKTsKICAgICAgaWYgKHZhbHVlICE9PSB2b2lkIDAgJiYgdmFsdWUgIT09IG51bGwpIHsKICAgICAgICB0ZXh0UGFydHMucHVzaChTdHJpbmcodmFsdWUpKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRleHRQYXJ0cy5qb2luKCIgIik7CiAgfQogIC8qKgogICAqIEFkZCBhIGRvY3VtZW50IHRvIHRoZSB0ZXh0IGluZGV4CiAgICogQHBhcmFtIHtPYmplY3R9IGRvYyAtIFRoZSBkb2N1bWVudCB0byBpbmRleAogICAqLwogIGFzeW5jIGFkZChkb2MpIHsKICAgIGlmICghZG9jLl9pZCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIkRvY3VtZW50IG11c3QgaGF2ZSBhbiBfaWQgZmllbGQiKTsKICAgIH0KICAgIGNvbnN0IHRleHQyID0gdGhpcy5fZXh0cmFjdFRleHQoZG9jKTsKICAgIGlmICh0ZXh0MikgewogICAgICBhd2FpdCB0aGlzLnRleHRJbmRleC5hZGQoU3RyaW5nKGRvYy5faWQpLCB0ZXh0Mik7CiAgICB9CiAgfQogIC8qKgogICAqIFJlbW92ZSBhIGRvY3VtZW50IGZyb20gdGhlIHRleHQgaW5kZXgKICAgKiBAcGFyYW0ge09iamVjdH0gZG9jIC0gVGhlIGRvY3VtZW50IHRvIHJlbW92ZQogICAqLwogIGFzeW5jIHJlbW92ZShkb2MpIHsKICAgIGlmICghZG9jLl9pZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBhd2FpdCB0aGlzLnRleHRJbmRleC5yZW1vdmUoU3RyaW5nKGRvYy5faWQpKTsKICB9CiAgLyoqCiAgICogUXVlcnkgdGhlIHRleHQgaW5kZXgKICAgKiBAcGFyYW0geyp9IHF1ZXJ5IC0gVGhlIHF1ZXJ5IG9iamVjdAogICAqIEByZXR1cm5zIHtBcnJheXxudWxsfSBBcnJheSBvZiBkb2N1bWVudCBJRHMgb3IgbnVsbCBpZiBxdWVyeSBpcyBub3QgYSB0ZXh0IHNlYXJjaAogICAqLwogIHF1ZXJ5KHF1ZXJ5KSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgLyoqCiAgICogU2VhcmNoIHRoZSB0ZXh0IGluZGV4CiAgICogQHBhcmFtIHtzdHJpbmd9IHNlYXJjaFRleHQgLSBUaGUgdGV4dCB0byBzZWFyY2ggZm9yCiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgLSBTZWFyY2ggb3B0aW9ucwogICAqIEByZXR1cm5zIHtQcm9taXNlPEFycmF5Pn0gQXJyYXkgb2YgZG9jdW1lbnQgSURzCiAgICovCiAgYXN5bmMgc2VhcmNoKHNlYXJjaFRleHQsIG9wdGlvbnMgPSB7fSkgewogICAgY29uc3QgcmVzdWx0cyA9IGF3YWl0IHRoaXMudGV4dEluZGV4LnF1ZXJ5KHNlYXJjaFRleHQsIHsgc2NvcmVkOiBmYWxzZSwgLi4ub3B0aW9ucyB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH0KICAvKioKICAgKiBDbGVhciBhbGwgZGF0YSBmcm9tIHRoZSBpbmRleAogICAqLwogIC8vIFRPRE86IFJlY3JlYXRlIHRoZSBpbmRleCBlbXB0eSBvciBkZWxldGUKICBhc3luYyBjbGVhcigpIHsKICAgIGlmICh0aGlzLmlzT3BlbikgewogICAgICBhd2FpdCB0aGlzLmNsb3NlKCk7CiAgICB9CiAgICBjb25zdCBjdXJyZW50VmVyc2lvbiA9IGF3YWl0IGdldEN1cnJlbnRWZXJzaW9uKHRoaXMuc3RvcmFnZUJhc2VQYXRoKTsKICAgIGNvbnN0IGJhc2VQYXRoID0gYnVpbGRWZXJzaW9uZWRQYXRoKHRoaXMuc3RvcmFnZUJhc2VQYXRoLCBjdXJyZW50VmVyc2lvbik7CiAgICBhd2FpdCB0aGlzLl9kZWxldGVJbmRleEZpbGVzKGJhc2VQYXRoKTsKICAgIGF3YWl0IHRoaXMub3BlbigpOwogIH0KICAvKioKICAgKiBHZXQgaW5kZXggc3BlY2lmaWNhdGlvbgogICAqLwogIGdldFNwZWMoKSB7CiAgICByZXR1cm4gewogICAgICBuYW1lOiB0aGlzLm5hbWUsCiAgICAgIGtleTogdGhpcy5rZXlzLAogICAgICB0ZXh0SW5kZXhWZXJzaW9uOiAzLAogICAgICB3ZWlnaHRzOiB0aGlzLl9nZXRXZWlnaHRzKCkKICAgIH07CiAgfQogIC8qKgogICAqIEdldCBmaWVsZCB3ZWlnaHRzIChhbGwgZGVmYXVsdCB0byAxIGZvciBub3cpCiAgICovCiAgX2dldFdlaWdodHMoKSB7CiAgICBjb25zdCB3ZWlnaHRzID0ge307CiAgICBmb3IgKGNvbnN0IGZpZWxkIG9mIHRoaXMuaW5kZXhlZEZpZWxkcykgewogICAgICB3ZWlnaHRzW2ZpZWxkXSA9IDE7CiAgICB9CiAgICByZXR1cm4gd2VpZ2h0czsKICB9Cn0KZnVuY3Rpb24gaGF2ZXJzaW5lRGlzdGFuY2UobGF0MSwgbG5nMSwgbGF0MiwgbG5nMikgewogIGNvbnN0IFIgPSA2MzcxOwogIGNvbnN0IGRMYXQgPSAobGF0MiAtIGxhdDEpICogTWF0aC5QSSAvIDE4MDsKICBjb25zdCBkTG5nID0gKGxuZzIgLSBsbmcxKSAqIE1hdGguUEkgLyAxODA7CiAgY29uc3QgYSA9IE1hdGguc2luKGRMYXQgLyAyKSAqIE1hdGguc2luKGRMYXQgLyAyKSArIE1hdGguY29zKGxhdDEgKiBNYXRoLlBJIC8gMTgwKSAqIE1hdGguY29zKGxhdDIgKiBNYXRoLlBJIC8gMTgwKSAqIE1hdGguc2luKGRMbmcgLyAyKSAqIE1hdGguc2luKGRMbmcgLyAyKTsKICBjb25zdCBjID0gMiAqIE1hdGguYXRhbjIoTWF0aC5zcXJ0KGEpLCBNYXRoLnNxcnQoMSAtIGEpKTsKICByZXR1cm4gUiAqIGM7Cn0KZnVuY3Rpb24gcmFkaXVzVG9Cb3VuZGluZ0JveChsYXQsIGxuZywgcmFkaXVzS20pIHsKICBjb25zdCBsYXREZWx0YSA9IHJhZGl1c0ttIC8gMTExOwogIGNvbnN0IGxuZ0RlbHRhID0gcmFkaXVzS20gLyAoMTExICogTWF0aC5jb3MobGF0ICogTWF0aC5QSSAvIDE4MCkpOwogIHJldHVybiB7CiAgICBtaW5MYXQ6IGxhdCAtIGxhdERlbHRhLAogICAgbWF4TGF0OiBsYXQgKyBsYXREZWx0YSwKICAgIG1pbkxuZzogbG5nIC0gbG5nRGVsdGEsCiAgICBtYXhMbmc6IGxuZyArIGxuZ0RlbHRhCiAgfTsKfQpmdW5jdGlvbiBpbnRlcnNlY3RzKGJib3gxLCBiYm94MikgewogIHJldHVybiAhKGJib3gxLm1heExhdCA8IGJib3gyLm1pbkxhdCB8fCBiYm94MS5taW5MYXQgPiBiYm94Mi5tYXhMYXQgfHwgYmJveDEubWF4TG5nIDwgYmJveDIubWluTG5nIHx8IGJib3gxLm1pbkxuZyA+IGJib3gyLm1heExuZyk7Cn0KZnVuY3Rpb24gYXJlYShiYm94KSB7CiAgcmV0dXJuIChiYm94Lm1heExhdCAtIGJib3gubWluTGF0KSAqIChiYm94Lm1heExuZyAtIGJib3gubWluTG5nKTsKfQpmdW5jdGlvbiB1bmlvbihiYm94MSwgYmJveDIpIHsKICByZXR1cm4gewogICAgbWluTGF0OiBNYXRoLm1pbihiYm94MS5taW5MYXQsIGJib3gyLm1pbkxhdCksCiAgICBtYXhMYXQ6IE1hdGgubWF4KGJib3gxLm1heExhdCwgYmJveDIubWF4TGF0KSwKICAgIG1pbkxuZzogTWF0aC5taW4oYmJveDEubWluTG5nLCBiYm94Mi5taW5MbmcpLAogICAgbWF4TG5nOiBNYXRoLm1heChiYm94MS5tYXhMbmcsIGJib3gyLm1heExuZykKICB9Owp9CmZ1bmN0aW9uIGVubGFyZ2VtZW50KGJib3gxLCBiYm94MikgewogIGNvbnN0IHVuaW9uQm94ID0gdW5pb24oYmJveDEsIGJib3gyKTsKICByZXR1cm4gYXJlYSh1bmlvbkJveCkgLSBhcmVhKGJib3gxKTsKfQpjbGFzcyBSVHJlZU5vZGUgewogIGNvbnN0cnVjdG9yKHJ0cmVlLCBub2RlRGF0YSkgewogICAgdGhpcy5ydHJlZSA9IHJ0cmVlOwogICAgdGhpcy5pZCA9IG5vZGVEYXRhLmlkOwogICAgdGhpcy5pc0xlYWYgPSBub2RlRGF0YS5pc0xlYWY7CiAgICB0aGlzLmNoaWxkcmVuID0gbm9kZURhdGEuY2hpbGRyZW4gfHwgW107CiAgICB0aGlzLmJib3ggPSBub2RlRGF0YS5iYm94OwogIH0KICAvKioKICAgKiBVcGRhdGUgdGhlIGJvdW5kaW5nIGJveCB0byBjb250YWluIGFsbCBjaGlsZHJlbgogICAqLwogIHVwZGF0ZUJCb3goKSB7CiAgICBpZiAodGhpcy5jaGlsZHJlbi5sZW5ndGggPT09IDApIHsKICAgICAgdGhpcy5iYm94ID0gbnVsbDsKICAgICAgcmV0dXJuOwogICAgfQogICAgbGV0IG1pbkxhdCA9IEluZmluaXR5LCBtYXhMYXQgPSAtSW5maW5pdHk7CiAgICBsZXQgbWluTG5nID0gSW5maW5pdHksIG1heExuZyA9IC1JbmZpbml0eTsKICAgIGZvciAoY29uc3QgY2hpbGQgb2YgdGhpcy5jaGlsZHJlbikgewogICAgICBsZXQgYmJveDsKICAgICAgaWYgKHRoaXMuaXNMZWFmKSB7CiAgICAgICAgYmJveCA9IGNoaWxkLmJib3g7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgY2hpbGROb2RlID0gdGhpcy5ydHJlZS5fbG9hZE5vZGUoY2hpbGQpOwogICAgICAgIGJib3ggPSBjaGlsZE5vZGUuYmJveDsKICAgICAgfQogICAgICBpZiAoYmJveCkgewogICAgICAgIG1pbkxhdCA9IE1hdGgubWluKG1pbkxhdCwgYmJveC5taW5MYXQpOwogICAgICAgIG1heExhdCA9IE1hdGgubWF4KG1heExhdCwgYmJveC5tYXhMYXQpOwogICAgICAgIG1pbkxuZyA9IE1hdGgubWluKG1pbkxuZywgYmJveC5taW5MbmcpOwogICAgICAgIG1heExuZyA9IE1hdGgubWF4KG1heExuZywgYmJveC5tYXhMbmcpOwogICAgICB9CiAgICB9CiAgICB0aGlzLmJib3ggPSB7IG1pbkxhdCwgbWF4TGF0LCBtaW5MbmcsIG1heExuZyB9OwogICAgdGhpcy5ydHJlZS5fc2F2ZU5vZGUodGhpcyk7CiAgfQogIC8qKgogICAqIENvbnZlcnQgbm9kZSB0byBwbGFpbiBvYmplY3QgZm9yIHNlcmlhbGl6YXRpb24KICAgKi8KICB0b0pTT04oKSB7CiAgICByZXR1cm4gewogICAgICBpZDogdGhpcy5pZCwKICAgICAgaXNMZWFmOiB0aGlzLmlzTGVhZiwKICAgICAgY2hpbGRyZW46IHRoaXMuY2hpbGRyZW4sCiAgICAgIGJib3g6IHRoaXMuYmJveAogICAgfTsKICB9Cn0KY2xhc3MgUlRyZWUgewogIGNvbnN0cnVjdG9yKHN5bmNIYW5kbGUsIG1heEVudHJpZXMgPSA5KSB7CiAgICB0aGlzLmZpbGUgPSBuZXcgQkpzb25GaWxlKHN5bmNIYW5kbGUpOwogICAgdGhpcy5tYXhFbnRyaWVzID0gbWF4RW50cmllczsKICAgIHRoaXMubWluRW50cmllcyA9IE1hdGgubWF4KDIsIE1hdGguY2VpbChtYXhFbnRyaWVzIC8gMikpOwogICAgdGhpcy5yb290UG9pbnRlciA9IG51bGw7CiAgICB0aGlzLm5leHRJZCA9IDE7CiAgICB0aGlzLl9zaXplID0gMDsKICAgIHRoaXMuaXNPcGVuID0gZmFsc2U7CiAgfQogIC8qKgogICAqIE9wZW4gdGhlIFItdHJlZSAobG9hZCBvciBpbml0aWFsaXplIG1ldGFkYXRhKQogICAqLwogIGFzeW5jIG9wZW4oKSB7CiAgICBpZiAodGhpcy5pc09wZW4pIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJSLXRyZWUgaXMgYWxyZWFkeSBvcGVuIik7CiAgICB9CiAgICBjb25zdCBmaWxlU2l6ZSA9IHRoaXMuZmlsZS5nZXRGaWxlU2l6ZSgpOwogICAgY29uc3QgZXhpc3RzID0gZmlsZVNpemUgPiAwOwogICAgaWYgKGV4aXN0cykgewogICAgICB0aGlzLl9sb2FkRnJvbUZpbGUoKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX2luaXRpYWxpemVOZXdUcmVlKCk7CiAgICB9CiAgICB0aGlzLmlzT3BlbiA9IHRydWU7CiAgfQogIC8qKgogICAqIENsb3NlIHRoZSBSLXRyZWUKICAgKi8KICBhc3luYyBjbG9zZSgpIHsKICAgIGlmICh0aGlzLmlzT3BlbikgewogICAgICB0aGlzLl93cml0ZU1ldGFkYXRhKCk7CiAgICAgIGlmICh0aGlzLmZpbGUgJiYgdGhpcy5maWxlLnN5bmNBY2Nlc3NIYW5kbGUpIHsKICAgICAgICB0aGlzLmZpbGUuZmx1c2goKTsKICAgICAgICBhd2FpdCB0aGlzLmZpbGUuc3luY0FjY2Vzc0hhbmRsZS5jbG9zZSgpOwogICAgICB9CiAgICAgIHRoaXMuaXNPcGVuID0gZmFsc2U7CiAgICB9CiAgfQogIC8qKgogICAqIEluaXRpYWxpemUgYSBuZXcgZW1wdHkgdHJlZQogICAqLwogIF9pbml0aWFsaXplTmV3VHJlZSgpIHsKICAgIGNvbnN0IHJvb3ROb2RlID0gbmV3IFJUcmVlTm9kZSh0aGlzLCB7CiAgICAgIGlkOiAwLAogICAgICBpc0xlYWY6IHRydWUsCiAgICAgIGNoaWxkcmVuOiBbXSwKICAgICAgYmJveDogbnVsbAogICAgfSk7CiAgICB0aGlzLm5leHRJZCA9IDE7CiAgICB0aGlzLl9zaXplID0gMDsKICAgIHRoaXMucm9vdFBvaW50ZXIgPSB0aGlzLl9zYXZlTm9kZShyb290Tm9kZSk7CiAgICB0aGlzLl93cml0ZU1ldGFkYXRhKCk7CiAgfQogIC8qKgogICAqIFdyaXRlIG1ldGFkYXRhIHJlY29yZCB0byBmaWxlCiAgICovCiAgX3dyaXRlTWV0YWRhdGEoKSB7CiAgICBjb25zdCBtZXRhZGF0YSA9IHsKICAgICAgdmVyc2lvbjogMSwKICAgICAgbWF4RW50cmllczogdGhpcy5tYXhFbnRyaWVzLAogICAgICBtaW5FbnRyaWVzOiB0aGlzLm1pbkVudHJpZXMsCiAgICAgIHNpemU6IHRoaXMuX3NpemUsCiAgICAgIHJvb3RQb2ludGVyOiB0aGlzLnJvb3RQb2ludGVyLAogICAgICBuZXh0SWQ6IHRoaXMubmV4dElkCiAgICB9OwogICAgdGhpcy5maWxlLmFwcGVuZChtZXRhZGF0YSk7CiAgfQogIC8qKgogICAqIExvYWQgdHJlZSBmcm9tIGV4aXN0aW5nIGZpbGUKICAgKi8KICBfbG9hZEZyb21GaWxlKCkgewogICAgY29uc3QgTUVUQURBVEFfU0laRSA9IDEzNTsKICAgIGNvbnN0IGZpbGVTaXplID0gdGhpcy5maWxlLmdldEZpbGVTaXplKCk7CiAgICBpZiAoZmlsZVNpemUgPCBNRVRBREFUQV9TSVpFKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBSLXRyZWUgZmlsZSBmb3JtYXQ6IGZpbGUgdG9vIHNtYWxsIGZvciBtZXRhZGF0YSIpOwogICAgfQogICAgY29uc3QgbWV0YWRhdGFPZmZzZXQgPSBmaWxlU2l6ZSAtIE1FVEFEQVRBX1NJWkU7CiAgICBjb25zdCBtZXRhZGF0YSA9IHRoaXMuZmlsZS5yZWFkKG1ldGFkYXRhT2Zmc2V0KTsKICAgIHRoaXMubWF4RW50cmllcyA9IG1ldGFkYXRhLm1heEVudHJpZXM7CiAgICB0aGlzLm1pbkVudHJpZXMgPSBtZXRhZGF0YS5taW5FbnRyaWVzOwogICAgdGhpcy5fc2l6ZSA9IG1ldGFkYXRhLnNpemU7CiAgICB0aGlzLnJvb3RQb2ludGVyID0gbWV0YWRhdGEucm9vdFBvaW50ZXI7CiAgICB0aGlzLm5leHRJZCA9IG1ldGFkYXRhLm5leHRJZDsKICB9CiAgLyoqCiAgICogU2F2ZSBhIG5vZGUgdG8gZGlzayBhbmQgcmV0dXJuIGl0cyBQb2ludGVyCiAgICovCiAgX3NhdmVOb2RlKG5vZGUpIHsKICAgIGNvbnN0IG5vZGVEYXRhID0gbm9kZS50b0pTT04oKTsKICAgIGNvbnN0IG9mZnNldCA9IHRoaXMuZmlsZS5nZXRGaWxlU2l6ZSgpOwogICAgdGhpcy5maWxlLmFwcGVuZChub2RlRGF0YSk7CiAgICByZXR1cm4gbmV3IFBvaW50ZXIob2Zmc2V0KTsKICB9CiAgLyoqCiAgICogTG9hZCBhIG5vZGUgZnJvbSBkaXNrIGJ5IFBvaW50ZXIKICAgKi8KICBfbG9hZE5vZGUocG9pbnRlcikgewogICAgaWYgKCEocG9pbnRlciBpbnN0YW5jZW9mIFBvaW50ZXIpKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgUG9pbnRlciBvYmplY3QiKTsKICAgIH0KICAgIGNvbnN0IG9mZnNldCA9IHBvaW50ZXIudmFsdWVPZigpOwogICAgY29uc3Qgbm9kZURhdGEgPSB0aGlzLmZpbGUucmVhZChvZmZzZXQpOwogICAgcmV0dXJuIG5ldyBSVHJlZU5vZGUodGhpcywgbm9kZURhdGEpOwogIH0KICAvKioKICAgKiBMb2FkIHRoZSByb290IG5vZGUKICAgKi8KICBfbG9hZFJvb3QoKSB7CiAgICByZXR1cm4gdGhpcy5fbG9hZE5vZGUodGhpcy5yb290UG9pbnRlcik7CiAgfQogIC8qKgogICAqIEluc2VydCBhIHBvaW50IGludG8gdGhlIFItdHJlZSB3aXRoIGFuIE9iamVjdElkCiAgICovCiAgaW5zZXJ0KGxhdCwgbG5nLCBvYmplY3RJZCkgewogICAgaWYgKCF0aGlzLmlzT3BlbikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlItdHJlZSBmaWxlIG11c3QgYmUgb3BlbmVkIGJlZm9yZSB1c2UiKTsKICAgIH0KICAgIGlmICghKG9iamVjdElkIGluc3RhbmNlb2YgT2JqZWN0SWQpKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigib2JqZWN0SWQgbXVzdCBiZSBhbiBpbnN0YW5jZSBvZiBPYmplY3RJZCB0byBpbnNlcnQgaW50byBydHJlZSIpOwogICAgfQogICAgY29uc3QgYmJveCA9IHsKICAgICAgbWluTGF0OiBsYXQsCiAgICAgIG1heExhdDogbGF0LAogICAgICBtaW5Mbmc6IGxuZywKICAgICAgbWF4TG5nOiBsbmcKICAgIH07CiAgICBjb25zdCBlbnRyeSA9IHsgYmJveCwgbGF0LCBsbmcsIG9iamVjdElkIH07CiAgICBjb25zdCByb290ID0gdGhpcy5fbG9hZFJvb3QoKTsKICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuX2luc2VydChlbnRyeSwgcm9vdCwgMSk7CiAgICBpZiAocmVzdWx0LnNwbGl0KSB7CiAgICAgIGNvbnN0IG5ld1Jvb3QgPSBuZXcgUlRyZWVOb2RlKHRoaXMsIHsKICAgICAgICBpZDogdGhpcy5uZXh0SWQrKywKICAgICAgICBpc0xlYWY6IGZhbHNlLAogICAgICAgIGNoaWxkcmVuOiByZXN1bHQucG9pbnRlcnMsCiAgICAgICAgYmJveDogbnVsbAogICAgICB9KTsKICAgICAgbmV3Um9vdC51cGRhdGVCQm94KCk7CiAgICAgIHRoaXMucm9vdFBvaW50ZXIgPSB0aGlzLl9zYXZlTm9kZShuZXdSb290KTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMucm9vdFBvaW50ZXIgPSByZXN1bHQucG9pbnRlcjsKICAgIH0KICAgIHRoaXMuX3NpemUrKzsKICAgIHRoaXMuX3dyaXRlTWV0YWRhdGEoKTsKICB9CiAgLyoqCiAgICogSW50ZXJuYWwgaW5zZXJ0IG1ldGhvZCAtIHJldHVybnMgc3BsaXRQb2ludGVycyBpZiBzcGxpdCBvY2N1cnJlZCwgZWxzZSByZXR1cm5zIHVwZGF0ZWQgbm9kZSBwb2ludGVyCiAgICovCiAgX2luc2VydChlbnRyeSwgbm9kZSwgbGV2ZWwpIHsKICAgIGlmIChub2RlLmlzTGVhZikgewogICAgICBub2RlLmNoaWxkcmVuLnB1c2goZW50cnkpOwogICAgICBub2RlLnVwZGF0ZUJCb3goKTsKICAgICAgaWYgKG5vZGUuY2hpbGRyZW4ubGVuZ3RoID4gdGhpcy5tYXhFbnRyaWVzKSB7CiAgICAgICAgY29uc3QgW3BvaW50ZXIxLCBwb2ludGVyMl0gPSB0aGlzLl9zcGxpdChub2RlKTsKICAgICAgICByZXR1cm4geyBzcGxpdDogdHJ1ZSwgcG9pbnRlcnM6IFtwb2ludGVyMSwgcG9pbnRlcjJdIH07CiAgICAgIH0KICAgICAgY29uc3QgcG9pbnRlciA9IHRoaXMuX3NhdmVOb2RlKG5vZGUpOwogICAgICByZXR1cm4geyBzcGxpdDogZmFsc2UsIHBvaW50ZXIgfTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IHRhcmdldFBvaW50ZXIgPSB0aGlzLl9jaG9vc2VTdWJ0cmVlKGVudHJ5LmJib3gsIG5vZGUpOwogICAgICBjb25zdCB0YXJnZXROb2RlID0gdGhpcy5fbG9hZE5vZGUodGFyZ2V0UG9pbnRlcik7CiAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuX2luc2VydChlbnRyeSwgdGFyZ2V0Tm9kZSwgbGV2ZWwgKyAxKTsKICAgICAgaWYgKHJlc3VsdC5zcGxpdCkgewogICAgICAgIGxldCBjaGlsZEluZGV4ID0gLTE7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAobm9kZS5jaGlsZHJlbltpXS52YWx1ZU9mKCkgPT09IHRhcmdldFBvaW50ZXIudmFsdWVPZigpKSB7CiAgICAgICAgICAgIGNoaWxkSW5kZXggPSBpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGNoaWxkSW5kZXggIT09IC0xKSB7CiAgICAgICAgICBub2RlLmNoaWxkcmVuW2NoaWxkSW5kZXhdID0gcmVzdWx0LnBvaW50ZXJzWzBdOwogICAgICAgICAgbm9kZS5jaGlsZHJlbi5wdXNoKHJlc3VsdC5wb2ludGVyc1sxXSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG5vZGUuY2hpbGRyZW4ucHVzaChyZXN1bHQucG9pbnRlcnNbMF0pOwogICAgICAgICAgbm9kZS5jaGlsZHJlbi5wdXNoKHJlc3VsdC5wb2ludGVyc1sxXSk7CiAgICAgICAgfQogICAgICAgIG5vZGUudXBkYXRlQkJveCgpOwogICAgICAgIGlmIChub2RlLmNoaWxkcmVuLmxlbmd0aCA+IHRoaXMubWF4RW50cmllcykgewogICAgICAgICAgY29uc3QgW3BvaW50ZXIxLCBwb2ludGVyMl0gPSB0aGlzLl9zcGxpdChub2RlKTsKICAgICAgICAgIHJldHVybiB7IHNwbGl0OiB0cnVlLCBwb2ludGVyczogW3BvaW50ZXIxLCBwb2ludGVyMl0gfTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbGV0IGNoaWxkSW5kZXggPSAtMTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChub2RlLmNoaWxkcmVuW2ldLnZhbHVlT2YoKSA9PT0gdGFyZ2V0UG9pbnRlci52YWx1ZU9mKCkpIHsKICAgICAgICAgICAgY2hpbGRJbmRleCA9IGk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoY2hpbGRJbmRleCAhPT0gLTEpIHsKICAgICAgICAgIG5vZGUuY2hpbGRyZW5bY2hpbGRJbmRleF0gPSByZXN1bHQucG9pbnRlcjsKICAgICAgICB9CiAgICAgICAgbm9kZS51cGRhdGVCQm94KCk7CiAgICAgIH0KICAgICAgY29uc3QgcG9pbnRlciA9IHRoaXMuX3NhdmVOb2RlKG5vZGUpOwogICAgICByZXR1cm4geyBzcGxpdDogZmFsc2UsIHBvaW50ZXIgfTsKICAgIH0KICB9CiAgLyoqCiAgICogQ2hvb3NlIHRoZSBiZXN0IHN1YnRyZWUgdG8gaW5zZXJ0IGFuIGVudHJ5CiAgICovCiAgX2Nob29zZVN1YnRyZWUoYmJveCwgbm9kZSkgewogICAgbGV0IG1pbkVubGFyZ2VtZW50ID0gSW5maW5pdHk7CiAgICBsZXQgbWluQXJlYSA9IEluZmluaXR5OwogICAgbGV0IHRhcmdldFBvaW50ZXIgPSBudWxsOwogICAgZm9yIChjb25zdCBjaGlsZFBvaW50ZXIgb2Ygbm9kZS5jaGlsZHJlbikgewogICAgICBpZiAoIShjaGlsZFBvaW50ZXIgaW5zdGFuY2VvZiBQb2ludGVyKSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgUG9pbnRlciBpbiBfY2hvb3NlU3VidHJlZSwgZ290OiAke3R5cGVvZiBjaGlsZFBvaW50ZXJ9YCk7CiAgICAgIH0KICAgICAgY29uc3QgY2hpbGROb2RlID0gdGhpcy5fbG9hZE5vZGUoY2hpbGRQb2ludGVyKTsKICAgICAgY29uc3QgZW5sID0gZW5sYXJnZW1lbnQoY2hpbGROb2RlLmJib3gsIGJib3gpOwogICAgICBjb25zdCBhciA9IGFyZWEoY2hpbGROb2RlLmJib3gpOwogICAgICBpZiAoZW5sIDwgbWluRW5sYXJnZW1lbnQgfHwgZW5sID09PSBtaW5FbmxhcmdlbWVudCAmJiBhciA8IG1pbkFyZWEpIHsKICAgICAgICBtaW5FbmxhcmdlbWVudCA9IGVubDsKICAgICAgICBtaW5BcmVhID0gYXI7CiAgICAgICAgdGFyZ2V0UG9pbnRlciA9IGNoaWxkUG9pbnRlcjsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRhcmdldFBvaW50ZXI7CiAgfQogIC8qKgogICAqIFNwbGl0IGFuIG92ZXJmbG93aW5nIG5vZGUKICAgKi8KICBfc3BsaXQobm9kZSkgewogICAgY29uc3QgY2hpbGRyZW4gPSBub2RlLmNoaWxkcmVuOwogICAgY29uc3QgaXNMZWFmID0gbm9kZS5pc0xlYWY7CiAgICBsZXQgbWF4RGlzdCA9IC1JbmZpbml0eTsKICAgIGxldCBzZWVkMUlkeCA9IDAsIHNlZWQySWR4ID0gMTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgZm9yIChsZXQgaiA9IGkgKyAxOyBqIDwgY2hpbGRyZW4ubGVuZ3RoOyBqKyspIHsKICAgICAgICBsZXQgYmJveDEsIGJib3gyOwogICAgICAgIGlmIChpc0xlYWYpIHsKICAgICAgICAgIGJib3gxID0gY2hpbGRyZW5baV0uYmJveDsKICAgICAgICAgIGJib3gyID0gY2hpbGRyZW5bal0uYmJveDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3Qgbm9kZTEyID0gdGhpcy5fbG9hZE5vZGUoY2hpbGRyZW5baV0pOwogICAgICAgICAgY29uc3Qgbm9kZTIyID0gdGhpcy5fbG9hZE5vZGUoY2hpbGRyZW5bal0pOwogICAgICAgICAgYmJveDEgPSBub2RlMTIuYmJveDsKICAgICAgICAgIGJib3gyID0gbm9kZTIyLmJib3g7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGRpc3QgPSBhcmVhKHVuaW9uKGJib3gxLCBiYm94MikpOwogICAgICAgIGlmIChkaXN0ID4gbWF4RGlzdCkgewogICAgICAgICAgbWF4RGlzdCA9IGRpc3Q7CiAgICAgICAgICBzZWVkMUlkeCA9IGk7CiAgICAgICAgICBzZWVkMklkeCA9IGo7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBjb25zdCBub2RlMSA9IG5ldyBSVHJlZU5vZGUodGhpcywgewogICAgICBpZDogdGhpcy5uZXh0SWQrKywKICAgICAgaXNMZWFmLAogICAgICBjaGlsZHJlbjogW2NoaWxkcmVuW3NlZWQxSWR4XV0sCiAgICAgIGJib3g6IG51bGwKICAgIH0pOwogICAgY29uc3Qgbm9kZTIgPSBuZXcgUlRyZWVOb2RlKHRoaXMsIHsKICAgICAgaWQ6IHRoaXMubmV4dElkKyssCiAgICAgIGlzTGVhZiwKICAgICAgY2hpbGRyZW46IFtjaGlsZHJlbltzZWVkMklkeF1dLAogICAgICBiYm94OiBudWxsCiAgICB9KTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKGkgPT09IHNlZWQxSWR4IHx8IGkgPT09IHNlZWQySWR4KSBjb250aW51ZTsKICAgICAgY29uc3QgY2hpbGQgPSBjaGlsZHJlbltpXTsKICAgICAgbGV0IGJib3g7CiAgICAgIGlmIChpc0xlYWYpIHsKICAgICAgICBiYm94ID0gY2hpbGQuYmJveDsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBjaGlsZE5vZGUgPSB0aGlzLl9sb2FkTm9kZShjaGlsZCk7CiAgICAgICAgYmJveCA9IGNoaWxkTm9kZS5iYm94OwogICAgICB9CiAgICAgIG5vZGUxLnVwZGF0ZUJCb3goKTsKICAgICAgbm9kZTIudXBkYXRlQkJveCgpOwogICAgICBjb25zdCBlbmwxID0gbm9kZTEuYmJveCA/IGVubGFyZ2VtZW50KG5vZGUxLmJib3gsIGJib3gpIDogMDsKICAgICAgY29uc3QgZW5sMiA9IG5vZGUyLmJib3ggPyBlbmxhcmdlbWVudChub2RlMi5iYm94LCBiYm94KSA6IDA7CiAgICAgIGlmIChlbmwxIDwgZW5sMikgewogICAgICAgIG5vZGUxLmNoaWxkcmVuLnB1c2goY2hpbGQpOwogICAgICB9IGVsc2UgaWYgKGVubDIgPCBlbmwxKSB7CiAgICAgICAgbm9kZTIuY2hpbGRyZW4ucHVzaChjaGlsZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKG5vZGUxLmNoaWxkcmVuLmxlbmd0aCA8PSBub2RlMi5jaGlsZHJlbi5sZW5ndGgpIHsKICAgICAgICAgIG5vZGUxLmNoaWxkcmVuLnB1c2goY2hpbGQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBub2RlMi5jaGlsZHJlbi5wdXNoKGNoaWxkKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIG5vZGUxLnVwZGF0ZUJCb3goKTsKICAgIG5vZGUyLnVwZGF0ZUJCb3goKTsKICAgIGNvbnN0IHBvaW50ZXIxID0gdGhpcy5fc2F2ZU5vZGUobm9kZTEpOwogICAgY29uc3QgcG9pbnRlcjIgPSB0aGlzLl9zYXZlTm9kZShub2RlMik7CiAgICByZXR1cm4gW3BvaW50ZXIxLCBwb2ludGVyMl07CiAgfQogIC8qKgogICAqIFNlYXJjaCBmb3IgcG9pbnRzIHdpdGhpbiBhIGJvdW5kaW5nIGJveCwgcmV0dXJuaW5nIGVudHJpZXMgd2l0aCBjb29yZHMKICAgKi8KICBzZWFyY2hCQm94KGJib3gpIHsKICAgIGlmICghdGhpcy5pc09wZW4pIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJSLXRyZWUgZmlsZSBtdXN0IGJlIG9wZW5lZCBiZWZvcmUgdXNlIik7CiAgICB9CiAgICBjb25zdCByZXN1bHRzID0gW107CiAgICBjb25zdCByb290ID0gdGhpcy5fbG9hZFJvb3QoKTsKICAgIHRoaXMuX3NlYXJjaEJCb3goYmJveCwgcm9vdCwgcmVzdWx0cyk7CiAgICByZXR1cm4gcmVzdWx0czsKICB9CiAgLyoqCiAgICogSW50ZXJuYWwgYm91bmRpbmcgYm94IHNlYXJjaAogICAqLwogIF9zZWFyY2hCQm94KGJib3gsIG5vZGUsIHJlc3VsdHMpIHsKICAgIGlmICghbm9kZS5iYm94IHx8ICFpbnRlcnNlY3RzKGJib3gsIG5vZGUuYmJveCkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKG5vZGUuaXNMZWFmKSB7CiAgICAgIGZvciAoY29uc3QgZW50cnkgb2Ygbm9kZS5jaGlsZHJlbikgewogICAgICAgIGlmIChpbnRlcnNlY3RzKGJib3gsIGVudHJ5LmJib3gpKSB7CiAgICAgICAgICByZXN1bHRzLnB1c2goewogICAgICAgICAgICBvYmplY3RJZDogZW50cnkub2JqZWN0SWQsCiAgICAgICAgICAgIGxhdDogZW50cnkubGF0LAogICAgICAgICAgICBsbmc6IGVudHJ5LmxuZwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBmb3IgKGNvbnN0IGNoaWxkUG9pbnRlciBvZiBub2RlLmNoaWxkcmVuKSB7CiAgICAgICAgY29uc3QgY2hpbGROb2RlID0gdGhpcy5fbG9hZE5vZGUoY2hpbGRQb2ludGVyKTsKICAgICAgICB0aGlzLl9zZWFyY2hCQm94KGJib3gsIGNoaWxkTm9kZSwgcmVzdWx0cyk7CiAgICAgIH0KICAgIH0KICB9CiAgLyoqCiAgICogU2VhcmNoIGZvciBwb2ludHMgd2l0aGluIGEgcmFkaXVzIG9mIGEgbG9jYXRpb24sIHJldHVybmluZyBPYmplY3RJZHMgd2l0aCBkaXN0YW5jZXMKICAgKi8KICBzZWFyY2hSYWRpdXMobGF0LCBsbmcsIHJhZGl1c0ttKSB7CiAgICBjb25zdCBiYm94ID0gcmFkaXVzVG9Cb3VuZGluZ0JveChsYXQsIGxuZywgcmFkaXVzS20pOwogICAgY29uc3Qgcm9vdCA9IHRoaXMuX2xvYWRSb290KCk7CiAgICBjb25zdCBlbnRyaWVzID0gW107CiAgICB0aGlzLl9zZWFyY2hCQm94RW50cmllcyhiYm94LCByb290LCBlbnRyaWVzKTsKICAgIGNvbnN0IHJlc3VsdHMgPSBbXTsKICAgIGZvciAoY29uc3QgZW50cnkgb2YgZW50cmllcykgewogICAgICBjb25zdCBkaXN0ID0gaGF2ZXJzaW5lRGlzdGFuY2UobGF0LCBsbmcsIGVudHJ5LmxhdCwgZW50cnkubG5nKTsKICAgICAgaWYgKGRpc3QgPD0gcmFkaXVzS20pIHsKICAgICAgICByZXN1bHRzLnB1c2goewogICAgICAgICAgb2JqZWN0SWQ6IGVudHJ5Lm9iamVjdElkLAogICAgICAgICAgbGF0OiBlbnRyeS5sYXQsCiAgICAgICAgICBsbmc6IGVudHJ5LmxuZywKICAgICAgICAgIGRpc3RhbmNlOiBkaXN0CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH0KICAvKioKICAgKiBJbnRlcm5hbCBib3VuZGluZyBib3ggc2VhcmNoIHRoYXQgcmV0dXJucyBmdWxsIGVudHJpZXMgKHVzZWQgYnkgcmFkaXVzIHNlYXJjaCkKICAgKi8KICBfc2VhcmNoQkJveEVudHJpZXMoYmJveCwgbm9kZSwgcmVzdWx0cykgewogICAgaWYgKCFub2RlLmJib3ggfHwgIWludGVyc2VjdHMoYmJveCwgbm9kZS5iYm94KSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAobm9kZS5pc0xlYWYpIHsKICAgICAgZm9yIChjb25zdCBlbnRyeSBvZiBub2RlLmNoaWxkcmVuKSB7CiAgICAgICAgaWYgKGludGVyc2VjdHMoYmJveCwgZW50cnkuYmJveCkpIHsKICAgICAgICAgIHJlc3VsdHMucHVzaChlbnRyeSk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBmb3IgKGNvbnN0IGNoaWxkUG9pbnRlciBvZiBub2RlLmNoaWxkcmVuKSB7CiAgICAgICAgY29uc3QgY2hpbGROb2RlID0gdGhpcy5fbG9hZE5vZGUoY2hpbGRQb2ludGVyKTsKICAgICAgICB0aGlzLl9zZWFyY2hCQm94RW50cmllcyhiYm94LCBjaGlsZE5vZGUsIHJlc3VsdHMpOwogICAgICB9CiAgICB9CiAgfQogIC8qKgogICAqIFJlbW92ZSBhbiBlbnRyeSBmcm9tIHRoZSBSLXRyZWUgYnkgT2JqZWN0SWQKICAgKi8KICByZW1vdmUob2JqZWN0SWQpIHsKICAgIGlmICghdGhpcy5pc09wZW4pIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJSLXRyZWUgZmlsZSBtdXN0IGJlIG9wZW5lZCBiZWZvcmUgdXNlIik7CiAgICB9CiAgICBpZiAoIShvYmplY3RJZCBpbnN0YW5jZW9mIE9iamVjdElkKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIm9iamVjdElkIG11c3QgYmUgYW4gaW5zdGFuY2Ugb2YgT2JqZWN0SWQgdG8gcmVtb3ZlIGZyb20gcnRyZWUiKTsKICAgIH0KICAgIGNvbnN0IHJvb3QgPSB0aGlzLl9sb2FkUm9vdCgpOwogICAgY29uc3QgcmVzdWx0ID0gdGhpcy5fcmVtb3ZlKG9iamVjdElkLCByb290KTsKICAgIGlmICghcmVzdWx0LmZvdW5kKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGlmIChyZXN1bHQudW5kZXJmbG93ICYmIHJlc3VsdC5jaGlsZHJlbikgewogICAgICBpZiAocmVzdWx0LmNoaWxkcmVuLmxlbmd0aCA9PT0gMCkgewogICAgICAgIGNvbnN0IG5ld1Jvb3QgPSBuZXcgUlRyZWVOb2RlKHRoaXMsIHsKICAgICAgICAgIGlkOiB0aGlzLm5leHRJZCsrLAogICAgICAgICAgaXNMZWFmOiB0cnVlLAogICAgICAgICAgY2hpbGRyZW46IFtdLAogICAgICAgICAgYmJveDogbnVsbAogICAgICAgIH0pOwogICAgICAgIHRoaXMucm9vdFBvaW50ZXIgPSB0aGlzLl9zYXZlTm9kZShuZXdSb290KTsKICAgICAgfSBlbHNlIGlmIChyZXN1bHQuY2hpbGRyZW4ubGVuZ3RoID09PSAxICYmICFyZXN1bHQuaXNMZWFmKSB7CiAgICAgICAgdGhpcy5yb290UG9pbnRlciA9IHJlc3VsdC5jaGlsZHJlblswXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBuZXdSb290ID0gbmV3IFJUcmVlTm9kZSh0aGlzLCB7CiAgICAgICAgICBpZDogcm9vdC5pZCwKICAgICAgICAgIGlzTGVhZjogcmVzdWx0LmlzTGVhZiwKICAgICAgICAgIGNoaWxkcmVuOiByZXN1bHQuY2hpbGRyZW4sCiAgICAgICAgICBiYm94OiBudWxsCiAgICAgICAgfSk7CiAgICAgICAgbmV3Um9vdC51cGRhdGVCQm94KCk7CiAgICAgICAgdGhpcy5yb290UG9pbnRlciA9IHRoaXMuX3NhdmVOb2RlKG5ld1Jvb3QpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKHJlc3VsdC5wb2ludGVyKSB7CiAgICAgIHRoaXMucm9vdFBvaW50ZXIgPSByZXN1bHQucG9pbnRlcjsKICAgIH0KICAgIHRoaXMuX3NpemUtLTsKICAgIHRoaXMuX3dyaXRlTWV0YWRhdGEoKTsKICAgIHJldHVybiB0cnVlOwogIH0KICAvKioKICAgKiBJbnRlcm5hbCByZW1vdmUgbWV0aG9kCiAgICogUmV0dXJuczogeyBmb3VuZDogYm9vbGVhbiwgdW5kZXJmbG93OiBib29sZWFuLCBwb2ludGVyOiBQb2ludGVyLCBjaGlsZHJlbjogQXJyYXksIGlzTGVhZjogYm9vbGVhbiB9CiAgICovCiAgX3JlbW92ZShvYmplY3RJZCwgbm9kZSkgewogICAgaWYgKG5vZGUuaXNMZWFmKSB7CiAgICAgIGNvbnN0IGluaXRpYWxMZW5ndGggPSBub2RlLmNoaWxkcmVuLmxlbmd0aDsKICAgICAgbm9kZS5jaGlsZHJlbiA9IG5vZGUuY2hpbGRyZW4uZmlsdGVyKAogICAgICAgIChlbnRyeSkgPT4gIWVudHJ5Lm9iamVjdElkLmVxdWFscyhvYmplY3RJZCkKICAgICAgKTsKICAgICAgaWYgKG5vZGUuY2hpbGRyZW4ubGVuZ3RoID09PSBpbml0aWFsTGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIHsgZm91bmQ6IGZhbHNlIH07CiAgICAgIH0KICAgICAgbm9kZS51cGRhdGVCQm94KCk7CiAgICAgIGNvbnN0IHBvaW50ZXIgPSB0aGlzLl9zYXZlTm9kZShub2RlKTsKICAgICAgY29uc3QgdW5kZXJmbG93ID0gbm9kZS5jaGlsZHJlbi5sZW5ndGggPCB0aGlzLm1pbkVudHJpZXMgJiYgbm9kZS5jaGlsZHJlbi5sZW5ndGggPiAwOwogICAgICByZXR1cm4gewogICAgICAgIGZvdW5kOiB0cnVlLAogICAgICAgIHVuZGVyZmxvdywKICAgICAgICBwb2ludGVyLAogICAgICAgIGNoaWxkcmVuOiBub2RlLmNoaWxkcmVuLAogICAgICAgIGlzTGVhZjogdHJ1ZQogICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgbGV0IHVwZGF0ZWRDaGlsZHJlbiA9IFsuLi5ub2RlLmNoaWxkcmVuXTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB1cGRhdGVkQ2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBjaGlsZFBvaW50ZXIgPSB1cGRhdGVkQ2hpbGRyZW5baV07CiAgICAgICAgY29uc3QgY2hpbGROb2RlID0gdGhpcy5fbG9hZE5vZGUoY2hpbGRQb2ludGVyKTsKICAgICAgICBjb25zdCByZXN1bHQgPSB0aGlzLl9yZW1vdmUob2JqZWN0SWQsIGNoaWxkTm9kZSk7CiAgICAgICAgaWYgKHJlc3VsdC5mb3VuZCkgewogICAgICAgICAgaWYgKHJlc3VsdC51bmRlcmZsb3cpIHsKICAgICAgICAgICAgY29uc3QgaGFuZGxlZCA9IHRoaXMuX2hhbmRsZVVuZGVyZmxvdyhub2RlLCBpLCBjaGlsZE5vZGUsIHJlc3VsdCk7CiAgICAgICAgICAgIGlmIChoYW5kbGVkLm1lcmdlZCkgewogICAgICAgICAgICAgIHVwZGF0ZWRDaGlsZHJlbiA9IGhhbmRsZWQuY2hpbGRyZW47CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdXBkYXRlZENoaWxkcmVuW2ldID0gcmVzdWx0LnBvaW50ZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVwZGF0ZWRDaGlsZHJlbltpXSA9IHJlc3VsdC5wb2ludGVyOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgdXBkYXRlZE5vZGUgPSBuZXcgUlRyZWVOb2RlKHRoaXMsIHsKICAgICAgICAgICAgaWQ6IG5vZGUuaWQsCiAgICAgICAgICAgIGlzTGVhZjogZmFsc2UsCiAgICAgICAgICAgIGNoaWxkcmVuOiB1cGRhdGVkQ2hpbGRyZW4sCiAgICAgICAgICAgIGJib3g6IG51bGwKICAgICAgICAgIH0pOwogICAgICAgICAgdXBkYXRlZE5vZGUudXBkYXRlQkJveCgpOwogICAgICAgICAgY29uc3QgcG9pbnRlciA9IHRoaXMuX3NhdmVOb2RlKHVwZGF0ZWROb2RlKTsKICAgICAgICAgIGNvbnN0IHVuZGVyZmxvdyA9IHVwZGF0ZWRDaGlsZHJlbi5sZW5ndGggPCB0aGlzLm1pbkVudHJpZXMgJiYgdXBkYXRlZENoaWxkcmVuLmxlbmd0aCA+IDA7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBmb3VuZDogdHJ1ZSwKICAgICAgICAgICAgdW5kZXJmbG93LAogICAgICAgICAgICBwb2ludGVyLAogICAgICAgICAgICBjaGlsZHJlbjogdXBkYXRlZENoaWxkcmVuLAogICAgICAgICAgICBpc0xlYWY6IGZhbHNlCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4geyBmb3VuZDogZmFsc2UgfTsKICAgIH0KICB9CiAgLyoqCiAgICogSGFuZGxlIHVuZGVyZmxvdyBpbiBhIGNoaWxkIG5vZGUgYnkgbWVyZ2luZyBvciByZWRpc3RyaWJ1dGluZwogICAqLwogIF9oYW5kbGVVbmRlcmZsb3cocGFyZW50Tm9kZSwgY2hpbGRJbmRleCwgY2hpbGROb2RlLCBjaGlsZFJlc3VsdCkgewogICAgY29uc3Qgc2libGluZ3MgPSBbXTsKICAgIGlmIChjaGlsZEluZGV4ID4gMCkgewogICAgICBjb25zdCBwcmV2UG9pbnRlciA9IHBhcmVudE5vZGUuY2hpbGRyZW5bY2hpbGRJbmRleCAtIDFdOwogICAgICBjb25zdCBwcmV2Tm9kZSA9IHRoaXMuX2xvYWROb2RlKHByZXZQb2ludGVyKTsKICAgICAgc2libGluZ3MucHVzaCh7IGluZGV4OiBjaGlsZEluZGV4IC0gMSwgbm9kZTogcHJldk5vZGUsIHBvaW50ZXI6IHByZXZQb2ludGVyIH0pOwogICAgfQogICAgaWYgKGNoaWxkSW5kZXggPCBwYXJlbnROb2RlLmNoaWxkcmVuLmxlbmd0aCAtIDEpIHsKICAgICAgY29uc3QgbmV4dFBvaW50ZXIgPSBwYXJlbnROb2RlLmNoaWxkcmVuW2NoaWxkSW5kZXggKyAxXTsKICAgICAgY29uc3QgbmV4dE5vZGUgPSB0aGlzLl9sb2FkTm9kZShuZXh0UG9pbnRlcik7CiAgICAgIHNpYmxpbmdzLnB1c2goeyBpbmRleDogY2hpbGRJbmRleCArIDEsIG5vZGU6IG5leHROb2RlLCBwb2ludGVyOiBuZXh0UG9pbnRlciB9KTsKICAgIH0KICAgIGZvciAoY29uc3Qgc2libGluZyBvZiBzaWJsaW5ncykgewogICAgICBpZiAoc2libGluZy5ub2RlLmNoaWxkcmVuLmxlbmd0aCA+IHRoaXMubWluRW50cmllcykgewogICAgICAgIGNvbnN0IGFsbENoaWxkcmVuID0gWwogICAgICAgICAgLi4uY2hpbGRSZXN1bHQuY2hpbGRyZW4sCiAgICAgICAgICAuLi5zaWJsaW5nLm5vZGUuY2hpbGRyZW4KICAgICAgICBdOwogICAgICAgIGNvbnN0IG1pZCA9IE1hdGguY2VpbChhbGxDaGlsZHJlbi5sZW5ndGggLyAyKTsKICAgICAgICBjb25zdCBuZXdDaGlsZDFDaGlsZHJlbiA9IGFsbENoaWxkcmVuLnNsaWNlKDAsIG1pZCk7CiAgICAgICAgY29uc3QgbmV3Q2hpbGQyQ2hpbGRyZW4gPSBhbGxDaGlsZHJlbi5zbGljZShtaWQpOwogICAgICAgIGNvbnN0IG5ld0NoaWxkMSA9IG5ldyBSVHJlZU5vZGUodGhpcywgewogICAgICAgICAgaWQ6IGNoaWxkTm9kZS5pZCwKICAgICAgICAgIGlzTGVhZjogY2hpbGRSZXN1bHQuaXNMZWFmLAogICAgICAgICAgY2hpbGRyZW46IG5ld0NoaWxkMUNoaWxkcmVuLAogICAgICAgICAgYmJveDogbnVsbAogICAgICAgIH0pOwogICAgICAgIG5ld0NoaWxkMS51cGRhdGVCQm94KCk7CiAgICAgICAgY29uc3QgbmV3Q2hpbGQyID0gbmV3IFJUcmVlTm9kZSh0aGlzLCB7CiAgICAgICAgICBpZDogc2libGluZy5ub2RlLmlkLAogICAgICAgICAgaXNMZWFmOiBzaWJsaW5nLm5vZGUuaXNMZWFmLAogICAgICAgICAgY2hpbGRyZW46IG5ld0NoaWxkMkNoaWxkcmVuLAogICAgICAgICAgYmJveDogbnVsbAogICAgICAgIH0pOwogICAgICAgIG5ld0NoaWxkMi51cGRhdGVCQm94KCk7CiAgICAgICAgY29uc3QgcG9pbnRlcjEgPSB0aGlzLl9zYXZlTm9kZShuZXdDaGlsZDEpOwogICAgICAgIGNvbnN0IHBvaW50ZXIyID0gdGhpcy5fc2F2ZU5vZGUobmV3Q2hpbGQyKTsKICAgICAgICBjb25zdCBuZXdDaGlsZHJlbiA9IFsuLi5wYXJlbnROb2RlLmNoaWxkcmVuXTsKICAgICAgICBjb25zdCBtaW5JbmRleCA9IE1hdGgubWluKGNoaWxkSW5kZXgsIHNpYmxpbmcuaW5kZXgpOwogICAgICAgIGNvbnN0IG1heEluZGV4ID0gTWF0aC5tYXgoY2hpbGRJbmRleCwgc2libGluZy5pbmRleCk7CiAgICAgICAgbmV3Q2hpbGRyZW5bbWluSW5kZXhdID0gcG9pbnRlcjE7CiAgICAgICAgbmV3Q2hpbGRyZW5bbWF4SW5kZXhdID0gcG9pbnRlcjI7CiAgICAgICAgcmV0dXJuIHsgbWVyZ2VkOiB0cnVlLCBjaGlsZHJlbjogbmV3Q2hpbGRyZW4gfTsKICAgICAgfQogICAgfQogICAgaWYgKHNpYmxpbmdzLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3Qgc2libGluZyA9IHNpYmxpbmdzWzBdOwogICAgICBjb25zdCBtZXJnZWRDaGlsZHJlbiA9IFsKICAgICAgICAuLi5jaGlsZFJlc3VsdC5jaGlsZHJlbiwKICAgICAgICAuLi5zaWJsaW5nLm5vZGUuY2hpbGRyZW4KICAgICAgXTsKICAgICAgY29uc3QgbWVyZ2VkTm9kZSA9IG5ldyBSVHJlZU5vZGUodGhpcywgewogICAgICAgIGlkOiB0aGlzLm5leHRJZCsrLAogICAgICAgIGlzTGVhZjogY2hpbGRSZXN1bHQuaXNMZWFmLAogICAgICAgIGNoaWxkcmVuOiBtZXJnZWRDaGlsZHJlbiwKICAgICAgICBiYm94OiBudWxsCiAgICAgIH0pOwogICAgICBtZXJnZWROb2RlLnVwZGF0ZUJCb3goKTsKICAgICAgY29uc3QgbWVyZ2VkUG9pbnRlciA9IHRoaXMuX3NhdmVOb2RlKG1lcmdlZE5vZGUpOwogICAgICBjb25zdCBuZXdDaGlsZHJlbiA9IHBhcmVudE5vZGUuY2hpbGRyZW4uZmlsdGVyKAogICAgICAgIChfLCBpKSA9PiBpICE9PSBjaGlsZEluZGV4ICYmIGkgIT09IHNpYmxpbmcuaW5kZXgKICAgICAgKTsKICAgICAgbmV3Q2hpbGRyZW4ucHVzaChtZXJnZWRQb2ludGVyKTsKICAgICAgcmV0dXJuIHsgbWVyZ2VkOiB0cnVlLCBjaGlsZHJlbjogbmV3Q2hpbGRyZW4gfTsKICAgIH0KICAgIHJldHVybiB7IG1lcmdlZDogZmFsc2UgfTsKICB9CiAgLyoqCiAgICogR2V0IHRoZSBudW1iZXIgb2YgZW50cmllcyBpbiB0aGUgdHJlZQogICAqLwogIHNpemUoKSB7CiAgICByZXR1cm4gdGhpcy5fc2l6ZTsKICB9CiAgLyoqCiAgICogQ2xlYXIgYWxsIGVudHJpZXMgZnJvbSB0aGUgdHJlZSBieSBhcHBlbmRpbmcgYSBuZXcgZW1wdHkgcm9vdCBub2RlCiAgICogUHJlc2VydmVzIHRoZSBhcHBlbmQtb25seSBmaWxlIHN0cnVjdHVyZQogICAqLwogIGFzeW5jIGNsZWFyKCkgewogICAgY29uc3QgbmV3Um9vdCA9IG5ldyBSVHJlZU5vZGUodGhpcywgewogICAgICBpZDogdGhpcy5uZXh0SWQrKywKICAgICAgaXNMZWFmOiB0cnVlLAogICAgICBjaGlsZHJlbjogW10sCiAgICAgIGJib3g6IG51bGwKICAgIH0pOwogICAgdGhpcy5yb290UG9pbnRlciA9IHRoaXMuX3NhdmVOb2RlKG5ld1Jvb3QpOwogICAgdGhpcy5fc2l6ZSA9IDA7CiAgICB0aGlzLl93cml0ZU1ldGFkYXRhKCk7CiAgfQogIC8qKgogICAqIENvbXBhY3QgdGhlIFItdHJlZSBieSBjb3B5aW5nIHRoZSBjdXJyZW50IHJvb3QgYW5kIGFsbCByZWFjaGFibGUgbm9kZXMgaW50byBhIG5ldyBmaWxlLgogICAqIFJldHVybnMgc2l6ZSBtZXRyaWNzIHRvIHNob3cgcmVjbGFpbWVkIHNwYWNlLgogICAqIEBwYXJhbSB7RmlsZVN5c3RlbVN5bmNBY2Nlc3NIYW5kbGV9IGRlc3RTeW5jSGFuZGxlIC0gU3luYyBoYW5kbGUgZm9yIGRlc3RpbmF0aW9uIGZpbGUKICAgKi8KICBhc3luYyBjb21wYWN0KGRlc3RTeW5jSGFuZGxlKSB7CiAgICBpZiAoIXRoaXMuaXNPcGVuKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiUi10cmVlIGZpbGUgbXVzdCBiZSBvcGVuZWQgYmVmb3JlIHVzZSIpOwogICAgfQogICAgaWYgKCFkZXN0U3luY0hhbmRsZSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIkRlc3RpbmF0aW9uIHN5bmMgaGFuZGxlIGlzIHJlcXVpcmVkIGZvciBjb21wYWN0aW9uIik7CiAgICB9CiAgICB0aGlzLl93cml0ZU1ldGFkYXRhKCk7CiAgICBjb25zdCBvbGRTaXplID0gdGhpcy5maWxlLmdldEZpbGVTaXplKCk7CiAgICBjb25zdCBkZXN0ID0gbmV3IFJUcmVlKGRlc3RTeW5jSGFuZGxlLCB0aGlzLm1heEVudHJpZXMpOwogICAgYXdhaXQgZGVzdC5vcGVuKCk7CiAgICBkZXN0Lm1pbkVudHJpZXMgPSB0aGlzLm1pbkVudHJpZXM7CiAgICBkZXN0Lm5leHRJZCA9IHRoaXMubmV4dElkOwogICAgZGVzdC5fc2l6ZSA9IHRoaXMuX3NpemU7CiAgICBjb25zdCBwb2ludGVyTWFwID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIGNvbnN0IGNsb25lTm9kZSA9IChwb2ludGVyKSA9PiB7CiAgICAgIGNvbnN0IG9mZnNldCA9IHBvaW50ZXIudmFsdWVPZigpOwogICAgICBpZiAocG9pbnRlck1hcC5oYXMob2Zmc2V0KSkgewogICAgICAgIHJldHVybiBwb2ludGVyTWFwLmdldChvZmZzZXQpOwogICAgICB9CiAgICAgIGNvbnN0IHNvdXJjZU5vZGUgPSB0aGlzLl9sb2FkTm9kZShwb2ludGVyKTsKICAgICAgY29uc3QgY2xvbmVkQ2hpbGRyZW4gPSBbXTsKICAgICAgaWYgKHNvdXJjZU5vZGUuaXNMZWFmKSB7CiAgICAgICAgZm9yIChjb25zdCBjaGlsZCBvZiBzb3VyY2VOb2RlLmNoaWxkcmVuKSB7CiAgICAgICAgICBjbG9uZWRDaGlsZHJlbi5wdXNoKGNoaWxkKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yIChjb25zdCBjaGlsZFBvaW50ZXIgb2Ygc291cmNlTm9kZS5jaGlsZHJlbikgewogICAgICAgICAgY29uc3QgbmV3Q2hpbGRQdHIgPSBjbG9uZU5vZGUoY2hpbGRQb2ludGVyKTsKICAgICAgICAgIGNsb25lZENoaWxkcmVuLnB1c2gobmV3Q2hpbGRQdHIpOwogICAgICAgIH0KICAgICAgfQogICAgICBjb25zdCBjbG9uZWROb2RlID0gbmV3IFJUcmVlTm9kZShkZXN0LCB7CiAgICAgICAgaWQ6IHNvdXJjZU5vZGUuaWQsCiAgICAgICAgaXNMZWFmOiBzb3VyY2VOb2RlLmlzTGVhZiwKICAgICAgICBjaGlsZHJlbjogY2xvbmVkQ2hpbGRyZW4sCiAgICAgICAgYmJveDogc291cmNlTm9kZS5iYm94CiAgICAgIH0pOwogICAgICBjb25zdCBuZXdQb2ludGVyID0gZGVzdC5fc2F2ZU5vZGUoY2xvbmVkTm9kZSk7CiAgICAgIHBvaW50ZXJNYXAuc2V0KG9mZnNldCwgbmV3UG9pbnRlcik7CiAgICAgIHJldHVybiBuZXdQb2ludGVyOwogICAgfTsKICAgIGNvbnN0IG5ld1Jvb3RQb2ludGVyID0gY2xvbmVOb2RlKHRoaXMucm9vdFBvaW50ZXIpOwogICAgZGVzdC5yb290UG9pbnRlciA9IG5ld1Jvb3RQb2ludGVyOwogICAgZGVzdC5fd3JpdGVNZXRhZGF0YSgpOwogICAgY29uc3QgbmV3U2l6ZSA9IGRlc3QuZmlsZS5nZXRGaWxlU2l6ZSgpOwogICAgYXdhaXQgZGVzdC5jbG9zZSgpOwogICAgcmV0dXJuIHsKICAgICAgb2xkU2l6ZSwKICAgICAgbmV3U2l6ZSwKICAgICAgYnl0ZXNTYXZlZDogTWF0aC5tYXgoMCwgb2xkU2l6ZSAtIG5ld1NpemUpCiAgICB9OwogIH0KfQpjbGFzcyBHZW9zcGF0aWFsSW5kZXggZXh0ZW5kcyBJbmRleCB7CiAgY29uc3RydWN0b3IoaW5kZXhOYW1lLCBrZXlzLCBzdG9yYWdlRmlsZSwgb3B0aW9ucyA9IHt9KSB7CiAgICBzdXBlcihpbmRleE5hbWUsIGtleXMsIHN0b3JhZ2VGaWxlLCBvcHRpb25zKTsKICAgIHRoaXMuZ2VvRmllbGQgPSBPYmplY3Qua2V5cyhrZXlzKVswXTsKICAgIHRoaXMuc3RvcmFnZUZpbGVQYXRoID0gc3RvcmFnZUZpbGU7CiAgICB0aGlzLnJ0cmVlID0gbnVsbDsKICAgIHRoaXMuc3luY0hhbmRsZSA9IG51bGw7CiAgICB0aGlzLmlzT3BlbiA9IGZhbHNlOwogIH0KICAvKioKICAgKiBPcGVuIHRoZSBpbmRleCBmaWxlCiAgICogTXVzdCBiZSBjYWxsZWQgYmVmb3JlIHVzaW5nIHRoZSBpbmRleAogICAqLwogIGFzeW5jIG9wZW4oKSB7CiAgICBpZiAodGhpcy5pc09wZW4pIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdHJ5IHsKICAgICAgY29uc3QgcGF0aFBhcnRzID0gdGhpcy5zdG9yYWdlRmlsZVBhdGguc3BsaXQoIi8iKS5maWx0ZXIoQm9vbGVhbik7CiAgICAgIGNvbnN0IGZpbGVuYW1lID0gcGF0aFBhcnRzLnBvcCgpOwogICAgICBpZiAoIWZpbGVuYW1lKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHN0b3JhZ2UgcGF0aDogJHt0aGlzLnN0b3JhZ2VGaWxlUGF0aH1gKTsKICAgICAgfQogICAgICBsZXQgZGlySGFuZGxlID0gYXdhaXQgZ2xvYmFsVGhpcy5uYXZpZ2F0b3Iuc3RvcmFnZS5nZXREaXJlY3RvcnkoKTsKICAgICAgZm9yIChjb25zdCBwYXJ0IG9mIHBhdGhQYXJ0cykgewogICAgICAgIGRpckhhbmRsZSA9IGF3YWl0IGRpckhhbmRsZS5nZXREaXJlY3RvcnlIYW5kbGUocGFydCwgeyBjcmVhdGU6IHRydWUgfSk7CiAgICAgIH0KICAgICAgY29uc3QgZmlsZUhhbmRsZSA9IGF3YWl0IGRpckhhbmRsZS5nZXRGaWxlSGFuZGxlKGZpbGVuYW1lLCB7IGNyZWF0ZTogdHJ1ZSB9KTsKICAgICAgdGhpcy5zeW5jSGFuZGxlID0gYXdhaXQgZmlsZUhhbmRsZS5jcmVhdGVTeW5jQWNjZXNzSGFuZGxlKCk7CiAgICAgIHRoaXMucnRyZWUgPSBuZXcgUlRyZWUodGhpcy5zeW5jSGFuZGxlLCA5KTsKICAgICAgYXdhaXQgdGhpcy5ydHJlZS5vcGVuKCk7CiAgICAgIHRoaXMuaXNPcGVuID0gdHJ1ZTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChlcnJvci5jb2RlID09PSAiRU5PRU5UIiB8fCBlcnJvci5tZXNzYWdlICYmIChlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCJJbnZhbGlkIFItdHJlZSIpIHx8IGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoImZpbGUgdG9vIHNtYWxsIikgfHwgZXJyb3IubWVzc2FnZS5pbmNsdWRlcygiRmFpbGVkIHRvIHJlYWQgbWV0YWRhdGEiKSB8fCBlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCJVbmtub3duIHR5cGUgYnl0ZSIpKSkgewogICAgICAgIGlmICh0aGlzLnN5bmNIYW5kbGUpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGF3YWl0IHRoaXMuc3luY0hhbmRsZS5jbG9zZSgpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgfQogICAgICAgICAgdGhpcy5zeW5jSGFuZGxlID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgY29uc3QgcGF0aFBhcnRzID0gdGhpcy5zdG9yYWdlRmlsZVBhdGguc3BsaXQoIi8iKS5maWx0ZXIoQm9vbGVhbik7CiAgICAgICAgY29uc3QgZmlsZW5hbWUgPSBwYXRoUGFydHMucG9wKCk7CiAgICAgICAgaWYgKCFmaWxlbmFtZSkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHN0b3JhZ2UgcGF0aDogJHt0aGlzLnN0b3JhZ2VGaWxlUGF0aH1gKTsKICAgICAgICB9CiAgICAgICAgbGV0IGRpckhhbmRsZSA9IGF3YWl0IGdsb2JhbFRoaXMubmF2aWdhdG9yLnN0b3JhZ2UuZ2V0RGlyZWN0b3J5KCk7CiAgICAgICAgZm9yIChjb25zdCBwYXJ0IG9mIHBhdGhQYXJ0cykgewogICAgICAgICAgZGlySGFuZGxlID0gYXdhaXQgZGlySGFuZGxlLmdldERpcmVjdG9yeUhhbmRsZShwYXJ0LCB7IGNyZWF0ZTogdHJ1ZSB9KTsKICAgICAgICB9CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGF3YWl0IGRpckhhbmRsZS5yZW1vdmVFbnRyeShmaWxlbmFtZSk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIH0KICAgICAgICBjb25zdCBmaWxlSGFuZGxlID0gYXdhaXQgZGlySGFuZGxlLmdldEZpbGVIYW5kbGUoZmlsZW5hbWUsIHsgY3JlYXRlOiB0cnVlIH0pOwogICAgICAgIHRoaXMuc3luY0hhbmRsZSA9IGF3YWl0IGZpbGVIYW5kbGUuY3JlYXRlU3luY0FjY2Vzc0hhbmRsZSgpOwogICAgICAgIHRoaXMucnRyZWUgPSBuZXcgUlRyZWUodGhpcy5zeW5jSGFuZGxlLCA5KTsKICAgICAgICBhd2FpdCB0aGlzLnJ0cmVlLm9wZW4oKTsKICAgICAgICB0aGlzLmlzT3BlbiA9IHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgIH0KICAgIH0KICB9CiAgLyoqCiAgICogQ2xvc2UgdGhlIGluZGV4IGZpbGUKICAgKi8KICBhc3luYyBjbG9zZSgpIHsKICAgIGlmICh0aGlzLmlzT3BlbikgewogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMucnRyZWUuY2xvc2UoKTsKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBpZiAoIWVycm9yLm1lc3NhZ2UgfHwgIWVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoIkZpbGUgaXMgbm90IG9wZW4iKSkgewogICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMuaXNPcGVuID0gZmFsc2U7CiAgICB9CiAgfQogIC8qKgogICAqIEV4dHJhY3QgY29vcmRpbmF0ZXMgZnJvbSBhIEdlb0pTT04gb2JqZWN0CiAgICogQHBhcmFtIHtPYmplY3R9IGdlb0pzb24gLSBUaGUgR2VvSlNPTiBvYmplY3QKICAgKiBAcmV0dXJucyB7T2JqZWN0fG51bGx9IE9iamVjdCB3aXRoIGxhdCBhbmQgbG5nLCBvciBudWxsIGlmIGludmFsaWQKICAgKi8KICBfZXh0cmFjdENvb3JkaW5hdGVzKGdlb0pzb24pIHsKICAgIGlmICghZ2VvSnNvbikgcmV0dXJuIG51bGw7CiAgICBpZiAoZ2VvSnNvbi50eXBlID09PSAiRmVhdHVyZUNvbGxlY3Rpb24iICYmIGdlb0pzb24uZmVhdHVyZXMgJiYgZ2VvSnNvbi5mZWF0dXJlcy5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IGZlYXR1cmUgPSBnZW9Kc29uLmZlYXR1cmVzWzBdOwogICAgICBpZiAoZmVhdHVyZS5nZW9tZXRyeSkgewogICAgICAgIHJldHVybiB0aGlzLl9leHRyYWN0Q29vcmRpbmF0ZXMoZmVhdHVyZS5nZW9tZXRyeSk7CiAgICAgIH0KICAgIH0KICAgIGlmIChnZW9Kc29uLnR5cGUgPT09ICJGZWF0dXJlIiAmJiBnZW9Kc29uLmdlb21ldHJ5KSB7CiAgICAgIHJldHVybiB0aGlzLl9leHRyYWN0Q29vcmRpbmF0ZXMoZ2VvSnNvbi5nZW9tZXRyeSk7CiAgICB9CiAgICBpZiAoZ2VvSnNvbi50eXBlID09PSAiUG9pbnQiICYmIGdlb0pzb24uY29vcmRpbmF0ZXMpIHsKICAgICAgY29uc3QgW2xuZywgbGF0XSA9IGdlb0pzb24uY29vcmRpbmF0ZXM7CiAgICAgIGlmICh0eXBlb2YgbG5nID09PSAibnVtYmVyIiAmJiB0eXBlb2YgbGF0ID09PSAibnVtYmVyIikgewogICAgICAgIHJldHVybiB7IGxhdCwgbG5nIH07CiAgICAgIH0KICAgIH0KICAgIGlmIChnZW9Kc29uLnR5cGUgPT09ICJQb2x5Z29uIiAmJiBnZW9Kc29uLmNvb3JkaW5hdGVzICYmIGdlb0pzb24uY29vcmRpbmF0ZXMubGVuZ3RoID4gMCkgewogICAgICBjb25zdCByaW5nID0gZ2VvSnNvbi5jb29yZGluYXRlc1swXTsKICAgICAgaWYgKHJpbmcubGVuZ3RoID4gMCkgewogICAgICAgIGxldCBzdW1MYXQgPSAwLCBzdW1MbmcgPSAwOwogICAgICAgIGZvciAoY29uc3QgY29vcmQgb2YgcmluZykgewogICAgICAgICAgc3VtTG5nICs9IGNvb3JkWzBdOwogICAgICAgICAgc3VtTGF0ICs9IGNvb3JkWzFdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgbGF0OiBzdW1MYXQgLyByaW5nLmxlbmd0aCwKICAgICAgICAgIGxuZzogc3VtTG5nIC8gcmluZy5sZW5ndGgKICAgICAgICB9OwogICAgICB9CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9CiAgLyoqCiAgICogQWRkIGEgZG9jdW1lbnQgdG8gdGhlIGdlb3NwYXRpYWwgaW5kZXgKICAgKiBAcGFyYW0ge09iamVjdH0gZG9jIC0gVGhlIGRvY3VtZW50IHRvIGluZGV4CiAgICovCiAgYXN5bmMgYWRkKGRvYykgewogICAgaWYgKCFkb2MuX2lkKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiRG9jdW1lbnQgbXVzdCBoYXZlIGFuIF9pZCBmaWVsZCIpOwogICAgfQogICAgY29uc3QgZ2VvVmFsdWUgPSBnZXRQcm9wKGRvYywgdGhpcy5nZW9GaWVsZCk7CiAgICBjb25zdCBjb29yZHMgPSB0aGlzLl9leHRyYWN0Q29vcmRpbmF0ZXMoZ2VvVmFsdWUpOwogICAgaWYgKGNvb3JkcykgewogICAgICBhd2FpdCB0aGlzLnJ0cmVlLmluc2VydChjb29yZHMubGF0LCBjb29yZHMubG5nLCBkb2MuX2lkKTsKICAgIH0KICB9CiAgLyoqCiAgICogUmVtb3ZlIGEgZG9jdW1lbnQgZnJvbSB0aGUgZ2Vvc3BhdGlhbCBpbmRleAogICAqIEBwYXJhbSB7T2JqZWN0fSBkb2MgLSBUaGUgZG9jdW1lbnQgdG8gcmVtb3ZlCiAgICovCiAgYXN5bmMgcmVtb3ZlKGRvYykgewogICAgaWYgKCFkb2MuX2lkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICghKGRvYy5faWQgaW5zdGFuY2VvZiBPYmplY3RJZCkpIHsKICAgICAgY29uc29sZS5lcnJvcihkb2MpOwogICAgICB0aHJvdyBuZXcgRXJyb3IoIkRvY3VtZW50IF9pZCBtdXN0IGJlIGFuIE9iamVjdElkIHRvIHJlbW92ZSBmcm9tIGdlb3NwYXRpYWwgaW5kZXgiKTsKICAgIH0KICAgIGF3YWl0IHRoaXMucnRyZWUucmVtb3ZlKGRvYy5faWQpOwogIH0KICAvKioKICAgKiBRdWVyeSB0aGUgZ2Vvc3BhdGlhbCBpbmRleAogICAqIEBwYXJhbSB7Kn0gcXVlcnkgLSBUaGUgcXVlcnkgb2JqZWN0CiAgICogQHJldHVybnMge1Byb21pc2U8QXJyYXl8bnVsbD59IEFycmF5IG9mIGRvY3VtZW50IElEcyBvciBudWxsIGlmIHF1ZXJ5IGlzIG5vdCBhIGdlb3NwYXRpYWwgcXVlcnkKICAgKi8KICBhc3luYyBxdWVyeShxdWVyeSkgewogICAgaWYgKCF0aGlzLmlzT3BlbikgewogICAgICBhd2FpdCB0aGlzLm9wZW4oKTsKICAgIH0KICAgIGlmICghcXVlcnlbdGhpcy5nZW9GaWVsZF0pIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBjb25zdCBnZW9RdWVyeSA9IHF1ZXJ5W3RoaXMuZ2VvRmllbGRdOwogICAgaWYgKGdlb1F1ZXJ5LiRnZW9XaXRoaW4pIHsKICAgICAgY29uc3QgYmJveCA9IGdlb1F1ZXJ5LiRnZW9XaXRoaW47CiAgICAgIGlmIChBcnJheS5pc0FycmF5KGJib3gpICYmIGJib3gubGVuZ3RoID09PSAyKSB7CiAgICAgICAgY29uc3QgbWluTG9uID0gYmJveFswXVswXTsKICAgICAgICBjb25zdCBtYXhMYXQgPSBiYm94WzBdWzFdOwogICAgICAgIGNvbnN0IG1heExvbiA9IGJib3hbMV1bMF07CiAgICAgICAgY29uc3QgbWluTGF0ID0gYmJveFsxXVsxXTsKICAgICAgICBjb25zdCByZXN1bHRzID0gYXdhaXQgdGhpcy5ydHJlZS5zZWFyY2hCQm94KHsKICAgICAgICAgIG1pbkxhdCwKICAgICAgICAgIG1heExhdCwKICAgICAgICAgIG1pbkxuZzogbWluTG9uLAogICAgICAgICAgbWF4TG5nOiBtYXhMb24KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcmVzdWx0cy5tYXAoKGVudHJ5KSA9PiBlbnRyeS5vYmplY3RJZC50b1N0cmluZygpKTsKICAgICAgfQogICAgfQogICAgaWYgKGdlb1F1ZXJ5LiRuZWFyKSB7CiAgICAgIGNvbnN0IG5lYXJRdWVyeSA9IGdlb1F1ZXJ5LiRuZWFyOwogICAgICBsZXQgY29vcmRpbmF0ZXM7CiAgICAgIGlmIChuZWFyUXVlcnkuJGdlb21ldHJ5KSB7CiAgICAgICAgY29vcmRpbmF0ZXMgPSBuZWFyUXVlcnkuJGdlb21ldHJ5LmNvb3JkaW5hdGVzOwogICAgICB9IGVsc2UgaWYgKG5lYXJRdWVyeS5jb29yZGluYXRlcykgewogICAgICAgIGNvb3JkaW5hdGVzID0gbmVhclF1ZXJ5LmNvb3JkaW5hdGVzOwogICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkobmVhclF1ZXJ5KSkgewogICAgICAgIGNvb3JkaW5hdGVzID0gbmVhclF1ZXJ5OwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIGlmICghY29vcmRpbmF0ZXMgfHwgY29vcmRpbmF0ZXMubGVuZ3RoIDwgMikgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIGNvbnN0IFtsbmcsIGxhdF0gPSBjb29yZGluYXRlczsKICAgICAgY29uc3QgbWF4RGlzdGFuY2VNZXRlcnMgPSBuZWFyUXVlcnkuJG1heERpc3RhbmNlIHx8IDFlNjsKICAgICAgY29uc3QgbWF4RGlzdGFuY2VLbSA9IG1heERpc3RhbmNlTWV0ZXJzIC8gMWUzOwogICAgICBjb25zdCByZXN1bHRzID0gYXdhaXQgdGhpcy5ydHJlZS5zZWFyY2hSYWRpdXMobGF0LCBsbmcsIG1heERpc3RhbmNlS20pOwogICAgICByZXN1bHRzLnNvcnQoKGEsIGIpID0+IGEuZGlzdGFuY2UgLSBiLmRpc3RhbmNlKTsKICAgICAgcmV0dXJuIHJlc3VsdHMubWFwKChlbnRyeSkgPT4gZW50cnkub2JqZWN0SWQudG9TdHJpbmcoKSk7CiAgICB9CiAgICBpZiAoZ2VvUXVlcnkuJG5lYXJTcGhlcmUpIHsKICAgICAgY29uc3QgbmVhclF1ZXJ5ID0gZ2VvUXVlcnkuJG5lYXJTcGhlcmU7CiAgICAgIGxldCBjb29yZGluYXRlczsKICAgICAgaWYgKG5lYXJRdWVyeS4kZ2VvbWV0cnkpIHsKICAgICAgICBjb29yZGluYXRlcyA9IG5lYXJRdWVyeS4kZ2VvbWV0cnkuY29vcmRpbmF0ZXM7CiAgICAgIH0gZWxzZSBpZiAobmVhclF1ZXJ5LmNvb3JkaW5hdGVzKSB7CiAgICAgICAgY29vcmRpbmF0ZXMgPSBuZWFyUXVlcnkuY29vcmRpbmF0ZXM7CiAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShuZWFyUXVlcnkpKSB7CiAgICAgICAgY29vcmRpbmF0ZXMgPSBuZWFyUXVlcnk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgaWYgKCFjb29yZGluYXRlcyB8fCBjb29yZGluYXRlcy5sZW5ndGggPCAyKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgY29uc3QgW2xuZywgbGF0XSA9IGNvb3JkaW5hdGVzOwogICAgICBjb25zdCBtYXhEaXN0YW5jZU1ldGVycyA9IG5lYXJRdWVyeS4kbWF4RGlzdGFuY2UgfHwgMWU2OwogICAgICBjb25zdCBtYXhEaXN0YW5jZUttID0gbWF4RGlzdGFuY2VNZXRlcnMgLyAxZTM7CiAgICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLnJ0cmVlLnNlYXJjaFJhZGl1cyhsYXQsIGxuZywgbWF4RGlzdGFuY2VLbSk7CiAgICAgIHJlc3VsdHMuc29ydCgoYSwgYikgPT4gYS5kaXN0YW5jZSAtIGIuZGlzdGFuY2UpOwogICAgICByZXR1cm4gcmVzdWx0cy5tYXAoKGVudHJ5KSA9PiBlbnRyeS5vYmplY3RJZC50b1N0cmluZygpKTsKICAgIH0KICAgIGlmIChnZW9RdWVyeS4kZ2VvSW50ZXJzZWN0cykgewogICAgICBjb25zdCBpbnRlcnNlY3RzUXVlcnkgPSBnZW9RdWVyeS4kZ2VvSW50ZXJzZWN0czsKICAgICAgbGV0IGdlb21ldHJ5OwogICAgICBpZiAoaW50ZXJzZWN0c1F1ZXJ5LiRnZW9tZXRyeSkgewogICAgICAgIGdlb21ldHJ5ID0gaW50ZXJzZWN0c1F1ZXJ5LiRnZW9tZXRyeTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICBpZiAoIWdlb21ldHJ5IHx8ICFnZW9tZXRyeS50eXBlKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgaWYgKGdlb21ldHJ5LnR5cGUgPT09ICJQb2ludCIpIHsKICAgICAgICBjb25zdCBbbG5nLCBsYXRdID0gZ2VvbWV0cnkuY29vcmRpbmF0ZXM7CiAgICAgICAgY29uc3QgZXBzaWxvbiA9IDFlLTQ7CiAgICAgICAgY29uc3QgcmVzdWx0cyA9IGF3YWl0IHRoaXMucnRyZWUuc2VhcmNoQkJveCh7CiAgICAgICAgICBtaW5MYXQ6IGxhdCAtIGVwc2lsb24sCiAgICAgICAgICBtYXhMYXQ6IGxhdCArIGVwc2lsb24sCiAgICAgICAgICBtaW5Mbmc6IGxuZyAtIGVwc2lsb24sCiAgICAgICAgICBtYXhMbmc6IGxuZyArIGVwc2lsb24KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcmVzdWx0cy5tYXAoKGVudHJ5KSA9PiBlbnRyeS5vYmplY3RJZC50b1N0cmluZygpKTsKICAgICAgfSBlbHNlIGlmIChnZW9tZXRyeS50eXBlID09PSAiUG9seWdvbiIpIHsKICAgICAgICBjb25zdCBjb29yZGluYXRlcyA9IGdlb21ldHJ5LmNvb3JkaW5hdGVzOwogICAgICAgIGlmICghY29vcmRpbmF0ZXMgfHwgY29vcmRpbmF0ZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgY29uc3QgcmluZyA9IGNvb3JkaW5hdGVzWzBdOwogICAgICAgIGlmICghcmluZyB8fCByaW5nLmxlbmd0aCA8IDMpIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBsZXQgbWluTGF0ID0gSW5maW5pdHksIG1heExhdCA9IC1JbmZpbml0eTsKICAgICAgICBsZXQgbWluTG5nID0gSW5maW5pdHksIG1heExuZyA9IC1JbmZpbml0eTsKICAgICAgICBmb3IgKGNvbnN0IGNvb3JkIG9mIHJpbmcpIHsKICAgICAgICAgIGNvbnN0IFtsbmcsIGxhdF0gPSBjb29yZDsKICAgICAgICAgIG1pbkxhdCA9IE1hdGgubWluKG1pbkxhdCwgbGF0KTsKICAgICAgICAgIG1heExhdCA9IE1hdGgubWF4KG1heExhdCwgbGF0KTsKICAgICAgICAgIG1pbkxuZyA9IE1hdGgubWluKG1pbkxuZywgbG5nKTsKICAgICAgICAgIG1heExuZyA9IE1hdGgubWF4KG1heExuZywgbG5nKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY2FuZGlkYXRlcyA9IGF3YWl0IHRoaXMucnRyZWUuc2VhcmNoQkJveCh7CiAgICAgICAgICBtaW5MYXQsCiAgICAgICAgICBtYXhMYXQsCiAgICAgICAgICBtaW5MbmcsCiAgICAgICAgICBtYXhMbmcKICAgICAgICB9KTsKICAgICAgICBjb25zdCByZXN1bHRzID0gY2FuZGlkYXRlcy5maWx0ZXIoKGVudHJ5KSA9PiB0aGlzLl9wb2ludEluUG9seWdvbihlbnRyeS5sYXQsIGVudHJ5LmxuZywgcmluZykpOwogICAgICAgIHJldHVybiByZXN1bHRzLm1hcCgoZW50cnkpID0+IGVudHJ5Lm9iamVjdElkLnRvU3RyaW5nKCkpOwogICAgICB9CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfQogIC8vIC8qKgogIC8vICAqIENhbGN1bGF0ZSBkaXN0YW5jZSBiZXR3ZWVuIHR3byBwb2ludHMgdXNpbmcgSGF2ZXJzaW5lIGZvcm11bGEKICAvLyAgKiBAcGFyYW0ge251bWJlcn0gbGF0MSAtIExhdGl0dWRlIG9mIGZpcnN0IHBvaW50CiAgLy8gICogQHBhcmFtIHtudW1iZXJ9IGxuZzEgLSBMb25naXR1ZGUgb2YgZmlyc3QgcG9pbnQKICAvLyAgKiBAcGFyYW0ge251bWJlcn0gbGF0MiAtIExhdGl0dWRlIG9mIHNlY29uZCBwb2ludAogIC8vICAqIEBwYXJhbSB7bnVtYmVyfSBsbmcyIC0gTG9uZ2l0dWRlIG9mIHNlY29uZCBwb2ludAogIC8vICAqIEByZXR1cm5zIHtudW1iZXJ9IERpc3RhbmNlIGluIGtpbG9tZXRlcnMKICAvLyAgKi8KICAvLyBfaGF2ZXJzaW5lRGlzdGFuY2UobGF0MSwgbG5nMSwgbGF0MiwgbG5nMikgewogIC8vIAljb25zdCBSID0gNjM3MTsgLy8gRWFydGgncyByYWRpdXMgaW4ga2lsb21ldGVycwogIC8vIAljb25zdCBkTGF0ID0gKGxhdDIgLSBsYXQxKSAqIE1hdGguUEkgLyAxODA7CiAgLy8gCWNvbnN0IGRMbmcgPSAobG5nMiAtIGxuZzEpICogTWF0aC5QSSAvIDE4MDsKICAvLyAJY29uc3QgYSA9IE1hdGguc2luKGRMYXQgLyAyKSAqIE1hdGguc2luKGRMYXQgLyAyKSArCiAgLy8gCQlNYXRoLmNvcyhsYXQxICogTWF0aC5QSSAvIDE4MCkgKiBNYXRoLmNvcyhsYXQyICogTWF0aC5QSSAvIDE4MCkgKgogIC8vIAkJTWF0aC5zaW4oZExuZyAvIDIpICogTWF0aC5zaW4oZExuZyAvIDIpOwogIC8vIAljb25zdCBjID0gMiAqIE1hdGguYXRhbjIoTWF0aC5zcXJ0KGEpLCBNYXRoLnNxcnQoMSAtIGEpKTsKICAvLyAJcmV0dXJuIFIgKiBjOwogIC8vIH0KICAvKioKICAgKiBUZXN0IGlmIGEgcG9pbnQgaXMgaW5zaWRlIGEgcG9seWdvbiB1c2luZyByYXkgY2FzdGluZyBhbGdvcml0aG0KICAgKiBAcGFyYW0ge251bWJlcn0gbGF0IC0gUG9pbnQgbGF0aXR1ZGUKICAgKiBAcGFyYW0ge251bWJlcn0gbG5nIC0gUG9pbnQgbG9uZ2l0dWRlCiAgICogQHBhcmFtIHtBcnJheX0gcmluZyAtIFBvbHlnb24gcmluZyBhcyBhcnJheSBvZiBbbG5nLCBsYXRdIGNvb3JkaW5hdGVzCiAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgcG9pbnQgaXMgaW5zaWRlIHBvbHlnb24KICAgKi8KICBfcG9pbnRJblBvbHlnb24obGF0LCBsbmcsIHJpbmcpIHsKICAgIGxldCBpbnNpZGUgPSBmYWxzZTsKICAgIGZvciAobGV0IGkgPSAwLCBqID0gcmluZy5sZW5ndGggLSAxOyBpIDwgcmluZy5sZW5ndGg7IGogPSBpKyspIHsKICAgICAgY29uc3QgW3hpLCB5aV0gPSByaW5nW2ldOwogICAgICBjb25zdCBbeGosIHlqXSA9IHJpbmdbal07CiAgICAgIGNvbnN0IGludGVyc2VjdCA9IHlpID4gbGF0ICE9PSB5aiA+IGxhdCAmJiBsbmcgPCAoeGogLSB4aSkgKiAobGF0IC0geWkpIC8gKHlqIC0geWkpICsgeGk7CiAgICAgIGlmIChpbnRlcnNlY3QpIHsKICAgICAgICBpbnNpZGUgPSAhaW5zaWRlOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gaW5zaWRlOwogIH0KICAvKioKICAgKiBDbGVhciBhbGwgZGF0YSBmcm9tIHRoZSBpbmRleAogICAqLwogIC8vIFRPRE86IGRvbnQnIGRlbGV0ZSB0aGUgZmlsZSBvciBqdXN0IGNsZWFyIHRoZSBSVHJlZSBjb250ZW50cwogIGFzeW5jIGNsZWFyKCkgewogICAgYXdhaXQgdGhpcy5jbG9zZSgpOwogICAgdHJ5IHsKICAgICAgY29uc3QgcGF0aFBhcnRzID0gdGhpcy5zdG9yYWdlRmlsZVBhdGguc3BsaXQoIi8iKS5maWx0ZXIoQm9vbGVhbik7CiAgICAgIGNvbnN0IGZpbGVuYW1lID0gcGF0aFBhcnRzLnBvcCgpOwogICAgICBsZXQgZGlySGFuZGxlID0gYXdhaXQgZ2xvYmFsVGhpcy5uYXZpZ2F0b3Iuc3RvcmFnZS5nZXREaXJlY3RvcnkoKTsKICAgICAgZm9yIChjb25zdCBwYXJ0IG9mIHBhdGhQYXJ0cykgewogICAgICAgIGRpckhhbmRsZSA9IGF3YWl0IGRpckhhbmRsZS5nZXREaXJlY3RvcnlIYW5kbGUocGFydCwgeyBjcmVhdGU6IGZhbHNlIH0pOwogICAgICB9CiAgICAgIGF3YWl0IGRpckhhbmRsZS5yZW1vdmVFbnRyeShmaWxlbmFtZSk7CiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgaWYgKCFlcnIgfHwgZXJyLm5hbWUgIT09ICJOb3RGb3VuZEVycm9yIikgewogICAgICAgIHRocm93IGVycjsKICAgICAgfQogICAgfQogICAgYXdhaXQgdGhpcy5vcGVuKCk7CiAgfQogIC8qKgogICAqIEdldCBpbmRleCBzcGVjaWZpY2F0aW9uCiAgICovCiAgZ2V0U3BlYygpIHsKICAgIHJldHVybiB7CiAgICAgIG5hbWU6IHRoaXMubmFtZSwKICAgICAga2V5OiB0aGlzLmtleXMsCiAgICAgICIyZHNwaGVyZUluZGV4VmVyc2lvbiI6IDMKICAgIH07CiAgfQp9CmNsYXNzIFF1ZXJ5UGxhbiB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLnR5cGUgPSAiZnVsbF9zY2FuIjsKICAgIHRoaXMuaW5kZXhlcyA9IFtdOwogICAgdGhpcy5pbmRleFNjYW5zID0gW107CiAgICB0aGlzLmVzdGltYXRlZENvc3QgPSBJbmZpbml0eTsKICAgIHRoaXMuaW5kZXhPbmx5ID0gZmFsc2U7CiAgfQp9CmNsYXNzIFF1ZXJ5UGxhbm5lciB7CiAgY29uc3RydWN0b3IoaW5kZXhlcykgewogICAgdGhpcy5pbmRleGVzID0gaW5kZXhlczsKICB9CiAgLyoqCiAgICogR2VuZXJhdGUgYW4gZXhlY3V0aW9uIHBsYW4gZm9yIGEgcXVlcnkKICAgKiBAcGFyYW0ge09iamVjdH0gcXVlcnkgLSBNb25nb0RCIHF1ZXJ5IG9iamVjdAogICAqIEByZXR1cm5zIHtRdWVyeVBsYW59IEV4ZWN1dGlvbiBwbGFuCiAgICovCiAgcGxhbihxdWVyeSkgewogICAgY29uc3QgcGxhbiA9IG5ldyBRdWVyeVBsYW4oKTsKICAgIGlmICghcXVlcnkgfHwgT2JqZWN0LmtleXMocXVlcnkpLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gcGxhbjsKICAgIH0KICAgIGNvbnN0IGFuYWx5c2lzID0gdGhpcy5fYW5hbHl6ZVF1ZXJ5KHF1ZXJ5KTsKICAgIGlmIChhbmFseXNpcy5oYXNUZXh0U2VhcmNoKSB7CiAgICAgIGNvbnN0IHRleHRQbGFuID0gdGhpcy5fcGxhblRleHRTZWFyY2gocXVlcnksIGFuYWx5c2lzKTsKICAgICAgaWYgKHRleHRQbGFuKSB7CiAgICAgICAgcmV0dXJuIHRleHRQbGFuOwogICAgICB9CiAgICB9CiAgICBpZiAoYW5hbHlzaXMuaGFzR2VvUXVlcnkpIHsKICAgICAgY29uc3QgZ2VvUGxhbiA9IHRoaXMuX3BsYW5HZW9RdWVyeShxdWVyeSwgYW5hbHlzaXMpOwogICAgICBpZiAoZ2VvUGxhbikgewogICAgICAgIHJldHVybiBnZW9QbGFuOwogICAgICB9CiAgICB9CiAgICBpZiAoYW5hbHlzaXMudHlwZSA9PT0gImFuZCIpIHsKICAgICAgY29uc3QgYW5kUGxhbiA9IHRoaXMuX3BsYW5BbmRRdWVyeShxdWVyeSwgYW5hbHlzaXMpOwogICAgICBpZiAoYW5kUGxhbi50eXBlICE9PSAiZnVsbF9zY2FuIikgewogICAgICAgIHJldHVybiBhbmRQbGFuOwogICAgICB9CiAgICB9CiAgICBpZiAoYW5hbHlzaXMudHlwZSA9PT0gIm9yIikgewogICAgICBjb25zdCBvclBsYW4gPSB0aGlzLl9wbGFuT3JRdWVyeShxdWVyeSwgYW5hbHlzaXMpOwogICAgICBpZiAob3JQbGFuLnR5cGUgIT09ICJmdWxsX3NjYW4iKSB7CiAgICAgICAgcmV0dXJuIG9yUGxhbjsKICAgICAgfQogICAgfQogICAgY29uc3Qgc2ltcGxlUGxhbiA9IHRoaXMuX3BsYW5TaW1wbGVRdWVyeShxdWVyeSk7CiAgICBpZiAoc2ltcGxlUGxhbi50eXBlICE9PSAiZnVsbF9zY2FuIikgewogICAgICByZXR1cm4gc2ltcGxlUGxhbjsKICAgIH0KICAgIHJldHVybiBwbGFuOwogIH0KICAvKioKICAgKiBBbmFseXplIHF1ZXJ5IHN0cnVjdHVyZQogICAqIEBwcml2YXRlCiAgICovCiAgX2FuYWx5emVRdWVyeShxdWVyeSkgewogICAgY29uc3QgYW5hbHlzaXMgPSB7CiAgICAgIHR5cGU6ICJzaW1wbGUiLAogICAgICAvLyAnc2ltcGxlJywgJ2FuZCcsICdvcicsICdjb21wbGV4JwogICAgICBmaWVsZHM6IFtdLAogICAgICBvcGVyYXRvcnM6IHt9LAogICAgICBoYXNUZXh0U2VhcmNoOiBmYWxzZSwKICAgICAgaGFzR2VvUXVlcnk6IGZhbHNlLAogICAgICBjb25kaXRpb25zOiBbXQogICAgfTsKICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhxdWVyeSk7CiAgICBpZiAoa2V5cy5sZW5ndGggPT09IDEpIHsKICAgICAgY29uc3Qga2V5ID0ga2V5c1swXTsKICAgICAgaWYgKGtleSA9PT0gIiRhbmQiKSB7CiAgICAgICAgYW5hbHlzaXMudHlwZSA9ICJhbmQiOwogICAgICAgIGFuYWx5c2lzLmNvbmRpdGlvbnMgPSBxdWVyeS4kYW5kOwogICAgICAgIGZvciAoY29uc3QgY29uZGl0aW9uIG9mIGFuYWx5c2lzLmNvbmRpdGlvbnMpIHsKICAgICAgICAgIGNvbnN0IHN1YkFuYWx5c2lzID0gdGhpcy5fYW5hbHl6ZVF1ZXJ5KGNvbmRpdGlvbik7CiAgICAgICAgICBhbmFseXNpcy5maWVsZHMucHVzaCguLi5zdWJBbmFseXNpcy5maWVsZHMpOwogICAgICAgICAgaWYgKHN1YkFuYWx5c2lzLmhhc1RleHRTZWFyY2gpIGFuYWx5c2lzLmhhc1RleHRTZWFyY2ggPSB0cnVlOwogICAgICAgICAgaWYgKHN1YkFuYWx5c2lzLmhhc0dlb1F1ZXJ5KSBhbmFseXNpcy5oYXNHZW9RdWVyeSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhbmFseXNpczsKICAgICAgfSBlbHNlIGlmIChrZXkgPT09ICIkb3IiKSB7CiAgICAgICAgYW5hbHlzaXMudHlwZSA9ICJvciI7CiAgICAgICAgYW5hbHlzaXMuY29uZGl0aW9ucyA9IHF1ZXJ5LiRvcjsKICAgICAgICBmb3IgKGNvbnN0IGNvbmRpdGlvbiBvZiBhbmFseXNpcy5jb25kaXRpb25zKSB7CiAgICAgICAgICBjb25zdCBzdWJBbmFseXNpcyA9IHRoaXMuX2FuYWx5emVRdWVyeShjb25kaXRpb24pOwogICAgICAgICAgYW5hbHlzaXMuZmllbGRzLnB1c2goLi4uc3ViQW5hbHlzaXMuZmllbGRzKTsKICAgICAgICAgIGlmIChzdWJBbmFseXNpcy5oYXNUZXh0U2VhcmNoKSBhbmFseXNpcy5oYXNUZXh0U2VhcmNoID0gdHJ1ZTsKICAgICAgICAgIGlmIChzdWJBbmFseXNpcy5oYXNHZW9RdWVyeSkgYW5hbHlzaXMuaGFzR2VvUXVlcnkgPSB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYW5hbHlzaXM7CiAgICAgIH0KICAgIH0KICAgIGZvciAoY29uc3QgZmllbGQgb2Yga2V5cykgewogICAgICBpZiAoZmllbGQuc3RhcnRzV2l0aCgiJCIpKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgYW5hbHlzaXMuZmllbGRzLnB1c2goZmllbGQpOwogICAgICBjb25zdCB2YWx1ZSA9IHF1ZXJ5W2ZpZWxkXTsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgJiYgdmFsdWUgIT09IG51bGwgJiYgIUFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgY29uc3Qgb3BzID0gT2JqZWN0LmtleXModmFsdWUpOwogICAgICAgIGFuYWx5c2lzLm9wZXJhdG9yc1tmaWVsZF0gPSBvcHM7CiAgICAgICAgaWYgKG9wcy5pbmNsdWRlcygiJHRleHQiKSkgewogICAgICAgICAgYW5hbHlzaXMuaGFzVGV4dFNlYXJjaCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGlmIChvcHMuc29tZSgob3ApID0+IFsiJGdlb1dpdGhpbiIsICIkZ2VvSW50ZXJzZWN0cyIsICIkbmVhciIsICIkbmVhclNwaGVyZSJdLmluY2x1ZGVzKG9wKSkpIHsKICAgICAgICAgIGFuYWx5c2lzLmhhc0dlb1F1ZXJ5ID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGlmIChrZXlzLmxlbmd0aCA+IDEpIHsKICAgICAgYW5hbHlzaXMudHlwZSA9ICJhbmQiOwogICAgfQogICAgcmV0dXJuIGFuYWx5c2lzOwogIH0KICAvKioKICAgKiBQbGFuIGZvciB0ZXh0IHNlYXJjaCBxdWVyaWVzCiAgICogQHByaXZhdGUKICAgKi8KICBfcGxhblRleHRTZWFyY2gocXVlcnksIGFuYWx5c2lzKSB7CiAgICBmb3IgKGNvbnN0IFtpbmRleE5hbWUsIGluZGV4XSBvZiB0aGlzLmluZGV4ZXMpIHsKICAgICAgaWYgKGluZGV4IGluc3RhbmNlb2YgVGV4dENvbGxlY3Rpb25JbmRleCkgewogICAgICAgIGNvbnN0IHRleHRRdWVyeSA9IHRoaXMuX2V4dHJhY3RUZXh0UXVlcnkocXVlcnkpOwogICAgICAgIGlmICh0ZXh0UXVlcnkpIHsKICAgICAgICAgIGNvbnN0IHBsYW4gPSBuZXcgUXVlcnlQbGFuKCk7CiAgICAgICAgICBwbGFuLnR5cGUgPSAiaW5kZXhfc2NhbiI7CiAgICAgICAgICBwbGFuLmluZGV4ZXMgPSBbaW5kZXhOYW1lXTsKICAgICAgICAgIHBsYW4uaW5kZXhTY2FucyA9IFt7IGluZGV4TmFtZSwgaW5kZXgsIHRleHRRdWVyeSB9XTsKICAgICAgICAgIHBsYW4uZXN0aW1hdGVkQ29zdCA9IDEwMDsKICAgICAgICAgIHBsYW4uaW5kZXhPbmx5ID0gdHJ1ZTsKICAgICAgICAgIHJldHVybiBwbGFuOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfQogIC8qKgogICAqIEV4dHJhY3QgJHRleHQgcXVlcnkgZnJvbSBxdWVyeSBvYmplY3QKICAgKiBAcHJpdmF0ZQogICAqLwogIF9leHRyYWN0VGV4dFF1ZXJ5KHF1ZXJ5KSB7CiAgICBmb3IgKGNvbnN0IGZpZWxkIGluIHF1ZXJ5KSB7CiAgICAgIGNvbnN0IHZhbHVlID0gcXVlcnlbZmllbGRdOwogICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZS4kdGV4dCkgewogICAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUuJHRleHQgPT09ICJzdHJpbmciID8gdmFsdWUuJHRleHQgOiB2YWx1ZS4kdGV4dC4kc2VhcmNoOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9CiAgLyoqCiAgICogUGxhbiBmb3IgZ2Vvc3BhdGlhbCBxdWVyaWVzCiAgICogQHByaXZhdGUKICAgKi8KICBfcGxhbkdlb1F1ZXJ5KHF1ZXJ5LCBhbmFseXNpcykgewogICAgZm9yIChjb25zdCBbaW5kZXhOYW1lLCBpbmRleF0gb2YgdGhpcy5pbmRleGVzKSB7CiAgICAgIGlmIChpbmRleCBpbnN0YW5jZW9mIEdlb3NwYXRpYWxJbmRleCkgewogICAgICAgIGNvbnN0IHBsYW4gPSBuZXcgUXVlcnlQbGFuKCk7CiAgICAgICAgcGxhbi50eXBlID0gImluZGV4X3NjYW4iOwogICAgICAgIHBsYW4uaW5kZXhlcyA9IFtpbmRleE5hbWVdOwogICAgICAgIHBsYW4uaW5kZXhTY2FucyA9IFt7IGluZGV4TmFtZSwgaW5kZXgsIHF1ZXJ5IH1dOwogICAgICAgIHBsYW4uZXN0aW1hdGVkQ29zdCA9IDEwMDsKICAgICAgICBwbGFuLmluZGV4T25seSA9IHRydWU7CiAgICAgICAgcmV0dXJuIHBsYW47CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBudWxsOwogIH0KICAvKioKICAgKiBQbGFuIGZvciAkYW5kIHF1ZXJpZXMgKGluZGV4IGludGVyc2VjdGlvbikKICAgKiBAcHJpdmF0ZQogICAqLwogIF9wbGFuQW5kUXVlcnkocXVlcnksIGFuYWx5c2lzKSB7CiAgICBjb25zdCBwbGFuID0gbmV3IFF1ZXJ5UGxhbigpOwogICAgbGV0IGNvbmRpdGlvbnM7CiAgICBpZiAocXVlcnkuJGFuZCkgewogICAgICBjb25kaXRpb25zID0gcXVlcnkuJGFuZDsKICAgIH0gZWxzZSB7CiAgICAgIGNvbmRpdGlvbnMgPSBPYmplY3Qua2V5cyhxdWVyeSkubWFwKChmaWVsZCkgPT4gKHsgW2ZpZWxkXTogcXVlcnlbZmllbGRdIH0pKTsKICAgIH0KICAgIGNvbnN0IGluZGV4YWJsZUNvbmRpdGlvbnMgPSBbXTsKICAgIGZvciAoY29uc3QgY29uZGl0aW9uIG9mIGNvbmRpdGlvbnMpIHsKICAgICAgY29uc3QgY29uZGl0aW9uUGxhbiA9IHRoaXMuX3BsYW5TaW1wbGVRdWVyeShjb25kaXRpb24pOwogICAgICBpZiAoY29uZGl0aW9uUGxhbi50eXBlID09PSAiaW5kZXhfc2NhbiIpIHsKICAgICAgICBpbmRleGFibGVDb25kaXRpb25zLnB1c2goY29uZGl0aW9uUGxhbi5pbmRleFNjYW5zWzBdKTsKICAgICAgfQogICAgfQogICAgaWYgKGluZGV4YWJsZUNvbmRpdGlvbnMubGVuZ3RoID4gMSkgewogICAgICBwbGFuLnR5cGUgPSAiaW5kZXhfaW50ZXJzZWN0aW9uIjsKICAgICAgcGxhbi5pbmRleFNjYW5zID0gaW5kZXhhYmxlQ29uZGl0aW9uczsKICAgICAgcGxhbi5pbmRleGVzID0gaW5kZXhhYmxlQ29uZGl0aW9ucy5tYXAoKHNjYW4pID0+IHNjYW4uaW5kZXhOYW1lKTsKICAgICAgcGxhbi5lc3RpbWF0ZWRDb3N0ID0gNTA7CiAgICAgIHJldHVybiBwbGFuOwogICAgfQogICAgaWYgKGluZGV4YWJsZUNvbmRpdGlvbnMubGVuZ3RoID09PSAxKSB7CiAgICAgIHBsYW4udHlwZSA9ICJpbmRleF9zY2FuIjsKICAgICAgcGxhbi5pbmRleFNjYW5zID0gW2luZGV4YWJsZUNvbmRpdGlvbnNbMF1dOwogICAgICBwbGFuLmluZGV4ZXMgPSBbaW5kZXhhYmxlQ29uZGl0aW9uc1swXS5pbmRleE5hbWVdOwogICAgICBwbGFuLmVzdGltYXRlZENvc3QgPSA1MDsKICAgICAgcmV0dXJuIHBsYW47CiAgICB9CiAgICByZXR1cm4gcGxhbjsKICB9CiAgLyoqCiAgICogUGxhbiBmb3IgJG9yIHF1ZXJpZXMgKGluZGV4IHVuaW9uKQogICAqIEBwcml2YXRlCiAgICovCiAgX3BsYW5PclF1ZXJ5KHF1ZXJ5LCBhbmFseXNpcykgewogICAgY29uc3QgcGxhbiA9IG5ldyBRdWVyeVBsYW4oKTsKICAgIGlmICghcXVlcnkuJG9yKSB7CiAgICAgIHJldHVybiBwbGFuOwogICAgfQogICAgY29uc3QgY29uZGl0aW9ucyA9IHF1ZXJ5LiRvcjsKICAgIGNvbnN0IGluZGV4YWJsZUNvbmRpdGlvbnMgPSBbXTsKICAgIGZvciAoY29uc3QgY29uZGl0aW9uIG9mIGNvbmRpdGlvbnMpIHsKICAgICAgY29uc3QgY29uZGl0aW9uUGxhbiA9IHRoaXMuX3BsYW5TaW1wbGVRdWVyeShjb25kaXRpb24pOwogICAgICBpZiAoY29uZGl0aW9uUGxhbi50eXBlID09PSAiaW5kZXhfc2NhbiIpIHsKICAgICAgICBpbmRleGFibGVDb25kaXRpb25zLnB1c2goY29uZGl0aW9uUGxhbi5pbmRleFNjYW5zWzBdKTsKICAgICAgfQogICAgfQogICAgaWYgKGluZGV4YWJsZUNvbmRpdGlvbnMubGVuZ3RoID4gMCkgewogICAgICBwbGFuLnR5cGUgPSAiaW5kZXhfdW5pb24iOwogICAgICBwbGFuLmluZGV4U2NhbnMgPSBpbmRleGFibGVDb25kaXRpb25zOwogICAgICBwbGFuLmluZGV4ZXMgPSBpbmRleGFibGVDb25kaXRpb25zLm1hcCgoc2NhbikgPT4gc2Nhbi5pbmRleE5hbWUpOwogICAgICBwbGFuLmVzdGltYXRlZENvc3QgPSAxMDAgKiBpbmRleGFibGVDb25kaXRpb25zLmxlbmd0aDsKICAgICAgcmV0dXJuIHBsYW47CiAgICB9CiAgICByZXR1cm4gcGxhbjsKICB9CiAgLyoqCiAgICogUGxhbiBmb3Igc2ltcGxlIHNpbmdsZS1maWVsZCBxdWVyaWVzCiAgICogQHByaXZhdGUKICAgKi8KICBfcGxhblNpbXBsZVF1ZXJ5KHF1ZXJ5KSB7CiAgICBjb25zdCBwbGFuID0gbmV3IFF1ZXJ5UGxhbigpOwogICAgY29uc3QgcXVlcnlLZXlzID0gT2JqZWN0LmtleXMocXVlcnkpOwogICAgaWYgKHF1ZXJ5S2V5cy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIHBsYW47CiAgICB9CiAgICBmb3IgKGNvbnN0IFtpbmRleE5hbWUsIGluZGV4XSBvZiB0aGlzLmluZGV4ZXMpIHsKICAgICAgaWYgKGluZGV4IGluc3RhbmNlb2YgVGV4dENvbGxlY3Rpb25JbmRleCB8fCBpbmRleCBpbnN0YW5jZW9mIEdlb3NwYXRpYWxJbmRleCkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGlmICh0aGlzLl9jYW5JbmRleEhhbmRsZVF1ZXJ5KGluZGV4LCBxdWVyeSkpIHsKICAgICAgICBwbGFuLnR5cGUgPSAiaW5kZXhfc2NhbiI7CiAgICAgICAgcGxhbi5pbmRleGVzID0gW2luZGV4TmFtZV07CiAgICAgICAgcGxhbi5pbmRleFNjYW5zID0gW3sgaW5kZXhOYW1lLCBpbmRleCwgcXVlcnkgfV07CiAgICAgICAgcGxhbi5lc3RpbWF0ZWRDb3N0ID0gNTA7CiAgICAgICAgcmV0dXJuIHBsYW47CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBwbGFuOwogIH0KICAvKioKICAgKiBFeGVjdXRlIGEgc2luZ2xlIGluZGV4IHNjYW4gdGhhdCB3YXMgZGVmZXJyZWQgZnJvbSBwbGFubmluZwogICAqIEBwcml2YXRlCiAgICovCiAgYXN5bmMgX2V4ZWN1dGVJbmRleFNjYW4oc2NhbikgewogICAgY29uc3QgeyBpbmRleCwgcXVlcnksIHRleHRRdWVyeSB9ID0gc2NhbjsKICAgIGlmICh0eXBlb2YgaW5kZXgub3BlbiA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgaW5kZXguaXNPcGVuICE9PSAidW5kZWZpbmVkIiAmJiAhaW5kZXguaXNPcGVuKSB7CiAgICAgIGF3YWl0IGluZGV4Lm9wZW4oKTsKICAgIH0KICAgIGlmICh0ZXh0UXVlcnkgIT09IHZvaWQgMCkgewogICAgICByZXR1cm4gYXdhaXQgaW5kZXguc2VhcmNoKHRleHRRdWVyeSk7CiAgICB9CiAgICBpZiAocXVlcnkgIT09IHZvaWQgMCkgewogICAgICBjb25zdCBkb2NJZHMgPSBhd2FpdCBpbmRleC5xdWVyeShxdWVyeSk7CiAgICAgIHJldHVybiBkb2NJZHMgIT09IG51bGwgPyBkb2NJZHMgOiBbXTsKICAgIH0KICAgIGlmIChzY2FuLmRvY0lkcyAhPT0gdm9pZCAwKSB7CiAgICAgIHJldHVybiBzY2FuLmRvY0lkczsKICAgIH0KICAgIHJldHVybiBbXTsKICB9CiAgLyoqCiAgICogQ2hlY2sgaWYgYW4gaW5kZXggY2FuIGhhbmRsZSBhIHF1ZXJ5ICh3aXRob3V0IGV4ZWN1dGluZyBpdCkKICAgKiBAcHJpdmF0ZQogICAqLwogIF9jYW5JbmRleEhhbmRsZVF1ZXJ5KGluZGV4LCBxdWVyeSkgewogICAgY29uc3QgcXVlcnlLZXlzID0gT2JqZWN0LmtleXMocXVlcnkpOwogICAgY29uc3QgaW5kZXhGaWVsZHMgPSBPYmplY3Qua2V5cyhpbmRleC5rZXlzKTsKICAgIGlmIChpbmRleEZpZWxkcy5sZW5ndGggIT09IDEpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgY29uc3QgZmllbGQgPSBpbmRleEZpZWxkc1swXTsKICAgIGlmIChxdWVyeUtleXMuaW5kZXhPZihmaWVsZCkgPT09IC0xKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KICAvKioKICAgKiBFeGVjdXRlIGEgcXVlcnkgcGxhbiBhbmQgcmV0dXJuIGRvY3VtZW50IElEcwogICAqIEBwYXJhbSB7UXVlcnlQbGFufSBwbGFuIC0gVGhlIGV4ZWN1dGlvbiBwbGFuCiAgICogQHJldHVybnMge1Byb21pc2U8QXJyYXl8bnVsbD59IEFycmF5IG9mIGRvY3VtZW50IElEcyBvciBudWxsIGZvciBmdWxsIHNjYW4KICAgKi8KICBhc3luYyBleGVjdXRlKHBsYW4pIHsKICAgIGlmIChwbGFuLnR5cGUgPT09ICJmdWxsX3NjYW4iKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgaWYgKHBsYW4udHlwZSA9PT0gImluZGV4X3NjYW4iKSB7CiAgICAgIGNvbnN0IHNjYW4gPSBwbGFuLmluZGV4U2NhbnNbMF07CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9leGVjdXRlSW5kZXhTY2FuKHNjYW4pOwogICAgfQogICAgaWYgKHBsYW4udHlwZSA9PT0gImluZGV4X2ludGVyc2VjdGlvbiIpIHsKICAgICAgaWYgKHBsYW4uaW5kZXhTY2Fucy5sZW5ndGggPT09IDApIHJldHVybiBudWxsOwogICAgICBjb25zdCByZXN1bHRzID0gW107CiAgICAgIGZvciAoY29uc3Qgc2NhbiBvZiBwbGFuLmluZGV4U2NhbnMpIHsKICAgICAgICByZXN1bHRzLnB1c2goewogICAgICAgICAgZG9jSWRzOiBhd2FpdCB0aGlzLl9leGVjdXRlSW5kZXhTY2FuKHNjYW4pLAogICAgICAgICAgaW5kZXhOYW1lOiBzY2FuLmluZGV4TmFtZQogICAgICAgIH0pOwogICAgICB9CiAgICAgIGNvbnN0IHNvcnRlZCA9IHJlc3VsdHMuc2xpY2UoKS5zb3J0KChhLCBiKSA9PiBhLmRvY0lkcy5sZW5ndGggLSBiLmRvY0lkcy5sZW5ndGgpOwogICAgICBsZXQgcmVzdWx0ID0gbmV3IFNldChzb3J0ZWRbMF0uZG9jSWRzKTsKICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBzb3J0ZWQubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBjdXJyZW50U2V0ID0gbmV3IFNldChzb3J0ZWRbaV0uZG9jSWRzKTsKICAgICAgICByZXN1bHQgPSBuZXcgU2V0KFsuLi5yZXN1bHRdLmZpbHRlcigoaWQpID0+IGN1cnJlbnRTZXQuaGFzKGlkKSkpOwogICAgICAgIGlmIChyZXN1bHQuc2l6ZSA9PT0gMCkgYnJlYWs7CiAgICAgIH0KICAgICAgcmV0dXJuIEFycmF5LmZyb20ocmVzdWx0KTsKICAgIH0KICAgIGlmIChwbGFuLnR5cGUgPT09ICJpbmRleF91bmlvbiIpIHsKICAgICAgY29uc3QgcmVzdWx0ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgZm9yIChjb25zdCBzY2FuIG9mIHBsYW4uaW5kZXhTY2FucykgewogICAgICAgIGNvbnN0IGRvY0lkcyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGVJbmRleFNjYW4oc2Nhbik7CiAgICAgICAgZG9jSWRzLmZvckVhY2goKGlkKSA9PiByZXN1bHQuYWRkKGlkKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIEFycmF5LmZyb20ocmVzdWx0KTsKICAgIH0KICAgIHJldHVybiBudWxsOwogIH0KfQpjbGFzcyBDaGFuZ2VTdHJlYW0gZXh0ZW5kcyBldmVudHNFeHBvcnRzLkV2ZW50RW1pdHRlciB7CiAgY29uc3RydWN0b3IodGFyZ2V0LCBwaXBlbGluZSA9IFtdLCBvcHRpb25zID0ge30pIHsKICAgIHN1cGVyKCk7CiAgICB0aGlzLnRhcmdldCA9IHRhcmdldDsKICAgIHRoaXMucGlwZWxpbmUgPSBwaXBlbGluZTsKICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICB0aGlzLmNsb3NlZCA9IGZhbHNlOwogICAgdGhpcy5fbGlzdGVuZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIHRoaXMuX2NoYW5nZUNvdW50ZXIgPSAwOwogICAgdGhpcy5fc3RhcnRXYXRjaGluZygpOwogIH0KICAvKioKICAgKiBTdGFydCB3YXRjaGluZyBmb3IgY2hhbmdlcwogICAqIEBwcml2YXRlCiAgICovCiAgX3N0YXJ0V2F0Y2hpbmcoKSB7CiAgICBpZiAodGhpcy5jbG9zZWQpIHJldHVybjsKICAgIGNvbnN0IGNvbGxlY3Rpb25zID0gdGhpcy5fZ2V0Q29sbGVjdGlvbnNUb1dhdGNoKCk7CiAgICBmb3IgKGNvbnN0IGNvbGxlY3Rpb24gb2YgY29sbGVjdGlvbnMpIHsKICAgICAgdGhpcy5fd2F0Y2hDb2xsZWN0aW9uKGNvbGxlY3Rpb24pOwogICAgfQogICAgaWYgKHRoaXMudGFyZ2V0LmNvbnN0cnVjdG9yLm5hbWUgPT09ICJTZXJ2ZXIiKSB7CiAgICAgIHRoaXMuX2ludGVyY2VwdFNlcnZlckRCQ3JlYXRpb24oKTsKICAgIH0KICAgIGlmICh0aGlzLnRhcmdldC5jb25zdHJ1Y3Rvci5uYW1lID09PSAiREIiKSB7CiAgICAgIHRoaXMuX2ludGVyY2VwdERCQ29sbGVjdGlvbkNyZWF0aW9uKCk7CiAgICB9CiAgICBpZiAodGhpcy50YXJnZXQuY29uc3RydWN0b3IubmFtZSA9PT0gIk1vbmdvQ2xpZW50IikgewogICAgICB0aGlzLl9pbnRlcmNlcHRDbGllbnREQkNyZWF0aW9uKCk7CiAgICB9CiAgfQogIC8qKgogICAqIEdldCBjb2xsZWN0aW9ucyB0byB3YXRjaCBiYXNlZCBvbiB0YXJnZXQgdHlwZQogICAqIEBwcml2YXRlCiAgICovCiAgX2dldENvbGxlY3Rpb25zVG9XYXRjaCgpIHsKICAgIGNvbnN0IGNvbGxlY3Rpb25zID0gW107CiAgICBpZiAodGhpcy50YXJnZXQuY29uc3RydWN0b3IubmFtZSA9PT0gIlNlcnZlciIpIHsKICAgICAgZm9yIChjb25zdCBbZGJOYW1lLCBkYl0gb2YgdGhpcy50YXJnZXQuZGF0YWJhc2VzKSB7CiAgICAgICAgY29uc3QgY29sbGVjdGlvbk5hbWVzID0gZGIuZ2V0Q29sbGVjdGlvbk5hbWVzKCk7CiAgICAgICAgZm9yIChjb25zdCBuYW1lIG9mIGNvbGxlY3Rpb25OYW1lcykgewogICAgICAgICAgY29uc3QgY29sbGVjdGlvbiA9IGRiW25hbWVdOwogICAgICAgICAgaWYgKGNvbGxlY3Rpb24gJiYgY29sbGVjdGlvbi5pc0NvbGxlY3Rpb24pIHsKICAgICAgICAgICAgY29sbGVjdGlvbnMucHVzaChjb2xsZWN0aW9uKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGNvbGxlY3Rpb25zOwogICAgfQogICAgaWYgKHRoaXMudGFyZ2V0LmNvbnN0cnVjdG9yLm5hbWUgPT09ICJNb25nb0NsaWVudCIpIHsKICAgICAgdGhpcy5fbW9uaXRvckNsaWVudCgpOwogICAgICByZXR1cm4gY29sbGVjdGlvbnM7CiAgICB9CiAgICBpZiAodGhpcy50YXJnZXQuY29uc3RydWN0b3IubmFtZSA9PT0gIkRCIikgewogICAgICBjb25zdCBjb2xsZWN0aW9uTmFtZXMgPSB0aGlzLnRhcmdldC5nZXRDb2xsZWN0aW9uTmFtZXMoKTsKICAgICAgZm9yIChjb25zdCBuYW1lIG9mIGNvbGxlY3Rpb25OYW1lcykgewogICAgICAgIGNvbnN0IGNvbGxlY3Rpb24gPSB0aGlzLnRhcmdldFtuYW1lXTsKICAgICAgICBpZiAoY29sbGVjdGlvbiAmJiBjb2xsZWN0aW9uLmlzQ29sbGVjdGlvbikgewogICAgICAgICAgY29sbGVjdGlvbnMucHVzaChjb2xsZWN0aW9uKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5fbW9uaXRvckRCKCk7CiAgICB9CiAgICBpZiAodGhpcy50YXJnZXQuaXNDb2xsZWN0aW9uKSB7CiAgICAgIGNvbGxlY3Rpb25zLnB1c2godGhpcy50YXJnZXQpOwogICAgfQogICAgcmV0dXJuIGNvbGxlY3Rpb25zOwogIH0KICAvKioKICAgKiBXYXRjaCBhIHNwZWNpZmljIGNvbGxlY3Rpb24gZm9yIGNoYW5nZXMKICAgKiBAcHJpdmF0ZQogICAqLwogIF93YXRjaENvbGxlY3Rpb24oY29sbGVjdGlvbikgewogICAgaWYgKHRoaXMuY2xvc2VkKSByZXR1cm47CiAgICBpZiAoIWNvbGxlY3Rpb24pIHJldHVybjsKICAgIGlmICh0eXBlb2YgY29sbGVjdGlvbi5vbiAhPT0gImZ1bmN0aW9uIikgcmV0dXJuOwogICAgaWYgKCFjb2xsZWN0aW9uLmlzQ29sbGVjdGlvbikgcmV0dXJuOwogICAgaWYgKHRoaXMuX2xpc3RlbmVycy5oYXMoY29sbGVjdGlvbikpIHJldHVybjsKICAgIGNvbnN0IGhhbmRsZXJzID0gewogICAgICBpbnNlcnQ6IChkb2MpID0+IHRoaXMuX2VtaXRDaGFuZ2UoImluc2VydCIsIGNvbGxlY3Rpb24sIGRvYyksCiAgICAgIHVwZGF0ZTogKGRvYywgdXBkYXRlRGVzY3JpcHRpb24pID0+IHRoaXMuX2VtaXRDaGFuZ2UoInVwZGF0ZSIsIGNvbGxlY3Rpb24sIGRvYywgdXBkYXRlRGVzY3JpcHRpb24pLAogICAgICByZXBsYWNlOiAoZG9jKSA9PiB0aGlzLl9lbWl0Q2hhbmdlKCJyZXBsYWNlIiwgY29sbGVjdGlvbiwgZG9jKSwKICAgICAgZGVsZXRlOiAoZG9jKSA9PiB0aGlzLl9lbWl0Q2hhbmdlKCJkZWxldGUiLCBjb2xsZWN0aW9uLCBkb2MpCiAgICB9OwogICAgdGhpcy5fbGlzdGVuZXJzLnNldChjb2xsZWN0aW9uLCBoYW5kbGVycyk7CiAgICBjb2xsZWN0aW9uLm9uKCJpbnNlcnQiLCBoYW5kbGVycy5pbnNlcnQpOwogICAgY29sbGVjdGlvbi5vbigidXBkYXRlIiwgaGFuZGxlcnMudXBkYXRlKTsKICAgIGNvbGxlY3Rpb24ub24oInJlcGxhY2UiLCBoYW5kbGVycy5yZXBsYWNlKTsKICAgIGNvbGxlY3Rpb24ub24oImRlbGV0ZSIsIGhhbmRsZXJzLmRlbGV0ZSk7CiAgfQogIC8qKgogICAqIEVtaXQgYSBjaGFuZ2UgZXZlbnQKICAgKiBAcHJpdmF0ZQogICAqLwogIF9lbWl0Q2hhbmdlKG9wZXJhdGlvblR5cGUsIGNvbGxlY3Rpb24sIGRvYywgdXBkYXRlRGVzY3JpcHRpb24gPSBudWxsKSB7CiAgICBpZiAodGhpcy5jbG9zZWQpIHJldHVybjsKICAgIGNvbnN0IGNoYW5nZUV2ZW50ID0gdGhpcy5fY3JlYXRlQ2hhbmdlRXZlbnQoCiAgICAgIG9wZXJhdGlvblR5cGUsCiAgICAgIGNvbGxlY3Rpb24sCiAgICAgIGRvYywKICAgICAgdXBkYXRlRGVzY3JpcHRpb24KICAgICk7CiAgICBpZiAoIXRoaXMuX21hdGNoZXNQaXBlbGluZShjaGFuZ2VFdmVudCkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5lbWl0KCJjaGFuZ2UiLCBjaGFuZ2VFdmVudCk7CiAgfQogIC8qKgogICAqIENyZWF0ZSBhIE1vbmdvREItY29tcGF0aWJsZSBjaGFuZ2UgZXZlbnQgZG9jdW1lbnQKICAgKiBAcHJpdmF0ZQogICAqLwogIF9jcmVhdGVDaGFuZ2VFdmVudChvcGVyYXRpb25UeXBlLCBjb2xsZWN0aW9uLCBkb2MsIHVwZGF0ZURlc2NyaXB0aW9uKSB7CiAgICBjb25zdCBldmVudCA9IHsKICAgICAgX2lkOiB7CiAgICAgICAgX2RhdGE6IGJ0b2EoU3RyaW5nKCsrdGhpcy5fY2hhbmdlQ291bnRlcikpCiAgICAgIH0sCiAgICAgIG9wZXJhdGlvblR5cGUsCiAgICAgIGNsdXN0ZXJUaW1lOiAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKSwKICAgICAgbnM6IHsKICAgICAgICBkYjogY29sbGVjdGlvbi5kYi5kYk5hbWUsCiAgICAgICAgY29sbDogY29sbGVjdGlvbi5uYW1lCiAgICAgIH0sCiAgICAgIGRvY3VtZW50S2V5OiB7CiAgICAgICAgX2lkOiBkb2MuX2lkCiAgICAgIH0KICAgIH07CiAgICBzd2l0Y2ggKG9wZXJhdGlvblR5cGUpIHsKICAgICAgY2FzZSAiaW5zZXJ0IjoKICAgICAgICBldmVudC5mdWxsRG9jdW1lbnQgPSBkb2M7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgInVwZGF0ZSI6CiAgICAgICAgZXZlbnQudXBkYXRlRGVzY3JpcHRpb24gPSB1cGRhdGVEZXNjcmlwdGlvbiB8fCB7CiAgICAgICAgICB1cGRhdGVkRmllbGRzOiB7fSwKICAgICAgICAgIHJlbW92ZWRGaWVsZHM6IFtdLAogICAgICAgICAgdHJ1bmNhdGVkQXJyYXlzOiBbXQogICAgICAgIH07CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5mdWxsRG9jdW1lbnQgPT09ICJ1cGRhdGVMb29rdXAiKSB7CiAgICAgICAgICBldmVudC5mdWxsRG9jdW1lbnQgPSBkb2M7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJyZXBsYWNlIjoKICAgICAgICBldmVudC5mdWxsRG9jdW1lbnQgPSBkb2M7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgICByZXR1cm4gZXZlbnQ7CiAgfQogIC8qKgogICAqIENoZWNrIGlmIGNoYW5nZSBldmVudCBtYXRjaGVzIHBpcGVsaW5lIGZpbHRlcnMKICAgKiBAcHJpdmF0ZQogICAqLwogIF9tYXRjaGVzUGlwZWxpbmUoY2hhbmdlRXZlbnQpIHsKICAgIGlmICghdGhpcy5waXBlbGluZSB8fCB0aGlzLnBpcGVsaW5lLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGZvciAoY29uc3Qgc3RhZ2Ugb2YgdGhpcy5waXBlbGluZSkgewogICAgICBpZiAoc3RhZ2UuJG1hdGNoKSB7CiAgICAgICAgaWYgKCFtYXRjaGVzKGNoYW5nZUV2ZW50LCBzdGFnZS4kbWF0Y2gpKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgLyoqCiAgICogR2V0IG5lc3RlZCB2YWx1ZSBmcm9tIG9iamVjdCB1c2luZyBkb3Qgbm90YXRpb24KICAgKiBAcHJpdmF0ZQogICAqLwogIF9nZXROZXN0ZWRWYWx1ZShvYmosIHBhdGgpIHsKICAgIHJldHVybiBwYXRoLnNwbGl0KCIuIikucmVkdWNlKChjdXJyZW50LCBwYXJ0KSA9PiBjdXJyZW50Py5bcGFydF0sIG9iaik7CiAgfQogIC8qKgogICAqIE1vbml0b3IgY2xpZW50IGZvciBuZXcgZGF0YWJhc2VzL2NvbGxlY3Rpb25zIChzaW1wbGlmaWVkKQogICAqIEBwcml2YXRlCiAgICovCiAgX21vbml0b3JDbGllbnQoKSB7CiAgfQogIC8qKgogICAqIEludGVyY2VwdCBEQiBjcmVhdGlvbiBvbiBhIE1vbmdvQ2xpZW50CiAgICogQHByaXZhdGUKICAgKi8KICBfaW50ZXJjZXB0Q2xpZW50REJDcmVhdGlvbigpIHsKICAgIGNvbnN0IGNsaWVudCA9IHRoaXMudGFyZ2V0OwogICAgY29uc3Qgb3JpZ2luYWxEYiA9IGNsaWVudC5kYi5iaW5kKGNsaWVudCk7CiAgICBjb25zdCBzZWxmMiA9IHRoaXM7CiAgICB0aGlzLl93YXRjaGVkREJzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIGNsaWVudC5kYiA9IGZ1bmN0aW9uKG5hbWUsIG9wdHMpIHsKICAgICAgY29uc3QgZGF0YWJhc2UgPSBvcmlnaW5hbERiKG5hbWUsIG9wdHMpOwogICAgICBjb25zdCBkYk5hbWUgPSBkYXRhYmFzZS5kYk5hbWU7CiAgICAgIGlmICghc2VsZjIuX3dhdGNoZWREQnMuaGFzKGRiTmFtZSkpIHsKICAgICAgICBzZWxmMi5fd2F0Y2hlZERCcy5zZXQoZGJOYW1lLCBkYXRhYmFzZSk7CiAgICAgICAgY29uc3QgY29sbGVjdGlvbk5hbWVzID0gZGF0YWJhc2UuZ2V0Q29sbGVjdGlvbk5hbWVzKCk7CiAgICAgICAgZm9yIChjb25zdCBjb2xOYW1lIG9mIGNvbGxlY3Rpb25OYW1lcykgewogICAgICAgICAgY29uc3QgY29sID0gZGF0YWJhc2VbY29sTmFtZV07CiAgICAgICAgICBpZiAoY29sICYmIGNvbC5pc0NvbGxlY3Rpb24gJiYgIXNlbGYyLl9saXN0ZW5lcnMuaGFzKGNvbCkpIHsKICAgICAgICAgICAgc2VsZjIuX3dhdGNoQ29sbGVjdGlvbihjb2wpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzZWxmMi5faW50ZXJjZXB0REJDb2xsZWN0aW9uQ3JlYXRpb25Gb3JDbGllbnQoZGF0YWJhc2UpOwogICAgICB9CiAgICAgIHJldHVybiBkYXRhYmFzZTsKICAgIH07CiAgICB0aGlzLl9vcmlnaW5hbENsaWVudE1ldGhvZHMgPSB7IGRiOiBvcmlnaW5hbERiIH07CiAgfQogIC8qKgogICAqIEludGVyY2VwdCBEQiBjcmVhdGlvbiBvbiBhIFNlcnZlcgogICAqIEBwcml2YXRlCiAgICovCiAgX2ludGVyY2VwdFNlcnZlckRCQ3JlYXRpb24oKSB7CiAgICBjb25zdCBzZXJ2ZXIyID0gdGhpcy50YXJnZXQ7CiAgICBjb25zdCBvcmlnaW5hbEdldERCID0gc2VydmVyMi5fZ2V0REIuYmluZChzZXJ2ZXIyKTsKICAgIGNvbnN0IHNlbGYyID0gdGhpczsKICAgIHRoaXMuX3dhdGNoZWREQnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgc2VydmVyMi5fZ2V0REIgPSBmdW5jdGlvbihkYk5hbWUpIHsKICAgICAgY29uc3QgZGIgPSBvcmlnaW5hbEdldERCKGRiTmFtZSk7CiAgICAgIGlmICghc2VsZjIuX3dhdGNoZWREQnMuaGFzKGRiTmFtZSkpIHsKICAgICAgICBzZWxmMi5fd2F0Y2hlZERCcy5zZXQoZGJOYW1lLCBkYik7CiAgICAgICAgY29uc3QgY29sbGVjdGlvbk5hbWVzID0gZGIuZ2V0Q29sbGVjdGlvbk5hbWVzKCk7CiAgICAgICAgZm9yIChjb25zdCBjb2xOYW1lIG9mIGNvbGxlY3Rpb25OYW1lcykgewogICAgICAgICAgY29uc3QgY29sID0gZGJbY29sTmFtZV07CiAgICAgICAgICBpZiAoY29sICYmIGNvbC5pc0NvbGxlY3Rpb24gJiYgIXNlbGYyLl9saXN0ZW5lcnMuaGFzKGNvbCkpIHsKICAgICAgICAgICAgc2VsZjIuX3dhdGNoQ29sbGVjdGlvbihjb2wpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzZWxmMi5faW50ZXJjZXB0REJDb2xsZWN0aW9uQ3JlYXRpb25Gb3JTZXJ2ZXIoZGIpOwogICAgICB9CiAgICAgIHJldHVybiBkYjsKICAgIH07CiAgICB0aGlzLl9vcmlnaW5hbFNlcnZlck1ldGhvZHMgPSB7IF9nZXREQjogb3JpZ2luYWxHZXREQiB9OwogIH0KICAvKioKICAgKiBJbnRlcmNlcHQgY29sbGVjdGlvbiBjcmVhdGlvbiBmb3IgYSBkYXRhYmFzZSBpbiBzZXJ2ZXIgd2F0Y2ggbW9kZQogICAqIEBwcml2YXRlCiAgICovCiAgX2ludGVyY2VwdERCQ29sbGVjdGlvbkNyZWF0aW9uRm9yU2VydmVyKGRiKSB7CiAgICBjb25zdCBvcmlnaW5hbENvbGxlY3Rpb24gPSBkYi5jb2xsZWN0aW9uLmJpbmQoZGIpOwogICAgY29uc3Qgb3JpZ2luYWxDcmVhdGVDb2xsZWN0aW9uID0gZGIuY3JlYXRlQ29sbGVjdGlvbi5iaW5kKGRiKTsKICAgIGNvbnN0IHNlbGYyID0gdGhpczsKICAgIGRiLmNvbGxlY3Rpb24gPSBmdW5jdGlvbihuYW1lKSB7CiAgICAgIGNvbnN0IGNvbCA9IG9yaWdpbmFsQ29sbGVjdGlvbihuYW1lKTsKICAgICAgaWYgKGNvbCAmJiBjb2wuaXNDb2xsZWN0aW9uICYmICFzZWxmMi5fbGlzdGVuZXJzLmhhcyhjb2wpKSB7CiAgICAgICAgc2VsZjIuX3dhdGNoQ29sbGVjdGlvbihjb2wpOwogICAgICB9CiAgICAgIHJldHVybiBjb2w7CiAgICB9OwogICAgZGIuY3JlYXRlQ29sbGVjdGlvbiA9IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgb3JpZ2luYWxDcmVhdGVDb2xsZWN0aW9uKG5hbWUpOwogICAgICBjb25zdCBjb2wgPSBkYltuYW1lXTsKICAgICAgaWYgKGNvbCAmJiBjb2wuaXNDb2xsZWN0aW9uICYmICFzZWxmMi5fbGlzdGVuZXJzLmhhcyhjb2wpKSB7CiAgICAgICAgc2VsZjIuX3dhdGNoQ29sbGVjdGlvbihjb2wpOwogICAgICB9CiAgICB9OwogIH0KICAvKioKICAgKiBJbnRlcmNlcHQgY29sbGVjdGlvbiBjcmVhdGlvbiBmb3IgYSBkYXRhYmFzZSBpbiBjbGllbnQgd2F0Y2ggbW9kZQogICAqIEBwcml2YXRlCiAgICovCiAgX2ludGVyY2VwdERCQ29sbGVjdGlvbkNyZWF0aW9uRm9yQ2xpZW50KGRiKSB7CiAgICBjb25zdCBvcmlnaW5hbENvbGxlY3Rpb24gPSBkYi5jb2xsZWN0aW9uLmJpbmQoZGIpOwogICAgY29uc3Qgb3JpZ2luYWxDcmVhdGVDb2xsZWN0aW9uID0gZGIuY3JlYXRlQ29sbGVjdGlvbi5iaW5kKGRiKTsKICAgIGNvbnN0IHNlbGYyID0gdGhpczsKICAgIGRiLmNvbGxlY3Rpb24gPSBmdW5jdGlvbihuYW1lKSB7CiAgICAgIGNvbnN0IGNvbCA9IG9yaWdpbmFsQ29sbGVjdGlvbihuYW1lKTsKICAgICAgaWYgKGNvbCAmJiBjb2wuaXNDb2xsZWN0aW9uICYmICFzZWxmMi5fbGlzdGVuZXJzLmhhcyhjb2wpKSB7CiAgICAgICAgc2VsZjIuX3dhdGNoQ29sbGVjdGlvbihjb2wpOwogICAgICB9CiAgICAgIHJldHVybiBjb2w7CiAgICB9OwogICAgZGIuY3JlYXRlQ29sbGVjdGlvbiA9IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgb3JpZ2luYWxDcmVhdGVDb2xsZWN0aW9uKG5hbWUpOwogICAgICBjb25zdCBjb2wgPSBkYltuYW1lXTsKICAgICAgaWYgKGNvbCAmJiBjb2wuaXNDb2xsZWN0aW9uICYmICFzZWxmMi5fbGlzdGVuZXJzLmhhcyhjb2wpKSB7CiAgICAgICAgc2VsZjIuX3dhdGNoQ29sbGVjdGlvbihjb2wpOwogICAgICB9CiAgICB9OwogIH0KICAvKioKICAgKiBNb25pdG9yIGRhdGFiYXNlIGZvciBuZXcgY29sbGVjdGlvbnMKICAgKiBAcHJpdmF0ZQogICAqLwogIF9tb25pdG9yREIoKSB7CiAgfQogIC8qKgogICAqIEludGVyY2VwdCBuZXcgY29sbGVjdGlvbiBjcmVhdGlvbiBvbiBhIERCCiAgICogQHByaXZhdGUKICAgKi8KICBfaW50ZXJjZXB0REJDb2xsZWN0aW9uQ3JlYXRpb24oKSB7CiAgICBjb25zdCBkYiA9IHRoaXMudGFyZ2V0OwogICAgY29uc3Qgb3JpZ2luYWxDb2xsZWN0aW9uID0gZGIuY29sbGVjdGlvbi5iaW5kKGRiKTsKICAgIGNvbnN0IG9yaWdpbmFsQ3JlYXRlQ29sbGVjdGlvbiA9IGRiLmNyZWF0ZUNvbGxlY3Rpb24uYmluZChkYik7CiAgICBjb25zdCBzZWxmMiA9IHRoaXM7CiAgICBkYi5jb2xsZWN0aW9uID0gZnVuY3Rpb24obmFtZSkgewogICAgICBjb25zdCBjb2wgPSBvcmlnaW5hbENvbGxlY3Rpb24obmFtZSk7CiAgICAgIGlmIChjb2wgJiYgY29sLmlzQ29sbGVjdGlvbiAmJiAhc2VsZjIuX2xpc3RlbmVycy5oYXMoY29sKSkgewogICAgICAgIHNlbGYyLl93YXRjaENvbGxlY3Rpb24oY29sKTsKICAgICAgfQogICAgICByZXR1cm4gY29sOwogICAgfTsKICAgIGRiLmNyZWF0ZUNvbGxlY3Rpb24gPSBmdW5jdGlvbihuYW1lKSB7CiAgICAgIG9yaWdpbmFsQ3JlYXRlQ29sbGVjdGlvbihuYW1lKTsKICAgICAgY29uc3QgY29sID0gZGJbbmFtZV07CiAgICAgIGlmIChjb2wgJiYgY29sLmlzQ29sbGVjdGlvbiAmJiAhc2VsZjIuX2xpc3RlbmVycy5oYXMoY29sKSkgewogICAgICAgIHNlbGYyLl93YXRjaENvbGxlY3Rpb24oY29sKTsKICAgICAgfQogICAgfTsKICAgIHRoaXMuX29yaWdpbmFsREJNZXRob2RzID0geyBjb2xsZWN0aW9uOiBvcmlnaW5hbENvbGxlY3Rpb24sIGNyZWF0ZUNvbGxlY3Rpb246IG9yaWdpbmFsQ3JlYXRlQ29sbGVjdGlvbiB9OwogIH0KICAvKioKICAgKiBDbG9zZSB0aGUgY2hhbmdlIHN0cmVhbQogICAqLwogIGNsb3NlKCkgewogICAgaWYgKHRoaXMuY2xvc2VkKSByZXR1cm47CiAgICB0aGlzLmNsb3NlZCA9IHRydWU7CiAgICBmb3IgKGNvbnN0IFtjb2xsZWN0aW9uLCBoYW5kbGVyc10gb2YgdGhpcy5fbGlzdGVuZXJzKSB7CiAgICAgIGNvbGxlY3Rpb24ub2ZmKCJpbnNlcnQiLCBoYW5kbGVycy5pbnNlcnQpOwogICAgICBjb2xsZWN0aW9uLm9mZigidXBkYXRlIiwgaGFuZGxlcnMudXBkYXRlKTsKICAgICAgY29sbGVjdGlvbi5vZmYoInJlcGxhY2UiLCBoYW5kbGVycy5yZXBsYWNlKTsKICAgICAgY29sbGVjdGlvbi5vZmYoImRlbGV0ZSIsIGhhbmRsZXJzLmRlbGV0ZSk7CiAgICB9CiAgICB0aGlzLl9saXN0ZW5lcnMuY2xlYXIoKTsKICAgIGlmICh0aGlzLl9vcmlnaW5hbFNlcnZlck1ldGhvZHMgJiYgdGhpcy50YXJnZXQuY29uc3RydWN0b3IubmFtZSA9PT0gIlNlcnZlciIpIHsKICAgICAgdGhpcy50YXJnZXQuX2dldERCID0gdGhpcy5fb3JpZ2luYWxTZXJ2ZXJNZXRob2RzLl9nZXREQjsKICAgIH0KICAgIGlmICh0aGlzLl9vcmlnaW5hbERCTWV0aG9kcyAmJiB0aGlzLnRhcmdldC5jb25zdHJ1Y3Rvci5uYW1lID09PSAiREIiKSB7CiAgICAgIHRoaXMudGFyZ2V0LmNvbGxlY3Rpb24gPSB0aGlzLl9vcmlnaW5hbERCTWV0aG9kcy5jb2xsZWN0aW9uOwogICAgICB0aGlzLnRhcmdldC5jcmVhdGVDb2xsZWN0aW9uID0gdGhpcy5fb3JpZ2luYWxEQk1ldGhvZHMuY3JlYXRlQ29sbGVjdGlvbjsKICAgIH0KICAgIGlmICh0aGlzLl9vcmlnaW5hbENsaWVudE1ldGhvZHMgJiYgdGhpcy50YXJnZXQuY29uc3RydWN0b3IubmFtZSA9PT0gIk1vbmdvQ2xpZW50IikgewogICAgICB0aGlzLnRhcmdldC5kYiA9IHRoaXMuX29yaWdpbmFsQ2xpZW50TWV0aG9kcy5kYjsKICAgIH0KICAgIHRoaXMuZW1pdCgiY2xvc2UiKTsKICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKCk7CiAgfQogIC8qKgogICAqIENoZWNrIGlmIHRoZSBzdHJlYW0gaXMgY2xvc2VkCiAgICovCiAgZ2V0IGlzQ2xvc2VkKCkgewogICAgcmV0dXJuIHRoaXMuY2xvc2VkOwogIH0KICAvKioKICAgKiBBc3luYyBpdGVyYXRvciBzdXBwb3J0IGZvciBmb3ItYXdhaXQtb2YgbG9vcHMKICAgKi8KICBhc3luYyAqW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpIHsKICAgIGNvbnN0IHF1ZXVlID0gW107CiAgICBsZXQgcmVzb2x2ZU5leHQgPSBudWxsOwogICAgbGV0IHN0cmVhbUNsb3NlZCA9IGZhbHNlOwogICAgY29uc3Qgb25DaGFuZ2UgPSAoY2hhbmdlKSA9PiB7CiAgICAgIGlmIChyZXNvbHZlTmV4dCkgewogICAgICAgIHJlc29sdmVOZXh0KHsgdmFsdWU6IGNoYW5nZSwgZG9uZTogZmFsc2UgfSk7CiAgICAgICAgcmVzb2x2ZU5leHQgPSBudWxsOwogICAgICB9IGVsc2UgewogICAgICAgIHF1ZXVlLnB1c2goY2hhbmdlKTsKICAgICAgfQogICAgfTsKICAgIGNvbnN0IG9uQ2xvc2UgPSAoKSA9PiB7CiAgICAgIHN0cmVhbUNsb3NlZCA9IHRydWU7CiAgICAgIGlmIChyZXNvbHZlTmV4dCkgewogICAgICAgIHJlc29sdmVOZXh0KHsgZG9uZTogdHJ1ZSB9KTsKICAgICAgICByZXNvbHZlTmV4dCA9IG51bGw7CiAgICAgIH0KICAgIH07CiAgICBjb25zdCBvbkVycm9yID0gKGVycm9yKSA9PiB7CiAgICAgIGlmIChyZXNvbHZlTmV4dCkgewogICAgICAgIHJlc29sdmVOZXh0KFByb21pc2UucmVqZWN0KGVycm9yKSk7CiAgICAgICAgcmVzb2x2ZU5leHQgPSBudWxsOwogICAgICB9CiAgICB9OwogICAgdGhpcy5vbigiY2hhbmdlIiwgb25DaGFuZ2UpOwogICAgdGhpcy5vbigiY2xvc2UiLCBvbkNsb3NlKTsKICAgIHRoaXMub24oImVycm9yIiwgb25FcnJvcik7CiAgICB0cnkgewogICAgICB3aGlsZSAoIXN0cmVhbUNsb3NlZCkgewogICAgICAgIGlmIChxdWV1ZS5sZW5ndGggPiAwKSB7CiAgICAgICAgICB5aWVsZCBxdWV1ZS5zaGlmdCgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCBuZXh0ID0gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgICAgcmVzb2x2ZU5leHQgPSByZXNvbHZlOwogICAgICAgICAgICBpZiAoc3RyZWFtQ2xvc2VkKSB7CiAgICAgICAgICAgICAgcmVzb2x2ZSh7IGRvbmU6IHRydWUgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgaWYgKG5leHQuZG9uZSkgYnJlYWs7CiAgICAgICAgICB5aWVsZCBuZXh0LnZhbHVlOwogICAgICAgIH0KICAgICAgfQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5vZmYoImNoYW5nZSIsIG9uQ2hhbmdlKTsKICAgICAgdGhpcy5vZmYoImNsb3NlIiwgb25DbG9zZSk7CiAgICAgIHRoaXMub2ZmKCJlcnJvciIsIG9uRXJyb3IpOwogICAgfQogIH0KICAvKioKICAgKiBHZXQgbmV4dCBjaGFuZ2UgKGZvciBjb21wYXRpYmlsaXR5KQogICAqLwogIGFzeW5jIG5leHQoKSB7CiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICBjb25zdCBvbkNoYW5nZSA9IChjaGFuZ2UpID0+IHsKICAgICAgICBjbGVhbnVwKCk7CiAgICAgICAgcmVzb2x2ZShjaGFuZ2UpOwogICAgICB9OwogICAgICBjb25zdCBvbkNsb3NlID0gKCkgPT4gewogICAgICAgIGNsZWFudXAoKTsKICAgICAgICByZXNvbHZlKG51bGwpOwogICAgICB9OwogICAgICBjb25zdCBvbkVycm9yID0gKGVycm9yKSA9PiB7CiAgICAgICAgY2xlYW51cCgpOwogICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgIH07CiAgICAgIGNvbnN0IGNsZWFudXAgPSAoKSA9PiB7CiAgICAgICAgdGhpcy5vZmYoImNoYW5nZSIsIG9uQ2hhbmdlKTsKICAgICAgICB0aGlzLm9mZigiY2xvc2UiLCBvbkNsb3NlKTsKICAgICAgICB0aGlzLm9mZigiZXJyb3IiLCBvbkVycm9yKTsKICAgICAgfTsKICAgICAgaWYgKHRoaXMuY2xvc2VkKSB7CiAgICAgICAgcmVzb2x2ZShudWxsKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdGhpcy5vbmNlKCJjaGFuZ2UiLCBvbkNoYW5nZSk7CiAgICAgIHRoaXMub25jZSgiY2xvc2UiLCBvbkNsb3NlKTsKICAgICAgdGhpcy5vbmNlKCJlcnJvciIsIG9uRXJyb3IpOwogICAgfSk7CiAgfQp9CmNsYXNzIENvbGxlY3Rpb24gZXh0ZW5kcyBldmVudHNFeHBvcnRzLkV2ZW50RW1pdHRlciB7CiAgY29uc3RydWN0b3IoZGIsIG5hbWUsIG9wdGlvbnMgPSB7fSkgewogICAgc3VwZXIoKTsKICAgIHRoaXMuZGIgPSBkYjsKICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICB0aGlzLnBhdGggPSBgJHt0aGlzLmRiLmJhc2VGb2xkZXJ9LyR7dGhpcy5kYi5kYk5hbWV9LyR7dGhpcy5uYW1lfWA7CiAgICB0aGlzLmRvY3VtZW50c1BhdGggPSBgJHt0aGlzLnBhdGh9L2RvY3VtZW50cy5ianNvbmA7CiAgICB0aGlzLmRvY3VtZW50c1ZlcnNpb25lZFBhdGggPSBudWxsOwogICAgdGhpcy5kb2N1bWVudHNWZXJzaW9uID0gMDsKICAgIHRoaXMuX3JlbGVhc2VEb2N1bWVudHMgPSBudWxsOwogICAgdGhpcy5vcmRlciA9IG9wdGlvbnMuYlBsdXNUcmVlT3JkZXIgfHwgNTA7CiAgICB0aGlzLmRvY3VtZW50cyA9IG51bGw7CiAgICB0aGlzLmluZGV4ZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgdGhpcy5faW5pdGlhbGl6ZWQgPSBmYWxzZTsKICAgIHRoaXMuaXNDb2xsZWN0aW9uID0gdHJ1ZTsKICAgIHRoaXMucXVlcnlQbGFubmVyID0gbmV3IFF1ZXJ5UGxhbm5lcih0aGlzLmluZGV4ZXMpOwogIH0KICBhc3luYyBfaW5pdGlhbGl6ZSgpIHsKICAgIGlmICh0aGlzLl9pbml0aWFsaXplZCkgcmV0dXJuOwogICAgaWYgKCFnbG9iYWxUaGlzLm5hdmlnYXRvciB8fCAhZ2xvYmFsVGhpcy5uYXZpZ2F0b3Iuc3RvcmFnZSB8fCB0eXBlb2YgZ2xvYmFsVGhpcy5uYXZpZ2F0b3Iuc3RvcmFnZS5nZXREaXJlY3RvcnkgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJPUEZTIG5vdCBhdmFpbGFibGU6IG5hdmlnYXRvci5zdG9yYWdlLmdldERpcmVjdG9yeSBpcyBtaXNzaW5nIik7CiAgICB9CiAgICBjb25zdCB7IHZlcnNpb24sIHBhdGg6IHZlcnNpb25lZFBhdGggfSA9IGF3YWl0IGFjcXVpcmVWZXJzaW9uZWRQYXRoKHRoaXMuZG9jdW1lbnRzUGF0aCk7CiAgICB0aGlzLmRvY3VtZW50c1ZlcnNpb24gPSB2ZXJzaW9uOwogICAgdGhpcy5kb2N1bWVudHNWZXJzaW9uZWRQYXRoID0gdmVyc2lvbmVkUGF0aDsKICAgIHRoaXMuX3JlbGVhc2VEb2N1bWVudHMgPSAoKSA9PiByZWxlYXNlVmVyc2lvbmVkUGF0aCh0aGlzLmRvY3VtZW50c1BhdGgsIHZlcnNpb24pOwogICAgbGV0IGRpckhhbmRsZSA9IGF3YWl0IHRoaXMuX2Vuc3VyZURpcmVjdG9yeUZvckZpbGUodGhpcy5kb2N1bWVudHNWZXJzaW9uZWRQYXRoKTsKICAgIGlmICghZGlySGFuZGxlKSB7CiAgICAgIGRpckhhbmRsZSA9IGF3YWl0IGdsb2JhbFRoaXMubmF2aWdhdG9yLnN0b3JhZ2UuZ2V0RGlyZWN0b3J5KCk7CiAgICB9CiAgICBjb25zdCBwYXRoUGFydHMgPSB0aGlzLmRvY3VtZW50c1ZlcnNpb25lZFBhdGguc3BsaXQoIi8iKS5maWx0ZXIoQm9vbGVhbik7CiAgICBjb25zdCBmaWxlbmFtZSA9IHBhdGhQYXJ0c1twYXRoUGFydHMubGVuZ3RoIC0gMV07CiAgICBpZiAoIWZpbGVuYW1lKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBkb2N1bWVudHMgcGF0aDogJHt0aGlzLmRvY3VtZW50c1ZlcnNpb25lZFBhdGh9YCk7CiAgICB9CiAgICBjb25zdCBmaWxlSGFuZGxlID0gYXdhaXQgZGlySGFuZGxlLmdldEZpbGVIYW5kbGUoZmlsZW5hbWUsIHsgY3JlYXRlOiB0cnVlIH0pOwogICAgY29uc3Qgc3luY0hhbmRsZSA9IGF3YWl0IGZpbGVIYW5kbGUuY3JlYXRlU3luY0FjY2Vzc0hhbmRsZSgpOwogICAgdGhpcy5kb2N1bWVudHMgPSBuZXcgQlBsdXNUcmVlKHN5bmNIYW5kbGUsIHRoaXMub3JkZXIpOwogICAgYXdhaXQgdGhpcy5kb2N1bWVudHMub3BlbigpOwogICAgYXdhaXQgdGhpcy5fbG9hZEluZGV4ZXMoKTsKICAgIHRoaXMuX2luaXRpYWxpemVkID0gdHJ1ZTsKICB9CiAgYXN5bmMgX2Vuc3VyZURpcmVjdG9yeUZvckZpbGUoZmlsZVBhdGgpIHsKICAgIGlmICghZmlsZVBhdGgpIHJldHVybjsKICAgIGNvbnN0IHBhdGhQYXJ0cyA9IGZpbGVQYXRoLnNwbGl0KCIvIikuZmlsdGVyKEJvb2xlYW4pOwogICAgcGF0aFBhcnRzLnBvcCgpOwogICAgaWYgKHBhdGhQYXJ0cy5sZW5ndGggPT09IDApIHJldHVybjsKICAgIHRyeSB7CiAgICAgIGxldCBkaXIgPSBhd2FpdCBnbG9iYWxUaGlzLm5hdmlnYXRvci5zdG9yYWdlLmdldERpcmVjdG9yeSgpOwogICAgICBmb3IgKGNvbnN0IHBhcnQgb2YgcGF0aFBhcnRzKSB7CiAgICAgICAgZGlyID0gYXdhaXQgZGlyLmdldERpcmVjdG9yeUhhbmRsZShwYXJ0LCB7IGNyZWF0ZTogdHJ1ZSB9KTsKICAgICAgfQogICAgICByZXR1cm4gZGlyOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGVycm9yLmNvZGUgIT09ICJFRVhJU1QiKSB7CiAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgIH0KICAgIH0KICB9CiAgYXN5bmMgX2xvYWRJbmRleGVzKCkgewogICAgbGV0IGRpckhhbmRsZTsKICAgIHRyeSB7CiAgICAgIGNvbnN0IHBhcnRzID0gdGhpcy5wYXRoLnNwbGl0KCIvIikuZmlsdGVyKEJvb2xlYW4pOwogICAgICBsZXQgaGFuZGxlID0gYXdhaXQgZ2xvYmFsVGhpcy5uYXZpZ2F0b3Iuc3RvcmFnZS5nZXREaXJlY3RvcnkoKTsKICAgICAgZm9yIChjb25zdCBwYXJ0IG9mIHBhcnRzKSB7CiAgICAgICAgaGFuZGxlID0gYXdhaXQgaGFuZGxlLmdldERpcmVjdG9yeUhhbmRsZShwYXJ0LCB7IGNyZWF0ZTogZmFsc2UgfSk7CiAgICAgIH0KICAgICAgZGlySGFuZGxlID0gaGFuZGxlOwogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGlmIChlcnI/Lm5hbWUgPT09ICJOb3RGb3VuZEVycm9yIiB8fCBlcnI/LmNvZGUgPT09ICJFTk9FTlQiKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHRocm93IGVycjsKICAgIH0KICAgIGZvciBhd2FpdCAoY29uc3QgW2VudHJ5TmFtZSwgZW50cnlIYW5kbGVdIG9mIGRpckhhbmRsZS5lbnRyaWVzKCkpIHsKICAgICAgaWYgKGVudHJ5SGFuZGxlLmtpbmQgIT09ICJmaWxlIikgY29udGludWU7CiAgICAgIGNvbnN0IHZlcnNpb25TdWZmaXhQYXR0ZXJuID0gL1wudlxkKyg/PS18JCkvOwogICAgICBjb25zdCBub3JtYWxpemVkTmFtZSA9IGVudHJ5TmFtZS5yZXBsYWNlKHZlcnNpb25TdWZmaXhQYXR0ZXJuLCAiIik7CiAgICAgIGxldCB0eXBlOwogICAgICBpZiAobm9ybWFsaXplZE5hbWUuZW5kc1dpdGgoIi50ZXh0aW5kZXgtZG9jdW1lbnRzLmJqc29uIikpIHsKICAgICAgICB0eXBlID0gInRleHQiOwogICAgICB9IGVsc2UgaWYgKG5vcm1hbGl6ZWROYW1lLmVuZHNXaXRoKCIucnRyZWUuYmpzb24iKSkgewogICAgICAgIHR5cGUgPSAiZ2Vvc3BhdGlhbCI7CiAgICAgIH0gZWxzZSBpZiAobm9ybWFsaXplZE5hbWUuZW5kc1dpdGgoIi5icGx1c3RyZWUuYmpzb24iKSkgewogICAgICAgIHR5cGUgPSAicmVndWxhciI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY29uc3QgaW5kZXhOYW1lID0gbm9ybWFsaXplZE5hbWUucmVwbGFjZSgvXC50ZXh0aW5kZXgtZG9jdW1lbnRzXC5ianNvbiQvLCAiIikucmVwbGFjZSgvXC5ydHJlZVwuYmpzb24kLywgIiIpLnJlcGxhY2UoL1wuYnBsdXN0cmVlXC5ianNvbiQvLCAiIik7CiAgICAgIGlmICh0aGlzLmluZGV4ZXMuaGFzKGluZGV4TmFtZSkpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBjb25zdCBrZXlzID0gdGhpcy5fcGFyc2VJbmRleE5hbWUoaW5kZXhOYW1lLCB0eXBlKTsKICAgICAgaWYgKCFrZXlzKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgbGV0IGluZGV4OwogICAgICBpZiAodHlwZSA9PT0gInRleHQiKSB7CiAgICAgICAgY29uc3Qgc3RvcmFnZUZpbGUgPSBhd2FpdCB0aGlzLl9nZXRJbmRleFBhdGgoaW5kZXhOYW1lLCB0eXBlKTsKICAgICAgICBpbmRleCA9IG5ldyBUZXh0Q29sbGVjdGlvbkluZGV4KGluZGV4TmFtZSwga2V5cywgc3RvcmFnZUZpbGUsIHt9KTsKICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAiZ2Vvc3BhdGlhbCIpIHsKICAgICAgICBjb25zdCBzdG9yYWdlRmlsZSA9IGF3YWl0IHRoaXMuX2dldEluZGV4UGF0aChpbmRleE5hbWUsIHR5cGUpOwogICAgICAgIGluZGV4ID0gbmV3IEdlb3NwYXRpYWxJbmRleChpbmRleE5hbWUsIGtleXMsIHN0b3JhZ2VGaWxlLCB7fSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3Qgc3RvcmFnZUZpbGUgPSBhd2FpdCB0aGlzLl9nZXRJbmRleFBhdGgoaW5kZXhOYW1lLCB0eXBlKTsKICAgICAgICBpbmRleCA9IG5ldyBSZWd1bGFyQ29sbGVjdGlvbkluZGV4KGluZGV4TmFtZSwga2V5cywgc3RvcmFnZUZpbGUsIHt9KTsKICAgICAgfQogICAgICB0cnkgewogICAgICAgIGF3YWl0IGluZGV4Lm9wZW4oKTsKICAgICAgICB0aGlzLmluZGV4ZXMuc2V0KGluZGV4TmFtZSwgaW5kZXgpOwogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgfQogICAgfQogIH0KICBfcGFyc2VJbmRleE5hbWUoaW5kZXhOYW1lLCB0eXBlKSB7CiAgICBjb25zdCB0b2tlbnMgPSBpbmRleE5hbWUuc3BsaXQoIl8iKTsKICAgIGlmICh0b2tlbnMubGVuZ3RoIDwgMiB8fCB0b2tlbnMubGVuZ3RoICUgMiAhPT0gMCkgcmV0dXJuIG51bGw7CiAgICBjb25zdCBrZXlzID0ge307CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRva2Vucy5sZW5ndGg7IGkgKz0gMikgewogICAgICBjb25zdCBmaWVsZCA9IHRva2Vuc1tpXTsKICAgICAgY29uc3QgZGlyID0gdG9rZW5zW2kgKyAxXTsKICAgICAgaWYgKCFmaWVsZCB8fCBkaXIgPT09IHZvaWQgMCkgcmV0dXJuIG51bGw7CiAgICAgIGlmICh0eXBlID09PSAidGV4dCIgfHwgZGlyID09PSAidGV4dCIpIHsKICAgICAgICBrZXlzW2ZpZWxkXSA9ICJ0ZXh0IjsKICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAiZ2Vvc3BhdGlhbCIgfHwgZGlyID09PSAiMmRzcGhlcmUiIHx8IGRpciA9PT0gIjJkIikgewogICAgICAgIGtleXNbZmllbGRdID0gZGlyID09PSAiMmQiID8gIjJkIiA6ICIyZHNwaGVyZSI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgbnVtID0gTnVtYmVyKGRpcik7CiAgICAgICAgaWYgKE51bWJlci5pc05hTihudW0pIHx8IG51bSAhPT0gMSAmJiBudW0gIT09IC0xKSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAga2V5c1tmaWVsZF0gPSBudW07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBrZXlzOwogIH0KICAvKioKICAgKiBDbG9zZSBhbGwgaW5kZXhlcwogICAqLwogIGFzeW5jIGNsb3NlKCkgewogICAgaWYgKCF0aGlzLl9pbml0aWFsaXplZCkgcmV0dXJuOwogICAgZm9yIChjb25zdCBbaW5kZXhOYW1lLCBpbmRleF0gb2YgdGhpcy5pbmRleGVzKSB7CiAgICAgIGF3YWl0IGluZGV4LmNsb3NlKCk7CiAgICB9CiAgICBhd2FpdCB0aGlzLl9tYXliZUNvbXBhY3REb2N1bWVudHMoKTsKICAgIGF3YWl0IHRoaXMuZG9jdW1lbnRzLmNsb3NlKCk7CiAgICBpZiAodGhpcy5fcmVsZWFzZURvY3VtZW50cykgewogICAgICBhd2FpdCB0aGlzLl9yZWxlYXNlRG9jdW1lbnRzKCk7CiAgICAgIHRoaXMuX3JlbGVhc2VEb2N1bWVudHMgPSBudWxsOwogICAgfQogIH0KICBhc3luYyBfbWF5YmVDb21wYWN0RG9jdW1lbnRzKCkgewogICAgaWYgKCF0aGlzLmRvY3VtZW50cyB8fCAhdGhpcy5kb2N1bWVudHMuZmlsZSkgcmV0dXJuOwogICAgY29uc3QgY3VycmVudFZlcnNpb24gPSBhd2FpdCBnZXRDdXJyZW50VmVyc2lvbih0aGlzLmRvY3VtZW50c1BhdGgpOwogICAgaWYgKGN1cnJlbnRWZXJzaW9uICE9PSB0aGlzLmRvY3VtZW50c1ZlcnNpb24pIHJldHVybjsKICAgIGNvbnN0IGZpbGVTaXplID0gdGhpcy5kb2N1bWVudHMuZmlsZS5nZXRGaWxlU2l6ZSgpOwogICAgaWYgKCFmaWxlU2l6ZSB8fCBmaWxlU2l6ZSA8IERFRkFVTFRfQ09NUEFDVElPTl9NSU5fQllURVMpIHJldHVybjsKICAgIGNvbnN0IG5leHRWZXJzaW9uID0gY3VycmVudFZlcnNpb24gKyAxOwogICAgY29uc3QgY29tcGFjdFBhdGggPSBidWlsZFZlcnNpb25lZFBhdGgodGhpcy5kb2N1bWVudHNQYXRoLCBuZXh0VmVyc2lvbik7CiAgICBjb25zdCBkZXN0U3luY0hhbmRsZSA9IGF3YWl0IGNyZWF0ZVN5bmNBY2Nlc3NIYW5kbGUoY29tcGFjdFBhdGgsIHsgcmVzZXQ6IHRydWUgfSk7CiAgICBhd2FpdCB0aGlzLmRvY3VtZW50cy5jb21wYWN0KGRlc3RTeW5jSGFuZGxlKTsKICAgIGF3YWl0IHByb21vdGVWZXJzaW9uKHRoaXMuZG9jdW1lbnRzUGF0aCwgbmV4dFZlcnNpb24sIGN1cnJlbnRWZXJzaW9uKTsKICB9CiAgLyoqCiAgICogR2VuZXJhdGUgaW5kZXggbmFtZSBmcm9tIGtleXMKICAgKi8KICBnZW5lcmF0ZUluZGV4TmFtZShrZXlzKSB7CiAgICBjb25zdCBwYXJ0cyA9IFtdOwogICAgZm9yIChjb25zdCBmaWVsZCBpbiBrZXlzKSB7CiAgICAgIGlmIChrZXlzLmhhc093blByb3BlcnR5KGZpZWxkKSkgewogICAgICAgIHBhcnRzLnB1c2goZmllbGQgKyAiXyIgKyBrZXlzW2ZpZWxkXSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBwYXJ0cy5qb2luKCJfIik7CiAgfQogIC8qKgogICAqIERldGVybWluZSBpZiBrZXlzIHNwZWNpZnkgYSB0ZXh0IGluZGV4CiAgICovCiAgaXNUZXh0SW5kZXgoa2V5cykgewogICAgZm9yIChjb25zdCBmaWVsZCBpbiBrZXlzKSB7CiAgICAgIGlmIChrZXlzW2ZpZWxkXSA9PT0gInRleHQiKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CiAgLyoqCiAgICogRGV0ZXJtaW5lIGlmIGtleXMgc3BlY2lmeSBhIGdlb3NwYXRpYWwgaW5kZXgKICAgKi8KICBpc0dlb3NwYXRpYWxJbmRleChrZXlzKSB7CiAgICBmb3IgKGNvbnN0IGZpZWxkIGluIGtleXMpIHsKICAgICAgaWYgKGtleXNbZmllbGRdID09PSAiMmRzcGhlcmUiIHx8IGtleXNbZmllbGRdID09PSAiMmQiKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CiAgYXN5bmMgX2dldEluZGV4UGF0aChpbmRleE5hbWUsIHR5cGUpIHsKICAgIGNvbnN0IHNhbml0aXplID0gKHZhbHVlKSA9PiBTdHJpbmcodmFsdWUpLnJlcGxhY2UoL1teYS16QS1aMC05Xy1dL2csICJfIik7CiAgICBjb25zdCBzYW5pdGl6ZWRJbmRleE5hbWUgPSBzYW5pdGl6ZShpbmRleE5hbWUpOwogICAgaWYgKHR5cGUgPT09ICJ0ZXh0IikgewogICAgICByZXR1cm4gYCR7dGhpcy5wYXRofS8ke3Nhbml0aXplZEluZGV4TmFtZX0udGV4dGluZGV4YDsKICAgIH0KICAgIGlmICh0eXBlID09PSAiZ2Vvc3BhdGlhbCIpIHsKICAgICAgcmV0dXJuIGAke3RoaXMucGF0aH0vJHtzYW5pdGl6ZWRJbmRleE5hbWV9LnJ0cmVlLmJqc29uYDsKICAgIH0KICAgIHJldHVybiBgJHt0aGlzLnBhdGh9LyR7c2FuaXRpemVkSW5kZXhOYW1lfS5icGx1c3RyZWUuYmpzb25gOwogIH0KICAvKioKICAgKiBCdWlsZC9yZWJ1aWxkIGFuIGluZGV4CiAgICovCiAgYXN5bmMgX2J1aWxkSW5kZXgoaW5kZXhOYW1lLCBrZXlzLCBvcHRpb25zID0ge30pIHsKICAgIGlmICghdGhpcy5faW5pdGlhbGl6ZWQpIGF3YWl0IHRoaXMuX2luaXRpYWxpemUoKTsKICAgIGxldCBpbmRleDsKICAgIGxldCBzdG9yYWdlRmlsZTsKICAgIGxldCB0eXBlOwogICAgaWYgKHRoaXMuaXNUZXh0SW5kZXgoa2V5cykpIHsKICAgICAgdHlwZSA9ICJ0ZXh0IjsKICAgICAgc3RvcmFnZUZpbGUgPSBhd2FpdCB0aGlzLl9nZXRJbmRleFBhdGgoaW5kZXhOYW1lLCB0eXBlKTsKICAgICAgaW5kZXggPSBuZXcgVGV4dENvbGxlY3Rpb25JbmRleChpbmRleE5hbWUsIGtleXMsIHN0b3JhZ2VGaWxlLCBvcHRpb25zKTsKICAgIH0gZWxzZSBpZiAodGhpcy5pc0dlb3NwYXRpYWxJbmRleChrZXlzKSkgewogICAgICB0eXBlID0gImdlb3NwYXRpYWwiOwogICAgICBzdG9yYWdlRmlsZSA9IGF3YWl0IHRoaXMuX2dldEluZGV4UGF0aChpbmRleE5hbWUsIHR5cGUpOwogICAgICBpbmRleCA9IG5ldyBHZW9zcGF0aWFsSW5kZXgoaW5kZXhOYW1lLCBrZXlzLCBzdG9yYWdlRmlsZSwgb3B0aW9ucyk7CiAgICB9IGVsc2UgewogICAgICB0eXBlID0gInJlZ3VsYXIiOwogICAgICBzdG9yYWdlRmlsZSA9IGF3YWl0IHRoaXMuX2dldEluZGV4UGF0aChpbmRleE5hbWUsIHR5cGUpOwogICAgICBpbmRleCA9IG5ldyBSZWd1bGFyQ29sbGVjdGlvbkluZGV4KGluZGV4TmFtZSwga2V5cywgc3RvcmFnZUZpbGUsIG9wdGlvbnMpOwogICAgfQogICAgYXdhaXQgaW5kZXgub3BlbigpOwogICAgaWYgKHR5cGVvZiBpbmRleC5jbGVhciA9PT0gImZ1bmN0aW9uIikgewogICAgICBhd2FpdCBpbmRleC5jbGVhcigpOwogICAgfQogICAgZm9yIGF3YWl0IChjb25zdCBlbnRyeSBvZiB0aGlzLmRvY3VtZW50cykgewogICAgICBpZiAoZW50cnkgJiYgZW50cnkudmFsdWUpIHsKICAgICAgICBhd2FpdCBpbmRleC5hZGQoZW50cnkudmFsdWUpOwogICAgICB9CiAgICB9CiAgICB0aGlzLmluZGV4ZXMuc2V0KGluZGV4TmFtZSwgaW5kZXgpOwogICAgcmV0dXJuIGluZGV4OwogIH0KICAvKioKICAgKiBVcGRhdGUgaW5kZXhlcyB3aGVuIGEgZG9jdW1lbnQgaXMgaW5zZXJ0ZWQKICAgKi8KICBhc3luYyB1cGRhdGVJbmRleGVzT25JbnNlcnQoZG9jKSB7CiAgICBjb25zdCBwcm9taXNlcyA9IFtdOwogICAgZm9yIChjb25zdCBbaW5kZXhOYW1lLCBpbmRleF0gb2YgdGhpcy5pbmRleGVzKSB7CiAgICAgIHByb21pc2VzLnB1c2goKGFzeW5jICgpID0+IHsKICAgICAgICBhd2FpdCB0aGlzLl9lbnN1cmVJbmRleE9wZW4oaW5kZXgpOwogICAgICAgIGF3YWl0IGluZGV4LmFkZChkb2MpOwogICAgICB9KSgpKTsKICAgIH0KICAgIGlmIChwcm9taXNlcy5sZW5ndGggPiAwKSB7CiAgICAgIGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKTsKICAgIH0KICB9CiAgLyoqCiAgICogVXBkYXRlIGluZGV4ZXMgd2hlbiBhIGRvY3VtZW50IGlzIGRlbGV0ZWQKICAgKi8KICBhc3luYyB1cGRhdGVJbmRleGVzT25EZWxldGUoZG9jKSB7CiAgICBjb25zdCBwcm9taXNlcyA9IFtdOwogICAgZm9yIChjb25zdCBbaW5kZXhOYW1lLCBpbmRleF0gb2YgdGhpcy5pbmRleGVzKSB7CiAgICAgIHByb21pc2VzLnB1c2goKGFzeW5jICgpID0+IHsKICAgICAgICBhd2FpdCB0aGlzLl9lbnN1cmVJbmRleE9wZW4oaW5kZXgpOwogICAgICAgIGF3YWl0IGluZGV4LnJlbW92ZShkb2MpOwogICAgICB9KSgpKTsKICAgIH0KICAgIGlmIChwcm9taXNlcy5sZW5ndGggPiAwKSB7CiAgICAgIGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKTsKICAgIH0KICB9CiAgLyoqCiAgICogRW5zdXJlIGFuIGluZGV4IGlzIG9wZW4gYmVmb3JlIHVzaW5nIGl0CiAgICogQHByaXZhdGUKICAgKi8KICBhc3luYyBfZW5zdXJlSW5kZXhPcGVuKGluZGV4KSB7CiAgICBpZiAoaW5kZXggJiYgdHlwZW9mIGluZGV4Lm9wZW4gPT09ICJmdW5jdGlvbiIgJiYgIWluZGV4LmlzT3BlbikgewogICAgICBhd2FpdCBpbmRleC5vcGVuKCk7CiAgICB9CiAgfQogIC8qKgogICAqIFF1ZXJ5IHBsYW5uZXIgLSBhbmFseXplIHF1ZXJ5IGFuZCBkZXRlcm1pbmUgb3B0aW1hbCBleGVjdXRpb24gcGxhbgogICAqLwogIHBsYW5RdWVyeShxdWVyeSkgewogICAgY29uc3QgcGxhbiA9IHRoaXMucXVlcnlQbGFubmVyLnBsYW4ocXVlcnkpOwogICAgcmV0dXJuIHsKICAgICAgdXNlSW5kZXg6IHBsYW4udHlwZSAhPT0gImZ1bGxfc2NhbiIsCiAgICAgIHBsYW5UeXBlOiBwbGFuLnR5cGUsCiAgICAgIGluZGV4TmFtZXM6IHBsYW4uaW5kZXhlcywKICAgICAgZG9jSWRzOiBudWxsLAogICAgICAvLyBGb3JjZSBmdWxsIHNjYW4gZm9yIG5vdyAtIHVzZSBwbGFuUXVlcnlBc3luYyBmb3IgaW5kZXggcmVzdWx0cwogICAgICBlc3RpbWF0ZWRDb3N0OiBwbGFuLmVzdGltYXRlZENvc3QsCiAgICAgIGluZGV4T25seTogcGxhbi5pbmRleE9ubHkgfHwgZmFsc2UKICAgIH07CiAgfQogIC8qKgogICAqIEFzeW5jIHZlcnNpb24gb2YgcXVlcnkgcGxhbm5lciAtIGZvciB1c2Ugd2l0aCBhc3luYyBpbmRleGVzCiAgICovCiAgYXN5bmMgcGxhblF1ZXJ5QXN5bmMocXVlcnkpIHsKICAgIGNvbnN0IHBsYW4gPSB0aGlzLnF1ZXJ5UGxhbm5lci5wbGFuKHF1ZXJ5KTsKICAgIGNvbnN0IGRvY0lkcyA9IGF3YWl0IHRoaXMucXVlcnlQbGFubmVyLmV4ZWN1dGUocGxhbik7CiAgICByZXR1cm4gewogICAgICB1c2VJbmRleDogcGxhbi50eXBlICE9PSAiZnVsbF9zY2FuIiwKICAgICAgcGxhblR5cGU6IHBsYW4udHlwZSwKICAgICAgaW5kZXhOYW1lczogcGxhbi5pbmRleGVzLAogICAgICBkb2NJZHMsCiAgICAgIGVzdGltYXRlZENvc3Q6IHBsYW4uZXN0aW1hdGVkQ29zdCwKICAgICAgaW5kZXhPbmx5OiBwbGFuLmluZGV4T25seSB8fCBmYWxzZQogICAgfTsKICB9CiAgLyoqCiAgICogR2V0IGEgdGV4dCBpbmRleCBmb3IgdGhlIGdpdmVuIGZpZWxkCiAgICogQHBhcmFtIHtzdHJpbmd9IGZpZWxkIC0gVGhlIGZpZWxkIG5hbWUKICAgKiBAcmV0dXJucyB7VGV4dENvbGxlY3Rpb25JbmRleHxudWxsfSBUaGUgdGV4dCBpbmRleCBvciBudWxsIGlmIG5vdCBmb3VuZAogICAqLwogIGdldFRleHRJbmRleChmaWVsZCkgewogICAgZm9yIChjb25zdCBbaW5kZXhOYW1lLCBpbmRleF0gb2YgdGhpcy5pbmRleGVzKSB7CiAgICAgIGlmIChpbmRleCBpbnN0YW5jZW9mIFRleHRDb2xsZWN0aW9uSW5kZXgpIHsKICAgICAgICBpZiAoaW5kZXguaW5kZXhlZEZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHsKICAgICAgICAgIHJldHVybiBpbmRleDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBudWxsOwogIH0KICAvLyBDb2xsZWN0aW9uIG1ldGhvZHMKICBhc3luYyBhZ2dyZWdhdGUocGlwZWxpbmUpIHsKICAgIGlmICghcGlwZWxpbmUgfHwgIWlzQXJyYXkocGlwZWxpbmUpKSB7CiAgICAgIHRocm93IG5ldyBRdWVyeUVycm9yKCJQaXBlbGluZSBtdXN0IGJlIGFuIGFycmF5IiwgewogICAgICAgIGNvbGxlY3Rpb246IHRoaXMubmFtZSwKICAgICAgICBjb2RlOiBFcnJvckNvZGVzLkZBSUxFRF9UT19QQVJTRQogICAgICB9KTsKICAgIH0KICAgIGxldCByZXN1bHRzID0gW107CiAgICBjb25zdCBjdXJzb3IgPSB0aGlzLmZpbmQoe30pOwogICAgYXdhaXQgY3Vyc29yLl9lbnN1cmVJbml0aWFsaXplZCgpOwogICAgd2hpbGUgKGF3YWl0IGN1cnNvci5oYXNOZXh0KCkpIHsKICAgICAgcmVzdWx0cy5wdXNoKGF3YWl0IGN1cnNvci5uZXh0KCkpOwogICAgfQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwaXBlbGluZS5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBzdGFnZSA9IHBpcGVsaW5lW2ldOwogICAgICBjb25zdCBzdGFnZUtleXMgPSBPYmplY3Qua2V5cyhzdGFnZSk7CiAgICAgIGlmIChzdGFnZUtleXMubGVuZ3RoICE9PSAxKSB7CiAgICAgICAgdGhyb3cgbmV3IFF1ZXJ5RXJyb3IoIkVhY2ggcGlwZWxpbmUgc3RhZ2UgbXVzdCBoYXZlIGV4YWN0bHkgb25lIGtleSIsIHsKICAgICAgICAgIGNvbGxlY3Rpb246IHRoaXMubmFtZSwKICAgICAgICAgIGNvZGU6IEVycm9yQ29kZXMuRkFJTEVEX1RPX1BBUlNFCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgY29uc3Qgc3RhZ2VUeXBlID0gc3RhZ2VLZXlzWzBdOwogICAgICBjb25zdCBzdGFnZVNwZWMgPSBzdGFnZVtzdGFnZVR5cGVdOwogICAgICBpZiAoc3RhZ2VUeXBlID09PSAiJG1hdGNoIikgewogICAgICAgIGNvbnN0IG1hdGNoZWQgPSBbXTsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHJlc3VsdHMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGlmIChtYXRjaGVzKHJlc3VsdHNbal0sIHN0YWdlU3BlYykpIHsKICAgICAgICAgICAgbWF0Y2hlZC5wdXNoKHJlc3VsdHNbal0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXN1bHRzID0gbWF0Y2hlZDsKICAgICAgfSBlbHNlIGlmIChzdGFnZVR5cGUgPT09ICIkcHJvamVjdCIpIHsKICAgICAgICBjb25zdCBwcm9qZWN0ZWQgPSBbXTsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHJlc3VsdHMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIHByb2plY3RlZC5wdXNoKGFwcGx5UHJvamVjdGlvbldpdGhFeHByZXNzaW9ucyhzdGFnZVNwZWMsIHJlc3VsdHNbal0pKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0cyA9IHByb2plY3RlZDsKICAgICAgfSBlbHNlIGlmIChzdGFnZVR5cGUgPT09ICIkYWRkRmllbGRzIiB8fCBzdGFnZVR5cGUgPT09ICIkc2V0IikgewogICAgICAgIGNvbnN0IG1vZGlmaWVkID0gW107CiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCByZXN1bHRzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBjb25zdCBkb2MgPSBjb3B5KHJlc3VsdHNbal0pOwogICAgICAgICAgZm9yIChjb25zdCBmaWVsZCBpbiBzdGFnZVNwZWMpIHsKICAgICAgICAgICAgY29uc3QgZXhwciA9IHN0YWdlU3BlY1tmaWVsZF07CiAgICAgICAgICAgIGRvY1tmaWVsZF0gPSBldmFsdWF0ZUV4cHJlc3Npb24oZXhwciwgcmVzdWx0c1tqXSk7CiAgICAgICAgICB9CiAgICAgICAgICBtb2RpZmllZC5wdXNoKGRvYyk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdHMgPSBtb2RpZmllZDsKICAgICAgfSBlbHNlIGlmIChzdGFnZVR5cGUgPT09ICIkdW5zZXQiKSB7CiAgICAgICAgY29uc3QgbW9kaWZpZWQgPSBbXTsKICAgICAgICBsZXQgZmllbGRzVG9SZW1vdmUgPSBbXTsKICAgICAgICBpZiAodHlwZW9mIHN0YWdlU3BlYyA9PT0gInN0cmluZyIpIHsKICAgICAgICAgIGZpZWxkc1RvUmVtb3ZlID0gW3N0YWdlU3BlY107CiAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHN0YWdlU3BlYykpIHsKICAgICAgICAgIGZpZWxkc1RvUmVtb3ZlID0gc3RhZ2VTcGVjOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHN0YWdlU3BlYyA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgIGZpZWxkc1RvUmVtb3ZlID0gT2JqZWN0LmtleXMoc3RhZ2VTcGVjKTsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCByZXN1bHRzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBjb25zdCBkb2MgPSBjb3B5KHJlc3VsdHNbal0pOwogICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBmaWVsZHNUb1JlbW92ZS5sZW5ndGg7IGsrKykgewogICAgICAgICAgICBjb25zdCBmaWVsZCA9IGZpZWxkc1RvUmVtb3ZlW2tdOwogICAgICAgICAgICBjb25zdCBwYXRoUGFydHMgPSBmaWVsZC5zcGxpdCgiLiIpOwogICAgICAgICAgICBpZiAocGF0aFBhcnRzLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICAgIGRlbGV0ZSBkb2NbZmllbGRdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGxldCBwYXJlbnQgPSBkb2M7CiAgICAgICAgICAgICAgZm9yIChsZXQgbSA9IDA7IG0gPCBwYXRoUGFydHMubGVuZ3RoIC0gMTsgbSsrKSB7CiAgICAgICAgICAgICAgICBpZiAocGFyZW50ID09IHZvaWQgMCB8fCBwYXJlbnQgPT0gbnVsbCkgYnJlYWs7CiAgICAgICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnRbcGF0aFBhcnRzW21dXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHBhcmVudCAhPSB2b2lkIDAgJiYgcGFyZW50ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSBwYXJlbnRbcGF0aFBhcnRzW3BhdGhQYXJ0cy5sZW5ndGggLSAxXV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBtb2RpZmllZC5wdXNoKGRvYyk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdHMgPSBtb2RpZmllZDsKICAgICAgfSBlbHNlIGlmIChzdGFnZVR5cGUgPT09ICIkc29ydCIpIHsKICAgICAgICBjb25zdCBzb3J0S2V5cyA9IE9iamVjdC5rZXlzKHN0YWdlU3BlYyk7CiAgICAgICAgcmVzdWx0cy5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgc29ydEtleXMubGVuZ3RoOyBrKyspIHsKICAgICAgICAgICAgY29uc3Qga2V5ID0gc29ydEtleXNba107CiAgICAgICAgICAgIGlmIChhW2tleV0gPT09IHZvaWQgMCAmJiBiW2tleV0gIT09IHZvaWQgMCkgcmV0dXJuIC0xICogc3RhZ2VTcGVjW2tleV07CiAgICAgICAgICAgIGlmIChhW2tleV0gIT09IHZvaWQgMCAmJiBiW2tleV0gPT09IHZvaWQgMCkgcmV0dXJuIDEgKiBzdGFnZVNwZWNba2V5XTsKICAgICAgICAgICAgaWYgKGFba2V5XSA8IGJba2V5XSkgcmV0dXJuIC0xICogc3RhZ2VTcGVjW2tleV07CiAgICAgICAgICAgIGlmIChhW2tleV0gPiBiW2tleV0pIHJldHVybiAxICogc3RhZ2VTcGVjW2tleV07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmIChzdGFnZVR5cGUgPT09ICIkbGltaXQiKSB7CiAgICAgICAgcmVzdWx0cyA9IHJlc3VsdHMuc2xpY2UoMCwgc3RhZ2VTcGVjKTsKICAgICAgfSBlbHNlIGlmIChzdGFnZVR5cGUgPT09ICIkc2tpcCIpIHsKICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5zbGljZShzdGFnZVNwZWMpOwogICAgICB9IGVsc2UgaWYgKHN0YWdlVHlwZSA9PT0gIiRncm91cCIpIHsKICAgICAgICBjb25zdCBncm91cHMgPSB7fTsKICAgICAgICBjb25zdCBncm91cElkID0gc3RhZ2VTcGVjLl9pZDsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHJlc3VsdHMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGNvbnN0IGRvYyA9IHJlc3VsdHNbal07CiAgICAgICAgICBsZXQga2V5OwogICAgICAgICAgaWYgKGdyb3VwSWQgPT09IG51bGwgfHwgZ3JvdXBJZCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGtleSA9IG51bGw7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBrZXkgPSBldmFsdWF0ZUV4cHJlc3Npb24oZ3JvdXBJZCwgZG9jKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGtleVN0ciA9IEpTT04uc3RyaW5naWZ5KGtleSk7CiAgICAgICAgICBpZiAoIWdyb3Vwc1trZXlTdHJdKSB7CiAgICAgICAgICAgIGdyb3Vwc1trZXlTdHJdID0gewogICAgICAgICAgICAgIF9pZDoga2V5LAogICAgICAgICAgICAgIGRvY3M6IFtdLAogICAgICAgICAgICAgIGFjY3VtdWxhdG9yczoge30KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIGdyb3Vwc1trZXlTdHJdLmRvY3MucHVzaChkb2MpOwogICAgICAgIH0KICAgICAgICBjb25zdCBncm91cGVkID0gW107CiAgICAgICAgZm9yIChjb25zdCBncm91cEtleSBpbiBncm91cHMpIHsKICAgICAgICAgIGNvbnN0IGdyb3VwID0gZ3JvdXBzW2dyb3VwS2V5XTsKICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHsgX2lkOiBncm91cC5faWQgfTsKICAgICAgICAgIGZvciAoY29uc3QgZmllbGQgaW4gc3RhZ2VTcGVjKSB7CiAgICAgICAgICAgIGlmIChmaWVsZCA9PT0gIl9pZCIpIGNvbnRpbnVlOwogICAgICAgICAgICBjb25zdCBhY2N1bXVsYXRvciA9IHN0YWdlU3BlY1tmaWVsZF07CiAgICAgICAgICAgIGNvbnN0IGFjY0tleXMgPSBPYmplY3Qua2V5cyhhY2N1bXVsYXRvcik7CiAgICAgICAgICAgIGlmIChhY2NLZXlzLmxlbmd0aCAhPT0gMSkgY29udGludWU7CiAgICAgICAgICAgIGNvbnN0IGFjY1R5cGUgPSBhY2NLZXlzWzBdOwogICAgICAgICAgICBjb25zdCBhY2NFeHByID0gYWNjdW11bGF0b3JbYWNjVHlwZV07CiAgICAgICAgICAgIGlmIChhY2NUeXBlID09PSAiJHN1bSIpIHsKICAgICAgICAgICAgICBsZXQgc3VtID0gMDsKICAgICAgICAgICAgICBmb3IgKGxldCBrID0gMDsgayA8IGdyb3VwLmRvY3MubGVuZ3RoOyBrKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihhY2NFeHByLCBncm91cC5kb2NzW2tdKTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgICBzdW0gKz0gdmFsOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh2YWwgIT09IG51bGwgJiYgdmFsICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgc3VtICs9IE51bWJlcih2YWwpIHx8IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc3VsdFtmaWVsZF0gPSBzdW07CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWNjVHlwZSA9PT0gIiRhdmciKSB7CiAgICAgICAgICAgICAgbGV0IHN1bSA9IDA7CiAgICAgICAgICAgICAgbGV0IGNvdW50ID0gMDsKICAgICAgICAgICAgICBmb3IgKGxldCBrID0gMDsgayA8IGdyb3VwLmRvY3MubGVuZ3RoOyBrKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihhY2NFeHByLCBncm91cC5kb2NzW2tdKTsKICAgICAgICAgICAgICAgIGlmICh2YWwgIT09IHZvaWQgMCAmJiB2YWwgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgc3VtICs9IE51bWJlcih2YWwpIHx8IDA7CiAgICAgICAgICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc3VsdFtmaWVsZF0gPSBjb3VudCA+IDAgPyBzdW0gLyBjb3VudCA6IDA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWNjVHlwZSA9PT0gIiRtaW4iKSB7CiAgICAgICAgICAgICAgbGV0IG1pbiA9IHZvaWQgMDsKICAgICAgICAgICAgICBmb3IgKGxldCBrID0gMDsgayA8IGdyb3VwLmRvY3MubGVuZ3RoOyBrKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihhY2NFeHByLCBncm91cC5kb2NzW2tdKTsKICAgICAgICAgICAgICAgIGlmICh2YWwgIT09IHZvaWQgMCAmJiAobWluID09PSB2b2lkIDAgfHwgdmFsIDwgbWluKSkgewogICAgICAgICAgICAgICAgICBtaW4gPSB2YWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc3VsdFtmaWVsZF0gPSBtaW47CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWNjVHlwZSA9PT0gIiRtYXgiKSB7CiAgICAgICAgICAgICAgbGV0IG1heCA9IHZvaWQgMDsKICAgICAgICAgICAgICBmb3IgKGxldCBrID0gMDsgayA8IGdyb3VwLmRvY3MubGVuZ3RoOyBrKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihhY2NFeHByLCBncm91cC5kb2NzW2tdKTsKICAgICAgICAgICAgICAgIGlmICh2YWwgIT09IHZvaWQgMCAmJiAobWF4ID09PSB2b2lkIDAgfHwgdmFsID4gbWF4KSkgewogICAgICAgICAgICAgICAgICBtYXggPSB2YWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc3VsdFtmaWVsZF0gPSBtYXg7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWNjVHlwZSA9PT0gIiRwdXNoIikgewogICAgICAgICAgICAgIGNvbnN0IGFyciA9IFtdOwogICAgICAgICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgZ3JvdXAuZG9jcy5sZW5ndGg7IGsrKykgewogICAgICAgICAgICAgICAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKGFjY0V4cHIsIGdyb3VwLmRvY3Nba10pOwogICAgICAgICAgICAgICAgYXJyLnB1c2godmFsKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzdWx0W2ZpZWxkXSA9IGFycjsKICAgICAgICAgICAgfSBlbHNlIGlmIChhY2NUeXBlID09PSAiJGFkZFRvU2V0IikgewogICAgICAgICAgICAgIGNvbnN0IHNldCA9IHt9OwogICAgICAgICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgZ3JvdXAuZG9jcy5sZW5ndGg7IGsrKykgewogICAgICAgICAgICAgICAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKGFjY0V4cHIsIGdyb3VwLmRvY3Nba10pOwogICAgICAgICAgICAgICAgc2V0W0pTT04uc3RyaW5naWZ5KHZhbCldID0gdmFsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb25zdCBhcnIgPSBbXTsKICAgICAgICAgICAgICBmb3IgKGNvbnN0IHZhbEtleSBpbiBzZXQpIHsKICAgICAgICAgICAgICAgIGFyci5wdXNoKHNldFt2YWxLZXldKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzdWx0W2ZpZWxkXSA9IGFycjsKICAgICAgICAgICAgfSBlbHNlIGlmIChhY2NUeXBlID09PSAiJGZpcnN0IikgewogICAgICAgICAgICAgIGlmIChncm91cC5kb2NzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHJlc3VsdFtmaWVsZF0gPSBldmFsdWF0ZUV4cHJlc3Npb24oYWNjRXhwciwgZ3JvdXAuZG9jc1swXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGFjY1R5cGUgPT09ICIkbGFzdCIpIHsKICAgICAgICAgICAgICBpZiAoZ3JvdXAuZG9jcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICByZXN1bHRbZmllbGRdID0gZXZhbHVhdGVFeHByZXNzaW9uKGFjY0V4cHIsIGdyb3VwLmRvY3NbZ3JvdXAuZG9jcy5sZW5ndGggLSAxXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGFjY1R5cGUgPT09ICIkc3RkRGV2UG9wIikgewogICAgICAgICAgICAgIGNvbnN0IHZhbHVlcyA9IFtdOwogICAgICAgICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgZ3JvdXAuZG9jcy5sZW5ndGg7IGsrKykgewogICAgICAgICAgICAgICAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKGFjY0V4cHIsIGdyb3VwLmRvY3Nba10pOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWwgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICAgIHZhbHVlcy5wdXNoKHZhbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh2YWx1ZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgY29uc3QgbWVhbiA9IHZhbHVlcy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIHZhbHVlcy5sZW5ndGg7CiAgICAgICAgICAgICAgICBjb25zdCB2YXJpYW5jZSA9IHZhbHVlcy5yZWR1Y2UoKHN1bSwgdmFsKSA9PiBzdW0gKyBNYXRoLnBvdyh2YWwgLSBtZWFuLCAyKSwgMCkgLyB2YWx1ZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgcmVzdWx0W2ZpZWxkXSA9IE1hdGguc3FydCh2YXJpYW5jZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlc3VsdFtmaWVsZF0gPSAwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChhY2NUeXBlID09PSAiJHN0ZERldlNhbXAiKSB7CiAgICAgICAgICAgICAgY29uc3QgdmFsdWVzID0gW107CiAgICAgICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBncm91cC5kb2NzLmxlbmd0aDsgaysrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24oYWNjRXhwciwgZ3JvdXAuZG9jc1trXSk7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgICAgdmFsdWVzLnB1c2godmFsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHZhbHVlcy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICBjb25zdCBtZWFuID0gdmFsdWVzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApIC8gdmFsdWVzLmxlbmd0aDsKICAgICAgICAgICAgICAgIGNvbnN0IHZhcmlhbmNlID0gdmFsdWVzLnJlZHVjZSgoc3VtLCB2YWwpID0+IHN1bSArIE1hdGgucG93KHZhbCAtIG1lYW4sIDIpLCAwKSAvICh2YWx1ZXMubGVuZ3RoIC0gMSk7CiAgICAgICAgICAgICAgICByZXN1bHRbZmllbGRdID0gTWF0aC5zcXJ0KHZhcmlhbmNlKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVzdWx0W2ZpZWxkXSA9IDA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGFjY1R5cGUgPT09ICIkbWVyZ2VPYmplY3RzIikgewogICAgICAgICAgICAgIGNvbnN0IG1lcmdlZCA9IHt9OwogICAgICAgICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgZ3JvdXAuZG9jcy5sZW5ndGg7IGsrKykgewogICAgICAgICAgICAgICAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKGFjY0V4cHIsIGdyb3VwLmRvY3Nba10pOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWwgPT09ICJvYmplY3QiICYmIHZhbCAhPT0gbnVsbCAmJiAhQXJyYXkuaXNBcnJheSh2YWwpKSB7CiAgICAgICAgICAgICAgICAgIE9iamVjdC5hc3NpZ24obWVyZ2VkLCB2YWwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXN1bHRbZmllbGRdID0gbWVyZ2VkOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBncm91cGVkLnB1c2gocmVzdWx0KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0cyA9IGdyb3VwZWQ7CiAgICAgIH0gZWxzZSBpZiAoc3RhZ2VUeXBlID09PSAiJGNvdW50IikgewogICAgICAgIHJlc3VsdHMgPSBbeyBbc3RhZ2VTcGVjXTogcmVzdWx0cy5sZW5ndGggfV07CiAgICAgIH0gZWxzZSBpZiAoc3RhZ2VUeXBlID09PSAiJHVud2luZCIpIHsKICAgICAgICBjb25zdCB1bndvdW5kID0gW107CiAgICAgICAgbGV0IGZpZWxkUGF0aCA9IHN0YWdlU3BlYzsKICAgICAgICBpZiAodHlwZW9mIGZpZWxkUGF0aCA9PT0gInN0cmluZyIgJiYgZmllbGRQYXRoLmNoYXJBdCgwKSA9PT0gIiQiKSB7CiAgICAgICAgICBmaWVsZFBhdGggPSBmaWVsZFBhdGguc3Vic3RyaW5nKDEpOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHJlc3VsdHMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGNvbnN0IGRvYyA9IHJlc3VsdHNbal07CiAgICAgICAgICBjb25zdCBhcnIgPSBnZXRQcm9wKGRvYywgZmllbGRQYXRoKTsKICAgICAgICAgIGlmIChhcnIgJiYgaXNBcnJheShhcnIpICYmIGFyci5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgYXJyLmxlbmd0aDsgaysrKSB7CiAgICAgICAgICAgICAgY29uc3QgdW53b3VuZERvYyA9IGNvcHkoZG9jKTsKICAgICAgICAgICAgICBjb25zdCBwYXJ0cyA9IGZpZWxkUGF0aC5zcGxpdCgiLiIpOwogICAgICAgICAgICAgIGxldCB0YXJnZXQgPSB1bndvdW5kRG9jOwogICAgICAgICAgICAgIGZvciAobGV0IGwgPSAwOyBsIDwgcGFydHMubGVuZ3RoIC0gMTsgbCsrKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRhcmdldFtwYXJ0c1tsXV0pIHsKICAgICAgICAgICAgICAgICAgdGFyZ2V0W3BhcnRzW2xdXSA9IHt9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0W3BhcnRzW2xdXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGFyZ2V0W3BhcnRzW3BhcnRzLmxlbmd0aCAtIDFdXSA9IGFycltrXTsKICAgICAgICAgICAgICB1bndvdW5kLnB1c2godW53b3VuZERvYyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmVzdWx0cyA9IHVud291bmQ7CiAgICAgIH0gZWxzZSBpZiAoc3RhZ2VUeXBlID09PSAiJHNvcnRCeUNvdW50IikgewogICAgICAgIGNvbnN0IGdyb3VwcyA9IHt9OwogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgcmVzdWx0cy5sZW5ndGg7IGorKykgewogICAgICAgICAgY29uc3QgZG9jID0gcmVzdWx0c1tqXTsKICAgICAgICAgIGNvbnN0IHZhbHVlID0gZXZhbHVhdGVFeHByZXNzaW9uKHN0YWdlU3BlYywgZG9jKTsKICAgICAgICAgIGNvbnN0IGtleSA9IEpTT04uc3RyaW5naWZ5KHZhbHVlKTsKICAgICAgICAgIGlmICghZ3JvdXBzW2tleV0pIHsKICAgICAgICAgICAgZ3JvdXBzW2tleV0gPSB7CiAgICAgICAgICAgICAgX2lkOiB2YWx1ZSwKICAgICAgICAgICAgICBjb3VudDogMAogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgZ3JvdXBzW2tleV0uY291bnQrKzsKICAgICAgICB9CiAgICAgICAgcmVzdWx0cyA9IE9iamVjdC52YWx1ZXMoZ3JvdXBzKS5zb3J0KChhLCBiKSA9PiBiLmNvdW50IC0gYS5jb3VudCk7CiAgICAgIH0gZWxzZSBpZiAoc3RhZ2VUeXBlID09PSAiJHJlcGxhY2VSb290IiB8fCBzdGFnZVR5cGUgPT09ICIkcmVwbGFjZVdpdGgiKSB7CiAgICAgICAgY29uc3QgbW9kaWZpZWQgPSBbXTsKICAgICAgICBjb25zdCBuZXdSb290U3BlYyA9IHN0YWdlVHlwZSA9PT0gIiRyZXBsYWNlUm9vdCIgPyBzdGFnZVNwZWMubmV3Um9vdCA6IHN0YWdlU3BlYzsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHJlc3VsdHMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGNvbnN0IG5ld1Jvb3QgPSBldmFsdWF0ZUV4cHJlc3Npb24obmV3Um9vdFNwZWMsIHJlc3VsdHNbal0pOwogICAgICAgICAgaWYgKHR5cGVvZiBuZXdSb290ID09PSAib2JqZWN0IiAmJiBuZXdSb290ICE9PSBudWxsICYmICFBcnJheS5pc0FycmF5KG5ld1Jvb3QpKSB7CiAgICAgICAgICAgIG1vZGlmaWVkLnB1c2gobmV3Um9vdCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBuZXcgUXVlcnlFcnJvcigiJHJlcGxhY2VSb290IGV4cHJlc3Npb24gbXVzdCBldmFsdWF0ZSB0byBhbiBvYmplY3QiLCB7CiAgICAgICAgICAgICAgY29sbGVjdGlvbjogdGhpcy5uYW1lLAogICAgICAgICAgICAgIGNvZGU6IEVycm9yQ29kZXMuRkFJTEVEX1RPX1BBUlNFCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXN1bHRzID0gbW9kaWZpZWQ7CiAgICAgIH0gZWxzZSBpZiAoc3RhZ2VUeXBlID09PSAiJHNhbXBsZSIpIHsKICAgICAgICBjb25zdCBzaXplID0gc3RhZ2VTcGVjLnNpemUgfHwgMTsKICAgICAgICBpZiAodHlwZW9mIHNpemUgIT09ICJudW1iZXIiIHx8IHNpemUgPCAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgUXVlcnlFcnJvcigiJHNhbXBsZSBzaXplIG11c3QgYmUgYSBub24tbmVnYXRpdmUgbnVtYmVyIiwgewogICAgICAgICAgICBjb2xsZWN0aW9uOiB0aGlzLm5hbWUsCiAgICAgICAgICAgIGNvZGU6IEVycm9yQ29kZXMuRkFJTEVEX1RPX1BBUlNFCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc2h1ZmZsZWQgPSBbLi4ucmVzdWx0c107CiAgICAgICAgZm9yIChsZXQgaiA9IHNodWZmbGVkLmxlbmd0aCAtIDE7IGogPiAwOyBqLS0pIHsKICAgICAgICAgIGNvbnN0IGsgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAoaiArIDEpKTsKICAgICAgICAgIFtzaHVmZmxlZFtqXSwgc2h1ZmZsZWRba11dID0gW3NodWZmbGVkW2tdLCBzaHVmZmxlZFtqXV07CiAgICAgICAgfQogICAgICAgIHJlc3VsdHMgPSBzaHVmZmxlZC5zbGljZSgwLCBNYXRoLm1pbihzaXplLCBzaHVmZmxlZC5sZW5ndGgpKTsKICAgICAgfSBlbHNlIGlmIChzdGFnZVR5cGUgPT09ICIkYnVja2V0IikgewogICAgICAgIGlmICghc3RhZ2VTcGVjLmdyb3VwQnkgfHwgIXN0YWdlU3BlYy5ib3VuZGFyaWVzKSB7CiAgICAgICAgICB0aHJvdyBuZXcgUXVlcnlFcnJvcigiJGJ1Y2tldCByZXF1aXJlcyBncm91cEJ5IGFuZCBib3VuZGFyaWVzIiwgewogICAgICAgICAgICBjb2xsZWN0aW9uOiB0aGlzLm5hbWUsCiAgICAgICAgICAgIGNvZGU6IEVycm9yQ29kZXMuRkFJTEVEX1RPX1BBUlNFCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYm91bmRhcmllcyA9IHN0YWdlU3BlYy5ib3VuZGFyaWVzOwogICAgICAgIGNvbnN0IGRlZmF1bHRCdWNrZXQgPSBzdGFnZVNwZWMuZGVmYXVsdDsKICAgICAgICBjb25zdCBvdXRwdXQgPSBzdGFnZVNwZWMub3V0cHV0IHx8IHsgY291bnQ6IHsgJHN1bTogMSB9IH07CiAgICAgICAgY29uc3QgYnVja2V0cyA9IHt9OwogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgYm91bmRhcmllcy5sZW5ndGggLSAxOyBqKyspIHsKICAgICAgICAgIGNvbnN0IGtleSA9IEpTT04uc3RyaW5naWZ5KGJvdW5kYXJpZXNbal0pOwogICAgICAgICAgYnVja2V0c1trZXldID0gewogICAgICAgICAgICBfaWQ6IGJvdW5kYXJpZXNbal0sCiAgICAgICAgICAgIGRvY3M6IFtdCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBpZiAoZGVmYXVsdEJ1Y2tldCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICBidWNrZXRzWyJkZWZhdWx0Il0gPSB7CiAgICAgICAgICAgIF9pZDogZGVmYXVsdEJ1Y2tldCwKICAgICAgICAgICAgZG9jczogW10KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgcmVzdWx0cy5sZW5ndGg7IGorKykgewogICAgICAgICAgY29uc3QgZG9jID0gcmVzdWx0c1tqXTsKICAgICAgICAgIGNvbnN0IHZhbHVlID0gZXZhbHVhdGVFeHByZXNzaW9uKHN0YWdlU3BlYy5ncm91cEJ5LCBkb2MpOwogICAgICAgICAgbGV0IHBsYWNlZCA9IGZhbHNlOwogICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBib3VuZGFyaWVzLmxlbmd0aCAtIDE7IGsrKykgewogICAgICAgICAgICBpZiAodmFsdWUgPj0gYm91bmRhcmllc1trXSAmJiB2YWx1ZSA8IGJvdW5kYXJpZXNbayArIDFdKSB7CiAgICAgICAgICAgICAgY29uc3Qga2V5ID0gSlNPTi5zdHJpbmdpZnkoYm91bmRhcmllc1trXSk7CiAgICAgICAgICAgICAgYnVja2V0c1trZXldLmRvY3MucHVzaChkb2MpOwogICAgICAgICAgICAgIHBsYWNlZCA9IHRydWU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghcGxhY2VkICYmIGRlZmF1bHRCdWNrZXQgIT09IHZvaWQgMCkgewogICAgICAgICAgICBidWNrZXRzWyJkZWZhdWx0Il0uZG9jcy5wdXNoKGRvYyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGJ1Y2tldGVkID0gW107CiAgICAgICAgZm9yIChjb25zdCBidWNrZXRLZXkgaW4gYnVja2V0cykgewogICAgICAgICAgY29uc3QgYnVja2V0ID0gYnVja2V0c1tidWNrZXRLZXldOwogICAgICAgICAgaWYgKGJ1Y2tldC5kb2NzLmxlbmd0aCA9PT0gMCkgY29udGludWU7CiAgICAgICAgICBjb25zdCByZXN1bHQgPSB7IF9pZDogYnVja2V0Ll9pZCB9OwogICAgICAgICAgZm9yIChjb25zdCBmaWVsZCBpbiBvdXRwdXQpIHsKICAgICAgICAgICAgY29uc3QgYWNjdW11bGF0b3IgPSBvdXRwdXRbZmllbGRdOwogICAgICAgICAgICBjb25zdCBhY2NLZXlzID0gT2JqZWN0LmtleXMoYWNjdW11bGF0b3IpOwogICAgICAgICAgICBpZiAoYWNjS2V5cy5sZW5ndGggIT09IDEpIGNvbnRpbnVlOwogICAgICAgICAgICBjb25zdCBhY2NUeXBlID0gYWNjS2V5c1swXTsKICAgICAgICAgICAgY29uc3QgYWNjRXhwciA9IGFjY3VtdWxhdG9yW2FjY1R5cGVdOwogICAgICAgICAgICBpZiAoYWNjVHlwZSA9PT0gIiRzdW0iKSB7CiAgICAgICAgICAgICAgbGV0IHN1bSA9IDA7CiAgICAgICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBidWNrZXQuZG9jcy5sZW5ndGg7IGsrKykgewogICAgICAgICAgICAgICAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKGFjY0V4cHIsIGJ1Y2tldC5kb2NzW2tdKTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgICBzdW0gKz0gdmFsOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh2YWwgIT09IG51bGwgJiYgdmFsICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgc3VtICs9IE51bWJlcih2YWwpIHx8IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc3VsdFtmaWVsZF0gPSBzdW07CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWNjVHlwZSA9PT0gIiRhdmciKSB7CiAgICAgICAgICAgICAgbGV0IHN1bSA9IDA7CiAgICAgICAgICAgICAgbGV0IGNvdW50ID0gMDsKICAgICAgICAgICAgICBmb3IgKGxldCBrID0gMDsgayA8IGJ1Y2tldC5kb2NzLmxlbmd0aDsgaysrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24oYWNjRXhwciwgYnVja2V0LmRvY3Nba10pOwogICAgICAgICAgICAgICAgaWYgKHZhbCAhPT0gdm9pZCAwICYmIHZhbCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBzdW0gKz0gTnVtYmVyKHZhbCkgfHwgMDsKICAgICAgICAgICAgICAgICAgY291bnQrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzdWx0W2ZpZWxkXSA9IGNvdW50ID4gMCA/IHN1bSAvIGNvdW50IDogMDsKICAgICAgICAgICAgfSBlbHNlIGlmIChhY2NUeXBlID09PSAiJHB1c2giKSB7CiAgICAgICAgICAgICAgY29uc3QgYXJyID0gW107CiAgICAgICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBidWNrZXQuZG9jcy5sZW5ndGg7IGsrKykgewogICAgICAgICAgICAgICAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKGFjY0V4cHIsIGJ1Y2tldC5kb2NzW2tdKTsKICAgICAgICAgICAgICAgIGFyci5wdXNoKHZhbCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc3VsdFtmaWVsZF0gPSBhcnI7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWNjVHlwZSA9PT0gIiRhZGRUb1NldCIpIHsKICAgICAgICAgICAgICBjb25zdCBzZXQgPSB7fTsKICAgICAgICAgICAgICBmb3IgKGxldCBrID0gMDsgayA8IGJ1Y2tldC5kb2NzLmxlbmd0aDsgaysrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24oYWNjRXhwciwgYnVja2V0LmRvY3Nba10pOwogICAgICAgICAgICAgICAgc2V0W0pTT04uc3RyaW5naWZ5KHZhbCldID0gdmFsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXN1bHRbZmllbGRdID0gT2JqZWN0LnZhbHVlcyhzZXQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBidWNrZXRlZC5wdXNoKHJlc3VsdCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdHMgPSBidWNrZXRlZC5zb3J0KChhLCBiKSA9PiB7CiAgICAgICAgICBpZiAoYS5faWQgPCBiLl9pZCkgcmV0dXJuIC0xOwogICAgICAgICAgaWYgKGEuX2lkID4gYi5faWQpIHJldHVybiAxOwogICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAoc3RhZ2VUeXBlID09PSAiJGJ1Y2tldEF1dG8iKSB7CiAgICAgICAgaWYgKCFzdGFnZVNwZWMuZ3JvdXBCeSB8fCAhc3RhZ2VTcGVjLmJ1Y2tldHMpIHsKICAgICAgICAgIHRocm93IG5ldyBRdWVyeUVycm9yKCIkYnVja2V0QXV0byByZXF1aXJlcyBncm91cEJ5IGFuZCBidWNrZXRzIiwgewogICAgICAgICAgICBjb2xsZWN0aW9uOiB0aGlzLm5hbWUsCiAgICAgICAgICAgIGNvZGU6IEVycm9yQ29kZXMuRkFJTEVEX1RPX1BBUlNFCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbnVtQnVja2V0cyA9IHN0YWdlU3BlYy5idWNrZXRzOwogICAgICAgIGNvbnN0IG91dHB1dCA9IHN0YWdlU3BlYy5vdXRwdXQgfHwgeyBjb3VudDogeyAkc3VtOiAxIH0gfTsKICAgICAgICBpZiAocmVzdWx0cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgIHJlc3VsdHMgPSBbXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3QgdmFsdWVzID0gcmVzdWx0cy5tYXAoKGRvYykgPT4gKHsKICAgICAgICAgICAgdmFsdWU6IGV2YWx1YXRlRXhwcmVzc2lvbihzdGFnZVNwZWMuZ3JvdXBCeSwgZG9jKSwKICAgICAgICAgICAgZG9jCiAgICAgICAgICB9KSkuc29ydCgoYSwgYikgPT4gewogICAgICAgICAgICBpZiAoYS52YWx1ZSA8IGIudmFsdWUpIHJldHVybiAtMTsKICAgICAgICAgICAgaWYgKGEudmFsdWUgPiBiLnZhbHVlKSByZXR1cm4gMTsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICB9KTsKICAgICAgICAgIGNvbnN0IGJ1Y2tldFNpemUgPSBNYXRoLmNlaWwodmFsdWVzLmxlbmd0aCAvIG51bUJ1Y2tldHMpOwogICAgICAgICAgY29uc3QgYnVja2V0cyA9IFtdOwogICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBudW1CdWNrZXRzICYmIGogKiBidWNrZXRTaXplIDwgdmFsdWVzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgIGNvbnN0IHN0YXJ0SWR4ID0gaiAqIGJ1Y2tldFNpemU7CiAgICAgICAgICAgIGNvbnN0IGVuZElkeCA9IE1hdGgubWluKChqICsgMSkgKiBidWNrZXRTaXplLCB2YWx1ZXMubGVuZ3RoKTsKICAgICAgICAgICAgY29uc3QgYnVja2V0RG9jcyA9IHZhbHVlcy5zbGljZShzdGFydElkeCwgZW5kSWR4KTsKICAgICAgICAgICAgaWYgKGJ1Y2tldERvY3MubGVuZ3RoID09PSAwKSBjb250aW51ZTsKICAgICAgICAgICAgY29uc3QgYnVja2V0ID0gewogICAgICAgICAgICAgIF9pZDogewogICAgICAgICAgICAgICAgbWluOiBidWNrZXREb2NzWzBdLnZhbHVlLAogICAgICAgICAgICAgICAgbWF4OiBlbmRJZHggPCB2YWx1ZXMubGVuZ3RoID8gYnVja2V0RG9jc1tidWNrZXREb2NzLmxlbmd0aCAtIDFdLnZhbHVlIDogYnVja2V0RG9jc1tidWNrZXREb2NzLmxlbmd0aCAtIDFdLnZhbHVlCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBkb2NzOiBidWNrZXREb2NzLm1hcCgodikgPT4gdi5kb2MpCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGJ1Y2tldHMucHVzaChidWNrZXQpOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgYnVja2V0ZWQgPSBbXTsKICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgYnVja2V0cy5sZW5ndGg7IGorKykgewogICAgICAgICAgICBjb25zdCBidWNrZXQgPSBidWNrZXRzW2pdOwogICAgICAgICAgICBjb25zdCByZXN1bHQgPSB7IF9pZDogYnVja2V0Ll9pZCB9OwogICAgICAgICAgICBmb3IgKGNvbnN0IGZpZWxkIGluIG91dHB1dCkgewogICAgICAgICAgICAgIGNvbnN0IGFjY3VtdWxhdG9yID0gb3V0cHV0W2ZpZWxkXTsKICAgICAgICAgICAgICBjb25zdCBhY2NLZXlzID0gT2JqZWN0LmtleXMoYWNjdW11bGF0b3IpOwogICAgICAgICAgICAgIGlmIChhY2NLZXlzLmxlbmd0aCAhPT0gMSkgY29udGludWU7CiAgICAgICAgICAgICAgY29uc3QgYWNjVHlwZSA9IGFjY0tleXNbMF07CiAgICAgICAgICAgICAgY29uc3QgYWNjRXhwciA9IGFjY3VtdWxhdG9yW2FjY1R5cGVdOwogICAgICAgICAgICAgIGlmIChhY2NUeXBlID09PSAiJHN1bSIpIHsKICAgICAgICAgICAgICAgIGxldCBzdW0gPSAwOwogICAgICAgICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBidWNrZXQuZG9jcy5sZW5ndGg7IGsrKykgewogICAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSBldmFsdWF0ZUV4cHJlc3Npb24oYWNjRXhwciwgYnVja2V0LmRvY3Nba10pOwogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgICAgICBzdW0gKz0gdmFsOwogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHZhbCAhPT0gbnVsbCAmJiB2YWwgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICAgIHN1bSArPSBOdW1iZXIodmFsKSB8fCAwOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXN1bHRbZmllbGRdID0gc3VtOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoYWNjVHlwZSA9PT0gIiRhdmciKSB7CiAgICAgICAgICAgICAgICBsZXQgc3VtID0gMDsKICAgICAgICAgICAgICAgIGxldCBjb3VudCA9IDA7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBrID0gMDsgayA8IGJ1Y2tldC5kb2NzLmxlbmd0aDsgaysrKSB7CiAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihhY2NFeHByLCBidWNrZXQuZG9jc1trXSk7CiAgICAgICAgICAgICAgICAgIGlmICh2YWwgIT09IHZvaWQgMCAmJiB2YWwgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBzdW0gKz0gTnVtYmVyKHZhbCkgfHwgMDsKICAgICAgICAgICAgICAgICAgICBjb3VudCsrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXN1bHRbZmllbGRdID0gY291bnQgPiAwID8gc3VtIC8gY291bnQgOiAwOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoYWNjVHlwZSA9PT0gIiRwdXNoIikgewogICAgICAgICAgICAgICAgY29uc3QgYXJyID0gW107CiAgICAgICAgICAgICAgICBmb3IgKGxldCBrID0gMDsgayA8IGJ1Y2tldC5kb2NzLmxlbmd0aDsgaysrKSB7CiAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihhY2NFeHByLCBidWNrZXQuZG9jc1trXSk7CiAgICAgICAgICAgICAgICAgIGFyci5wdXNoKHZhbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXN1bHRbZmllbGRdID0gYXJyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBidWNrZXRlZC5wdXNoKHJlc3VsdCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXN1bHRzID0gYnVja2V0ZWQ7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHN0YWdlVHlwZSA9PT0gIiRvdXQiKSB7CiAgICAgICAgY29uc3QgdGFyZ2V0Q29sbGVjdGlvbk5hbWUgPSBzdGFnZVNwZWM7CiAgICAgICAgaWYgKHR5cGVvZiB0YXJnZXRDb2xsZWN0aW9uTmFtZSAhPT0gInN0cmluZyIpIHsKICAgICAgICAgIHRocm93IG5ldyBRdWVyeUVycm9yKCIkb3V0IHJlcXVpcmVzIGEgc3RyaW5nIGNvbGxlY3Rpb24gbmFtZSIsIHsKICAgICAgICAgICAgY29sbGVjdGlvbjogdGhpcy5uYW1lLAogICAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLkZBSUxFRF9UT19QQVJTRQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLmRiLmNvbGxlY3Rpb25zLmhhcyh0YXJnZXRDb2xsZWN0aW9uTmFtZSkpIHsKICAgICAgICAgIGF3YWl0IHRoaXMuZGIuZHJvcENvbGxlY3Rpb24odGFyZ2V0Q29sbGVjdGlvbk5hbWUpOwogICAgICAgIH0KICAgICAgICBjb25zdCB0YXJnZXRDb2xsZWN0aW9uID0gdGhpcy5kYlt0YXJnZXRDb2xsZWN0aW9uTmFtZV07CiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCByZXN1bHRzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBjb25zdCBkb2MgPSByZXN1bHRzW2pdOwogICAgICAgICAgY29uc3QgZG9jSWQgPSBkb2MuX2lkOwogICAgICAgICAgdHlwZW9mIGRvY0lkID09PSAib2JqZWN0IiAmJiBkb2NJZC50b1N0cmluZyA/IGRvY0lkLnRvU3RyaW5nKCkgOiBTdHJpbmcoZG9jSWQpOwogICAgICAgICAgYXdhaXQgdGFyZ2V0Q29sbGVjdGlvbi5pbnNlcnRPbmUoZG9jKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0cyA9IFtdOwogICAgICB9IGVsc2UgaWYgKHN0YWdlVHlwZSA9PT0gIiRtZXJnZSIpIHsKICAgICAgICBsZXQgdGFyZ2V0Q29sbGVjdGlvbk5hbWU7CiAgICAgICAgbGV0IG9uID0gIl9pZCI7CiAgICAgICAgbGV0IHdoZW5NYXRjaGVkID0gIm1lcmdlIjsKICAgICAgICBsZXQgd2hlbk5vdE1hdGNoZWQgPSAiaW5zZXJ0IjsKICAgICAgICBpZiAodHlwZW9mIHN0YWdlU3BlYyA9PT0gInN0cmluZyIpIHsKICAgICAgICAgIHRhcmdldENvbGxlY3Rpb25OYW1lID0gc3RhZ2VTcGVjOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHN0YWdlU3BlYyA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgIHRhcmdldENvbGxlY3Rpb25OYW1lID0gc3RhZ2VTcGVjLmludG87CiAgICAgICAgICBvbiA9IHN0YWdlU3BlYy5vbiB8fCBvbjsKICAgICAgICAgIHdoZW5NYXRjaGVkID0gc3RhZ2VTcGVjLndoZW5NYXRjaGVkIHx8IHdoZW5NYXRjaGVkOwogICAgICAgICAgd2hlbk5vdE1hdGNoZWQgPSBzdGFnZVNwZWMud2hlbk5vdE1hdGNoZWQgfHwgd2hlbk5vdE1hdGNoZWQ7CiAgICAgICAgfQogICAgICAgIGlmICghdGFyZ2V0Q29sbGVjdGlvbk5hbWUpIHsKICAgICAgICAgIHRocm93IG5ldyBRdWVyeUVycm9yKCIkbWVyZ2UgcmVxdWlyZXMgYSB0YXJnZXQgY29sbGVjdGlvbiIsIHsKICAgICAgICAgICAgY29sbGVjdGlvbjogdGhpcy5uYW1lLAogICAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLkZBSUxFRF9UT19QQVJTRQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHRhcmdldENvbGxlY3Rpb24gPSB0aGlzLmRiW3RhcmdldENvbGxlY3Rpb25OYW1lXTsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHJlc3VsdHMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGNvbnN0IGRvYyA9IHJlc3VsdHNbal07CiAgICAgICAgICBjb25zdCBtYXRjaEZpZWxkID0gdHlwZW9mIG9uID09PSAic3RyaW5nIiA/IG9uIDogb25bMF07CiAgICAgICAgICBjb25zdCBtYXRjaFZhbHVlID0gZ2V0UHJvcChkb2MsIG1hdGNoRmllbGQpOwogICAgICAgICAgY29uc3QgZXhpc3RpbmdDdXJzb3IgPSB0YXJnZXRDb2xsZWN0aW9uLmZpbmQoeyBbbWF0Y2hGaWVsZF06IG1hdGNoVmFsdWUgfSk7CiAgICAgICAgICBhd2FpdCBleGlzdGluZ0N1cnNvci5fZW5zdXJlSW5pdGlhbGl6ZWQoKTsKICAgICAgICAgIGNvbnN0IGV4aXN0aW5nID0gYXdhaXQgZXhpc3RpbmdDdXJzb3IuaGFzTmV4dCgpID8gYXdhaXQgZXhpc3RpbmdDdXJzb3IubmV4dCgpIDogbnVsbDsKICAgICAgICAgIGlmIChleGlzdGluZykgewogICAgICAgICAgICBpZiAod2hlbk1hdGNoZWQgPT09ICJyZXBsYWNlIikgewogICAgICAgICAgICAgIGF3YWl0IHRhcmdldENvbGxlY3Rpb24ucmVwbGFjZU9uZSh7IF9pZDogZXhpc3RpbmcuX2lkIH0sIGRvYyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAod2hlbk1hdGNoZWQgPT09ICJtZXJnZSIpIHsKICAgICAgICAgICAgICBjb25zdCBtZXJnZWQgPSBPYmplY3QuYXNzaWduKHt9LCBleGlzdGluZywgZG9jKTsKICAgICAgICAgICAgICBhd2FpdCB0YXJnZXRDb2xsZWN0aW9uLnJlcGxhY2VPbmUoeyBfaWQ6IGV4aXN0aW5nLl9pZCB9LCBtZXJnZWQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHdoZW5NYXRjaGVkID09PSAia2VlcEV4aXN0aW5nIikgOwogICAgICAgICAgICBlbHNlIGlmICh3aGVuTWF0Y2hlZCA9PT0gImZhaWwiKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFF1ZXJ5RXJyb3IoIiRtZXJnZSBmYWlsZWQ6IGR1cGxpY2F0ZSBrZXkiLCB7CiAgICAgICAgICAgICAgICBjb2xsZWN0aW9uOiB0aGlzLm5hbWUsCiAgICAgICAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLkRVUExJQ0FURV9LRVkKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHdoZW5Ob3RNYXRjaGVkID09PSAiaW5zZXJ0IikgewogICAgICAgICAgICAgIGF3YWl0IHRhcmdldENvbGxlY3Rpb24uaW5zZXJ0T25lKGRvYyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAod2hlbk5vdE1hdGNoZWQgPT09ICJkaXNjYXJkIikgOwogICAgICAgICAgICBlbHNlIGlmICh3aGVuTm90TWF0Y2hlZCA9PT0gImZhaWwiKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFF1ZXJ5RXJyb3IoIiRtZXJnZSBmYWlsZWQ6IGRvY3VtZW50IG5vdCBmb3VuZCIsIHsKICAgICAgICAgICAgICAgIGNvbGxlY3Rpb246IHRoaXMubmFtZSwKICAgICAgICAgICAgICAgIGNvZGU6IEVycm9yQ29kZXMuRkFJTEVEX1RPX1BBUlNFCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmVzdWx0cyA9IFtdOwogICAgICB9IGVsc2UgaWYgKHN0YWdlVHlwZSA9PT0gIiRsb29rdXAiKSB7CiAgICAgICAgaWYgKCFzdGFnZVNwZWMuZnJvbSB8fCAhc3RhZ2VTcGVjLmxvY2FsRmllbGQgfHwgIXN0YWdlU3BlYy5mb3JlaWduRmllbGQgfHwgIXN0YWdlU3BlYy5hcykgewogICAgICAgICAgdGhyb3cgbmV3IFF1ZXJ5RXJyb3IoIiRsb29rdXAgcmVxdWlyZXMgZnJvbSwgbG9jYWxGaWVsZCwgZm9yZWlnbkZpZWxkLCBhbmQgYXMiLCB7CiAgICAgICAgICAgIGNvbGxlY3Rpb246IHRoaXMubmFtZSwKICAgICAgICAgICAgY29kZTogRXJyb3JDb2Rlcy5GQUlMRURfVE9fUEFSU0UKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBjb25zdCBjb2xsZWN0aW9uTmFtZXMgPSB0aGlzLmRiLmdldENvbGxlY3Rpb25OYW1lcygpOwogICAgICAgIGlmICghY29sbGVjdGlvbk5hbWVzLmluY2x1ZGVzKHN0YWdlU3BlYy5mcm9tKSkgewogICAgICAgICAgdGhyb3cgbmV3IFF1ZXJ5RXJyb3IoIiRsb29rdXA6IGNvbGxlY3Rpb24gbm90IGZvdW5kOiAiICsgc3RhZ2VTcGVjLmZyb20sIHsKICAgICAgICAgICAgY29sbGVjdGlvbjogdGhpcy5uYW1lLAogICAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLk5BTUVTUEFDRV9OT1RfRk9VTkQKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBjb25zdCBmcm9tQ29sbGVjdGlvbiA9IHRoaXMuZGJbc3RhZ2VTcGVjLmZyb21dOwogICAgICAgIGNvbnN0IGpvaW5lZCA9IFtdOwogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgcmVzdWx0cy5sZW5ndGg7IGorKykgewogICAgICAgICAgY29uc3QgZG9jID0gY29weShyZXN1bHRzW2pdKTsKICAgICAgICAgIGNvbnN0IGxvY2FsVmFsdWUgPSBnZXRQcm9wKGRvYywgc3RhZ2VTcGVjLmxvY2FsRmllbGQpOwogICAgICAgICAgY29uc3QgbWF0Y2hlczIgPSBbXTsKICAgICAgICAgIGNvbnN0IGZvcmVpZ25DdXJzb3IgPSBmcm9tQ29sbGVjdGlvbi5maW5kKHsgW3N0YWdlU3BlYy5mb3JlaWduRmllbGRdOiBsb2NhbFZhbHVlIH0pOwogICAgICAgICAgYXdhaXQgZm9yZWlnbkN1cnNvci5fZW5zdXJlSW5pdGlhbGl6ZWQoKTsKICAgICAgICAgIHdoaWxlIChhd2FpdCBmb3JlaWduQ3Vyc29yLmhhc05leHQoKSkgewogICAgICAgICAgICBtYXRjaGVzMi5wdXNoKGF3YWl0IGZvcmVpZ25DdXJzb3IubmV4dCgpKTsKICAgICAgICAgIH0KICAgICAgICAgIGRvY1tzdGFnZVNwZWMuYXNdID0gbWF0Y2hlczI7CiAgICAgICAgICBqb2luZWQucHVzaChkb2MpOwogICAgICAgIH0KICAgICAgICByZXN1bHRzID0gam9pbmVkOwogICAgICB9IGVsc2UgaWYgKHN0YWdlVHlwZSA9PT0gIiRncmFwaExvb2t1cCIpIHsKICAgICAgICBpZiAoIXN0YWdlU3BlYy5mcm9tIHx8ICFzdGFnZVNwZWMuc3RhcnRXaXRoIHx8ICFzdGFnZVNwZWMuY29ubmVjdEZyb21GaWVsZCB8fCAhc3RhZ2VTcGVjLmNvbm5lY3RUb0ZpZWxkIHx8ICFzdGFnZVNwZWMuYXMpIHsKICAgICAgICAgIHRocm93IG5ldyBRdWVyeUVycm9yKCIkZ3JhcGhMb29rdXAgcmVxdWlyZXMgZnJvbSwgc3RhcnRXaXRoLCBjb25uZWN0RnJvbUZpZWxkLCBjb25uZWN0VG9GaWVsZCwgYW5kIGFzIiwgewogICAgICAgICAgICBjb2xsZWN0aW9uOiB0aGlzLm5hbWUsCiAgICAgICAgICAgIGNvZGU6IEVycm9yQ29kZXMuRkFJTEVEX1RPX1BBUlNFCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY29sbGVjdGlvbk5hbWVzID0gdGhpcy5kYi5nZXRDb2xsZWN0aW9uTmFtZXMoKTsKICAgICAgICBpZiAoIWNvbGxlY3Rpb25OYW1lcy5pbmNsdWRlcyhzdGFnZVNwZWMuZnJvbSkpIHsKICAgICAgICAgIHRocm93IG5ldyBRdWVyeUVycm9yKCIkZ3JhcGhMb29rdXA6IGNvbGxlY3Rpb24gbm90IGZvdW5kOiAiICsgc3RhZ2VTcGVjLmZyb20sIHsKICAgICAgICAgICAgY29sbGVjdGlvbjogdGhpcy5uYW1lLAogICAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLk5BTUVTUEFDRV9OT1RfRk9VTkQKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBjb25zdCBmcm9tQ29sbGVjdGlvbiA9IHRoaXMuZGJbc3RhZ2VTcGVjLmZyb21dOwogICAgICAgIGNvbnN0IG1heERlcHRoID0gc3RhZ2VTcGVjLm1heERlcHRoICE9PSB2b2lkIDAgPyBzdGFnZVNwZWMubWF4RGVwdGggOiBOdW1iZXIuTUFYX1NBRkVfSU5URUdFUjsKICAgICAgICBjb25zdCBkZXB0aEZpZWxkID0gc3RhZ2VTcGVjLmRlcHRoRmllbGQ7CiAgICAgICAgY29uc3QgcmVzdHJpY3RTZWFyY2hXaXRoTWF0Y2ggPSBzdGFnZVNwZWMucmVzdHJpY3RTZWFyY2hXaXRoTWF0Y2g7CiAgICAgICAgY29uc3QgZ3JhcGhlZCA9IFtdOwogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgcmVzdWx0cy5sZW5ndGg7IGorKykgewogICAgICAgICAgY29uc3QgZG9jID0gY29weShyZXN1bHRzW2pdKTsKICAgICAgICAgIGNvbnN0IHN0YXJ0VmFsdWUgPSBldmFsdWF0ZUV4cHJlc3Npb24oc3RhZ2VTcGVjLnN0YXJ0V2l0aCwgcmVzdWx0c1tqXSk7CiAgICAgICAgICBjb25zdCB2aXNpdGVkID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIGNvbnN0IG1hdGNoZXMyID0gW107CiAgICAgICAgICBjb25zdCBxdWV1ZSA9IFt7IHZhbHVlOiBzdGFydFZhbHVlLCBkZXB0aDogMCB9XTsKICAgICAgICAgIHdoaWxlIChxdWV1ZS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGNvbnN0IHsgdmFsdWUsIGRlcHRoIH0gPSBxdWV1ZS5zaGlmdCgpOwogICAgICAgICAgICBpZiAoZGVwdGggPiBtYXhEZXB0aCkgY29udGludWU7CiAgICAgICAgICAgIGNvbnN0IHZhbHVlS2V5ID0gSlNPTi5zdHJpbmdpZnkodmFsdWUpOwogICAgICAgICAgICBpZiAodmlzaXRlZC5oYXModmFsdWVLZXkpKSBjb250aW51ZTsKICAgICAgICAgICAgdmlzaXRlZC5hZGQodmFsdWVLZXkpOwogICAgICAgICAgICBsZXQgcXVlcnkgPSB7IFtzdGFnZVNwZWMuY29ubmVjdFRvRmllbGRdOiB2YWx1ZSB9OwogICAgICAgICAgICBpZiAocmVzdHJpY3RTZWFyY2hXaXRoTWF0Y2gpIHsKICAgICAgICAgICAgICBxdWVyeSA9IHsgJGFuZDogW3F1ZXJ5LCByZXN0cmljdFNlYXJjaFdpdGhNYXRjaF0gfTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCBjdXJzb3IyID0gZnJvbUNvbGxlY3Rpb24uZmluZChxdWVyeSk7CiAgICAgICAgICAgIGF3YWl0IGN1cnNvcjIuX2Vuc3VyZUluaXRpYWxpemVkKCk7CiAgICAgICAgICAgIHdoaWxlIChhd2FpdCBjdXJzb3IyLmhhc05leHQoKSkgewogICAgICAgICAgICAgIGNvbnN0IG1hdGNoID0gYXdhaXQgY3Vyc29yMi5uZXh0KCk7CiAgICAgICAgICAgICAgY29uc3QgbWF0Y2hDb3B5ID0gY29weShtYXRjaCk7CiAgICAgICAgICAgICAgaWYgKGRlcHRoRmllbGQpIHsKICAgICAgICAgICAgICAgIG1hdGNoQ29weVtkZXB0aEZpZWxkXSA9IGRlcHRoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBtYXRjaGVzMi5wdXNoKG1hdGNoQ29weSk7CiAgICAgICAgICAgICAgY29uc3QgbmV4dFZhbHVlID0gZ2V0UHJvcChtYXRjaCwgc3RhZ2VTcGVjLmNvbm5lY3RGcm9tRmllbGQpOwogICAgICAgICAgICAgIGlmIChuZXh0VmFsdWUgIT09IHZvaWQgMCAmJiBuZXh0VmFsdWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHF1ZXVlLnB1c2goeyB2YWx1ZTogbmV4dFZhbHVlLCBkZXB0aDogZGVwdGggKyAxIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZG9jW3N0YWdlU3BlYy5hc10gPSBtYXRjaGVzMjsKICAgICAgICAgIGdyYXBoZWQucHVzaChkb2MpOwogICAgICAgIH0KICAgICAgICByZXN1bHRzID0gZ3JhcGhlZDsKICAgICAgfSBlbHNlIGlmIChzdGFnZVR5cGUgPT09ICIkZmFjZXQiKSB7CiAgICAgICAgaWYgKHR5cGVvZiBzdGFnZVNwZWMgIT09ICJvYmplY3QiIHx8IEFycmF5LmlzQXJyYXkoc3RhZ2VTcGVjKSkgewogICAgICAgICAgdGhyb3cgbmV3IFF1ZXJ5RXJyb3IoIiRmYWNldCByZXF1aXJlcyBhbiBvYmplY3Qgd2l0aCBwaXBlbGluZSBkZWZpbml0aW9ucyIsIHsKICAgICAgICAgICAgY29sbGVjdGlvbjogdGhpcy5uYW1lLAogICAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLkZBSUxFRF9UT19QQVJTRQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGZhY2V0UmVzdWx0ID0ge307CiAgICAgICAgZm9yIChjb25zdCBmYWNldE5hbWUgaW4gc3RhZ2VTcGVjKSB7CiAgICAgICAgICBjb25zdCBmYWNldFBpcGVsaW5lID0gc3RhZ2VTcGVjW2ZhY2V0TmFtZV07CiAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkoZmFjZXRQaXBlbGluZSkpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IFF1ZXJ5RXJyb3IoIiRmYWNldCBwaXBlbGluZSBtdXN0IGJlIGFuIGFycmF5IiwgewogICAgICAgICAgICAgIGNvbGxlY3Rpb246IHRoaXMubmFtZSwKICAgICAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLkZBSUxFRF9UT19QQVJTRQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGxldCBmYWNldFJlc3VsdHMgPSByZXN1bHRzLm1hcCgocikgPT4gY29weShyKSk7CiAgICAgICAgICBmb3IgKGxldCBrID0gMDsgayA8IGZhY2V0UGlwZWxpbmUubGVuZ3RoOyBrKyspIHsKICAgICAgICAgICAgY29uc3QgZmFjZXRTdGFnZSA9IGZhY2V0UGlwZWxpbmVba107CiAgICAgICAgICAgIGNvbnN0IGZhY2V0U3RhZ2VLZXlzID0gT2JqZWN0LmtleXMoZmFjZXRTdGFnZSk7CiAgICAgICAgICAgIGlmIChmYWNldFN0YWdlS2V5cy5sZW5ndGggIT09IDEpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgUXVlcnlFcnJvcigiRWFjaCBwaXBlbGluZSBzdGFnZSBtdXN0IGhhdmUgZXhhY3RseSBvbmUga2V5IiwgewogICAgICAgICAgICAgICAgY29sbGVjdGlvbjogdGhpcy5uYW1lLAogICAgICAgICAgICAgICAgY29kZTogRXJyb3JDb2Rlcy5GQUlMRURfVE9fUEFSU0UKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCBmYWNldFN0YWdlVHlwZSA9IGZhY2V0U3RhZ2VLZXlzWzBdOwogICAgICAgICAgICBjb25zdCBmYWNldFN0YWdlU3BlYyA9IGZhY2V0U3RhZ2VbZmFjZXRTdGFnZVR5cGVdOwogICAgICAgICAgICBpZiAoZmFjZXRTdGFnZVR5cGUgPT09ICIkbWF0Y2giKSB7CiAgICAgICAgICAgICAgY29uc3QgbWF0Y2hlZCA9IFtdOwogICAgICAgICAgICAgIGZvciAobGV0IG0gPSAwOyBtIDwgZmFjZXRSZXN1bHRzLmxlbmd0aDsgbSsrKSB7CiAgICAgICAgICAgICAgICBpZiAobWF0Y2hlcyhmYWNldFJlc3VsdHNbbV0sIGZhY2V0U3RhZ2VTcGVjKSkgewogICAgICAgICAgICAgICAgICBtYXRjaGVkLnB1c2goZmFjZXRSZXN1bHRzW21dKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZmFjZXRSZXN1bHRzID0gbWF0Y2hlZDsKICAgICAgICAgICAgfSBlbHNlIGlmIChmYWNldFN0YWdlVHlwZSA9PT0gIiRwcm9qZWN0IikgewogICAgICAgICAgICAgIGNvbnN0IHByb2plY3RlZCA9IFtdOwogICAgICAgICAgICAgIGZvciAobGV0IG0gPSAwOyBtIDwgZmFjZXRSZXN1bHRzLmxlbmd0aDsgbSsrKSB7CiAgICAgICAgICAgICAgICBwcm9qZWN0ZWQucHVzaChhcHBseVByb2plY3Rpb25XaXRoRXhwcmVzc2lvbnMoZmFjZXRTdGFnZVNwZWMsIGZhY2V0UmVzdWx0c1ttXSkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmYWNldFJlc3VsdHMgPSBwcm9qZWN0ZWQ7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmFjZXRTdGFnZVR5cGUgPT09ICIkbGltaXQiKSB7CiAgICAgICAgICAgICAgZmFjZXRSZXN1bHRzID0gZmFjZXRSZXN1bHRzLnNsaWNlKDAsIGZhY2V0U3RhZ2VTcGVjKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChmYWNldFN0YWdlVHlwZSA9PT0gIiRza2lwIikgewogICAgICAgICAgICAgIGZhY2V0UmVzdWx0cyA9IGZhY2V0UmVzdWx0cy5zbGljZShmYWNldFN0YWdlU3BlYyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmFjZXRTdGFnZVR5cGUgPT09ICIkc29ydCIpIHsKICAgICAgICAgICAgICBjb25zdCBzb3J0S2V5cyA9IE9iamVjdC5rZXlzKGZhY2V0U3RhZ2VTcGVjKTsKICAgICAgICAgICAgICBmYWNldFJlc3VsdHMuc29ydChmdW5jdGlvbihhLCBiKSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBuID0gMDsgbiA8IHNvcnRLZXlzLmxlbmd0aDsgbisrKSB7CiAgICAgICAgICAgICAgICAgIGNvbnN0IGtleSA9IHNvcnRLZXlzW25dOwogICAgICAgICAgICAgICAgICBpZiAoYVtrZXldID09PSB2b2lkIDAgJiYgYltrZXldICE9PSB2b2lkIDApIHJldHVybiAtMSAqIGZhY2V0U3RhZ2VTcGVjW2tleV07CiAgICAgICAgICAgICAgICAgIGlmIChhW2tleV0gIT09IHZvaWQgMCAmJiBiW2tleV0gPT09IHZvaWQgMCkgcmV0dXJuIDEgKiBmYWNldFN0YWdlU3BlY1trZXldOwogICAgICAgICAgICAgICAgICBpZiAoYVtrZXldIDwgYltrZXldKSByZXR1cm4gLTEgKiBmYWNldFN0YWdlU3BlY1trZXldOwogICAgICAgICAgICAgICAgICBpZiAoYVtrZXldID4gYltrZXldKSByZXR1cm4gMSAqIGZhY2V0U3RhZ2VTcGVjW2tleV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIGlmIChmYWNldFN0YWdlVHlwZSA9PT0gIiRjb3VudCIpIHsKICAgICAgICAgICAgICBmYWNldFJlc3VsdHMgPSBbeyBbZmFjZXRTdGFnZVNwZWNdOiBmYWNldFJlc3VsdHMubGVuZ3RoIH1dOwogICAgICAgICAgICB9IGVsc2UgaWYgKGZhY2V0U3RhZ2VUeXBlID09PSAiJGdyb3VwIikgewogICAgICAgICAgICAgIGNvbnN0IGdyb3VwcyA9IHt9OwogICAgICAgICAgICAgIGNvbnN0IGdyb3VwSWQgPSBmYWNldFN0YWdlU3BlYy5faWQ7CiAgICAgICAgICAgICAgZm9yIChsZXQgbSA9IDA7IG0gPCBmYWNldFJlc3VsdHMubGVuZ3RoOyBtKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRvYyA9IGZhY2V0UmVzdWx0c1ttXTsKICAgICAgICAgICAgICAgIGxldCBrZXk7CiAgICAgICAgICAgICAgICBpZiAoZ3JvdXBJZCA9PT0gbnVsbCB8fCBncm91cElkID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAga2V5ID0gbnVsbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGtleSA9IGV2YWx1YXRlRXhwcmVzc2lvbihncm91cElkLCBkb2MpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3Qga2V5U3RyID0gSlNPTi5zdHJpbmdpZnkoa2V5KTsKICAgICAgICAgICAgICAgIGlmICghZ3JvdXBzW2tleVN0cl0pIHsKICAgICAgICAgICAgICAgICAgZ3JvdXBzW2tleVN0cl0gPSB7CiAgICAgICAgICAgICAgICAgICAgX2lkOiBrZXksCiAgICAgICAgICAgICAgICAgICAgZG9jczogW10sCiAgICAgICAgICAgICAgICAgICAgYWNjdW11bGF0b3JzOiB7fQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZ3JvdXBzW2tleVN0cl0uZG9jcy5wdXNoKGRvYyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnN0IGdyb3VwZWQgPSBbXTsKICAgICAgICAgICAgICBmb3IgKGNvbnN0IGdyb3VwS2V5IGluIGdyb3VwcykgewogICAgICAgICAgICAgICAgY29uc3QgZ3JvdXAgPSBncm91cHNbZ3JvdXBLZXldOwogICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0geyBfaWQ6IGdyb3VwLl9pZCB9OwogICAgICAgICAgICAgICAgZm9yIChjb25zdCBmaWVsZCBpbiBmYWNldFN0YWdlU3BlYykgewogICAgICAgICAgICAgICAgICBpZiAoZmllbGQgPT09ICJfaWQiKSBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgY29uc3QgYWNjdW11bGF0b3IgPSBmYWNldFN0YWdlU3BlY1tmaWVsZF07CiAgICAgICAgICAgICAgICAgIGNvbnN0IGFjY0tleXMgPSBPYmplY3Qua2V5cyhhY2N1bXVsYXRvcik7CiAgICAgICAgICAgICAgICAgIGlmIChhY2NLZXlzLmxlbmd0aCAhPT0gMSkgY29udGludWU7CiAgICAgICAgICAgICAgICAgIGNvbnN0IGFjY1R5cGUgPSBhY2NLZXlzWzBdOwogICAgICAgICAgICAgICAgICBjb25zdCBhY2NFeHByID0gYWNjdW11bGF0b3JbYWNjVHlwZV07CiAgICAgICAgICAgICAgICAgIGlmIChhY2NUeXBlID09PSAiJHN1bSIpIHsKICAgICAgICAgICAgICAgICAgICBsZXQgc3VtID0gMDsKICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBuID0gMDsgbiA8IGdyb3VwLmRvY3MubGVuZ3RoOyBuKyspIHsKICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihhY2NFeHByLCBncm91cC5kb2NzW25dKTsKICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgICAgICAgICBzdW0gKz0gdmFsOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh2YWwgIT09IG51bGwgJiYgdmFsICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3VtICs9IE51bWJlcih2YWwpIHx8IDA7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJlc3VsdFtmaWVsZF0gPSBzdW07CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYWNjVHlwZSA9PT0gIiRhdmciKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHN1bSA9IDA7CiAgICAgICAgICAgICAgICAgICAgbGV0IGNvdW50ID0gMDsKICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBuID0gMDsgbiA8IGdyb3VwLmRvY3MubGVuZ3RoOyBuKyspIHsKICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihhY2NFeHByLCBncm91cC5kb2NzW25dKTsKICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWwgIT09IHZvaWQgMCAmJiB2YWwgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3VtICs9IE51bWJlcih2YWwpIHx8IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJlc3VsdFtmaWVsZF0gPSBjb3VudCA+IDAgPyBzdW0gLyBjb3VudCA6IDA7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYWNjVHlwZSA9PT0gIiRtYXgiKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IG1heCA9IHZvaWQgMDsKICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBuID0gMDsgbiA8IGdyb3VwLmRvY3MubGVuZ3RoOyBuKyspIHsKICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IGV2YWx1YXRlRXhwcmVzc2lvbihhY2NFeHByLCBncm91cC5kb2NzW25dKTsKICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWwgIT09IHZvaWQgMCAmJiAobWF4ID09PSB2b2lkIDAgfHwgdmFsID4gbWF4KSkgewogICAgICAgICAgICAgICAgICAgICAgICBtYXggPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJlc3VsdFtmaWVsZF0gPSBtYXg7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGdyb3VwZWQucHVzaChyZXN1bHQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmYWNldFJlc3VsdHMgPSBncm91cGVkOwogICAgICAgICAgICB9IGVsc2UgaWYgKGZhY2V0U3RhZ2VUeXBlID09PSAiJHNvcnRCeUNvdW50IikgewogICAgICAgICAgICAgIGNvbnN0IGdyb3VwcyA9IHt9OwogICAgICAgICAgICAgIGZvciAobGV0IG0gPSAwOyBtIDwgZmFjZXRSZXN1bHRzLmxlbmd0aDsgbSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkb2MgPSBmYWNldFJlc3VsdHNbbV07CiAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGV2YWx1YXRlRXhwcmVzc2lvbihmYWNldFN0YWdlU3BlYywgZG9jKTsKICAgICAgICAgICAgICAgIGNvbnN0IGtleSA9IEpTT04uc3RyaW5naWZ5KHZhbHVlKTsKICAgICAgICAgICAgICAgIGlmICghZ3JvdXBzW2tleV0pIHsKICAgICAgICAgICAgICAgICAgZ3JvdXBzW2tleV0gPSB7CiAgICAgICAgICAgICAgICAgICAgX2lkOiB2YWx1ZSwKICAgICAgICAgICAgICAgICAgICBjb3VudDogMAogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZ3JvdXBzW2tleV0uY291bnQrKzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZmFjZXRSZXN1bHRzID0gT2JqZWN0LnZhbHVlcyhncm91cHMpLnNvcnQoKGEsIGIpID0+IGIuY291bnQgLSBhLmNvdW50KTsKICAgICAgICAgICAgfSBlbHNlIGlmIChmYWNldFN0YWdlVHlwZSA9PT0gIiRzYW1wbGUiKSB7CiAgICAgICAgICAgICAgY29uc3Qgc2l6ZSA9IGZhY2V0U3RhZ2VTcGVjLnNpemUgfHwgMTsKICAgICAgICAgICAgICBjb25zdCBzaHVmZmxlZCA9IFsuLi5mYWNldFJlc3VsdHNdOwogICAgICAgICAgICAgIGZvciAobGV0IG0gPSBzaHVmZmxlZC5sZW5ndGggLSAxOyBtID4gMDsgbS0tKSB7CiAgICAgICAgICAgICAgICBjb25zdCBrMiA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChtICsgMSkpOwogICAgICAgICAgICAgICAgW3NodWZmbGVkW21dLCBzaHVmZmxlZFtrMl1dID0gW3NodWZmbGVkW2syXSwgc2h1ZmZsZWRbbV1dOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmYWNldFJlc3VsdHMgPSBzaHVmZmxlZC5zbGljZSgwLCBNYXRoLm1pbihzaXplLCBzaHVmZmxlZC5sZW5ndGgpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChmYWNldFN0YWdlVHlwZSA9PT0gIiRidWNrZXQiKSB7CiAgICAgICAgICAgICAgY29uc3QgYm91bmRhcmllcyA9IGZhY2V0U3RhZ2VTcGVjLmJvdW5kYXJpZXM7CiAgICAgICAgICAgICAgY29uc3QgZGVmYXVsdEJ1Y2tldCA9IGZhY2V0U3RhZ2VTcGVjLmRlZmF1bHQ7CiAgICAgICAgICAgICAgY29uc3Qgb3V0cHV0ID0gZmFjZXRTdGFnZVNwZWMub3V0cHV0IHx8IHsgY291bnQ6IHsgJHN1bTogMSB9IH07CiAgICAgICAgICAgICAgY29uc3QgYnVja2V0cyA9IHt9OwogICAgICAgICAgICAgIGZvciAobGV0IG0gPSAwOyBtIDwgYm91bmRhcmllcy5sZW5ndGggLSAxOyBtKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGtleSA9IEpTT04uc3RyaW5naWZ5KGJvdW5kYXJpZXNbbV0pOwogICAgICAgICAgICAgICAgYnVja2V0c1trZXldID0gewogICAgICAgICAgICAgICAgICBfaWQ6IGJvdW5kYXJpZXNbbV0sCiAgICAgICAgICAgICAgICAgIGRvY3M6IFtdCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZGVmYXVsdEJ1Y2tldCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBidWNrZXRzWyJkZWZhdWx0Il0gPSB7CiAgICAgICAgICAgICAgICAgIF9pZDogZGVmYXVsdEJ1Y2tldCwKICAgICAgICAgICAgICAgICAgZG9jczogW10KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZvciAobGV0IG0gPSAwOyBtIDwgZmFjZXRSZXN1bHRzLmxlbmd0aDsgbSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkb2MgPSBmYWNldFJlc3VsdHNbbV07CiAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGV2YWx1YXRlRXhwcmVzc2lvbihmYWNldFN0YWdlU3BlYy5ncm91cEJ5LCBkb2MpOwogICAgICAgICAgICAgICAgbGV0IHBsYWNlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgZm9yIChsZXQgbiA9IDA7IG4gPCBib3VuZGFyaWVzLmxlbmd0aCAtIDE7IG4rKykgewogICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPj0gYm91bmRhcmllc1tuXSAmJiB2YWx1ZSA8IGJvdW5kYXJpZXNbbiArIDFdKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qga2V5ID0gSlNPTi5zdHJpbmdpZnkoYm91bmRhcmllc1tuXSk7CiAgICAgICAgICAgICAgICAgICAgYnVja2V0c1trZXldLmRvY3MucHVzaChkb2MpOwogICAgICAgICAgICAgICAgICAgIHBsYWNlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICghcGxhY2VkICYmIGRlZmF1bHRCdWNrZXQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICBidWNrZXRzWyJkZWZhdWx0Il0uZG9jcy5wdXNoKGRvYyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnN0IGJ1Y2tldGVkID0gW107CiAgICAgICAgICAgICAgZm9yIChjb25zdCBidWNrZXRLZXkgaW4gYnVja2V0cykgewogICAgICAgICAgICAgICAgY29uc3QgYnVja2V0ID0gYnVja2V0c1tidWNrZXRLZXldOwogICAgICAgICAgICAgICAgaWYgKGJ1Y2tldC5kb2NzLmxlbmd0aCA9PT0gMCkgY29udGludWU7CiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSB7IF9pZDogYnVja2V0Ll9pZCB9OwogICAgICAgICAgICAgICAgZm9yIChjb25zdCBmaWVsZCBpbiBvdXRwdXQpIHsKICAgICAgICAgICAgICAgICAgY29uc3QgYWNjdW11bGF0b3IgPSBvdXRwdXRbZmllbGRdOwogICAgICAgICAgICAgICAgICBjb25zdCBhY2NLZXlzID0gT2JqZWN0LmtleXMoYWNjdW11bGF0b3IpOwogICAgICAgICAgICAgICAgICBpZiAoYWNjS2V5cy5sZW5ndGggIT09IDEpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICBjb25zdCBhY2NUeXBlID0gYWNjS2V5c1swXTsKICAgICAgICAgICAgICAgICAgY29uc3QgYWNjRXhwciA9IGFjY3VtdWxhdG9yW2FjY1R5cGVdOwogICAgICAgICAgICAgICAgICBpZiAoYWNjVHlwZSA9PT0gIiRzdW0iKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHN1bSA9IDA7CiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgbiA9IDA7IG4gPCBidWNrZXQuZG9jcy5sZW5ndGg7IG4rKykgewogICAgICAgICAgICAgICAgICAgICAgY29uc3QgdmFsID0gZXZhbHVhdGVFeHByZXNzaW9uKGFjY0V4cHIsIGJ1Y2tldC5kb2NzW25dKTsKICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgICAgICAgICBzdW0gKz0gdmFsOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh2YWwgIT09IG51bGwgJiYgdmFsICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3VtICs9IE51bWJlcih2YWwpIHx8IDA7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJlc3VsdFtmaWVsZF0gPSBzdW07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJ1Y2tldGVkLnB1c2gocmVzdWx0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZmFjZXRSZXN1bHRzID0gYnVja2V0ZWQuc29ydCgoYSwgYikgPT4gewogICAgICAgICAgICAgICAgaWYgKGEuX2lkIDwgYi5faWQpIHJldHVybiAtMTsKICAgICAgICAgICAgICAgIGlmIChhLl9pZCA+IGIuX2lkKSByZXR1cm4gMTsKICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmYWNldFJlc3VsdFtmYWNldE5hbWVdID0gZmFjZXRSZXN1bHRzOwogICAgICAgIH0KICAgICAgICByZXN1bHRzID0gW2ZhY2V0UmVzdWx0XTsKICAgICAgfSBlbHNlIGlmIChzdGFnZVR5cGUgPT09ICIkcmVkYWN0IikgewogICAgICAgIGNvbnN0IHJlZGFjdGVkID0gW107CiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCByZXN1bHRzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBjb25zdCBkb2MgPSByZXN1bHRzW2pdOwogICAgICAgICAgY29uc3QgZGVjaXNpb24gPSBldmFsdWF0ZUV4cHJlc3Npb24oc3RhZ2VTcGVjLCBkb2MpOwogICAgICAgICAgaWYgKGRlY2lzaW9uID09PSAiJCRERVNDRU5EIikgewogICAgICAgICAgICByZWRhY3RlZC5wdXNoKGRvYyk7CiAgICAgICAgICB9IGVsc2UgaWYgKGRlY2lzaW9uID09PSAiJCRQUlVORSIpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9IGVsc2UgaWYgKGRlY2lzaW9uID09PSAiJCRLRUVQIikgewogICAgICAgICAgICByZWRhY3RlZC5wdXNoKGRvYyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoZGVjaXNpb24pIHsKICAgICAgICAgICAgICByZWRhY3RlZC5wdXNoKGRvYyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmVzdWx0cyA9IHJlZGFjdGVkOwogICAgICB9IGVsc2UgaWYgKHN0YWdlVHlwZSA9PT0gIiRnZW9OZWFyIikgewogICAgICAgIGlmICghc3RhZ2VTcGVjLm5lYXIgfHwgIXN0YWdlU3BlYy5kaXN0YW5jZUZpZWxkKSB7CiAgICAgICAgICB0aHJvdyBuZXcgUXVlcnlFcnJvcigiJGdlb05lYXIgcmVxdWlyZXMgbmVhciBhbmQgZGlzdGFuY2VGaWVsZCIsIHsKICAgICAgICAgICAgY29sbGVjdGlvbjogdGhpcy5uYW1lLAogICAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLkZBSUxFRF9UT19QQVJTRQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5lYXIgPSBzdGFnZVNwZWMubmVhcjsKICAgICAgICBjb25zdCBkaXN0YW5jZUZpZWxkID0gc3RhZ2VTcGVjLmRpc3RhbmNlRmllbGQ7CiAgICAgICAgY29uc3QgbWF4RGlzdGFuY2UgPSBzdGFnZVNwZWMubWF4RGlzdGFuY2U7CiAgICAgICAgY29uc3QgbWluRGlzdGFuY2UgPSBzdGFnZVNwZWMubWluRGlzdGFuY2UgfHwgMDsKICAgICAgICBjb25zdCBzcGhlcmljYWwgPSBzdGFnZVNwZWMuc3BoZXJpY2FsICE9PSBmYWxzZTsKICAgICAgICBjb25zdCBrZXkgPSBzdGFnZVNwZWMua2V5IHx8ICJsb2NhdGlvbiI7CiAgICAgICAgY29uc3Qgd2l0aERpc3RhbmNlcyA9IFtdOwogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgcmVzdWx0cy5sZW5ndGg7IGorKykgewogICAgICAgICAgY29uc3QgZG9jID0gY29weShyZXN1bHRzW2pdKTsKICAgICAgICAgIGNvbnN0IGxvY2F0aW9uID0gZ2V0UHJvcChkb2MsIGtleSk7CiAgICAgICAgICBpZiAoIWxvY2F0aW9uIHx8ICFBcnJheS5pc0FycmF5KGxvY2F0aW9uKSB8fCBsb2NhdGlvbi5sZW5ndGggPCAyKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgbGV0IGRpc3RhbmNlOwogICAgICAgICAgaWYgKHNwaGVyaWNhbCkgewogICAgICAgICAgICBjb25zdCBSID0gNjM3MWUzOwogICAgICAgICAgICBjb25zdCBsYXQxID0gbmVhclsxXSAqIE1hdGguUEkgLyAxODA7CiAgICAgICAgICAgIGNvbnN0IGxhdDIgPSBsb2NhdGlvblsxXSAqIE1hdGguUEkgLyAxODA7CiAgICAgICAgICAgIGNvbnN0IGRlbHRhTGF0ID0gKGxvY2F0aW9uWzFdIC0gbmVhclsxXSkgKiBNYXRoLlBJIC8gMTgwOwogICAgICAgICAgICBjb25zdCBkZWx0YUxvbiA9IChsb2NhdGlvblswXSAtIG5lYXJbMF0pICogTWF0aC5QSSAvIDE4MDsKICAgICAgICAgICAgY29uc3QgYSA9IE1hdGguc2luKGRlbHRhTGF0IC8gMikgKiBNYXRoLnNpbihkZWx0YUxhdCAvIDIpICsgTWF0aC5jb3MobGF0MSkgKiBNYXRoLmNvcyhsYXQyKSAqIE1hdGguc2luKGRlbHRhTG9uIC8gMikgKiBNYXRoLnNpbihkZWx0YUxvbiAvIDIpOwogICAgICAgICAgICBjb25zdCBjID0gMiAqIE1hdGguYXRhbjIoTWF0aC5zcXJ0KGEpLCBNYXRoLnNxcnQoMSAtIGEpKTsKICAgICAgICAgICAgZGlzdGFuY2UgPSBSICogYzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IGR4ID0gbG9jYXRpb25bMF0gLSBuZWFyWzBdOwogICAgICAgICAgICBjb25zdCBkeSA9IGxvY2F0aW9uWzFdIC0gbmVhclsxXTsKICAgICAgICAgICAgZGlzdGFuY2UgPSBNYXRoLnNxcnQoZHggKiBkeCArIGR5ICogZHkpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGRpc3RhbmNlID49IG1pbkRpc3RhbmNlICYmICghbWF4RGlzdGFuY2UgfHwgZGlzdGFuY2UgPD0gbWF4RGlzdGFuY2UpKSB7CiAgICAgICAgICAgIGRvY1tkaXN0YW5jZUZpZWxkXSA9IGRpc3RhbmNlOwogICAgICAgICAgICB3aXRoRGlzdGFuY2VzLnB1c2goZG9jKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgd2l0aERpc3RhbmNlcy5zb3J0KChhLCBiKSA9PiBhW2Rpc3RhbmNlRmllbGRdIC0gYltkaXN0YW5jZUZpZWxkXSk7CiAgICAgICAgaWYgKHN0YWdlU3BlYy5saW1pdCkgewogICAgICAgICAgcmVzdWx0cyA9IHdpdGhEaXN0YW5jZXMuc2xpY2UoMCwgc3RhZ2VTcGVjLmxpbWl0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0cyA9IHdpdGhEaXN0YW5jZXM7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBRdWVyeUVycm9yKCJVbnN1cHBvcnRlZCBhZ2dyZWdhdGlvbiBzdGFnZTogIiArIHN0YWdlVHlwZSwgewogICAgICAgICAgY29sbGVjdGlvbjogdGhpcy5uYW1lLAogICAgICAgICAgY29kZTogRXJyb3JDb2Rlcy5GQUlMRURfVE9fUEFSU0UKICAgICAgICB9KTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdHM7CiAgfQogIGFzeW5jIGJ1bGtXcml0ZSgpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJidWxrV3JpdGUiLCB7IGNvbGxlY3Rpb246IHRoaXMubmFtZSB9KTsKICB9CiAgYXN5bmMgY291bnQoKSB7CiAgICBpZiAoIXRoaXMuX2luaXRpYWxpemVkKSBhd2FpdCB0aGlzLl9pbml0aWFsaXplKCk7CiAgICBsZXQgY291bnQgPSAwOwogICAgZm9yIGF3YWl0IChjb25zdCBfIG9mIHRoaXMuZG9jdW1lbnRzKSB7CiAgICAgIGNvdW50Kys7CiAgICB9CiAgICByZXR1cm4gY291bnQ7CiAgfQogIGFzeW5jIGNvcHlUbyhkZXN0Q29sbGVjdGlvbk5hbWUpIHsKICAgIHRoaXMuZGIuY3JlYXRlQ29sbGVjdGlvbihkZXN0Q29sbGVjdGlvbk5hbWUpOwogICAgY29uc3QgZGVzdENvbCA9IHRoaXMuZGIuZ2V0Q29sbGVjdGlvbihkZXN0Q29sbGVjdGlvbk5hbWUpOwogICAgbGV0IG51bUNvcGllZCA9IDA7CiAgICBjb25zdCBjID0gdGhpcy5maW5kKHt9KTsKICAgIGF3YWl0IGMuX2Vuc3VyZUluaXRpYWxpemVkKCk7CiAgICB3aGlsZSAoYXdhaXQgYy5oYXNOZXh0KCkpIHsKICAgICAgYXdhaXQgZGVzdENvbC5pbnNlcnRPbmUoYXdhaXQgYy5uZXh0KCkpOwogICAgICBudW1Db3BpZWQrKzsKICAgIH0KICAgIHJldHVybiBudW1Db3BpZWQ7CiAgfQogIGFzeW5jIGNyZWF0ZUluZGV4KGtleXMsIG9wdGlvbnMpIHsKICAgIGlmICghdGhpcy5faW5pdGlhbGl6ZWQpIGF3YWl0IHRoaXMuX2luaXRpYWxpemUoKTsKICAgIGlmICgha2V5cyB8fCB0eXBlb2Yga2V5cyAhPT0gIm9iamVjdCIgfHwgQXJyYXkuaXNBcnJheShrZXlzKSkgewogICAgICB0aHJvdyBuZXcgQmFkVmFsdWVFcnJvcigia2V5cyIsIGtleXMsICJjcmVhdGVJbmRleCByZXF1aXJlcyBhIGtleSBzcGVjaWZpY2F0aW9uIG9iamVjdCIsIHsKICAgICAgICBjb2xsZWN0aW9uOiB0aGlzLm5hbWUKICAgICAgfSk7CiAgICB9CiAgICBjb25zdCBpbmRleE5hbWUgPSBvcHRpb25zICYmIG9wdGlvbnMubmFtZSA/IG9wdGlvbnMubmFtZSA6IHRoaXMuZ2VuZXJhdGVJbmRleE5hbWUoa2V5cyk7CiAgICBpZiAodGhpcy5pbmRleGVzLmhhcyhpbmRleE5hbWUpKSB7CiAgICAgIGNvbnN0IGV4aXN0aW5nSW5kZXggPSB0aGlzLmluZGV4ZXMuZ2V0KGluZGV4TmFtZSk7CiAgICAgIGNvbnN0IGV4aXN0aW5nS2V5cyA9IEpTT04uc3RyaW5naWZ5KGV4aXN0aW5nSW5kZXgua2V5cyk7CiAgICAgIGNvbnN0IG5ld0tleXMgPSBKU09OLnN0cmluZ2lmeShrZXlzKTsKICAgICAgaWYgKGV4aXN0aW5nS2V5cyAhPT0gbmV3S2V5cykgewogICAgICAgIHRocm93IG5ldyBJbmRleEVycm9yKAogICAgICAgICAgIkluZGV4IHdpdGggbmFtZSAnIiArIGluZGV4TmFtZSArICInIGFscmVhZHkgZXhpc3RzIHdpdGggYSBkaWZmZXJlbnQga2V5IHNwZWNpZmljYXRpb24iLAogICAgICAgICAgewogICAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLklOREVYX09QVElPTlNfQ09ORkxJQ1QsCiAgICAgICAgICAgIGluZGV4OiBpbmRleE5hbWUsCiAgICAgICAgICAgIGNvbGxlY3Rpb246IHRoaXMubmFtZQogICAgICAgICAgfQogICAgICAgICk7CiAgICAgIH0KICAgICAgcmV0dXJuIGluZGV4TmFtZTsKICAgIH0KICAgIGF3YWl0IHRoaXMuX2J1aWxkSW5kZXgoaW5kZXhOYW1lLCBrZXlzLCBvcHRpb25zKTsKICAgIHJldHVybiBpbmRleE5hbWU7CiAgfQogIGRhdGFTaXplKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoImRhdGFTaXplIiwgeyBjb2xsZWN0aW9uOiB0aGlzLm5hbWUgfSk7CiAgfQogIGFzeW5jIGRlbGV0ZU9uZShxdWVyeSkgewogICAgY29uc3QgZG9jID0gYXdhaXQgdGhpcy5maW5kT25lKHF1ZXJ5KTsKICAgIGlmIChkb2MpIHsKICAgICAgYXdhaXQgdGhpcy51cGRhdGVJbmRleGVzT25EZWxldGUoZG9jKTsKICAgICAgYXdhaXQgdGhpcy5kb2N1bWVudHMuZGVsZXRlKGRvYy5faWQudG9TdHJpbmcoKSk7CiAgICAgIHRoaXMuZW1pdCgiZGVsZXRlIiwgeyBfaWQ6IGRvYy5faWQgfSk7CiAgICAgIHJldHVybiB7IGRlbGV0ZWRDb3VudDogMSB9OwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHsgZGVsZXRlZENvdW50OiAwIH07CiAgICB9CiAgfQogIGFzeW5jIGRlbGV0ZU1hbnkocXVlcnkpIHsKICAgIGNvbnN0IGMgPSB0aGlzLmZpbmQocXVlcnkpOwogICAgYXdhaXQgYy5fZW5zdXJlSW5pdGlhbGl6ZWQoKTsKICAgIGNvbnN0IGlkcyA9IFtdOwogICAgY29uc3QgZG9jcyA9IFtdOwogICAgd2hpbGUgKGF3YWl0IGMuaGFzTmV4dCgpKSB7CiAgICAgIGNvbnN0IGRvYyA9IGF3YWl0IGMubmV4dCgpOwogICAgICBpZHMucHVzaChkb2MuX2lkKTsKICAgICAgZG9jcy5wdXNoKGRvYyk7CiAgICB9CiAgICBjb25zdCBkZWxldGVkQ291bnQgPSBpZHMubGVuZ3RoOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpZHMubGVuZ3RoOyBpKyspIHsKICAgICAgYXdhaXQgdGhpcy51cGRhdGVJbmRleGVzT25EZWxldGUoZG9jc1tpXSk7CiAgICAgIHRoaXMuZG9jdW1lbnRzLmRlbGV0ZShpZHNbaV0udG9TdHJpbmcoKSk7CiAgICAgIHRoaXMuZW1pdCgiZGVsZXRlIiwgeyBfaWQ6IGlkc1tpXSB9KTsKICAgIH0KICAgIHJldHVybiB7IGRlbGV0ZWRDb3VudCB9OwogIH0KICBhc3luYyBkaXN0aW5jdChmaWVsZCwgcXVlcnkpIHsKICAgIGNvbnN0IHZhbHMgPSB7fTsKICAgIGNvbnN0IGMgPSB0aGlzLmZpbmQocXVlcnkpOwogICAgYXdhaXQgYy5fZW5zdXJlSW5pdGlhbGl6ZWQoKTsKICAgIHdoaWxlIChhd2FpdCBjLmhhc05leHQoKSkgewogICAgICBjb25zdCBkID0gYXdhaXQgYy5uZXh0KCk7CiAgICAgIGlmIChkW2ZpZWxkXSkgewogICAgICAgIHZhbHNbZFtmaWVsZF1dID0gdHJ1ZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIE9iamVjdC5rZXlzKHZhbHMpOwogIH0KICBhc3luYyBkcm9wKCkgewogICAgaWYgKCF0aGlzLl9pbml0aWFsaXplZCkgYXdhaXQgdGhpcy5faW5pdGlhbGl6ZSgpOwogICAgZm9yIChjb25zdCBbaW5kZXhOYW1lLCBpbmRleF0gb2YgdGhpcy5pbmRleGVzKSB7CiAgICAgIGlmIChpbmRleCAmJiB0eXBlb2YgaW5kZXguY2xvc2UgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICBhd2FpdCBpbmRleC5jbG9zZSgpOwogICAgICB9CiAgICB9CiAgICBpZiAodGhpcy5kb2N1bWVudHMgJiYgdHlwZW9mIHRoaXMuZG9jdW1lbnRzLmNsb3NlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIGF3YWl0IHRoaXMuZG9jdW1lbnRzLmNsb3NlKCk7CiAgICB9CiAgICBpZiAodGhpcy5fcmVsZWFzZURvY3VtZW50cykgewogICAgICBhd2FpdCB0aGlzLl9yZWxlYXNlRG9jdW1lbnRzKCk7CiAgICAgIHRoaXMuX3JlbGVhc2VEb2N1bWVudHMgPSBudWxsOwogICAgfQogICAgdHJ5IHsKICAgICAgY29uc3QgcGF0aFBhcnRzMiA9IHRoaXMucGF0aC5zcGxpdCgiLyIpLmZpbHRlcihCb29sZWFuKTsKICAgICAgbGV0IGNvbGxlY3Rpb25EaXIgPSBhd2FpdCBnbG9iYWxUaGlzLm5hdmlnYXRvci5zdG9yYWdlLmdldERpcmVjdG9yeSgpOwogICAgICBmb3IgKGNvbnN0IHBhcnQgb2YgcGF0aFBhcnRzMikgewogICAgICAgIGNvbGxlY3Rpb25EaXIgPSBhd2FpdCBjb2xsZWN0aW9uRGlyLmdldERpcmVjdG9yeUhhbmRsZShwYXJ0LCB7IGNyZWF0ZTogZmFsc2UgfSk7CiAgICAgIH0KICAgICAgY29uc3QgZW50cmllc1RvRGVsZXRlID0gW107CiAgICAgIGZvciBhd2FpdCAoY29uc3QgW2VudHJ5TmFtZSwgZW50cnlIYW5kbGVdIG9mIGNvbGxlY3Rpb25EaXIuZW50cmllcygpKSB7CiAgICAgICAgZW50cmllc1RvRGVsZXRlLnB1c2goZW50cnlOYW1lKTsKICAgICAgfQogICAgICBmb3IgKGNvbnN0IGVudHJ5TmFtZSBvZiBlbnRyaWVzVG9EZWxldGUpIHsKICAgICAgICB0cnkgewogICAgICAgICAgYXdhaXQgY29sbGVjdGlvbkRpci5yZW1vdmVFbnRyeShlbnRyeU5hbWUsIHsgcmVjdXJzaXZlOiBmYWxzZSB9KTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgfQogICAgICB9CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgfQogICAgY29uc3QgcGF0aFBhcnRzID0gdGhpcy5wYXRoLnNwbGl0KCIvIikuZmlsdGVyKEJvb2xlYW4pOwogICAgY29uc3QgZmlsZW5hbWUgPSBwYXRoUGFydHMucG9wKCk7CiAgICB0cnkgewogICAgICBsZXQgZGlyID0gYXdhaXQgZ2xvYmFsVGhpcy5uYXZpZ2F0b3Iuc3RvcmFnZS5nZXREaXJlY3RvcnkoKTsKICAgICAgZm9yIChjb25zdCBwYXJ0IG9mIHBhdGhQYXJ0cykgewogICAgICAgIGRpciA9IGF3YWl0IGRpci5nZXREaXJlY3RvcnlIYW5kbGUocGFydCwgeyBjcmVhdGU6IGZhbHNlIH0pOwogICAgICB9CiAgICAgIHRyeSB7CiAgICAgICAgYXdhaXQgZGlyLnJlbW92ZUVudHJ5KGZpbGVuYW1lLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGlmIChlLm5hbWUgPT09ICJUeXBlRXJyb3IiIHx8IGUubWVzc2FnZT8uaW5jbHVkZXMoInJlY3Vyc2l2ZSIpKSB7CiAgICAgICAgICBhd2FpdCBkaXIucmVtb3ZlRW50cnkoZmlsZW5hbWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyBlOwogICAgICAgIH0KICAgICAgfQogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGVycm9yLm5hbWUgIT09ICJOb3RGb3VuZEVycm9yIiAmJiBlcnJvci5jb2RlICE9PSAiRU5PRU5UIikgewogICAgICAgIHRocm93IGVycm9yOwogICAgICB9CiAgICB9CiAgICB0aGlzLmRvY3VtZW50cyA9IG51bGw7CiAgICB0aGlzLmluZGV4ZXMuY2xlYXIoKTsKICAgIHRoaXMuX2luaXRpYWxpemVkID0gZmFsc2U7CiAgICB0aGlzLmRiLmNvbGxlY3Rpb25zLmRlbGV0ZSh0aGlzLm5hbWUpOwogICAgdGhpcy5lbWl0KCJkcm9wIiwgeyBjb2xsZWN0aW9uOiB0aGlzLm5hbWUgfSk7CiAgICByZXR1cm4geyBvazogMSB9OwogIH0KICBhc3luYyBkcm9wSW5kZXgoaW5kZXhOYW1lKSB7CiAgICBpZiAoIXRoaXMuaW5kZXhlcy5oYXMoaW5kZXhOYW1lKSkgewogICAgICB0aHJvdyBuZXcgSW5kZXhOb3RGb3VuZEVycm9yKGluZGV4TmFtZSwgeyBjb2xsZWN0aW9uOiB0aGlzLm5hbWUgfSk7CiAgICB9CiAgICBjb25zdCBpbmRleCA9IHRoaXMuaW5kZXhlcy5nZXQoaW5kZXhOYW1lKTsKICAgIGlmIChpbmRleCAmJiB0eXBlb2YgaW5kZXguY2xlYXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgYXdhaXQgaW5kZXguY2xlYXIoKTsKICAgIH0KICAgIGlmIChpbmRleCAmJiB0eXBlb2YgaW5kZXguY2xvc2UgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgYXdhaXQgaW5kZXguY2xvc2UoKTsKICAgIH0KICAgIHRoaXMuaW5kZXhlcy5kZWxldGUoaW5kZXhOYW1lKTsKICAgIHJldHVybiB7IG5JbmRleGVzV2FzOiB0aGlzLmluZGV4ZXMuc2l6ZSArIDEsIG9rOiAxIH07CiAgfQogIGFzeW5jIGRyb3BJbmRleGVzKCkgewogICAgY29uc3QgY291bnQgPSB0aGlzLmluZGV4ZXMuc2l6ZTsKICAgIGZvciAoY29uc3QgW18sIGluZGV4XSBvZiB0aGlzLmluZGV4ZXMpIHsKICAgICAgaWYgKGluZGV4ICYmIHR5cGVvZiBpbmRleC5jbGVhciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIGF3YWl0IGluZGV4LmNsZWFyKCk7CiAgICAgIH0KICAgICAgaWYgKGluZGV4ICYmIHR5cGVvZiBpbmRleC5jbG9zZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIGF3YWl0IGluZGV4LmNsb3NlKCk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuaW5kZXhlcy5jbGVhcigpOwogICAgcmV0dXJuIHsgbkluZGV4ZXNXYXM6IGNvdW50LCBtc2c6ICJub24tX2lkIGluZGV4ZXMgZHJvcHBlZCIsIG9rOiAxIH07CiAgfQogIGVuc3VyZUluZGV4KCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoImVuc3VyZUluZGV4IiwgeyBjb2xsZWN0aW9uOiB0aGlzLm5hbWUgfSk7CiAgfQogIGV4cGxhaW4oKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigiZXhwbGFpbiIsIHsgY29sbGVjdGlvbjogdGhpcy5uYW1lIH0pOwogIH0KICBmaW5kKHF1ZXJ5LCBwcm9qZWN0aW9uKSB7CiAgICB0aGlzLl92YWxpZGF0ZVByb2plY3Rpb24ocHJvamVjdGlvbik7CiAgICBjb25zdCBkb2N1bWVudHNQcm9taXNlID0gdGhpcy5fZmluZEludGVybmFsKHF1ZXJ5LCBwcm9qZWN0aW9uKTsKICAgIHJldHVybiBuZXcgQ3Vyc29yKAogICAgICB0aGlzLAogICAgICBxdWVyeSwKICAgICAgcHJvamVjdGlvbiwKICAgICAgZG9jdW1lbnRzUHJvbWlzZSwKICAgICAgU29ydGVkQ3Vyc29yCiAgICApOwogIH0KICBfdmFsaWRhdGVQcm9qZWN0aW9uKHByb2plY3Rpb24pIHsKICAgIGlmICghcHJvamVjdGlvbiB8fCBPYmplY3Qua2V5cyhwcm9qZWN0aW9uKS5sZW5ndGggPT09IDApIHJldHVybjsKICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhwcm9qZWN0aW9uKTsKICAgIGxldCBoYXNJbmNsdXNpb24gPSBmYWxzZTsKICAgIGxldCBoYXNFeGNsdXNpb24gPSBmYWxzZTsKICAgIGZvciAoY29uc3Qga2V5IG9mIGtleXMpIHsKICAgICAgaWYgKGtleSA9PT0gIl9pZCIpIGNvbnRpbnVlOwogICAgICBpZiAocHJvamVjdGlvbltrZXldKSBoYXNJbmNsdXNpb24gPSB0cnVlOwogICAgICBlbHNlIGhhc0V4Y2x1c2lvbiA9IHRydWU7CiAgICAgIGlmIChoYXNJbmNsdXNpb24gJiYgaGFzRXhjbHVzaW9uKSBicmVhazsKICAgIH0KICAgIGlmIChoYXNJbmNsdXNpb24gJiYgaGFzRXhjbHVzaW9uKSB7CiAgICAgIHRocm93IG5ldyBRdWVyeUVycm9yKCJDYW5ub3QgZG8gZXhjbHVzaW9uIG9uIGZpZWxkIGluIGluY2x1c2lvbiBwcm9qZWN0aW9uIiwgewogICAgICAgIGNvZGU6IEVycm9yQ29kZXMuQ0FOTk9UX0RPX0VYQ0xVU0lPTl9PTl9GSUVMRF9JRF9JTl9JTkNMVVNJT05fUFJPSkVDVElPTiwKICAgICAgICBjb2xsZWN0aW9uOiB0aGlzLm5hbWUKICAgICAgfSk7CiAgICB9CiAgfQogIGFzeW5jIF9maW5kSW50ZXJuYWwocXVlcnksIHByb2plY3Rpb24pIHsKICAgIGlmICghdGhpcy5faW5pdGlhbGl6ZWQpIGF3YWl0IHRoaXMuX2luaXRpYWxpemUoKTsKICAgIGNvbnN0IG5vcm1hbGl6ZWRRdWVyeSA9IHF1ZXJ5ID09IHZvaWQgMCA/IHt9IDogcXVlcnk7CiAgICBjb25zdCBuZWFyU3BlYyA9IHRoaXMuX2V4dHJhY3ROZWFyU3BlYyhub3JtYWxpemVkUXVlcnkpOwogICAgY29uc3QgZG9jdW1lbnRzID0gW107CiAgICBjb25zdCBzZWVuID0ge307CiAgICBpZiAodGhpcy5pbmRleGVzLnNpemUgPiAwKSB7CiAgICAgIGNvbnN0IHF1ZXJ5UGxhbiA9IGF3YWl0IHRoaXMucGxhblF1ZXJ5QXN5bmMobm9ybWFsaXplZFF1ZXJ5KTsKICAgICAgaWYgKHF1ZXJ5UGxhbi51c2VJbmRleCAmJiBxdWVyeVBsYW4uZG9jSWRzICYmIHF1ZXJ5UGxhbi5kb2NJZHMubGVuZ3RoID4gMCkgewogICAgICAgIGZvciAoY29uc3QgZG9jSWQgb2YgcXVlcnlQbGFuLmRvY0lkcykgewogICAgICAgICAgaWYgKCFzZWVuW2RvY0lkXSkgewogICAgICAgICAgICBjb25zdCBkb2MgPSBhd2FpdCB0aGlzLmRvY3VtZW50cy5zZWFyY2goZG9jSWQpOwogICAgICAgICAgICBpZiAoZG9jICYmIG1hdGNoZXMoZG9jLCBub3JtYWxpemVkUXVlcnkpKSB7CiAgICAgICAgICAgICAgc2Vlbltkb2NJZF0gPSB0cnVlOwogICAgICAgICAgICAgIGRvY3VtZW50cy5wdXNoKGRvYyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yIGF3YWl0IChjb25zdCBlbnRyeSBvZiB0aGlzLmRvY3VtZW50cykgewogICAgICAgICAgaWYgKGVudHJ5ICYmIGVudHJ5LnZhbHVlICYmICFzZWVuW2VudHJ5LnZhbHVlLl9pZF0gJiYgbWF0Y2hlcyhlbnRyeS52YWx1ZSwgbm9ybWFsaXplZFF1ZXJ5KSkgewogICAgICAgICAgICBzZWVuW2VudHJ5LnZhbHVlLl9pZF0gPSB0cnVlOwogICAgICAgICAgICBkb2N1bWVudHMucHVzaChlbnRyeS52YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBmb3IgYXdhaXQgKGNvbnN0IGVudHJ5IG9mIHRoaXMuZG9jdW1lbnRzKSB7CiAgICAgICAgaWYgKGVudHJ5ICYmIGVudHJ5LnZhbHVlICYmICFzZWVuW2VudHJ5LnZhbHVlLl9pZF0gJiYgbWF0Y2hlcyhlbnRyeS52YWx1ZSwgbm9ybWFsaXplZFF1ZXJ5KSkgewogICAgICAgICAgc2VlbltlbnRyeS52YWx1ZS5faWRdID0gdHJ1ZTsKICAgICAgICAgIGRvY3VtZW50cy5wdXNoKGVudHJ5LnZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGlmIChuZWFyU3BlYykgewogICAgICB0aGlzLl9zb3J0QnlOZWFyRGlzdGFuY2UoZG9jdW1lbnRzLCBuZWFyU3BlYyk7CiAgICB9CiAgICByZXR1cm4gZG9jdW1lbnRzOwogIH0KICBfZXh0cmFjdE5lYXJTcGVjKHF1ZXJ5KSB7CiAgICBmb3IgKGNvbnN0IGZpZWxkIG9mIE9iamVjdC5rZXlzKHF1ZXJ5IHx8IHt9KSkgewogICAgICBpZiAoZmllbGQuc3RhcnRzV2l0aCgiJCIpKSBjb250aW51ZTsKICAgICAgY29uc3QgdmFsdWUgPSBxdWVyeVtmaWVsZF07CiAgICAgIGlmICghdmFsdWUgfHwgdHlwZW9mIHZhbHVlICE9PSAib2JqZWN0IikgY29udGludWU7CiAgICAgIGlmICh2YWx1ZS4kbmVhcikgewogICAgICAgIGNvbnN0IGNvb3JkcyA9IHRoaXMuX3BhcnNlTmVhckNvb3JkaW5hdGVzKHZhbHVlLiRuZWFyKTsKICAgICAgICBpZiAoY29vcmRzKSByZXR1cm4geyBmaWVsZCwgLi4uY29vcmRzIH07CiAgICAgIH0KICAgICAgaWYgKHZhbHVlLiRuZWFyU3BoZXJlKSB7CiAgICAgICAgY29uc3QgY29vcmRzID0gdGhpcy5fcGFyc2VOZWFyQ29vcmRpbmF0ZXModmFsdWUuJG5lYXJTcGhlcmUpOwogICAgICAgIGlmIChjb29yZHMpIHJldHVybiB7IGZpZWxkLCAuLi5jb29yZHMgfTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfQogIF9wYXJzZU5lYXJDb29yZGluYXRlcyhzcGVjKSB7CiAgICBsZXQgY29vcmRpbmF0ZXM7CiAgICBpZiAoc3BlYyAmJiB0eXBlb2Ygc3BlYyA9PT0gIm9iamVjdCIpIHsKICAgICAgaWYgKHNwZWMuJGdlb21ldHJ5ICYmIHNwZWMuJGdlb21ldHJ5LmNvb3JkaW5hdGVzKSB7CiAgICAgICAgY29vcmRpbmF0ZXMgPSBzcGVjLiRnZW9tZXRyeS5jb29yZGluYXRlczsKICAgICAgfSBlbHNlIGlmIChzcGVjLmNvb3JkaW5hdGVzKSB7CiAgICAgICAgY29vcmRpbmF0ZXMgPSBzcGVjLmNvb3JkaW5hdGVzOwogICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoc3BlYykpIHsKICAgICAgICBjb29yZGluYXRlcyA9IHNwZWM7CiAgICAgIH0KICAgIH0KICAgIGlmICghY29vcmRpbmF0ZXMgfHwgY29vcmRpbmF0ZXMubGVuZ3RoIDwgMikgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGNvbnN0IFtsbmcsIGxhdF0gPSBjb29yZGluYXRlczsKICAgIGlmICh0eXBlb2YgbGF0ICE9PSAibnVtYmVyIiB8fCB0eXBlb2YgbG5nICE9PSAibnVtYmVyIikgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIHJldHVybiB7IGxhdCwgbG5nIH07CiAgfQogIF9leHRyYWN0UG9pbnRDb29yZGluYXRlcyh2YWx1ZSkgewogICAgaWYgKCF2YWx1ZSkgcmV0dXJuIG51bGw7CiAgICBpZiAodmFsdWUudHlwZSA9PT0gIkZlYXR1cmVDb2xsZWN0aW9uIiAmJiBBcnJheS5pc0FycmF5KHZhbHVlLmZlYXR1cmVzKSAmJiB2YWx1ZS5mZWF0dXJlcy5sZW5ndGggPiAwKSB7CiAgICAgIHJldHVybiB0aGlzLl9leHRyYWN0UG9pbnRDb29yZGluYXRlcyh2YWx1ZS5mZWF0dXJlc1swXS5nZW9tZXRyeSk7CiAgICB9CiAgICBpZiAodmFsdWUudHlwZSA9PT0gIkZlYXR1cmUiICYmIHZhbHVlLmdlb21ldHJ5KSB7CiAgICAgIHJldHVybiB0aGlzLl9leHRyYWN0UG9pbnRDb29yZGluYXRlcyh2YWx1ZS5nZW9tZXRyeSk7CiAgICB9CiAgICBpZiAodmFsdWUudHlwZSA9PT0gIlBvaW50IiAmJiBBcnJheS5pc0FycmF5KHZhbHVlLmNvb3JkaW5hdGVzKSAmJiB2YWx1ZS5jb29yZGluYXRlcy5sZW5ndGggPj0gMikgewogICAgICBjb25zdCBbbG5nLCBsYXRdID0gdmFsdWUuY29vcmRpbmF0ZXM7CiAgICAgIGlmICh0eXBlb2YgbGF0ID09PSAibnVtYmVyIiAmJiB0eXBlb2YgbG5nID09PSAibnVtYmVyIikgewogICAgICAgIHJldHVybiB7IGxhdCwgbG5nIH07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBudWxsOwogIH0KICBfc29ydEJ5TmVhckRpc3RhbmNlKGRvY3VtZW50cywgbmVhclNwZWMpIHsKICAgIGNvbnN0IHsgZmllbGQsIGxhdDogdGFyZ2V0TGF0LCBsbmc6IHRhcmdldExuZyB9ID0gbmVhclNwZWM7CiAgICBkb2N1bWVudHMuc29ydCgoYSwgYikgPT4gewogICAgICBjb25zdCBhUG9pbnQgPSB0aGlzLl9leHRyYWN0UG9pbnRDb29yZGluYXRlcyhnZXRQcm9wKGEsIGZpZWxkKSk7CiAgICAgIGNvbnN0IGJQb2ludCA9IHRoaXMuX2V4dHJhY3RQb2ludENvb3JkaW5hdGVzKGdldFByb3AoYiwgZmllbGQpKTsKICAgICAgY29uc3QgYURpc3QgPSBhUG9pbnQgPyB0aGlzLl9oYXZlcnNpbmVEaXN0YW5jZShhUG9pbnQubGF0LCBhUG9pbnQubG5nLCB0YXJnZXRMYXQsIHRhcmdldExuZykgOiBJbmZpbml0eTsKICAgICAgY29uc3QgYkRpc3QgPSBiUG9pbnQgPyB0aGlzLl9oYXZlcnNpbmVEaXN0YW5jZShiUG9pbnQubGF0LCBiUG9pbnQubG5nLCB0YXJnZXRMYXQsIHRhcmdldExuZykgOiBJbmZpbml0eTsKICAgICAgcmV0dXJuIGFEaXN0IC0gYkRpc3Q7CiAgICB9KTsKICB9CiAgX2hhdmVyc2luZURpc3RhbmNlKGxhdDEsIGxuZzEsIGxhdDIsIGxuZzIpIHsKICAgIGNvbnN0IFIgPSA2MzcxOwogICAgY29uc3QgZExhdCA9IChsYXQyIC0gbGF0MSkgKiBNYXRoLlBJIC8gMTgwOwogICAgY29uc3QgZExuZyA9IChsbmcyIC0gbG5nMSkgKiBNYXRoLlBJIC8gMTgwOwogICAgY29uc3QgYSA9IE1hdGguc2luKGRMYXQgLyAyKSAqIE1hdGguc2luKGRMYXQgLyAyKSArIE1hdGguY29zKGxhdDEgKiBNYXRoLlBJIC8gMTgwKSAqIE1hdGguY29zKGxhdDIgKiBNYXRoLlBJIC8gMTgwKSAqIE1hdGguc2luKGRMbmcgLyAyKSAqIE1hdGguc2luKGRMbmcgLyAyKTsKICAgIGNvbnN0IGMgPSAyICogTWF0aC5hdGFuMihNYXRoLnNxcnQoYSksIE1hdGguc3FydCgxIC0gYSkpOwogICAgcmV0dXJuIFIgKiBjOwogIH0KICBmaW5kQW5kTW9kaWZ5KCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoImZpbmRBbmRNb2RpZnkiLCB7IGNvbGxlY3Rpb246IHRoaXMubmFtZSB9KTsKICB9CiAgYXN5bmMgZmluZE9uZShxdWVyeSwgcHJvamVjdGlvbikgewogICAgY29uc3QgY3Vyc29yID0gdGhpcy5maW5kKHF1ZXJ5LCBwcm9qZWN0aW9uKTsKICAgIGF3YWl0IGN1cnNvci5fZW5zdXJlSW5pdGlhbGl6ZWQoKTsKICAgIGlmIChhd2FpdCBjdXJzb3IuaGFzTmV4dCgpKSB7CiAgICAgIHJldHVybiBhd2FpdCBjdXJzb3IubmV4dCgpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgfQogIGFzeW5jIGZpbmRPbmVBbmREZWxldGUoZmlsdGVyLCBvcHRpb25zKSB7CiAgICBsZXQgYyA9IHRoaXMuZmluZChmaWx0ZXIpOwogICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5zb3J0KSB7CiAgICAgIGMgPSBjLnNvcnQob3B0aW9ucy5zb3J0KTsKICAgICAgYXdhaXQgYy5fZW5zdXJlSW5pdGlhbGl6ZWQoKTsKICAgIH0gZWxzZSB7CiAgICAgIGF3YWl0IGMuX2Vuc3VyZUluaXRpYWxpemVkKCk7CiAgICB9CiAgICBpZiAoIWF3YWl0IGMuaGFzTmV4dCgpKSByZXR1cm4gbnVsbDsKICAgIGNvbnN0IGRvYyA9IGF3YWl0IGMubmV4dCgpOwogICAgYXdhaXQgdGhpcy5kb2N1bWVudHMuZGVsZXRlKGRvYy5faWQudG9TdHJpbmcoKSk7CiAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnByb2plY3Rpb24pIHJldHVybiBhcHBseVByb2plY3Rpb24ob3B0aW9ucy5wcm9qZWN0aW9uLCBkb2MpOwogICAgZWxzZSByZXR1cm4gZG9jOwogIH0KICBhc3luYyBmaW5kT25lQW5kUmVwbGFjZShmaWx0ZXIsIHJlcGxhY2VtZW50LCBvcHRpb25zKSB7CiAgICBsZXQgYyA9IHRoaXMuZmluZChmaWx0ZXIpOwogICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5zb3J0KSB7CiAgICAgIGMgPSBjLnNvcnQob3B0aW9ucy5zb3J0KTsKICAgICAgYXdhaXQgYy5fZW5zdXJlSW5pdGlhbGl6ZWQoKTsKICAgIH0gZWxzZSB7CiAgICAgIGF3YWl0IGMuX2Vuc3VyZUluaXRpYWxpemVkKCk7CiAgICB9CiAgICBpZiAoIWF3YWl0IGMuaGFzTmV4dCgpKSByZXR1cm4gbnVsbDsKICAgIGNvbnN0IGRvYyA9IGF3YWl0IGMubmV4dCgpOwogICAgcmVwbGFjZW1lbnQuX2lkID0gZG9jLl9pZDsKICAgIGF3YWl0IHRoaXMuZG9jdW1lbnRzLmFkZChkb2MuX2lkLnRvU3RyaW5nKCksIHJlcGxhY2VtZW50KTsKICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMucmV0dXJuTmV3RG9jdW1lbnQpIHsKICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5wcm9qZWN0aW9uKSByZXR1cm4gYXBwbHlQcm9qZWN0aW9uKG9wdGlvbnMucHJvamVjdGlvbiwgcmVwbGFjZW1lbnQpOwogICAgICBlbHNlIHJldHVybiByZXBsYWNlbWVudDsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMucHJvamVjdGlvbikgcmV0dXJuIGFwcGx5UHJvamVjdGlvbihvcHRpb25zLnByb2plY3Rpb24sIGRvYyk7CiAgICAgIGVsc2UgcmV0dXJuIGRvYzsKICAgIH0KICB9CiAgYXN5bmMgZmluZE9uZUFuZFVwZGF0ZShmaWx0ZXIsIHVwZGF0ZSwgb3B0aW9ucykgewogICAgbGV0IGMgPSB0aGlzLmZpbmQoZmlsdGVyKTsKICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuc29ydCkgewogICAgICBjID0gYy5zb3J0KG9wdGlvbnMuc29ydCk7CiAgICAgIGF3YWl0IGMuX2Vuc3VyZUluaXRpYWxpemVkKCk7CiAgICB9IGVsc2UgewogICAgICBhd2FpdCBjLl9lbnN1cmVJbml0aWFsaXplZCgpOwogICAgfQogICAgaWYgKCFhd2FpdCBjLmhhc05leHQoKSkgcmV0dXJuIG51bGw7CiAgICBjb25zdCBkb2MgPSBhd2FpdCBjLm5leHQoKTsKICAgIGNvbnN0IGNsb25lID0gT2JqZWN0LmFzc2lnbih7fSwgZG9jKTsKICAgIGNvbnN0IG1hdGNoSW5mbyA9IG1hdGNoV2l0aEFycmF5SW5kaWNlcyhkb2MsIGZpbHRlcik7CiAgICBjb25zdCBwb3NpdGlvbmFsTWF0Y2hJbmZvID0gbWF0Y2hJbmZvLmFycmF5RmlsdGVyczsKICAgIGNvbnN0IHVzZXJBcnJheUZpbHRlcnMgPSBvcHRpb25zICYmIG9wdGlvbnMuYXJyYXlGaWx0ZXJzOwogICAgYXBwbHlVcGRhdGVzKHVwZGF0ZSwgY2xvbmUsIGZhbHNlLCBwb3NpdGlvbmFsTWF0Y2hJbmZvLCB1c2VyQXJyYXlGaWx0ZXJzKTsKICAgIGF3YWl0IHRoaXMuZG9jdW1lbnRzLmFkZChkb2MuX2lkLnRvU3RyaW5nKCksIGNsb25lKTsKICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMucmV0dXJuTmV3RG9jdW1lbnQpIHsKICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5wcm9qZWN0aW9uKSByZXR1cm4gYXBwbHlQcm9qZWN0aW9uKG9wdGlvbnMucHJvamVjdGlvbiwgY2xvbmUpOwogICAgICBlbHNlIHJldHVybiBjbG9uZTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMucHJvamVjdGlvbikgcmV0dXJuIGFwcGx5UHJvamVjdGlvbihvcHRpb25zLnByb2plY3Rpb24sIGRvYyk7CiAgICAgIGVsc2UgcmV0dXJuIGRvYzsKICAgIH0KICB9CiAgZ2V0SW5kZXhlcygpIHsKICAgIGNvbnN0IHJlc3VsdCA9IFtdOwogICAgZm9yIChjb25zdCBbaW5kZXhOYW1lLCBpbmRleF0gb2YgdGhpcy5pbmRleGVzKSB7CiAgICAgIHJlc3VsdC5wdXNoKGluZGV4LmdldFNwZWMoKSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBnZXRTaGFyZERpc3RyaWJ1dGlvbigpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJnZXRTaGFyZERpc3RyaWJ1dGlvbiIsIHsgY29sbGVjdGlvbjogdGhpcy5uYW1lIH0pOwogIH0KICBnZXRTaGFyZFZlcnNpb24oKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigiZ2V0U2hhcmRWZXJzaW9uIiwgeyBjb2xsZWN0aW9uOiB0aGlzLm5hbWUgfSk7CiAgfQogIC8vIG5vbi1tb25nbwogIGdldFN0b3JlKCkgewogICAgcmV0dXJuIHRoaXMuZG9jdW1lbnRzOwogIH0KICBncm91cCgpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJncm91cCIsIHsgY29sbGVjdGlvbjogdGhpcy5uYW1lIH0pOwogIH0KICBhc3luYyBpbnNlcnQoZG9jKSB7CiAgICBpZiAoQXJyYXkgPT0gZG9jLmNvbnN0cnVjdG9yKSB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmluc2VydE1hbnkoZG9jKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmluc2VydE9uZShkb2MpOwogICAgfQogIH0KICBhc3luYyBpbnNlcnRPbmUoZG9jKSB7CiAgICBpZiAoIXRoaXMuX2luaXRpYWxpemVkKSBhd2FpdCB0aGlzLl9pbml0aWFsaXplKCk7CiAgICBpZiAoZG9jLl9pZCA9PSB2b2lkIDApIGRvYy5faWQgPSBuZXcgT2JqZWN0SWQoKTsKICAgIGF3YWl0IHRoaXMuZG9jdW1lbnRzLmFkZChkb2MuX2lkLnRvU3RyaW5nKCksIGRvYyk7CiAgICBhd2FpdCB0aGlzLnVwZGF0ZUluZGV4ZXNPbkluc2VydChkb2MpOwogICAgdGhpcy5lbWl0KCJpbnNlcnQiLCBkb2MpOwogICAgcmV0dXJuIHsgaW5zZXJ0ZWRJZDogZG9jLl9pZCB9OwogIH0KICBhc3luYyBpbnNlcnRNYW55KGRvY3MpIHsKICAgIGlmICghdGhpcy5faW5pdGlhbGl6ZWQpIGF3YWl0IHRoaXMuX2luaXRpYWxpemUoKTsKICAgIGNvbnN0IGluc2VydGVkSWRzID0gW107CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRvY3MubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5pbnNlcnRPbmUoZG9jc1tpXSk7CiAgICAgIGluc2VydGVkSWRzLnB1c2gocmVzdWx0Lmluc2VydGVkSWQpOwogICAgfQogICAgcmV0dXJuIHsgaW5zZXJ0ZWRJZHMgfTsKICB9CiAgaXNDYXBwZWQoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigiaXNDYXBwZWQiLCB7IGNvbGxlY3Rpb246IHRoaXMubmFtZSB9KTsKICB9CiAgbWFwUmVkdWNlKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoIm1hcFJlZHVjZSIsIHsgY29sbGVjdGlvbjogdGhpcy5uYW1lIH0pOwogIH0KICByZUluZGV4KCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoInJlSW5kZXgiLCB7IGNvbGxlY3Rpb246IHRoaXMubmFtZSB9KTsKICB9CiAgYXN5bmMgcmVwbGFjZU9uZShxdWVyeSwgcmVwbGFjZW1lbnQsIG9wdGlvbnMpIHsKICAgIGNvbnN0IHJlc3VsdCA9IHt9OwogICAgY29uc3QgYyA9IHRoaXMuZmluZChxdWVyeSk7CiAgICBhd2FpdCBjLl9lbnN1cmVJbml0aWFsaXplZCgpOwogICAgcmVzdWx0Lm1hdGNoZWRDb3VudCA9IGF3YWl0IGMuY291bnQoKTsKICAgIGlmIChyZXN1bHQubWF0Y2hlZENvdW50ID09IDApIHsKICAgICAgcmVzdWx0Lm1vZGlmaWVkQ291bnQgPSAwOwogICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnVwc2VydCkgewogICAgICAgIGNvbnN0IG5ld0RvYyA9IHJlcGxhY2VtZW50OwogICAgICAgIG5ld0RvYy5faWQgPSBuZXcgT2JqZWN0SWQoKTsKICAgICAgICBhd2FpdCB0aGlzLmRvY3VtZW50cy5hZGQobmV3RG9jLl9pZC50b1N0cmluZygpLCBuZXdEb2MpOwogICAgICAgIGF3YWl0IHRoaXMudXBkYXRlSW5kZXhlc09uSW5zZXJ0KG5ld0RvYyk7CiAgICAgICAgdGhpcy5lbWl0KCJpbnNlcnQiLCBuZXdEb2MpOwogICAgICAgIHJlc3VsdC51cHNlcnRlZElkID0gbmV3RG9jLl9pZDsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgcmVzdWx0Lm1vZGlmaWVkQ291bnQgPSAxOwogICAgICBjb25zdCBkb2MgPSBhd2FpdCBjLm5leHQoKTsKICAgICAgYXdhaXQgdGhpcy51cGRhdGVJbmRleGVzT25EZWxldGUoZG9jKTsKICAgICAgcmVwbGFjZW1lbnQuX2lkID0gZG9jLl9pZDsKICAgICAgdGhpcy5kb2N1bWVudHMuYWRkKGRvYy5faWQudG9TdHJpbmcoKSwgcmVwbGFjZW1lbnQpOwogICAgICBhd2FpdCB0aGlzLnVwZGF0ZUluZGV4ZXNPbkluc2VydChyZXBsYWNlbWVudCk7CiAgICAgIHRoaXMuZW1pdCgicmVwbGFjZSIsIHJlcGxhY2VtZW50KTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGFzeW5jIHJlbW92ZShxdWVyeSwgb3B0aW9ucykgewogICAgY29uc3QgYyA9IHRoaXMuZmluZChxdWVyeSk7CiAgICBhd2FpdCBjLl9lbnN1cmVJbml0aWFsaXplZCgpOwogICAgaWYgKCFhd2FpdCBjLmhhc05leHQoKSkgcmV0dXJuOwogICAgaWYgKG9wdGlvbnMgPT09IHRydWUgfHwgb3B0aW9ucyAmJiBvcHRpb25zLmp1c3RPbmUpIHsKICAgICAgY29uc3QgZG9jID0gYXdhaXQgYy5uZXh0KCk7CiAgICAgIGF3YWl0IHRoaXMudXBkYXRlSW5kZXhlc09uRGVsZXRlKGRvYyk7CiAgICAgIHRoaXMuZG9jdW1lbnRzLmRlbGV0ZShkb2MuX2lkLnRvU3RyaW5nKCkpOwogICAgfSBlbHNlIHsKICAgICAgd2hpbGUgKGF3YWl0IGMuaGFzTmV4dCgpKSB7CiAgICAgICAgY29uc3QgZG9jID0gYXdhaXQgYy5uZXh0KCk7CiAgICAgICAgYXdhaXQgdGhpcy51cGRhdGVJbmRleGVzT25EZWxldGUoZG9jKTsKICAgICAgICB0aGlzLmRvY3VtZW50cy5kZWxldGUoZG9jLl9pZC50b1N0cmluZygpKTsKICAgICAgfQogICAgfQogIH0KICByZW5hbWVDb2xsZWN0aW9uKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoInJlbmFtZUNvbGxlY3Rpb24iLCB7IGNvbGxlY3Rpb246IHRoaXMubmFtZSB9KTsKICB9CiAgc2F2ZSgpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJzYXZlIiwgeyBjb2xsZWN0aW9uOiB0aGlzLm5hbWUgfSk7CiAgfQogIHN0YXRzKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoInN0YXRzIiwgeyBjb2xsZWN0aW9uOiB0aGlzLm5hbWUgfSk7CiAgfQogIHN0b3JhZ2VTaXplKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoInN0b3JhZ2VTaXplIiwgeyBjb2xsZWN0aW9uOiB0aGlzLm5hbWUgfSk7CiAgfQogIHRvdGFsU2l6ZSgpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJ0b3RhbFNpemUiLCB7IGNvbGxlY3Rpb246IHRoaXMubmFtZSB9KTsKICB9CiAgdG90YWxJbmRleFNpemUoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigidG90YWxJbmRleFNpemUiLCB7IGNvbGxlY3Rpb246IHRoaXMubmFtZSB9KTsKICB9CiAgYXN5bmMgdXBkYXRlKHF1ZXJ5LCB1cGRhdGVzLCBvcHRpb25zKSB7CiAgICBjb25zdCBjID0gdGhpcy5maW5kKHF1ZXJ5KTsKICAgIGF3YWl0IGMuX2Vuc3VyZUluaXRpYWxpemVkKCk7CiAgICBpZiAoYXdhaXQgYy5oYXNOZXh0KCkpIHsKICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5tdWx0aSkgewogICAgICAgIHdoaWxlIChhd2FpdCBjLmhhc05leHQoKSkgewogICAgICAgICAgY29uc3QgZG9jID0gYXdhaXQgYy5uZXh0KCk7CiAgICAgICAgICBjb25zdCBtYXRjaEluZm8gPSBtYXRjaFdpdGhBcnJheUluZGljZXMoZG9jLCBxdWVyeSk7CiAgICAgICAgICBjb25zdCBwb3NpdGlvbmFsTWF0Y2hJbmZvID0gbWF0Y2hJbmZvLmFycmF5RmlsdGVyczsKICAgICAgICAgIGNvbnN0IHVzZXJBcnJheUZpbHRlcnMgPSBvcHRpb25zICYmIG9wdGlvbnMuYXJyYXlGaWx0ZXJzOwogICAgICAgICAgYXdhaXQgdGhpcy51cGRhdGVJbmRleGVzT25EZWxldGUoZG9jKTsKICAgICAgICAgIGFwcGx5VXBkYXRlcyh1cGRhdGVzLCBkb2MsIGZhbHNlLCBwb3NpdGlvbmFsTWF0Y2hJbmZvLCB1c2VyQXJyYXlGaWx0ZXJzKTsKICAgICAgICAgIGF3YWl0IHRoaXMuZG9jdW1lbnRzLmFkZChkb2MuX2lkLnRvU3RyaW5nKCksIGRvYyk7CiAgICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZUluZGV4ZXNPbkluc2VydChkb2MpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBkb2MgPSBhd2FpdCBjLm5leHQoKTsKICAgICAgICBjb25zdCBtYXRjaEluZm8gPSBtYXRjaFdpdGhBcnJheUluZGljZXMoZG9jLCBxdWVyeSk7CiAgICAgICAgY29uc3QgcG9zaXRpb25hbE1hdGNoSW5mbyA9IG1hdGNoSW5mby5hcnJheUZpbHRlcnM7CiAgICAgICAgY29uc3QgdXNlckFycmF5RmlsdGVycyA9IG9wdGlvbnMgJiYgb3B0aW9ucy5hcnJheUZpbHRlcnM7CiAgICAgICAgYXdhaXQgdGhpcy51cGRhdGVJbmRleGVzT25EZWxldGUoZG9jKTsKICAgICAgICBhcHBseVVwZGF0ZXModXBkYXRlcywgZG9jLCBmYWxzZSwgcG9zaXRpb25hbE1hdGNoSW5mbywgdXNlckFycmF5RmlsdGVycyk7CiAgICAgICAgYXdhaXQgdGhpcy5kb2N1bWVudHMuYWRkKGRvYy5faWQudG9TdHJpbmcoKSwgZG9jKTsKICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZUluZGV4ZXNPbkluc2VydChkb2MpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnVwc2VydCkgewogICAgICAgIGNvbnN0IG5ld0RvYyA9IGNyZWF0ZURvY0Zyb21VcGRhdGUocXVlcnksIHVwZGF0ZXMsIG5ldyBPYmplY3RJZCgpKTsKICAgICAgICBhd2FpdCB0aGlzLmRvY3VtZW50cy5hZGQobmV3RG9jLl9pZC50b1N0cmluZygpLCBuZXdEb2MpOwogICAgICAgIGF3YWl0IHRoaXMudXBkYXRlSW5kZXhlc09uSW5zZXJ0KG5ld0RvYyk7CiAgICAgIH0KICAgIH0KICB9CiAgYXN5bmMgdXBkYXRlT25lKHF1ZXJ5LCB1cGRhdGVzLCBvcHRpb25zKSB7CiAgICBjb25zdCBjID0gdGhpcy5maW5kKHF1ZXJ5KTsKICAgIGF3YWl0IGMuX2Vuc3VyZUluaXRpYWxpemVkKCk7CiAgICBpZiAoYXdhaXQgYy5oYXNOZXh0KCkpIHsKICAgICAgY29uc3QgZG9jID0gYXdhaXQgYy5uZXh0KCk7CiAgICAgIGNvbnN0IG9yaWdpbmFsRG9jID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShkb2MpKTsKICAgICAgY29uc3QgbWF0Y2hJbmZvID0gbWF0Y2hXaXRoQXJyYXlJbmRpY2VzKGRvYywgcXVlcnkpOwogICAgICBjb25zdCBwb3NpdGlvbmFsTWF0Y2hJbmZvID0gbWF0Y2hJbmZvLmFycmF5RmlsdGVyczsKICAgICAgY29uc3QgdXNlckFycmF5RmlsdGVycyA9IG9wdGlvbnMgJiYgb3B0aW9ucy5hcnJheUZpbHRlcnM7CiAgICAgIGF3YWl0IHRoaXMudXBkYXRlSW5kZXhlc09uRGVsZXRlKGRvYyk7CiAgICAgIGFwcGx5VXBkYXRlcyh1cGRhdGVzLCBkb2MsIGZhbHNlLCBwb3NpdGlvbmFsTWF0Y2hJbmZvLCB1c2VyQXJyYXlGaWx0ZXJzKTsKICAgICAgdGhpcy5kb2N1bWVudHMuYWRkKGRvYy5faWQudG9TdHJpbmcoKSwgZG9jKTsKICAgICAgYXdhaXQgdGhpcy51cGRhdGVJbmRleGVzT25JbnNlcnQoZG9jKTsKICAgICAgY29uc3QgdXBkYXRlRGVzY3JpcHRpb24gPSB0aGlzLl9nZXRVcGRhdGVEZXNjcmlwdGlvbihvcmlnaW5hbERvYywgZG9jKTsKICAgICAgdGhpcy5lbWl0KCJ1cGRhdGUiLCBkb2MsIHVwZGF0ZURlc2NyaXB0aW9uKTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMudXBzZXJ0KSB7CiAgICAgICAgY29uc3QgbmV3RG9jID0gY3JlYXRlRG9jRnJvbVVwZGF0ZShxdWVyeSwgdXBkYXRlcywgbmV3IE9iamVjdElkKCkpOwogICAgICAgIHRoaXMuZG9jdW1lbnRzLmFkZChuZXdEb2MuX2lkLnRvU3RyaW5nKCksIG5ld0RvYyk7CiAgICAgICAgYXdhaXQgdGhpcy51cGRhdGVJbmRleGVzT25JbnNlcnQobmV3RG9jKTsKICAgICAgICB0aGlzLmVtaXQoImluc2VydCIsIG5ld0RvYyk7CiAgICAgIH0KICAgIH0KICB9CiAgYXN5bmMgdXBkYXRlTWFueShxdWVyeSwgdXBkYXRlcywgb3B0aW9ucykgewogICAgY29uc3QgYyA9IHRoaXMuZmluZChxdWVyeSk7CiAgICBhd2FpdCBjLl9lbnN1cmVJbml0aWFsaXplZCgpOwogICAgaWYgKGF3YWl0IGMuaGFzTmV4dCgpKSB7CiAgICAgIHdoaWxlIChhd2FpdCBjLmhhc05leHQoKSkgewogICAgICAgIGNvbnN0IGRvYyA9IGF3YWl0IGMubmV4dCgpOwogICAgICAgIGNvbnN0IG9yaWdpbmFsRG9jID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShkb2MpKTsKICAgICAgICBjb25zdCBtYXRjaEluZm8gPSBtYXRjaFdpdGhBcnJheUluZGljZXMoZG9jLCBxdWVyeSk7CiAgICAgICAgY29uc3QgcG9zaXRpb25hbE1hdGNoSW5mbyA9IG1hdGNoSW5mby5hcnJheUZpbHRlcnM7CiAgICAgICAgY29uc3QgdXNlckFycmF5RmlsdGVycyA9IG9wdGlvbnMgJiYgb3B0aW9ucy5hcnJheUZpbHRlcnM7CiAgICAgICAgYXdhaXQgdGhpcy51cGRhdGVJbmRleGVzT25EZWxldGUoZG9jKTsKICAgICAgICBhcHBseVVwZGF0ZXModXBkYXRlcywgZG9jLCBmYWxzZSwgcG9zaXRpb25hbE1hdGNoSW5mbywgdXNlckFycmF5RmlsdGVycyk7CiAgICAgICAgdGhpcy5kb2N1bWVudHMuYWRkKGRvYy5faWQudG9TdHJpbmcoKSwgZG9jKTsKICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZUluZGV4ZXNPbkluc2VydChkb2MpOwogICAgICAgIGNvbnN0IHVwZGF0ZURlc2NyaXB0aW9uID0gdGhpcy5fZ2V0VXBkYXRlRGVzY3JpcHRpb24ob3JpZ2luYWxEb2MsIGRvYyk7CiAgICAgICAgdGhpcy5lbWl0KCJ1cGRhdGUiLCBkb2MsIHVwZGF0ZURlc2NyaXB0aW9uKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy51cHNlcnQpIHsKICAgICAgICBjb25zdCBuZXdEb2MgPSBjcmVhdGVEb2NGcm9tVXBkYXRlKHF1ZXJ5LCB1cGRhdGVzLCBuZXcgT2JqZWN0SWQoKSk7CiAgICAgICAgdGhpcy5kb2N1bWVudHMuYWRkKG5ld0RvYy5faWQudG9TdHJpbmcoKSwgbmV3RG9jKTsKICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZUluZGV4ZXNPbkluc2VydChuZXdEb2MpOwogICAgICAgIHRoaXMuZW1pdCgiaW5zZXJ0IiwgbmV3RG9jKTsKICAgICAgfQogICAgfQogIH0KICB2YWxpZGF0ZSgpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJ2YWxpZGF0ZSIsIHsgY29sbGVjdGlvbjogdGhpcy5uYW1lIH0pOwogIH0KICAvKioKICAgKiBHZW5lcmF0ZSB1cGRhdGVEZXNjcmlwdGlvbiBmb3IgY2hhbmdlIGV2ZW50cwogICAqIENvbXBhcmVzIG9yaWdpbmFsIGFuZCB1cGRhdGVkIGRvY3VtZW50cyB0byB0cmFjayBjaGFuZ2VzCiAgICovCiAgX2dldFVwZGF0ZURlc2NyaXB0aW9uKG9yaWdpbmFsRG9jLCB1cGRhdGVkRG9jKSB7CiAgICBjb25zdCB1cGRhdGVkRmllbGRzID0ge307CiAgICBjb25zdCByZW1vdmVkRmllbGRzID0gW107CiAgICBmb3IgKGNvbnN0IGtleSBpbiB1cGRhdGVkRG9jKSB7CiAgICAgIGlmIChrZXkgPT09ICJfaWQiKSBjb250aW51ZTsKICAgICAgaWYgKEpTT04uc3RyaW5naWZ5KG9yaWdpbmFsRG9jW2tleV0pICE9PSBKU09OLnN0cmluZ2lmeSh1cGRhdGVkRG9jW2tleV0pKSB7CiAgICAgICAgdXBkYXRlZEZpZWxkc1trZXldID0gdXBkYXRlZERvY1trZXldOwogICAgICB9CiAgICB9CiAgICBmb3IgKGNvbnN0IGtleSBpbiBvcmlnaW5hbERvYykgewogICAgICBpZiAoa2V5ID09PSAiX2lkIikgY29udGludWU7CiAgICAgIGlmICghKGtleSBpbiB1cGRhdGVkRG9jKSkgewogICAgICAgIHJlbW92ZWRGaWVsZHMucHVzaChrZXkpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gewogICAgICB1cGRhdGVkRmllbGRzLAogICAgICByZW1vdmVkRmllbGRzLAogICAgICB0cnVuY2F0ZWRBcnJheXM6IFtdCiAgICAgIC8vIE5vdCBpbXBsZW1lbnRlZCBpbiBtaWNyby1tb25nbwogICAgfTsKICB9CiAgLyoqCiAgICogV2F0Y2ggZm9yIGNoYW5nZXMgdG8gdGhpcyBjb2xsZWN0aW9uCiAgICogQHBhcmFtIHtBcnJheX0gcGlwZWxpbmUgLSBBZ2dyZWdhdGlvbiBwaXBlbGluZSB0byBmaWx0ZXIgY2hhbmdlcwogICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIC0gV2F0Y2ggb3B0aW9ucyAoZnVsbERvY3VtZW50LCBldGMuKQogICAqIEByZXR1cm5zIHtDaGFuZ2VTdHJlYW19IEEgY2hhbmdlIHN0cmVhbSBpbnN0YW5jZQogICAqLwogIHdhdGNoKHBpcGVsaW5lID0gW10sIG9wdGlvbnMgPSB7fSkgewogICAgcmV0dXJuIG5ldyBDaGFuZ2VTdHJlYW0odGhpcywgcGlwZWxpbmUsIG9wdGlvbnMpOwogIH0KfQpmdW5jdGlvbiBhcHBseVByb2plY3Rpb25XaXRoRXhwcmVzc2lvbnMocHJvamVjdGlvbiwgZG9jKSB7CiAgY29uc3QgcmVzdWx0ID0ge307CiAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHByb2plY3Rpb24pOwogIGxldCBpc0luY2x1c2lvbiA9IGZhbHNlOwogIGxldCBoYXNDb21wdXRlZEZpZWxkcyA9IGZhbHNlOwogIGZvciAoY29uc3Qga2V5IG9mIGtleXMpIHsKICAgIGlmIChrZXkgPT09ICJfaWQiKSBjb250aW51ZTsKICAgIGNvbnN0IHZhbHVlID0gcHJvamVjdGlvbltrZXldOwogICAgaWYgKHZhbHVlID09PSAxIHx8IHZhbHVlID09PSB0cnVlKSB7CiAgICAgIGlzSW5jbHVzaW9uID0gdHJ1ZTsKICAgIH0gZWxzZSBpZiAodmFsdWUgPT09IDAgfHwgdmFsdWUgPT09IGZhbHNlKSA7CiAgICBlbHNlIHsKICAgICAgaGFzQ29tcHV0ZWRGaWVsZHMgPSB0cnVlOwogICAgfQogIH0KICBpZiAoaGFzQ29tcHV0ZWRGaWVsZHMgfHwgaXNJbmNsdXNpb24pIHsKICAgIGlmIChwcm9qZWN0aW9uLl9pZCAhPT0gMCAmJiBwcm9qZWN0aW9uLl9pZCAhPT0gZmFsc2UpIHsKICAgICAgcmVzdWx0Ll9pZCA9IGRvYy5faWQ7CiAgICB9CiAgICBmb3IgKGNvbnN0IGtleSBvZiBrZXlzKSB7CiAgICAgIGNvbnN0IHZhbHVlID0gcHJvamVjdGlvbltrZXldOwogICAgICBpZiAoa2V5ID09PSAiX2lkIikgewogICAgICAgIGlmICh2YWx1ZSA9PT0gMCB8fCB2YWx1ZSA9PT0gZmFsc2UpIHsKICAgICAgICAgIGRlbGV0ZSByZXN1bHQuX2lkOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gMSB8fCB2YWx1ZSA9PT0gdHJ1ZSkgewogICAgICAgIHJlc3VsdFtrZXldID0gZ2V0UHJvcChkb2MsIGtleSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0W2tleV0gPSBldmFsdWF0ZUV4cHJlc3Npb24odmFsdWUsIGRvYyk7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgewogICAgZm9yIChjb25zdCBrZXkgaW4gZG9jKSB7CiAgICAgIGlmIChkb2MuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgIHJlc3VsdFtrZXldID0gZG9jW2tleV07CiAgICAgIH0KICAgIH0KICAgIGZvciAoY29uc3Qga2V5IG9mIGtleXMpIHsKICAgICAgaWYgKHByb2plY3Rpb25ba2V5XSA9PT0gMCB8fCBwcm9qZWN0aW9uW2tleV0gPT09IGZhbHNlKSB7CiAgICAgICAgZGVsZXRlIHJlc3VsdFtrZXldOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KY2xhc3MgREIgewogIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHsKICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB0aGlzLmJhc2VGb2xkZXIgPSB0aGlzLm9wdGlvbnMuYmFzZUZvbGRlciB8fCAibWljcm8tbW9uZ28iOwogICAgdGhpcy5kYk5hbWUgPSB0aGlzLm9wdGlvbnMuZGJOYW1lIHx8ICJkZWZhdWx0IjsKICAgIHRoaXMuZGJGb2xkZXIgPSBgJHt0aGlzLmJhc2VGb2xkZXJ9LyR7dGhpcy5kYk5hbWV9YDsKICAgIHRoaXMuY29sbGVjdGlvbnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgY29uc3QgcHJveHkgPSBuZXcgUHJveHkodGhpcywgewogICAgICBnZXQodGFyZ2V0LCBwcm9wZXJ0eSwgcmVjZWl2ZXIpIHsKICAgICAgICBpZiAocHJvcGVydHkgaW4gdGFyZ2V0KSB7CiAgICAgICAgICByZXR1cm4gUmVmbGVjdC5nZXQodGFyZ2V0LCBwcm9wZXJ0eSwgcmVjZWl2ZXIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIHByb3BlcnR5ID09PSAic3ltYm9sIiB8fCBwcm9wZXJ0eS5zdGFydHNXaXRoKCJfIikpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgcHJvcGVydHkgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICByZXR1cm4gdGFyZ2V0LmdldENvbGxlY3Rpb24ocHJvcGVydHkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICB9CiAgICB9KTsKICAgIHRoaXMuX3Byb3h5ID0gcHJveHk7CiAgICByZXR1cm4gcHJveHk7CiAgfQogIC8qKgogICAqIENsb3NlIGFsbCBjb2xsZWN0aW9ucwogICAqLwogIGFzeW5jIGNsb3NlKCkgewogICAgZm9yIChjb25zdCBbXywgY29sbGVjdGlvbl0gb2YgdGhpcy5jb2xsZWN0aW9ucykgewogICAgICBhd2FpdCBjb2xsZWN0aW9uLmNsb3NlKCk7CiAgICB9CiAgfQogIC8vIERCIE1ldGhvZHMKICBjbG9uZUNvbGxlY3Rpb24oKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigiY2xvbmVDb2xsZWN0aW9uIiwgeyBkYXRhYmFzZTogdGhpcy5kYk5hbWUgfSk7CiAgfQogIGNsb25lRGF0YWJhc2UoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigiY2xvbmVEYXRhYmFzZSIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICBjb21tYW5kSGVscCgpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJjb21tYW5kSGVscCIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICBjb3B5RGF0YWJhc2UoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigiY29weURhdGFiYXNlIiwgeyBkYXRhYmFzZTogdGhpcy5kYk5hbWUgfSk7CiAgfQogIGNyZWF0ZUNvbGxlY3Rpb24obmFtZSkgewogICAgaWYgKCF0aGlzLmNvbGxlY3Rpb25zLmhhcyhuYW1lKSkgewogICAgICB0aGlzLmNvbGxlY3Rpb25zLnNldChuYW1lLCBuZXcgQ29sbGVjdGlvbih0aGlzLCBuYW1lKSk7CiAgICB9CiAgICByZXR1cm4geyBvazogMSB9OwogIH0KICBjdXJyZW50T3AoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigiY3VycmVudE9wIiwgeyBkYXRhYmFzZTogdGhpcy5kYk5hbWUgfSk7CiAgfQogIGFzeW5jIGRyb3BDb2xsZWN0aW9uKGNvbGxlY3Rpb25OYW1lKSB7CiAgICBpZiAodGhpcy5jb2xsZWN0aW9ucy5oYXMoY29sbGVjdGlvbk5hbWUpKSB7CiAgICAgIGNvbnN0IGNvbGxlY3Rpb24gPSB0aGlzLmNvbGxlY3Rpb25zLmdldChjb2xsZWN0aW9uTmFtZSk7CiAgICAgIGlmICh0eXBlb2YgY29sbGVjdGlvbi5kcm9wID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgYXdhaXQgY29sbGVjdGlvbi5kcm9wKCk7CiAgICAgIH0KICAgICAgdGhpcy5jb2xsZWN0aW9ucy5kZWxldGUoY29sbGVjdGlvbk5hbWUpOwogICAgfQogIH0KICBhc3luYyBkcm9wRGF0YWJhc2UoKSB7CiAgICBmb3IgKGNvbnN0IFtfLCBjb2xsZWN0aW9uXSBvZiB0aGlzLmNvbGxlY3Rpb25zKSB7CiAgICAgIGF3YWl0IGNvbGxlY3Rpb24uZHJvcCgpOwogICAgfQogICAgdGhpcy5jb2xsZWN0aW9ucy5jbGVhcigpOwogICAgY29uc3QgcGF0aFBhcnRzID0gdGhpcy5kYkZvbGRlci5zcGxpdCgiLyIpLmZpbHRlcihCb29sZWFuKTsKICAgIGNvbnN0IGRiRm9sZGVyID0gcGF0aFBhcnRzLnBvcCgpOwogICAgdHJ5IHsKICAgICAgbGV0IGRpciA9IGF3YWl0IGdsb2JhbFRoaXMubmF2aWdhdG9yLnN0b3JhZ2UuZ2V0RGlyZWN0b3J5KCk7CiAgICAgIGZvciAoY29uc3QgcGFydCBvZiBwYXRoUGFydHMpIHsKICAgICAgICBkaXIgPSBhd2FpdCBkaXIuZ2V0RGlyZWN0b3J5SGFuZGxlKHBhcnQsIHsgY3JlYXRlOiBmYWxzZSB9KTsKICAgICAgfQogICAgICBhd2FpdCBkaXIucmVtb3ZlRW50cnkoZGJGb2xkZXIsIHsgcmVjdXJzaXZlOiB0cnVlIH0pOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGVycm9yLm5hbWUgIT09ICJOb3RGb3VuZEVycm9yIiAmJiBlcnJvci5jb2RlICE9PSAiRU5PRU5UIikgewogICAgICAgIHRocm93IGVycm9yOwogICAgICB9CiAgICB9CiAgICByZXR1cm4geyBvazogMSB9OwogIH0KICBldmFsKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoImV2YWwiLCB7IGRhdGFiYXNlOiB0aGlzLmRiTmFtZSB9KTsKICB9CiAgZnN5bmNMb2NrKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoImZzeW5jTG9jayIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICBmc3luY1VubG9jaygpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJmc3luY1VubG9jayIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICBnZXRDb2xsZWN0aW9uKG5hbWUpIHsKICAgIGlmICghdGhpcy5jb2xsZWN0aW9ucy5oYXMobmFtZSkpIHsKICAgICAgY29uc3QgZGJSZWYgPSB0aGlzLl9wcm94eSB8fCB0aGlzOwogICAgICB0aGlzLmNvbGxlY3Rpb25zLnNldChuYW1lLCBuZXcgQ29sbGVjdGlvbihkYlJlZiwgbmFtZSkpOwogICAgfQogICAgcmV0dXJuIHRoaXMuY29sbGVjdGlvbnMuZ2V0KG5hbWUpOwogIH0KICAvLyBBbGlhcyBmb3IgZ2V0Q29sbGVjdGlvbiBmb3IgTW9uZ29EQiBBUEkgY29tcGF0aWJpbGl0eQogIGNvbGxlY3Rpb24obmFtZSkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29sbGVjdGlvbihuYW1lKTsKICB9CiAgZ2V0Q29sbGVjdGlvbkluZm9zKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoImdldENvbGxlY3Rpb25JbmZvcyIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICBnZXRDb2xsZWN0aW9uTmFtZXMoKSB7CiAgICByZXR1cm4gQXJyYXkuZnJvbSh0aGlzLmNvbGxlY3Rpb25zLmtleXMoKSk7CiAgfQogIGdldExhc3RFcnJvcigpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJnZXRMYXN0RXJyb3IiLCB7IGRhdGFiYXNlOiB0aGlzLmRiTmFtZSB9KTsKICB9CiAgZ2V0TGFzdEVycm9yT2JqKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoImdldExhc3RFcnJvck9iaiIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICBnZXRMb2dDb21wb25lbnRzKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoImdldExvZ0NvbXBvbmVudHMiLCB7IGRhdGFiYXNlOiB0aGlzLmRiTmFtZSB9KTsKICB9CiAgZ2V0TW9uZ28oKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigiZ2V0TW9uZ28iLCB7IGRhdGFiYXNlOiB0aGlzLmRiTmFtZSB9KTsKICB9CiAgZ2V0TmFtZSgpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJnZXROYW1lIiwgeyBkYXRhYmFzZTogdGhpcy5kYk5hbWUgfSk7CiAgfQogIGdldFByZXZFcnJvcigpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJnZXRQcmV2RXJyb3IiLCB7IGRhdGFiYXNlOiB0aGlzLmRiTmFtZSB9KTsKICB9CiAgZ2V0UHJvZmlsaW5nTGV2ZWwoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigiZ2V0UHJvZmlsaW5nTGV2ZWwiLCB7IGRhdGFiYXNlOiB0aGlzLmRiTmFtZSB9KTsKICB9CiAgZ2V0UHJvZmlsaW5nU3RhdHVzKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoImdldFByb2ZpbGluZ1N0YXR1cyIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICBnZXRSZXBsaWNhdGlvbkluZm8oKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigiZ2V0UmVwbGljYXRpb25JbmZvIiwgeyBkYXRhYmFzZTogdGhpcy5kYk5hbWUgfSk7CiAgfQogIGdldFNpYmxpbmdEQigpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJnZXRTaWJsaW5nREIiLCB7IGRhdGFiYXNlOiB0aGlzLmRiTmFtZSB9KTsKICB9CiAgaGVscCgpIHsKICAgIGNvbnNvbGUubG9nKCIgICAgICAgIGhlbHAgbXIgICAgICAgICAgICAgICAgICAgICAgbWFwcmVkdWNlIik7CiAgICBjb25zb2xlLmxvZygiICAgICAgICBkYi5mb28uZmluZCgpICAgICAgICAgICAgICAgIGxpc3Qgb2JqZWN0cyBpbiBjb2xsZWN0aW9uIGZvbyIpOwogICAgY29uc29sZS5sb2coIiAgICAgICAgZGIuZm9vLmZpbmQoIHsgYSA6IDEgfSApICAgICBsaXN0IG9iamVjdHMgaW4gZm9vIHdoZXJlIGEgPT0gMSIpOwogICAgY29uc29sZS5sb2coIiAgICAgICAgaXQgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgb2YgdGhlIGxhc3QgbGluZSBldmFsdWF0ZWQ7IHVzZSB0byBmdXJ0aGVyIGl0ZXJhdGUiKTsKICB9CiAgaG9zdEluZm8oKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigiaG9zdEluZm8iLCB7IGRhdGFiYXNlOiB0aGlzLmRiTmFtZSB9KTsKICB9CiAgaXNNYXN0ZXIoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigiaXNNYXN0ZXIiLCB7IGRhdGFiYXNlOiB0aGlzLmRiTmFtZSB9KTsKICB9CiAga2lsbE9wKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoImtpbGxPcCIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICBsaXN0Q29tbWFuZHMoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigibGlzdENvbW1hbmRzIiwgeyBkYXRhYmFzZTogdGhpcy5kYk5hbWUgfSk7CiAgfQogIGxvYWRTZXJ2ZXJTY3JpcHRzKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoImxvYWRTZXJ2ZXJTY3JpcHRzIiwgeyBkYXRhYmFzZTogdGhpcy5kYk5hbWUgfSk7CiAgfQogIGxvZ291dCgpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJsb2dvdXQiLCB7IGRhdGFiYXNlOiB0aGlzLmRiTmFtZSB9KTsKICB9CiAgcHJpbnRDb2xsZWN0aW9uU3RhdHMoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigicHJpbnRDb2xsZWN0aW9uU3RhdHMiLCB7IGRhdGFiYXNlOiB0aGlzLmRiTmFtZSB9KTsKICB9CiAgcHJpbnRSZXBsaWNhdGlvbkluZm8oKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigicHJpbnRSZXBsaWNhdGlvbkluZm8iLCB7IGRhdGFiYXNlOiB0aGlzLmRiTmFtZSB9KTsKICB9CiAgcHJpbnRTaGFyZGluZ1N0YXR1cygpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJwcmludFNoYXJkaW5nU3RhdHVzIiwgeyBkYXRhYmFzZTogdGhpcy5kYk5hbWUgfSk7CiAgfQogIHByaW50U2xhdmVSZXBsaWNhdGlvbkluZm8oKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigicHJpbnRTbGF2ZVJlcGxpY2F0aW9uSW5mbyIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICByZXBhaXJEYXRhYmFzZSgpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJyZXBhaXJEYXRhYmFzZSIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICByZXNldEVycm9yKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoInJlc2V0RXJyb3IiLCB7IGRhdGFiYXNlOiB0aGlzLmRiTmFtZSB9KTsKICB9CiAgcnVuQ29tbWFuZCgpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJydW5Db21tYW5kIiwgeyBkYXRhYmFzZTogdGhpcy5kYk5hbWUgfSk7CiAgfQogIHNlcnZlckJ1aWxkSW5mbygpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJzZXJ2ZXJCdWlsZEluZm8iLCB7IGRhdGFiYXNlOiB0aGlzLmRiTmFtZSB9KTsKICB9CiAgc2VydmVyQ21kTGluZU9wdHMoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigic2VydmVyQ21kTGluZU9wdHMiLCB7IGRhdGFiYXNlOiB0aGlzLmRiTmFtZSB9KTsKICB9CiAgc2VydmVyU3RhdHVzKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoInNlcnZlclN0YXR1cyIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICBzZXRMb2dMZXZlbCgpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJzZXRMb2dMZXZlbCIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICBzZXRQcm9maWxpbmdMZXZlbCgpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJzZXRQcm9maWxpbmdMZXZlbCIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICBzaHV0ZG93blNlcnZlcigpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJzaHV0ZG93blNlcnZlciIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICBzdGF0cygpIHsKICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKCJzdGF0cyIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICB2ZXJzaW9uKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoInZlcnNpb24iLCB7IGRhdGFiYXNlOiB0aGlzLmRiTmFtZSB9KTsKICB9CiAgdXBncmFkZUNoZWNrKCkgewogICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoInVwZ3JhZGVDaGVjayIsIHsgZGF0YWJhc2U6IHRoaXMuZGJOYW1lIH0pOwogIH0KICB1cGdyYWRlQ2hlY2tBbGxEQnMoKSB7CiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcigidXBncmFkZUNoZWNrQWxsREJzIiwgeyBkYXRhYmFzZTogdGhpcy5kYk5hbWUgfSk7CiAgfQogIC8qKgogICAqIFdhdGNoIGZvciBjaGFuZ2VzIGFjcm9zcyBhbGwgY29sbGVjdGlvbnMgaW4gdGhpcyBkYXRhYmFzZQogICAqIEBwYXJhbSB7QXJyYXl9IHBpcGVsaW5lIC0gQWdncmVnYXRpb24gcGlwZWxpbmUgdG8gZmlsdGVyIGNoYW5nZXMKICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAtIFdhdGNoIG9wdGlvbnMKICAgKiBAcmV0dXJucyB7Q2hhbmdlU3RyZWFtfSBBIGNoYW5nZSBzdHJlYW0gaW5zdGFuY2UKICAgKi8KICB3YXRjaChwaXBlbGluZSA9IFtdLCBvcHRpb25zID0ge30pIHsKICAgIHJldHVybiBuZXcgQ2hhbmdlU3RyZWFtKHRoaXMsIHBpcGVsaW5lLCBvcHRpb25zKTsKICB9Cn0KY2xhc3MgU2VydmVyIHsKICBjb25zdHJ1Y3RvcihvcHRpb25zID0ge30sIHBvc3RFdmVudCA9ICgpID0+IHsKICB9KSB7CiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgdGhpcy5kYXRhYmFzZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgdGhpcy5wb3N0RXZlbnQgPSBwb3N0RXZlbnQ7CiAgICB0aGlzLmN1cnNvcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgdGhpcy5jdXJzb3JDb3VudGVyID0gMTsKICAgIHRoaXMuc3RyZWFtcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICB0aGlzLnN0cmVhbUNvdW50ZXIgPSAxOwogIH0KICBhc3luYyBkaXNwYXRjaChyZXF1ZXN0KSB7CiAgICBjb25zdCB7IHRhcmdldCwgZGF0YWJhc2UsIGNvbGxlY3Rpb24sIG1ldGhvZCwgYXJncyA9IFtdLCBjdXJzb3JJZCwgc3RyZWFtSWQsIGN1cnNvck9wdHMgfSA9IHJlcXVlc3Q7CiAgICBpZiAodGFyZ2V0ID09PSAiY3Vyc29yIikgewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fY3Vyc29yT3AoY3Vyc29ySWQsIG1ldGhvZCwgYXJncyk7CiAgICB9CiAgICBpZiAodGFyZ2V0ID09PSAiY2hhbmdlc3RyZWFtIikgewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fY2hhbmdlU3RyZWFtT3Aoc3RyZWFtSWQsIG1ldGhvZCwgYXJncyk7CiAgICB9CiAgICBpZiAodGFyZ2V0ID09PSAiY2xpZW50IikgewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fY2FsbCh0aGlzLCBtZXRob2QsIGFyZ3MpOwogICAgfQogICAgaWYgKCF0YXJnZXQgfHwgIWRhdGFiYXNlIHx8ICFtZXRob2QpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHJlcXVlc3QgcGF5bG9hZCIpOwogICAgfQogICAgY29uc3QgZGIgPSB0aGlzLl9nZXREQihkYXRhYmFzZSk7CiAgICBpZiAodGFyZ2V0ID09PSAiZGIiKSB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9jYWxsKGRiLCBtZXRob2QsIGFyZ3MpOwogICAgfQogICAgaWYgKHRhcmdldCA9PT0gImNvbGxlY3Rpb24iKSB7CiAgICAgIGlmICghY29sbGVjdGlvbikgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiQ29sbGVjdGlvbiBuYW1lIHJlcXVpcmVkIGZvciBjb2xsZWN0aW9uIHRhcmdldCIpOwogICAgICB9CiAgICAgIGNvbnN0IGNvbCA9IGRiLmNvbGxlY3Rpb24oY29sbGVjdGlvbik7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9jYWxsKGNvbCwgbWV0aG9kLCBhcmdzLCBjdXJzb3JPcHRzKTsKICAgIH0KICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biB0YXJnZXQ6ICR7dGFyZ2V0fWApOwogIH0KICBfZ2V0REIoZGJOYW1lKSB7CiAgICBpZiAodGhpcy5kYXRhYmFzZXMuaGFzKGRiTmFtZSkpIHJldHVybiB0aGlzLmRhdGFiYXNlcy5nZXQoZGJOYW1lKTsKICAgIGNvbnN0IGRiID0gbmV3IERCKHsgLi4udGhpcy5vcHRpb25zLCBkYk5hbWUgfSk7CiAgICB0aGlzLmRhdGFiYXNlcy5zZXQoZGJOYW1lLCBkYik7CiAgICByZXR1cm4gZGI7CiAgfQogIGFzeW5jIF9jYWxsKHRhcmdldCwgbWV0aG9kLCBhcmdzLCBjdXJzb3JPcHRzKSB7CiAgICBpZiAodHlwZW9mIHRhcmdldFttZXRob2RdICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihgTWV0aG9kICR7bWV0aG9kfSBub3QgZm91bmQgb24gdGFyZ2V0YCk7CiAgICB9CiAgICBjb25zdCByZXN1bHQgPSB0YXJnZXRbbWV0aG9kXSguLi5hcmdzIHx8IFtdKTsKICAgIGNvbnN0IGF3YWl0ZWQgPSByZXN1bHQgJiYgdHlwZW9mIHJlc3VsdC50aGVuID09PSAiZnVuY3Rpb24iID8gYXdhaXQgcmVzdWx0IDogcmVzdWx0OwogICAgaWYgKGF3YWl0ZWQgJiYgdHlwZW9mIGF3YWl0ZWQuaGFzTmV4dCA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgYXdhaXRlZC5uZXh0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9yZWdpc3RlckN1cnNvcihhd2FpdGVkLCBjdXJzb3JPcHRzKTsKICAgIH0KICAgIGlmIChtZXRob2QgPT09ICJhZ2dyZWdhdGUiICYmIEFycmF5LmlzQXJyYXkoYXdhaXRlZCkpIHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX3JlZ2lzdGVyQXJyYXlBc0N1cnNvcihhd2FpdGVkKTsKICAgIH0KICAgIGlmIChhd2FpdGVkICYmIGF3YWl0ZWQuY29uc3RydWN0b3I/Lm5hbWUgPT09ICJDaGFuZ2VTdHJlYW0iKSB7CiAgICAgIHJldHVybiB0aGlzLl9yZWdpc3RlckNoYW5nZVN0cmVhbShhd2FpdGVkKTsKICAgIH0KICAgIHJldHVybiBhd2FpdGVkOwogIH0KICBhc3luYyBfcmVnaXN0ZXJDdXJzb3IoY3Vyc29yLCBjdXJzb3JPcHRzID0ge30pIHsKICAgIGlmIChjdXJzb3JPcHRzLnNvcnQpIGN1cnNvciA9IGN1cnNvci5zb3J0KGN1cnNvck9wdHMuc29ydCk7CiAgICBpZiAoY3Vyc29yT3B0cy5za2lwKSBjdXJzb3IgPSBhd2FpdCBjdXJzb3Iuc2tpcChjdXJzb3JPcHRzLnNraXApOwogICAgaWYgKGN1cnNvck9wdHMubGltaXQpIGN1cnNvciA9IGF3YWl0IGN1cnNvci5saW1pdChjdXJzb3JPcHRzLmxpbWl0KTsKICAgIGlmIChjdXJzb3JPcHRzLm1pbiAmJiBjdXJzb3IubWluKSBjdXJzb3IgPSBjdXJzb3IubWluKGN1cnNvck9wdHMubWluKTsKICAgIGlmIChjdXJzb3JPcHRzLm1heCAmJiBjdXJzb3IubWF4KSBjdXJzb3IgPSBjdXJzb3IubWF4KGN1cnNvck9wdHMubWF4KTsKICAgIGlmIChjdXJzb3JPcHRzLmhpbnQgJiYgY3Vyc29yLmhpbnQpIGN1cnNvciA9IGN1cnNvci5oaW50KGN1cnNvck9wdHMuaGludCk7CiAgICBpZiAoY3Vyc29yT3B0cy5jb21tZW50ICYmIGN1cnNvci5jb21tZW50KSBjdXJzb3IgPSBjdXJzb3IuY29tbWVudChjdXJzb3JPcHRzLmNvbW1lbnQpOwogICAgaWYgKGN1cnNvck9wdHMubWF4VGltZU1TICYmIGN1cnNvci5tYXhUaW1lTVMpIGN1cnNvciA9IGN1cnNvci5tYXhUaW1lTVMoY3Vyc29yT3B0cy5tYXhUaW1lTVMpOwogICAgaWYgKGN1cnNvck9wdHMubWF4U2NhbiAmJiBjdXJzb3IubWF4U2NhbikgY3Vyc29yID0gY3Vyc29yLm1heFNjYW4oY3Vyc29yT3B0cy5tYXhTY2FuKTsKICAgIGlmIChjdXJzb3JPcHRzLnJldHVybktleSAmJiBjdXJzb3IucmV0dXJuS2V5KSBjdXJzb3IgPSBjdXJzb3IucmV0dXJuS2V5KGN1cnNvck9wdHMucmV0dXJuS2V5KTsKICAgIGlmIChjdXJzb3JPcHRzLnNob3dSZWNvcmRJZCAmJiBjdXJzb3Iuc2hvd1JlY29yZElkKSBjdXJzb3IgPSBjdXJzb3Iuc2hvd1JlY29yZElkKGN1cnNvck9wdHMuc2hvd1JlY29yZElkKTsKICAgIGlmIChjdXJzb3JPcHRzLmNvbGxhdGlvbiAmJiBjdXJzb3IuY29sbGF0aW9uKSBjdXJzb3IgPSBjdXJzb3IuY29sbGF0aW9uKGN1cnNvck9wdHMuY29sbGF0aW9uKTsKICAgIGNvbnN0IGlkID0gYGN1cl8ke3RoaXMuY3Vyc29yQ291bnRlcisrfWA7CiAgICBjb25zdCBiYXRjaFNpemUgPSB0aGlzLm9wdGlvbnMuYmF0Y2hTaXplIHx8IDEwMDsKICAgIGNvbnN0IGJhdGNoID0gW107CiAgICB3aGlsZSAoYmF0Y2gubGVuZ3RoIDwgYmF0Y2hTaXplICYmIGF3YWl0IGN1cnNvci5oYXNOZXh0KCkpIHsKICAgICAgYmF0Y2gucHVzaChhd2FpdCBjdXJzb3IubmV4dCgpKTsKICAgIH0KICAgIGNvbnN0IGV4aGF1c3RlZCA9ICFhd2FpdCBjdXJzb3IuaGFzTmV4dCgpOwogICAgaWYgKCFleGhhdXN0ZWQpIHsKICAgICAgdGhpcy5jdXJzb3JzLnNldChpZCwgY3Vyc29yKTsKICAgIH0KICAgIHJldHVybiB7IGN1cnNvcklkOiBpZCwgYmF0Y2gsIGV4aGF1c3RlZCwgYmF0Y2hTaXplIH07CiAgfQogIGFzeW5jIF9yZWdpc3RlckFycmF5QXNDdXJzb3IocmVzdWx0c0FycmF5KSB7CiAgICBjb25zdCBpZCA9IGBjdXJfJHt0aGlzLmN1cnNvckNvdW50ZXIrK31gOwogICAgY29uc3QgYmF0Y2hTaXplID0gdGhpcy5vcHRpb25zLmJhdGNoU2l6ZSB8fCAxMDA7CiAgICBjb25zdCBiYXRjaCA9IHJlc3VsdHNBcnJheS5zbGljZSgwLCBiYXRjaFNpemUpOwogICAgY29uc3QgZXhoYXVzdGVkID0gcmVzdWx0c0FycmF5Lmxlbmd0aCA8PSBiYXRjaFNpemU7CiAgICBpZiAoIWV4aGF1c3RlZCkgewogICAgICBjb25zdCBjdXJzb3IgPSB7CiAgICAgICAgcG9zaXRpb246IGJhdGNoU2l6ZSwKICAgICAgICBhcnJheTogcmVzdWx0c0FycmF5LAogICAgICAgIGFzeW5jIGhhc05leHQoKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5wb3NpdGlvbiA8IHRoaXMuYXJyYXkubGVuZ3RoOwogICAgICAgIH0sCiAgICAgICAgYXN5bmMgbmV4dCgpIHsKICAgICAgICAgIGlmICh0aGlzLnBvc2l0aW9uID49IHRoaXMuYXJyYXkubGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoIk5vIG1vcmUgZG9jdW1lbnRzIik7CiAgICAgICAgICByZXR1cm4gdGhpcy5hcnJheVt0aGlzLnBvc2l0aW9uKytdOwogICAgICAgIH0KICAgICAgfTsKICAgICAgdGhpcy5jdXJzb3JzLnNldChpZCwgY3Vyc29yKTsKICAgIH0KICAgIHJldHVybiB7IGN1cnNvcklkOiBpZCwgYmF0Y2gsIGV4aGF1c3RlZCwgYmF0Y2hTaXplIH07CiAgfQogIGFzeW5jIF9jdXJzb3JPcChjdXJzb3JJZCwgbWV0aG9kLCBhcmdzID0gW10pIHsKICAgIGlmICghY3Vyc29ySWQpIHRocm93IG5ldyBFcnJvcigiY3Vyc29ySWQgcmVxdWlyZWQiKTsKICAgIGNvbnN0IGN1cnNvciA9IHRoaXMuY3Vyc29ycy5nZXQoY3Vyc29ySWQpOwogICAgaWYgKCFjdXJzb3IpIHsKICAgICAgaWYgKG1ldGhvZCA9PT0gImNsb3NlIikgcmV0dXJuIHsgY2xvc2VkOiB0cnVlIH07CiAgICAgIHRocm93IG5ldyBFcnJvcihgQ3Vyc29yIG5vdCBmb3VuZDogJHtjdXJzb3JJZH1gKTsKICAgIH0KICAgIGlmIChtZXRob2QgPT09ICJjbG9zZSIpIHsKICAgICAgdGhpcy5jdXJzb3JzLmRlbGV0ZShjdXJzb3JJZCk7CiAgICAgIHJldHVybiB7IGNsb3NlZDogdHJ1ZSB9OwogICAgfQogICAgaWYgKG1ldGhvZCA9PT0gImdldE1vcmUiKSB7CiAgICAgIGNvbnN0IG9wdHMgPSBhcmdzPy5bMF0gfHwge307CiAgICAgIGNvbnN0IGJhdGNoU2l6ZSA9IG9wdHMuYmF0Y2hTaXplIHx8IDEwMDsKICAgICAgY29uc3QgYmF0Y2ggPSBbXTsKICAgICAgd2hpbGUgKGJhdGNoLmxlbmd0aCA8IGJhdGNoU2l6ZSAmJiBhd2FpdCBjdXJzb3IuaGFzTmV4dCgpKSB7CiAgICAgICAgYmF0Y2gucHVzaChhd2FpdCBjdXJzb3IubmV4dCgpKTsKICAgICAgfQogICAgICBjb25zdCBleGhhdXN0ZWQgPSAhYXdhaXQgY3Vyc29yLmhhc05leHQoKTsKICAgICAgaWYgKGV4aGF1c3RlZCkgewogICAgICAgIHRoaXMuY3Vyc29ycy5kZWxldGUoY3Vyc29ySWQpOwogICAgICB9CiAgICAgIHJldHVybiB7IGJhdGNoLCBleGhhdXN0ZWQsIGJhdGNoU2l6ZSB9OwogICAgfQogICAgdGhyb3cgbmV3IEVycm9yKGBVbmtub3duIGN1cnNvciBtZXRob2Q6ICR7bWV0aG9kfWApOwogIH0KICBfcmVnaXN0ZXJDaGFuZ2VTdHJlYW0oc3RyZWFtKSB7CiAgICBjb25zdCBpZCA9IGBjc18ke3RoaXMuc3RyZWFtQ291bnRlcisrfWA7CiAgICBjb25zdCBoYW5kbGVycyA9IHsKICAgICAgY2hhbmdlOiAoY2hhbmdlKSA9PiB0aGlzLnBvc3RFdmVudCh7CiAgICAgICAgdHlwZTogImV2ZW50IiwKICAgICAgICBldmVudDogImNoYW5nZVN0cmVhbSIsCiAgICAgICAgcGF5bG9hZDogeyBzdHJlYW1JZDogaWQsIHR5cGU6ICJjaGFuZ2UiLCBkYXRhOiBjaGFuZ2UgfQogICAgICB9KSwKICAgICAgZXJyb3I6IChlcnIpID0+IHRoaXMucG9zdEV2ZW50KHsKICAgICAgICB0eXBlOiAiZXZlbnQiLAogICAgICAgIGV2ZW50OiAiY2hhbmdlU3RyZWFtIiwKICAgICAgICBwYXlsb2FkOiB7IHN0cmVhbUlkOiBpZCwgdHlwZTogImVycm9yIiwgZGF0YTogewogICAgICAgICAgbmFtZTogZXJyPy5uYW1lLAogICAgICAgICAgbWVzc2FnZTogZXJyPy5tZXNzYWdlLAogICAgICAgICAgc3RhY2s6IGVycj8uc3RhY2sKICAgICAgICB9IH0KICAgICAgfSksCiAgICAgIGNsb3NlOiAoKSA9PiB0aGlzLnBvc3RFdmVudCh7CiAgICAgICAgdHlwZTogImV2ZW50IiwKICAgICAgICBldmVudDogImNoYW5nZVN0cmVhbSIsCiAgICAgICAgcGF5bG9hZDogeyBzdHJlYW1JZDogaWQsIHR5cGU6ICJjbG9zZSIgfQogICAgICB9KQogICAgfTsKICAgIHN0cmVhbS5vbigiY2hhbmdlIiwgaGFuZGxlcnMuY2hhbmdlKTsKICAgIHN0cmVhbS5vbigiZXJyb3IiLCBoYW5kbGVycy5lcnJvcik7CiAgICBzdHJlYW0ub24oImNsb3NlIiwgaGFuZGxlcnMuY2xvc2UpOwogICAgdGhpcy5zdHJlYW1zLnNldChpZCwgeyBzdHJlYW0sIGhhbmRsZXJzIH0pOwogICAgcmV0dXJuIHsgc3RyZWFtSWQ6IGlkIH07CiAgfQogIGFzeW5jIF9jaGFuZ2VTdHJlYW1PcChzdHJlYW1JZCwgbWV0aG9kKSB7CiAgICBpZiAoIXN0cmVhbUlkKSB0aHJvdyBuZXcgRXJyb3IoInN0cmVhbUlkIHJlcXVpcmVkIik7CiAgICBjb25zdCBlbnRyeSA9IHRoaXMuc3RyZWFtcy5nZXQoc3RyZWFtSWQpOwogICAgaWYgKCFlbnRyeSkgcmV0dXJuIHsgY2xvc2VkOiB0cnVlIH07CiAgICBpZiAobWV0aG9kID09PSAiY2xvc2UiKSB7CiAgICAgIGNvbnN0IHsgc3RyZWFtLCBoYW5kbGVycyB9ID0gZW50cnk7CiAgICAgIHN0cmVhbS5vZmYoImNoYW5nZSIsIGhhbmRsZXJzLmNoYW5nZSk7CiAgICAgIHN0cmVhbS5vZmYoImVycm9yIiwgaGFuZGxlcnMuZXJyb3IpOwogICAgICBzdHJlYW0ub2ZmKCJjbG9zZSIsIGhhbmRsZXJzLmNsb3NlKTsKICAgICAgaWYgKHR5cGVvZiBzdHJlYW0uY2xvc2UgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICBhd2FpdCBzdHJlYW0uY2xvc2UoKTsKICAgICAgfQogICAgICB0aGlzLnN0cmVhbXMuZGVsZXRlKHN0cmVhbUlkKTsKICAgICAgcmV0dXJuIHsgY2xvc2VkOiB0cnVlIH07CiAgICB9CiAgICB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gY2hhbmdlIHN0cmVhbSBtZXRob2Q6ICR7bWV0aG9kfWApOwogIH0KICAvKioKICAgKiBXYXRjaCBmb3IgY2hhbmdlcyBhY3Jvc3MgYWxsIGRhdGFiYXNlcyBhbmQgY29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fSBwaXBlbGluZSAtIEFnZ3JlZ2F0aW9uIHBpcGVsaW5lIHRvIGZpbHRlciBjaGFuZ2VzCiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgLSBXYXRjaCBvcHRpb25zCiAgICogQHJldHVybnMge0NoYW5nZVN0cmVhbX0gQSBjaGFuZ2Ugc3RyZWFtIGluc3RhbmNlCiAgICovCiAgd2F0Y2gocGlwZWxpbmUgPSBbXSwgb3B0aW9ucyA9IHt9KSB7CiAgICByZXR1cm4gbmV3IENoYW5nZVN0cmVhbSh0aGlzLCBwaXBlbGluZSwgb3B0aW9ucyk7CiAgfQp9CmZ1bmN0aW9uIHNlcmlhbGl6ZVBheWxvYWQob2JqKSB7CiAgaWYgKG9iaiA9PT0gbnVsbCB8fCBvYmogPT09IHZvaWQgMCkgcmV0dXJuIG9iajsKICBpZiAodHlwZW9mIG9iaiA9PT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIHsgX19mdW5jdGlvbjogb2JqLnRvU3RyaW5nKCkgfTsKICB9CiAgaWYgKG9iaiBpbnN0YW5jZW9mIE9iamVjdElkKSB7CiAgICByZXR1cm4geyBfX29iamVjdElkOiBvYmoudG9TdHJpbmcoKSB9OwogIH0KICBpZiAob2JqIGluc3RhbmNlb2YgRGF0ZSkgewogICAgcmV0dXJuIHsgX19kYXRlOiBvYmoudG9JU09TdHJpbmcoKSB9OwogIH0KICBpZiAoQXJyYXkuaXNBcnJheShvYmopKSB7CiAgICByZXR1cm4gb2JqLm1hcChzZXJpYWxpemVQYXlsb2FkKTsKICB9CiAgaWYgKHR5cGVvZiBvYmogPT09ICJvYmplY3QiKSB7CiAgICBjb25zdCByZXN1bHQgPSB7fTsKICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKG9iaikpIHsKICAgICAgcmVzdWx0W2tleV0gPSBzZXJpYWxpemVQYXlsb2FkKHZhbHVlKTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHJldHVybiBvYmo7Cn0KZnVuY3Rpb24gZGVzZXJpYWxpemVQYXlsb2FkKG9iaikgewogIGlmIChvYmogPT09IG51bGwgfHwgb2JqID09PSB2b2lkIDApIHJldHVybiBvYmo7CiAgaWYgKHR5cGVvZiBvYmogPT09ICJvYmplY3QiICYmIG9iai5fX2Z1bmN0aW9uKSB7CiAgICByZXR1cm4gdHlwZW9mIG9iai5fX2Z1bmN0aW9uID09PSAic3RyaW5nIiA/IGAoJHtvYmouX19mdW5jdGlvbn0pLmNhbGwodGhpcylgIDogdm9pZCAwOwogIH0KICBpZiAodHlwZW9mIG9iaiA9PT0gIm9iamVjdCIgJiYgb2JqLl9fb2JqZWN0SWQpIHsKICAgIHJldHVybiBuZXcgT2JqZWN0SWQob2JqLl9fb2JqZWN0SWQpOwogIH0KICBpZiAodHlwZW9mIG9iaiA9PT0gIm9iamVjdCIgJiYgb2JqLl9fZGF0ZSkgewogICAgcmV0dXJuIG5ldyBEYXRlKG9iai5fX2RhdGUpOwogIH0KICBpZiAoQXJyYXkuaXNBcnJheShvYmopKSB7CiAgICByZXR1cm4gb2JqLm1hcChkZXNlcmlhbGl6ZVBheWxvYWQpOwogIH0KICBpZiAodHlwZW9mIG9iaiA9PT0gIm9iamVjdCIpIHsKICAgIGNvbnN0IHJlc3VsdCA9IHt9OwogICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMob2JqKSkgewogICAgICByZXN1bHRba2V5XSA9IGRlc2VyaWFsaXplUGF5bG9hZCh2YWx1ZSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICByZXR1cm4gb2JqOwp9CmNvbnN0IGlzTm9kZSA9IHR5cGVvZiBwcm9jZXNzICE9PSAidW5kZWZpbmVkIiAmJiAhIXByb2Nlc3MudmVyc2lvbnM/Lm5vZGU7CmxldCBzZXJ2ZXI7CmxldCBpbml0UHJvbWlzZSA9IG51bGw7CmlmIChpc05vZGUpIHsKICBpbml0UHJvbWlzZSA9IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gewogICAgY29uc3QgaW1wb3J0RnVuYyA9IG5ldyBGdW5jdGlvbigic3BlYyIsICJyZXR1cm4gaW1wb3J0KHNwZWMpIik7CiAgICByZXR1cm4gUHJvbWlzZS5hbGwoWwogICAgICBpbXBvcnRGdW5jKCJwYXRoIiksCiAgICAgIGltcG9ydEZ1bmMoInVybCIpLAogICAgICBpbXBvcnRGdW5jKCJub2RlLW9wZnMiKQogICAgXSk7CiAgfSkudGhlbigoW3BhdGhNb2R1bGUsIHVybE1vZHVsZSwgb3Bmc01vZHVsZV0pID0+IHsKICAgIGNvbnN0IHBhdGggPSBwYXRoTW9kdWxlLmRlZmF1bHQ7CiAgICBjb25zdCB7IGZpbGVVUkxUb1BhdGggfSA9IHVybE1vZHVsZTsKICAgIGNvbnN0IHsgU3RvcmFnZU1hbmFnZXIgfSA9IG9wZnNNb2R1bGU7CiAgICBjb25zdCBfX2ZpbGVuYW1lID0gZmlsZVVSTFRvUGF0aChpbXBvcnQubWV0YS51cmwpOwogICAgY29uc3QgX19kaXJuYW1lID0gcGF0aC5kaXJuYW1lKF9fZmlsZW5hbWUpOwogICAgY29uc3QgcHJvamVjdFJvb3QgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAiLi4iKTsKICAgIGNvbnN0IG9wZnNEaXIgPSBwYXRoLmpvaW4ocHJvamVjdFJvb3QsICIub3BmcyIpOwogICAgY29uc3QgY3VzdG9tU3RvcmFnZSA9IG5ldyBTdG9yYWdlTWFuYWdlcihvcGZzRGlyKTsKICAgIGNvbnN0IG9wZnNOYXZpZ2F0b3IgPSB7CiAgICAgIHN0b3JhZ2U6IHsKICAgICAgICBnZXREaXJlY3Rvcnk6ICgpID0+IGN1c3RvbVN0b3JhZ2UuZ2V0RGlyZWN0b3J5KCkKICAgICAgfQogICAgfTsKICAgIGlmICh0eXBlb2YgZ2xvYmFsVGhpcy5uYXZpZ2F0b3IgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIGdsb2JhbFRoaXMubmF2aWdhdG9yID0gb3Bmc05hdmlnYXRvcjsKICAgIH0gZWxzZSB7CiAgICAgIGdsb2JhbFRoaXMubmF2aWdhdG9yLnN0b3JhZ2UgPSBvcGZzTmF2aWdhdG9yLnN0b3JhZ2U7CiAgICB9CiAgfSkuY2F0Y2goKCkgPT4gewogIH0pOwp9CmZ1bmN0aW9uIGNyZWF0ZVNlcnZlcihwb3N0KSB7CiAgaWYgKCFzZXJ2ZXIpIHsKICAgIHNlcnZlciA9IG5ldyBTZXJ2ZXIoe30sIHBvc3QpOwogIH0KICByZXR1cm4gc2VydmVyOwp9CmFzeW5jIGZ1bmN0aW9uIGhhbmRsZU1lc3NhZ2UobWVzc2FnZSwgcG9zdCkgewogIGlmICghbWVzc2FnZSB8fCBtZXNzYWdlLnR5cGUgIT09ICJyZXF1ZXN0IikgcmV0dXJuOwogIGlmIChpbml0UHJvbWlzZSkgewogICAgYXdhaXQgaW5pdFByb21pc2U7CiAgfQogIGNvbnN0IHsgaWQsIHBheWxvYWQgfSA9IG1lc3NhZ2U7CiAgY29uc3QgZGVzZXJpYWxpemVkUGF5bG9hZCA9IGRlc2VyaWFsaXplUGF5bG9hZChwYXlsb2FkKTsKICBjb25zdCBzcnYgPSBjcmVhdGVTZXJ2ZXIocG9zdCk7CiAgdHJ5IHsKICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNydi5kaXNwYXRjaChkZXNlcmlhbGl6ZWRQYXlsb2FkKTsKICAgIGNvbnN0IHNlcmlhbGl6ZWRSZXN1bHQgPSBzZXJpYWxpemVQYXlsb2FkKHJlc3VsdCk7CiAgICBwb3N0KHsgdHlwZTogInJlc3BvbnNlIiwgaWQsIHN1Y2Nlc3M6IHRydWUsIHJlc3VsdDogc2VyaWFsaXplZFJlc3VsdCB9KTsKICB9IGNhdGNoIChlcnJvcikgewogICAgcG9zdCh7CiAgICAgIHR5cGU6ICJyZXNwb25zZSIsCiAgICAgIGlkLAogICAgICBzdWNjZXNzOiBmYWxzZSwKICAgICAgZXJyb3I6IHsKICAgICAgICBuYW1lOiBlcnJvcj8ubmFtZSwKICAgICAgICBtZXNzYWdlOiBlcnJvcj8ubWVzc2FnZSwKICAgICAgICBzdGFjazogZXJyb3I/LnN0YWNrLAogICAgICAgIGNvZGU6IGVycm9yPy5jb2RlLAogICAgICAgICRlcnI6IGVycm9yPy4kZXJyCiAgICAgIH0KICAgIH0pOwogIH0KfQphc3luYyBmdW5jdGlvbiBpbml0aWFsaXplV29ya2VyKCkgewogIGlmIChpc05vZGUpIHsKICAgIGNvbnN0IHsgcGFyZW50UG9ydCB9ID0gYXdhaXQgaW1wb3J0KCJ3b3JrZXJfdGhyZWFkcyIpOwogICAgY29uc3QgcG9zdCA9IChyZXNwKSA9PiBwYXJlbnRQb3J0LnBvc3RNZXNzYWdlKHJlc3ApOwogICAgcGFyZW50UG9ydC5vbigibWVzc2FnZSIsIChtc2cpID0+IGhhbmRsZU1lc3NhZ2UobXNnLCBwb3N0KSk7CiAgfSBlbHNlIHsKICAgIGNvbnN0IHBvc3QgPSAocmVzcCkgPT4gc2VsZi5wb3N0TWVzc2FnZShyZXNwKTsKICAgIHNlbGYub25tZXNzYWdlID0gKGV2ZW50KSA9PiBoYW5kbGVNZXNzYWdlKGV2ZW50LmRhdGEsIHBvc3QpOwogIH0KfQppbml0aWFsaXplV29ya2VyKCkuY2F0Y2goKGVycikgPT4gewogIGNvbnNvbGUuZXJyb3IoIldvcmtlciBpbml0aWFsaXphdGlvbiBmYWlsZWQ6IiwgZXJyKTsKICBpZiAodHlwZW9mIHByb2Nlc3MgIT09ICJ1bmRlZmluZWQiKSB7CiAgICBwcm9jZXNzLmV4aXQoMSk7CiAgfSBlbHNlIHsKICAgIHNlbGYucG9zdE1lc3NhZ2UoeyB0eXBlOiAiZXJyb3IiLCBlcnJvcjogZXJyLm1lc3NhZ2UgfSk7CiAgfQp9KTsKLy8jIHNvdXJjZU1hcHBpbmdVUkw9bWljcm8tbW9uZ28tc2VydmVyLXdvcmtlci5qcy5tYXAK",import.meta.url))}const l=new g(A,{workerData:I.workerData});return new xI(l)}sendRequest(I,g={}){const C=this._nextId++,A=vI(I),l={type:"request",id:C,payload:A};return new Promise((I,A)=>{let Z;g.timeout&&(Z=setTimeout(()=>{this._pending.delete(C),A(new Error(`Worker request timed out after ${g.timeout}ms`))},g.timeout)),this._pending.set(C,{resolve:I,reject:A,timeoutHandle:Z}),this._post(l)})}async terminate(){this._terminating=!0;for(const[I,g]of this._pending.entries())clearTimeout(g.timeoutHandle);this._pending.clear(),await this._terminateImpl()}_handleMessage(I){const g=I?.data??I;if(g){if("response"===g.type){const I=this._pending.get(g.id);if(!I)return;if(this._pending.delete(g.id),clearTimeout(I.timeoutHandle),g.success){const C=zI(g.result);I.resolve(C)}else{const C=new Error(g.error?.message||"Worker error");g.error?.name&&(C.name=g.error.name),g.error?.stack&&(C.stack=g.error.stack),g.error?.code&&(C.code=g.error.code),g.error?.$err&&(C.$err=g.error.$err),I.reject(C)}return}if("event"===g.type){const I=zI(g.payload);this.emit("event",g.event,I)}}}_handleError(I){if(!this._terminating){for(const[g,C]of this._pending.entries())clearTimeout(C.timeoutHandle),C.reject(I);this._pending.clear(),this.emit("error",I)}}_attach(){throw new Error("Not implemented")}_post(){throw new Error("Not implemented")}_terminateImpl(){throw new Error("Not implemented")}}class QI extends rI{constructor(I={}){const g=globalThis.Worker;if(!g)throw new Error("Worker API is not available in this environment");super(new g(I.workerUrl||"/build/micro-mongo-server-worker.js",{type:"module"}))}_attach(){this.worker.onmessage=this._handleMessage,this.worker.onerror=this._handleError}_post(I){this.worker.postMessage(I)}_terminateImpl(){this.worker.terminate()}}class xI extends rI{constructor(I){super(I)}_attach(){this.worker.on("message",this._handleMessage),this.worker.on("error",this._handleError),this.worker.on("exit",I=>{0===I||this._terminating||this._handleError(new Error(`Worker stopped with exit code ${I}`))})}_post(I){this.worker.postMessage(I)}_terminateImpl(){return this.worker.terminate()}}const UI=/* @__PURE__ */Object.freeze(/* @__PURE__ */Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));export{u as BadValueError,a as BulkWriteError,W as CannotCreateIndexError,kI as ChangeStream,Y as CursorError,y as CursorNotFoundError,c as DuplicateKeyError,A as ErrorCodes,i as IndexError,m as IndexExistsError,B as IndexNotFoundError,h as InvalidNamespaceError,N as MongoClient,G as MongoDriverError,l as MongoError,H as MongoNetworkError,Z as MongoServerError,X as NamespaceError,s as NamespaceNotFoundError,K as NotImplementedError,F as ObjectId,R as OperationNotSupportedError,V as QueryError,o as TypeMismatchError,d as ValidationError,rI as WorkerBridge,b as WriteError};
//# sourceMappingURL=micro-mongo-client.min.js.map
