var e,t={exports:{}};var n=function(){if(e)return t.exports;e=1;var n,r="object"==typeof Reflect?Reflect:null,i=r&&"function"==typeof r.apply?r.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};n=r&&"function"==typeof r.ownKeys?r.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var s=Number.isNaN||function(e){return e!=e};function o(){o.init.call(this)}t.exports=o,t.exports.once=function(e,t){return new Promise(function(n,r){function i(n){e.removeListener(t,s),r(n)}function s(){"function"==typeof e.removeListener&&e.removeListener("error",i),n([].slice.call(arguments))}m(e,t,s,{once:!0}),"error"!==t&&function(e,t,n){"function"==typeof e.on&&m(e,"error",t,n)}(e,i,{once:!0})})},o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var a=10;function l(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function c(e){return void 0===e._maxListeners?o.defaultMaxListeners:e._maxListeners}function u(e,t,n,r){var i,s,o,a;if(l(n),void 0===(s=e._events)?(s=e._events=/* @__PURE__ */Object.create(null),e._eventsCount=0):(void 0!==s.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),s=e._events),o=s[t]),void 0===o)o=s[t]=n,++e._eventsCount;else if("function"==typeof o?o=s[t]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),(i=c(e))>0&&o.length>i&&!o.warned){o.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=o.length,a=u,console&&console.warn&&console.warn(a)}return e}function h(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function d(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=h.bind(r);return i.listener=n,r.wrapFn=i,i}function f(e,t,n){var r=e._events;if(void 0===r)return[];var i=r[t];return void 0===i?[]:"function"==typeof i?n?[i.listener||i]:[i]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(i):g(i,i.length)}function p(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function g(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}function m(e,t,n,r){if("function"==typeof e.on)r.once?e.once(t,n):e.on(t,n);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,function i(s){r.once&&e.removeEventListener(t,i),n(s)})}}return Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return a},set:function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");a=e}}),o.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=/* @__PURE__ */Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},o.prototype.getMaxListeners=function(){return c(this)},o.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var r="error"===e,s=this._events;if(void 0!==s)r=r&&void 0===s.error;else if(!r)return!1;if(r){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var l=s[e];if(void 0===l)return!1;if("function"==typeof l)i(l,this,t);else{var c=l.length,u=g(l,c);for(n=0;n<c;++n)i(u[n],this,t)}return!0},o.prototype.addListener=function(e,t){return u(this,e,t,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(e,t){return u(this,e,t,!0)},o.prototype.once=function(e,t){return l(t),this.on(e,d(this,e,t)),this},o.prototype.prependOnceListener=function(e,t){return l(t),this.prependListener(e,d(this,e,t)),this},o.prototype.removeListener=function(e,t){var n,r,i,s,o;if(l(t),void 0===(r=this._events))return this;if(void 0===(n=r[e]))return this;if(n===t||n.listener===t)0===--this._eventsCount?this._events=/* @__PURE__ */Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,s=n.length-1;s>=0;s--)if(n[s]===t||n[s].listener===t){o=n[s].listener,i=s;break}if(i<0)return this;0===i?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,i),1===n.length&&(r[e]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",e,o||t)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(e){var t,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=/* @__PURE__ */Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0===--this._eventsCount?this._events=/* @__PURE__ */Object.create(null):delete n[e]),this;if(0===arguments.length){var i,s=Object.keys(n);for(r=0;r<s.length;++r)"removeListener"!==(i=s[r])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=/* @__PURE__ */Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},o.prototype.listeners=function(e){return f(this,e,!0)},o.prototype.rawListeners=function(e){return f(this,e,!1)},o.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):p.call(e,t)},o.prototype.listenerCount=p,o.prototype.eventNames=function(){return this._eventsCount>0?n(this._events):[]},t.exports}();class r{constructor(e){if(null==e)this.id=r.generate();else if("string"==typeof e){if(!r.isValid(e))throw new Error(`Argument passed in must be a string of 24 hex characters, got: ${e}`);this.id=e.toLowerCase()}else if(e instanceof Uint8Array&&12===e.length)this.id=Array.from(e).map(e=>e.toString(16).padStart(2,"0")).join("");else{if(!(e instanceof r))throw new Error("Argument passed in must be a string of 24 hex characters or an ObjectId");this.id=e.id}}toString(){return this.id}toHexString(){return this.id}getTimestamp(){const e=parseInt(this.id.substring(0,8),16);return new Date(1e3*e)}equals(e){if(!(e instanceof r))throw new Error("Can only compare with another ObjectId");return this.id===e.id}compare(e){if(!(e instanceof r))throw new Error("Can only compare with another ObjectId");return this.id.localeCompare(e.id)}toJSON(){return this.id}inspect(){return`ObjectId("${this.id}")`}toBytes(){const e=new Uint8Array(12);for(let t=0;t<12;t++)e[t]=parseInt(this.id.substring(2*t,2*t+2),16);return e}static isValid(e){return!!e&&("string"==typeof e&&(24===e.length&&/^[0-9a-fA-F]{24}$/.test(e)))}static createFromTime(e){const t=("00000000"+Math.floor(e/1e3).toString(16)).slice(-8);return new r(t+"0000000000000000")}static generate(){const e=Math.floor(Date.now()/1e3),t="undefined"!=typeof crypto&&crypto.getRandomValues?new Uint8Array(8):null;let n="";if(t){crypto.getRandomValues(t);for(let e=0;e<t.length;e++)n+=("0"+t[e].toString(16)).slice(-2)}else n=Math.random().toString(16).slice(2).padEnd(8,"0").slice(0,8)+Math.random().toString(16).slice(2).padEnd(8,"0").slice(0,8);return(("00000000"+e.toString(16)).slice(-8)+n).slice(0,24)}}function i(e,t){return e instanceof r||t instanceof r?e instanceof r&&t instanceof r||e instanceof r&&"string"==typeof t?e.equals(t):t instanceof r&&"string"==typeof e&&t.equals(e):e==t}function s(e){if(e instanceof r)return new r(e.id);var t,n,i;for(i in t=Array.isArray(e)?[]:{},e)n=e[i],t[i]="object"==typeof n&&null!==n?s(n):n;return t}function o(e,t){for(var n=t.split("."),r=e[n[0]],i=1;i<n.length;i++){if(null==r||null==r)return r;var s=n[i],o=parseInt(s,10);r=c(r)&&!isNaN(o)&&o>=0&&o<r.length?r[o]:r[s]}return r}function a(e,t){for(var n=t.split("."),r=[e],i=0;i<n.length;i++){for(var s=n[i],o=parseInt(s,10),a=[],l=0;l<r.length;l++){var u=r[l];if(null!=u&&null!=u)if(c(u)&&!isNaN(o)&&o>=0)o<u.length&&a.push(u[o]);else if(c(u))for(var h=0;h<u.length;h++)null!=u[h]&&null!=u[h]&&"object"==typeof u[h]&&a.push(u[h][s]);else"object"==typeof u&&a.push(u[s])}r=a}if(0!==(r=r.filter(function(e){return void 0!==e})).length)return 1===r.length?r[0]:r}function l(e,t,n){if(-1!==t.indexOf("$[]"))return function(e,t,n){for(var r=t.split("."),i=e,s=0;s<r.length;s++){var o=r[s];if("$[]"===o){if(!Array.isArray(i))throw new Error("The positional operator did not find the match needed from the query.");for(var a=r.slice(s+1).join("."),u=0;u<i.length;u++)a?l(i[u],a,n):i[u]=n;return}var h=parseInt(o,10);if(c(i)&&!isNaN(h)&&h>=0)i=i[h];else{if(null==i[o]||null==i[o]){var d=s+1<r.length?r[s+1]:null;if("$[]"===d)i[o]=[];else{var f=parseInt(d,10);!isNaN(f)&&f>=0?i[o]=[]:i[o]={}}}i=i[o]}}}(e,t,n);for(var r=t.split("."),i=e,s=0;s<r.length-1;s++){var o=r[s],a=parseInt(o,10);if(c(i)&&!isNaN(a)&&a>=0){for(;i.length<=a;)i.push(void 0);if(null==i[a]||null==i[a]){var u=r[s+1],h=parseInt(u,10);!isNaN(h)&&h>=0?i[a]=[]:i[a]={}}i=i[a]}else{if(null==i[o]||null==i[o]){u=r[s+1],h=parseInt(u,10);!isNaN(h)&&h>=0?i[o]=[]:i[o]={}}i=i[o]}}var d=r[r.length-1],f=parseInt(d,10);if(c(i)&&!isNaN(f)&&f>=0){for(;i.length<=f;)i.push(void 0);i[f]=n}else i[d]=n}function c(e){return Array==e.constructor}function u(e){var t=[];for(var n in e)if(e.hasOwnProperty(n)){var r={};r[n]=e[n],t.push(r)}return t}function h(e,t){for(var n=0;n<t.length;n++)if(i(t[n],e))return!0;return!1}function d(e,t){if(e.length!=t.length)return!1;for(var n=0;n<e.length;n++)if(!i(e[n],t[n])){if(typeof e[n]!=typeof t[n])return!1;if("object"==typeof e[n]&&null!==e[n]){if(c(e[n])){if(!d(e[n],t[n]))return!1}else if(!f(e[n],t[n]))return!1}else if(!i(e[n],t[n]))return!1}return!0}function f(e,t){for(var n in e)if(e.hasOwnProperty(n)){if(!t.hasOwnProperty(n))return!1;if(!i(e[n],t[n])){if(typeof e[n]!=typeof t[n])return!1;if("object"==typeof e[n]&&null!==e[n]){if(c(e[n])){if(!d(e[n],t[n]))return!1}else if(!f(e[n],t[n]))return!1}else if(!i(e[n],t[n]))return!1}}for(var n in t)if(t.hasOwnProperty(n)&&!e.hasOwnProperty(n))return!1;return!0}function p(e,t){var n={},r=Object.keys(e);if(0==r.length)return t;for(var i=!1,a=!1,u=0;u<r.length;u++)"_id"!==r[u]&&(e[r[u]]?i=!0:a=!0);if(i&&a)throw{$err:"Can't canonicalize query: BadValue Projection cannot have a mix of inclusion and exclusion.",code:17287};if(e[r[0]]||i){0!==e._id&&(n._id=t._id);for(u=0;u<r.length;u++)if("_id"!==r[u]&&e[r[u]]){var h=o(t,p=r[u]);void 0!==h&&l(n,p,h)}}else{for(var d in t)if(t.hasOwnProperty(d)){var f=t[d];"object"!=typeof f||null===f||c(f)?c(f)?n[d]=f.slice():n[d]=f:n[d]=s(f)}for(u=0;u<r.length;u++)if(!e[r[u]]){var p,g=(p=r[u]).split(".");if(1===g.length)delete n[p];else{for(var m=n,y=0;y<g.length-1&&(null!=m&&null!=m);y++)m=m[g[y]];null!=m&&null!=m&&delete m[g[g.length-1]]}}}return n}const g={OK:0,INTERNAL_ERROR:1,BAD_VALUE:2,NO_SUCH_KEY:4,GRAPH_CONTAINS_CYCLE:5,HOST_UNREACHABLE:6,HOST_NOT_FOUND:7,UNKNOWN_ERROR:8,FAILED_TO_PARSE:17287,CANNOT_MUTATE_OBJECT:10,USER_NOT_FOUND:11,UNSUPPORTED_FORMAT:12,UNAUTHORIZED:13,TYPE_MISMATCH:14,OVERFLOW:15,INVALID_LENGTH:16,PROTOCOL_ERROR:17,AUTHENTICATION_FAILED:18,ILLEGAL_OPERATION:20,NAMESPACE_NOT_FOUND:26,INDEX_NOT_FOUND:27,PATH_NOT_VIABLE:28,CANNOT_CREATE_INDEX:67,INDEX_ALREADY_EXISTS:68,INDEX_EXISTS:68,COMMAND_NOT_FOUND:59,NAMESPACE_EXISTS:48,INVALID_NAMESPACE:73,INDEX_OPTIONS_CONFLICT:85,INVALID_INDEX_SPECIFICATION_OPTION:197,WRITE_CONFLICT:112,DUPLICATE_KEY:11e3,DUPLICATE_KEY_UPDATE:11001,DOCUMENT_VALIDATION_FAILURE:121,BAD_QUERY:2,CANNOT_INDEX_PARALLEL_ARRAYS:171,CURSOR_NOT_FOUND:43,COLLECTION_IS_EMPTY:26,NOT_IMPLEMENTED:999,OPERATION_NOT_SUPPORTED:998};class m extends Error{constructor(e,t={}){super(e),this.name="MongoError",this.code=t.code||g.UNKNOWN_ERROR,this.codeName=this._getCodeName(this.code),this.$err=e,t.collection&&(this.collection=t.collection),t.database&&(this.database=t.database),t.operation&&(this.operation=t.operation),t.query&&(this.query=t.query),t.document&&(this.document=t.document),t.field&&(this.field=t.field),t.index&&(this.index=t.index),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}_getCodeName(e){return{0:"OK",1:"InternalError",2:"BadValue",4:"NoSuchKey",5:"GraphContainsCycle",6:"HostUnreachable",7:"HostNotFound",8:"UnknownError",10:"CannotMutateObject",11:"UserNotFound",12:"UnsupportedFormat",13:"Unauthorized",14:"TypeMismatch",15:"Overflow",16:"InvalidLength",17:"ProtocolError",18:"AuthenticationFailed",20:"IllegalOperation",26:"NamespaceNotFound",27:"IndexNotFound",28:"PathNotViable",43:"CursorNotFound",48:"NamespaceExists",59:"CommandNotFound",67:"CannotCreateIndex",68:"IndexExists",73:"InvalidNamespace",85:"IndexOptionsConflict",112:"WriteConflict",121:"DocumentValidationFailure",171:"CannotIndexParallelArrays",197:"InvalidIndexSpecificationOption",998:"OperationNotSupported",999:"NotImplemented",11e3:"DuplicateKey",11001:"DuplicateKeyUpdate",17287:"FailedToParse"}[e]||"UnknownError"}toJSON(){const e={name:this.name,message:this.message,code:this.code,codeName:this.codeName};return this.collection&&(e.collection=this.collection),this.database&&(e.database=this.database),this.operation&&(e.operation=this.operation),this.index&&(e.index=this.index),this.indexName&&(e.indexName=this.indexName),this.field&&(e.field=this.field),this.query&&(e.query=this.query),this.document&&(e.document=this.document),this.namespace&&(e.namespace=this.namespace),this.cursorId&&(e.cursorId=this.cursorId),this.feature&&(e.feature=this.feature),this.keyPattern&&(e.keyPattern=this.keyPattern),this.keyValue&&(e.keyValue=this.keyValue),this.writeErrors&&(e.writeErrors=this.writeErrors),e}}class y extends m{constructor(e,t={}){super(e,t),this.name="MongoServerError"}}class x extends m{constructor(e,t={}){super(e,t),this.name="MongoDriverError",this.code=t.code||g.INTERNAL_ERROR}}class b extends m{constructor(e,t={}){super(e,t),this.name="WriteError",this.code=t.code||g.WRITE_CONFLICT}}class _ extends b{constructor(e,t={}){const n=JSON.stringify(e);super(`E11000 duplicate key error${t.collection?` collection: ${t.collection}`:""} index: ${n} dup key: ${n}`,{...t,code:g.DUPLICATE_KEY}),this.name="DuplicateKeyError",this.keyPattern=e,this.keyValue=t.keyValue||e}}class w extends m{constructor(e,t={}){super(e,t),this.name="ValidationError",this.code=t.code||g.DOCUMENT_VALIDATION_FAILURE,this.validationErrors=t.validationErrors||[]}}class v extends m{constructor(e,t={}){super(e,t),this.name="IndexError"}}class $ extends v{constructor(e,t={}){super(`Index with name '${e}' already exists`,{...t,code:g.INDEX_EXISTS}),this.name="IndexExistsError",this.indexName=e}}class S extends v{constructor(e,t={}){super(`Index '${e}' not found`,{...t,code:g.INDEX_NOT_FOUND,index:e}),this.name="IndexNotFoundError",this.indexName=e}}class N extends v{constructor(e,t={}){super(`Cannot create index: ${e}`,{...t,code:g.CANNOT_CREATE_INDEX}),this.name="CannotCreateIndexError"}}class A extends m{constructor(e,t={}){super(e,t),this.name="QueryError",this.code=t.code||g.BAD_QUERY}}class E extends m{constructor(e,t,n,r={}){super(`Type mismatch for field '${e}': expected ${t}, got ${n}`,{...r,code:g.TYPE_MISMATCH,field:e}),this.name="TypeMismatchError",this.expectedType=t,this.actualType=n}}class O extends m{constructor(e,t={}){super(e,t),this.name="NamespaceError"}}class I extends O{constructor(e,t={}){super(`Namespace '${e}' not found`,{...t,code:g.NAMESPACE_NOT_FOUND}),this.name="NamespaceNotFoundError",this.namespace=e}}class C extends O{constructor(e,t,n={}){"object"!=typeof t||n||(n=t,t=void 0);super(t?`Invalid namespace '${e}': ${t}`:`Invalid namespace '${e}'`,{...n,code:g.INVALID_NAMESPACE}),this.name="InvalidNamespaceError",this.namespace=e}}class k extends m{constructor(e,t={}){super(e,t),this.name="CursorError"}}class M extends k{constructor(e,t={}){super(`Cursor ${e} not found`,{...t,code:g.CURSOR_NOT_FOUND}),this.name="CursorNotFoundError",this.cursorId=e}}class L extends m{constructor(e,t={}){super(`${e} is not implemented in micro-mongo`,{...t,code:g.NOT_IMPLEMENTED}),this.name="NotImplementedError",this.feature=e}}class D extends m{constructor(e,t,n={}){"object"!=typeof t||n||(n=t,t=void 0);super(t?`Operation '${e}' is not supported: ${t}`:`Operation '${e}' is not supported`,{...n,code:g.OPERATION_NOT_SUPPORTED,operation:e}),this.name="OperationNotSupportedError"}}class T extends m{constructor(e,t,n,r={}){super(`Bad value for field '${e}': ${n}`,{...r,code:g.BAD_VALUE,field:e}),this.name="BadValueError",this.value=t}}class j extends m{constructor(e=[],t={}){super(`Bulk write operation error: ${e.length} error(s)`,t),this.name="BulkWriteError",this.writeErrors=e,this.code=t.code||g.WRITE_CONFLICT}}class P extends m{constructor(e,t={}){super(e,t),this.name="MongoNetworkError",this.code=t.code||g.HOST_UNREACHABLE}}class F{constructor(e,t,n,r,i){if(this.collection=e,this.query=t,this.projection=n,this.documents=r,this.SortedCursor=i,n&&Object.keys(n).length>0){const t=Object.keys(n);let r=!1,i=!1;for(let e=0;e<t.length;e++)"_id"!==t[e]&&(n[t[e]]?r=!0:i=!0);if(r&&i)throw new A("Can't canonicalize query: BadValue Projection cannot have a mix of inclusion and exclusion.",{code:g.FAILED_TO_PARSE,collection:e.name})}this.pos=0,this._limit=0,this._skip=0,this._closed=!1}batchSize(e){return this._batchSize=e,this}close(){this._closed=!0,this.pos=this.documents.length}comment(e){return this._comment=e,this}count(){return this.documents.length}explain(e="queryPlanner"){return{queryPlanner:{plannerVersion:1,namespace:`${this.collection.db?.name||"db"}.${this.collection.name}`,indexFilterSet:!1,parsedQuery:this.query,winningPlan:{stage:"COLLSCAN",filter:this.query,direction:"forward"}},executionStats:"executionStats"===e||"allPlansExecution"===e?{executionSuccess:!0,nReturned:this.documents.length,executionTimeMillis:0,totalKeysExamined:0,totalDocsExamined:this.documents.length}:void 0,ok:1}}async forEach(e){for(;this.hasNext();)await e(this.next())}hasNext(){if(this._closed)return!1;let e;return e=this._limit>0?Math.min(this._skip+this._limit,this.documents.length):this.documents.length,this.pos<e}hint(e){return this._hint=e,this}itcount(){let e=0;for(;this.hasNext();)this.next(),e++;return e}limit(e){return this._limit=e,this}map(e){const t=[];for(;this.hasNext();)t.push(e(this.next()));return t}maxScan(e){return this._maxScan=e,this}maxTimeMS(e){return this._maxTimeMS=e,this}max(e){return this._maxIndexBounds=e,this}min(e){return this._minIndexBounds=e,this}next(){if(!this.hasNext())throw new A("Error: error hasNext: false",{collection:this.collection.name});const e=this.documents[this.pos++];return this.projection?p(this.projection,e):e}noCursorTimeout(){return this._noCursorTimeout=!0,this}objsLeftInBatch(){return this.size()}pretty(){return this._pretty=!0,this}readConcern(e){return this._readConcern=e,this}readPref(e,t){return this._readPref={mode:e,tagSet:t},this}returnKey(e=!0){return this._returnKey=e,this}showRecordId(e=!0){return this._showRecordId=e,this}size(){const e=this.documents.length-this.pos;if(this._limit>0){const t=this._skip+this._limit;return Math.min(t-this.pos,e)}return e}skip(e){return this._skip=e,0===this.pos&&(this.pos=Math.min(e,this.documents.length)),this}isClosed(){return!0===this._closed}snapshot(){throw new L("snapshot")}sort(e){return new this.SortedCursor(this.collection,this.query,this,e)}allowDiskUse(e=!0){return this._allowDiskUse=e,this}collation(e){return this._collation=e,this}tailable(){throw new L("tailable")}async toArray(){const e=[];for(;this.hasNext();)e.push(this.next());return e}async*[Symbol.asyncIterator](){for(;this.hasNext();)yield this.next()}}class R{constructor(e,t,n,r){for(this.collection=e,this.query=t,this.sortSpec=r,this.pos=0,this.items=[];n.hasNext();)this.items.push(n.next());const i=Object.keys(r);this.items.sort(function(e,t){for(let n=0;n<i.length;n++){if(null==e[i[n]]&&null!=t[i[n]])return-1*r[i[n]];if(null!=e[i[n]]&&null==t[i[n]])return 1*r[i[n]];if(e[i[n]]<t[i[n]])return-1*r[i[n]];if(e[i[n]]>t[i[n]])return 1*r[i[n]]}return 0})}batchSize(){throw"Not Implemented"}close(){throw"Not Implemented"}comment(){throw"Not Implemented"}count(){return this.items.length}explain(){throw"Not Implemented"}async forEach(e){for(;this.hasNext();)await e(this.next())}hasNext(){return this.pos<this.items.length}hint(){throw"Not Implemented"}itcount(){throw"Not Implemented"}limit(e){return this.items=this.items.slice(0,e),this}map(e){const t=[];for(;this.hasNext();)t.push(e(this.next()));return t}maxScan(){throw"Not Implemented"}maxTimeMS(){throw"Not Implemented"}max(){throw"Not Implemented"}min(){throw"Not Implemented"}next(){return this.items[this.pos++]}noCursorTimeout(){throw"Not Implemented"}objsLeftInBatch(){throw"Not Implemented"}pretty(){throw"Not Implemented"}readConcern(){throw"Not Implemented"}readPref(){throw"Not Implemented"}returnKey(){throw"Not Implemented"}showRecordId(){throw"Not Implemented"}size(){throw"Not Implemented"}skip(e){for(;e>0;)this.next(),e--;return this}snapshot(){throw"Not Implemented"}sort(e){return new R(this.collection,this.query,this,e)}tailable(){throw"Not Implemented"}async toArray(){const e=[];for(;this.hasNext();)e.push(this.next());return e}async*[Symbol.asyncIterator](){for(;this.hasNext();)yield this.next()}}const B={ational:"ate",tional:"tion",enci:"ence",anci:"ance",izer:"ize",bli:"ble",alli:"al",entli:"ent",eli:"e",ousli:"ous",ization:"ize",ation:"ate",ator:"ate",alism:"al",iveness:"ive",fulness:"ful",ousness:"ous",aliti:"al",iviti:"ive",biliti:"ble",logi:"log"},U={icate:"ic",ative:"",alize:"al",iciti:"ic",ical:"ic",ful:"",ness:""},z="[aeiouy]",q="([^aeiou][^aeiouy]*)",K="("+z+"[aeiou]*)",W=new RegExp("^"+q+"?"+K+q),V=new RegExp("^"+q+"?"+K+q+K+"?$"),Q=new RegExp("^"+q+"?("+K+q+"){2,}"),J=new RegExp("^"+q+"?"+z),H=new RegExp("^"+q+z+"[^aeiouwxy]$"),G=/ll$/,Y=/^(.+?)e$/,X=/^(.+?)y$/,Z=/^(.+?(s|t))(ion)$/,ee=/^(.+?)(ed|ing)$/,te=/(at|bl|iz)$/,ne=/^(.+?)eed$/,re=/^.+?[^s]s$/,ie=/^.+?(ss|i)es$/,se=/([^aeiouylsz])\1$/,oe=/^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$/,ae=/^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/,le=/^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$/;function ce(e){let t=String(e).toLowerCase();if(t.length<3)return t;let n,r=!1;return 121===t.codePointAt(0)&&(r=!0,t="Y"+t.slice(1)),ie.test(t)?t=t.slice(0,-2):re.test(t)&&(t=t.slice(0,-1)),(n=ne.exec(t))?W.test(n[1])&&(t=t.slice(0,-1)):(n=ee.exec(t))&&J.test(n[1])&&(t=n[1],te.test(t)?t+="e":se.test(t)?t=t.slice(0,-1):H.test(t)&&(t+="e")),(n=X.exec(t))&&J.test(n[1])&&(t=n[1]+"i"),(n=oe.exec(t))&&W.test(n[1])&&(t=n[1]+B[n[2]]),(n=ae.exec(t))&&W.test(n[1])&&(t=n[1]+U[n[2]]),(n=le.exec(t))?Q.test(n[1])&&(t=n[1]):(n=Z.exec(t))&&Q.test(n[1])&&(t=n[1]),(n=Y.exec(t))&&(Q.test(n[1])||V.test(n[1])&&!H.test(n[1]))&&(t=n[1]),G.test(t)&&Q.test(t)&&(t=t.slice(0,-1)),r&&(t="y"+t.slice(1)),t}class ue{constructor(e){if(this._meta=/* @__PURE__ */new Map,this._data=/* @__PURE__ */new Map,e)for(const[t,n]of Object.entries(e))this._meta.set(t,n)}setMeta(e,t){this._meta.set(e,t)}hasMeta(e){return this._meta.has(e)}getMeta(e){return this._meta.get(e)}hasDataMap(e){return this._data.has(e)}getDataMap(e){return this._data.has(e)||this._data.set(e,/* @__PURE__ */new Map),this._data.get(e)}}const he=/* @__PURE__ */new Set(["a","about","after","all","also","am","an","and","another","any","are","around","as","at","be","because","been","before","being","between","both","but","by","came","can","come","could","did","do","each","for","from","get","got","has","had","he","have","her","here","him","himself","his","how","i","if","in","into","is","it","like","make","many","me","might","more","most","much","must","my","never","now","of","on","only","or","other","our","out","over","said","same","see","should","since","some","still","such","take","than","that","the","their","them","then","there","these","they","this","those","through","to","too","under","up","very","was","way","we","well","were","what","where","which","while","who","with","would","you","your"]);class de{constructor(e=new ue){this.storage=e,this.index=this.storage.getDataMap("index"),this.documentTerms=this.storage.getDataMap("documentTerms"),this.documentLengths=this.storage.getDataMap("documentLengths")}_tokenize(e){if("string"!=typeof e)return[];return e.toLowerCase().split(/\W+/).filter(e=>e.length>0).filter(e=>!he.has(e))}add(e,t){if(!e)throw new Error("Document ID is required");const n=this._tokenize(t),r=/* @__PURE__ */new Map;n.forEach(e=>{const t=ce(e);r.set(t,(r.get(t)||0)+1)}),r.forEach((t,n)=>{this.index.has(n)||this.index.set(n,/* @__PURE__ */new Map),this.index.get(n).set(e,t)}),this.documentTerms.set(e,r),this.documentLengths.set(e,n.length)}remove(e){if(!this.documentTerms.has(e))return!1;return this.documentTerms.get(e).forEach((t,n)=>{this.index.has(n)&&(this.index.get(n).delete(e),0===this.index.get(n).size&&this.index.delete(n))}),this.documentTerms.delete(e),this.documentLengths.delete(e),!0}query(e,t={scored:!0,requireAll:!1}){const n=this._tokenize(e);if(0===n.length)return[];const r=n.map(e=>ce(e)),i=[...new Set(r)];if(t.requireAll){const e=i.map(e=>{const t=this.index.get(e);return t?new Set(t.keys()):/* @__PURE__ */new Set});if(0===e.length)return[];const t=new Set(e[0]);for(let n=1;n<e.length;n++)for(const r of t)e[n].has(r)||t.delete(r);return Array.from(t)}const s=this.documentLengths.size,o=/* @__PURE__ */new Map;i.forEach(e=>{const t=this.index.get(e)?.size||0;t>0&&o.set(e,Math.log(s/t))});const a=/* @__PURE__ */new Map;i.forEach(e=>{const t=this.index.get(e);t&&t.forEach((t,n)=>{a.has(n)||a.set(n,0);const r=t/(this.documentLengths.get(n)||1)*(o.get(e)||0);a.set(n,a.get(n)+r)})}),a.forEach((e,t)=>{const n=this.documentTerms.get(t);if(n){const r=i.filter(e=>n.has(e)).length/i.length;a.set(t,e*(1+r))}});const l=Array.from(a.entries()).map(([e,t])=>({id:e,score:t})).sort((e,t)=>t.score-e.score);return!1===t.scored?l.map(e=>e.id):l}getTermCount(){return this.index.size}getDocumentCount(){return this.documentTerms.size}clear(){this.index.clear(),this.documentTerms.clear(),this.documentLengths.clear()}}function fe(e,t){if(null==e)return e;if("boolean"==typeof e||"number"==typeof e)return e;if("string"==typeof e)return e.startsWith("$$")?"$$KEEP"===e||"$$PRUNE"===e||"$$DESCEND"===e?e:o(t,e.substring(2)):"$"===e.charAt(0)?o(t,e.substring(1)):e;if("object"==typeof e){if(Array.isArray(e))return e.map(e=>fe(e,t));const n=Object.keys(e);if(0===n.length)return e;const r=n[0];if("$"===r.charAt(0)){return function(e,t,n){switch(e){case"$add":return function(e,t){if(!Array.isArray(e))return null;let n=0;for(const r of e){const e=fe(r,t);e instanceof Date?n+=e.getTime():"number"==typeof e&&(n+=e)}return n}(t,n);case"$subtract":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=fe(e[0],t),r=fe(e[1],t);if(n instanceof Date&&r instanceof Date)return n.getTime()-r.getTime();if(n instanceof Date&&"number"==typeof r)return new Date(n.getTime()-r);if("number"==typeof n&&"number"==typeof r)return n-r;return null}(t,n);case"$multiply":return function(e,t){if(!Array.isArray(e))return null;let n=1;for(const r of e){const e=fe(r,t);"number"==typeof e&&(n*=e)}return n}(t,n);case"$divide":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=fe(e[0],t),r=fe(e[1],t);if("number"==typeof n&&"number"==typeof r&&0!==r)return n/r;return null}(t,n);case"$mod":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=fe(e[0],t),r=fe(e[1],t);if("number"==typeof n&&"number"==typeof r&&0!==r)return n%r;return null}(t,n);case"$pow":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=fe(e[0],t),r=fe(e[1],t);if("number"==typeof n&&"number"==typeof r)return Math.pow(n,r);return null}(t,n);case"$sqrt":return function(e,t){const n=fe(e,t);if("number"==typeof n&&n>=0)return Math.sqrt(n);return null}(t,n);case"$abs":return function(e,t){const n=fe(e,t);if("number"==typeof n)return Math.abs(n);return null}(t,n);case"$ceil":return function(e,t){const n=fe(e,t);if("number"==typeof n)return Math.ceil(n);return null}(t,n);case"$floor":return function(e,t){const n=fe(e,t);if("number"==typeof n)return Math.floor(n);return null}(t,n);case"$trunc":return function(e,t){const n=fe(e,t);if("number"==typeof n)return Math.trunc(n);return null}(t,n);case"$round":return function(e,t){const n=fe(Array.isArray(e)?e[0]:e,t),r=Array.isArray(e)&&void 0!==e[1]?fe(e[1],t):0;if("number"==typeof n&&"number"==typeof r){const e=Math.pow(10,r);return Math.round(n*e)/e}return null}(t,n);case"$concat":return function(e,t){if(!Array.isArray(e))return null;let n="";for(const r of e){const e=fe(r,t);null!=e&&(n+=String(e))}return n}(t,n);case"$substr":return function(e,t){if(!Array.isArray(e)||e.length<3)return null;const n=String(fe(e[0],t)||""),r=fe(e[1],t),i=fe(e[2],t);if("number"==typeof r&&"number"==typeof i)return n.substr(r,i);return null}(t,n);case"$toLower":return function(e,t){const n=fe(e,t);return null!=n?String(n).toLowerCase():""}(t,n);case"$toUpper":return function(e,t){const n=fe(e,t);return null!=n?String(n).toUpperCase():""}(t,n);case"$trim":return function(e,t){const n=fe("object"==typeof e&&e.input?e.input:e,t),r=e.chars?fe(e.chars,t):null;let i=null!=n?String(n):"";if(r){const e=new RegExp(`^[${pe(r)}]+|[${pe(r)}]+$`,"g");return i.replace(e,"")}return i.trim()}(t,n);case"$ltrim":return function(e,t){const n=fe("object"==typeof e&&e.input?e.input:e,t),r=e.chars?fe(e.chars,t):null;let i=null!=n?String(n):"";if(r){const e=new RegExp(`^[${pe(r)}]+`,"g");return i.replace(e,"")}return i.replace(/^\s+/,"")}(t,n);case"$rtrim":return function(e,t){const n=fe("object"==typeof e&&e.input?e.input:e,t),r=e.chars?fe(e.chars,t):null;let i=null!=n?String(n):"";if(r){const e=new RegExp(`[${pe(r)}]+$`,"g");return i.replace(e,"")}return i.replace(/\s+$/,"")}(t,n);case"$split":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=String(fe(e[0],t)||""),r=String(fe(e[1],t)||"");return n.split(r)}(t,n);case"$strLenCP":return function(e,t){const n=fe(e,t);return null!=n?String(n).length:0}(t,n);case"$strcasecmp":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=String(fe(e[0],t)||"").toLowerCase(),r=String(fe(e[1],t)||"").toLowerCase();return n<r?-1:n>r?1:0}(t,n);case"$indexOfCP":return function(e,t){if(!Array.isArray(e)||e.length<2)return null;const n=String(fe(e[0],t)||""),r=String(fe(e[1],t)||""),i=void 0!==e[2]?fe(e[2],t):0,s=void 0!==e[3]?fe(e[3],t):n.length,o=n.substring(i,s).indexOf(r);return-1===o?-1:o+i}(t,n);case"$replaceOne":return function(e,t){const n=String(fe(e.input,t)||""),r=String(fe(e.find,t)||""),i=String(fe(e.replacement,t)||"");return n.replace(r,i)}(t,n);case"$replaceAll":return function(e,t){const n=String(fe(e.input,t)||""),r=String(fe(e.find,t)||""),i=String(fe(e.replacement,t)||"");return n.split(r).join(i)}(t,n);case"$cmp":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=fe(e[0],t),r=fe(e[1],t);return n<r?-1:n>r?1:0}(t,n);case"$eq":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=fe(e[0],t),r=fe(e[1],t);return n===r}(t,n);case"$ne":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=fe(e[0],t),r=fe(e[1],t);return n!==r}(t,n);case"$gt":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=fe(e[0],t),r=fe(e[1],t);return n>r}(t,n);case"$gte":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=fe(e[0],t),r=fe(e[1],t);return n>=r}(t,n);case"$lt":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=fe(e[0],t),r=fe(e[1],t);return n<r}(t,n);case"$lte":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=fe(e[0],t),r=fe(e[1],t);return n<=r}(t,n);case"$and":return function(e,t){if(!Array.isArray(e))return null;for(const n of e){if(!fe(n,t))return!1}return!0}(t,n);case"$or":return function(e,t){if(!Array.isArray(e))return null;for(const n of e){if(fe(n,t))return!0}return!1}(t,n);case"$not":return function(e,t){const n=fe(Array.isArray(e)?e[0]:e,t);return!n}(t,n);case"$cond":return function(e,t){let n,r,i;if(Array.isArray(e)){if(3!==e.length)return null;[n,r,i]=e}else{if("object"!=typeof e)return null;n=e.if,r=e.then,i=e.else}const s=fe(n,t);return fe(s?r:i,t)}(t,n);case"$ifNull":return function(e,t){if(!Array.isArray(e)||e.length<2)return null;for(let n=0;n<e.length;n++){const r=fe(e[n],t);if(null!=r)return r}return null}(t,n);case"$switch":return function(e,t){if("object"!=typeof e||!Array.isArray(e.branches))return null;for(const n of e.branches){if(fe(n.case,t))return fe(n.then,t)}return void 0!==e.default?fe(e.default,t):null}(t,n);case"$year":return function(e,t){const n=fe(e,t);if(n instanceof Date)return n.getUTCFullYear();return null}(t,n);case"$month":return function(e,t){const n=fe(e,t);if(n instanceof Date)return n.getUTCMonth()+1;return null}(t,n);case"$dayOfMonth":return function(e,t){const n=fe(e,t);if(n instanceof Date)return n.getUTCDate();return null}(t,n);case"$dayOfWeek":return function(e,t){const n=fe(e,t);if(n instanceof Date)return n.getUTCDay()+1;return null}(t,n);case"$dayOfYear":return function(e,t){const n=fe(e,t);if(n instanceof Date){const e=new Date(Date.UTC(n.getUTCFullYear(),0,0)),t=n-e,r=864e5;return Math.floor(t/r)}return null}(t,n);case"$hour":return function(e,t){const n=fe(e,t);if(n instanceof Date)return n.getUTCHours();return null}(t,n);case"$minute":return function(e,t){const n=fe(e,t);if(n instanceof Date)return n.getUTCMinutes();return null}(t,n);case"$second":return function(e,t){const n=fe(e,t);if(n instanceof Date)return n.getUTCSeconds();return null}(t,n);case"$millisecond":return function(e,t){const n=fe(e,t);if(n instanceof Date)return n.getUTCMilliseconds();return null}(t,n);case"$week":return function(e,t){const n=fe(e,t);if(n instanceof Date){const e=new Date(Date.UTC(n.getUTCFullYear(),0,1));return Math.ceil(((n-e)/864e5+e.getUTCDay()+1)/7)-1}return null}(t,n);case"$isoWeek":return function(e,t){const n=fe(e,t);if(n instanceof Date){const e=new Date(n.valueOf()),t=(n.getUTCDay()+6)%7;e.setUTCDate(e.getUTCDate()-t+3);const r=e.valueOf();return e.setUTCMonth(0,1),4!==e.getUTCDay()&&e.setUTCMonth(0,1+(4-e.getUTCDay()+7)%7),1+Math.ceil((r-e)/6048e5)}return null}(t,n);case"$isoWeekYear":return function(e,t){const n=fe(e,t);if(n instanceof Date){const e=new Date(n.valueOf());return e.setUTCDate(e.getUTCDate()-(n.getUTCDay()+6)%7+3),e.getUTCFullYear()}return null}(t,n);case"$dateToString":return function(e,t){const n=e.format?fe(e.format,t):"%Y-%m-%dT%H:%M:%S.%LZ",r=fe(e.date,t);return r instanceof Date?n.replace("%Y",r.getUTCFullYear()).replace("%m",String(r.getUTCMonth()+1).padStart(2,"0")).replace("%d",String(r.getUTCDate()).padStart(2,"0")).replace("%H",String(r.getUTCHours()).padStart(2,"0")).replace("%M",String(r.getUTCMinutes()).padStart(2,"0")).replace("%S",String(r.getUTCSeconds()).padStart(2,"0")).replace("%L",String(r.getUTCMilliseconds()).padStart(3,"0")):null}(t,n);case"$toDate":return function(e,t){const n=fe(e,t);if(n instanceof Date)return n;if("string"==typeof n||"number"==typeof n){const e=new Date(n);return isNaN(e.getTime())?null:e}return null}(t,n);case"$arrayElemAt":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=fe(e[0],t),r=fe(e[1],t);if(!Array.isArray(n)||"number"!=typeof r)return null;const i=r<0?n.length+r:r;return n[i]}(t,n);case"$concatArrays":return function(e,t){if(!Array.isArray(e))return null;const n=[];for(const r of e){const e=fe(r,t);Array.isArray(e)&&n.push(...e)}return n}(t,n);case"$filter":return function(e,t){const n=fe(e.input,t),r=e.as||"this",i=e.cond;return Array.isArray(n)?n.filter(e=>{const n={...t,[r]:e};return fe(i,n)}):null}(t,n);case"$in":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=fe(e[0],t),r=fe(e[1],t);return!!Array.isArray(r)&&r.includes(n)}(t,n);case"$indexOfArray":return function(e,t){if(!Array.isArray(e)||e.length<2)return null;const n=fe(e[0],t),r=fe(e[1],t),i=void 0!==e[2]?fe(e[2],t):0,s=void 0!==e[3]?fe(e[3],t):n.length;if(!Array.isArray(n))return null;for(let o=i;o<s&&o<n.length;o++)if(n[o]===r)return o;return-1}(t,n);case"$isArray":return function(e,t){const n=fe(e,t);return Array.isArray(n)}(t,n);case"$map":return function(e,t){const n=fe(e.input,t),r=e.as||"this",i=e.in;return Array.isArray(n)?n.map(e=>{const n={...t,[r]:e};return fe(i,n)}):null}(t,n);case"$reduce":return function(e,t){const n=fe(e.input,t),r=fe(e.initialValue,t),i=e.in;if(!Array.isArray(n))return null;let s=r;for(const o of n){s=fe(i,{...t,value:s,this:o})}return s}(t,n);case"$size":return function(e,t){const n=fe(e,t);return Array.isArray(n)?n.length:null}(t,n);case"$slice":return function(e,t){if(!Array.isArray(e)||e.length<2)return null;const n=fe(e[0],t);if(!Array.isArray(n))return null;if(2===e.length){const r=fe(e[1],t);return r>=0?n.slice(0,r):n.slice(r)}{const r=fe(e[1],t),i=fe(e[2],t);return n.slice(r,r+i)}}(t,n);case"$reverseArray":return function(e,t){const n=fe(e,t);return Array.isArray(n)?n.slice().reverse():null}(t,n);case"$zip":return function(e,t){const n=e.inputs?fe(e.inputs,t):null,r=e.useLongestLength||!1,i=e.defaults;if(!Array.isArray(n))return null;const s=n.map(e=>fe(e,t));if(!s.every(e=>Array.isArray(e)))return null;const o=Math.max(...s.map(e=>e.length)),a=r?o:Math.min(...s.map(e=>e.length)),l=[];for(let c=0;c<a;c++){const e=[];for(let t=0;t<s.length;t++)c<s[t].length?e.push(s[t][c]):i&&t<i.length?e.push(i[t]):e.push(null);l.push(e)}return l}(t,n);case"$type":return function(e,t){const n=fe(e,t);return null===n?"null":void 0===n?"missing":"boolean"==typeof n?"bool":"number"==typeof n?Number.isInteger(n)?"int":"double":"string"==typeof n?"string":n instanceof Date?"date":Array.isArray(n)?"array":"object"==typeof n?"object":"unknown"}(t,n);case"$convert":return function(e,t){const n=fe(e.input,t),r=e.to,i=e.onError,s=e.onNull;if(null===n)return void 0!==s?fe(s,t):null;try{switch(r){case"double":case"decimal":return parseFloat(n);case"int":case"long":return parseInt(n);case"bool":return Boolean(n);case"string":return String(n);case"date":return new Date(n);default:return n}}catch(o){return void 0!==i?fe(i,t):null}}(t,n);case"$toBool":return function(e,t){const n=fe(e,t);return Boolean(n)}(t,n);case"$toDecimal":return function(e,t){const n=fe(e,t);return parseFloat(n)}(t,n);case"$toDouble":return function(e,t){const n=fe(e,t);return parseFloat(n)}(t,n);case"$toInt":return function(e,t){const n=fe(e,t);return parseInt(n)}(t,n);case"$toLong":return function(e,t){const n=fe(e,t);return parseInt(n)}(t,n);case"$toString":return function(e,t){const n=fe(e,t);return null==n?null:String(n)}(t,n);case"$objectToArray":return function(e,t){const n=fe(e,t);if("object"!=typeof n||null===n||Array.isArray(n))return null;return Object.keys(n).map(e=>({k:e,v:n[e]}))}(t,n);case"$arrayToObject":return function(e,t){const n=fe(e,t);if(!Array.isArray(n))return null;const r={};for(const i of n)Array.isArray(i)&&2===i.length?r[i[0]]=i[1]:"object"==typeof i&&void 0!==i.k&&void 0!==i.v&&(r[i.k]=i.v);return r}(t,n);case"$mergeObjects":return function(e,t){if(!Array.isArray(e))return fe(e,t);const n={};for(const r of e){const e=fe(r,t);"object"!=typeof e||null===e||Array.isArray(e)||Object.assign(n,e)}return n}(t,n);case"$literal":return t;default:throw new Error(`Unsupported aggregation operator: ${e}`)}}(r,e[r],t)}{const r={};for(const i of n)r[i]=fe(e[i],t);return r}}return e}function pe(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}const ge={1:"double",2:"string",3:"object",4:"array",5:"binData",6:"undefined",7:"objectId",8:"bool",9:"date",10:"null",11:"regex",13:"javascript",15:"javascriptWithScope",16:"int",17:"timestamp",18:"long",19:"decimal",127:"maxKey","-1":"minKey"},me=Object.entries(ge).reduce((e,[t,n])=>(e[n]=parseInt(t),e),{});function ye(e,t){if(c(t)){for(let n=0;n<t.length;n++)if(ye(e,t[n]))return!0;return!1}const n="number"==typeof t?t:me[t],i=ge[n]||t;return null===e?"null"===i||10===n:void 0===e?"undefined"===i||6===n:"number"==typeof e?Number.isInteger(e)?"int"===i||16===n:"double"===i||1===n:"string"==typeof e?"string"===i||2===n:"boolean"==typeof e?"bool"===i||8===n:e instanceof Date?"date"===i||9===n:e instanceof r?"objectId"===i||7===n:e instanceof RegExp?"regex"===i||11===n:c(e)?"array"===i||4===n:"object"==typeof e?"object"===i||3===n:typeof e===t}function xe(e){if(c(e)){let t=0;for(let n=0;n<e.length;n++)t|=1<<e[n];return t}return"number"==typeof e?e:0}function be(e,t){if("number"!=typeof e)return!1;const n=xe(t);return(e&n)===n}function _e(e,t){if("number"!=typeof e)return!1;return 0===(e&xe(t))}function we(e,t){if("number"!=typeof e)return!1;return 0!==(e&xe(t))}function ve(e,t){if("number"!=typeof e)return!1;const n=xe(t);return(e&n)!==n}function $e(e,t){if(t.type){const n=c(e)?"array":null===e?"null":typeof e;if(t.type!==n)return!1}if(t.required&&c(t.required))for(let n=0;n<t.required.length;n++)if(!(t.required[n]in e))return!1;if(t.properties)for(const n in t.properties){if(!(n in e))return!1;const r=t.properties[n];if(!$e(e[n],r))return!1}if(void 0!==t.minimum&&"number"==typeof e&&e<t.minimum)return!1;if(void 0!==t.maximum&&"number"==typeof e&&e>t.maximum)return!1;if(void 0!==t.minLength&&"string"==typeof e&&e.length<t.minLength)return!1;if(void 0!==t.maxLength&&"string"==typeof e&&e.length>t.maxLength)return!1;if(t.pattern&&"string"==typeof e){if(!new RegExp(t.pattern).test(e))return!1}return!(t.enum&&c(t.enum)&&!t.enum.includes(e))}function Se(e,t){return e instanceof r&&t instanceof r?e.equals(t):e==t}function Ne(e,t,n){let i=e,s=t;switch(e instanceof r&&(i=e.toString()),t instanceof r&&(s=t.toString()),n){case">":return i>s;case">=":return i>=s;case"<":return i<s;case"<=":return i<=s;default:return!1}}function Ae(e,t){if(void 0===e)return!1;if(null===e)return t(e);if(c(e)){for(var n=0;n<e.length;n++)if(t(e[n]))return!0;return!1}return t(e)}function Ee(e,t){const n=new de;n.add("id",e);return 1===n.query(t,{scored:!1}).length}function Oe(e,t){try{if(!Array.isArray(t)||2!==t.length)return!1;const n=t[0][0],r=t[0][1],i=t[1][0];return Ie(e,n,i,t[1][1],r)}catch(n){return!1}}function Ie(e,t,n,r,i){if(!e)return!1;if("FeatureCollection"===e.type&&e.features&&e.features.length>0){for(const s of e.features)if(s.geometry&&!Ie(s.geometry,t,n,r,i))return!1;return!0}if("Feature"===e.type&&e.geometry)return Ie(e.geometry,t,n,r,i);if("Point"===e.type&&e.coordinates){const[s,o]=e.coordinates;if("number"==typeof s&&"number"==typeof o)return s>=t&&s<=n&&o>=r&&o<=i}if("Polygon"===e.type&&e.coordinates&&e.coordinates.length>0){for(const s of e.coordinates)for(const e of s){const s=e[0],o=e[1];if(s<t||s>n||o<r||o>i)return!1}return!0}return!1}function Ce(e,t){if("function"==typeof t)try{return t.call(e)}catch(n){return!1}else if("string"==typeof t)try{return new Function("return "+t).call(e)}catch(n){return!1}return!1}function ke(e,t){var n=Object.keys(t)[0],r=t[n];if("$"!=n.charAt(0))return Me(e,n,r);if("$and"==n)return Le(e,r);if("$or"==n)return function(e,t){for(var n=0;n<t.length;n++)if(ke(e,t[n]))return!0;return!1}(e,r);if("$not"==n)return function(e,t){return!ke(e,t)}(e,r);if("$nor"==n)return function(e,t){for(var n=0;n<t.length;n++)if(ke(e,t[n]))return!1;return!0}(e,r);if("$where"==n)return Ce(e,r);if("$comment"==n)return!0;if("$jsonSchema"==n)return $e(e,r);if("$expr"!=n)throw{$err:"Can't canonicalize query: BadValue unknown top level operator: "+n,code:17287};try{return fe(r,e)}catch(i){return!1}}function Me(e,t,n){var i=a(e,t);if("string"==typeof n)return Ae(i,function(e){return Se(e,n)});if("number"==typeof n)return Ae(i,function(e){return Se(e,n)});if("boolean"==typeof n)return Ae(i,function(e){return Se(e,n)});if(n instanceof r)return Ae(i,function(e){return Se(e,n)});if("object"==typeof n){if(n instanceof RegExp)return null!=i&&Ae(i,function(e){return e&&e.match(n)});if(c(n))return null!=i&&Ae(i,function(e){return e&&d(e,n)});var s=Object.keys(n);if("$"==s[0].charAt(0)){for(var l=0;l<s.length;l++){var u=Object.keys(n)[l],p=n[u];if("$eq"==u){if(!Ae(i,function(e){return Se(e,p)}))return!1}else if("$gt"==u){if(!Ae(i,function(e){return Ne(e,p,">")}))return!1}else if("$gte"==u){if(!Ae(i,function(e){return Ne(e,p,">=")}))return!1}else if("$lt"==u){if(!Ae(i,function(e){return Ne(e,p,"<")}))return!1}else if("$lte"==u){if(!Ae(i,function(e){return Ne(e,p,"<=")}))return!1}else if("$ne"==u){if(!Ae(i,function(e){return!Se(e,p)}))return!1}else if("$in"==u){if(!Ae(i,function(e){return h(e,p)}))return!1}else if("$nin"==u){if(Ae(i,function(e){return h(e,p)}))return!1}else if("$exists"==u){var g=o(e,t);if(p?null==g:null!=g)return!1}else if("$type"==u){if(void 0===i){if(6!==("number"==typeof p?p:me[p]))return!1}else if(!ye(i,p))return!1}else if("$mod"==u){if(2!=p.length)throw{$err:"Can't canonicalize query: BadValue malformed mod, not enough elements",code:17287};if(!Ae(i,function(e){return null!=e&&e%p[0]==p[1]}))return!1}else if("$regex"==u){var m=p,y=n.$options||"",x="string"==typeof m?new RegExp(m,y):m;if(!Ae(i,function(e){return null!=e&&x.test(e)}))return!1}else{if("$options"==u)continue;if("$text"==u){if(!Ae(i,function(e){return null!=e&&Ee(e,p)}))return!1}else if("$expr"==u)try{if(!fe(p,e))return!1}catch(I){return!1}else if("$geoWithin"==u){if(!Ae(i,function(e){return null!=e&&Oe(e,p)}))return!1}else if("$near"==u||"$nearSphere"==u||"$geoIntersects"==u);else if("$not"==u){if(Me(e,t,p))return!1}else if("$all"==u){if(null==(_=o(e,t))||!c(_))return!1;for(var b=0;b<p.length;b++)if(!h(p[b],_))return!1}else if("$elemMatch"==u){var _;if(null==(_=o(e,t))||!c(_))return!1;var w=!1;for(b=0;b<_.length;b++){var v=_[b];if("object"!=typeof v||c(v)){for(var $=!0,S=Object.keys(p),N=0;N<S.length;N++){var A=S[N],E=p[A];("$gte"!=A||v>=E)&&("$gt"!=A||v>E)&&("$lte"!=A||v<=E)&&("$lt"!=A||v<E)?"$eq"==A&&v!=E||"$ne"==A&&v==E?$=!1:"$in"!=A||h(v,E)?"$nin"==A&&h(v,E)&&($=!1):$=!1:$=!1}if($){w=!0;break}}else if(De(v,p)){w=!0;break}}if(!w)return!1}else if("$size"==u){var O=o(e,t);if(null==O||!c(O))return!1;if(O.length!=p)return!1}else if("$bitsAllSet"==u){if(!Ae(i,function(e){return be(e,p)}))return!1}else if("$bitsAllClear"==u){if(!Ae(i,function(e){return _e(e,p)}))return!1}else if("$bitsAnySet"==u){if(!Ae(i,function(e){return we(e,p)}))return!1}else{if("$bitsAnyClear"!=u)throw{$err:"Can't canonicalize query: BadValue unknown operator: "+u,code:17287};if(!Ae(i,function(e){return ve(e,p)}))return!1}}}return!0}return o(e,t)&&f(o(e,t),n)}}function Le(e,t){for(var n=0;n<t.length;n++)if(!ke(e,t[n]))return!1;return!0}function De(e,t){return Le(e,u(t))}function Te(e,t){const n={};return{matched:je(e,u(t),n),arrayFilters:n}}function je(e,t,n){for(var r=0;r<t.length;r++)if(!Pe(e,t[r],n))return!1;return!0}function Pe(e,t,n){var i=Object.keys(t)[0],s=t[i];if("$"!=i.charAt(0))return function(e,t,n,i){const s=t.split(".")[0],l=a(e,t),u=(n,r)=>{if(void 0===n)return!1;if(null===n)return r(n);if(c(n)){if(c(o(e,s))){for(var a=0;a<n.length;a++)if(r(n[a]))return i[t]=a,!0;return!1}}return Ae(n,r)};if("string"==typeof n)return u(l,function(e){return Se(e,n)});if("number"==typeof n)return u(l,function(e){return Se(e,n)});if("boolean"==typeof n)return u(l,function(e){return Se(e,n)});if(n instanceof r)return u(l,function(e){return Se(e,n)});if("object"==typeof n){if(n instanceof RegExp)return null!=l&&u(l,function(e){return e&&e.match(n)});if(c(n))return null!=l&&u(l,function(e){return e&&d(e,n)});var p=Object.keys(n);if("$"==p[0].charAt(0)){for(var g=0;g<p.length;g++){var m=p[g],y=n[m];if("$eq"==m){if(!u(l,function(e){return Se(e,y)}))return!1}else if("$gt"==m){if(!u(l,function(e){return Ne(e,y,">")}))return!1}else if("$gte"==m){if(!u(l,function(e){return Ne(e,y,">=")}))return!1}else if("$lt"==m){if(!u(l,function(e){return Ne(e,y,"<")}))return!1}else if("$lte"==m){if(!u(l,function(e){return Ne(e,y,"<=")}))return!1}else if("$ne"==m){if(!u(l,function(e){return!Se(e,y)}))return!1}else if("$in"==m){if(!u(l,function(e){return h(e,y)}))return!1}else if("$nin"==m){if(u(l,function(e){return h(e,y)}))return!1}else{if("$elemMatch"==m){var x=o(e,t);if(null==x||!c(x))return!1;for(var b=0;b<x.length;b++){var _=x[b];if("object"!=typeof _||c(_)){for(var w=!0,v=Object.keys(y),$=0;$<v.length;$++){var S=v[$],N=y[S];("$gte"!=S||_>=N)&&("$gt"!=S||_>N)&&("$lte"!=S||_<=N)&&("$lt"!=S||_<N)?("$eq"==S&&_!=N||"$ne"==S&&_==N)&&(w=!1):w=!1}if(w)return i[t]=b,!0}else if(De(_,y))return i[t]=b,!0}return!1}if(!Me(e,t,n))return!1}}return!0}return null!=l&&u(l,function(e){return f(e,n)})}return!1}(e,i,s,n);if("$and"==i)return je(e,s,n);if("$or"==i)return function(e,t,n){for(var r=0;r<t.length;r++)if(Pe(e,t[r],n))return!0;return!1}(e,s,n);if("$not"==i)return!ke(e,s);if("$nor"==i)return function(e,t,n){for(var r=0;r<t.length;r++)if(Pe(e,t[r],n))return!1;return!0}(e,s,n);if("$where"==i)return Ce(e,s);if("$comment"==i)return!0;if("$jsonSchema"==i)return $e(e,s);if("$expr"!=i)throw{$err:"Can't canonicalize query: BadValue unknown top level operator: "+i,code:17287};try{return fe(s,e)}catch(l){return!1}}class Fe{constructor(e,t){0===arguments.length?(this.low=0,this.high=Math.floor(Date.now()/1e3)):1===arguments.length?"object"==typeof e&&null!==e?(this.low=e.low||0,this.high=e.high||0):(this.low=0,this.high=e):(this.low=e>>>0,this.high=t>>>0)}valueOf(){return 4294967296*this.high+this.low}toString(){return`Timestamp(${this.high}, ${this.low})`}toJSON(){return{$timestamp:{t:this.high,i:this.low}}}inspect(){return this.toString()}equals(e){return!!e&&((e instanceof Fe||"object"==typeof e&&void 0!==e.low&&void 0!==e.high)&&this.low===e.low&&this.high===e.high)}getHighBits(){return this.high}getLowBits(){return this.low}toDate(){return new Date(1e3*this.high)}static fromDate(e){const t=Math.floor(e.getTime()/1e3);return new Fe(0,t)}static now(){return new Fe}}function Re(e){return e.split(".").map(e=>{const t=function(e){const t=e.match(/^\$\[([^\]]+)\]$/);return t?t[1]:null}(e);return{segment:e,isFilteredPositional:null!==t,identifier:t}})}function Be(e,t,n,r,i){!function e(s,o,a){if(o>=t.length)return;const l=t[o],u=o===t.length-1;if(l.isFilteredPositional){const a=l.identifier,h=i?i.find(e=>Object.keys(e).some(e=>e.startsWith(a+".")||e===a)):null;if(!i){if(!s[l.segment]){const e=t[o+1];e&&e.isFilteredPositional?s[l.segment]=[]:s[l.segment]={}}return void(u?Ue(s,l.segment,n,r):e(s[l.segment],o+1))}if(!c(s))return s[l.segment]||(s[l.segment]={}),void(u?Ue(s,l.segment,n,r):e(s[l.segment],o+1));for(let t=0;t<s.length;t++){const i=s[t];let l=!0;if(h){let e={},t=!1;if(Object.keys(h).forEach(n=>{if(n.startsWith(a+".")){const t=n.substring(a.length+1);e[t]=h[n]}else n===a&&(e=h[n],t=!0)}),t){l=De({value:i},{value:e})}else l=De(i,e)}l&&(u?Ue(s,t,n,r):null!=i&&e(s[t],o+1))}}else{if((void 0===s[l.segment]||null===s[l.segment])&&!u){const e=t[o+1];e&&e.isFilteredPositional?s[l.segment]=[]:s[l.segment]={}}u?Ue(s,l.segment,n,r):void 0!==s[l.segment]&&null!==s[l.segment]&&e(s[l.segment],o+1)}}(e,0)}function Ue(e,t,n,r){switch(r){case"$set":default:e[t]=n;break;case"$inc":void 0===e[t]&&(e[t]=0),e[t]+=n;break;case"$mul":e[t]=e[t]*n;break;case"$min":e[t]=Math.min(e[t],n);break;case"$max":e[t]=Math.max(e[t],n);break;case"$unset":delete e[t]}}function ze(e){return/\$\[[^\]]+\]/.test(e)}function qe(e){return-1!==e.indexOf("$[]")}function Ke(e,t,n){for(var r=t.split("."),i=e,s=0;s<r.length;s++){var a=r[s];if("$[]"===a){if(!Array.isArray(i))return;for(var c=r.slice(s+1).join("."),u=0;u<i.length;u++)if(c)if(-1!==c.indexOf("$[]"))Ke(i[u],c,n);else{var h=n(o(i[u],c));l(i[u],c,h)}else i[u]=n(i[u]);return}if(null==i||null==i)return;i=i[a]}}function We(e,t){if(!t||!e.includes("$"))return e;const n=e.split("."),r=n.indexOf("$");if(-1===r)return e;const i=n.slice(0,r).join(".");let s=null;for(const o in t)if(o===i||o.startsWith(i+".")){s=t[o];break}return null!=s?(n[r]=s.toString(),n.join(".")):e}function Ve(e,t,n,r,i){for(var s=Object.keys(e),a=0;a<s.length;a++){var c=s[a],u=e[c];if("$inc"==c)for(var h=Object.keys(u),d=0;d<h.length;d++){var f=We(h[d],r),p=u[h[d]];if(ze(f)){Be(t,Re(f),p,"$inc",i)}else if(qe(f))Ke(t,f,function(e){return(void 0===e?0:e)+p});else{null==(g=o(t,f))&&(g=0),l(t,f,g+p)}}else if("$mul"==c)for(h=Object.keys(u),d=0;d<h.length;d++){f=We(h[d],r),p=u[h[d]];if(ze(f)){Be(t,Re(f),p,"$mul",i)}else if(qe(f))Ke(t,f,function(e){return e*p});else{null==(g=o(t,f))&&(g=0),l(t,f,g*p)}}else if("$rename"==c)for(h=Object.keys(u),d=0;d<h.length;d++){f=We(h[d],r);t[We(u[h[d]],r)]=t[f],delete t[f]}else if("$setOnInsert"==c&&n)for(h=Object.keys(u),d=0;d<h.length;d++){t[f=We(h[d],r)]=u[h[d]]}else if("$set"==c)for(h=Object.keys(u),d=0;d<h.length;d++){if(ze(f=We(h[d],r))){Be(t,Re(f),u[h[d]],"$set",i)}else l(t,f,u[h[d]])}else if("$unset"==c)for(h=Object.keys(u),d=0;d<h.length;d++){delete t[f=We(h[d],r)]}else if("$min"==c)for(h=Object.keys(u),d=0;d<h.length;d++){f=We(h[d],r),p=u[h[d]];if(ze(f)){Be(t,Re(f),p,"$min",i)}else if(qe(f))Ke(t,f,function(e){return Math.min(e,p)});else{var g=o(t,f);l(t,f,Math.min(g,p))}}else if("$max"==c)for(h=Object.keys(u),d=0;d<h.length;d++){f=We(h[d],r),p=u[h[d]];if(ze(f)){Be(t,Re(f),p,"$max",i)}else if(qe(f))Ke(t,f,function(e){return Math.max(e,p)});else{g=o(t,f);l(t,f,Math.max(g,p))}}else if("$currentDate"==c)for(h=Object.keys(u),d=0;d<h.length;d++){f=We(h[d],r);var m=u[h[d]];!0===m||"object"==typeof m&&"date"===m.$type?l(t,f,/* @__PURE__ */new Date):"object"==typeof m&&"timestamp"===m.$type?l(t,f,new Fe):l(t,f,/* @__PURE__ */new Date)}else if("$addToSet"==c)for(h=Object.keys(u),d=0;d<h.length;d++){f=We(h[d],r);var y=u[h[d]];(D=o(t,f))&&Array.isArray(D)&&D.push(y)}else if("$pop"==c)for(h=Object.keys(u),d=0;d<h.length;d++){f=We(h[d],r);var x=u[h[d]];(D=o(t,f))&&Array.isArray(D)&&(1==x?D.pop():-1==x&&D.shift())}else if("$pull"==c)for(h=Object.keys(u),d=0;d<h.length;d++){f=We(h[d],r);var b=u[h[d]];if(null!=(S=o(t,f))&&Array.isArray(S)){for(var _=[],w=0;w<S.length;w++){var v=S[w],$=!1;if("object"!=typeof b||null===b||Array.isArray(b))$=v==b;else if("object"!=typeof v||null===v||Array.isArray(v))$=Me({__temp:v},"__temp",b);else $=De(v,b);$||_.push(v)}l(t,f,_)}}else if("$pullAll"==c)for(h=Object.keys(u),d=0;d<h.length;d++){var S=o(t,f=We(h[d],r)),N=u[h[d]];for(_=[],w=0;w<S.length;w++){for(var A=!1,E=0;E<N.length;E++)if(S[w]==N[E]){A=!0;break}A||_.push(S[w])}l(t,f,_)}else if("$pushAll"==c)for(h=Object.keys(u),d=0;d<h.length;d++){f=We(h[d],r);var O=u[h[d]];if((D=o(t,f))&&Array.isArray(D))for(w=0;w<O.length;w++)D.push(O[w])}else if("$push"==c)for(h=Object.keys(u),d=0;d<h.length;d++){f=We(h[d],r);var I=u[h[d]];if(null!==I&&"object"==typeof I&&(void 0!==I.$each||void 0!==I.$position||void 0!==I.$slice||void 0!==I.$sort)){(D=o(t,f))||l(t,f,D=[]);var C=void 0!==I.$each?I.$each:[I],k=void 0!==I.$position?I.$position:D.length;if(k<0&&(k=Math.max(0,D.length+k)),D.splice(k,0,...C),void 0!==I.$sort){var M=I.$sort;"number"==typeof M?D.sort(function(e,t){return e<t?M>0?-1:1:e>t?M>0?1:-1:0}):"object"==typeof M&&D.sort(function(e,t){for(var n=Object.keys(M),r=0;r<n.length;r++){var i=n[r],s=M[i],a=o(e,i),l=o(t,i);if(a<l)return s>0?-1:1;if(a>l)return s>0?1:-1}return 0})}if(void 0!==I.$slice){var L=I.$slice;if(L<0)l(t,f,D.slice(L));else if(0===L)l(t,f,[]);else{l(t,f,D.slice(0,L))}}}else{var D;(D=o(t,f))&&Array.isArray(D)&&D.push(I)}}else{if("$bit"!=c)throw"unknown update operator: "+c;f=We((h=Object.keys(u))[0],r);var T=u[h[0]],j=Object.keys(T)[0],P=T[j];g=o(t,f);if("and"==j)l(t,f,g&P);else if("or"==j)l(t,f,g|P);else{if("xor"!=j)throw"unknown $bit operator: "+j;l(t,f,g^P)}}}}function Qe(e,t,n){for(var r={_id:n()},i=!0,s=Object.keys(t),o=0;o<s.length;o++)if("$"==s[o].charAt(0)){i=!1;break}if(i)for(o=0;o<s.length;o++)r[s[o]]=t[s[o]];else{var a=Object.keys(e);for(o=0;o<a.length;o++)r[a[o]]=e[a[o]];Ve(t,r,!0)}return r}class Je{constructor(e,t,n,r={}){this.name=e,this.keys=t,this.storage=n,this.options=r}add(e){throw new Error("add() must be implemented by subclass")}remove(e){throw new Error("remove() must be implemented by subclass")}update(e,t){this.remove(e),this.add(t)}query(e){throw new Error("query() must be implemented by subclass")}clear(){throw new Error("clear() must be implemented by subclass")}getSpec(){return{name:this.name,key:this.keys}}serialize(){throw new Error("serialize() must be implemented by subclass")}deserialize(e){throw new Error("deserialize() must be implemented by subclass")}}function He(e){return"string"==typeof e&&""!==e.trim()&&Number.isFinite(+e)}class Ge{constructor(e,t,n){if(!(t instanceof ue))throw new Error("IndexStore is required to create BPlusTreeNode");if("object"==typeof e){this._data=e,this.id=this._data.id,this.keys=this._data.keys,this.values=this._data.values,this.children=[];for(const e of this._data.children){if(n.has(e)){this.children.push(n.get(e));continue}const r=t.getDataMap("nodes").get(e);if(!r)throw new Error(`BPlusTreeNode: Child node with id ${e} not found in IndexStore`);const i=new Ge(r,t,n);this.children.push(i),n.set(e,i)}if(this.isLeaf=this._data.isLeaf,this._data.next)if(n.has(this._data.next))this.next=n.get(this._data.next);else{const e=t.getDataMap("nodes").get(this._data.next);if(!e)throw new Error(`BPlusTreeNode: Next leaf node with id ${this._data.next} not found in IndexStore`);this.next=new Ge(e,t,n),n.set(this.next.id,this.next)}else this.next=null}else this._data={id:t.getMeta("nextId"),keys:[],values:[],children:[],isLeaf:e,next:null},t.setMeta("nextId",this._data.id+1),t.getDataMap("nodes").set(this._data.id,this._data),this.id=this._data.id,this.keys=this._data.keys,this.values=this._data.values,this.children=[],this.isLeaf=this._data.isLeaf,this.next=null;const r=this;return new Proxy(this,{get:(e,n)=>"children"===n?new Proxy(e.children,{get(e,n,i){if(!He(n)){if("length"===n)return Reflect.get(e,n,i);if("splice"===n)return function(...i){if(3==i.length){if(!(i[2]instanceof Ge))throw new Error("BPlusTreeNode: children array can only store BPlusTreeNode instances",i[2]);r._data.children.splice(i[0],i[1],i[2].id),t.getDataMap("nodes").set(r._data.id,r._data)}return Reflect.apply(e[n],e,i)};if("push"===n)return function(...e){if(1!==e.length)throw new Error("BPlusTreeNode: children.push only supports single argument");if(e[0]instanceof Ge)return r._data.children.push(e[0].id),t.getDataMap("nodes").set(r._data.id,r._data),r.children.push(e[0]);throw new Error("BPlusTreeNode: children array can only store BPlusTreeNode instances",e[2])}}return Reflect.get(e,n,i)},set:(e,n,i,s)=>(He(n)&&i instanceof Ge?Reflect.set(r._data.children,n,i.id,s):Reflect.set(r._data.children,n,i,s),t.getDataMap("nodes").set(r._data.id,r._data),Reflect.set(e,n,i,s))}):Reflect.get(e,n),set(e,n,r){if("next"===n)if(r instanceof Ge)e.next=r,e._data.next=r.id,t.getDataMap("nodes").set(e._data.id,e._data);else{if(null!==r)throw new Error("BPlusTreeNode: next pointer must be a BPlusTreeNode or null");e.next=null,e._data.next=null,t.getDataMap("nodes").set(e._data.id,e._data)}else"isLeaf"===n?(e.isLeaf=r,e._data.isLeaf=r,t.getDataMap("nodes").set(e._data.id,e._data)):"children"===n?(e.children=r,e._data.children=r.map(e=>e.id),t.getDataMap("nodes").set(e._data.id,e._data)):(e[n]=r,e._data[n]=r,t.getDataMap("nodes").set(e._data.id,e._data));return!0}})}}class Ye{constructor(e=3,t=new ue){if(e<3)throw new Error("B+ tree order must be at least 3");if(this.order=e,this.minKeys=Math.ceil(e/2)-1,this.indexStore=t,t.hasMeta("order")){if(t.getMeta("order")!==this.order)throw new Error(`B+ tree order does not match stored index metadata ${t.getMeta("order")} != ${this.order}`);if(t.getMeta("minKeys")!=this.minKeys)throw new Error(`B+ tree minKeys does not match stored index metadata ${t.getMeta("minKeys")} != ${this.minKeys}`);this._buildTreeFromStorage()}else this.indexStore.setMeta("order",this.order),this.indexStore.setMeta("minKeys",this.minKeys),this.indexStore.setMeta("nextId",1),this.root=new Ge(!0,this.indexStore),this.indexStore.setMeta("rootId",this.root.id)}_buildTreeFromStorage(){const e=/* @__PURE__ */new Map,t=this.indexStore.getDataMap("nodes").get(this.indexStore.getMeta("rootId"));if(!t)throw new Error("BPlusTree: Root node not found in IndexStore");this.root=new Ge(t,this.indexStore,e)}search(e){return this._searchNode(this.root,e)}_searchNode(e,t){if(e.isLeaf){const n=[];for(let r=0;r<e.keys.length;r++)t===e.keys[r]&&n.push(...e.values[r]);return n}{let n=0;for(;n<e.keys.length&&t>=e.keys[n];)n++;return this._searchNode(e.children[n],t)}}add(e,t){if(this.root.keys.length===this.indexStore.getMeta("order")-1){const e=new Ge(!1,this.indexStore);e.children.push(this.root),this._splitChild(e,0),this.root=e,this.indexStore.setMeta("rootId",this.root.id)}this._insertNonFull(this.root,e,t)}_insertNonFull(e,t,n){let r=e.keys.length-1;if(e.isLeaf){for(let r=0;r<e.keys.length;r++)if(e.keys[r]===t)return void e.values[r].push(n);for(e.keys.push(null),e.values.push(null);r>=0&&t<e.keys[r];)e.keys[r+1]=e.keys[r],e.values[r+1]=e.values[r],r--;e.keys[r+1]=t,e.values[r+1]=[n]}else{for(r=0;r<e.keys.length&&t>=e.keys[r];)r++;e.children[r].keys.length===this.indexStore.getMeta("order")-1&&(this._splitChild(e,r),t>=e.keys[r]&&r++),this._insertNonFull(e.children[r],t,n)}}_splitChild(e,t){const n=e.children[t],r=new Ge(n.isLeaf,this.indexStore),i=Math.floor((this.indexStore.getMeta("order")-1)/2);if(n.isLeaf)r.keys=n.keys.splice(i),r.values=n.values.splice(i),r.next=n.next,n.next=r,e.keys.splice(t,0,r.keys[0]);else{r.keys=n.keys.splice(i+1);const s=n.keys.pop();r.children=n.children.splice(i+1),e.keys.splice(t,0,s)}e.children.splice(t+1,0,r)}deleteValue(e,t){const n=this._deleteValue(this.root,e,t);return 0===this.root.keys.length&&!this.root.isLeaf&&this.root.children.length>0&&(this.root=this.root.children[0],this.indexStore.setMeta("rootId",this.root.id)),n}delete(e){const t=this._delete(this.root,e);return 0===this.root.keys.length&&!this.root.isLeaf&&this.root.children.length>0&&(this.root=this.root.children[0],this.indexStore.setMeta("rootId",this.root.id)),t}_deleteValue(e,t,n){if(e.isLeaf){for(let r=0;r<e.keys.length;r++)if(t===e.keys[r]){const t=e.values[r],i=t.indexOf(n);return-1!==i&&(t.splice(i,1),0===t.length&&(e.keys.splice(r,1),e.values.splice(r,1)),!0)}return!1}{let r=0;for(;r<e.keys.length&&t>=e.keys[r];)r++;const i=this._deleteValue(e.children[r],t,n);return i&&this._rebalanceAfterDelete(e,r),i}}_delete(e,t){if(e.isLeaf){for(let n=0;n<e.keys.length;n++)if(t===e.keys[n])return e.keys.splice(n,1),e.values.splice(n,1),!0;return!1}{let n=0;for(;n<e.keys.length&&t>=e.keys[n];)n++;const r=this._delete(e.children[n],t);return r&&this._rebalanceAfterDelete(e,n),r}}_rebalanceAfterDelete(e,t){if(!(e.children[t].keys.length>=this.indexStore.getMeta("minKeys"))){if(t>0){if(e.children[t-1].keys.length>this.indexStore.getMeta("minKeys"))return void this._borrowFromLeft(e,t)}if(t<e.children.length-1){if(e.children[t+1].keys.length>this.indexStore.getMeta("minKeys"))return void this._borrowFromRight(e,t)}t>0?this._merge(e,t-1):this._merge(e,t)}}_borrowFromLeft(e,t){const n=e.children[t],r=e.children[t-1];n.isLeaf?(n.keys.unshift(r.keys.pop()),n.values.unshift(r.values.pop()),e.keys[t-1]=n.keys[0]):(n.keys.unshift(e.keys[t-1]),e.keys[t-1]=r.keys.pop(),n.children.unshift(r.children.pop()))}_borrowFromRight(e,t){const n=e.children[t],r=e.children[t+1];n.isLeaf?(n.keys.push(r.keys.shift()),n.values.push(r.values.shift()),e.keys[t]=r.keys[0]):(n.keys.push(e.keys[t]),e.keys[t]=r.keys.shift(),n.children.push(r.children.shift()))}_merge(e,t){const n=e.children[t],r=e.children[t+1];n.isLeaf?(n.keys=n.keys.concat(r.keys),n.values=n.values.concat(r.values),n.next=r.next,e.keys.splice(t,1)):(n.keys.push(e.keys[t]),n.keys=n.keys.concat(r.keys),n.children=n.children.concat(r.children),e.keys.splice(t,1)),e.children.splice(t+1,1)}toArray(){const e=[];let t=this._getFirstLeaf(this.root);for(;t;){for(let n=0;n<t.keys.length;n++){const r=t.values[n];for(let i=0;i<r.length;i++)e.push({key:t.keys[n],value:r[i]})}t=t.next}return e}_getFirstLeaf(e){return e.isLeaf?e:this._getFirstLeaf(e.children[0])}size(){let e=0,t=this._getFirstLeaf(this.root);for(;t;){for(let n=0;n<t.values.length;n++)e+=t.values[n].length;t=t.next}return e}isEmpty(){return 0===this.root.keys.length}clear(){this.indexStore.getDataMap("nodes").clear(),this.root=new Ge(!0,this.indexStore),this.indexStore.setMeta("rootId",this.root.id)}rangeSearch(e,t){const n=[];let r=this._getFirstLeaf(this.root);for(;r&&r.keys[r.keys.length-1]<e;)r=r.next;for(;r;){for(let i=0;i<r.keys.length;i++)if(r.keys[i]>=e&&r.keys[i]<=t){const e=r.values[i];for(let t=0;t<e.length;t++)n.push({key:r.keys[i],value:e[t]})}else if(r.keys[i]>t)return n;r=r.next}return n}getHeight(){let e=0,t=this.root;for(;!t.isLeaf;)e++,t=t.children[0];return e}}class Xe extends Je{constructor(e,t,n,r={}){super(e,t,n,r),this.data=new Ye(50,n)}extractIndexKey(e){const t=Object.keys(this.keys);if(0===t.length)return null;if(1===t.length){const n=o(e,t[0]);return void 0===n?null:n}const n=[];for(let r=0;r<t.length;r++){const i=o(e,t[r]);if(void 0===i)return null;n.push(i)}return n.join("\0")}add(e){const t=this.extractIndexKey(e);null!==t&&this.data.add(t,e._id.toString())}remove(e){const t=this.extractIndexKey(e);null!==t&&this.data.delete(t,e._id.toString())}query(e){const t=Object.keys(e),n=Object.keys(this.keys);if(1!==n.length)return null;const r=n[0];if(-1===t.indexOf(r))return null;const i=e[r];if("object"!=typeof i||null===i){const e=i;return this.data.search(e)}return"object"!=typeof i||Array.isArray(i)?null:this._queryWithOperators(r,i)}_queryWithOperators(e,t){const n=Object.keys(t),r=/* @__PURE__ */new Set;if(n.some(e=>["$gt","$gte","$lt","$lte"].includes(e))){const e=n.includes("$gt")||n.includes("$gte"),s=n.includes("$lt")||n.includes("$lte");if(e&&s){const e=n.includes("$gte")?t.$gte:n.includes("$gt")?t.$gt:-1/0,s=n.includes("$lte")?t.$lte:n.includes("$lt")?t.$lt:1/0,o=this.data.rangeSearch(e,s);for(const{key:a,value:l}of o)try{const e=a;let i=!0;!n.includes("$gt")||e>t.$gt||(i=!1),!n.includes("$gte")||e>=t.$gte||(i=!1),!n.includes("$lt")||e<t.$lt||(i=!1),!n.includes("$lte")||e<=t.$lte||(i=!1),i&&l&&r.add(l)}catch(i){}return Array.from(r)}{const e=this.data.toArray();for(const{key:s,value:o}of e)try{const e=s;let i=!0;for(const r of n){const n=t[r];("$gt"!==r||e>n)&&("$gte"!==r||e>=n)&&("$lt"!==r||e<n)&&("$lte"!==r||e<=n)?("$eq"===r&&e!==n||"$ne"===r&&e===n)&&(i=!1):i=!1}i&&o&&r.add(o)}catch(i){}return Array.from(r)}}if(n.includes("$in")){const e=t.$in;if(Array.isArray(e)){for(const t of e){const e=t,n=this.data.search(e);n&&n.forEach(e=>r.add(e))}return Array.from(r)}}if(n.includes("$eq")){const e=t.$eq;return this.data.search(e)||[]}if(n.includes("$ne")){const e=t.$ne,n=this.data.toArray();for(const{key:t,value:i}of n)t!==e&&i&&r.add(i);return Array.from(r)}return null}clear(){this.data.clear()}}class Ze extends Je{constructor(e,t,n,r={}){super(e,t,n,r),this.textIndex=new de(n),this.indexedFields=[];for(const i in t)"text"===t[i]&&this.indexedFields.push(i);if(0===this.indexedFields.length)throw new Error('Text index must have at least one field with type "text"')}_extractText(e){const t=[];for(const n of this.indexedFields){const r=o(e,n);null!=r&&t.push(String(r))}return t.join(" ")}add(e){if(!e._id)throw new Error("Document must have an _id field");const t=this._extractText(e);t&&this.textIndex.add(String(e._id),t)}remove(e){e._id&&this.textIndex.remove(String(e._id))}query(e){return null}search(e,t={}){return this.textIndex.query(e,{scored:!1,...t})}clear(){this.textIndex.clear()}getSpec(){return{name:this.name,key:this.keys,textIndexVersion:3,weights:this._getWeights()}}_getWeights(){const e={};for(const t of this.indexedFields)e[t]=1;return e}}function et(e,t,n,r){const i=(n-e)*Math.PI/180,s=(r-t)*Math.PI/180,o=Math.sin(i/2)*Math.sin(i/2)+Math.cos(e*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin(s/2)*Math.sin(s/2);return 6371*(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)))}function tt(e,t){return!(e.maxLat<t.minLat||e.minLat>t.maxLat||e.maxLng<t.minLng||e.minLng>t.maxLng)}function nt(e){return(e.maxLat-e.minLat)*(e.maxLng-e.minLng)}function rt(e,t){return{minLat:Math.min(e.minLat,t.minLat),maxLat:Math.max(e.maxLat,t.maxLat),minLng:Math.min(e.minLng,t.minLng),maxLng:Math.max(e.maxLng,t.maxLng)}}function it(e,t){return nt(rt(e,t))-nt(e)}class st{constructor(e=!1,t){if(!(t instanceof ue))throw new Error("IndexStore is required to create RTreeNode");if(this.indexStore=t,"object"==typeof e)if(this._data=e,this.id=this._data.id,this.isLeaf=this._data.isLeaf,this.children=[],this.bbox=Object.assign({},this._data.bbox),this.isLeaf)this.children=[...this._data.children];else for(const n of this._data.children){const e=t.getDataMap("nodes").get(n);if(!e)throw new Error(`RTreeNode: Child node with id ${n} not found in IndexStore`);const r=new st(e,t);this.children.push(r)}else this._data={id:t.getMeta("nextId"),isLeaf:e,children:[],bbox:null},t.setMeta("nextId",this._data.id+1),t.getDataMap("nodes").set(this._data.id,this._data),this.id=this._data.id,this.isLeaf=e,this.children=[],this.bbox=null;return new Proxy(this,{set:(e,n,r)=>"children"===n?(e.children=r,e.isLeaf?e._data.children=[...e.children]:e._data.children=e.children.map(e=>e.id),t.getDataMap("nodes").set(e.id,e._data),!0):(e[n]=r,!0),get:(e,n)=>"children"===n?new Proxy(e.children,{set:(n,r,i)=>(n[r]=i,e.isLeaf?e._data.children=[...e.children]:e._data.children=e.children.map(e=>e.id),t.getDataMap("nodes").set(e.id,e._data),!0)}):e[n]})}updateBBox(){if(0===this.children.length)return void(this.bbox=null);let e=1/0,t=-1/0,n=1/0,r=-1/0;for(const i of this.children){const s=i.bbox;e=Math.min(e,s.minLat),t=Math.max(t,s.maxLat),n=Math.min(n,s.minLng),r=Math.max(r,s.maxLng)}this.bbox={minLat:e,maxLat:t,minLng:n,maxLng:r},this._data.bbox=Object.assign({},this.bbox),this.indexStore.getDataMap("nodes").set(this.id,this._data)}}class ot{constructor(e=9,t=new ue){if(this.maxEntries=e,this.minEntries=Math.max(2,Math.ceil(e/2)),this.indexStore=t,t.hasMeta("maxEntries")){if(t.getMeta("maxEntries")!==e)throw new Error(`R-tree maxEntries does not match stored index metadata ${t.getMeta("maxEntries")} != ${e}`);if(t.getMeta("minEntries")!==this.minEntries)throw new Error(`R-tree minEntries does not match stored index metadata ${t.getMeta("minEntries")} != ${this.minEntries}`);this._size=this.indexStore.getMeta("size"),this.root=new st(this.indexStore.getDataMap("nodes").get(this.indexStore.getMeta("rootId")),this.indexStore)}else this.indexStore.setMeta("maxEntries",this.maxEntries),this.indexStore.setMeta("minEntries",this.minEntries),this.indexStore.setMeta("nextId",1),this.root=new st(!0,this.indexStore),this.indexStore.setMeta("rootId",this.root.id),this.indexStore.setMeta("size",0),this._size=0}insert(e,t,n){const r={bbox:{minLat:e,maxLat:e,minLng:t,maxLng:t},lat:e,lng:t,data:n};this._insert(r,this.root,1),this._size++,this.indexStore.setMeta("size",this._size)}_insert(e,t,n){if(t.isLeaf){if(t.children.push(e),t.updateBBox(),t.children.length>this.maxEntries)return this._split(t)}else{const r=this._chooseSubtree(e.bbox,t),i=this._insert(e,r,n+1);if(i){if(t.children.push(i),t.updateBBox(),t.children.length>this.maxEntries)return this._split(t)}else t.updateBBox()}return null}_chooseSubtree(e,t){let n=1/0,r=1/0,i=null;for(const s of t.children){const t=it(s.bbox,e),o=nt(s.bbox);(t<n||t===n&&o<r)&&(n=t,r=o,i=s)}return i}_split(e){const t=e.children,n=e.isLeaf;let r=-1/0,i=0,s=1;for(let l=0;l<t.length;l++)for(let e=l+1;e<t.length;e++){const n=t[l].bbox,o=t[e].bbox,a=nt(rt(n,o))-nt(n)-nt(o);a>r&&(r=a,i=l,s=e)}const o=new st(n,this.indexStore),a=new st(n,this.indexStore);o.children.push(t[i]),a.children.push(t[s]);for(let l=0;l<t.length;l++){if(l===i||l===s)continue;const e=t[l],n=e.bbox,r=0===o.children.length?1/0:it(o.bbox||n,n),c=0===a.children.length?1/0:it(a.bbox||n,n);if(o.children.length<this.minEntries&&t.length-l+o.children.length<=this.minEntries)o.children.push(e);else if(a.children.length<this.minEntries&&t.length-l+a.children.length<=this.minEntries)a.children.push(e);else if(r<c)o.children.push(e);else if(c<r)a.children.push(e);else{(o.bbox?nt(o.bbox):0)<(a.bbox?nt(a.bbox):0)?o.children.push(e):a.children.push(e)}o.updateBBox(),a.updateBBox()}if(e.children=o.children,e.updateBBox(),e===this.root){const e=new st(!1,this.indexStore);return e.children=[o,a],e.updateBBox(),this.root=e,this.indexStore.setMeta("rootId",this.root.id),null}return a}searchBBox(e){const t=[];return this._searchBBox(e,this.root,t),t}_searchBBox(e,t,n){if(t.bbox&&tt(e,t.bbox))if(t.isLeaf)for(const r of t.children)tt(e,r.bbox)&&n.push(r);else for(const r of t.children)this._searchBBox(e,r,n)}searchRadius(e,t,n){const r=function(e,t,n){const r=n/111,i=n/(111*Math.cos(e*Math.PI/180));return{minLat:e-r,maxLat:e+r,minLng:t-i,maxLng:t+i}}(e,t,n),i=this.searchBBox(r),s=[];for(const o of i){et(e,t,o.lat,o.lng)<=n&&s.push(o)}return s}remove(e,t,n=null){const r={minLat:e,maxLat:e,minLng:t,maxLng:t},i=this._remove(r,n,this.root,null,-1);return i&&(this._size--,this.indexStore.setMeta("size",this._size)),1!==this.root.children.length||this.root.isLeaf||(this.root=this.root.children[0],this.indexStore.setMeta("rootId",this.root.id)),i}_remove(e,t,n,r,i){if(!n.bbox||!tt(e,n.bbox))return!1;if(n.isLeaf)for(let s=0;s<n.children.length;s++){const o=n.children[s];if(o.lat===e.minLat&&o.lng===e.minLng){if(null===t||JSON.stringify(o.data)===JSON.stringify(t)){if(n.children.splice(s,1),n.updateBBox(),n.children.length<this.minEntries&&n!==this.root){const e=n.children.slice();n.children=[],n.updateBBox(),r&&(r.children.splice(i,1),r.updateBBox());for(const t of e)this._insert(t,this.root,1)}return!0}}}else for(let s=0;s<n.children.length;s++){const r=n.children[s];if(this._remove(e,t,r,n,s))return n.updateBBox(),!0}return!1}getAll(){const e=[];return this._getAll(this.root,e),e}_getAll(e,t){if(e.isLeaf)t.push(...e.children);else for(const n of e.children)this._getAll(n,t)}size(){return this._size}clear(){this.root=new st(!0,this.indexStore),this.indexStore.setMeta("rootId",this.root.id),this._size=0,this.indexStore.setMeta("size",0)}}class at extends Je{constructor(e,t,n,r={}){super(e,t,n,r),this.rtree=new ot(9,n),this.geoField=null;for(const i in t)if("2dsphere"===t[i]||"2d"===t[i]){this.geoField=i;break}if(!this.geoField)throw new Error('Geospatial index must have at least one field with type "2dsphere" or "2d"')}_extractCoordinates(e){if(!e)return null;if("FeatureCollection"===e.type&&e.features&&e.features.length>0){const t=e.features[0];if(t.geometry)return this._extractCoordinates(t.geometry)}if("Feature"===e.type&&e.geometry)return this._extractCoordinates(e.geometry);if("Point"===e.type&&e.coordinates){const[t,n]=e.coordinates;if("number"==typeof t&&"number"==typeof n)return{lat:n,lng:t}}if("Polygon"===e.type&&e.coordinates&&e.coordinates.length>0){const t=e.coordinates[0];if(t.length>0){let e=0,n=0;for(const r of t)n+=r[0],e+=r[1];return{lat:e/t.length,lng:n/t.length}}}return null}add(e){if(!e._id)throw new Error("Document must have an _id field");const t=o(e,this.geoField),n=this._extractCoordinates(t);n&&this.rtree.insert(n.lat,n.lng,{_id:e._id,geoJson:t})}remove(e){if(!e._id)return;const t=o(e,this.geoField),n=this._extractCoordinates(t);n&&this.rtree.remove(n.lat,n.lng,{_id:e._id,geoJson:t})}query(e){if(!e[this.geoField])return null;const t=e[this.geoField];if(t.$geoWithin){const e=t.$geoWithin;if(Array.isArray(e)&&2===e.length){const t=e[0][0],n=e[0][1],r=e[1][0],i=e[1][1];return this.rtree.searchBBox({minLat:i,maxLat:n,minLng:t,maxLng:r}).map(e=>e.data._id)}}if(t.$near){const e=t.$near;let n;if(e.$geometry)n=e.$geometry.coordinates;else if(e.coordinates)n=e.coordinates;else{if(!Array.isArray(e))return null;n=e}if(!n||n.length<2)return null;const[r,i]=n,s=(e.$maxDistance||1e6)/1e3,o=this.rtree.searchRadius(i,r,s).map(e=>{const t=this._haversineDistance(i,r,e.lat,e.lng);return{_id:e.data._id,distance:t}});return o.sort((e,t)=>e.distance-t.distance),o.map(e=>e._id)}if(t.$nearSphere){const e=t.$nearSphere;let n;if(e.$geometry)n=e.$geometry.coordinates;else if(e.coordinates)n=e.coordinates;else{if(!Array.isArray(e))return null;n=e}if(!n||n.length<2)return null;const[r,i]=n,s=(e.$maxDistance||1e6)/1e3,o=this.rtree.searchRadius(i,r,s).map(e=>{const t=this._haversineDistance(i,r,e.lat,e.lng);return{_id:e.data._id,distance:t}});return o.sort((e,t)=>e.distance-t.distance),o.map(e=>e._id)}if(t.$geoIntersects){const e=t.$geoIntersects;let n;if(!e.$geometry)return null;if(n=e.$geometry,!n||!n.type)return null;if("Point"===n.type){const[e,t]=n.coordinates,r=1e-4;return this.rtree.searchBBox({minLat:t-r,maxLat:t+r,minLng:e-r,maxLng:e+r}).map(e=>e.data._id)}if("Polygon"===n.type){const e=n.coordinates;if(!e||0===e.length)return null;const t=e[0];if(!t||t.length<3)return null;let r=1/0,i=-1/0,s=1/0,o=-1/0;for(const n of t){const[e,t]=n;r=Math.min(r,t),i=Math.max(i,t),s=Math.min(s,e),o=Math.max(o,e)}return this.rtree.searchBBox({minLat:r,maxLat:i,minLng:s,maxLng:o}).filter(e=>this._pointInPolygon(e.lat,e.lng,t)).map(e=>e.data._id)}return null}return null}_haversineDistance(e,t,n,r){const i=(n-e)*Math.PI/180,s=(r-t)*Math.PI/180,o=Math.sin(i/2)*Math.sin(i/2)+Math.cos(e*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin(s/2)*Math.sin(s/2);return 6371*(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)))}_pointInPolygon(e,t,n){let r=!1;for(let i=0,s=n.length-1;i<n.length;s=i++){const[o,a]=n[i],[l,c]=n[s];a>e!=c>e&&t<(l-o)*(e-a)/(c-a)+o&&(r=!r)}return r}clear(){this.rtree.clear()}getSpec(){return{name:this.name,key:this.keys,"2dsphereIndexVersion":3}}}class lt{constructor(){this.type="full_scan",this.indexes=[],this.indexScans=[],this.estimatedCost=1/0,this.indexOnly=!1}}class ct{constructor(e){this.indexes=e}plan(e){const t=new lt;if(!e||0===Object.keys(e).length)return t;const n=this._analyzeQuery(e);if(n.hasTextSearch){const t=this._planTextSearch(e,n);if(t)return t}if(n.hasGeoQuery){const t=this._planGeoQuery(e,n);if(t)return t}if("and"===n.type){const t=this._planAndQuery(e,n);if("full_scan"!==t.type)return t}if("or"===n.type){const t=this._planOrQuery(e,n);if("full_scan"!==t.type)return t}const r=this._planSimpleQuery(e);return"full_scan"!==r.type?r:t}_analyzeQuery(e){const t={type:"simple",fields:[],operators:{},hasTextSearch:!1,hasGeoQuery:!1,conditions:[]},n=Object.keys(e);if(1===n.length){const r=n[0];if("$and"===r){t.type="and",t.conditions=e.$and;for(const e of t.conditions){const n=this._analyzeQuery(e);t.fields.push(...n.fields),n.hasTextSearch&&(t.hasTextSearch=!0),n.hasGeoQuery&&(t.hasGeoQuery=!0)}return t}if("$or"===r){t.type="or",t.conditions=e.$or;for(const e of t.conditions){const n=this._analyzeQuery(e);t.fields.push(...n.fields),n.hasTextSearch&&(t.hasTextSearch=!0),n.hasGeoQuery&&(t.hasGeoQuery=!0)}return t}}for(const r of n){if(r.startsWith("$"))continue;t.fields.push(r);const n=e[r];if("object"==typeof n&&null!==n&&!Array.isArray(n)){const e=Object.keys(n);t.operators[r]=e,e.includes("$text")&&(t.hasTextSearch=!0),e.some(e=>["$geoWithin","$geoIntersects","$near","$nearSphere"].includes(e))&&(t.hasGeoQuery=!0)}}return n.length>1&&(t.type="and"),t}_planTextSearch(e,t){for(const[n,r]of this.indexes)if(r instanceof Ze){const t=this._extractTextQuery(e);if(t){const e=new lt;return e.type="index_scan",e.indexes=[n],e.indexScans=[{indexName:n,index:r,textQuery:t}],e.estimatedCost=100,e.indexOnly=!0,e}}return null}_extractTextQuery(e){for(const t in e){const n=e[t];if("object"==typeof n&&null!==n&&n.$text)return"string"==typeof n.$text?n.$text:n.$text.$search}return null}_planGeoQuery(e,t){for(const[n,r]of this.indexes)if(r instanceof at){const t=new lt;return t.type="index_scan",t.indexes=[n],t.indexScans=[{indexName:n,index:r,query:e}],t.estimatedCost=100,t.indexOnly=!0,t}return null}_planAndQuery(e,t){const n=new lt;let r;r=e.$and?e.$and:Object.keys(e).map(t=>({[t]:e[t]}));const i=[];for(const s of r){const e=this._planSimpleQuery(s);"index_scan"===e.type&&i.push(e.indexScans[0])}return i.length>1?(n.type="index_intersection",n.indexScans=i,n.indexes=i.map(e=>e.indexName),n.estimatedCost=50,n):1===i.length?(n.type="index_scan",n.indexScans=[i[0]],n.indexes=[i[0].indexName],n.estimatedCost=50,n):n}_planOrQuery(e,t){const n=new lt;if(!e.$or)return n;const r=e.$or,i=[];for(const s of r){const e=this._planSimpleQuery(s);"index_scan"===e.type&&i.push(e.indexScans[0])}return i.length>0?(n.type="index_union",n.indexScans=i,n.indexes=i.map(e=>e.indexName),n.estimatedCost=100*i.length,n):n}_planSimpleQuery(e){const t=new lt;if(0===Object.keys(e).length)return t;for(const[n,r]of this.indexes)if(!(r instanceof Ze||r instanceof at)&&this._canIndexHandleQuery(r,e))return t.type="index_scan",t.indexes=[n],t.indexScans=[{indexName:n,index:r,query:e}],t.estimatedCost=50,t;return t}_executeIndexScan(e){const{index:t,query:n,textQuery:r}=e;if(void 0!==r)return t.search(r);if(void 0!==n){const e=t.query(n);return null!==e?e:[]}return void 0!==e.docIds?e.docIds:[]}_canIndexHandleQuery(e,t){const n=Object.keys(t),r=Object.keys(e.keys);if(1!==r.length)return!1;const i=r[0];return-1!==n.indexOf(i)}execute(e){if("full_scan"===e.type)return null;if("index_scan"===e.type){const t=e.indexScans[0];return this._executeIndexScan(t)}if("index_intersection"===e.type){if(0===e.indexScans.length)return null;const t=e.indexScans.map(e=>({docIds:this._executeIndexScan(e),indexName:e.indexName})).slice().sort((e,t)=>e.docIds.length-t.docIds.length);let n=new Set(t[0].docIds);for(let e=1;e<t.length;e++){const r=new Set(t[e].docIds);if(n=new Set([...n].filter(e=>r.has(e))),0===n.size)break}return Array.from(n)}if("index_union"===e.type){const t=/* @__PURE__ */new Set;for(const n of e.indexScans){this._executeIndexScan(n).forEach(e=>t.add(e))}return Array.from(t)}return null}}class ut extends n.EventEmitter{constructor(e,t=[],n={}){super(),this.target=e,this.pipeline=t,this.options=n,this.closed=!1,this._listeners=/* @__PURE__ */new Map,this._changeCounter=0,this._startWatching()}_startWatching(){if(this.closed)return;const e=this._getCollectionsToWatch();for(const t of e)this._watchCollection(t);"DB"===this.target.constructor.name&&this._interceptDBCollectionCreation(),"MongoClient"===this.target.constructor.name&&this._interceptClientDBCreation()}_getCollectionsToWatch(){const e=[];if("MongoClient"===this.target.constructor.name)return this._monitorClient(),e;if("DB"===this.target.constructor.name){const t=this.target.getCollectionNames();for(const n of t){const t=this.target[n];t&&t.isCollection&&e.push(t)}this._monitorDB()}return this.target.isCollection&&e.push(this.target),e}_watchCollection(e){if(this.closed)return;if(!e)return;if("function"!=typeof e.on)return;if(!e.isCollection)return;if(this._listeners.has(e))return;const t={insert:t=>this._emitChange("insert",e,t),update:(t,n)=>this._emitChange("update",e,t,n),replace:t=>this._emitChange("replace",e,t),delete:t=>this._emitChange("delete",e,t)};this._listeners.set(e,t),e.on("insert",t.insert),e.on("update",t.update),e.on("replace",t.replace),e.on("delete",t.delete)}_emitChange(e,t,n,r=null){if(this.closed)return;const i=this._createChangeEvent(e,t,n,r);this._matchesPipeline(i)&&this.emit("change",i)}_createChangeEvent(e,t,n,r){const i={_id:{_data:Buffer.from(String(++this._changeCounter)).toString("base64")},operationType:e,clusterTime:/* @__PURE__ */new Date,ns:{db:t.db.dbName,coll:t.name},documentKey:{_id:n._id}};switch(e){case"insert":case"replace":i.fullDocument=n;break;case"update":i.updateDescription=r||{updatedFields:{},removedFields:[],truncatedArrays:[]},"updateLookup"===this.options.fullDocument&&(i.fullDocument=n)}return i}_matchesPipeline(e){if(!this.pipeline||0===this.pipeline.length)return!0;for(const t of this.pipeline)if(t.$match&&!De(e,t.$match))return!1;return!0}_getNestedValue(e,t){return t.split(".").reduce((e,t)=>e?.[t],e)}_monitorClient(){}_interceptClientDBCreation(){const e=this.target,t=e.db.bind(e),n=this;this._watchedDBs=/* @__PURE__ */new Map,e.db=function(e,r){const i=t(e,r),s=i.dbName;if(!n._watchedDBs.has(s)){n._watchedDBs.set(s,i);const e=i.getCollectionNames();for(const t of e){const e=i[t];e&&e.isCollection&&!n._listeners.has(e)&&n._watchCollection(e)}n._interceptDBCollectionCreationForClient(i)}return i},this._originalClientMethods={db:t}}_interceptDBCollectionCreationForClient(e){const t=e.collection.bind(e),n=e.createCollection.bind(e),r=this;e.collection=function(e){const n=t(e);return n&&n.isCollection&&!r._listeners.has(n)&&r._watchCollection(n),n},e.createCollection=function(t){n(t);const i=e[t];i&&i.isCollection&&!r._listeners.has(i)&&r._watchCollection(i)}}_monitorDB(){}_interceptDBCollectionCreation(){const e=this.target,t=e.collection.bind(e),n=e.createCollection.bind(e),r=this;e.collection=function(e){const n=t(e);return n&&n.isCollection&&!r._listeners.has(n)&&r._watchCollection(n),n},e.createCollection=function(t){n(t);const i=e[t];i&&i.isCollection&&!r._listeners.has(i)&&r._watchCollection(i)},this._originalDBMethods={collection:t,createCollection:n}}close(){if(!this.closed){this.closed=!0;for(const[e,t]of this._listeners)e.off("insert",t.insert),e.off("update",t.update),e.off("replace",t.replace),e.off("delete",t.delete);this._listeners.clear(),this._originalDBMethods&&"DB"===this.target.constructor.name&&(this.target.collection=this._originalDBMethods.collection,this.target.createCollection=this._originalDBMethods.createCollection),this._originalClientMethods&&"MongoClient"===this.target.constructor.name&&(this.target.db=this._originalClientMethods.db),this.emit("close"),this.removeAllListeners()}}get isClosed(){return this.closed}async*[Symbol.asyncIterator](){const e=[];let t=null,n=!1;const r=n=>{t?(t({value:n,done:!1}),t=null):e.push(n)},i=()=>{n=!0,t&&(t({done:!0}),t=null)},s=e=>{t&&(t(Promise.reject(e)),t=null)};this.on("change",r),this.on("close",i),this.on("error",s);try{for(;!n;)if(e.length>0)yield e.shift();else{const e=await new Promise(e=>{t=e,n&&e({done:!0})});if(e.done)break;yield e.value}}finally{this.off("change",r),this.off("close",i),this.off("error",s)}}async next(){return new Promise((e,t)=>{const n=t=>{s(),e(t)},r=()=>{s(),e(null)},i=e=>{s(),t(e)},s=()=>{this.off("change",n),this.off("close",r),this.off("error",i)};this.closed?e(null):(this.once("change",n),this.once("close",r),this.once("error",i))})}}class ht extends n.EventEmitter{constructor(e,t,n,r){super(),this.db=e,this.name=t,this.storage=n,this.idGenerator=r,this.indexes=/* @__PURE__ */new Map,this.queryPlanner=new ct(this.indexes),this.isCollection=!0;for(const[i,s]of this.storage.indexes){let e;"text"===s.getMeta("type")?e=new Ze(i,s.getMeta("keys"),s):"geospatial"===s.getMeta("type")?e=new at(i,s.getMeta("keys"),s):"regular"===s.getMeta("type")&&(e=new Xe(i,s.getMeta("keys"),s)),e&&this.indexes.set(e.name,e)}}generateIndexName(e){const t=[];for(const n in e)e.hasOwnProperty(n)&&t.push(n+"_"+e[n]);return t.join("_")}isTextIndex(e){for(const t in e)if("text"===e[t])return!0;return!1}isGeospatialIndex(e){for(const t in e)if("2dsphere"===e[t]||"2d"===e[t])return!0;return!1}buildIndex(e,t,n={}){let r;if(this.isTextIndex(t)){const i={type:"text",keys:t};r=new Ze(e,t,this.storage.createIndexStore(e,i),n)}else if(this.isGeospatialIndex(t)){const i={type:"geospatial",keys:t};r=new at(e,t,this.storage.createIndexStore(e,i),n)}else{const i={type:"regular",keys:t};r=new Xe(e,t,this.storage.createIndexStore(e,i),n)}const i=this.storage.getAllDocuments();for(const s of i)s&&r.add(s);return this.indexes.set(e,r),r}updateIndexesOnInsert(e){for(const[t,n]of this.indexes)n.add(e)}updateIndexesOnDelete(e){for(const[t,n]of this.indexes)n.remove(e)}planQuery(e){const t=this.queryPlanner.plan(e),n=this.queryPlanner.execute(t);return{useIndex:"full_scan"!==t.type,planType:t.type,indexNames:t.indexes,docIds:n,estimatedCost:t.estimatedCost,indexOnly:t.indexOnly||!1}}getTextIndex(e){for(const[t,n]of this.indexes)if(n instanceof Ze&&n.indexedFields.includes(e))return n;return null}aggregate(e){if(!e||!c(e))throw new A("Pipeline must be an array",{collection:this.name,code:g.FAILED_TO_PARSE});let t=[];const n=this.find({});for(;n.hasNext();)t.push(n.next());for(let r=0;r<e.length;r++){const n=e[r],i=Object.keys(n);if(1!==i.length)throw new A("Each pipeline stage must have exactly one key",{collection:this.name,code:g.FAILED_TO_PARSE});const a=i[0],l=n[a];if("$match"===a){const e=[];for(let n=0;n<t.length;n++)De(t[n],l)&&e.push(t[n]);t=e}else if("$project"===a){const e=[];for(let n=0;n<t.length;n++)e.push(dt(l,t[n]));t=e}else if("$addFields"===a||"$set"===a){const e=[];for(let n=0;n<t.length;n++){const r=s(t[n]);for(const e in l){const i=l[e];r[e]=fe(i,t[n])}e.push(r)}t=e}else if("$unset"===a){const e=[];let n=[];"string"==typeof l?n=[l]:Array.isArray(l)?n=l:"object"==typeof l&&(n=Object.keys(l));for(let r=0;r<t.length;r++){const i=s(t[r]);for(let e=0;e<n.length;e++){const t=n[e],r=t.split(".");if(1===r.length)delete i[t];else{let e=i;for(let t=0;t<r.length-1&&(null!=e&&null!=e);t++)e=e[r[t]];null!=e&&null!=e&&delete e[r[r.length-1]]}}e.push(i)}t=e}else if("$sort"===a){const e=Object.keys(l);t.sort(function(t,n){for(let r=0;r<e.length;r++){const i=e[r];if(void 0===t[i]&&void 0!==n[i])return-1*l[i];if(void 0!==t[i]&&void 0===n[i])return 1*l[i];if(t[i]<n[i])return-1*l[i];if(t[i]>n[i])return 1*l[i]}return 0})}else if("$limit"===a)t=t.slice(0,l);else if("$skip"===a)t=t.slice(l);else if("$group"===a){const e={},n=l._id;for(let i=0;i<t.length;i++){const r=t[i];let s;s=null==n?null:fe(n,r);const o=JSON.stringify(s);e[o]||(e[o]={_id:s,docs:[],accumulators:{}}),e[o].docs.push(r)}const r=[];for(const t in e){const n=e[t],i={_id:n._id};for(const e in l){if("_id"===e)continue;const t=l[e],r=Object.keys(t);if(1!==r.length)continue;const s=r[0],o=t[s];if("$sum"===s){let t=0;for(let e=0;e<n.docs.length;e++){const r=fe(o,n.docs[e]);"number"==typeof r?t+=r:null!=r&&(t+=Number(r)||0)}i[e]=t}else if("$avg"===s){let t=0,r=0;for(let e=0;e<n.docs.length;e++){const i=fe(o,n.docs[e]);null!=i&&(t+=Number(i)||0,r++)}i[e]=r>0?t/r:0}else if("$min"===s){let t;for(let e=0;e<n.docs.length;e++){const r=fe(o,n.docs[e]);void 0!==r&&(void 0===t||r<t)&&(t=r)}i[e]=t}else if("$max"===s){let t;for(let e=0;e<n.docs.length;e++){const r=fe(o,n.docs[e]);void 0!==r&&(void 0===t||r>t)&&(t=r)}i[e]=t}else if("$push"===s){const t=[];for(let e=0;e<n.docs.length;e++){const r=fe(o,n.docs[e]);t.push(r)}i[e]=t}else if("$addToSet"===s){const t={};for(let e=0;e<n.docs.length;e++){const r=fe(o,n.docs[e]);t[JSON.stringify(r)]=r}const r=[];for(const e in t)r.push(t[e]);i[e]=r}else if("$first"===s)n.docs.length>0&&(i[e]=fe(o,n.docs[0]));else if("$last"===s)n.docs.length>0&&(i[e]=fe(o,n.docs[n.docs.length-1]));else if("$stdDevPop"===s){const t=[];for(let e=0;e<n.docs.length;e++){const r=fe(o,n.docs[e]);"number"==typeof r&&t.push(r)}if(t.length>0){const n=t.reduce((e,t)=>e+t,0)/t.length,r=t.reduce((e,t)=>e+Math.pow(t-n,2),0)/t.length;i[e]=Math.sqrt(r)}else i[e]=0}else if("$stdDevSamp"===s){const t=[];for(let e=0;e<n.docs.length;e++){const r=fe(o,n.docs[e]);"number"==typeof r&&t.push(r)}if(t.length>1){const n=t.reduce((e,t)=>e+t,0)/t.length,r=t.reduce((e,t)=>e+Math.pow(t-n,2),0)/(t.length-1);i[e]=Math.sqrt(r)}else i[e]=0}else if("$mergeObjects"===s){const t={};for(let e=0;e<n.docs.length;e++){const r=fe(o,n.docs[e]);"object"!=typeof r||null===r||Array.isArray(r)||Object.assign(t,r)}i[e]=t}}r.push(i)}t=r}else if("$count"===a)t=[{[l]:t.length}];else if("$unwind"===a){const e=[];let n=l;"string"==typeof n&&"$"===n.charAt(0)&&(n=n.substring(1));for(let r=0;r<t.length;r++){const i=t[r],a=o(i,n);if(a&&c(a)&&a.length>0)for(let t=0;t<a.length;t++){const r=s(i),o=n.split(".");let l=r;for(let e=0;e<o.length-1;e++)l[o[e]]||(l[o[e]]={}),l=l[o[e]];l[o[o.length-1]]=a[t],e.push(r)}}t=e}else if("$sortByCount"===a){const e={};for(let n=0;n<t.length;n++){const r=t[n],i=fe(l,r),s=JSON.stringify(i);e[s]||(e[s]={_id:i,count:0}),e[s].count++}t=Object.values(e).sort((e,t)=>t.count-e.count)}else if("$replaceRoot"===a||"$replaceWith"===a){const e=[],n="$replaceRoot"===a?l.newRoot:l;for(let r=0;r<t.length;r++){const i=fe(n,t[r]);if("object"!=typeof i||null===i||Array.isArray(i))throw new A("$replaceRoot expression must evaluate to an object",{collection:this.name,code:g.FAILED_TO_PARSE});e.push(i)}t=e}else if("$sample"===a){const e=l.size||1;if("number"!=typeof e||e<0)throw new A("$sample size must be a non-negative number",{collection:this.name,code:g.FAILED_TO_PARSE});const n=[...t];for(let t=n.length-1;t>0;t--){const e=Math.floor(Math.random()*(t+1));[n[t],n[e]]=[n[e],n[t]]}t=n.slice(0,Math.min(e,n.length))}else if("$bucket"===a){if(!l.groupBy||!l.boundaries)throw new A("$bucket requires groupBy and boundaries",{collection:this.name,code:g.FAILED_TO_PARSE});const e=l.boundaries,n=l.default,r=l.output||{count:{$sum:1}},i={};for(let t=0;t<e.length-1;t++){i[JSON.stringify(e[t])]={_id:e[t],docs:[]}}void 0!==n&&(i.default={_id:n,docs:[]});for(let o=0;o<t.length;o++){const r=t[o],s=fe(l.groupBy,r);let a=!1;for(let t=0;t<e.length-1;t++)if(s>=e[t]&&s<e[t+1]){i[JSON.stringify(e[t])].docs.push(r),a=!0;break}a||void 0===n||i.default.docs.push(r)}const s=[];for(const t in i){const e=i[t];if(0===e.docs.length)continue;const n={_id:e._id};for(const t in r){const i=r[t],s=Object.keys(i);if(1!==s.length)continue;const o=s[0],a=i[o];if("$sum"===o){let r=0;for(let t=0;t<e.docs.length;t++){const n=fe(a,e.docs[t]);"number"==typeof n?r+=n:null!=n&&(r+=Number(n)||0)}n[t]=r}else if("$avg"===o){let r=0,i=0;for(let t=0;t<e.docs.length;t++){const n=fe(a,e.docs[t]);null!=n&&(r+=Number(n)||0,i++)}n[t]=i>0?r/i:0}else if("$push"===o){const r=[];for(let t=0;t<e.docs.length;t++){const n=fe(a,e.docs[t]);r.push(n)}n[t]=r}else if("$addToSet"===o){const r={};for(let t=0;t<e.docs.length;t++){const n=fe(a,e.docs[t]);r[JSON.stringify(n)]=n}n[t]=Object.values(r)}}s.push(n)}t=s.sort((e,t)=>e._id<t._id?-1:e._id>t._id?1:0)}else if("$bucketAuto"===a){if(!l.groupBy||!l.buckets)throw new A("$bucketAuto requires groupBy and buckets",{collection:this.name,code:g.FAILED_TO_PARSE});const e=l.buckets,n=l.output||{count:{$sum:1}};if(0===t.length)t=[];else{const r=t.map(e=>({value:fe(l.groupBy,e),doc:e})).sort((e,t)=>e.value<t.value?-1:e.value>t.value?1:0),i=Math.ceil(r.length/e),s=[];for(let t=0;t<e&&t*i<r.length;t++){const e=t*i,n=Math.min((t+1)*i,r.length),o=r.slice(e,n);if(0===o.length)continue;const a={_id:{min:o[0].value,max:(r.length,o[o.length-1].value)},docs:o.map(e=>e.doc)};s.push(a)}const o=[];for(let e=0;e<s.length;e++){const t=s[e],r={_id:t._id};for(const e in n){const i=n[e],s=Object.keys(i);if(1!==s.length)continue;const o=s[0],a=i[o];if("$sum"===o){let n=0;for(let e=0;e<t.docs.length;e++){const r=fe(a,t.docs[e]);"number"==typeof r?n+=r:null!=r&&(n+=Number(r)||0)}r[e]=n}else if("$avg"===o){let n=0,i=0;for(let e=0;e<t.docs.length;e++){const r=fe(a,t.docs[e]);null!=r&&(n+=Number(r)||0,i++)}r[e]=i>0?n/i:0}else if("$push"===o){const n=[];for(let e=0;e<t.docs.length;e++){const r=fe(a,t.docs[e]);n.push(r)}r[e]=n}}o.push(r)}t=o}}else if("$out"===a){const e=l;if("string"!=typeof e)throw new A("$out requires a string collection name",{collection:this.name,code:g.FAILED_TO_PARSE});this.db[e]&&this.db.dropCollection(e),this.db.createCollection(e);const n=this.db[e];for(let r=0;r<t.length;r++){const e=t[r],i=e._id,s="object"==typeof i&&i.toString?i.toString():String(i);n.storage.set(s,e)}t=[]}else if("$merge"===a){let e,n="_id",r="merge",i="insert";if("string"==typeof l?e=l:"object"==typeof l&&(e=l.into,n=l.on||n,r=l.whenMatched||r,i=l.whenNotMatched||i),!e)throw new A("$merge requires a target collection",{collection:this.name,code:g.FAILED_TO_PARSE});this.db[e]||this.db.createCollection(e);const s=this.db[e];for(let a=0;a<t.length;a++){const e=t[a],l="string"==typeof n?n:n[0],c=o(e,l),u=s.find({[l]:c}),h=u.hasNext()?u.next():null;if(h){if("replace"===r){const t=e._id,n="object"==typeof t&&t.toString?t.toString():String(t);s.storage.set(n,e)}else if("merge"===r){const t=Object.assign({},h,e),n=t._id,r="object"==typeof n&&n.toString?n.toString():String(n);s.storage.set(r,t)}else if("keepExisting"===r);else if("fail"===r)throw new A("$merge failed: duplicate key",{collection:this.name,code:g.DUPLICATE_KEY})}else if("insert"===i){const t=e._id,n="object"==typeof t&&t.toString?t.toString():String(t);s.storage.set(n,e)}else if("discard"===i);else if("fail"===i)throw new A("$merge failed: document not found",{collection:this.name,code:g.FAILED_TO_PARSE})}t=[]}else if("$lookup"===a){if(!(l.from&&l.localField&&l.foreignField&&l.as))throw new A("$lookup requires from, localField, foreignField, and as",{collection:this.name,code:g.FAILED_TO_PARSE});if(!this.db.getCollectionNames().includes(l.from))throw new A("$lookup: collection not found: "+l.from,{collection:this.name,code:g.NAMESPACE_NOT_FOUND});const e=this.db[l.from],n=[];for(let r=0;r<t.length;r++){const i=s(t[r]),a=o(i,l.localField),c=[],u=e.find({[l.foreignField]:a});for(;u.hasNext();)c.push(u.next());i[l.as]=c,n.push(i)}t=n}else if("$graphLookup"===a){if(!(l.from&&l.startWith&&l.connectFromField&&l.connectToField&&l.as))throw new A("$graphLookup requires from, startWith, connectFromField, connectToField, and as",{collection:this.name,code:g.FAILED_TO_PARSE});if(!this.db.getCollectionNames().includes(l.from))throw new A("$graphLookup: collection not found: "+l.from,{collection:this.name,code:g.NAMESPACE_NOT_FOUND});const e=this.db[l.from],n=void 0!==l.maxDepth?l.maxDepth:Number.MAX_SAFE_INTEGER,r=l.depthField,i=l.restrictSearchWithMatch,a=[];for(let c=0;c<t.length;c++){const u=s(t[c]),h=fe(l.startWith,t[c]),d=/* @__PURE__ */new Set,f=[],p=[{value:h,depth:0}];for(;p.length>0;){const{value:t,depth:a}=p.shift();if(a>n)continue;const c=JSON.stringify(t);if(d.has(c))continue;d.add(c);let u={[l.connectToField]:t};i&&(u={$and:[u,i]});const h=e.find(u);for(;h.hasNext();){const e=h.next(),t=s(e);r&&(t[r]=a),f.push(t);const n=o(e,l.connectFromField);null!=n&&p.push({value:n,depth:a+1})}}u[l.as]=f,a.push(u)}t=a}else if("$facet"===a){if("object"!=typeof l||Array.isArray(l))throw new A("$facet requires an object with pipeline definitions",{collection:this.name,code:g.FAILED_TO_PARSE});const e={};for(const n in l){const r=l[n];if(!Array.isArray(r))throw new A("$facet pipeline must be an array",{collection:this.name,code:g.FAILED_TO_PARSE});let i=t.map(e=>s(e));for(let e=0;e<r.length;e++){const t=r[e],n=Object.keys(t);if(1!==n.length)throw new A("Each pipeline stage must have exactly one key",{collection:this.name,code:g.FAILED_TO_PARSE});const s=n[0],o=t[s];if("$match"===s){const e=[];for(let t=0;t<i.length;t++)De(i[t],o)&&e.push(i[t]);i=e}else if("$project"===s){const e=[];for(let t=0;t<i.length;t++)e.push(dt(o,i[t]));i=e}else if("$limit"===s)i=i.slice(0,o);else if("$skip"===s)i=i.slice(o);else if("$sort"===s){const e=Object.keys(o);i.sort(function(t,n){for(let r=0;r<e.length;r++){const i=e[r];if(void 0===t[i]&&void 0!==n[i])return-1*o[i];if(void 0!==t[i]&&void 0===n[i])return 1*o[i];if(t[i]<n[i])return-1*o[i];if(t[i]>n[i])return 1*o[i]}return 0})}else if("$count"===s)i=[{[o]:i.length}];else if("$group"===s){const e={},t=o._id;for(let r=0;r<i.length;r++){const n=i[r];let s;s=null==t?null:fe(t,n);const o=JSON.stringify(s);e[o]||(e[o]={_id:s,docs:[],accumulators:{}}),e[o].docs.push(n)}const n=[];for(const r in e){const t=e[r],i={_id:t._id};for(const e in o){if("_id"===e)continue;const n=o[e],r=Object.keys(n);if(1!==r.length)continue;const s=r[0],a=n[s];if("$sum"===s){let n=0;for(let e=0;e<t.docs.length;e++){const r=fe(a,t.docs[e]);"number"==typeof r?n+=r:null!=r&&(n+=Number(r)||0)}i[e]=n}else if("$avg"===s){let n=0,r=0;for(let e=0;e<t.docs.length;e++){const i=fe(a,t.docs[e]);null!=i&&(n+=Number(i)||0,r++)}i[e]=r>0?n/r:0}else if("$max"===s){let n;for(let e=0;e<t.docs.length;e++){const r=fe(a,t.docs[e]);void 0!==r&&(void 0===n||r>n)&&(n=r)}i[e]=n}}n.push(i)}i=n}else if("$sortByCount"===s){const e={};for(let t=0;t<i.length;t++){const n=i[t],r=fe(o,n),s=JSON.stringify(r);e[s]||(e[s]={_id:r,count:0}),e[s].count++}i=Object.values(e).sort((e,t)=>t.count-e.count)}else if("$sample"===s){const e=o.size||1,t=[...i];for(let n=t.length-1;n>0;n--){const e=Math.floor(Math.random()*(n+1));[t[n],t[e]]=[t[e],t[n]]}i=t.slice(0,Math.min(e,t.length))}else if("$bucket"===s){const e=o.boundaries,t=o.default,n=o.output||{count:{$sum:1}},r={};for(let i=0;i<e.length-1;i++){r[JSON.stringify(e[i])]={_id:e[i],docs:[]}}void 0!==t&&(r.default={_id:t,docs:[]});for(let a=0;a<i.length;a++){const n=i[a],s=fe(o.groupBy,n);let l=!1;for(let t=0;t<e.length-1;t++)if(s>=e[t]&&s<e[t+1]){r[JSON.stringify(e[t])].docs.push(n),l=!0;break}l||void 0===t||r.default.docs.push(n)}const s=[];for(const i in r){const e=r[i];if(0===e.docs.length)continue;const t={_id:e._id};for(const r in n){const i=n[r],s=Object.keys(i);if(1!==s.length)continue;const o=s[0],a=i[o];if("$sum"===o){let n=0;for(let t=0;t<e.docs.length;t++){const r=fe(a,e.docs[t]);"number"==typeof r?n+=r:null!=r&&(n+=Number(r)||0)}t[r]=n}}s.push(t)}i=s.sort((e,t)=>e._id<t._id?-1:e._id>t._id?1:0)}}e[n]=i}t=[e]}else if("$redact"===a){const e=[];for(let n=0;n<t.length;n++){const r=t[n],i=fe(l,r);if("$$DESCEND"===i)e.push(r);else{if("$$PRUNE"===i)continue;("$$KEEP"===i||i)&&e.push(r)}}t=e}else{if("$geoNear"!==a)throw new A("Unsupported aggregation stage: "+a,{collection:this.name,code:g.FAILED_TO_PARSE});{if(!l.near||!l.distanceField)throw new A("$geoNear requires near and distanceField",{collection:this.name,code:g.FAILED_TO_PARSE});const e=l.near,n=l.distanceField,r=l.maxDistance,i=l.minDistance||0,a=!1!==l.spherical,c=l.key||"location",u=[];for(let l=0;l<t.length;l++){const h=s(t[l]),d=o(h,c);if(!d||!Array.isArray(d)||d.length<2)continue;let f;if(a){const t=6371e3,n=e[1]*Math.PI/180,r=d[1]*Math.PI/180,i=(d[1]-e[1])*Math.PI/180,s=(d[0]-e[0])*Math.PI/180,o=Math.sin(i/2)*Math.sin(i/2)+Math.cos(n)*Math.cos(r)*Math.sin(s/2)*Math.sin(s/2);f=t*(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)))}else{const t=d[0]-e[0],n=d[1]-e[1];f=Math.sqrt(t*t+n*n)}f>=i&&(!r||f<=r)&&(h[n]=f,u.push(h))}u.sort((e,t)=>e[n]-t[n]),t=l.limit?u.slice(0,l.limit):u}}}return t}bulkWrite(){throw new L("bulkWrite",{collection:this.name})}async count(){return this.storage.size()}async copyTo(e){this.db[e]||this.db.createCollection(e);const t=this.db[e];let n=0;const r=this.find({});for(;r.hasNext();)await t.insertOne(r.next()),n++;return n}async createIndex(e,t){if(!e||"object"!=typeof e||Array.isArray(e))throw new T("keys",e,"createIndex requires a key specification object",{collection:this.name});const n=t&&t.name?t.name:this.generateIndexName(e);if(this.indexes.has(n)){const t=this.indexes.get(n);if(JSON.stringify(t.keys)!==JSON.stringify(e))throw new v("Index with name '"+n+"' already exists with a different key specification",{code:g.INDEX_OPTIONS_CONFLICT,index:n,collection:this.name});return n}return this.buildIndex(n,e,t),n}dataSize(){throw new L("dataSize",{collection:this.name})}async deleteOne(e){const t=await this.findOne(e);return t?(this.updateIndexesOnDelete(t),this.storage.remove(t._id.toString()),this.emit("delete",{_id:t._id}),{deletedCount:1}):{deletedCount:0}}async deleteMany(e){const t=this.find(e),n=[],r=[];for(;t.hasNext();){const e=t.next();n.push(e._id),r.push(e)}const i=n.length;for(let s=0;s<n.length;s++)this.updateIndexesOnDelete(r[s]),this.storage.remove(n[s].toString()),this.emit("delete",{_id:n[s]});return{deletedCount:i}}async distinct(e,t){const n={},r=this.find(t);for(;r.hasNext();){const t=r.next();t[e]&&(n[t[e]]=!0)}return Object.keys(n)}drop(){for(const[e,t]of this.indexes)t.clear();this.storage.clear()}dropIndex(e){if(!this.indexes.has(e))throw new S(e,{collection:this.name});return this.indexes.get(e).clear(),this.indexes.delete(e),{nIndexesWas:this.indexes.size+1,ok:1}}dropIndexes(){const e=this.indexes.size;for(const[t,n]of this.indexes)n.clear();return this.indexes.clear(),{nIndexesWas:e,msg:"non-_id indexes dropped",ok:1}}ensureIndex(){throw new L("ensureIndex",{collection:this.name})}explain(){throw new L("explain",{collection:this.name})}find(e,t){const n=null==e?{}:e,r=this.planQuery(n),i=[],s={};if(r.useIndex&&r.docIds)for(const o of r.docIds){const e=this.storage.get(o.toString());e&&De(e,n)&&(s[e._id]=!0,i.push(e))}if(!r.indexOnly){const e=this.storage.getAllDocuments();for(const t of e)!s[t._id]&&De(t,n)&&(s[t._id]=!0,i.push(t))}return new F(this,n,t,i,R)}findAndModify(){throw new L("findAndModify",{collection:this.name})}async findOne(e,t){const n=this.find(e,t);return n.hasNext()?n.next():null}async findOneAndDelete(e,t){let n=this.find(e);if(t&&t.sort&&(n=n.sort(t.sort)),!n.hasNext())return null;const r=n.next();return this.storage.remove(r._id.toString()),t&&t.projection?p(t.projection,r):r}async findOneAndReplace(e,t,n){let r=this.find(e);if(n&&n.sort&&(r=r.sort(n.sort)),!r.hasNext())return null;const i=r.next();return t._id=i._id,this.storage.set(i._id.toString(),t),n&&n.returnNewDocument?n&&n.projection?p(n.projection,t):t:n&&n.projection?p(n.projection,i):i}async findOneAndUpdate(e,t,n){let r=this.find(e);if(n&&n.sort&&(r=r.sort(n.sort)),!r.hasNext())return null;const i=r.next(),s=Object.assign({},i);return Ve(t,s,!1,Te(i,e).arrayFilters,n&&n.arrayFilters),this.storage.set(i._id.toString(),s),n&&n.returnNewDocument?n&&n.projection?p(n.projection,s):s:n&&n.projection?p(n.projection,i):i}getIndexes(){const e=[];for(const[t,n]of this.indexes)e.push(n.getSpec());return e}getShardDistribution(){throw new L("getShardDistribution",{collection:this.name})}getShardVersion(){throw new L("getShardVersion",{collection:this.name})}getStore(){return this.storage.getStore()}group(){throw new L("group",{collection:this.name})}async insert(e){return Array==e.constructor?await this.insertMany(e):await this.insertOne(e)}async insertOne(e){return null==e._id&&(e._id=this.idGenerator()),this.storage.set(e._id.toString(),e),this.updateIndexesOnInsert(e),this.emit("insert",e),{insertedId:e._id}}async insertMany(e){const t=[];for(let n=0;n<e.length;n++){const r=await this.insertOne(e[n]);t.push(r.insertedId)}return{insertedIds:t}}isCapped(){throw new L("isCapped",{collection:this.name})}mapReduce(){throw new L("mapReduce",{collection:this.name})}reIndex(){throw new L("reIndex",{collection:this.name})}async replaceOne(e,t,n){const r={},i=this.find(e);if(r.matchedCount=i.count(),0==r.matchedCount){if(r.modifiedCount=0,n&&n.upsert){const e=t;e._id=this.idGenerator(),this.storage.set(e._id.toString(),e),this.updateIndexesOnInsert(e),this.emit("insert",e),r.upsertedId=e._id}}else{r.modifiedCount=1;const e=i.next();this.updateIndexesOnDelete(e),t._id=e._id,this.storage.set(e._id.toString(),t),this.updateIndexesOnInsert(t),this.emit("replace",t)}return r}remove(e,t){const n=this.find(e);if(n.hasNext())if(!0===t||t&&t.justOne){const e=n.next();this.updateIndexesOnDelete(e),this.storage.remove(e._id.toString())}else for(;n.hasNext();){const e=n.next();this.updateIndexesOnDelete(e),this.storage.remove(e._id.toString())}}renameCollection(){throw new L("renameCollection",{collection:this.name})}save(){throw new L("save",{collection:this.name})}stats(){throw new L("stats",{collection:this.name})}storageSize(){throw new L("storageSize",{collection:this.name})}totalSize(){throw new L("totalSize",{collection:this.name})}totalIndexSize(){throw new L("totalIndexSize",{collection:this.name})}update(e,t,n){const r=this.find(e);if(r.hasNext())if(n&&n.multi)for(;r.hasNext();){const i=r.next(),s=Te(i,e).arrayFilters,o=n&&n.arrayFilters;this.updateIndexesOnDelete(i),Ve(t,i,!1,s,o),this.storage.set(i._id.toString(),i),this.updateIndexesOnInsert(i)}else{const i=r.next(),s=Te(i,e).arrayFilters,o=n&&n.arrayFilters;this.updateIndexesOnDelete(i),Ve(t,i,!1,s,o),this.storage.set(i._id.toString(),i),this.updateIndexesOnInsert(i)}else if(n&&n.upsert){const n=Qe(e,t,this.idGenerator);this.storage.set(n._id.toString(),n),this.updateIndexesOnInsert(n)}}async updateOne(e,t,n){const r=this.find(e);if(r.hasNext()){const i=r.next(),s=JSON.parse(JSON.stringify(i)),o=Te(i,e).arrayFilters,a=n&&n.arrayFilters;this.updateIndexesOnDelete(i),Ve(t,i,!1,o,a),this.storage.set(i._id.toString(),i),this.updateIndexesOnInsert(i);const l=this._getUpdateDescription(s,i);this.emit("update",i,l)}else if(n&&n.upsert){const n=Qe(e,t,this.idGenerator);this.storage.set(n._id.toString(),n),this.updateIndexesOnInsert(n),this.emit("insert",n)}}async updateMany(e,t,n){const r=this.find(e);if(r.hasNext())for(;r.hasNext();){const i=r.next(),s=JSON.parse(JSON.stringify(i)),o=Te(i,e).arrayFilters,a=n&&n.arrayFilters;this.updateIndexesOnDelete(i),Ve(t,i,!1,o,a),this.storage.set(i._id.toString(),i),this.updateIndexesOnInsert(i);const l=this._getUpdateDescription(s,i);this.emit("update",i,l)}else if(n&&n.upsert){const n=Qe(e,t,this.idGenerator);this.storage.set(n._id.toString(),n),this.updateIndexesOnInsert(n),this.emit("insert",n)}}validate(){throw new L("validate",{collection:this.name})}_getUpdateDescription(e,t){const n={},r=[];for(const i in t)"_id"!==i&&JSON.stringify(e[i])!==JSON.stringify(t[i])&&(n[i]=t[i]);for(const i in e)"_id"!==i&&(i in t||r.push(i));return{updatedFields:n,removedFields:r,truncatedArrays:[]}}watch(e=[],t={}){return new ut(this,e,t)}}function dt(e,t){const n={},r=Object.keys(e);let i=!1,s=!1;for(const o of r){if("_id"===o)continue;const t=e[o];1===t||!0===t?i=!0:0===t||!1===t||(s=!0)}if(s||i){0!==e._id&&!1!==e._id&&(n._id=t._id);for(const i of r){const r=e[i];"_id"===i?0!==r&&!1!==r||delete n._id:n[i]=1===r||!0===r?o(t,i):fe(r,t)}}else{for(const e in t)t.hasOwnProperty(e)&&(n[e]=t[e]);for(const t of r)0!==e[t]&&!1!==e[t]||delete n[t]}return n}class ft{constructor(){this.data=/* @__PURE__ */new Map}clear(){this.data=/* @__PURE__ */new Map}keys(){return this.data.keys()}get(e){return this.data.get(e)}remove(e){this.data.delete(e)}set(e,t){this.data.set(e,t)}size(){return this.data.size}}class pt{constructor(){this.documents=new ft,this.indexes=/* @__PURE__ */new Map}clear(){this.documents.clear(),this.indexes.clear()}documentKeys(){return this.documents.keys()}getAllDocuments(){return Array.from(this.documents.data.values())}get(e){if("string"!=typeof e)throw new Error("Document key must be a string");return this.documents.get(e)}set(e,t){if("string"!=typeof e)throw new Error("Document key must be a string");this.documents.set(e,t)}remove(e){if("string"!=typeof e)throw new Error("Document key must be a string");this.documents.remove(e)}size(){return this.documents.size()}getStore(){const e={};for(const t of this.documents.keys())e[t]=this.documents.get(t);return e}indexesCount(){return this.indexes.size}indexKeys(){return this.indexes.keys()}createIndexStore(e,t){return this.indexes.has(e)||this.indexes.set(e,new ue(t)),this.indexes.get(e)}}class gt{constructor(){this.collections=/* @__PURE__ */new Map}collectionsCount(){return this.collections.size}collectionStoreKeys(){return this.collections.keys()}getCollectionStore(e){return this.collections.get(e)}createCollectionStore(e){if(this.collections.has(e))return this.collections.get(e);const t=new pt;return this.collections.set(e,t),t}removeCollectionStore(e){this.collections.delete(e)}save(){}}class mt{constructor(e){return this.options=e||{},this.dbName=this.options.dbName||"default",this.storageEngine=this.options.storageEngine||new gt,this._loadExistingCollections(),new Proxy(this,{get:(e,t,n)=>t in e?Reflect.get(e,t,n):"symbol"==typeof t||t.startsWith("_")?void 0:"string"==typeof t?(Object.prototype.hasOwnProperty.call(e,t)||e.createCollection(t),e[t]):void 0})}_log(e){this.options&&this.options.print?this.options.print(e):console.log(e)}_id(){return this.options&&this.options.id?this.options.id():new r}_loadExistingCollections(){for(const e of this.storageEngine.collectionStoreKeys()){const t=this.storageEngine.getCollectionStore(e);this[e]=new ht(this,e,t,this._id.bind(this))}}cloneCollection(){throw new L("cloneCollection",{database:this.dbName})}cloneDatabase(){throw new L("cloneDatabase",{database:this.dbName})}commandHelp(){throw new L("commandHelp",{database:this.dbName})}copyDatabase(){throw new L("copyDatabase",{database:this.dbName})}createCollection(e){e&&(this[e]=new ht(this,e,this.storageEngine.createCollectionStore(e),this._id.bind(this)))}collection(e){if(!e)throw new Error("Collection name is required");return this[e]&&this[e].isCollection||this.createCollection(e),this[e]}currentOp(){throw new L("currentOp",{database:this.dbName})}dropCollection(e){this[e]&&(this.storageEngine.removeCollectionStore(e),delete this[e])}dropDatabase(){const e=this.getCollectionNames();for(const t of e)this.storageEngine.removeCollectionStore(t),delete this[t]}eval(){throw new L("eval",{database:this.dbName})}fsyncLock(){throw new L("fsyncLock",{database:this.dbName})}fsyncUnlock(){throw new L("fsyncUnlock",{database:this.dbName})}getCollection(){throw new L("getCollection",{database:this.dbName})}getCollectionInfos(){throw new L("getCollectionInfos",{database:this.dbName})}getCollectionNames(){const e=[];for(const t in this)null!=this[t]&&this[t].isCollection&&e.push(t);return e}getLastError(){throw new L("getLastError",{database:this.dbName})}getLastErrorObj(){throw new L("getLastErrorObj",{database:this.dbName})}getLogComponents(){throw new L("getLogComponents",{database:this.dbName})}getMongo(){throw new L("getMongo",{database:this.dbName})}getName(){throw new L("getName",{database:this.dbName})}getPrevError(){throw new L("getPrevError",{database:this.dbName})}getProfilingLevel(){throw new L("getProfilingLevel",{database:this.dbName})}getProfilingStatus(){throw new L("getProfilingStatus",{database:this.dbName})}getReplicationInfo(){throw new L("getReplicationInfo",{database:this.dbName})}getSiblingDB(){throw new L("getSiblingDB",{database:this.dbName})}help(){this._log("        help mr                      mapreduce"),this._log("        db.foo.find()                list objects in collection foo"),this._log("        db.foo.find( { a : 1 } )     list objects in foo where a == 1"),this._log("        it                           result of the last line evaluated; use to further iterate")}hostInfo(){throw new L("hostInfo",{database:this.dbName})}isMaster(){throw new L("isMaster",{database:this.dbName})}killOp(){throw new L("killOp",{database:this.dbName})}listCommands(){throw new L("listCommands",{database:this.dbName})}loadServerScripts(){throw new L("loadServerScripts",{database:this.dbName})}logout(){throw new L("logout",{database:this.dbName})}printCollectionStats(){throw new L("printCollectionStats",{database:this.dbName})}printReplicationInfo(){throw new L("printReplicationInfo",{database:this.dbName})}printShardingStatus(){throw new L("printShardingStatus",{database:this.dbName})}printSlaveReplicationInfo(){throw new L("printSlaveReplicationInfo",{database:this.dbName})}repairDatabase(){throw new L("repairDatabase",{database:this.dbName})}resetError(){throw new L("resetError",{database:this.dbName})}runCommand(){throw new L("runCommand",{database:this.dbName})}serverBuildInfo(){throw new L("serverBuildInfo",{database:this.dbName})}serverCmdLineOpts(){throw new L("serverCmdLineOpts",{database:this.dbName})}serverStatus(){throw new L("serverStatus",{database:this.dbName})}setLogLevel(){throw new L("setLogLevel",{database:this.dbName})}setProfilingLevel(){throw new L("setProfilingLevel",{database:this.dbName})}shutdownServer(){throw new L("shutdownServer",{database:this.dbName})}stats(){throw new L("stats",{database:this.dbName})}version(){throw new L("version",{database:this.dbName})}upgradeCheck(){throw new L("upgradeCheck",{database:this.dbName})}upgradeCheckAllDBs(){throw new L("upgradeCheckAllDBs",{database:this.dbName})}watch(e=[],t={}){return new ut(this,e,t)}}class yt extends n.EventEmitter{constructor(e="mongodb://localhost:27017",t={}){super(),this.uri=e,this.options=Object.freeze({...t}),this._isConnected=!1,this._defaultDb=this._parseDefaultDbName(e)}static async connect(e,t={}){const n=new yt(e,t);return await n.connect(),n}async connect(){return this._isConnected||(this._isConnected=!0,this.emit("open",this)),this}db(e,t={}){const n=e||this._defaultDb;if(!n)throw new Error("No database name provided and no default in connection string");const r={...this.options,...t,dbName:n};return new mt(r)}async close(e=!1){this._isConnected&&(this._isConnected=!1,this.emit("close"))}startSession(e={}){return{id:crypto.randomUUID(),endSession:()=>{},withTransaction:async e=>await e(this)}}async withSession(e,t){const n=this.startSession("function"==typeof e?{}:e),r="function"==typeof e?e:t;try{return await r(n)}finally{n.endSession()}}get readConcern(){return this.options.readConcern}get writeConcern(){return this.options.writeConcern}get readPreference(){return this.options.readPreference}watch(e=[],t={}){return new ut(this,e,t)}_parseDefaultDbName(e){const t=e.match(/\/([^/?]+)/);return t?t[1]:null}}class xt extends gt{constructor(e="micro-mongo"){super(),this.dbName=e,this.db=null,this.indexedDBName=`micro-mongo-${e}`}async initialize(){return new Promise((e,t)=>{const n=indexedDB.open(this.indexedDBName,1);n.onerror=()=>{t(new Error("Failed to open IndexedDB: "+n.error))},n.onsuccess=()=>{this.db=n.result,e()},n.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains("collections")||t.createObjectStore("collections",{keyPath:"name"}),t.objectStoreNames.contains("metadata")||t.createObjectStore("metadata",{keyPath:"key"})}})}async saveDatabase(e){this.db||await this.initialize();const t=this.db.transaction(["metadata"],"readwrite").objectStore("metadata");await new Promise((n,r)=>{const i=t.put({key:"dbName",value:e.name});i.onsuccess=()=>n(),i.onerror=()=>r(i.error)});for(const n in e.collections)e.collections.hasOwnProperty(n)&&await this.saveCollection(e.name,n,e.collections[n])}async loadDatabase(e){this.db||await this.initialize();const t=this.db.transaction(["collections"],"readonly").objectStore("collections");return new Promise((n,r)=>{const i=t.getAll();i.onsuccess=()=>{const t={};for(const e of i.result)t[e.name]={documents:e.documents||[],indexes:e.indexes||[]};n({name:e,collections:t})},i.onerror=()=>r(i.error)})}async saveCollection(e,t,n){this.db||await this.initialize();const r=this.db.transaction(["collections"],"readwrite").objectStore("collections");return new Promise((e,i)=>{const s=r.put({name:t,documents:n.documents||[],indexes:n.indexes||[]});s.onsuccess=()=>e(),s.onerror=()=>i(s.error)})}async loadCollection(e,t){this.db||await this.initialize();const n=this.db.transaction(["collections"],"readonly").objectStore("collections");return new Promise((e,r)=>{const i=n.get(t);i.onsuccess=()=>{i.result?e({documents:i.result.documents||[],indexes:i.result.indexes||[]}):e(null)},i.onerror=()=>r(i.error)})}async deleteCollection(e,t){this.db||await this.initialize();const n=this.db.transaction(["collections"],"readwrite").objectStore("collections");return new Promise((e,r)=>{const i=n.delete(t);i.onsuccess=()=>e(),i.onerror=()=>r(i.error)})}async deleteDatabase(e){return this.db&&(this.db.close(),this.db=null),new Promise((e,t)=>{const n=indexedDB.deleteDatabase(this.indexedDBName);n.onsuccess=()=>e(),n.onerror=()=>t(n.error)})}async close(){this.db&&(this.db.close(),this.db=null)}}export{T as BadValueError,j as BulkWriteError,N as CannotCreateIndexError,ut as ChangeStream,k as CursorError,M as CursorNotFoundError,_ as DuplicateKeyError,g as ErrorCodes,v as IndexError,$ as IndexExistsError,S as IndexNotFoundError,xt as IndexedDbStorageEngine,C as InvalidNamespaceError,yt as MongoClient,x as MongoDriverError,m as MongoError,P as MongoNetworkError,y as MongoServerError,O as NamespaceError,I as NamespaceNotFoundError,L as NotImplementedError,r as ObjectId,D as OperationNotSupportedError,A as QueryError,gt as StorageEngine,Fe as Timestamp,E as TypeMismatchError,w as ValidationError,b as WriteError};
//# sourceMappingURL=micro-mongo-2.0.0.min.js.map
