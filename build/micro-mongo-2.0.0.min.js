var e,t={exports:{}};var n=function(){if(e)return t.exports;e=1;var n,r="object"==typeof Reflect?Reflect:null,s=r&&"function"==typeof r.apply?r.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};n=r&&"function"==typeof r.ownKeys?r.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var i=Number.isNaN||function(e){return e!=e};function o(){o.init.call(this)}t.exports=o,t.exports.once=function(e,t){return new Promise(function(n,r){function s(n){e.removeListener(t,i),r(n)}function i(){"function"==typeof e.removeListener&&e.removeListener("error",s),n([].slice.call(arguments))}g(e,t,i,{once:!0}),"error"!==t&&function(e,t,n){"function"==typeof e.on&&g(e,"error",t,n)}(e,s,{once:!0})})},o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var a=10;function l(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function c(e){return void 0===e._maxListeners?o.defaultMaxListeners:e._maxListeners}function h(e,t,n,r){var s,i,o,a;if(l(n),void 0===(i=e._events)?(i=e._events=/* @__PURE__ */Object.create(null),e._eventsCount=0):(void 0!==i.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),i=e._events),o=i[t]),void 0===o)o=i[t]=n,++e._eventsCount;else if("function"==typeof o?o=i[t]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),(s=c(e))>0&&o.length>s&&!o.warned){o.warned=!0;var h=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");h.name="MaxListenersExceededWarning",h.emitter=e,h.type=t,h.count=o.length,a=h,console&&console.warn&&console.warn(a)}return e}function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function d(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},s=u.bind(r);return s.listener=n,r.wrapFn=s,s}function f(e,t,n){var r=e._events;if(void 0===r)return[];var s=r[t];return void 0===s?[]:"function"==typeof s?n?[s.listener||s]:[s]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(s):m(s,s.length)}function p(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function m(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}function g(e,t,n,r){if("function"==typeof e.on)r.once?e.once(t,n):e.on(t,n);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,function s(i){r.once&&e.removeEventListener(t,s),n(i)})}}return Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return a},set:function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");a=e}}),o.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=/* @__PURE__ */Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},o.prototype.getMaxListeners=function(){return c(this)},o.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var r="error"===e,i=this._events;if(void 0!==i)r=r&&void 0===i.error;else if(!r)return!1;if(r){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var l=i[e];if(void 0===l)return!1;if("function"==typeof l)s(l,this,t);else{var c=l.length,h=m(l,c);for(n=0;n<c;++n)s(h[n],this,t)}return!0},o.prototype.addListener=function(e,t){return h(this,e,t,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(e,t){return h(this,e,t,!0)},o.prototype.once=function(e,t){return l(t),this.on(e,d(this,e,t)),this},o.prototype.prependOnceListener=function(e,t){return l(t),this.prependListener(e,d(this,e,t)),this},o.prototype.removeListener=function(e,t){var n,r,s,i,o;if(l(t),void 0===(r=this._events))return this;if(void 0===(n=r[e]))return this;if(n===t||n.listener===t)0===--this._eventsCount?this._events=/* @__PURE__ */Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(s=-1,i=n.length-1;i>=0;i--)if(n[i]===t||n[i].listener===t){o=n[i].listener,s=i;break}if(s<0)return this;0===s?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,s),1===n.length&&(r[e]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",e,o||t)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(e){var t,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=/* @__PURE__ */Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0===--this._eventsCount?this._events=/* @__PURE__ */Object.create(null):delete n[e]),this;if(0===arguments.length){var s,i=Object.keys(n);for(r=0;r<i.length;++r)"removeListener"!==(s=i[r])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=/* @__PURE__ */Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},o.prototype.listeners=function(e){return f(this,e,!0)},o.prototype.rawListeners=function(e){return f(this,e,!1)},o.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):p.call(e,t)},o.prototype.listenerCount=p,o.prototype.eventNames=function(){return this._eventsCount>0?n(this._events):[]},t.exports}();class r{constructor(e){if(null==e)this.id=r.generate();else if("string"==typeof e){if(!r.isValid(e))throw new Error(`Argument passed in must be a string of 24 hex characters, got: ${e}`);this.id=e.toLowerCase()}else{if(!(e instanceof r))throw new Error("Argument passed in must be a string of 24 hex characters or an ObjectId");this.id=e.id}}toString(){return this.id}toHexString(){return this.id}getTimestamp(){const e=parseInt(this.id.substring(0,8),16);return new Date(1e3*e)}equals(e){return!!e&&(e instanceof r?this.id===e.id:"string"==typeof e?this.id===e.toLowerCase():!!e.id&&this.id===e.id)}toJSON(){return this.id}inspect(){return`ObjectId("${this.id}")`}static isValid(e){return!!e&&("string"==typeof e&&(24===e.length&&/^[0-9a-fA-F]{24}$/.test(e)))}static createFromTime(e){const t=("00000000"+Math.floor(e/1e3).toString(16)).slice(-8);return new r(t+"0000000000000000")}static generate(){const e=Math.floor(Date.now()/1e3),t="undefined"!=typeof crypto&&crypto.getRandomValues?new Uint8Array(8):null;let n="";if(t){crypto.getRandomValues(t);for(let e=0;e<t.length;e++)n+=("0"+t[e].toString(16)).slice(-2)}else n=Math.random().toString(16).slice(2).padEnd(8,"0").slice(0,8)+Math.random().toString(16).slice(2).padEnd(8,"0").slice(0,8);return(("00000000"+e.toString(16)).slice(-8)+n).slice(0,24)}}function s(e,t){return e instanceof r||t instanceof r?e instanceof r&&t instanceof r||e instanceof r&&"string"==typeof t?e.equals(t):t instanceof r&&"string"==typeof e&&t.equals(e):e==t}function i(e){if(e instanceof r)return new r(e.id);var t,n,s;for(s in t=Array.isArray(e)?[]:{},e)n=e[s],t[s]="object"==typeof n&&null!==n?i(n):n;return t}function o(e,t){for(var n=t.split("."),r=e[n[0]],s=1;s<n.length;s++){if(null==r||null==r)return r;var i=n[s],o=parseInt(i,10);r=l(r)&&!isNaN(o)&&o>=0&&o<r.length?r[o]:r[i]}return r}function a(e,t,n){for(var r=t.split("."),s=e,i=0;i<r.length-1;i++){var o=r[i],a=parseInt(o,10);if(l(s)&&!isNaN(a)&&a>=0){for(;s.length<=a;)s.push(void 0);if(null==s[a]||null==s[a]){var c=r[i+1],h=parseInt(c,10);!isNaN(h)&&h>=0?s[a]=[]:s[a]={}}s=s[a]}else{if(null==s[o]||null==s[o]){c=r[i+1],h=parseInt(c,10);!isNaN(h)&&h>=0?s[o]=[]:s[o]={}}s=s[o]}}var u=r[r.length-1],d=parseInt(u,10);if(l(s)&&!isNaN(d)&&d>=0){for(;s.length<=d;)s.push(void 0);s[d]=n}else s[u]=n}function l(e){return Array==e.constructor}function c(e,t){for(var n=0;n<t.length;n++)if(s(t[n],e))return!0;return!1}function h(e,t){if(e.length!=t.length)return!1;for(var n=0;n<e.length;n++)if(!s(e[n],t[n])){if(typeof e[n]!=typeof t[n])return!1;if("object"==typeof e[n]&&null!==e[n]){if(l(e[n])){if(!h(e[n],t[n]))return!1}else if(!u(e[n],t[n]))return!1}else if(!s(e[n],t[n]))return!1}return!0}function u(e,t){for(var n in e)if(e.hasOwnProperty(n)){if(!t.hasOwnProperty(n))return!1;if(!s(e[n],t[n])){if(typeof e[n]!=typeof t[n])return!1;if("object"==typeof e[n]&&null!==e[n]){if(l(e[n])){if(!h(e[n],t[n]))return!1}else if(!u(e[n],t[n]))return!1}else if(!s(e[n],t[n]))return!1}}for(var n in t)if(t.hasOwnProperty(n)&&!e.hasOwnProperty(n))return!1;return!0}function d(e,t){var n={},r=Object.keys(e);if(0==r.length)return t;for(var s=!1,c=!1,h=0;h<r.length;h++)"_id"!==r[h]&&(e[r[h]]?s=!0:c=!0);if(s&&c)throw{$err:"Can't canonicalize query: BadValue Projection cannot have a mix of inclusion and exclusion.",code:17287};if(e[r[0]]||s){0!==e._id&&(n._id=t._id);for(h=0;h<r.length;h++)if("_id"!==r[h]&&e[r[h]]){var u=o(t,p=r[h]);void 0!==u&&a(n,p,u)}}else{for(var d in t)if(t.hasOwnProperty(d)){var f=t[d];"object"!=typeof f||null===f||l(f)?l(f)?n[d]=f.slice():n[d]=f:n[d]=i(f)}for(h=0;h<r.length;h++)if(!e[r[h]]){var p,m=(p=r[h]).split(".");if(1===m.length)delete n[p];else{for(var g=n,y=0;y<m.length-1&&(null!=g&&null!=g);y++)g=g[m[y]];null!=g&&null!=g&&delete g[m[m.length-1]]}}}return n}class f{constructor(e,t,n,r,s){if(this.collection=e,this.query=t,this.projection=n,this.documents=r,this.SortedCursor=s,n&&Object.keys(n).length>0){const e=Object.keys(n);let t=!1,r=!1;for(let s=0;s<e.length;s++)"_id"!==e[s]&&(n[e[s]]?t=!0:r=!0);if(t&&r)throw{$err:"Can't canonicalize query: BadValue Projection cannot have a mix of inclusion and exclusion.",code:17287}}this.pos=0,this.max=0}batchSize(){throw"Not Implemented"}close(){throw"Not Implemented"}comment(){throw"Not Implemented"}count(){return this.documents.length}explain(){throw"Not Implemented"}async forEach(e){for(;this.hasNext();)await e(this.next())}hasNext(){const e=this.max>0?Math.min(this.max,this.documents.length):this.documents.length;return this.pos<e}hint(){throw"Not Implemented"}itcount(){throw"Not Implemented"}limit(e){return this.max=e,this}map(e){const t=[];for(;this.hasNext();)t.push(e(this.next()));return t}maxScan(){throw"Not Implemented"}maxTimeMS(){throw"Not Implemented"}max(){throw"Not Implemented"}min(){throw"Not Implemented"}next(){if(!this.hasNext())throw"Error: error hasNext: false";const e=this.documents[this.pos++];return this.projection?d(this.projection,e):e}noCursorTimeout(){throw"Not Implemented"}objsLeftInBatch(){throw"Not Implemented"}pretty(){throw"Not Implemented"}readConcern(){throw"Not Implemented"}readPref(){throw"Not Implemented"}returnKey(){throw"Not Implemented"}showRecordId(){throw"Not Implemented"}size(){throw"Not Implemented"}skip(e){return this.pos=Math.min(this.pos+e,this.documents.length),this}snapshot(){throw"Not Implemented"}sort(e){return new this.SortedCursor(this.collection,this.query,this,e)}tailable(){throw"Not Implemented"}async toArray(){const e=[];for(;this.hasNext();)e.push(this.next());return e}async*[Symbol.asyncIterator](){for(;this.hasNext();)yield this.next()}}class p{constructor(e,t,n,r){for(this.collection=e,this.query=t,this.sortSpec=r,this.pos=0,this.items=[];n.hasNext();)this.items.push(n.next());const s=Object.keys(r);this.items.sort(function(e,t){for(let n=0;n<s.length;n++){if(null==e[s[n]]&&null!=t[s[n]])return-1*r[s[n]];if(null!=e[s[n]]&&null==t[s[n]])return 1*r[s[n]];if(e[s[n]]<t[s[n]])return-1*r[s[n]];if(e[s[n]]>t[s[n]])return 1*r[s[n]]}return 0})}batchSize(){throw"Not Implemented"}close(){throw"Not Implemented"}comment(){throw"Not Implemented"}count(){return this.items.length}explain(){throw"Not Implemented"}async forEach(e){for(;this.hasNext();)await e(this.next())}hasNext(){return this.pos<this.items.length}hint(){throw"Not Implemented"}itcount(){throw"Not Implemented"}limit(e){return this.items=this.items.slice(0,e),this}map(e){const t=[];for(;this.hasNext();)t.push(e(this.next()));return t}maxScan(){throw"Not Implemented"}maxTimeMS(){throw"Not Implemented"}max(){throw"Not Implemented"}min(){throw"Not Implemented"}next(){return this.items[this.pos++]}noCursorTimeout(){throw"Not Implemented"}objsLeftInBatch(){throw"Not Implemented"}pretty(){throw"Not Implemented"}readConcern(){throw"Not Implemented"}readPref(){throw"Not Implemented"}returnKey(){throw"Not Implemented"}showRecordId(){throw"Not Implemented"}size(){throw"Not Implemented"}skip(e){for(;e>0;)this.next(),e--;return this}snapshot(){throw"Not Implemented"}sort(e){return new p(this.collection,this.query,this,e)}tailable(){throw"Not Implemented"}async toArray(){const e=[];for(;this.hasNext();)e.push(this.next());return e}async*[Symbol.asyncIterator](){for(;this.hasNext();)yield this.next()}}const m={ational:"ate",tional:"tion",enci:"ence",anci:"ance",izer:"ize",bli:"ble",alli:"al",entli:"ent",eli:"e",ousli:"ous",ization:"ize",ation:"ate",ator:"ate",alism:"al",iveness:"ive",fulness:"ful",ousness:"ous",aliti:"al",iviti:"ive",biliti:"ble",logi:"log"},g={icate:"ic",ative:"",alize:"al",iciti:"ic",ical:"ic",ful:"",ness:""},y="[aeiouy]",x="([^aeiou][^aeiouy]*)",w="("+y+"[aeiou]*)",b=new RegExp("^"+x+"?"+w+x),_=new RegExp("^"+x+"?"+w+x+w+"?$"),v=new RegExp("^"+x+"?("+w+x+"){2,}"),$=new RegExp("^"+x+"?"+y),I=new RegExp("^"+x+y+"[^aeiouwxy]$"),S=/ll$/,N=/^(.+?)e$/,k=/^(.+?)y$/,M=/^(.+?(s|t))(ion)$/,C=/^(.+?)(ed|ing)$/,A=/(at|bl|iz)$/,L=/^(.+?)eed$/,O=/^.+?[^s]s$/,D=/^.+?(ss|i)es$/,j=/([^aeiouylsz])\1$/,E=/^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$/,T=/^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/,B=/^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$/;function P(e){let t=String(e).toLowerCase();if(t.length<3)return t;let n,r=!1;return 121===t.codePointAt(0)&&(r=!0,t="Y"+t.slice(1)),D.test(t)?t=t.slice(0,-2):O.test(t)&&(t=t.slice(0,-1)),(n=L.exec(t))?b.test(n[1])&&(t=t.slice(0,-1)):(n=C.exec(t))&&$.test(n[1])&&(t=n[1],A.test(t)?t+="e":j.test(t)?t=t.slice(0,-1):I.test(t)&&(t+="e")),(n=k.exec(t))&&$.test(n[1])&&(t=n[1]+"i"),(n=E.exec(t))&&b.test(n[1])&&(t=n[1]+m[n[2]]),(n=T.exec(t))&&b.test(n[1])&&(t=n[1]+g[n[2]]),(n=B.exec(t))?v.test(n[1])&&(t=n[1]):(n=M.exec(t))&&v.test(n[1])&&(t=n[1]),(n=N.exec(t))&&(v.test(n[1])||_.test(n[1])&&!I.test(n[1]))&&(t=n[1]),S.test(t)&&v.test(t)&&(t=t.slice(0,-1)),r&&(t="y"+t.slice(1)),t}class z{constructor(e){if(this._meta=/* @__PURE__ */new Map,this._data=/* @__PURE__ */new Map,e)for(const[t,n]of Object.entries(e))this._meta.set(t,n)}setMeta(e,t){this._meta.set(e,t)}hasMeta(e){return this._meta.has(e)}getMeta(e){return this._meta.get(e)}hasDataMap(e){return this._data.has(e)}getDataMap(e){return this._data.has(e)||this._data.set(e,/* @__PURE__ */new Map),this._data.get(e)}}const F=/* @__PURE__ */new Set(["a","about","after","all","also","am","an","and","another","any","are","around","as","at","be","because","been","before","being","between","both","but","by","came","can","come","could","did","do","each","for","from","get","got","has","had","he","have","her","here","him","himself","his","how","i","if","in","into","is","it","like","make","many","me","might","more","most","much","must","my","never","now","of","on","only","or","other","our","out","over","said","same","see","should","since","some","still","such","take","than","that","the","their","them","then","there","these","they","this","those","through","to","too","under","up","very","was","way","we","well","were","what","where","which","while","who","with","would","you","your"]);class q{constructor(e=new z){this.storage=e,this.index=this.storage.getDataMap("index"),this.documentTerms=this.storage.getDataMap("documentTerms"),this.documentLengths=this.storage.getDataMap("documentLengths")}_tokenize(e){if("string"!=typeof e)return[];return e.toLowerCase().split(/\W+/).filter(e=>e.length>0).filter(e=>!F.has(e))}add(e,t){if(!e)throw new Error("Document ID is required");const n=this._tokenize(t),r=/* @__PURE__ */new Map;n.forEach(e=>{const t=P(e);r.set(t,(r.get(t)||0)+1)}),r.forEach((t,n)=>{this.index.has(n)||this.index.set(n,/* @__PURE__ */new Map),this.index.get(n).set(e,t)}),this.documentTerms.set(e,r),this.documentLengths.set(e,n.length)}remove(e){if(!this.documentTerms.has(e))return!1;return this.documentTerms.get(e).forEach((t,n)=>{this.index.has(n)&&(this.index.get(n).delete(e),0===this.index.get(n).size&&this.index.delete(n))}),this.documentTerms.delete(e),this.documentLengths.delete(e),!0}query(e,t={scored:!0,requireAll:!1}){const n=this._tokenize(e);if(0===n.length)return[];const r=n.map(e=>P(e)),s=[...new Set(r)];if(t.requireAll){const e=s.map(e=>{const t=this.index.get(e);return t?new Set(t.keys()):/* @__PURE__ */new Set});if(0===e.length)return[];const t=new Set(e[0]);for(let n=1;n<e.length;n++)for(const r of t)e[n].has(r)||t.delete(r);return Array.from(t)}const i=this.documentLengths.size,o=/* @__PURE__ */new Map;s.forEach(e=>{const t=this.index.get(e)?.size||0;t>0&&o.set(e,Math.log(i/t))});const a=/* @__PURE__ */new Map;s.forEach(e=>{const t=this.index.get(e);t&&t.forEach((t,n)=>{a.has(n)||a.set(n,0);const r=t/(this.documentLengths.get(n)||1)*(o.get(e)||0);a.set(n,a.get(n)+r)})}),a.forEach((e,t)=>{const n=this.documentTerms.get(t);if(n){const r=s.filter(e=>n.has(e)).length/s.length;a.set(t,e*(1+r))}});const l=Array.from(a.entries()).map(([e,t])=>({id:e,score:t})).sort((e,t)=>t.score-e.score);return!1===t.scored?l.map(e=>e.id):l}getTermCount(){return this.index.size}getDocumentCount(){return this.documentTerms.size}clear(){this.index.clear(),this.documentTerms.clear(),this.documentLengths.clear()}}function U(e,t){return e instanceof r||t instanceof r?e instanceof r&&t instanceof r||e instanceof r&&"string"==typeof t?e.equals(t):t instanceof r&&"string"==typeof e&&t.equals(e):e==t}function R(e,t,n){let s=e,i=t;switch(e instanceof r&&(s=e.toString()),t instanceof r&&(i=t.toString()),n){case">":return s>i;case">=":return s>=i;case"<":return s<i;case"<=":return s<=i;default:return!1}}function Q(e,t){if(null==e)return!1;if(l(e)){for(var n=0;n<e.length;n++)if(t(e[n]))return!0;return!1}return t(e)}function K(e,t){const n=new q;n.add("id",e);return 1===n.query(t,{scored:!1}).length}function W(e,t){try{if(!Array.isArray(t)||2!==t.length)return!1;const n=t[0][0],r=t[0][1],s=t[1][0];return G(e,n,s,t[1][1],r)}catch(n){return!1}}function G(e,t,n,r,s){if(!e)return!1;if("FeatureCollection"===e.type&&e.features&&e.features.length>0){for(const i of e.features)if(i.geometry&&!G(i.geometry,t,n,r,s))return!1;return!0}if("Feature"===e.type&&e.geometry)return G(e.geometry,t,n,r,s);if("Point"===e.type&&e.coordinates){const[i,o]=e.coordinates;if("number"==typeof i&&"number"==typeof o)return i>=t&&i<=n&&o>=r&&o<=s}if("Polygon"===e.type&&e.coordinates&&e.coordinates.length>0){for(const i of e.coordinates)for(const e of i){const i=e[0],o=e[1];if(i<t||i>n||o<r||o>s)return!1}return!0}return!1}function V(e,t){var n=Object.keys(t)[0],r=t[n];if("$"==n.charAt(0)){if("$and"==n)return Y(e,r);if("$or"==n)return function(e,t){for(var n=0;n<t.length;n++)if(V(e,t[n]))return!0;return!1}(e,r);if("$not"==n)return function(e,t){return!V(e,t)}(e,r);if("$nor"==n)return function(e,t){for(var n=0;n<t.length;n++)if(V(e,t[n]))return!1;return!0}(e,r);if("$where"==n)return function(e,t){if("function"==typeof t)try{return t.call(e)}catch(n){return!1}else if("string"==typeof t)try{return new Function("return "+t).call(e)}catch(n){return!1}return!1}(e,r);throw{$err:"Can't canonicalize query: BadValue unknown top level operator: "+n,code:17287}}return J(e,n,r)}function J(e,t,n){var s=function(e,t){for(var n=t.split("."),r=[e],s=0;s<n.length;s++){for(var i=n[s],o=parseInt(i,10),a=[],c=0;c<r.length;c++){var h=r[c];if(null!=h&&null!=h)if(l(h)&&!isNaN(o)&&o>=0)o<h.length&&a.push(h[o]);else if(l(h))for(var u=0;u<h.length;u++)null!=h[u]&&null!=h[u]&&"object"==typeof h[u]&&a.push(h[u][i]);else"object"==typeof h&&a.push(h[i])}r=a}if(0!==(r=r.filter(function(e){return void 0!==e})).length)return 1===r.length?r[0]:r}(e,t);if("string"==typeof n)return Q(s,function(e){return U(e,n)});if("number"==typeof n)return Q(s,function(e){return U(e,n)});if("boolean"==typeof n)return Q(s,function(e){return U(e,n)});if(n instanceof r)return Q(s,function(e){return U(e,n)});if("object"==typeof n){if(n instanceof RegExp)return null!=s&&Q(s,function(e){return e&&e.match(n)});if(l(n))return null!=s&&Q(s,function(e){return e&&h(e,n)});var i=Object.keys(n);if("$"==i[0].charAt(0)){for(var a=0;a<i.length;a++){var d=Object.keys(n)[a],f=n[d];if("$eq"==d){if(!Q(s,function(e){return U(e,f)}))return!1}else if("$gt"==d){if(!Q(s,function(e){return R(e,f,">")}))return!1}else if("$gte"==d){if(!Q(s,function(e){return R(e,f,">=")}))return!1}else if("$lt"==d){if(!Q(s,function(e){return R(e,f,"<")}))return!1}else if("$lte"==d){if(!Q(s,function(e){return R(e,f,"<=")}))return!1}else if("$ne"==d){if(!Q(s,function(e){return!U(e,f)}))return!1}else if("$in"==d){if(!Q(s,function(e){return c(e,f)}))return!1}else if("$nin"==d){if(Q(s,function(e){return c(e,f)}))return!1}else if("$exists"==d){var p=o(e,t);if(f?null==p:null!=p)return!1}else if("$type"==d){if(!Q(s,function(e){return typeof e==f}))return!1}else if("$mod"==d){if(2!=f.length)throw{$err:"Can't canonicalize query: BadValue malformed mod, not enough elements",code:17287};if(!Q(s,function(e){return null!=e&&e%f[0]==f[1]}))return!1}else if("$regex"==d){if(!Q(s,function(e){return null!=e&&e.match(f)}))return!1}else if("$text"==d){if(!Q(s,function(e){return null!=e&&K(e,f)}))return!1}else if("$geoWithin"==d){if(!Q(s,function(e){return null!=e&&W(e,f)}))return!1}else if("$near"==d||"$nearSphere"==d||"$geoIntersects"==d);else if("$not"==d){if(J(e,t,f))return!1}else if("$all"==d){if(null==(g=o(e,t))||!l(g))return!1;for(var m=0;m<f.length;m++)if(!c(f[m],g))return!1}else if("$elemMatch"==d){var g;if(null==(g=o(e,t))||!l(g))return!1;var y=!1;for(m=0;m<g.length;m++){var x=g[m];if("object"!=typeof x||l(x)){for(var w=!0,b=Object.keys(f),_=0;_<b.length;_++){var v=b[_],$=f[v];("$gte"!=v||x>=$)&&("$gt"!=v||x>$)&&("$lte"!=v||x<=$)&&("$lt"!=v||x<$)?"$eq"==v&&x!=$||"$ne"==v&&x==$?w=!1:"$in"!=v||c(x,$)?"$nin"==v&&c(x,$)&&(w=!1):w=!1:w=!1}if(w){y=!0;break}}else if(H(x,f)){y=!0;break}}if(!y)return!1}else{if("$size"!=d)throw{$err:"Can't canonicalize query: BadValue unknown operator: "+d,code:17287};var I=o(e,t);if(null==I||!l(I))return!1;if(I.length!=f)return!1}}return!0}return o(e,t)&&u(o(e,t),n)}}function Y(e,t){for(var n=0;n<t.length;n++)if(!V(e,t[n]))return!1;return!0}function H(e,t){return Y(e,function(e){var t=[];for(var n in e)if(e.hasOwnProperty(n)){var r={};r[n]=e[n],t.push(r)}return t}(t))}function Z(e,t,n){for(var r=Object.keys(e),s=0;s<r.length;s++){var i=r[s],l=e[i];if("$inc"==i)for(var c=Object.keys(l),h=0;h<c.length;h++){var u=l[b=c[h]],d=o(t,b);null==d&&(d=0),a(t,b,d+u)}else if("$mul"==i)for(c=Object.keys(l),h=0;h<c.length;h++){u=l[b=c[h]];t[b]=t[b]*u}else if("$rename"==i)for(c=Object.keys(l),h=0;h<c.length;h++){t[l[b=c[h]]]=t[b],delete t[b]}else if("$setOnInsert"==i&&n)for(c=Object.keys(l),h=0;h<c.length;h++)t[c[h]]=l[c[h]];else if("$set"==i)for(c=Object.keys(l),h=0;h<c.length;h++){a(t,b=c[h],l[b])}else if("$unset"==i)for(c=Object.keys(l),h=0;h<c.length;h++)delete t[c[h]];else if("$min"==i)for(c=Object.keys(l),h=0;h<c.length;h++){u=l[b=c[h]];t[b]=Math.min(t[b],u)}else if("$max"==i)for(c=Object.keys(l),h=0;h<c.length;h++){u=l[b=c[h]];t[b]=Math.max(t[b],u)}else if("$currentDate"==i)for(c=Object.keys(l),h=0;h<c.length;h++)t[c[h]]=/* @__PURE__ */new Date;else if("$addToSet"==i)for(c=Object.keys(l),h=0;h<c.length;h++){l=l[b=c[h]];t[b].push(l)}else if("$pop"==i)for(c=Object.keys(l),h=0;h<c.length;h++){1==(l=l[b=c[h]])?t[b].pop():-1==l&&t[b].shift()}else if("$pullAll"==i)for(c=Object.keys(l),h=0;h<c.length;h++){for(var f=t[c[h]],p=l[c[h]],m=[],g=0;g<f.length;g++){for(var y=!1,x=0;x<p.length;x++)if(f[g]==p[x]){y=!0;break}y||m.push(f[g])}t[c[h]]=m}else if("$pushAll"==i)for(c=Object.keys(l),h=0;h<c.length;h++){var w=l[b=c[h]];for(g=0;g<w.length;g++)t[b].push(w[g])}else if("$push"==i)for(c=Object.keys(l),h=0;h<c.length;h++){t[b=c[h]].push(l[b])}else{if("$bit"!=i)throw"unknown update operator: "+i;var b,_=l[b=Object.keys(l)[0]],v=Object.keys(_)[0],$=_[v];if("and"==v)t[b]=t[b]&$;else if("or"==v)t[b]=t[b]|$;else{if("xor"!=v)throw"unknown $bit operator: "+v;t[b]=t[b]^$}}}}function X(e,t,n){for(var r={_id:n()},s=!0,i=Object.keys(t),o=0;o<i.length;o++)if("$"==i[o].charAt(0)){s=!1;break}if(s)for(o=0;o<i.length;o++)r[i[o]]=t[i[o]];else{var a=Object.keys(e);for(o=0;o<a.length;o++)r[a[o]]=e[a[o]];Z(t,r,!0)}return r}class ee{constructor(e,t,n,r={}){this.name=e,this.keys=t,this.storage=n,this.options=r}add(e){throw new Error("add() must be implemented by subclass")}remove(e){throw new Error("remove() must be implemented by subclass")}update(e,t){this.remove(e),this.add(t)}query(e){throw new Error("query() must be implemented by subclass")}clear(){throw new Error("clear() must be implemented by subclass")}getSpec(){return{name:this.name,key:this.keys}}serialize(){throw new Error("serialize() must be implemented by subclass")}deserialize(e){throw new Error("deserialize() must be implemented by subclass")}}function te(e){return"string"==typeof e&&""!==e.trim()&&Number.isFinite(+e)}class ne{constructor(e,t,n){if(!(t instanceof z))throw new Error("IndexStore is required to create BPlusTreeNode");if("object"==typeof e){this._data=e,this.id=this._data.id,this.keys=this._data.keys,this.values=this._data.values,this.children=[];for(const e of this._data.children){if(n.has(e)){this.children.push(n.get(e));continue}const r=t.getDataMap("nodes").get(e);if(!r)throw new Error(`BPlusTreeNode: Child node with id ${e} not found in IndexStore`);const s=new ne(r,t,n);this.children.push(s),n.set(e,s)}if(this.isLeaf=this._data.isLeaf,this._data.next)if(n.has(this._data.next))this.next=n.get(this._data.next);else{const e=t.getDataMap("nodes").get(this._data.next);if(!e)throw new Error(`BPlusTreeNode: Next leaf node with id ${this._data.next} not found in IndexStore`);this.next=new ne(e,t,n),n.set(this.next.id,this.next)}else this.next=null}else this._data={id:t.getMeta("nextId"),keys:[],values:[],children:[],isLeaf:e,next:null},t.setMeta("nextId",this._data.id+1),t.getDataMap("nodes").set(this._data.id,this._data),this.id=this._data.id,this.keys=this._data.keys,this.values=this._data.values,this.children=[],this.isLeaf=this._data.isLeaf,this.next=null;const r=this;return new Proxy(this,{get:(e,n)=>"children"===n?new Proxy(e.children,{get(e,n,s){if(!te(n)){if("length"===n)return Reflect.get(e,n,s);if("splice"===n)return function(...s){if(3==s.length){if(!(s[2]instanceof ne))throw new Error("BPlusTreeNode: children array can only store BPlusTreeNode instances",s[2]);r._data.children.splice(s[0],s[1],s[2].id),t.getDataMap("nodes").set(r._data.id,r._data)}return Reflect.apply(e[n],e,s)};if("push"===n)return function(...e){if(1!==e.length)throw new Error("BPlusTreeNode: children.push only supports single argument");if(e[0]instanceof ne)return r._data.children.push(e[0].id),t.getDataMap("nodes").set(r._data.id,r._data),r.children.push(e[0]);throw new Error("BPlusTreeNode: children array can only store BPlusTreeNode instances",e[2])}}return Reflect.get(e,n,s)},set:(e,n,s,i)=>(te(n)&&s instanceof ne?Reflect.set(r._data.children,n,s.id,i):Reflect.set(r._data.children,n,s,i),t.getDataMap("nodes").set(r._data.id,r._data),Reflect.set(e,n,s,i))}):Reflect.get(e,n),set(e,n,r){if("next"===n)if(r instanceof ne)e.next=r,e._data.next=r.id,t.getDataMap("nodes").set(e._data.id,e._data);else{if(null!==r)throw new Error("BPlusTreeNode: next pointer must be a BPlusTreeNode or null");e.next=null,e._data.next=null,t.getDataMap("nodes").set(e._data.id,e._data)}else"isLeaf"===n?(e.isLeaf=r,e._data.isLeaf=r,t.getDataMap("nodes").set(e._data.id,e._data)):"children"===n?(e.children=r,e._data.children=r.map(e=>e.id),t.getDataMap("nodes").set(e._data.id,e._data)):(e[n]=r,e._data[n]=r,t.getDataMap("nodes").set(e._data.id,e._data));return!0}})}}class re{constructor(e=3,t=new z){if(e<3)throw new Error("B+ tree order must be at least 3");if(this.order=e,this.minKeys=Math.ceil(e/2)-1,this.indexStore=t,t.hasMeta("order")){if(t.getMeta("order")!==this.order)throw new Error(`B+ tree order does not match stored index metadata ${t.getMeta("order")} != ${this.order}`);if(t.getMeta("minKeys")!=this.minKeys)throw new Error(`B+ tree minKeys does not match stored index metadata ${t.getMeta("minKeys")} != ${this.minKeys}`);this._buildTreeFromStorage()}else this.indexStore.setMeta("order",this.order),this.indexStore.setMeta("minKeys",this.minKeys),this.indexStore.setMeta("nextId",1),this.root=new ne(!0,this.indexStore),this.indexStore.setMeta("rootId",this.root.id)}_buildTreeFromStorage(){const e=/* @__PURE__ */new Map,t=this.indexStore.getDataMap("nodes").get(this.indexStore.getMeta("rootId"));if(!t)throw new Error("BPlusTree: Root node not found in IndexStore");this.root=new ne(t,this.indexStore,e)}search(e){return this._searchNode(this.root,e)}_searchNode(e,t){if(e.isLeaf){const n=[];for(let r=0;r<e.keys.length;r++)t===e.keys[r]&&n.push(...e.values[r]);return n}{let n=0;for(;n<e.keys.length&&t>=e.keys[n];)n++;return this._searchNode(e.children[n],t)}}add(e,t){if(this.root.keys.length===this.indexStore.getMeta("order")-1){const e=new ne(!1,this.indexStore);e.children.push(this.root),this._splitChild(e,0),this.root=e,this.indexStore.setMeta("rootId",this.root.id)}this._insertNonFull(this.root,e,t)}_insertNonFull(e,t,n){let r=e.keys.length-1;if(e.isLeaf){for(let r=0;r<e.keys.length;r++)if(e.keys[r]===t)return void e.values[r].push(n);for(e.keys.push(null),e.values.push(null);r>=0&&t<e.keys[r];)e.keys[r+1]=e.keys[r],e.values[r+1]=e.values[r],r--;e.keys[r+1]=t,e.values[r+1]=[n]}else{for(r=0;r<e.keys.length&&t>=e.keys[r];)r++;e.children[r].keys.length===this.indexStore.getMeta("order")-1&&(this._splitChild(e,r),t>=e.keys[r]&&r++),this._insertNonFull(e.children[r],t,n)}}_splitChild(e,t){const n=e.children[t],r=new ne(n.isLeaf,this.indexStore),s=Math.floor((this.indexStore.getMeta("order")-1)/2);if(n.isLeaf)r.keys=n.keys.splice(s),r.values=n.values.splice(s),r.next=n.next,n.next=r,e.keys.splice(t,0,r.keys[0]);else{r.keys=n.keys.splice(s+1);const i=n.keys.pop();r.children=n.children.splice(s+1),e.keys.splice(t,0,i)}e.children.splice(t+1,0,r)}deleteValue(e,t){const n=this._deleteValue(this.root,e,t);return 0===this.root.keys.length&&!this.root.isLeaf&&this.root.children.length>0&&(this.root=this.root.children[0],this.indexStore.setMeta("rootId",this.root.id)),n}delete(e){const t=this._delete(this.root,e);return 0===this.root.keys.length&&!this.root.isLeaf&&this.root.children.length>0&&(this.root=this.root.children[0],this.indexStore.setMeta("rootId",this.root.id)),t}_deleteValue(e,t,n){if(e.isLeaf){for(let r=0;r<e.keys.length;r++)if(t===e.keys[r]){const t=e.values[r],s=t.indexOf(n);return-1!==s&&(t.splice(s,1),0===t.length&&(e.keys.splice(r,1),e.values.splice(r,1)),!0)}return!1}{let r=0;for(;r<e.keys.length&&t>=e.keys[r];)r++;const s=this._deleteValue(e.children[r],t,n);return s&&this._rebalanceAfterDelete(e,r),s}}_delete(e,t){if(e.isLeaf){for(let n=0;n<e.keys.length;n++)if(t===e.keys[n])return e.keys.splice(n,1),e.values.splice(n,1),!0;return!1}{let n=0;for(;n<e.keys.length&&t>=e.keys[n];)n++;const r=this._delete(e.children[n],t);return r&&this._rebalanceAfterDelete(e,n),r}}_rebalanceAfterDelete(e,t){if(!(e.children[t].keys.length>=this.indexStore.getMeta("minKeys"))){if(t>0){if(e.children[t-1].keys.length>this.indexStore.getMeta("minKeys"))return void this._borrowFromLeft(e,t)}if(t<e.children.length-1){if(e.children[t+1].keys.length>this.indexStore.getMeta("minKeys"))return void this._borrowFromRight(e,t)}t>0?this._merge(e,t-1):this._merge(e,t)}}_borrowFromLeft(e,t){const n=e.children[t],r=e.children[t-1];n.isLeaf?(n.keys.unshift(r.keys.pop()),n.values.unshift(r.values.pop()),e.keys[t-1]=n.keys[0]):(n.keys.unshift(e.keys[t-1]),e.keys[t-1]=r.keys.pop(),n.children.unshift(r.children.pop()))}_borrowFromRight(e,t){const n=e.children[t],r=e.children[t+1];n.isLeaf?(n.keys.push(r.keys.shift()),n.values.push(r.values.shift()),e.keys[t]=r.keys[0]):(n.keys.push(e.keys[t]),e.keys[t]=r.keys.shift(),n.children.push(r.children.shift()))}_merge(e,t){const n=e.children[t],r=e.children[t+1];n.isLeaf?(n.keys=n.keys.concat(r.keys),n.values=n.values.concat(r.values),n.next=r.next,e.keys.splice(t,1)):(n.keys.push(e.keys[t]),n.keys=n.keys.concat(r.keys),n.children=n.children.concat(r.children),e.keys.splice(t,1)),e.children.splice(t+1,1)}toArray(){const e=[];let t=this._getFirstLeaf(this.root);for(;t;){for(let n=0;n<t.keys.length;n++){const r=t.values[n];for(let s=0;s<r.length;s++)e.push({key:t.keys[n],value:r[s]})}t=t.next}return e}_getFirstLeaf(e){return e.isLeaf?e:this._getFirstLeaf(e.children[0])}size(){let e=0,t=this._getFirstLeaf(this.root);for(;t;){for(let n=0;n<t.values.length;n++)e+=t.values[n].length;t=t.next}return e}isEmpty(){return 0===this.root.keys.length}clear(){this.indexStore.getDataMap("nodes").clear(),this.root=new ne(!0,this.indexStore),this.indexStore.setMeta("rootId",this.root.id)}rangeSearch(e,t){const n=[];let r=this._getFirstLeaf(this.root);for(;r&&r.keys[r.keys.length-1]<e;)r=r.next;for(;r;){for(let s=0;s<r.keys.length;s++)if(r.keys[s]>=e&&r.keys[s]<=t){const e=r.values[s];for(let t=0;t<e.length;t++)n.push({key:r.keys[s],value:e[t]})}else if(r.keys[s]>t)return n;r=r.next}return n}getHeight(){let e=0,t=this.root;for(;!t.isLeaf;)e++,t=t.children[0];return e}}class se extends ee{constructor(e,t,n,r={}){super(e,t,n,r),this.data=new re(50,n)}extractIndexKey(e){const t=Object.keys(this.keys);if(0===t.length)return null;if(1===t.length){const n=o(e,t[0]);return void 0===n?null:n}const n=[];for(let r=0;r<t.length;r++){const s=o(e,t[r]);if(void 0===s)return null;n.push(s)}return n.join("\0")}add(e){const t=this.extractIndexKey(e);null!==t&&this.data.add(t,e._id.toString())}remove(e){const t=this.extractIndexKey(e);null!==t&&this.data.delete(t,e._id.toString())}query(e){const t=Object.keys(e),n=Object.keys(this.keys);if(1!==n.length)return null;const r=n[0];if(-1===t.indexOf(r))return null;const s=e[r];if("object"!=typeof s||null===s){const e=s;return this.data.search(e)}return"object"!=typeof s||Array.isArray(s)?null:this._queryWithOperators(r,s)}_queryWithOperators(e,t){const n=Object.keys(t),r=/* @__PURE__ */new Set;if(n.some(e=>["$gt","$gte","$lt","$lte"].includes(e))){const e=n.includes("$gt")||n.includes("$gte"),i=n.includes("$lt")||n.includes("$lte");if(e&&i){const e=n.includes("$gte")?t.$gte:n.includes("$gt")?t.$gt:-1/0,i=n.includes("$lte")?t.$lte:n.includes("$lt")?t.$lt:1/0,o=this.data.rangeSearch(e,i);for(const{key:a,value:l}of o)try{const e=a;let s=!0;!n.includes("$gt")||e>t.$gt||(s=!1),!n.includes("$gte")||e>=t.$gte||(s=!1),!n.includes("$lt")||e<t.$lt||(s=!1),!n.includes("$lte")||e<=t.$lte||(s=!1),s&&l&&r.add(l)}catch(s){}return Array.from(r)}{const e=this.data.toArray();for(const{key:i,value:o}of e)try{const e=i;let s=!0;for(const r of n){const n=t[r];("$gt"!==r||e>n)&&("$gte"!==r||e>=n)&&("$lt"!==r||e<n)&&("$lte"!==r||e<=n)?("$eq"===r&&e!==n||"$ne"===r&&e===n)&&(s=!1):s=!1}s&&o&&r.add(o)}catch(s){}return Array.from(r)}}if(n.includes("$in")){const e=t.$in;if(Array.isArray(e)){for(const t of e){const e=t,n=this.data.search(e);n&&n.forEach(e=>r.add(e))}return Array.from(r)}}if(n.includes("$eq")){const e=t.$eq;return this.data.search(e)||[]}if(n.includes("$ne")){const e=t.$ne,n=this.data.toArray();for(const{key:t,value:s}of n)t!==e&&s&&r.add(s);return Array.from(r)}return null}clear(){this.data.clear()}}class ie extends ee{constructor(e,t,n,r={}){super(e,t,n,r),this.textIndex=new q(n),this.indexedFields=[];for(const s in t)"text"===t[s]&&this.indexedFields.push(s);if(0===this.indexedFields.length)throw new Error('Text index must have at least one field with type "text"')}_extractText(e){const t=[];for(const n of this.indexedFields){const r=o(e,n);null!=r&&t.push(String(r))}return t.join(" ")}add(e){if(!e._id)throw new Error("Document must have an _id field");const t=this._extractText(e);t&&this.textIndex.add(String(e._id),t)}remove(e){e._id&&this.textIndex.remove(String(e._id))}query(e){return null}search(e,t={}){return this.textIndex.query(e,{scored:!1,...t})}clear(){this.textIndex.clear()}getSpec(){return{name:this.name,key:this.keys,textIndexVersion:3,weights:this._getWeights()}}_getWeights(){const e={};for(const t of this.indexedFields)e[t]=1;return e}}function oe(e,t,n,r){const s=(n-e)*Math.PI/180,i=(r-t)*Math.PI/180,o=Math.sin(s/2)*Math.sin(s/2)+Math.cos(e*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 6371*(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)))}function ae(e,t){return!(e.maxLat<t.minLat||e.minLat>t.maxLat||e.maxLng<t.minLng||e.minLng>t.maxLng)}function le(e){return(e.maxLat-e.minLat)*(e.maxLng-e.minLng)}function ce(e,t){return{minLat:Math.min(e.minLat,t.minLat),maxLat:Math.max(e.maxLat,t.maxLat),minLng:Math.min(e.minLng,t.minLng),maxLng:Math.max(e.maxLng,t.maxLng)}}function he(e,t){return le(ce(e,t))-le(e)}class ue{constructor(e=!1,t){if(!(t instanceof z))throw new Error("IndexStore is required to create RTreeNode");if(this.indexStore=t,"object"==typeof e)if(this._data=e,this.id=this._data.id,this.isLeaf=this._data.isLeaf,this.children=[],this.bbox=Object.assign({},this._data.bbox),this.isLeaf)this.children=[...this._data.children];else for(const n of this._data.children){const e=t.getDataMap("nodes").get(n);if(!e)throw new Error(`RTreeNode: Child node with id ${n} not found in IndexStore`);const r=new ue(e,t);this.children.push(r)}else this._data={id:t.getMeta("nextId"),isLeaf:e,children:[],bbox:null},t.setMeta("nextId",this._data.id+1),t.getDataMap("nodes").set(this._data.id,this._data),this.id=this._data.id,this.isLeaf=e,this.children=[],this.bbox=null;return new Proxy(this,{set:(e,n,r)=>"children"===n?(e.children=r,e.isLeaf?e._data.children=[...e.children]:e._data.children=e.children.map(e=>e.id),t.getDataMap("nodes").set(e.id,e._data),!0):(e[n]=r,!0),get:(e,n)=>"children"===n?new Proxy(e.children,{set:(n,r,s)=>(n[r]=s,e.isLeaf?e._data.children=[...e.children]:e._data.children=e.children.map(e=>e.id),t.getDataMap("nodes").set(e.id,e._data),!0)}):e[n]})}updateBBox(){if(0===this.children.length)return void(this.bbox=null);let e=1/0,t=-1/0,n=1/0,r=-1/0;for(const s of this.children){const i=s.bbox;e=Math.min(e,i.minLat),t=Math.max(t,i.maxLat),n=Math.min(n,i.minLng),r=Math.max(r,i.maxLng)}this.bbox={minLat:e,maxLat:t,minLng:n,maxLng:r},this._data.bbox=Object.assign({},this.bbox),this.indexStore.getDataMap("nodes").set(this.id,this._data)}}class de{constructor(e=9,t=new z){if(this.maxEntries=e,this.minEntries=Math.max(2,Math.ceil(e/2)),this.indexStore=t,t.hasMeta("maxEntries")){if(t.getMeta("maxEntries")!==e)throw new Error(`R-tree maxEntries does not match stored index metadata ${t.getMeta("maxEntries")} != ${e}`);if(t.getMeta("minEntries")!==this.minEntries)throw new Error(`R-tree minEntries does not match stored index metadata ${t.getMeta("minEntries")} != ${this.minEntries}`);this._size=this.indexStore.getMeta("size"),this.root=new ue(this.indexStore.getDataMap("nodes").get(this.indexStore.getMeta("rootId")),this.indexStore)}else this.indexStore.setMeta("maxEntries",this.maxEntries),this.indexStore.setMeta("minEntries",this.minEntries),this.indexStore.setMeta("nextId",1),this.root=new ue(!0,this.indexStore),this.indexStore.setMeta("rootId",this.root.id),this.indexStore.setMeta("size",0),this._size=0}insert(e,t,n){const r={bbox:{minLat:e,maxLat:e,minLng:t,maxLng:t},lat:e,lng:t,data:n};this._insert(r,this.root,1),this._size++,this.indexStore.setMeta("size",this._size)}_insert(e,t,n){if(t.isLeaf){if(t.children.push(e),t.updateBBox(),t.children.length>this.maxEntries)return this._split(t)}else{const r=this._chooseSubtree(e.bbox,t),s=this._insert(e,r,n+1);if(s){if(t.children.push(s),t.updateBBox(),t.children.length>this.maxEntries)return this._split(t)}else t.updateBBox()}return null}_chooseSubtree(e,t){let n=1/0,r=1/0,s=null;for(const i of t.children){const t=he(i.bbox,e),o=le(i.bbox);(t<n||t===n&&o<r)&&(n=t,r=o,s=i)}return s}_split(e){const t=e.children,n=e.isLeaf;let r=-1/0,s=0,i=1;for(let l=0;l<t.length;l++)for(let e=l+1;e<t.length;e++){const n=t[l].bbox,o=t[e].bbox,a=le(ce(n,o))-le(n)-le(o);a>r&&(r=a,s=l,i=e)}const o=new ue(n,this.indexStore),a=new ue(n,this.indexStore);o.children.push(t[s]),a.children.push(t[i]);for(let l=0;l<t.length;l++){if(l===s||l===i)continue;const e=t[l],n=e.bbox,r=0===o.children.length?1/0:he(o.bbox||n,n),c=0===a.children.length?1/0:he(a.bbox||n,n);if(o.children.length<this.minEntries&&t.length-l+o.children.length<=this.minEntries)o.children.push(e);else if(a.children.length<this.minEntries&&t.length-l+a.children.length<=this.minEntries)a.children.push(e);else if(r<c)o.children.push(e);else if(c<r)a.children.push(e);else{(o.bbox?le(o.bbox):0)<(a.bbox?le(a.bbox):0)?o.children.push(e):a.children.push(e)}o.updateBBox(),a.updateBBox()}if(e.children=o.children,e.updateBBox(),e===this.root){const e=new ue(!1,this.indexStore);return e.children=[o,a],e.updateBBox(),this.root=e,this.indexStore.setMeta("rootId",this.root.id),null}return a}searchBBox(e){const t=[];return this._searchBBox(e,this.root,t),t}_searchBBox(e,t,n){if(t.bbox&&ae(e,t.bbox))if(t.isLeaf)for(const r of t.children)ae(e,r.bbox)&&n.push(r);else for(const r of t.children)this._searchBBox(e,r,n)}searchRadius(e,t,n){const r=function(e,t,n){const r=n/111,s=n/(111*Math.cos(e*Math.PI/180));return{minLat:e-r,maxLat:e+r,minLng:t-s,maxLng:t+s}}(e,t,n),s=this.searchBBox(r),i=[];for(const o of s){oe(e,t,o.lat,o.lng)<=n&&i.push(o)}return i}remove(e,t,n=null){const r={minLat:e,maxLat:e,minLng:t,maxLng:t},s=this._remove(r,n,this.root,null,-1);return s&&(this._size--,this.indexStore.setMeta("size",this._size)),1!==this.root.children.length||this.root.isLeaf||(this.root=this.root.children[0],this.indexStore.setMeta("rootId",this.root.id)),s}_remove(e,t,n,r,s){if(!n.bbox||!ae(e,n.bbox))return!1;if(n.isLeaf)for(let i=0;i<n.children.length;i++){const o=n.children[i];if(o.lat===e.minLat&&o.lng===e.minLng){if(null===t||JSON.stringify(o.data)===JSON.stringify(t)){if(n.children.splice(i,1),n.updateBBox(),n.children.length<this.minEntries&&n!==this.root){const e=n.children.slice();n.children=[],n.updateBBox(),r&&(r.children.splice(s,1),r.updateBBox());for(const t of e)this._insert(t,this.root,1)}return!0}}}else for(let i=0;i<n.children.length;i++){const r=n.children[i];if(this._remove(e,t,r,n,i))return n.updateBBox(),!0}return!1}getAll(){const e=[];return this._getAll(this.root,e),e}_getAll(e,t){if(e.isLeaf)t.push(...e.children);else for(const n of e.children)this._getAll(n,t)}size(){return this._size}clear(){this.root=new ue(!0,this.indexStore),this.indexStore.setMeta("rootId",this.root.id),this._size=0,this.indexStore.setMeta("size",0)}}class fe extends ee{constructor(e,t,n,r={}){super(e,t,n,r),this.rtree=new de(9,n),this.geoField=null;for(const s in t)if("2dsphere"===t[s]||"2d"===t[s]){this.geoField=s;break}if(!this.geoField)throw new Error('Geospatial index must have at least one field with type "2dsphere" or "2d"')}_extractCoordinates(e){if(!e)return null;if("FeatureCollection"===e.type&&e.features&&e.features.length>0){const t=e.features[0];if(t.geometry)return this._extractCoordinates(t.geometry)}if("Feature"===e.type&&e.geometry)return this._extractCoordinates(e.geometry);if("Point"===e.type&&e.coordinates){const[t,n]=e.coordinates;if("number"==typeof t&&"number"==typeof n)return{lat:n,lng:t}}if("Polygon"===e.type&&e.coordinates&&e.coordinates.length>0){const t=e.coordinates[0];if(t.length>0){let e=0,n=0;for(const r of t)n+=r[0],e+=r[1];return{lat:e/t.length,lng:n/t.length}}}return null}add(e){if(!e._id)throw new Error("Document must have an _id field");const t=o(e,this.geoField),n=this._extractCoordinates(t);n&&this.rtree.insert(n.lat,n.lng,{_id:e._id,geoJson:t})}remove(e){if(!e._id)return;const t=o(e,this.geoField),n=this._extractCoordinates(t);n&&this.rtree.remove(n.lat,n.lng,{_id:e._id,geoJson:t})}query(e){if(!e[this.geoField])return null;const t=e[this.geoField];if(t.$geoWithin){const e=t.$geoWithin;if(Array.isArray(e)&&2===e.length){const t=e[0][0],n=e[0][1],r=e[1][0],s=e[1][1];return this.rtree.searchBBox({minLat:s,maxLat:n,minLng:t,maxLng:r}).map(e=>e.data._id)}}if(t.$near){const e=t.$near;let n;if(e.$geometry)n=e.$geometry.coordinates;else if(e.coordinates)n=e.coordinates;else{if(!Array.isArray(e))return null;n=e}if(!n||n.length<2)return null;const[r,s]=n,i=(e.$maxDistance||1e6)/1e3,o=this.rtree.searchRadius(s,r,i).map(e=>{const t=this._haversineDistance(s,r,e.lat,e.lng);return{_id:e.data._id,distance:t}});return o.sort((e,t)=>e.distance-t.distance),o.map(e=>e._id)}if(t.$nearSphere){const e=t.$nearSphere;let n;if(e.$geometry)n=e.$geometry.coordinates;else if(e.coordinates)n=e.coordinates;else{if(!Array.isArray(e))return null;n=e}if(!n||n.length<2)return null;const[r,s]=n,i=(e.$maxDistance||1e6)/1e3,o=this.rtree.searchRadius(s,r,i).map(e=>{const t=this._haversineDistance(s,r,e.lat,e.lng);return{_id:e.data._id,distance:t}});return o.sort((e,t)=>e.distance-t.distance),o.map(e=>e._id)}if(t.$geoIntersects){const e=t.$geoIntersects;let n;if(!e.$geometry)return null;if(n=e.$geometry,!n||!n.type)return null;if("Point"===n.type){const[e,t]=n.coordinates,r=1e-4;return this.rtree.searchBBox({minLat:t-r,maxLat:t+r,minLng:e-r,maxLng:e+r}).map(e=>e.data._id)}if("Polygon"===n.type){const e=n.coordinates;if(!e||0===e.length)return null;const t=e[0];if(!t||t.length<3)return null;let r=1/0,s=-1/0,i=1/0,o=-1/0;for(const n of t){const[e,t]=n;r=Math.min(r,t),s=Math.max(s,t),i=Math.min(i,e),o=Math.max(o,e)}return this.rtree.searchBBox({minLat:r,maxLat:s,minLng:i,maxLng:o}).filter(e=>this._pointInPolygon(e.lat,e.lng,t)).map(e=>e.data._id)}return null}return null}_haversineDistance(e,t,n,r){const s=(n-e)*Math.PI/180,i=(r-t)*Math.PI/180,o=Math.sin(s/2)*Math.sin(s/2)+Math.cos(e*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 6371*(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)))}_pointInPolygon(e,t,n){let r=!1;for(let s=0,i=n.length-1;s<n.length;i=s++){const[o,a]=n[s],[l,c]=n[i];a>e!=c>e&&t<(l-o)*(e-a)/(c-a)+o&&(r=!r)}return r}clear(){this.rtree.clear()}getSpec(){return{name:this.name,key:this.keys,"2dsphereIndexVersion":3}}}class pe{constructor(){this.type="full_scan",this.indexes=[],this.indexScans=[],this.estimatedCost=1/0,this.indexOnly=!1}}class me{constructor(e){this.indexes=e}plan(e){const t=new pe;if(!e||0===Object.keys(e).length)return t;const n=this._analyzeQuery(e);if(n.hasTextSearch){const t=this._planTextSearch(e,n);if(t)return t}if(n.hasGeoQuery){const t=this._planGeoQuery(e,n);if(t)return t}if("and"===n.type){const t=this._planAndQuery(e,n);if("full_scan"!==t.type)return t}if("or"===n.type){const t=this._planOrQuery(e,n);if("full_scan"!==t.type)return t}const r=this._planSimpleQuery(e);return"full_scan"!==r.type?r:t}_analyzeQuery(e){const t={type:"simple",fields:[],operators:{},hasTextSearch:!1,hasGeoQuery:!1,conditions:[]},n=Object.keys(e);if(1===n.length){const r=n[0];if("$and"===r){t.type="and",t.conditions=e.$and;for(const e of t.conditions){const n=this._analyzeQuery(e);t.fields.push(...n.fields),n.hasTextSearch&&(t.hasTextSearch=!0),n.hasGeoQuery&&(t.hasGeoQuery=!0)}return t}if("$or"===r){t.type="or",t.conditions=e.$or;for(const e of t.conditions){const n=this._analyzeQuery(e);t.fields.push(...n.fields),n.hasTextSearch&&(t.hasTextSearch=!0),n.hasGeoQuery&&(t.hasGeoQuery=!0)}return t}}for(const r of n){if(r.startsWith("$"))continue;t.fields.push(r);const n=e[r];if("object"==typeof n&&null!==n&&!Array.isArray(n)){const e=Object.keys(n);t.operators[r]=e,e.includes("$text")&&(t.hasTextSearch=!0),e.some(e=>["$geoWithin","$geoIntersects","$near","$nearSphere"].includes(e))&&(t.hasGeoQuery=!0)}}return n.length>1&&(t.type="and"),t}_planTextSearch(e,t){for(const[n,r]of this.indexes)if(r instanceof ie){const t=this._extractTextQuery(e);if(t){const e=new pe;e.type="index_scan",e.indexes=[n];const s=r.search(t);return e.indexScans=[{indexName:n,docIds:s}],e.estimatedCost=s.length,e.indexOnly=!0,e}}return null}_extractTextQuery(e){for(const t in e){const n=e[t];if("object"==typeof n&&null!==n&&n.$text)return"string"==typeof n.$text?n.$text:n.$text.$search}return null}_planGeoQuery(e,t){for(const[n,r]of this.indexes)if(r instanceof fe){const t=r.query(e);if(null!==t){const e=new pe;return e.type="index_scan",e.indexes=[n],e.indexScans=[{indexName:n,docIds:t}],e.estimatedCost=t.length,e.indexOnly=!0,e}}return null}_planAndQuery(e,t){const n=new pe;let r;r=e.$and?e.$and:Object.keys(e).map(t=>({[t]:e[t]}));const s=[];for(const i of r){const e=this._planSimpleQuery(i);"index_scan"===e.type&&s.push(e.indexScans[0])}return s.length>1?(n.type="index_intersection",n.indexScans=s,n.indexes=s.map(e=>e.indexName),n.estimatedCost=Math.min(...s.map(e=>e.docIds.length)),n):1===s.length?(n.type="index_scan",n.indexScans=[s[0]],n.indexes=[s[0].indexName],n.estimatedCost=s[0].docIds.length,n):n}_planOrQuery(e,t){const n=new pe;if(!e.$or)return n;const r=e.$or,s=[];for(const i of r){const e=this._planSimpleQuery(i);"index_scan"===e.type&&s.push(e.indexScans[0])}return s.length>0?(n.type="index_union",n.indexScans=s,n.indexes=s.map(e=>e.indexName),n.estimatedCost=s.reduce((e,t)=>e+t.docIds.length,0),n):n}_planSimpleQuery(e){const t=new pe;if(0===Object.keys(e).length)return t;for(const[n,r]of this.indexes){if(r instanceof ie||r instanceof fe)continue;const s=r.query(e);if(null!==s&&s.length>=0)return t.type="index_scan",t.indexes=[n],t.indexScans=[{indexName:n,docIds:s}],t.estimatedCost=s.length,t}return t}execute(e){if("full_scan"===e.type)return null;if("index_scan"===e.type)return e.indexScans[0].docIds;if("index_intersection"===e.type){if(0===e.indexScans.length)return null;const t=e.indexScans.slice().sort((e,t)=>e.docIds.length-t.docIds.length);let n=new Set(t[0].docIds);for(let e=1;e<t.length;e++){const r=new Set(t[e].docIds);if(n=new Set([...n].filter(e=>r.has(e))),0===n.size)break}return Array.from(n)}if("index_union"===e.type){const t=/* @__PURE__ */new Set;for(const n of e.indexScans)n.docIds.forEach(e=>t.add(e));return Array.from(t)}return null}}function ge(e,t){if(null==e)return e;if("boolean"==typeof e||"number"==typeof e)return e;if("string"==typeof e)return e.startsWith("$$")?o(t,e.substring(2)):"$"===e.charAt(0)?o(t,e.substring(1)):e;if("object"==typeof e){if(Array.isArray(e))return e.map(e=>ge(e,t));const n=Object.keys(e);if(0===n.length)return e;const r=n[0];return function(e,t,n){switch(e){case"$add":return function(e,t){if(!Array.isArray(e))return null;let n=0;for(const r of e){const e=ge(r,t);e instanceof Date?n+=e.getTime():"number"==typeof e&&(n+=e)}return n}(t,n);case"$subtract":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=ge(e[0],t),r=ge(e[1],t);if(n instanceof Date&&r instanceof Date)return n.getTime()-r.getTime();if(n instanceof Date&&"number"==typeof r)return new Date(n.getTime()-r);if("number"==typeof n&&"number"==typeof r)return n-r;return null}(t,n);case"$multiply":return function(e,t){if(!Array.isArray(e))return null;let n=1;for(const r of e){const e=ge(r,t);"number"==typeof e&&(n*=e)}return n}(t,n);case"$divide":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=ge(e[0],t),r=ge(e[1],t);if("number"==typeof n&&"number"==typeof r&&0!==r)return n/r;return null}(t,n);case"$mod":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=ge(e[0],t),r=ge(e[1],t);if("number"==typeof n&&"number"==typeof r&&0!==r)return n%r;return null}(t,n);case"$pow":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=ge(e[0],t),r=ge(e[1],t);if("number"==typeof n&&"number"==typeof r)return Math.pow(n,r);return null}(t,n);case"$sqrt":return function(e,t){const n=ge(e,t);if("number"==typeof n&&n>=0)return Math.sqrt(n);return null}(t,n);case"$abs":return function(e,t){const n=ge(e,t);if("number"==typeof n)return Math.abs(n);return null}(t,n);case"$ceil":return function(e,t){const n=ge(e,t);if("number"==typeof n)return Math.ceil(n);return null}(t,n);case"$floor":return function(e,t){const n=ge(e,t);if("number"==typeof n)return Math.floor(n);return null}(t,n);case"$trunc":return function(e,t){const n=ge(e,t);if("number"==typeof n)return Math.trunc(n);return null}(t,n);case"$round":return function(e,t){const n=ge(Array.isArray(e)?e[0]:e,t),r=Array.isArray(e)&&void 0!==e[1]?ge(e[1],t):0;if("number"==typeof n&&"number"==typeof r){const e=Math.pow(10,r);return Math.round(n*e)/e}return null}(t,n);case"$concat":return function(e,t){if(!Array.isArray(e))return null;let n="";for(const r of e){const e=ge(r,t);null!=e&&(n+=String(e))}return n}(t,n);case"$substr":return function(e,t){if(!Array.isArray(e)||e.length<3)return null;const n=String(ge(e[0],t)||""),r=ge(e[1],t),s=ge(e[2],t);if("number"==typeof r&&"number"==typeof s)return n.substr(r,s);return null}(t,n);case"$toLower":return function(e,t){const n=ge(e,t);return null!=n?String(n).toLowerCase():""}(t,n);case"$toUpper":return function(e,t){const n=ge(e,t);return null!=n?String(n).toUpperCase():""}(t,n);case"$trim":return function(e,t){const n=ge("object"==typeof e&&e.input?e.input:e,t),r=e.chars?ge(e.chars,t):null;let s=null!=n?String(n):"";if(r){const e=new RegExp(`^[${ye(r)}]+|[${ye(r)}]+$`,"g");return s.replace(e,"")}return s.trim()}(t,n);case"$ltrim":return function(e,t){const n=ge("object"==typeof e&&e.input?e.input:e,t),r=e.chars?ge(e.chars,t):null;let s=null!=n?String(n):"";if(r){const e=new RegExp(`^[${ye(r)}]+`,"g");return s.replace(e,"")}return s.replace(/^\s+/,"")}(t,n);case"$rtrim":return function(e,t){const n=ge("object"==typeof e&&e.input?e.input:e,t),r=e.chars?ge(e.chars,t):null;let s=null!=n?String(n):"";if(r){const e=new RegExp(`[${ye(r)}]+$`,"g");return s.replace(e,"")}return s.replace(/\s+$/,"")}(t,n);case"$split":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=String(ge(e[0],t)||""),r=String(ge(e[1],t)||"");return n.split(r)}(t,n);case"$strLenCP":return function(e,t){const n=ge(e,t);return null!=n?String(n).length:0}(t,n);case"$strcasecmp":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=String(ge(e[0],t)||"").toLowerCase(),r=String(ge(e[1],t)||"").toLowerCase();return n<r?-1:n>r?1:0}(t,n);case"$indexOfCP":return function(e,t){if(!Array.isArray(e)||e.length<2)return null;const n=String(ge(e[0],t)||""),r=String(ge(e[1],t)||""),s=void 0!==e[2]?ge(e[2],t):0,i=void 0!==e[3]?ge(e[3],t):n.length,o=n.substring(s,i).indexOf(r);return-1===o?-1:o+s}(t,n);case"$replaceOne":return function(e,t){const n=String(ge(e.input,t)||""),r=String(ge(e.find,t)||""),s=String(ge(e.replacement,t)||"");return n.replace(r,s)}(t,n);case"$replaceAll":return function(e,t){const n=String(ge(e.input,t)||""),r=String(ge(e.find,t)||""),s=String(ge(e.replacement,t)||"");return n.split(r).join(s)}(t,n);case"$cmp":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=ge(e[0],t),r=ge(e[1],t);return n<r?-1:n>r?1:0}(t,n);case"$eq":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=ge(e[0],t),r=ge(e[1],t);return n===r}(t,n);case"$ne":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=ge(e[0],t),r=ge(e[1],t);return n!==r}(t,n);case"$gt":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=ge(e[0],t),r=ge(e[1],t);return n>r}(t,n);case"$gte":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=ge(e[0],t),r=ge(e[1],t);return n>=r}(t,n);case"$lt":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=ge(e[0],t),r=ge(e[1],t);return n<r}(t,n);case"$lte":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=ge(e[0],t),r=ge(e[1],t);return n<=r}(t,n);case"$and":return function(e,t){if(!Array.isArray(e))return null;for(const n of e){if(!ge(n,t))return!1}return!0}(t,n);case"$or":return function(e,t){if(!Array.isArray(e))return null;for(const n of e){if(ge(n,t))return!0}return!1}(t,n);case"$not":return function(e,t){const n=ge(Array.isArray(e)?e[0]:e,t);return!n}(t,n);case"$cond":return function(e,t){let n,r,s;if(Array.isArray(e)){if(3!==e.length)return null;[n,r,s]=e}else{if("object"!=typeof e)return null;n=e.if,r=e.then,s=e.else}const i=ge(n,t);return ge(i?r:s,t)}(t,n);case"$ifNull":return function(e,t){if(!Array.isArray(e)||e.length<2)return null;for(let n=0;n<e.length;n++){const r=ge(e[n],t);if(null!=r)return r}return null}(t,n);case"$switch":return function(e,t){if("object"!=typeof e||!Array.isArray(e.branches))return null;for(const n of e.branches){if(ge(n.case,t))return ge(n.then,t)}return void 0!==e.default?ge(e.default,t):null}(t,n);case"$year":return function(e,t){const n=ge(e,t);if(n instanceof Date)return n.getUTCFullYear();return null}(t,n);case"$month":return function(e,t){const n=ge(e,t);if(n instanceof Date)return n.getUTCMonth()+1;return null}(t,n);case"$dayOfMonth":return function(e,t){const n=ge(e,t);if(n instanceof Date)return n.getUTCDate();return null}(t,n);case"$dayOfWeek":return function(e,t){const n=ge(e,t);if(n instanceof Date)return n.getUTCDay()+1;return null}(t,n);case"$dayOfYear":return function(e,t){const n=ge(e,t);if(n instanceof Date){const e=new Date(Date.UTC(n.getUTCFullYear(),0,0)),t=n-e,r=864e5;return Math.floor(t/r)}return null}(t,n);case"$hour":return function(e,t){const n=ge(e,t);if(n instanceof Date)return n.getUTCHours();return null}(t,n);case"$minute":return function(e,t){const n=ge(e,t);if(n instanceof Date)return n.getUTCMinutes();return null}(t,n);case"$second":return function(e,t){const n=ge(e,t);if(n instanceof Date)return n.getUTCSeconds();return null}(t,n);case"$millisecond":return function(e,t){const n=ge(e,t);if(n instanceof Date)return n.getUTCMilliseconds();return null}(t,n);case"$week":return function(e,t){const n=ge(e,t);if(n instanceof Date){const e=new Date(Date.UTC(n.getUTCFullYear(),0,1));return Math.ceil(((n-e)/864e5+e.getUTCDay()+1)/7)-1}return null}(t,n);case"$isoWeek":return function(e,t){const n=ge(e,t);if(n instanceof Date){const e=new Date(n.valueOf()),t=(n.getUTCDay()+6)%7;e.setUTCDate(e.getUTCDate()-t+3);const r=e.valueOf();return e.setUTCMonth(0,1),4!==e.getUTCDay()&&e.setUTCMonth(0,1+(4-e.getUTCDay()+7)%7),1+Math.ceil((r-e)/6048e5)}return null}(t,n);case"$isoWeekYear":return function(e,t){const n=ge(e,t);if(n instanceof Date){const e=new Date(n.valueOf());return e.setUTCDate(e.getUTCDate()-(n.getUTCDay()+6)%7+3),e.getUTCFullYear()}return null}(t,n);case"$dateToString":return function(e,t){const n=e.format?ge(e.format,t):"%Y-%m-%dT%H:%M:%S.%LZ",r=ge(e.date,t);return r instanceof Date?n.replace("%Y",r.getUTCFullYear()).replace("%m",String(r.getUTCMonth()+1).padStart(2,"0")).replace("%d",String(r.getUTCDate()).padStart(2,"0")).replace("%H",String(r.getUTCHours()).padStart(2,"0")).replace("%M",String(r.getUTCMinutes()).padStart(2,"0")).replace("%S",String(r.getUTCSeconds()).padStart(2,"0")).replace("%L",String(r.getUTCMilliseconds()).padStart(3,"0")):null}(t,n);case"$toDate":return function(e,t){const n=ge(e,t);if(n instanceof Date)return n;if("string"==typeof n||"number"==typeof n){const e=new Date(n);return isNaN(e.getTime())?null:e}return null}(t,n);case"$arrayElemAt":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=ge(e[0],t),r=ge(e[1],t);if(!Array.isArray(n)||"number"!=typeof r)return null;const s=r<0?n.length+r:r;return n[s]}(t,n);case"$concatArrays":return function(e,t){if(!Array.isArray(e))return null;const n=[];for(const r of e){const e=ge(r,t);Array.isArray(e)&&n.push(...e)}return n}(t,n);case"$filter":return function(e,t){const n=ge(e.input,t),r=e.as||"this",s=e.cond;return Array.isArray(n)?n.filter(e=>{const n={...t,[r]:e};return ge(s,n)}):null}(t,n);case"$in":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=ge(e[0],t),r=ge(e[1],t);return!!Array.isArray(r)&&r.includes(n)}(t,n);case"$indexOfArray":return function(e,t){if(!Array.isArray(e)||e.length<2)return null;const n=ge(e[0],t),r=ge(e[1],t),s=void 0!==e[2]?ge(e[2],t):0,i=void 0!==e[3]?ge(e[3],t):n.length;if(!Array.isArray(n))return null;for(let o=s;o<i&&o<n.length;o++)if(n[o]===r)return o;return-1}(t,n);case"$isArray":return function(e,t){const n=ge(e,t);return Array.isArray(n)}(t,n);case"$map":return function(e,t){const n=ge(e.input,t),r=e.as||"this",s=e.in;return Array.isArray(n)?n.map(e=>{const n={...t,[r]:e};return ge(s,n)}):null}(t,n);case"$reduce":return function(e,t){const n=ge(e.input,t),r=ge(e.initialValue,t),s=e.in;if(!Array.isArray(n))return null;let i=r;for(const o of n){i=ge(s,{...t,value:i,this:o})}return i}(t,n);case"$size":return function(e,t){const n=ge(e,t);return Array.isArray(n)?n.length:null}(t,n);case"$slice":return function(e,t){if(!Array.isArray(e)||e.length<2)return null;const n=ge(e[0],t);if(!Array.isArray(n))return null;if(2===e.length){const r=ge(e[1],t);return r>=0?n.slice(0,r):n.slice(r)}{const r=ge(e[1],t),s=ge(e[2],t);return n.slice(r,r+s)}}(t,n);case"$reverseArray":return function(e,t){const n=ge(e,t);return Array.isArray(n)?n.slice().reverse():null}(t,n);case"$zip":return function(e,t){const n=e.inputs?ge(e.inputs,t):null,r=e.useLongestLength||!1,s=e.defaults;if(!Array.isArray(n))return null;const i=n.map(e=>ge(e,t));if(!i.every(e=>Array.isArray(e)))return null;const o=Math.max(...i.map(e=>e.length)),a=r?o:Math.min(...i.map(e=>e.length)),l=[];for(let c=0;c<a;c++){const e=[];for(let t=0;t<i.length;t++)c<i[t].length?e.push(i[t][c]):s&&t<s.length?e.push(s[t]):e.push(null);l.push(e)}return l}(t,n);case"$type":return function(e,t){const n=ge(e,t);return null===n?"null":void 0===n?"missing":"boolean"==typeof n?"bool":"number"==typeof n?Number.isInteger(n)?"int":"double":"string"==typeof n?"string":n instanceof Date?"date":Array.isArray(n)?"array":"object"==typeof n?"object":"unknown"}(t,n);case"$convert":return function(e,t){const n=ge(e.input,t),r=e.to,s=e.onError,i=e.onNull;if(null===n)return void 0!==i?ge(i,t):null;try{switch(r){case"double":case"decimal":return parseFloat(n);case"int":case"long":return parseInt(n);case"bool":return Boolean(n);case"string":return String(n);case"date":return new Date(n);default:return n}}catch(o){return void 0!==s?ge(s,t):null}}(t,n);case"$toBool":return function(e,t){const n=ge(e,t);return Boolean(n)}(t,n);case"$toDecimal":return function(e,t){const n=ge(e,t);return parseFloat(n)}(t,n);case"$toDouble":return function(e,t){const n=ge(e,t);return parseFloat(n)}(t,n);case"$toInt":return function(e,t){const n=ge(e,t);return parseInt(n)}(t,n);case"$toLong":return function(e,t){const n=ge(e,t);return parseInt(n)}(t,n);case"$toString":return function(e,t){const n=ge(e,t);return null==n?null:String(n)}(t,n);case"$objectToArray":return function(e,t){const n=ge(e,t);if("object"!=typeof n||null===n||Array.isArray(n))return null;return Object.keys(n).map(e=>({k:e,v:n[e]}))}(t,n);case"$arrayToObject":return function(e,t){const n=ge(e,t);if(!Array.isArray(n))return null;const r={};for(const s of n)Array.isArray(s)&&2===s.length?r[s[0]]=s[1]:"object"==typeof s&&void 0!==s.k&&void 0!==s.v&&(r[s.k]=s.v);return r}(t,n);case"$mergeObjects":return function(e,t){if(!Array.isArray(e))return ge(e,t);const n={};for(const r of e){const e=ge(r,t);"object"!=typeof e||null===e||Array.isArray(e)||Object.assign(n,e)}return n}(t,n);case"$literal":return t;default:throw new Error(`Unsupported aggregation operator: ${e}`)}}(r,e[r],t)}return e}function ye(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}class xe extends n.EventEmitter{constructor(e,t=[],n={}){super(),this.target=e,this.pipeline=t,this.options=n,this.closed=!1,this._listeners=/* @__PURE__ */new Map,this._changeCounter=0,this._startWatching()}_startWatching(){if(this.closed)return;const e=this._getCollectionsToWatch();for(const t of e)this._watchCollection(t);"DB"===this.target.constructor.name&&this._interceptDBCollectionCreation(),"MongoClient"===this.target.constructor.name&&this._interceptClientDBCreation()}_getCollectionsToWatch(){const e=[];if("MongoClient"===this.target.constructor.name)return this._monitorClient(),e;if("DB"===this.target.constructor.name){const t=this.target.getCollectionNames();for(const n of t){const t=this.target[n];t&&t.isCollection&&e.push(t)}this._monitorDB()}return this.target.isCollection&&e.push(this.target),e}_watchCollection(e){if(this.closed)return;if(!e)return;if("function"!=typeof e.on)return;if(!e.isCollection)return;if(this._listeners.has(e))return;const t={insert:t=>this._emitChange("insert",e,t),update:(t,n)=>this._emitChange("update",e,t,n),replace:t=>this._emitChange("replace",e,t),delete:t=>this._emitChange("delete",e,t)};this._listeners.set(e,t),e.on("insert",t.insert),e.on("update",t.update),e.on("replace",t.replace),e.on("delete",t.delete)}_emitChange(e,t,n,r=null){if(this.closed)return;const s=this._createChangeEvent(e,t,n,r);this._matchesPipeline(s)&&this.emit("change",s)}_createChangeEvent(e,t,n,r){const s={_id:{_data:Buffer.from(String(++this._changeCounter)).toString("base64")},operationType:e,clusterTime:/* @__PURE__ */new Date,ns:{db:t.db.dbName,coll:t.name},documentKey:{_id:n._id}};switch(e){case"insert":case"replace":s.fullDocument=n;break;case"update":s.updateDescription=r||{updatedFields:{},removedFields:[],truncatedArrays:[]},"updateLookup"===this.options.fullDocument&&(s.fullDocument=n)}return s}_matchesPipeline(e){if(!this.pipeline||0===this.pipeline.length)return!0;for(const t of this.pipeline)if(t.$match&&!H(e,t.$match))return!1;return!0}_getNestedValue(e,t){return t.split(".").reduce((e,t)=>e?.[t],e)}_monitorClient(){}_interceptClientDBCreation(){const e=this.target,t=e.db.bind(e),n=this;this._watchedDBs=/* @__PURE__ */new Map,e.db=function(e,r){const s=t(e,r),i=s.dbName;if(!n._watchedDBs.has(i)){n._watchedDBs.set(i,s);const e=s.getCollectionNames();for(const t of e){const e=s[t];e&&e.isCollection&&!n._listeners.has(e)&&n._watchCollection(e)}n._interceptDBCollectionCreationForClient(s)}return s},this._originalClientMethods={db:t}}_interceptDBCollectionCreationForClient(e){const t=e.collection.bind(e),n=e.createCollection.bind(e),r=this;e.collection=function(e){const n=t(e);return n&&n.isCollection&&!r._listeners.has(n)&&r._watchCollection(n),n},e.createCollection=function(t){n(t);const s=e[t];s&&s.isCollection&&!r._listeners.has(s)&&r._watchCollection(s)}}_monitorDB(){}_interceptDBCollectionCreation(){const e=this.target,t=e.collection.bind(e),n=e.createCollection.bind(e),r=this;e.collection=function(e){const n=t(e);return n&&n.isCollection&&!r._listeners.has(n)&&r._watchCollection(n),n},e.createCollection=function(t){n(t);const s=e[t];s&&s.isCollection&&!r._listeners.has(s)&&r._watchCollection(s)},this._originalDBMethods={collection:t,createCollection:n}}close(){if(!this.closed){this.closed=!0;for(const[e,t]of this._listeners)e.off("insert",t.insert),e.off("update",t.update),e.off("replace",t.replace),e.off("delete",t.delete);this._listeners.clear(),this._originalDBMethods&&"DB"===this.target.constructor.name&&(this.target.collection=this._originalDBMethods.collection,this.target.createCollection=this._originalDBMethods.createCollection),this._originalClientMethods&&"MongoClient"===this.target.constructor.name&&(this.target.db=this._originalClientMethods.db),this.emit("close"),this.removeAllListeners()}}get isClosed(){return this.closed}async*[Symbol.asyncIterator](){const e=[];let t=null,n=!1;const r=n=>{t?(t({value:n,done:!1}),t=null):e.push(n)},s=()=>{n=!0,t&&(t({done:!0}),t=null)},i=e=>{t&&(t(Promise.reject(e)),t=null)};this.on("change",r),this.on("close",s),this.on("error",i);try{for(;!n;)if(e.length>0)yield e.shift();else{const e=await new Promise(e=>{t=e,n&&e({done:!0})});if(e.done)break;yield e.value}}finally{this.off("change",r),this.off("close",s),this.off("error",i)}}async next(){return new Promise((e,t)=>{const n=t=>{i(),e(t)},r=()=>{i(),e(null)},s=e=>{i(),t(e)},i=()=>{this.off("change",n),this.off("close",r),this.off("error",s)};this.closed?e(null):(this.once("change",n),this.once("close",r),this.once("error",s))})}}class we extends n.EventEmitter{constructor(e,t,n,r){super(),this.db=e,this.name=t,this.storage=n,this.idGenerator=r,this.indexes=/* @__PURE__ */new Map,this.queryPlanner=new me(this.indexes),this.isCollection=!0;for(const[s,i]of this.storage.indexes){let e;"text"===i.getMeta("type")?e=new ie(s,i.getMeta("keys"),i):"geospatial"===i.getMeta("type")?e=new fe(s,i.getMeta("keys"),i):"regular"===i.getMeta("type")&&(e=new se(s,i.getMeta("keys"),i)),e&&this.indexes.set(e.name,e)}}generateIndexName(e){const t=[];for(const n in e)e.hasOwnProperty(n)&&t.push(n+"_"+e[n]);return t.join("_")}isTextIndex(e){for(const t in e)if("text"===e[t])return!0;return!1}isGeospatialIndex(e){for(const t in e)if("2dsphere"===e[t]||"2d"===e[t])return!0;return!1}buildIndex(e,t,n={}){let r;if(this.isTextIndex(t)){const s={type:"text",keys:t};r=new ie(e,t,this.storage.createIndexStore(e,s),n)}else if(this.isGeospatialIndex(t)){const s={type:"geospatial",keys:t};r=new fe(e,t,this.storage.createIndexStore(e,s),n)}else{const s={type:"regular",keys:t};r=new se(e,t,this.storage.createIndexStore(e,s),n)}const s=this.storage.getAllDocuments();for(const i of s)i&&r.add(i);return this.indexes.set(e,r),r}updateIndexesOnInsert(e){for(const[t,n]of this.indexes)n.add(e)}updateIndexesOnDelete(e){for(const[t,n]of this.indexes)n.remove(e)}planQuery(e){const t=this.queryPlanner.plan(e),n=this.queryPlanner.execute(t);return{useIndex:"full_scan"!==t.type,planType:t.type,indexNames:t.indexes,docIds:n,estimatedCost:t.estimatedCost,indexOnly:t.indexOnly||!1}}getTextIndex(e){for(const[t,n]of this.indexes)if(n instanceof ie&&n.indexedFields.includes(e))return n;return null}aggregate(e){if(!e||!l(e))throw{$err:"Pipeline must be an array",code:17287};let t=[];const n=this.find({});for(;n.hasNext();)t.push(n.next());for(let r=0;r<e.length;r++){const n=e[r],s=Object.keys(n);if(1!==s.length)throw{$err:"Each pipeline stage must have exactly one key",code:17287};const a=s[0],c=n[a];if("$match"===a){const e=[];for(let n=0;n<t.length;n++)H(t[n],c)&&e.push(t[n]);t=e}else if("$project"===a){const e=[];for(let n=0;n<t.length;n++)e.push(be(c,t[n]));t=e}else if("$addFields"===a||"$set"===a){const e=[];for(let n=0;n<t.length;n++){const r=i(t[n]);for(const e in c){const s=c[e];r[e]=ge(s,t[n])}e.push(r)}t=e}else if("$unset"===a){const e=[];let n=[];"string"==typeof c?n=[c]:Array.isArray(c)?n=c:"object"==typeof c&&(n=Object.keys(c));for(let r=0;r<t.length;r++){const s=i(t[r]);for(let e=0;e<n.length;e++){const t=n[e],r=t.split(".");if(1===r.length)delete s[t];else{let e=s;for(let t=0;t<r.length-1&&(null!=e&&null!=e);t++)e=e[r[t]];null!=e&&null!=e&&delete e[r[r.length-1]]}}e.push(s)}t=e}else if("$sort"===a){const e=Object.keys(c);t.sort(function(t,n){for(let r=0;r<e.length;r++){const s=e[r];if(void 0===t[s]&&void 0!==n[s])return-1*c[s];if(void 0!==t[s]&&void 0===n[s])return 1*c[s];if(t[s]<n[s])return-1*c[s];if(t[s]>n[s])return 1*c[s]}return 0})}else if("$limit"===a)t=t.slice(0,c);else if("$skip"===a)t=t.slice(c);else if("$group"===a){const e={},n=c._id;for(let s=0;s<t.length;s++){const r=t[s];let i;i=null==n?null:ge(n,r);const o=JSON.stringify(i);e[o]||(e[o]={_id:i,docs:[],accumulators:{}}),e[o].docs.push(r)}const r=[];for(const t in e){const n=e[t],s={_id:n._id};for(const e in c){if("_id"===e)continue;const t=c[e],r=Object.keys(t);if(1!==r.length)continue;const i=r[0],o=t[i];if("$sum"===i){let t=0;for(let e=0;e<n.docs.length;e++){const r=ge(o,n.docs[e]);"number"==typeof r?t+=r:null!=r&&(t+=Number(r)||0)}s[e]=t}else if("$avg"===i){let t=0,r=0;for(let e=0;e<n.docs.length;e++){const s=ge(o,n.docs[e]);null!=s&&(t+=Number(s)||0,r++)}s[e]=r>0?t/r:0}else if("$min"===i){let t;for(let e=0;e<n.docs.length;e++){const r=ge(o,n.docs[e]);void 0!==r&&(void 0===t||r<t)&&(t=r)}s[e]=t}else if("$max"===i){let t;for(let e=0;e<n.docs.length;e++){const r=ge(o,n.docs[e]);void 0!==r&&(void 0===t||r>t)&&(t=r)}s[e]=t}else if("$push"===i){const t=[];for(let e=0;e<n.docs.length;e++){const r=ge(o,n.docs[e]);t.push(r)}s[e]=t}else if("$addToSet"===i){const t={};for(let e=0;e<n.docs.length;e++){const r=ge(o,n.docs[e]);t[JSON.stringify(r)]=r}const r=[];for(const e in t)r.push(t[e]);s[e]=r}else if("$first"===i)n.docs.length>0&&(s[e]=ge(o,n.docs[0]));else if("$last"===i)n.docs.length>0&&(s[e]=ge(o,n.docs[n.docs.length-1]));else if("$stdDevPop"===i){const t=[];for(let e=0;e<n.docs.length;e++){const r=ge(o,n.docs[e]);"number"==typeof r&&t.push(r)}if(t.length>0){const n=t.reduce((e,t)=>e+t,0)/t.length,r=t.reduce((e,t)=>e+Math.pow(t-n,2),0)/t.length;s[e]=Math.sqrt(r)}else s[e]=0}else if("$stdDevSamp"===i){const t=[];for(let e=0;e<n.docs.length;e++){const r=ge(o,n.docs[e]);"number"==typeof r&&t.push(r)}if(t.length>1){const n=t.reduce((e,t)=>e+t,0)/t.length,r=t.reduce((e,t)=>e+Math.pow(t-n,2),0)/(t.length-1);s[e]=Math.sqrt(r)}else s[e]=0}else if("$mergeObjects"===i){const t={};for(let e=0;e<n.docs.length;e++){const r=ge(o,n.docs[e]);"object"!=typeof r||null===r||Array.isArray(r)||Object.assign(t,r)}s[e]=t}}r.push(s)}t=r}else if("$count"===a)t=[{[c]:t.length}];else{if("$unwind"!==a)throw{$err:"Unsupported aggregation stage: "+a,code:17287};{const e=[];let n=c;"string"==typeof n&&"$"===n.charAt(0)&&(n=n.substring(1));for(let r=0;r<t.length;r++){const s=t[r],a=o(s,n);if(a&&l(a)&&a.length>0)for(let t=0;t<a.length;t++){const r=i(s),o=n.split(".");let l=r;for(let e=0;e<o.length-1;e++)l[o[e]]||(l[o[e]]={}),l=l[o[e]];l[o[o.length-1]]=a[t],e.push(r)}}t=e}}}return t}bulkWrite(){throw"Not Implemented"}async count(){return this.storage.size()}async copyTo(e){this.db[e]||this.db.createCollection(e);const t=this.db[e];let n=0;const r=this.find({});for(;r.hasNext();)await t.insertOne(r.next()),n++;return n}async createIndex(e,t){if(!e||"object"!=typeof e||Array.isArray(e))throw{$err:"createIndex requires a key specification object",code:2};const n=t&&t.name?t.name:this.generateIndexName(e);if(this.indexes.has(n)){const t=this.indexes.get(n);if(JSON.stringify(t.keys)!==JSON.stringify(e))throw{$err:"Index with name '"+n+"' already exists with a different key specification",code:85};return n}return this.buildIndex(n,e,t),n}dataSize(){throw"Not Implemented"}async deleteOne(e){const t=await this.findOne(e);return t?(this.updateIndexesOnDelete(t),this.storage.remove(t._id.toString()),this.emit("delete",{_id:t._id}),{deletedCount:1}):{deletedCount:0}}async deleteMany(e){const t=this.find(e),n=[],r=[];for(;t.hasNext();){const e=t.next();n.push(e._id),r.push(e)}const s=n.length;for(let i=0;i<n.length;i++)this.updateIndexesOnDelete(r[i]),this.storage.remove(n[i].toString()),this.emit("delete",{_id:n[i]});return{deletedCount:s}}async distinct(e,t){const n={},r=this.find(t);for(;r.hasNext();){const t=r.next();t[e]&&(n[t[e]]=!0)}return Object.keys(n)}drop(){for(const[e,t]of this.indexes)t.clear();this.storage.clear()}dropIndex(e){if(!this.indexes.has(e))throw{$err:"Index not found with name: "+e,code:27};return this.indexes.get(e).clear(),this.indexes.delete(e),{nIndexesWas:this.indexes.size+1,ok:1}}dropIndexes(){const e=this.indexes.size;for(const[t,n]of this.indexes)n.clear();return this.indexes.clear(),{nIndexesWas:e,msg:"non-_id indexes dropped",ok:1}}ensureIndex(){throw"Not Implemented"}explain(){throw"Not Implemented"}find(e,t){const n=null==e?{}:e,r=this.planQuery(n),s=[],i={};if(r.useIndex&&r.docIds)for(const o of r.docIds){const e=this.storage.get(o.toString());e&&H(e,n)&&(i[e._id]=!0,s.push(e))}if(!r.indexOnly){const e=this.storage.getAllDocuments();for(const t of e)!i[t._id]&&H(t,n)&&(i[t._id]=!0,s.push(t))}return new f(this,n,t,s,p)}findAndModify(){throw"Not Implemented"}async findOne(e,t){const n=this.find(e,t);return n.hasNext()?n.next():null}async findOneAndDelete(e,t){let n=this.find(e);if(t&&t.sort&&(n=n.sort(t.sort)),!n.hasNext())return null;const r=n.next();return this.storage.remove(r._id.toString()),t&&t.projection?d(t.projection,r):r}async findOneAndReplace(e,t,n){let r=this.find(e);if(n&&n.sort&&(r=r.sort(n.sort)),!r.hasNext())return null;const s=r.next();return t._id=s._id,this.storage.set(s._id.toString(),t),n&&n.returnNewDocument?n&&n.projection?d(n.projection,t):t:n&&n.projection?d(n.projection,s):s}async findOneAndUpdate(e,t,n){let r=this.find(e);if(n&&n.sort&&(r=r.sort(n.sort)),!r.hasNext())return null;const s=r.next(),i=Object.assign({},s);return Z(t,i),this.storage.set(s._id.toString(),i),n&&n.returnNewDocument?n&&n.projection?d(n.projection,i):i:n&&n.projection?d(n.projection,s):s}getIndexes(){const e=[];for(const[t,n]of this.indexes)e.push(n.getSpec());return e}getShardDistribution(){throw"Not Implemented"}getShardVersion(){throw"Not Implemented"}getStore(){return this.storage.getStore()}group(){throw"Not Implemented"}async insert(e){return Array==e.constructor?await this.insertMany(e):await this.insertOne(e)}async insertOne(e){return null==e._id&&(e._id=this.idGenerator()),this.storage.set(e._id.toString(),e),this.updateIndexesOnInsert(e),this.emit("insert",e),{insertedId:e._id}}async insertMany(e){const t=[];for(let n=0;n<e.length;n++){const r=await this.insertOne(e[n]);t.push(r.insertedId)}return{insertedIds:t}}isCapped(){throw"Not Implemented"}mapReduce(){throw"Not Implemented"}reIndex(){throw"Not Implemented"}async replaceOne(e,t,n){const r={},s=this.find(e);if(r.matchedCount=s.count(),0==r.matchedCount){if(r.modifiedCount=0,n&&n.upsert){const e=t;e._id=this.idGenerator(),this.storage.set(e._id.toString(),e),this.updateIndexesOnInsert(e),this.emit("insert",e),r.upsertedId=e._id}}else{r.modifiedCount=1;const e=s.next();this.updateIndexesOnDelete(e),t._id=e._id,this.storage.set(e._id.toString(),t),this.updateIndexesOnInsert(t),this.emit("replace",t)}return r}remove(e,t){const n=this.find(e);if(n.hasNext())if(!0===t||t&&t.justOne){const e=n.next();this.updateIndexesOnDelete(e),this.storage.remove(e._id.toString())}else for(;n.hasNext();){const e=n.next();this.updateIndexesOnDelete(e),this.storage.remove(e._id.toString())}}renameCollection(){throw"Not Implemented"}save(){throw"Not Implemented"}stats(){throw"Not Implemented"}storageSize(){throw"Not Implemented"}totalSize(){throw"Not Implemented"}totalIndexSize(){throw"Not Implemented"}update(e,t,n){const r=this.find(e);if(r.hasNext())if(n&&n.multi)for(;r.hasNext();){const e=r.next();this.updateIndexesOnDelete(e),Z(t,e),this.storage.set(e._id.toString(),e),this.updateIndexesOnInsert(e)}else{const e=r.next();this.updateIndexesOnDelete(e),Z(t,e),this.storage.set(e._id.toString(),e),this.updateIndexesOnInsert(e)}else if(n&&n.upsert){const n=X(e,t,this.idGenerator);this.storage.set(n._id.toString(),n),this.updateIndexesOnInsert(n)}}async updateOne(e,t,n){const r=this.find(e);if(r.hasNext()){const e=r.next(),n=JSON.parse(JSON.stringify(e));this.updateIndexesOnDelete(e),Z(t,e),this.storage.set(e._id.toString(),e),this.updateIndexesOnInsert(e);const s=this._getUpdateDescription(n,e);this.emit("update",e,s)}else if(n&&n.upsert){const n=X(e,t,this.idGenerator);this.storage.set(n._id.toString(),n),this.updateIndexesOnInsert(n),this.emit("insert",n)}}async updateMany(e,t,n){const r=this.find(e);if(r.hasNext())for(;r.hasNext();){const e=r.next(),n=JSON.parse(JSON.stringify(e));this.updateIndexesOnDelete(e),Z(t,e),this.storage.set(e._id.toString(),e),this.updateIndexesOnInsert(e);const s=this._getUpdateDescription(n,e);this.emit("update",e,s)}else if(n&&n.upsert){const n=X(e,t,this.idGenerator);this.storage.set(n._id.toString(),n),this.updateIndexesOnInsert(n),this.emit("insert",n)}}validate(){throw"Not Implemented"}_getUpdateDescription(e,t){const n={},r=[];for(const s in t)"_id"!==s&&JSON.stringify(e[s])!==JSON.stringify(t[s])&&(n[s]=t[s]);for(const s in e)"_id"!==s&&(s in t||r.push(s));return{updatedFields:n,removedFields:r,truncatedArrays:[]}}watch(e=[],t={}){return new xe(this,e,t)}}function be(e,t){const n={},r=Object.keys(e);let s=!1,i=!1;for(const o of r){if("_id"===o)continue;const t=e[o];1===t||!0===t?s=!0:0===t||!1===t||(i=!0)}if(i||s){0!==e._id&&!1!==e._id&&(n._id=t._id);for(const s of r){const r=e[s];"_id"===s?0!==r&&!1!==r||delete n._id:n[s]=1===r||!0===r?o(t,s):ge(r,t)}}else{for(const e in t)t.hasOwnProperty(e)&&(n[e]=t[e]);for(const t of r)0!==e[t]&&!1!==e[t]||delete n[t]}return n}class _e{constructor(){this.data=/* @__PURE__ */new Map}clear(){this.data=/* @__PURE__ */new Map}keys(){return this.data.keys()}get(e){return this.data.get(e)}remove(e){this.data.delete(e)}set(e,t){this.data.set(e,t)}size(){return this.data.size}}class ve{constructor(){this.documents=new _e,this.indexes=/* @__PURE__ */new Map}clear(){this.documents.clear(),this.indexes.clear()}documentKeys(){return this.documents.keys()}getAllDocuments(){return Array.from(this.documents.data.values())}get(e){if("string"!=typeof e)throw new Error("Document key must be a string");return this.documents.get(e)}set(e,t){if("string"!=typeof e)throw new Error("Document key must be a string");this.documents.set(e,t)}remove(e){if("string"!=typeof e)throw new Error("Document key must be a string");this.documents.remove(e)}size(){return this.documents.size()}getStore(){const e={};for(const t of this.documents.keys())e[t]=this.documents.get(t);return e}indexesCount(){return this.indexes.size}indexKeys(){return this.indexes.keys()}createIndexStore(e,t){return this.indexes.has(e)||this.indexes.set(e,new z(t)),this.indexes.get(e)}}class $e{constructor(){this.collections=/* @__PURE__ */new Map}collectionsCount(){return this.collections.size}collectionStoreKeys(){return this.collections.keys()}getCollectionStore(e){return this.collections.get(e)}createCollectionStore(e){if(this.collections.has(e))return this.collections.get(e);const t=new ve;return this.collections.set(e,t),t}removeCollectionStore(e){this.collections.delete(e)}save(){}}class Ie{constructor(e){return this.options=e||{},this.dbName=this.options.dbName||"default",this.storageEngine=this.options.storageEngine||new $e,this._loadExistingCollections(),new Proxy(this,{get:(e,t,n)=>t in e?Reflect.get(e,t,n):"symbol"==typeof t||t.startsWith("_")?void 0:"string"==typeof t?(Object.prototype.hasOwnProperty.call(e,t)||e.createCollection(t),e[t]):void 0})}_log(e){this.options&&this.options.print?this.options.print(e):console.log(e)}_id(){return this.options&&this.options.id?this.options.id():new r}_loadExistingCollections(){for(const e of this.storageEngine.collectionStoreKeys()){const t=this.storageEngine.getCollectionStore(e);this[e]=new we(this,e,t,this._id.bind(this))}}cloneCollection(){throw"Not Implemented"}cloneDatabase(){throw"Not Implemented"}commandHelp(){throw"Not Implemented"}copyDatabase(){throw"Not Implemented"}createCollection(e){e&&(this[e]=new we(this,e,this.storageEngine.createCollectionStore(e),this._id.bind(this)))}collection(e){if(!e)throw new Error("Collection name is required");return this[e]&&this[e].isCollection||this.createCollection(e),this[e]}currentOp(){throw"Not Implemented"}dropDatabase(){const e=this.getCollectionNames();for(const t of e)this.storageEngine.removeCollectionStore(t),delete this[t]}eval(){throw"Not Implemented"}fsyncLock(){throw"Not Implemented"}fsyncUnlock(){throw"Not Implemented"}getCollection(){throw"Not Implemented"}getCollectionInfos(){throw"Not Implemented"}getCollectionNames(){const e=[];for(const t in this)null!=this[t]&&this[t].isCollection&&e.push(t);return e}getLastError(){throw"Not Implemented"}getLastErrorObj(){throw"Not Implemented"}getLogComponents(){throw"Not Implemented"}getMongo(){throw"Not Implemented"}getName(){throw"Not Implemented"}getPrevError(){throw"Not Implemented"}getProfilingLevel(){throw"Not Implemented"}getProfilingStatus(){throw"Not Implemented"}getReplicationInfo(){throw"Not Implemented"}getSiblingDB(){throw"Not Implemented"}help(){this._log("        help mr                      mapreduce"),this._log("        db.foo.find()                list objects in collection foo"),this._log("        db.foo.find( { a : 1 } )     list objects in foo where a == 1"),this._log("        it                           result of the last line evaluated; use to further iterate")}hostInfo(){throw"Not Implemented"}isMaster(){throw"Not Implemented"}killOp(){throw"Not Implemented"}listCommands(){throw"Not Implemented"}loadServerScripts(){throw"Not Implemented"}logout(){throw"Not Implemented"}printCollectionStats(){throw"Not Implemented"}printReplicationInfo(){throw"Not Implemented"}printShardingStatus(){throw"Not Implemented"}printSlaveReplicationInfo(){throw"Not Implemented"}repairDatabase(){throw"Not Implemented"}resetError(){throw"Not Implemented"}runCommand(){throw"Not Implemented"}serverBuildInfo(){throw"Not Implemented"}serverCmdLineOpts(){throw"Not Implemented"}serverStatus(){throw"Not Implemented"}setLogLevel(){throw"Not Implemented"}setProfilingLevel(){throw"Not Implemented"}shutdownServer(){throw"Not Implemented"}stats(){throw"Not Implemented"}version(){throw"Not Implemented"}upgradeCheck(){throw"Not Implemented"}upgradeCheckAllDBs(){throw"Not Implemented"}watch(e=[],t={}){return new xe(this,e,t)}}class Se extends n.EventEmitter{constructor(e="mongodb://localhost:27017",t={}){super(),this.uri=e,this.options=Object.freeze({...t}),this._isConnected=!1,this._defaultDb=this._parseDefaultDbName(e)}static async connect(e,t={}){const n=new Se(e,t);return await n.connect(),n}async connect(){return this._isConnected||(this._isConnected=!0,this.emit("open",this)),this}db(e,t={}){const n=e||this._defaultDb;if(!n)throw new Error("No database name provided and no default in connection string");const r={...this.options,...t,dbName:n};return new Ie(r)}async close(e=!1){this._isConnected&&(this._isConnected=!1,this.emit("close"))}startSession(e={}){return{id:crypto.randomUUID(),endSession:()=>{},withTransaction:async e=>await e(this)}}async withSession(e,t){const n=this.startSession("function"==typeof e?{}:e),r="function"==typeof e?e:t;try{return await r(n)}finally{n.endSession()}}get readConcern(){return this.options.readConcern}get writeConcern(){return this.options.writeConcern}get readPreference(){return this.options.readPreference}watch(e=[],t={}){return new xe(this,e,t)}_parseDefaultDbName(e){const t=e.match(/\/([^/?]+)/);return t?t[1]:null}}class Ne extends $e{constructor(e="micro-mongo"){super(),this.dbName=e,this.db=null,this.indexedDBName=`micro-mongo-${e}`}async initialize(){return new Promise((e,t)=>{const n=indexedDB.open(this.indexedDBName,1);n.onerror=()=>{t(new Error("Failed to open IndexedDB: "+n.error))},n.onsuccess=()=>{this.db=n.result,e()},n.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains("collections")||t.createObjectStore("collections",{keyPath:"name"}),t.objectStoreNames.contains("metadata")||t.createObjectStore("metadata",{keyPath:"key"})}})}async saveDatabase(e){this.db||await this.initialize();const t=this.db.transaction(["metadata"],"readwrite").objectStore("metadata");await new Promise((n,r)=>{const s=t.put({key:"dbName",value:e.name});s.onsuccess=()=>n(),s.onerror=()=>r(s.error)});for(const n in e.collections)e.collections.hasOwnProperty(n)&&await this.saveCollection(e.name,n,e.collections[n])}async loadDatabase(e){this.db||await this.initialize();const t=this.db.transaction(["collections"],"readonly").objectStore("collections");return new Promise((n,r)=>{const s=t.getAll();s.onsuccess=()=>{const t={};for(const e of s.result)t[e.name]={documents:e.documents||[],indexes:e.indexes||[]};n({name:e,collections:t})},s.onerror=()=>r(s.error)})}async saveCollection(e,t,n){this.db||await this.initialize();const r=this.db.transaction(["collections"],"readwrite").objectStore("collections");return new Promise((e,s)=>{const i=r.put({name:t,documents:n.documents||[],indexes:n.indexes||[]});i.onsuccess=()=>e(),i.onerror=()=>s(i.error)})}async loadCollection(e,t){this.db||await this.initialize();const n=this.db.transaction(["collections"],"readonly").objectStore("collections");return new Promise((e,r)=>{const s=n.get(t);s.onsuccess=()=>{s.result?e({documents:s.result.documents||[],indexes:s.result.indexes||[]}):e(null)},s.onerror=()=>r(s.error)})}async deleteCollection(e,t){this.db||await this.initialize();const n=this.db.transaction(["collections"],"readwrite").objectStore("collections");return new Promise((e,r)=>{const s=n.delete(t);s.onsuccess=()=>e(),s.onerror=()=>r(s.error)})}async deleteDatabase(e){return this.db&&(this.db.close(),this.db=null),new Promise((e,t)=>{const n=indexedDB.deleteDatabase(this.indexedDBName);n.onsuccess=()=>e(),n.onerror=()=>t(n.error)})}async close(){this.db&&(this.db.close(),this.db=null)}}export{xe as ChangeStream,Ne as IndexedDbStorageEngine,Se as MongoClient,r as ObjectId,$e as StorageEngine};
//# sourceMappingURL=micro-mongo-2.0.0.min.js.map
