!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).MicroMongo={})}(this,function(e){"use strict";var t,n={exports:{}};var r=function(){if(t)return n.exports;t=1;var e,r="object"==typeof Reflect?Reflect:null,i=r&&"function"==typeof r.apply?r.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};e=r&&"function"==typeof r.ownKeys?r.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var s=Number.isNaN||function(e){return e!=e};function o(){o.init.call(this)}n.exports=o,n.exports.once=function(e,t){return new Promise(function(n,r){function i(n){e.removeListener(t,s),r(n)}function s(){"function"==typeof e.removeListener&&e.removeListener("error",i),n([].slice.call(arguments))}m(e,t,s,{once:!0}),"error"!==t&&function(e,t,n){"function"==typeof e.on&&m(e,"error",t,n)}(e,i,{once:!0})})},o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var a=10;function l(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function c(e){return void 0===e._maxListeners?o.defaultMaxListeners:e._maxListeners}function u(e,t,n,r){var i,s,o,a;if(l(n),void 0===(s=e._events)?(s=e._events=Object.create(null),e._eventsCount=0):(void 0!==s.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),s=e._events),o=s[t]),void 0===o)o=s[t]=n,++e._eventsCount;else if("function"==typeof o?o=s[t]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),(i=c(e))>0&&o.length>i&&!o.warned){o.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=o.length,a=u,console&&console.warn&&console.warn(a)}return e}function h(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function f(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=h.bind(r);return i.listener=n,r.wrapFn=i,i}function d(e,t,n){var r=e._events;if(void 0===r)return[];var i=r[t];return void 0===i?[]:"function"==typeof i?n?[i.listener||i]:[i]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(i):g(i,i.length)}function p(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function g(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}function m(e,t,n,r){if("function"==typeof e.on)r.once?e.once(t,n):e.on(t,n);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,function i(s){r.once&&e.removeEventListener(t,i),n(s)})}}return Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return a},set:function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");a=e}}),o.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},o.prototype.getMaxListeners=function(){return c(this)},o.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var r="error"===e,s=this._events;if(void 0!==s)r=r&&void 0===s.error;else if(!r)return!1;if(r){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var l=s[e];if(void 0===l)return!1;if("function"==typeof l)i(l,this,t);else{var c=l.length,u=g(l,c);for(n=0;n<c;++n)i(u[n],this,t)}return!0},o.prototype.addListener=function(e,t){return u(this,e,t,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(e,t){return u(this,e,t,!0)},o.prototype.once=function(e,t){return l(t),this.on(e,f(this,e,t)),this},o.prototype.prependOnceListener=function(e,t){return l(t),this.prependListener(e,f(this,e,t)),this},o.prototype.removeListener=function(e,t){var n,r,i,s,o;if(l(t),void 0===(r=this._events))return this;if(void 0===(n=r[e]))return this;if(n===t||n.listener===t)0===--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,s=n.length-1;s>=0;s--)if(n[s]===t||n[s].listener===t){o=n[s].listener,i=s;break}if(i<0)return this;0===i?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,i),1===n.length&&(r[e]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",e,o||t)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(e){var t,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0===--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var i,s=Object.keys(n);for(r=0;r<s.length;++r)"removeListener"!==(i=s[r])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},o.prototype.listeners=function(e){return d(this,e,!0)},o.prototype.rawListeners=function(e){return d(this,e,!1)},o.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):p.call(e,t)},o.prototype.listenerCount=p,o.prototype.eventNames=function(){return this._eventsCount>0?e(this._events):[]},n.exports}();const i=0,s=1,o=2,a=3,l=4,c=5,u=6,h=7,f=8,d=9,p=16,g=17;class m{constructor(e){if(null==e)this.id=m.generate();else if("string"==typeof e){if(!m.isValid(e))throw new Error(`Argument passed in must be a string of 24 hex characters, got: ${e}`);this.id=e.toLowerCase()}else if(e instanceof Uint8Array&&12===e.length)this.id=Array.from(e).map(e=>e.toString(16).padStart(2,"0")).join("");else{if(!(e instanceof m))throw new Error("Argument passed in must be a string of 24 hex characters or an ObjectId");this.id=e.id}}toString(){return this.id}toHexString(){return this.id}getTimestamp(){const e=parseInt(this.id.substring(0,8),16);return new Date(1e3*e)}equals(e){if(!(e instanceof m))throw new Error("Can only compare with another ObjectId");return this.id===e.id}compare(e){if(!(e instanceof m))throw new Error("Can only compare with another ObjectId");return this.id.localeCompare(e.id)}toJSON(){return this.id}inspect(){return`ObjectId("${this.id}")`}toBytes(){const e=new Uint8Array(12);for(let t=0;t<12;t++)e[t]=parseInt(this.id.substring(2*t,2*t+2),16);return e}static isValid(e){return!!e&&("string"==typeof e&&(24===e.length&&/^[0-9a-fA-F]{24}$/.test(e)))}static createFromTime(e){const t=("00000000"+Math.floor(e/1e3).toString(16)).slice(-8);return new m(t+"0000000000000000")}static generate(){const e=Math.floor(Date.now()/1e3),t="undefined"!=typeof crypto&&crypto.getRandomValues?new Uint8Array(8):null;let n="";if(t){crypto.getRandomValues(t);for(let e=0;e<t.length;e++)n+=("0"+t[e].toString(16)).slice(-2)}else n=Math.random().toString(16).slice(2).padEnd(8,"0").slice(0,8)+Math.random().toString(16).slice(2).padEnd(8,"0").slice(0,8);return(("00000000"+e.toString(16)).slice(-8)+n).slice(0,24)}}class y{constructor(e){if(null==e)throw new Error("Pointer offset must be a number");if("number"!=typeof e)throw new Error("Pointer offset must be a number");if(!Number.isInteger(e))throw new Error("Pointer offset must be an integer");if(e<0)throw new Error("Pointer offset must be non-negative");if(e>Number.MAX_SAFE_INTEGER)throw new Error("Pointer offset exceeds maximum safe integer");this.offset=e}valueOf(){return this.offset}toString(){return this.offset.toString()}toJSON(){return this.offset}inspect(){return`Pointer(${this.offset})`}equals(e){return e instanceof y&&this.offset===e.offset}}function w(e){const t=[];!function e(n){if(null===n)t.push(new Uint8Array([i]));else if(!1===n)t.push(new Uint8Array([s]));else if(!0===n)t.push(new Uint8Array([o]));else if(n instanceof m)t.push(new Uint8Array([u])),t.push(n.toBytes());else if(n instanceof Date){t.push(new Uint8Array([h]));const e=new ArrayBuffer(8);new DataView(e).setBigInt64(0,BigInt(n.getTime()),!0),t.push(new Uint8Array(e))}else if(n instanceof y){t.push(new Uint8Array([f]));const e=new ArrayBuffer(8);new DataView(e).setBigUint64(0,BigInt(n.offset),!0),t.push(new Uint8Array(e))}else if(n instanceof Uint8Array){t.push(new Uint8Array([d]));const e=new ArrayBuffer(4);new DataView(e).setUint32(0,n.length,!0),t.push(new Uint8Array(e)),t.push(n)}else if("number"==typeof n)if(Number.isInteger(n)&&Number.isSafeInteger(n)){t.push(new Uint8Array([a]));const e=new ArrayBuffer(8);new DataView(e).setBigInt64(0,BigInt(n),!0),t.push(new Uint8Array(e))}else{t.push(new Uint8Array([l]));const e=new ArrayBuffer(8);new DataView(e).setFloat64(0,n,!0),t.push(new Uint8Array(e))}else if("string"==typeof n){t.push(new Uint8Array([c]));const e=(new TextEncoder).encode(n),r=new ArrayBuffer(4);new DataView(r).setUint32(0,e.length,!0),t.push(new Uint8Array(r)),t.push(e)}else if(Array.isArray(n)){const r=[],i=new ArrayBuffer(4);new DataView(i).setUint32(0,n.length,!0),r.push(new Uint8Array(i));const s=t.length;for(const t of n)e(t);const o=t.splice(s);r.push(...o);const a=r.reduce((e,t)=>e+t.length,0);t.push(new Uint8Array([p]));const l=new ArrayBuffer(4);new DataView(l).setUint32(0,a,!0),t.push(new Uint8Array(l)),t.push(...r)}else{if("object"!=typeof n)throw new Error("Unsupported type: "+typeof n);{const r=[],i=Object.keys(n),s=new ArrayBuffer(4);new DataView(s).setUint32(0,i.length,!0),r.push(new Uint8Array(s));const o=t.length;for(const u of i){const r=(new TextEncoder).encode(u),i=new ArrayBuffer(4);new DataView(i).setUint32(0,r.length,!0),t.push(new Uint8Array(i)),t.push(r),e(n[u])}const a=t.splice(o);r.push(...a);const l=r.reduce((e,t)=>e+t.length,0);t.push(new Uint8Array([g]));const c=new ArrayBuffer(4);new DataView(c).setUint32(0,l,!0),t.push(new Uint8Array(c)),t.push(...r)}}}(e);const n=t.reduce((e,t)=>e+t.length,0),r=new Uint8Array(n);let w=0;for(const i of t)r.set(i,w),w+=i.length;return r}function b(e){let t=0;return function n(){if(t>=e.length)throw new Error("Unexpected end of data");const r=e[t++];switch(r){case i:return null;case s:return!1;case o:return!0;case a:{if(t+4>e.length)throw new Error("Unexpected end of data for INT");const n=new DataView(e.buffer,e.byteOffset+t,8).getBigInt64(0,!0);if(t+=8,n<BigInt(Number.MIN_SAFE_INTEGER)||n>BigInt(Number.MAX_SAFE_INTEGER))throw new Error("Decoded integer exceeds safe range");return Number(n)}case l:{if(t+8>e.length)throw new Error("Unexpected end of data for FLOAT");const n=new DataView(e.buffer,e.byteOffset+t,8).getFloat64(0,!0);return t+=8,n}case c:{if(t+4>e.length)throw new Error("Unexpected end of data for STRING length");const n=new DataView(e.buffer,e.byteOffset+t,4).getUint32(0,!0);if(t+=4,t+n>e.length)throw new Error("Unexpected end of data for STRING content");const r=e.slice(t,t+n);return t+=n,(new TextDecoder).decode(r)}case u:{if(t+12>e.length)throw new Error("Unexpected end of data for OID");const n=e.slice(t,t+12);return t+=12,new m(n)}case h:{if(t+8>e.length)throw new Error("Unexpected end of data for DATE");const n=new DataView(e.buffer,e.byteOffset+t,8).getBigInt64(0,!0);return t+=8,new Date(Number(n))}case f:{if(t+8>e.length)throw new Error("Unexpected end of data for POINTER");const n=new DataView(e.buffer,e.byteOffset+t,8).getBigUint64(0,!0);if(t+=8,n>BigInt(Number.MAX_SAFE_INTEGER))throw new Error("Pointer offset out of valid range");return new y(Number(n))}case d:{if(t+4>e.length)throw new Error("Unexpected end of data for BINARY length");const n=new DataView(e.buffer,e.byteOffset+t,4).getUint32(0,!0);if(t+=4,t+n>e.length)throw new Error("Unexpected end of data for BINARY content");const r=e.slice(t,t+n);return t+=n,r}case p:{if(t+4>e.length)throw new Error("Unexpected end of data for ARRAY size");const r=new DataView(e.buffer,e.byteOffset+t,4).getUint32(0,!0);if(t+=4,t+r>e.length)throw new Error("Unexpected end of data for ARRAY content");const i=new DataView(e.buffer,e.byteOffset+t,4).getUint32(0,!0);t+=4;const s=[];for(let e=0;e<i;e++)s.push(n());return s}case g:{if(t+4>e.length)throw new Error("Unexpected end of data for OBJECT size");const r=new DataView(e.buffer,e.byteOffset+t,4).getUint32(0,!0);if(t+=4,t+r>e.length)throw new Error("Unexpected end of data for OBJECT content");const i=new DataView(e.buffer,e.byteOffset+t,4).getUint32(0,!0);t+=4;const s={};for(let o=0;o<i;o++){if(t+4>e.length)throw new Error("Unexpected end of data for OBJECT key length");const r=new DataView(e.buffer,e.byteOffset+t,4).getUint32(0,!0);if(t+=4,t+r>e.length)throw new Error("Unexpected end of data for OBJECT key");const i=e.slice(t,t+r);t+=r;s[(new TextDecoder).decode(i)]=n()}return s}default:throw new Error(`Unknown type byte: 0x${r.toString(16)}`)}}()}class x{constructor(e){this.filename=e,this.root=null,this.fileHandle=null,this.syncAccessHandle=null,this.mode=null,this.isOpen=!1}async open(e="r"){if(this.isOpen)throw new Error(`File is already open in ${this.mode} mode`);if("r"!==e&&"rw"!==e)throw new Error(`Invalid mode: ${e}. Use 'r' for read-only or 'rw' for read-write`);if(!navigator.storage||!navigator.storage.getDirectory)throw new Error("Origin Private File System (OPFS) is not supported in this browser");this.root=this.root||await navigator.storage.getDirectory(),this.mode=e;try{this.fileHandle="r"===e?await this.root.getFileHandle(this.filename):await this.root.getFileHandle(this.filename,{create:!0}),this.syncAccessHandle=await this.fileHandle.createSyncAccessHandle(),this.isOpen=!0}catch(t){if("NotFoundError"===t.name)throw new Error(`File not found: ${this.filename}`);if("NoModificationAllowedError"===t.name||t.message?.includes("createSyncAccessHandle"))throw new Error("FileSystemSyncAccessHandle is only available in Web Workers. BJsonFile must be used in a Web Worker context.");throw t}}async close(){this.syncAccessHandle&&(this.syncAccessHandle.flush(),await this.syncAccessHandle.close(),this.syncAccessHandle=null),this.isOpen=!1,this.mode=null,this.fileHandle=null}ensureOpen(){if(!this.isOpen)throw new Error("File is not open. Call open('r') or open('rw') first")}ensureWritable(){if(this.ensureOpen(),"r"===this.mode)throw new Error("File is opened in read-only mode. Cannot write or append")}#e(e,t){this.ensureOpen();const n=new Uint8Array(t),r=this.syncAccessHandle.read(n,{at:e});return r<t?n.slice(0,r):n}getFileSize(){return this.ensureOpen(),this.syncAccessHandle.getSize()}write(e){this.ensureWritable();const t=w(e);this.syncAccessHandle.truncate(0),this.syncAccessHandle.write(t,{at:0})}read(e=new y(0)){this.ensureOpen();const t=this.getFileSize();if(0===t)throw new Error(`File is empty: ${this.filename}`);const n=e.valueOf();if(n<0||n>=t)throw new Error(`Pointer offset ${e} out of file bounds [0, ${t})`);return b(this.#e(n,t-n))}append(e){this.ensureWritable();const t=w(e),n=this.getFileSize();this.syncAccessHandle.write(t,{at:n})}flush(){this.ensureWritable(),this.syncAccessHandle.flush()}*scan(){this.ensureOpen();const e=this.getFileSize();if(0===e)return;let t=0;for(;t<e;){const e=(e=>{let t=this.#e(e,1);const n=t[0];switch(n){case i:case s:case o:return 1;case a:case l:case h:case f:return 9;case u:return 13;case c:t=this.#e(e+1,4);return 5+new DataView(t.buffer,t.byteOffset,4).getUint32(0,!0);case d:t=this.#e(e+1,4);return 5+new DataView(t.buffer,t.byteOffset,4).getUint32(0,!0);case p:t=this.#e(e+1,4);return 5+new DataView(t.buffer,t.byteOffset,4).getUint32(0,!0);case g:t=this.#e(e+1,4);return 5+new DataView(t.buffer,t.byteOffset,4).getUint32(0,!0);default:throw new Error(`Unknown type byte: 0x${n.toString(16)}`)}})(t),n=this.#e(t,e);t+=e,yield b(n)}}async delete(){if(this.isOpen)throw new Error("File is open. Call close() first");this.root=this.root||await navigator.storage.getDirectory();try{await this.root.removeEntry(this.filename)}catch(e){if("NotFoundError"===e.name)return;throw e}}async exists(){if(!navigator.storage||!navigator.storage.getDirectory)throw new Error("Origin Private File System (OPFS) is not supported in this browser");this.root=this.root||await navigator.storage.getDirectory();try{return await this.root.getFileHandle(this.filename),!0}catch(e){if("NotFoundError"===e.name)return!1;throw e}}}function _(e,t){return e instanceof m||t instanceof m?e instanceof m&&t instanceof m||e instanceof m&&"string"==typeof t?e.equals(t):t instanceof m&&"string"==typeof e&&t.equals(e):e==t}function v(e){if(e instanceof m)return new m(e.id);var t,n,r;for(r in t=Array.isArray(e)?[]:{},e)n=e[r],t[r]="object"==typeof n&&null!==n?v(n):n;return t}function N(e,t){for(var n=t.split("."),r=e[n[0]],i=1;i<n.length;i++){if(null==r||null==r)return r;var s=n[i],o=parseInt(s,10);r=E(r)&&!isNaN(o)&&o>=0&&o<r.length?r[o]:r[s]}return r}function $(e,t){for(var n=t.split("."),r=[e],i=0;i<n.length;i++){for(var s=n[i],o=parseInt(s,10),a=[],l=0;l<r.length;l++){var c=r[l];if(null!=c&&null!=c)if(E(c)&&!isNaN(o)&&o>=0)o<c.length&&a.push(c[o]);else if(E(c))for(var u=0;u<c.length;u++)null!=c[u]&&null!=c[u]&&"object"==typeof c[u]&&a.push(c[u][s]);else"object"==typeof c&&a.push(c[s])}r=a}if(0!==(r=r.filter(function(e){return void 0!==e})).length)return 1===r.length?r[0]:r}function O(e,t,n){if(-1!==t.indexOf("$[]"))return function(e,t,n){for(var r=t.split("."),i=e,s=0;s<r.length;s++){var o=r[s];if("$[]"===o){if(!Array.isArray(i))throw new Error("The positional operator did not find the match needed from the query.");for(var a=r.slice(s+1).join("."),l=0;l<i.length;l++)a?O(i[l],a,n):i[l]=n;return}var c=parseInt(o,10);if(E(i)&&!isNaN(c)&&c>=0)i=i[c];else{if(null==i[o]||null==i[o]){var u=s+1<r.length?r[s+1]:null;if("$[]"===u)i[o]=[];else{var h=parseInt(u,10);!isNaN(h)&&h>=0?i[o]=[]:i[o]={}}}i=i[o]}}}(e,t,n);for(var r=t.split("."),i=e,s=0;s<r.length-1;s++){var o=r[s],a=parseInt(o,10);if(E(i)&&!isNaN(a)&&a>=0){for(;i.length<=a;)i.push(void 0);if(null==i[a]||null==i[a]){var l=r[s+1],c=parseInt(l,10);!isNaN(c)&&c>=0?i[a]=[]:i[a]={}}i=i[a]}else{if(null==i[o]||null==i[o]){l=r[s+1],c=parseInt(l,10);!isNaN(c)&&c>=0?i[o]=[]:i[o]={}}i=i[o]}}var u=r[r.length-1],h=parseInt(u,10);if(E(i)&&!isNaN(h)&&h>=0){for(;i.length<=h;)i.push(void 0);i[h]=n}else i[u]=n}function E(e){return Array==e.constructor}function A(e){var t=[];for(var n in e)if(e.hasOwnProperty(n)){var r={};r[n]=e[n],t.push(r)}return t}function I(e,t){for(var n=0;n<t.length;n++)if(_(t[n],e))return!0;return!1}function S(e,t){if(e.length!=t.length)return!1;for(var n=0;n<e.length;n++)if(!_(e[n],t[n])){if(typeof e[n]!=typeof t[n])return!1;if("object"==typeof e[n]&&null!==e[n]){if(E(e[n])){if(!S(e[n],t[n]))return!1}else if(!C(e[n],t[n]))return!1}else if(!_(e[n],t[n]))return!1}return!0}function C(e,t){for(var n in e)if(e.hasOwnProperty(n)){if(!t.hasOwnProperty(n))return!1;if(!_(e[n],t[n])){if(typeof e[n]!=typeof t[n])return!1;if("object"==typeof e[n]&&null!==e[n]){if(E(e[n])){if(!S(e[n],t[n]))return!1}else if(!C(e[n],t[n]))return!1}else if(!_(e[n],t[n]))return!1}}for(var n in t)if(t.hasOwnProperty(n)&&!e.hasOwnProperty(n))return!1;return!0}function D(e,t){var n={},r=Object.keys(e);if(0==r.length)return t;for(var i=!1,s=!1,o=0;o<r.length;o++)"_id"!==r[o]&&(e[r[o]]?i=!0:s=!0);if(i&&s)throw{$err:"Can't canonicalize query: BadValue Projection cannot have a mix of inclusion and exclusion.",code:17287};if(e[r[0]]||i){0!==e._id&&(n._id=t._id);for(o=0;o<r.length;o++)if("_id"!==r[o]&&e[r[o]]){var a=N(t,u=r[o]);void 0!==a&&O(n,u,a)}}else{for(var l in t)if(t.hasOwnProperty(l)){var c=t[l];"object"!=typeof c||null===c||E(c)?E(c)?n[l]=c.slice():n[l]=c:n[l]=v(c)}for(o=0;o<r.length;o++)if(!e[r[o]]){var u,h=(u=r[o]).split(".");if(1===h.length)delete n[u];else{for(var f=n,d=0;d<h.length-1&&(null!=f&&null!=f);d++)f=f[h[d]];null!=f&&null!=f&&delete f[h[h.length-1]]}}}return n}const T={OK:0,INTERNAL_ERROR:1,BAD_VALUE:2,NO_SUCH_KEY:4,GRAPH_CONTAINS_CYCLE:5,HOST_UNREACHABLE:6,HOST_NOT_FOUND:7,UNKNOWN_ERROR:8,FAILED_TO_PARSE:17287,CANNOT_MUTATE_OBJECT:10,USER_NOT_FOUND:11,UNSUPPORTED_FORMAT:12,UNAUTHORIZED:13,TYPE_MISMATCH:14,OVERFLOW:15,INVALID_LENGTH:16,PROTOCOL_ERROR:17,AUTHENTICATION_FAILED:18,ILLEGAL_OPERATION:20,NAMESPACE_NOT_FOUND:26,INDEX_NOT_FOUND:27,PATH_NOT_VIABLE:28,CANNOT_CREATE_INDEX:67,INDEX_ALREADY_EXISTS:68,INDEX_EXISTS:68,COMMAND_NOT_FOUND:59,NAMESPACE_EXISTS:48,INVALID_NAMESPACE:73,INDEX_OPTIONS_CONFLICT:85,INVALID_INDEX_SPECIFICATION_OPTION:197,WRITE_CONFLICT:112,DUPLICATE_KEY:11e3,DUPLICATE_KEY_UPDATE:11001,DOCUMENT_VALIDATION_FAILURE:121,BAD_QUERY:2,CANNOT_INDEX_PARALLEL_ARRAYS:171,CURSOR_NOT_FOUND:43,COLLECTION_IS_EMPTY:26,CANNOT_DO_EXCLUSION_ON_FIELD_ID_IN_INCLUSION_PROJECTION:31254,NOT_IMPLEMENTED:999,OPERATION_NOT_SUPPORTED:998};class L extends Error{constructor(e,t={}){super(e),this.name="MongoError",this.code=t.code||T.UNKNOWN_ERROR,this.codeName=this._getCodeName(this.code),this.$err=e,t.collection&&(this.collection=t.collection),t.database&&(this.database=t.database),t.operation&&(this.operation=t.operation),t.query&&(this.query=t.query),t.document&&(this.document=t.document),t.field&&(this.field=t.field),t.index&&(this.index=t.index),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}_getCodeName(e){return{0:"OK",1:"InternalError",2:"BadValue",4:"NoSuchKey",5:"GraphContainsCycle",6:"HostUnreachable",7:"HostNotFound",8:"UnknownError",10:"CannotMutateObject",11:"UserNotFound",12:"UnsupportedFormat",13:"Unauthorized",14:"TypeMismatch",15:"Overflow",16:"InvalidLength",17:"ProtocolError",18:"AuthenticationFailed",20:"IllegalOperation",26:"NamespaceNotFound",27:"IndexNotFound",28:"PathNotViable",43:"CursorNotFound",48:"NamespaceExists",59:"CommandNotFound",67:"CannotCreateIndex",68:"IndexExists",73:"InvalidNamespace",85:"IndexOptionsConflict",112:"WriteConflict",121:"DocumentValidationFailure",171:"CannotIndexParallelArrays",197:"InvalidIndexSpecificationOption",998:"OperationNotSupported",999:"NotImplemented",11e3:"DuplicateKey",11001:"DuplicateKeyUpdate",17287:"FailedToParse"}[e]||"UnknownError"}toJSON(){const e={name:this.name,message:this.message,code:this.code,codeName:this.codeName};return this.collection&&(e.collection=this.collection),this.database&&(e.database=this.database),this.operation&&(e.operation=this.operation),this.index&&(e.index=this.index),this.indexName&&(e.indexName=this.indexName),this.field&&(e.field=this.field),this.query&&(e.query=this.query),this.document&&(e.document=this.document),this.namespace&&(e.namespace=this.namespace),this.cursorId&&(e.cursorId=this.cursorId),this.feature&&(e.feature=this.feature),this.keyPattern&&(e.keyPattern=this.keyPattern),this.keyValue&&(e.keyValue=this.keyValue),this.writeErrors&&(e.writeErrors=this.writeErrors),e}}class j extends L{constructor(e,t={}){super(e,t),this.name="WriteError",this.code=t.code||T.WRITE_CONFLICT}}class M extends L{constructor(e,t={}){super(e,t),this.name="IndexError"}}class k extends M{constructor(e,t={}){super(`Index '${e}' not found`,{...t,code:T.INDEX_NOT_FOUND,index:e}),this.name="IndexNotFoundError",this.indexName=e}}class F extends L{constructor(e,t={}){super(e,t),this.name="QueryError",this.code=t.code||T.BAD_QUERY}}class P extends L{constructor(e,t={}){super(e,t),this.name="NamespaceError"}}class U extends L{constructor(e,t={}){super(e,t),this.name="CursorError"}}class R extends L{constructor(e,t={}){super(`${e} is not implemented in micro-mongo`,{...t,code:T.NOT_IMPLEMENTED}),this.name="NotImplementedError",this.feature=e}}class B extends L{constructor(e,t,n,r={}){super(`Bad value for field '${e}': ${n}`,{...r,code:T.BAD_VALUE,field:e}),this.name="BadValueError",this.value=t}}class z{constructor(e,t,n,r,i){if(this.collection=e,this.query=t,this.projection=n,this.documents=r,this.SortedCursor=i,n&&Object.keys(n).length>0){const t=Object.keys(n);let r=!1,i=!1;for(let e=0;e<t.length;e++)"_id"!==t[e]&&(n[t[e]]?r=!0:i=!0);if(r&&i)throw new F("Can't canonicalize query: BadValue Projection cannot have a mix of inclusion and exclusion.",{code:T.FAILED_TO_PARSE,collection:e.name})}this.pos=0,this._limit=0,this._skip=0,this._closed=!1}batchSize(e){return this._batchSize=e,this}close(){this._closed=!0,this.pos=this.documents.length}comment(e){return this._comment=e,this}count(){return this.documents.length}explain(e="queryPlanner"){return{queryPlanner:{plannerVersion:1,namespace:`${this.collection.db?.name||"db"}.${this.collection.name}`,indexFilterSet:!1,parsedQuery:this.query,winningPlan:{stage:"COLLSCAN",filter:this.query,direction:"forward"}},executionStats:"executionStats"===e||"allPlansExecution"===e?{executionSuccess:!0,nReturned:this.documents.length,executionTimeMillis:0,totalKeysExamined:0,totalDocsExamined:this.documents.length}:void 0,ok:1}}async forEach(e){for(;this.hasNext();)await e(this.next())}hasNext(){if(this._closed)return!1;let e;return e=this._limit>0?Math.min(this._skip+this._limit,this.documents.length):this.documents.length,this.pos<e}hint(e){return this._hint=e,this}itcount(){let e=0;for(;this.hasNext();)this.next(),e++;return e}limit(e){return this._limit=e,this}map(e){const t=[];for(;this.hasNext();)t.push(e(this.next()));return t}maxScan(e){return this._maxScan=e,this}maxTimeMS(e){return this._maxTimeMS=e,this}max(e){return this._maxIndexBounds=e,this}min(e){return this._minIndexBounds=e,this}next(){if(!this.hasNext())throw new F("Error: error hasNext: false",{collection:this.collection.name});const e=this.documents[this.pos++];return this.projection?D(this.projection,e):e}noCursorTimeout(){return this._noCursorTimeout=!0,this}objsLeftInBatch(){return this.size()}pretty(){return this._pretty=!0,this}readConcern(e){return this._readConcern=e,this}readPref(e,t){return this._readPref={mode:e,tagSet:t},this}returnKey(e=!0){return this._returnKey=e,this}showRecordId(e=!0){return this._showRecordId=e,this}size(){const e=this.documents.length-this.pos;if(this._limit>0){const t=this._skip+this._limit;return Math.min(t-this.pos,e)}return e}skip(e){return this._skip=e,0===this.pos&&(this.pos=Math.min(e,this.documents.length)),this}isClosed(){return!0===this._closed}snapshot(){throw new R("snapshot")}sort(e){return new this.SortedCursor(this.collection,this.query,this,e)}allowDiskUse(e=!0){return this._allowDiskUse=e,this}collation(e){return this._collation=e,this}tailable(){throw new R("tailable")}toArray(){const e=[];for(;this.hasNext();)e.push(this.next());return e}async*[Symbol.asyncIterator](){for(;this.hasNext();)yield this.next()}}class q{constructor(e,t,n,r){for(this.collection=e,this.query=t,this.sortSpec=r,this.pos=0,this.items=[];n.hasNext();)this.items.push(n.next());const i=Object.keys(r);this.items.sort(function(e,t){for(let n=0;n<i.length;n++){if(null==e[i[n]]&&null!=t[i[n]])return-1*r[i[n]];if(null!=e[i[n]]&&null==t[i[n]])return 1*r[i[n]];if(e[i[n]]<t[i[n]])return-1*r[i[n]];if(e[i[n]]>t[i[n]])return 1*r[i[n]]}return 0})}batchSize(){throw"Not Implemented"}close(){throw"Not Implemented"}comment(){throw"Not Implemented"}count(){return this.items.length}explain(){throw"Not Implemented"}async forEach(e){for(;this.hasNext();)await e(this.next())}hasNext(){return this.pos<this.items.length}hint(){throw"Not Implemented"}itcount(){throw"Not Implemented"}limit(e){return this.items=this.items.slice(0,e),this}map(e){const t=[];for(;this.hasNext();)t.push(e(this.next()));return t}maxScan(){throw"Not Implemented"}maxTimeMS(){throw"Not Implemented"}max(){throw"Not Implemented"}min(){throw"Not Implemented"}next(){return this.items[this.pos++]}noCursorTimeout(){throw"Not Implemented"}objsLeftInBatch(){throw"Not Implemented"}pretty(){throw"Not Implemented"}readConcern(){throw"Not Implemented"}readPref(){throw"Not Implemented"}returnKey(){throw"Not Implemented"}showRecordId(){throw"Not Implemented"}size(){throw"Not Implemented"}skip(e){for(;e>0;)this.next(),e--;return this}snapshot(){throw"Not Implemented"}sort(e){return new q(this.collection,this.query,this,e)}tailable(){throw"Not Implemented"}toArray(){const e=[];for(;this.hasNext();)e.push(this.next());return e}async*[Symbol.asyncIterator](){for(;this.hasNext();)yield this.next()}}const V={ational:"ate",tional:"tion",enci:"ence",anci:"ance",izer:"ize",bli:"ble",alli:"al",entli:"ent",eli:"e",ousli:"ous",ization:"ize",ation:"ate",ator:"ate",alism:"al",iveness:"ive",fulness:"ful",ousness:"ous",aliti:"al",iviti:"ive",biliti:"ble",logi:"log"},W={icate:"ic",ative:"",alize:"al",iciti:"ic",ical:"ic",ful:"",ness:""},H="[aeiouy]",K="([^aeiou][^aeiouy]*)",Q="("+H+"[aeiou]*)",J=new RegExp("^"+K+"?"+Q+K),Y=new RegExp("^"+K+"?"+Q+K+Q+"?$"),X=new RegExp("^"+K+"?("+Q+K+"){2,}"),G=new RegExp("^"+K+"?"+H),Z=new RegExp("^"+K+H+"[^aeiouwxy]$"),ee=/ll$/,te=/^(.+?)e$/,ne=/^(.+?)y$/,re=/^(.+?(s|t))(ion)$/,ie=/^(.+?)(ed|ing)$/,se=/(at|bl|iz)$/,oe=/^(.+?)eed$/,ae=/^.+?[^s]s$/,le=/^.+?(ss|i)es$/,ce=/([^aeiouylsz])\1$/,ue=/^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$/,he=/^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/,fe=/^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$/;function de(e){let t=String(e).toLowerCase();if(t.length<3)return t;let n,r=!1;return 121===t.codePointAt(0)&&(r=!0,t="Y"+t.slice(1)),le.test(t)?t=t.slice(0,-2):ae.test(t)&&(t=t.slice(0,-1)),(n=oe.exec(t))?J.test(n[1])&&(t=t.slice(0,-1)):(n=ie.exec(t))&&G.test(n[1])&&(t=n[1],se.test(t)?t+="e":ce.test(t)?t=t.slice(0,-1):Z.test(t)&&(t+="e")),(n=ne.exec(t))&&G.test(n[1])&&(t=n[1]+"i"),(n=ue.exec(t))&&J.test(n[1])&&(t=n[1]+V[n[2]]),(n=he.exec(t))&&J.test(n[1])&&(t=n[1]+W[n[2]]),(n=fe.exec(t))?X.test(n[1])&&(t=n[1]):(n=re.exec(t))&&X.test(n[1])&&(t=n[1]),(n=te.exec(t))&&(X.test(n[1])||Y.test(n[1])&&!Z.test(n[1]))&&(t=n[1]),ee.test(t)&&X.test(t)&&(t=t.slice(0,-1)),r&&(t="y"+t.slice(1)),t}class pe{constructor(e,t,n,r,i,s){this.id=e,this.isLeaf=t,this.keys=n,this.values=r,this.children=i;for(let o of i)if(!(o instanceof y))throw new Error("Children must be Pointer objects");this.next=s}}class ge{constructor(e,t=3){if(t<3)throw new Error("B+ tree order must be at least 3");this.filename=e,this.order=t,this.minKeys=Math.ceil(t/2)-1,this.file=new x(e),this.isOpen=!1,this.rootPointer=null,this.nextNodeId=0,this._size=0}async open(){if(this.isOpen)throw new Error("Tree file is already open");await this.file.exists()?(await this.file.open("rw"),this._loadMetadata()):(await this.file.open("rw"),this._initializeNewTree()),this.isOpen=!0}async close(){this.isOpen&&(await this.file.close(),this.isOpen=!1)}_initializeNewTree(){const e=new pe(0,!0,[],[],[],null);this.nextNodeId=1,this._size=0;const t=this._saveNode(e);this.rootPointer=t,this._saveMetadata()}_saveMetadata(){const e={version:1,maxEntries:this.order,minEntries:this.minKeys,size:this._size,rootPointer:this.rootPointer,nextId:this.nextNodeId};this.file.append(e)}_loadMetadata(){const e=this.file.getFileSize();if(e<135)throw new Error("Invalid tree file");const t=e-135,n=this.file.read(t);if(!n||void 0===n.maxEntries)throw new Error("Failed to read metadata: missing required fields");this.order=n.maxEntries,this.minKeys=n.minEntries,this._size=n.size,this.nextNodeId=n.nextId,this.rootPointer=n.rootPointer}_saveNode(e){const t=this.file.getFileSize();return this.file.append(e),new y(t)}_loadNode(e){if(!(e instanceof y))throw new Error("Expected Pointer object");const t=this.file.read(e);return new pe(t.id,t.isLeaf,t.keys,t.values,t.children,t.next)}_loadRoot(){return this._loadNode(this.rootPointer)}search(e){const t=this._loadRoot();return this._searchNode(t,e)}_searchNode(e,t){if(!e.isLeaf){let n=0;for(;n<e.keys.length&&t>=e.keys[n];)n++;const r=this._loadNode(e.children[n]);return this._searchNode(r,t)}for(let n=0;n<e.keys.length;n++)if(t===e.keys[n])return e.values[n]}add(e,t){const n=this._loadRoot(),r=this._addToNode(n,e,t);let i;if(r.newNode)i=r.newNode;else{const e=this._saveNode(r.left),t=this._saveNode(r.right);i=new pe(this.nextNodeId++,!1,[r.splitKey],[],[e,t],null)}const s=this._saveNode(i);this.rootPointer=s,this._size++,this._saveMetadata()}_addToNode(e,t,n){if(e.isLeaf){const r=[...e.keys],i=[...e.values],s=r.indexOf(t);if(-1!==s)return i[s]=n,{newNode:new pe(e.id,!0,r,i,[],null)};let o=0;for(;o<r.length&&t>r[o];)o++;if(r.splice(o,0,t),i.splice(o,0,n),r.length<this.order)return{newNode:new pe(e.id,!0,r,i,[],null)};{const t=Math.ceil(r.length/2),n=r.slice(0,t),s=i.slice(0,t),o=r.slice(t),a=i.slice(t),l=new pe(this.nextNodeId++,!0,o,a,[],null);return{left:new pe(e.id,!0,n,s,[],null),right:l,splitKey:o[0]}}}{const r=[...e.keys],i=[...e.children];let s=0;for(;s<r.length&&t>=r[s];)s++;const o=this._loadNode(i[s]),a=this._addToNode(o,t,n);if(a.newNode){const t=this._saveNode(a.newNode);return i[s]=t,{newNode:new pe(e.id,!1,r,[],i,null)}}{const t=this._saveNode(a.left),n=this._saveNode(a.right);if(r.splice(s,0,a.splitKey),i.splice(s,1,t,n),r.length<this.order)return{newNode:new pe(e.id,!1,r,[],i,null)};{const t=Math.ceil(r.length/2)-1,n=r[t],s=r.slice(0,t),o=r.slice(t+1),a=i.slice(0,t+1),l=i.slice(t+1);return{left:new pe(e.id,!1,s,[],a,null),right:new pe(this.nextNodeId++,!1,o,[],l,null),splitKey:n}}}}}delete(e){const t=this._loadRoot(),n=this._deleteFromNode(t,e);if(!n)return;let r=n;0===r.keys.length&&!r.isLeaf&&r.children.length>0&&(r=this._loadNode(r.children[0]));const i=this._saveNode(r);this.rootPointer=i,this._size--,this._saveMetadata()}_deleteFromNode(e,t){if(e.isLeaf){const n=e.keys.indexOf(t);if(-1===n)return null;const r=[...e.keys],i=[...e.values];return r.splice(n,1),i.splice(n,1),new pe(e.id,!0,r,i,[],e.next)}{let n=0;for(;n<e.keys.length&&t>=e.keys[n];)n++;const r=this._loadNode(e.children[n]),i=this._deleteFromNode(r,t);if(!i)return null;const s=[...e.children],o=this._saveNode(i);return s[n]=o,new pe(e.id,!1,[...e.keys],[],s,null)}}toArray(){const e=[];return this._collectAllEntries(this._loadRoot(),e),e}async*[Symbol.asyncIterator](){if(!this.isOpen)throw new Error("Tree must be open before iteration");0!==this._size&&(yield*this._iterateNode(this._loadRoot()))}*_iterateNode(e){if(e.isLeaf)for(let t=0;t<e.keys.length;t++)yield{key:e.keys[t],value:e.values[t]};else for(const t of e.children){const e=this._loadNode(t);yield*this._iterateNode(e)}}_collectAllEntries(e,t){if(e.isLeaf)for(let n=0;n<e.keys.length;n++)t.push({key:e.keys[n],value:e.values[n]});else for(const n of e.children){const e=this._loadNode(n);this._collectAllEntries(e,t)}}size(){return this._size}isEmpty(){return 0===this._size}rangeSearch(e,t){const n=[];return this._rangeSearchNode(this._loadRoot(),e,t,n),n}_rangeSearchNode(e,t,n,r){if(e.isLeaf)for(let i=0;i<e.keys.length;i++)e.keys[i]>=t&&e.keys[i]<=n&&r.push({key:e.keys[i],value:e.values[i]});else for(const i of e.children){const e=this._loadNode(i);this._rangeSearchNode(e,t,n,r)}}getHeight(){let e=0,t=this._loadRoot();for(;!t.isLeaf;)e++,t=this._loadNode(t.children[0]);return e}async compact(e){if(!this.isOpen)throw new Error("Tree file is not open");if(!e)throw new Error("Destination filename is required for compaction");const t=await this.file.getFileSize(),n=this.toArray(),r=new ge(e,this.order);await r.open();for(const o of n)r.add(o.key,o.value);await r.close();const i=new x(e);await i.open("r");const s=await i.getFileSize();return await i.close(),{oldSize:t,newSize:s,bytesSaved:Math.max(0,t-s),newFilename:e}}}const me=new Set(["a","about","after","all","also","am","an","and","another","any","are","around","as","at","be","because","been","before","being","between","both","but","by","came","can","come","could","did","do","each","for","from","get","got","has","had","he","have","her","here","him","himself","his","how","i","if","in","into","is","it","like","make","many","me","might","more","most","much","must","my","never","now","of","on","only","or","other","our","out","over","said","same","see","should","since","some","still","such","take","than","that","the","their","them","then","there","these","they","this","those","through","to","too","under","up","very","was","way","we","well","were","what","where","which","while","who","with","would","you","your"]);function ye(e){if("string"!=typeof e)return[];return e.toLowerCase().split(/\W+/).filter(e=>e.length>0).filter(e=>!me.has(e))}class we{constructor(e={}){const{baseFilename:t=`text-index-${Date.now()}-${Math.random().toString(16).slice(2)}`,order:n=16,trees:r}=e;this.baseFilename=t,this.index=r?.index||new ge(`${t}-terms.bjson`,n),this.documentTerms=r?.documentTerms||new ge(`${t}-documents.bjson`,n),this.documentLengths=r?.documentLengths||new ge(`${t}-lengths.bjson`,n),this.isOpen=!1}async open(){if(this.isOpen)throw new Error("TextIndex is already open");await Promise.all([this.index.open(),this.documentTerms.open(),this.documentLengths.open()]),this.isOpen=!0}async close(){this.isOpen&&(await Promise.all([this.index.close(),this.documentTerms.close(),this.documentLengths.close()]),this.isOpen=!1)}_ensureOpen(){if(!this.isOpen)throw new Error("TextIndex is not open")}async add(e,t){if(this._ensureOpen(),!e)throw new Error("Document ID is required");const n=ye(t),r=new Map;n.forEach(e=>{const t=de(e);r.set(t,(r.get(t)||0)+1)});for(const[o,a]of r.entries()){const t=await this.index.search(o)||{};t[e]=a,await this.index.add(o,t)}const i={...await this.documentTerms.search(e)||{}};r.forEach((e,t)=>{i[t]=e});const s=Object.values(i).reduce((e,t)=>e+t,0);await this.documentTerms.add(e,i),await this.documentLengths.add(e,s)}async remove(e){this._ensureOpen();const t=await this.documentTerms.search(e);if(!t)return!1;for(const[n]of Object.entries(t)){const t=await this.index.search(n)||{};delete t[e],0===Object.keys(t).length?await this.index.delete(n):await this.index.add(n,t)}return await this.documentTerms.delete(e),await this.documentLengths.delete(e),!0}async query(e,t={scored:!0,requireAll:!1}){this._ensureOpen();const n=ye(e);if(0===n.length)return[];const r=n.map(e=>de(e)),i=[...new Set(r)];if(t.requireAll){const e=[];for(const n of i){const t=await this.index.search(n);e.push(new Set(Object.keys(t||{})))}if(0===e.length)return[];const t=new Set(e[0]);for(let n=1;n<e.length;n++)for(const r of[...t])e[n].has(r)||t.delete(r);return Array.from(t)}const s=await this.documentLengths.toArray(),o=new Map(s.map(({key:e,value:t})=>[String(e),t||1])),a=s.length,l=new Map;for(const h of i){const e=await this.index.search(h),t=e?Object.keys(e).length:0;t>0&&l.set(h,Math.log(a/t))}const c=new Map;for(const h of i){const e=await this.index.search(h);if(e)for(const[t,n]of Object.entries(e)){const e=n/(o.get(t)||1),r=l.get(h)||0,i=c.get(t)||0;c.set(t,i+e*r)}}for(const[h,f]of c.entries()){const e=await this.documentTerms.search(h)||{},t=i.filter(t=>!!e[t]).length/i.length;c.set(h,f*(1+t))}const u=Array.from(c.entries()).map(([e,t])=>({id:e,score:t})).sort((e,t)=>t.score-e.score);return!1===t.scored?u.map(e=>e.id):u}async getTermCount(){this._ensureOpen();return(await this.index.toArray()).length}async getDocumentCount(){this._ensureOpen();return(await this.documentTerms.toArray()).length}async clear(){this._ensureOpen();const[e,t,n]=await Promise.all([this.index.toArray(),this.documentTerms.toArray(),this.documentLengths.toArray()]);for(const r of e)await this.index.delete(r.key);for(const r of t)await this.documentTerms.delete(r.key);for(const r of n)await this.documentLengths.delete(r.key)}async compact(e=`${this.baseFilename}-compact-${Date.now()}`){if(this._ensureOpen(),!e)throw new Error("Destination base filename is required for compaction");const t=`${e}-terms.bjson`,n=`${e}-documents.bjson`,r=`${e}-lengths.bjson`,i=await Promise.all([this.index.compact(t),this.documentTerms.compact(n),this.documentLengths.compact(r)]),s=this.index.order,o=this.documentTerms.order,a=this.documentLengths.order;return await this.close(),this.baseFilename=e,this.index=new ge(t,s),this.documentTerms=new ge(n,o),this.documentLengths=new ge(r,a),await this.open(),{terms:i[0],documents:i[1],lengths:i[2]}}}function be(e,t){if(null==e)return e;if("boolean"==typeof e||"number"==typeof e)return e;if("string"==typeof e)return e.startsWith("$$")?"$$KEEP"===e||"$$PRUNE"===e||"$$DESCEND"===e?e:N(t,e.substring(2)):"$"===e.charAt(0)?N(t,e.substring(1)):e;if("object"==typeof e){if(Array.isArray(e))return e.map(e=>be(e,t));const n=Object.keys(e);if(0===n.length)return e;const r=n[0];if("$"===r.charAt(0)){return function(e,t,n){switch(e){case"$add":return function(e,t){if(!Array.isArray(e))return null;let n=0;for(const r of e){const e=be(r,t);e instanceof Date?n+=e.getTime():"number"==typeof e&&(n+=e)}return n}(t,n);case"$subtract":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=be(e[0],t),r=be(e[1],t);if(n instanceof Date&&r instanceof Date)return n.getTime()-r.getTime();if(n instanceof Date&&"number"==typeof r)return new Date(n.getTime()-r);if("number"==typeof n&&"number"==typeof r)return n-r;return null}(t,n);case"$multiply":return function(e,t){if(!Array.isArray(e))return null;let n=1;for(const r of e){const e=be(r,t);"number"==typeof e&&(n*=e)}return n}(t,n);case"$divide":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=be(e[0],t),r=be(e[1],t);if("number"==typeof n&&"number"==typeof r&&0!==r)return n/r;return null}(t,n);case"$mod":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=be(e[0],t),r=be(e[1],t);if("number"==typeof n&&"number"==typeof r&&0!==r)return n%r;return null}(t,n);case"$pow":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=be(e[0],t),r=be(e[1],t);if("number"==typeof n&&"number"==typeof r)return Math.pow(n,r);return null}(t,n);case"$sqrt":return function(e,t){const n=be(e,t);if("number"==typeof n&&n>=0)return Math.sqrt(n);return null}(t,n);case"$abs":return function(e,t){const n=be(e,t);if("number"==typeof n)return Math.abs(n);return null}(t,n);case"$ceil":return function(e,t){const n=be(e,t);if("number"==typeof n)return Math.ceil(n);return null}(t,n);case"$floor":return function(e,t){const n=be(e,t);if("number"==typeof n)return Math.floor(n);return null}(t,n);case"$trunc":return function(e,t){const n=be(e,t);if("number"==typeof n)return Math.trunc(n);return null}(t,n);case"$round":return function(e,t){const n=be(Array.isArray(e)?e[0]:e,t),r=Array.isArray(e)&&void 0!==e[1]?be(e[1],t):0;if("number"==typeof n&&"number"==typeof r){const e=Math.pow(10,r);return Math.round(n*e)/e}return null}(t,n);case"$concat":return function(e,t){if(!Array.isArray(e))return null;let n="";for(const r of e){const e=be(r,t);null!=e&&(n+=String(e))}return n}(t,n);case"$substr":return function(e,t){if(!Array.isArray(e)||e.length<3)return null;const n=String(be(e[0],t)||""),r=be(e[1],t),i=be(e[2],t);if("number"==typeof r&&"number"==typeof i)return n.substr(r,i);return null}(t,n);case"$toLower":return function(e,t){const n=be(e,t);return null!=n?String(n).toLowerCase():""}(t,n);case"$toUpper":return function(e,t){const n=be(e,t);return null!=n?String(n).toUpperCase():""}(t,n);case"$trim":return function(e,t){const n=be("object"==typeof e&&e.input?e.input:e,t),r=e.chars?be(e.chars,t):null;let i=null!=n?String(n):"";if(r){const e=new RegExp(`^[${xe(r)}]+|[${xe(r)}]+$`,"g");return i.replace(e,"")}return i.trim()}(t,n);case"$ltrim":return function(e,t){const n=be("object"==typeof e&&e.input?e.input:e,t),r=e.chars?be(e.chars,t):null;let i=null!=n?String(n):"";if(r){const e=new RegExp(`^[${xe(r)}]+`,"g");return i.replace(e,"")}return i.replace(/^\s+/,"")}(t,n);case"$rtrim":return function(e,t){const n=be("object"==typeof e&&e.input?e.input:e,t),r=e.chars?be(e.chars,t):null;let i=null!=n?String(n):"";if(r){const e=new RegExp(`[${xe(r)}]+$`,"g");return i.replace(e,"")}return i.replace(/\s+$/,"")}(t,n);case"$split":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=String(be(e[0],t)||""),r=String(be(e[1],t)||"");return n.split(r)}(t,n);case"$strLenCP":return function(e,t){const n=be(e,t);return null!=n?String(n).length:0}(t,n);case"$strcasecmp":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=String(be(e[0],t)||"").toLowerCase(),r=String(be(e[1],t)||"").toLowerCase();return n<r?-1:n>r?1:0}(t,n);case"$indexOfCP":return function(e,t){if(!Array.isArray(e)||e.length<2)return null;const n=String(be(e[0],t)||""),r=String(be(e[1],t)||""),i=void 0!==e[2]?be(e[2],t):0,s=void 0!==e[3]?be(e[3],t):n.length,o=n.substring(i,s).indexOf(r);return-1===o?-1:o+i}(t,n);case"$replaceOne":return function(e,t){const n=String(be(e.input,t)||""),r=String(be(e.find,t)||""),i=String(be(e.replacement,t)||"");return n.replace(r,i)}(t,n);case"$replaceAll":return function(e,t){const n=String(be(e.input,t)||""),r=String(be(e.find,t)||""),i=String(be(e.replacement,t)||"");return n.split(r).join(i)}(t,n);case"$cmp":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=be(e[0],t),r=be(e[1],t);return n<r?-1:n>r?1:0}(t,n);case"$eq":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=be(e[0],t),r=be(e[1],t);return n===r}(t,n);case"$ne":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=be(e[0],t),r=be(e[1],t);return n!==r}(t,n);case"$gt":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=be(e[0],t),r=be(e[1],t);return n>r}(t,n);case"$gte":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=be(e[0],t),r=be(e[1],t);return n>=r}(t,n);case"$lt":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=be(e[0],t),r=be(e[1],t);return n<r}(t,n);case"$lte":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=be(e[0],t),r=be(e[1],t);return n<=r}(t,n);case"$and":return function(e,t){if(!Array.isArray(e))return null;for(const n of e){if(!be(n,t))return!1}return!0}(t,n);case"$or":return function(e,t){if(!Array.isArray(e))return null;for(const n of e){if(be(n,t))return!0}return!1}(t,n);case"$not":return function(e,t){const n=be(Array.isArray(e)?e[0]:e,t);return!n}(t,n);case"$cond":return function(e,t){let n,r,i;if(Array.isArray(e)){if(3!==e.length)return null;[n,r,i]=e}else{if("object"!=typeof e)return null;n=e.if,r=e.then,i=e.else}const s=be(n,t);return be(s?r:i,t)}(t,n);case"$ifNull":return function(e,t){if(!Array.isArray(e)||e.length<2)return null;for(let n=0;n<e.length;n++){const r=be(e[n],t);if(null!=r)return r}return null}(t,n);case"$switch":return function(e,t){if("object"!=typeof e||!Array.isArray(e.branches))return null;for(const n of e.branches){if(be(n.case,t))return be(n.then,t)}return void 0!==e.default?be(e.default,t):null}(t,n);case"$year":return function(e,t){const n=be(e,t);if(n instanceof Date)return n.getUTCFullYear();return null}(t,n);case"$month":return function(e,t){const n=be(e,t);if(n instanceof Date)return n.getUTCMonth()+1;return null}(t,n);case"$dayOfMonth":return function(e,t){const n=be(e,t);if(n instanceof Date)return n.getUTCDate();return null}(t,n);case"$dayOfWeek":return function(e,t){const n=be(e,t);if(n instanceof Date)return n.getUTCDay()+1;return null}(t,n);case"$dayOfYear":return function(e,t){const n=be(e,t);if(n instanceof Date){const e=new Date(Date.UTC(n.getUTCFullYear(),0,0)),t=n-e,r=864e5;return Math.floor(t/r)}return null}(t,n);case"$hour":return function(e,t){const n=be(e,t);if(n instanceof Date)return n.getUTCHours();return null}(t,n);case"$minute":return function(e,t){const n=be(e,t);if(n instanceof Date)return n.getUTCMinutes();return null}(t,n);case"$second":return function(e,t){const n=be(e,t);if(n instanceof Date)return n.getUTCSeconds();return null}(t,n);case"$millisecond":return function(e,t){const n=be(e,t);if(n instanceof Date)return n.getUTCMilliseconds();return null}(t,n);case"$week":return function(e,t){const n=be(e,t);if(n instanceof Date){const e=new Date(Date.UTC(n.getUTCFullYear(),0,1));return Math.ceil(((n-e)/864e5+e.getUTCDay()+1)/7)-1}return null}(t,n);case"$isoWeek":return function(e,t){const n=be(e,t);if(n instanceof Date){const e=new Date(n.valueOf()),t=(n.getUTCDay()+6)%7;e.setUTCDate(e.getUTCDate()-t+3);const r=e.valueOf();return e.setUTCMonth(0,1),4!==e.getUTCDay()&&e.setUTCMonth(0,1+(4-e.getUTCDay()+7)%7),1+Math.ceil((r-e)/6048e5)}return null}(t,n);case"$isoWeekYear":return function(e,t){const n=be(e,t);if(n instanceof Date){const e=new Date(n.valueOf());return e.setUTCDate(e.getUTCDate()-(n.getUTCDay()+6)%7+3),e.getUTCFullYear()}return null}(t,n);case"$dateToString":return function(e,t){const n=e.format?be(e.format,t):"%Y-%m-%dT%H:%M:%S.%LZ",r=be(e.date,t);return r instanceof Date?n.replace("%Y",r.getUTCFullYear()).replace("%m",String(r.getUTCMonth()+1).padStart(2,"0")).replace("%d",String(r.getUTCDate()).padStart(2,"0")).replace("%H",String(r.getUTCHours()).padStart(2,"0")).replace("%M",String(r.getUTCMinutes()).padStart(2,"0")).replace("%S",String(r.getUTCSeconds()).padStart(2,"0")).replace("%L",String(r.getUTCMilliseconds()).padStart(3,"0")):null}(t,n);case"$toDate":return function(e,t){const n=be(e,t);if(n instanceof Date)return n;if("string"==typeof n||"number"==typeof n){const e=new Date(n);return isNaN(e.getTime())?null:e}return null}(t,n);case"$arrayElemAt":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=be(e[0],t),r=be(e[1],t);if(!Array.isArray(n)||"number"!=typeof r)return null;const i=r<0?n.length+r:r;return n[i]}(t,n);case"$concatArrays":return function(e,t){if(!Array.isArray(e))return null;const n=[];for(const r of e){const e=be(r,t);Array.isArray(e)&&n.push(...e)}return n}(t,n);case"$filter":return function(e,t){const n=be(e.input,t),r=e.as||"this",i=e.cond;return Array.isArray(n)?n.filter(e=>{const n={...t,[r]:e};return be(i,n)}):null}(t,n);case"$in":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=be(e[0],t),r=be(e[1],t);return!!Array.isArray(r)&&r.includes(n)}(t,n);case"$indexOfArray":return function(e,t){if(!Array.isArray(e)||e.length<2)return null;const n=be(e[0],t),r=be(e[1],t),i=void 0!==e[2]?be(e[2],t):0,s=void 0!==e[3]?be(e[3],t):n.length;if(!Array.isArray(n))return null;for(let o=i;o<s&&o<n.length;o++)if(n[o]===r)return o;return-1}(t,n);case"$isArray":return function(e,t){const n=be(e,t);return Array.isArray(n)}(t,n);case"$map":return function(e,t){const n=be(e.input,t),r=e.as||"this",i=e.in;return Array.isArray(n)?n.map(e=>{const n={...t,[r]:e};return be(i,n)}):null}(t,n);case"$reduce":return function(e,t){const n=be(e.input,t),r=be(e.initialValue,t),i=e.in;if(!Array.isArray(n))return null;let s=r;for(const o of n){s=be(i,{...t,value:s,this:o})}return s}(t,n);case"$size":return function(e,t){const n=be(e,t);return Array.isArray(n)?n.length:null}(t,n);case"$slice":return function(e,t){if(!Array.isArray(e)||e.length<2)return null;const n=be(e[0],t);if(!Array.isArray(n))return null;if(2===e.length){const r=be(e[1],t);return r>=0?n.slice(0,r):n.slice(r)}{const r=be(e[1],t),i=be(e[2],t);return n.slice(r,r+i)}}(t,n);case"$reverseArray":return function(e,t){const n=be(e,t);return Array.isArray(n)?n.slice().reverse():null}(t,n);case"$zip":return function(e,t){const n=e.inputs?be(e.inputs,t):null,r=e.useLongestLength||!1,i=e.defaults;if(!Array.isArray(n))return null;const s=n.map(e=>be(e,t));if(!s.every(e=>Array.isArray(e)))return null;const o=Math.max(...s.map(e=>e.length)),a=r?o:Math.min(...s.map(e=>e.length)),l=[];for(let c=0;c<a;c++){const e=[];for(let t=0;t<s.length;t++)c<s[t].length?e.push(s[t][c]):i&&t<i.length?e.push(i[t]):e.push(null);l.push(e)}return l}(t,n);case"$type":return function(e,t){const n=be(e,t);return null===n?"null":void 0===n?"missing":"boolean"==typeof n?"bool":"number"==typeof n?Number.isInteger(n)?"int":"double":"string"==typeof n?"string":n instanceof Date?"date":Array.isArray(n)?"array":"object"==typeof n?"object":"unknown"}(t,n);case"$convert":return function(e,t){const n=be(e.input,t),r=e.to,i=e.onError,s=e.onNull;if(null===n)return void 0!==s?be(s,t):null;try{switch(r){case"double":case"decimal":return parseFloat(n);case"int":case"long":return parseInt(n);case"bool":return Boolean(n);case"string":return String(n);case"date":return new Date(n);default:return n}}catch(o){return void 0!==i?be(i,t):null}}(t,n);case"$toBool":return function(e,t){const n=be(e,t);return Boolean(n)}(t,n);case"$toDecimal":return function(e,t){const n=be(e,t);return parseFloat(n)}(t,n);case"$toDouble":return function(e,t){const n=be(e,t);return parseFloat(n)}(t,n);case"$toInt":return function(e,t){const n=be(e,t);return parseInt(n)}(t,n);case"$toLong":return function(e,t){const n=be(e,t);return parseInt(n)}(t,n);case"$toString":return function(e,t){const n=be(e,t);return null==n?null:String(n)}(t,n);case"$objectToArray":return function(e,t){const n=be(e,t);if("object"!=typeof n||null===n||Array.isArray(n))return null;return Object.keys(n).map(e=>({k:e,v:n[e]}))}(t,n);case"$arrayToObject":return function(e,t){const n=be(e,t);if(!Array.isArray(n))return null;const r={};for(const i of n)Array.isArray(i)&&2===i.length?r[i[0]]=i[1]:"object"==typeof i&&void 0!==i.k&&void 0!==i.v&&(r[i.k]=i.v);return r}(t,n);case"$mergeObjects":return function(e,t){if(!Array.isArray(e))return be(e,t);const n={};for(const r of e){const e=be(r,t);"object"!=typeof e||null===e||Array.isArray(e)||Object.assign(n,e)}return n}(t,n);case"$literal":return t;default:throw new Error(`Unsupported aggregation operator: ${e}`)}}(r,e[r],t)}{const r={};for(const i of n)r[i]=be(e[i],t);return r}}return e}function xe(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}const _e={1:"double",2:"string",3:"object",4:"array",5:"binData",6:"undefined",7:"objectId",8:"bool",9:"date",10:"null",11:"regex",13:"javascript",15:"javascriptWithScope",16:"int",17:"timestamp",18:"long",19:"decimal",127:"maxKey","-1":"minKey"},ve=Object.entries(_e).reduce((e,[t,n])=>(e[n]=parseInt(t),e),{});function Ne(e,t){if(E(t)){for(let n=0;n<t.length;n++)if(Ne(e,t[n]))return!0;return!1}const n="number"==typeof t?t:ve[t],r=_e[n]||t;return null===e?"null"===r||10===n:void 0===e?"undefined"===r||6===n:"number"==typeof e?Number.isInteger(e)?"int"===r||16===n:"double"===r||1===n:"string"==typeof e?"string"===r||2===n:"boolean"==typeof e?"bool"===r||8===n:e instanceof Date?"date"===r||9===n:e instanceof m?"objectId"===r||7===n:e instanceof RegExp?"regex"===r||11===n:E(e)?"array"===r||4===n:"object"==typeof e?"object"===r||3===n:typeof e===t}function $e(e){if(E(e)){let t=0;for(let n=0;n<e.length;n++)t|=1<<e[n];return t}return"number"==typeof e?e:0}function Oe(e,t){if("number"!=typeof e)return!1;const n=$e(t);return(e&n)===n}function Ee(e,t){if("number"!=typeof e)return!1;return 0===(e&$e(t))}function Ae(e,t){if("number"!=typeof e)return!1;return 0!==(e&$e(t))}function Ie(e,t){if("number"!=typeof e)return!1;const n=$e(t);return(e&n)!==n}function Se(e,t){if(t.type){const n=E(e)?"array":null===e?"null":typeof e;if(t.type!==n)return!1}if(t.required&&E(t.required))for(let n=0;n<t.required.length;n++)if(!(t.required[n]in e))return!1;if(t.properties)for(const n in t.properties){if(!(n in e))return!1;const r=t.properties[n];if(!Se(e[n],r))return!1}if(void 0!==t.minimum&&"number"==typeof e&&e<t.minimum)return!1;if(void 0!==t.maximum&&"number"==typeof e&&e>t.maximum)return!1;if(void 0!==t.minLength&&"string"==typeof e&&e.length<t.minLength)return!1;if(void 0!==t.maxLength&&"string"==typeof e&&e.length>t.maxLength)return!1;if(t.pattern&&"string"==typeof e){if(!new RegExp(t.pattern).test(e))return!1}return!(t.enum&&E(t.enum)&&!t.enum.includes(e))}function Ce(e,t){return e instanceof m&&t instanceof m?e.equals(t):e==t}function De(e,t,n){let r=e,i=t;switch(e instanceof m&&(r=e.toString()),t instanceof m&&(i=t.toString()),n){case">":return r>i;case">=":return r>=i;case"<":return r<i;case"<=":return r<=i;default:return!1}}function Te(e,t){if(void 0===e)return!1;if(null===e)return t(e);if(E(e)){for(var n=0;n<e.length;n++)if(t(e[n]))return!0;return!1}return t(e)}function Le(e){if("string"!=typeof e)return[];return ye(e).map(e=>de(e))}function je(e,t){if("string"!=typeof e)return!1;const n=new Set(Le(e));return Le(t).some(e=>n.has(e))}function Me(e,t){try{if(!Array.isArray(t)||2!==t.length)return!1;const n=t[0][0],r=t[0][1],i=t[1][0];return ke(e,n,i,t[1][1],r)}catch(n){return!1}}function ke(e,t,n,r,i){if(!e)return!1;if("FeatureCollection"===e.type&&e.features&&e.features.length>0){for(const s of e.features)if(s.geometry&&!ke(s.geometry,t,n,r,i))return!1;return!0}if("Feature"===e.type&&e.geometry)return ke(e.geometry,t,n,r,i);if("Point"===e.type&&e.coordinates){const[s,o]=e.coordinates;if("number"==typeof s&&"number"==typeof o)return s>=t&&s<=n&&o>=r&&o<=i}if("Polygon"===e.type&&e.coordinates&&e.coordinates.length>0){for(const s of e.coordinates)for(const e of s){const s=e[0],o=e[1];if(s<t||s>n||o<r||o>i)return!1}return!0}return!1}function Fe(e){if(!e)return null;if("FeatureCollection"===e.type&&e.features&&e.features.length>0){const t=e.features[0];if(t.geometry)return Fe(t.geometry)}if("Feature"===e.type&&e.geometry)return Fe(e.geometry);if("Point"===e.type&&e.coordinates){const[t,n]=e.coordinates;if("number"==typeof t&&"number"==typeof n)return{lat:n,lng:t}}if("Polygon"===e.type&&e.coordinates&&e.coordinates.length>0){const t=e.coordinates[0];if(t.length>0){let e=0,n=0;for(const r of t)n+=r[0],e+=r[1];return{lat:e/t.length,lng:n/t.length}}}return null}function Pe(e,t,n,r){const i=(n-e)*Math.PI/180,s=(r-t)*Math.PI/180,o=Math.sin(i/2)*Math.sin(i/2)+Math.cos(e*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin(s/2)*Math.sin(s/2);return 6371*(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)))}function Ue(e,t,n,r){const i=Fe(e);if(!i)return!1;return 1e3*Pe(i.lat,i.lng,n,t)<=r}function Re(e,t){if(!e||!t)return!1;const n=Fe(t);if(!n)return!1;const r=Fe(e);if(!r)return!1;if("Polygon"===t.type&&"Point"===e.type)return Be(r.lng,r.lat,t.coordinates[0]);if("Polygon"===e.type&&"Point"===t.type){const n=t.coordinates;return Be(n[0],n[1],e.coordinates[0])}if("Point"===e.type&&"Point"===t.type){return Pe(r.lat,r.lng,n.lat,n.lng)<.001}return!1}function Be(e,t,n){let r=!1;for(let i=0,s=n.length-1;i<n.length;s=i++){const o=n[i][0],a=n[i][1],l=n[s][0],c=n[s][1];a>t!=c>t&&e<(l-o)*(t-a)/(c-a)+o&&(r=!r)}return r}function ze(e,t){if("function"==typeof t)try{return t.call(e)}catch(n){return!1}else if("string"==typeof t)try{return new Function("return "+t).call(e)}catch(n){return!1}return!1}function qe(e,t){var n=Object.keys(t)[0],r=t[n];if("$"!=n.charAt(0))return Ve(e,n,r);if("$and"==n)return We(e,r);if("$or"==n)return function(e,t){for(var n=0;n<t.length;n++)if(qe(e,t[n]))return!0;return!1}(e,r);if("$not"==n)return function(e,t){return!qe(e,t)}(e,r);if("$nor"==n)return function(e,t){for(var n=0;n<t.length;n++)if(qe(e,t[n]))return!1;return!0}(e,r);if("$where"==n)return ze(e,r);if("$comment"==n)return!0;if("$jsonSchema"==n)return Se(e,r);if("$text"==n){return function(e,t){return!(!e||"object"!=typeof e)&&function e(n){if("string"==typeof n)return je(n,t);if("object"!=typeof n||null===n)return!1;if(E(n)){for(let t=0;t<n.length;t++)if(e(n[t]))return!0;return!1}for(const t in n)if(n.hasOwnProperty(t)&&e(n[t]))return!0;return!1}(e)}(e,r.$search||r)}if("$expr"!=n)throw{$err:"Can't canonicalize query: BadValue unknown top level operator: "+n,code:17287};try{return be(r,e)}catch(i){return!1}}function Ve(e,t,n){var r=$(e,t);if("string"==typeof n)return Te(r,function(e){return Ce(e,n)});if("number"==typeof n)return Te(r,function(e){return Ce(e,n)});if("boolean"==typeof n)return Te(r,function(e){return Ce(e,n)});if(n instanceof m)return Te(r,function(e){return Ce(e,n)});if("object"==typeof n){if(n instanceof RegExp)return null!=r&&Te(r,function(e){return e&&e.match(n)});if(E(n))return null!=r&&Te(r,function(e){return e&&S(e,n)});var i=Object.keys(n);if("$"==i[0].charAt(0)){for(var s=0;s<i.length;s++){var o=Object.keys(n)[s],a=n[o];if("$eq"==o){if(!Te(r,function(e){return Ce(e,a)}))return!1}else if("$gt"==o){if(!Te(r,function(e){return De(e,a,">")}))return!1}else if("$gte"==o){if(!Te(r,function(e){return De(e,a,">=")}))return!1}else if("$lt"==o){if(!Te(r,function(e){return De(e,a,"<")}))return!1}else if("$lte"==o){if(!Te(r,function(e){return De(e,a,"<=")}))return!1}else if("$ne"==o){if(!Te(r,function(e){return!Ce(e,a)}))return!1}else if("$in"==o){if(!Te(r,function(e){return I(e,a)}))return!1}else if("$nin"==o){if(Te(r,function(e){return I(e,a)}))return!1}else if("$exists"==o){var l=N(e,t);if(a?null==l:null!=l)return!1}else if("$type"==o){if(void 0===r){if(6!==("number"==typeof a?a:ve[a]))return!1}else if(!Ne(r,a))return!1}else if("$mod"==o){if(2!=a.length)throw{$err:"Can't canonicalize query: BadValue malformed mod, not enough elements",code:17287};if(!Te(r,function(e){return null!=e&&e%a[0]==a[1]}))return!1}else if("$regex"==o){var c=a,u=n.$options||"",h="string"==typeof c?new RegExp(c,u):c;if(!Te(r,function(e){return null!=e&&h.test(e)}))return!1}else{if("$options"==o)continue;if("$text"==o){if(!Te(r,function(e){return null!=e&&je(e,a)}))return!1}else if("$expr"==o)try{if(!be(a,e))return!1}catch(O){return!1}else if("$geoWithin"==o){if(!Te(r,function(e){return null!=e&&Me(e,a)}))return!1}else if("$near"==o||"$nearSphere"==o){let e;if(a.$geometry?e=a.$geometry.coordinates:a.coordinates?e=a.coordinates:Array.isArray(a)&&(e=a),!(e&&e.length>=2))return!1;{const[t,n]=e,i=a.$maxDistance||1e6;if(!Te(r,function(e){return null!=e&&Ue(e,t,n,i)}))return!1}}else if("$geoIntersects"==o){const e=a.$geometry||a;if(!Te(r,function(t){return null!=t&&Re(t,e)}))return!1}else if("$not"==o){if(Ve(e,t,a))return!1}else if("$all"==o){if(null==(d=N(e,t))||!E(d))return!1;for(var f=0;f<a.length;f++)if(!I(a[f],d))return!1}else if("$elemMatch"==o){var d;if(null==(d=N(e,t))||!E(d))return!1;var p=!1;for(f=0;f<d.length;f++){var g=d[f];if("object"!=typeof g||E(g)){for(var y=!0,w=Object.keys(a),b=0;b<w.length;b++){var x=w[b],_=a[x];("$gte"!=x||g>=_)&&("$gt"!=x||g>_)&&("$lte"!=x||g<=_)&&("$lt"!=x||g<_)?"$eq"==x&&g!=_||"$ne"==x&&g==_?y=!1:"$in"!=x||I(g,_)?"$nin"==x&&I(g,_)&&(y=!1):y=!1:y=!1}if(y){p=!0;break}}else if(He(g,a)){p=!0;break}}if(!p)return!1}else if("$size"==o){var v=N(e,t);if(null==v||!E(v))return!1;if(v.length!=a)return!1}else if("$bitsAllSet"==o){if(!Te(r,function(e){return Oe(e,a)}))return!1}else if("$bitsAllClear"==o){if(!Te(r,function(e){return Ee(e,a)}))return!1}else if("$bitsAnySet"==o){if(!Te(r,function(e){return Ae(e,a)}))return!1}else{if("$bitsAnyClear"!=o)throw{$err:"Can't canonicalize query: BadValue unknown operator: "+o,code:17287};if(!Te(r,function(e){return Ie(e,a)}))return!1}}}return!0}return N(e,t)&&C(N(e,t),n)}}function We(e,t){for(var n=0;n<t.length;n++)if(!qe(e,t[n]))return!1;return!0}function He(e,t){return We(e,A(t))}function Ke(e,t){const n={};return{matched:Qe(e,A(t),n),arrayFilters:n}}function Qe(e,t,n){for(var r=0;r<t.length;r++)if(!Je(e,t[r],n))return!1;return!0}function Je(e,t,n){var r=Object.keys(t)[0],i=t[r];if("$"!=r.charAt(0))return function(e,t,n,r){const i=t.split(".")[0],s=$(e,t),o=(n,s)=>{if(void 0===n)return!1;if(null===n)return s(n);if(E(n)){if(E(N(e,i))){for(var o=0;o<n.length;o++)if(s(n[o]))return r[t]=o,!0;return!1}}return Te(n,s)};if("string"==typeof n)return o(s,function(e){return Ce(e,n)});if("number"==typeof n)return o(s,function(e){return Ce(e,n)});if("boolean"==typeof n)return o(s,function(e){return Ce(e,n)});if(n instanceof m)return o(s,function(e){return Ce(e,n)});if("object"==typeof n){if(n instanceof RegExp)return null!=s&&o(s,function(e){return e&&e.match(n)});if(E(n))return null!=s&&o(s,function(e){return e&&S(e,n)});var a=Object.keys(n);if("$"==a[0].charAt(0)){for(var l=0;l<a.length;l++){var c=a[l],u=n[c];if("$eq"==c){if(!o(s,function(e){return Ce(e,u)}))return!1}else if("$gt"==c){if(!o(s,function(e){return De(e,u,">")}))return!1}else if("$gte"==c){if(!o(s,function(e){return De(e,u,">=")}))return!1}else if("$lt"==c){if(!o(s,function(e){return De(e,u,"<")}))return!1}else if("$lte"==c){if(!o(s,function(e){return De(e,u,"<=")}))return!1}else if("$ne"==c){if(!o(s,function(e){return!Ce(e,u)}))return!1}else if("$in"==c){if(!o(s,function(e){return I(e,u)}))return!1}else if("$nin"==c){if(o(s,function(e){return I(e,u)}))return!1}else{if("$elemMatch"==c){var h=N(e,t);if(null==h||!E(h))return!1;for(var f=0;f<h.length;f++){var d=h[f];if("object"!=typeof d||E(d)){for(var p=!0,g=Object.keys(u),y=0;y<g.length;y++){var w=g[y],b=u[w];("$gte"!=w||d>=b)&&("$gt"!=w||d>b)&&("$lte"!=w||d<=b)&&("$lt"!=w||d<b)?("$eq"==w&&d!=b||"$ne"==w&&d==b)&&(p=!1):p=!1}if(p)return r[t]=f,!0}else if(He(d,u))return r[t]=f,!0}return!1}if(!Ve(e,t,n))return!1}}return!0}return null!=s&&o(s,function(e){return C(e,n)})}return!1}(e,r,i,n);if("$and"==r)return Qe(e,i,n);if("$or"==r)return function(e,t,n){for(var r=0;r<t.length;r++)if(Je(e,t[r],n))return!0;return!1}(e,i,n);if("$not"==r)return!qe(e,i);if("$nor"==r)return function(e,t,n){for(var r=0;r<t.length;r++)if(Je(e,t[r],n))return!1;return!0}(e,i,n);if("$where"==r)return ze(e,i);if("$comment"==r)return!0;if("$jsonSchema"==r)return Se(e,i);if("$expr"!=r)throw{$err:"Can't canonicalize query: BadValue unknown top level operator: "+r,code:17287};try{return be(i,e)}catch(s){return!1}}function Ye(e){return e.split(".").map(e=>{const t=function(e){const t=e.match(/^\$\[([^\]]+)\]$/);return t?t[1]:null}(e);return{segment:e,isFilteredPositional:null!==t,identifier:t}})}function Xe(e,t,n,r,i){!function e(s,o,a){if(o>=t.length)return;const l=t[o],c=o===t.length-1;if(l.isFilteredPositional){const a=l.identifier,u=i?i.find(e=>Object.keys(e).some(e=>e.startsWith(a+".")||e===a)):null;if(!i){if(!s[l.segment]){const e=t[o+1];e&&e.isFilteredPositional?s[l.segment]=[]:s[l.segment]={}}return void(c?Ge(s,l.segment,n,r):e(s[l.segment],o+1))}if(!E(s))return s[l.segment]||(s[l.segment]={}),void(c?Ge(s,l.segment,n,r):e(s[l.segment],o+1));for(let t=0;t<s.length;t++){const i=s[t];let l=!0;if(u){let e={},t=!1;if(Object.keys(u).forEach(n=>{if(n.startsWith(a+".")){const t=n.substring(a.length+1);e[t]=u[n]}else n===a&&(e=u[n],t=!0)}),t){l=He({value:i},{value:e})}else l=He(i,e)}l&&(c?Ge(s,t,n,r):null!=i&&e(s[t],o+1))}}else{if((void 0===s[l.segment]||null===s[l.segment])&&!c){const e=t[o+1];e&&e.isFilteredPositional?s[l.segment]=[]:s[l.segment]={}}c?Ge(s,l.segment,n,r):void 0!==s[l.segment]&&null!==s[l.segment]&&e(s[l.segment],o+1)}}(e,0)}function Ge(e,t,n,r){switch(r){case"$set":default:e[t]=n;break;case"$inc":void 0===e[t]&&(e[t]=0),e[t]+=n;break;case"$mul":e[t]=e[t]*n;break;case"$min":e[t]=Math.min(e[t],n);break;case"$max":e[t]=Math.max(e[t],n);break;case"$unset":delete e[t]}}function Ze(e){return/\$\[[^\]]+\]/.test(e)}function et(e){return-1!==e.indexOf("$[]")}function tt(e,t,n){for(var r=t.split("."),i=e,s=0;s<r.length;s++){var o=r[s];if("$[]"===o){if(!Array.isArray(i))return;for(var a=r.slice(s+1).join("."),l=0;l<i.length;l++)if(a)if(-1!==a.indexOf("$[]"))tt(i[l],a,n);else{var c=n(N(i[l],a));O(i[l],a,c)}else i[l]=n(i[l]);return}if(null==i||null==i)return;i=i[o]}}function nt(e,t){if(!t||!e.includes("$"))return e;const n=e.split("."),r=n.indexOf("$");if(-1===r)return e;const i=n.slice(0,r).join(".");let s=null;for(const o in t)if(o===i||o.startsWith(i+".")){s=t[o];break}return null!=s?(n[r]=s.toString(),n.join(".")):e}function rt(e,t,n,r,i){for(var s=Object.keys(e),o=0;o<s.length;o++){var a=s[o],l=e[a];if("$inc"==a)for(var c=Object.keys(l),u=0;u<c.length;u++){var h=nt(c[u],r),f=l[c[u]];if(Ze(h)){if(!i)throw new Error("arrayFilters option is required when using filtered positional operator $[<identifier>]");Xe(t,Ye(h),f,"$inc",i)}else if(et(h))tt(t,h,function(e){return(void 0===e?0:e)+f});else{null==(d=N(t,h))&&(d=0),O(t,h,d+f)}}else if("$mul"==a)for(c=Object.keys(l),u=0;u<c.length;u++){h=nt(c[u],r),f=l[c[u]];if(Ze(h)){if(!i)throw new Error("arrayFilters option is required when using filtered positional operator $[<identifier>]");Xe(t,Ye(h),f,"$mul",i)}else if(et(h))tt(t,h,function(e){return e*f});else{null==(d=N(t,h))&&(d=0),O(t,h,d*f)}}else if("$rename"==a)for(c=Object.keys(l),u=0;u<c.length;u++){h=nt(c[u],r);t[nt(l[c[u]],r)]=t[h],delete t[h]}else if("$setOnInsert"==a&&n)for(c=Object.keys(l),u=0;u<c.length;u++){t[h=nt(c[u],r)]=l[c[u]]}else if("$set"==a)for(c=Object.keys(l),u=0;u<c.length;u++){if(Ze(h=nt(c[u],r))){if(!i)throw new Error("arrayFilters option is required when using filtered positional operator $[<identifier>]");Xe(t,Ye(h),l[c[u]],"$set",i)}else O(t,h,l[c[u]])}else if("$unset"==a)for(c=Object.keys(l),u=0;u<c.length;u++){delete t[h=nt(c[u],r)]}else if("$min"==a)for(c=Object.keys(l),u=0;u<c.length;u++){h=nt(c[u],r),f=l[c[u]];if(Ze(h)){if(!i)throw new Error("arrayFilters option is required when using filtered positional operator $[<identifier>]");Xe(t,Ye(h),f,"$min",i)}else if(et(h))tt(t,h,function(e){return Math.min(e,f)});else{var d=N(t,h);O(t,h,Math.min(d,f))}}else if("$max"==a)for(c=Object.keys(l),u=0;u<c.length;u++){h=nt(c[u],r),f=l[c[u]];if(Ze(h)){if(!i)throw new Error("arrayFilters option is required when using filtered positional operator $[<identifier>]");Xe(t,Ye(h),f,"$max",i)}else if(et(h))tt(t,h,function(e){return Math.max(e,f)});else{d=N(t,h);O(t,h,Math.max(d,f))}}else if("$currentDate"==a)for(c=Object.keys(l),u=0;u<c.length;u++){h=nt(c[u],r);var p=l[c[u]];!0===p||"object"==typeof p&&p.$type,O(t,h,new Date)}else if("$addToSet"==a)for(c=Object.keys(l),u=0;u<c.length;u++){h=nt(c[u],r);var g=l[c[u]];(j=N(t,h))&&Array.isArray(j)&&j.push(g)}else if("$pop"==a)for(c=Object.keys(l),u=0;u<c.length;u++){h=nt(c[u],r);var m=l[c[u]];(j=N(t,h))&&Array.isArray(j)&&(1==m?j.pop():-1==m&&j.shift())}else if("$pull"==a)for(c=Object.keys(l),u=0;u<c.length;u++){h=nt(c[u],r);var y=l[c[u]];if(null!=(v=N(t,h))&&Array.isArray(v)){for(var w=[],b=0;b<v.length;b++){var x=v[b],_=!1;if("object"!=typeof y||null===y||Array.isArray(y))_=x==y;else if("object"!=typeof x||null===x||Array.isArray(x))_=Ve({__temp:x},"__temp",y);else _=He(x,y);_||w.push(x)}O(t,h,w)}}else if("$pullAll"==a)for(c=Object.keys(l),u=0;u<c.length;u++){var v=N(t,h=nt(c[u],r)),$=l[c[u]];for(w=[],b=0;b<v.length;b++){for(var E=!1,A=0;A<$.length;A++)if(v[b]==$[A]){E=!0;break}E||w.push(v[b])}O(t,h,w)}else if("$pushAll"==a)for(c=Object.keys(l),u=0;u<c.length;u++){h=nt(c[u],r);var I=l[c[u]];if((j=N(t,h))&&Array.isArray(j))for(b=0;b<I.length;b++)j.push(I[b])}else if("$push"==a)for(c=Object.keys(l),u=0;u<c.length;u++){h=nt(c[u],r);var S=l[c[u]];if(null!==S&&"object"==typeof S&&(void 0!==S.$each||void 0!==S.$position||void 0!==S.$slice||void 0!==S.$sort)){(j=N(t,h))||O(t,h,j=[]);var C=void 0!==S.$each?S.$each:[S],D=void 0!==S.$position?S.$position:j.length;if(D<0&&(D=Math.max(0,j.length+D)),j.splice(D,0,...C),void 0!==S.$sort){var T=S.$sort;"number"==typeof T?j.sort(function(e,t){return e<t?T>0?-1:1:e>t?T>0?1:-1:0}):"object"==typeof T&&j.sort(function(e,t){for(var n=Object.keys(T),r=0;r<n.length;r++){var i=n[r],s=T[i],o=N(e,i),a=N(t,i);if(o<a)return s>0?-1:1;if(o>a)return s>0?1:-1}return 0})}if(void 0!==S.$slice){var L=S.$slice;if(L<0)O(t,h,j.slice(L));else if(0===L)O(t,h,[]);else{O(t,h,j.slice(0,L))}}}else{var j;(j=N(t,h))&&Array.isArray(j)&&j.push(S)}}else{if("$bit"!=a)throw"unknown update operator: "+a;h=nt((c=Object.keys(l))[0],r);var M=l[c[0]],k=Object.keys(M)[0],F=M[k];d=N(t,h);if("and"==k)O(t,h,d&F);else if("or"==k)O(t,h,d|F);else{if("xor"!=k)throw"unknown $bit operator: "+k;O(t,h,d^F)}}}}function it(e,t,n){for(var r={_id:n},i=!0,s=Object.keys(t),o=0;o<s.length;o++)if("$"==s[o].charAt(0)){i=!1;break}if(i)for(o=0;o<s.length;o++)r[s[o]]=t[s[o]];else{var a=Object.keys(e);for(o=0;o<a.length;o++)r[a[o]]=e[a[o]];rt(t,r,!0)}return r}class st{constructor(e,t,n,r={}){this.name=e,this.keys=t,this.storage=n,this.options=r}add(e){throw new Error("add() must be implemented by subclass")}remove(e){throw new Error("remove() must be implemented by subclass")}update(e,t){this.remove(e),this.add(t)}query(e){throw new Error("query() must be implemented by subclass")}clear(){throw new Error("clear() must be implemented by subclass")}getSpec(){return{name:this.name,key:this.keys}}}class ot extends st{constructor(e,t,n,r={}){super(e,t,n,r),this.data=new ge(n,50),this.isOpen=!1}async open(){if(!this.isOpen)try{await this.data.open(),this.isOpen=!0}catch(e){if(!e.message||!(e.message.includes("Unknown type byte")||e.message.includes("Failed to read metadata")||e.message.includes("Invalid tree file")))throw e;if("undefined"!=typeof navigator&&navigator.storage){const e=await navigator.storage.getDirectory();try{await e.removeEntry(this.storage)}catch(t){}}this.data=new ge(this.storage,50),await this.data.open(),this.isOpen=!0}}async close(){if(this.isOpen){try{await this.data.close()}catch(e){if(!e.message||!e.message.includes("File is not open"))throw e}this.isOpen=!1}}extractIndexKey(e){const t=Object.keys(this.keys);if(0===t.length)return null;if(1===t.length){const n=N(e,t[0]);return void 0===n?null:n}const n=[];for(let r=0;r<t.length;r++){const i=N(e,t[r]);if(void 0===i)return null;n.push(i)}return n.join("\0")}async add(e){this.isOpen||await this.open();const t=this.extractIndexKey(e);if(null!==t){const n=e._id.toString(),r=await this.data.search(t);let i;if(Array.isArray(r)){if(r.includes(n))return;i=[...r,n]}else i=r?r===n?[r]:[r,n]:[n];await this.data.add(t,i)}}async remove(e){this.isOpen||await this.open();const t=this.extractIndexKey(e);if(null!==t){const n=e._id.toString(),r=await this.data.search(t);if(Array.isArray(r)){const e=r.filter(e=>e!==n);e.length>0?await this.data.add(t,e):await this.data.delete(t)}else r===n&&await this.data.delete(t)}}async query(e){const t=Object.keys(e),n=Object.keys(this.keys);if(1!==n.length)return null;const r=n[0];if(-1===t.indexOf(r))return null;const i=e[r];if("object"!=typeof i||null===i){const e=i;return await this.data.search(e)||[]}return"object"!=typeof i||Array.isArray(i)?null:await this._queryWithOperators(r,i)}async _queryWithOperators(e,t){const n=Object.keys(t),r=new Set;if(n.some(e=>["$gt","$gte","$lt","$lte"].includes(e))){const e=n.includes("$gt")||n.includes("$gte"),i=n.includes("$lt")||n.includes("$lte");if(e&&i){const e=n.includes("$gte")?t.$gte:n.includes("$gt")?t.$gt:-1/0,i=n.includes("$lte")?t.$lte:n.includes("$lt")?t.$lt:1/0,s=await this.data.rangeSearch(e,i);for(const o of s){const e=o.key,i=o.value;let s=!0;!n.includes("$gt")||e>t.$gt||(s=!1),!n.includes("$gte")||e>=t.$gte||(s=!1),!n.includes("$lt")||e<t.$lt||(s=!1),!n.includes("$lte")||e<=t.$lte||(s=!1),s&&i&&(Array.isArray(i)?i.forEach(e=>r.add(e)):r.add(i))}return Array.from(r)}{const e=await this.data.toArray();for(const i of e){const e=i.key,s=i.value;let o=!0;for(const r of n){const n=t[r];("$gt"!==r||e>n)&&("$gte"!==r||e>=n)&&("$lt"!==r||e<n)&&("$lte"!==r||e<=n)?("$eq"===r&&e!==n||"$ne"===r&&e===n)&&(o=!1):o=!1}o&&s&&(Array.isArray(s)?s.forEach(e=>r.add(e)):r.add(s))}return Array.from(r)}}if(n.includes("$in")){const e=t.$in;if(Array.isArray(e)){for(const t of e){const e=await this.data.search(t);e&&(Array.isArray(e)?e.forEach(e=>r.add(e)):r.add(e))}return Array.from(r)}}if(n.includes("$eq")){const e=t.$eq,n=await this.data.search(e);return n?Array.isArray(n)?n:[n]:[]}if(n.includes("$ne")){const e=t.$ne,n=await this.data.toArray();for(const t of n)t.key!==e&&t.value&&(Array.isArray(t.value)?t.value.forEach(e=>r.add(e)):r.add(t.value));return Array.from(r)}return null}async clear(){this.isOpen&&await this.close(),this.data=new ge(this.data.filename,50),await this.open()}}class at extends st{constructor(e,t,n,r={}){super(e,t,n),this.textIndex=new we({baseFilename:n}),this.isOpen=!1,this.indexedFields=[];for(const i in t)"text"===t[i]&&this.indexedFields.push(i);if(0===this.indexedFields.length)throw new Error('Text index must have at least one field with type "text"')}async open(){if(!this.isOpen)try{await this.textIndex.open(),this.isOpen=!0}catch(e){if(!("ENOENT"===e.code||e.message&&(e.message.includes("Failed to read metadata")||e.message.includes("missing required fields")||e.message.includes("Unknown type byte")||e.message.includes("Invalid")||e.message.includes("file too small"))))throw e;await this._deleteIndexFiles(),await this._ensureDirectoryForFile(this.storage+"-terms.bjson"),this.textIndex=new we({baseFilename:this.storage}),await this.textIndex.open(),this.isOpen=!0}}async _deleteIndexFiles(){const e=["-terms.bjson","-documents.bjson","-lengths.bjson"];for(const t of e)await this._deleteFile(this.storage+t)}async _deleteFile(e){if(e)try{const t=e.split("/").filter(Boolean),n=t.pop();let r=await globalThis.navigator.storage.getDirectory();for(const e of t)r=await r.getDirectoryHandle(e,{create:!1});await r.removeEntry(n)}catch(t){}}async _ensureDirectoryForFile(e){if(!e)return;const t=e.split("/").filter(Boolean);if(t.pop(),0!==t.length)try{let e=await globalThis.navigator.storage.getDirectory();for(const n of t)e=await e.getDirectoryHandle(n,{create:!0})}catch(n){if("EEXIST"!==n.code)throw n}}async close(){if(this.isOpen){try{await this.textIndex.close()}catch(e){if(!e.message||!e.message.includes("File is not open"))throw e}this.isOpen=!1}}_extractText(e){const t=[];for(const n of this.indexedFields){const r=N(e,n);null!=r&&t.push(String(r))}return t.join(" ")}async add(e){if(!e._id)throw new Error("Document must have an _id field");const t=this._extractText(e);t&&await this.textIndex.add(String(e._id),t)}async remove(e){e._id&&await this.textIndex.remove(String(e._id))}query(e){return null}async search(e,t={}){return await this.textIndex.query(e,{scored:!1,...t})}async clear(){this.isOpen&&await this.close(),this.textIndex=new we({baseFilename:this.storage}),await this.open()}getSpec(){return{name:this.name,key:this.keys,textIndexVersion:3,weights:this._getWeights()}}_getWeights(){const e={};for(const t of this.indexedFields)e[t]=1;return e}}function lt(e,t,n,r){const i=(n-e)*Math.PI/180,s=(r-t)*Math.PI/180,o=Math.sin(i/2)*Math.sin(i/2)+Math.cos(e*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin(s/2)*Math.sin(s/2);return 6371*(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)))}function ct(e,t){return!(e.maxLat<t.minLat||e.minLat>t.maxLat||e.maxLng<t.minLng||e.minLng>t.maxLng)}function ut(e){return(e.maxLat-e.minLat)*(e.maxLng-e.minLng)}function ht(e,t){return{minLat:Math.min(e.minLat,t.minLat),maxLat:Math.max(e.maxLat,t.maxLat),minLng:Math.min(e.minLng,t.minLng),maxLng:Math.max(e.maxLng,t.maxLng)}}function ft(e,t){return ut(ht(e,t))-ut(e)}class dt{constructor(e,t){this.rtree=e,this.id=t.id,this.isLeaf=t.isLeaf,this.children=t.children||[],this.bbox=t.bbox}updateBBox(){if(0===this.children.length)return void(this.bbox=null);let e=1/0,t=-1/0,n=1/0,r=-1/0;for(const i of this.children){let s;if(this.isLeaf)s=i.bbox;else{s=this.rtree._loadNode(i).bbox}s&&(e=Math.min(e,s.minLat),t=Math.max(t,s.maxLat),n=Math.min(n,s.minLng),r=Math.max(r,s.maxLng))}this.bbox={minLat:e,maxLat:t,minLng:n,maxLng:r},this.rtree._saveNode(this)}toJSON(){return{id:this.id,isLeaf:this.isLeaf,children:this.children,bbox:this.bbox}}}class pt{constructor(e,t=9){this.filename=e,this.maxEntries=t,this.minEntries=Math.max(2,Math.ceil(t/2)),this.rootPointer=null,this.nextId=1,this._size=0,this.file=new x(e),this.isOpen=!1}async open(){if(this.isOpen)throw new Error("R-tree file is already open");await this.file.exists()?(await this.file.open("rw"),this._loadFromFile()):(await this.file.open("rw"),this._initializeNewTree()),this.isOpen=!0}async close(){this.isOpen&&(this._writeMetadata(),await this.file.close(),this.isOpen=!1)}_initializeNewTree(){const e=new dt(this,{id:0,isLeaf:!0,children:[],bbox:null});this.nextId=1,this._size=0,this.rootPointer=this._saveNode(e),this._writeMetadata()}_writeMetadata(){const e={version:1,maxEntries:this.maxEntries,minEntries:this.minEntries,size:this._size,rootPointer:this.rootPointer,nextId:this.nextId};this.file.append(e)}_loadFromFile(){const e=this.file.getFileSize();if(e<135)throw new Error("Invalid R-tree file format: file too small for metadata");const t=e-135,n=this.file.read(t);this.maxEntries=n.maxEntries,this.minEntries=n.minEntries,this._size=n.size,this.rootPointer=n.rootPointer,this.nextId=n.nextId}_saveNode(e){const t=e.toJSON(),n=this.file.getFileSize();return this.file.append(t),new y(n)}_loadNode(e){if(!(e instanceof y))throw new Error("Expected Pointer object");const t=e.valueOf(),n=this.file.read(t);return new dt(this,n)}_loadRoot(){return this._loadNode(this.rootPointer)}insert(e,t,n){if(!this.isOpen)throw new Error("R-tree file must be opened before use");if(!(n instanceof m))throw new Error("objectId must be an instance of ObjectId to insert into rtree");const r={bbox:{minLat:e,maxLat:e,minLng:t,maxLng:t},lat:e,lng:t,objectId:n},i=this._loadRoot(),s=this._insert(r,i,1);if(s.split){const e=new dt(this,{id:this.nextId++,isLeaf:!1,children:s.pointers,bbox:null});e.updateBBox(),this.rootPointer=this._saveNode(e)}else this.rootPointer=s.pointer;this._size++,this._writeMetadata()}_insert(e,t,n){if(t.isLeaf){if(t.children.push(e),t.updateBBox(),t.children.length>this.maxEntries){const[e,n]=this._split(t);return{split:!0,pointers:[e,n]}}return{split:!1,pointer:this._saveNode(t)}}{const r=this._chooseSubtree(e.bbox,t),i=this._loadNode(r),s=this._insert(e,i,n+1);if(s.split){let e=-1;for(let n=0;n<t.children.length;n++)if(t.children[n].valueOf()===r.valueOf()){e=n;break}if(-1!==e?(t.children[e]=s.pointers[0],t.children.push(s.pointers[1])):(t.children.push(s.pointers[0]),t.children.push(s.pointers[1])),t.updateBBox(),t.children.length>this.maxEntries){const[e,n]=this._split(t);return{split:!0,pointers:[e,n]}}}else{let e=-1;for(let n=0;n<t.children.length;n++)if(t.children[n].valueOf()===r.valueOf()){e=n;break}-1!==e&&(t.children[e]=s.pointer),t.updateBBox()}return{split:!1,pointer:this._saveNode(t)}}}_chooseSubtree(e,t){let n=1/0,r=1/0,i=null;for(const s of t.children){if(!(s instanceof y))throw new Error("Expected Pointer in _chooseSubtree, got: "+typeof s);const t=this._loadNode(s),o=ft(t.bbox,e),a=ut(t.bbox);(o<n||o===n&&a<r)&&(n=o,r=a,i=s)}return i}_split(e){const t=e.children,n=e.isLeaf;let r=-1/0,i=0,s=1;for(let l=0;l<t.length;l++)for(let e=l+1;e<t.length;e++){let o,a;if(n)o=t[l].bbox,a=t[e].bbox;else{const n=this._loadNode(t[l]),r=this._loadNode(t[e]);o=n.bbox,a=r.bbox}const c=ut(ht(o,a));c>r&&(r=c,i=l,s=e)}const o=new dt(this,{id:this.nextId++,isLeaf:n,children:[t[i]],bbox:null}),a=new dt(this,{id:this.nextId++,isLeaf:n,children:[t[s]],bbox:null});for(let l=0;l<t.length;l++){if(l===i||l===s)continue;const e=t[l];let r;if(n)r=e.bbox;else{r=this._loadNode(e).bbox}o.updateBBox(),a.updateBBox();const c=o.bbox?ft(o.bbox,r):0,u=a.bbox?ft(a.bbox,r):0;c<u?o.children.push(e):u<c?a.children.push(e):o.children.length<=a.children.length?o.children.push(e):a.children.push(e)}o.updateBBox(),a.updateBBox();return[this._saveNode(o),this._saveNode(a)]}searchBBox(e){if(!this.isOpen)throw new Error("R-tree file must be opened before use");const t=[],n=this._loadRoot();return this._searchBBox(e,n,t),t}_searchBBox(e,t,n){if(t.bbox&&ct(e,t.bbox))if(t.isLeaf)for(const r of t.children)ct(e,r.bbox)&&n.push({objectId:r.objectId,lat:r.lat,lng:r.lng});else for(const r of t.children){const t=this._loadNode(r);this._searchBBox(e,t,n)}}searchRadius(e,t,n){const r=function(e,t,n){const r=n/111,i=n/(111*Math.cos(e*Math.PI/180));return{minLat:e-r,maxLat:e+r,minLng:t-i,maxLng:t+i}}(e,t,n),i=this._loadRoot(),s=[];this._searchBBoxEntries(r,i,s);const o=[];for(const a of s){const r=lt(e,t,a.lat,a.lng);r<=n&&o.push({objectId:a.objectId,lat:a.lat,lng:a.lng,distance:r})}return o}_searchBBoxEntries(e,t,n){if(t.bbox&&ct(e,t.bbox))if(t.isLeaf)for(const r of t.children)ct(e,r.bbox)&&n.push(r);else for(const r of t.children){const t=this._loadNode(r);this._searchBBoxEntries(e,t,n)}}remove(e){if(!this.isOpen)throw new Error("R-tree file must be opened before use");if(!(e instanceof m))throw new Error("objectId must be an instance of ObjectId to remove from rtree");const t=this._loadRoot(),n=this._remove(e,t);if(!n.found)return!1;if(n.underflow&&n.children)if(0===n.children.length){const e=new dt(this,{id:this.nextId++,isLeaf:!0,children:[],bbox:null});this.rootPointer=this._saveNode(e)}else if(1!==n.children.length||n.isLeaf){const e=new dt(this,{id:t.id,isLeaf:n.isLeaf,children:n.children,bbox:null});e.updateBBox(),this.rootPointer=this._saveNode(e)}else this.rootPointer=n.children[0];else n.pointer&&(this.rootPointer=n.pointer);return this._size--,this._writeMetadata(),!0}_remove(e,t){if(t.isLeaf){const n=t.children.length;if(t.children=t.children.filter(t=>!t.objectId.equals(e)),t.children.length===n)return{found:!1};t.updateBBox();const r=this._saveNode(t);return{found:!0,underflow:t.children.length<this.minEntries&&t.children.length>0,pointer:r,children:t.children,isLeaf:!0}}{let n=[...t.children];for(let r=0;r<n.length;r++){const i=n[r],s=this._loadNode(i),o=this._remove(e,s);if(o.found){if(o.underflow){const e=this._handleUnderflow(t,r,s,o);e.merged?n=e.children:n[r]=o.pointer}else n[r]=o.pointer;const e=new dt(this,{id:t.id,isLeaf:!1,children:n,bbox:null});e.updateBBox();const i=this._saveNode(e);return{found:!0,underflow:n.length<this.minEntries&&n.length>0,pointer:i,children:n,isLeaf:!1}}}return{found:!1}}}_handleUnderflow(e,t,n,r){const i=[];if(t>0){const n=e.children[t-1],r=this._loadNode(n);i.push({index:t-1,node:r,pointer:n})}if(t<e.children.length-1){const n=e.children[t+1],r=this._loadNode(n);i.push({index:t+1,node:r,pointer:n})}for(const s of i)if(s.node.children.length>this.minEntries){const i=[...r.children,...s.node.children],o=Math.ceil(i.length/2),a=i.slice(0,o),l=i.slice(o),c=new dt(this,{id:n.id,isLeaf:r.isLeaf,children:a,bbox:null});c.updateBBox();const u=new dt(this,{id:s.node.id,isLeaf:s.node.isLeaf,children:l,bbox:null});u.updateBBox();const h=this._saveNode(c),f=this._saveNode(u),d=[...e.children],p=Math.min(t,s.index),g=Math.max(t,s.index);return d[p]=h,d[g]=f,{merged:!0,children:d}}if(i.length>0){const n=i[0],s=[...r.children,...n.node.children],o=new dt(this,{id:this.nextId++,isLeaf:r.isLeaf,children:s,bbox:null});o.updateBBox();const a=this._saveNode(o),l=e.children.filter((e,r)=>r!==t&&r!==n.index);return l.push(a),{merged:!0,children:l}}return{merged:!1}}size(){return this._size}async clear(){await this.close();const e=new x(this.filename);await e.delete(),this.file=new x(this.filename),await this.open()}async compact(e){if(!this.isOpen)throw new Error("R-tree file must be opened before use");if(!e)throw new Error("Destination filename is required for compaction");this._writeMetadata();const t=this.file.getFileSize(),n=new pt(e,this.maxEntries);n.minEntries=this.minEntries,n.nextId=this.nextId,n._size=this._size,await n.file.open("rw"),n.isOpen=!0;const r=new Map,i=e=>{const t=e.valueOf();if(r.has(t))return r.get(t);const s=this._loadNode(e),o=[];if(s.isLeaf)for(const n of s.children)o.push(n);else for(const n of s.children){const e=i(n);o.push(e)}const a=new dt(n,{id:s.id,isLeaf:s.isLeaf,children:o,bbox:s.bbox}),l=n._saveNode(a);return r.set(t,l),l},s=i(this.rootPointer);n.rootPointer=s,n._writeMetadata(),await n.file.close(),n.isOpen=!1;const o=new x(e);await o.open("r");const a=o.getFileSize();return await o.close(),{oldSize:t,newSize:a,bytesSaved:Math.max(0,t-a),newFilename:e}}}class gt extends st{constructor(e,t,n,r={}){super(e,t,n,r),this.geoField=Object.keys(t)[0],this.rtree=new pt(n,9),this.isOpen=!1}async open(){if(!this.isOpen)try{await this.rtree.open(),this.isOpen=!0}catch(e){if(!("ENOENT"===e.code||e.message&&(e.message.includes("Invalid R-tree")||e.message.includes("file too small")||e.message.includes("Failed to read metadata")||e.message.includes("Unknown type byte"))))throw e;this.rtree=new pt(this.storage,9),await this.rtree.open(),this.isOpen=!0}}async close(){if(this.isOpen){try{await this.rtree.close()}catch(e){if(!e.message||!e.message.includes("File is not open"))throw e}this.isOpen=!1}}_extractCoordinates(e){if(!e)return null;if("FeatureCollection"===e.type&&e.features&&e.features.length>0){const t=e.features[0];if(t.geometry)return this._extractCoordinates(t.geometry)}if("Feature"===e.type&&e.geometry)return this._extractCoordinates(e.geometry);if("Point"===e.type&&e.coordinates){const[t,n]=e.coordinates;if("number"==typeof t&&"number"==typeof n)return{lat:n,lng:t}}if("Polygon"===e.type&&e.coordinates&&e.coordinates.length>0){const t=e.coordinates[0];if(t.length>0){let e=0,n=0;for(const r of t)n+=r[0],e+=r[1];return{lat:e/t.length,lng:n/t.length}}}return null}async add(e){if(!e._id)throw new Error("Document must have an _id field");const t=N(e,this.geoField),n=this._extractCoordinates(t);n&&await this.rtree.insert(n.lat,n.lng,e._id)}async remove(e){if(e._id){if(!(e._id instanceof m))throw console.error(e),new Error("Document _id must be an ObjectId to remove from geospatial index");await this.rtree.remove(e._id)}}async query(e){if(this.isOpen||await this.open(),!e[this.geoField])return null;const t=e[this.geoField];if(t.$geoWithin){const e=t.$geoWithin;if(Array.isArray(e)&&2===e.length){const t=e[0][0],n=e[0][1],r=e[1][0],i=e[1][1];return(await this.rtree.searchBBox({minLat:i,maxLat:n,minLng:t,maxLng:r})).map(e=>e.objectId.toString())}}if(t.$near){const e=t.$near;let n;if(e.$geometry)n=e.$geometry.coordinates;else if(e.coordinates)n=e.coordinates;else{if(!Array.isArray(e))return null;n=e}if(!n||n.length<2)return null;const[r,i]=n,s=(e.$maxDistance||1e6)/1e3,o=await this.rtree.searchRadius(i,r,s);return o.sort((e,t)=>e.distance-t.distance),o.map(e=>e.objectId.toString())}if(t.$nearSphere){const e=t.$nearSphere;let n;if(e.$geometry)n=e.$geometry.coordinates;else if(e.coordinates)n=e.coordinates;else{if(!Array.isArray(e))return null;n=e}if(!n||n.length<2)return null;const[r,i]=n,s=(e.$maxDistance||1e6)/1e3,o=await this.rtree.searchRadius(i,r,s);return o.sort((e,t)=>e.distance-t.distance),o.map(e=>e.objectId.toString())}if(t.$geoIntersects){const e=t.$geoIntersects;let n;if(!e.$geometry)return null;if(n=e.$geometry,!n||!n.type)return null;if("Point"===n.type){const[e,t]=n.coordinates,r=1e-4;return(await this.rtree.searchBBox({minLat:t-r,maxLat:t+r,minLng:e-r,maxLng:e+r})).map(e=>e.objectId.toString())}if("Polygon"===n.type){const e=n.coordinates;if(!e||0===e.length)return null;const t=e[0];if(!t||t.length<3)return null;let r=1/0,i=-1/0,s=1/0,o=-1/0;for(const n of t){const[e,t]=n;r=Math.min(r,t),i=Math.max(i,t),s=Math.min(s,e),o=Math.max(o,e)}return(await this.rtree.searchBBox({minLat:r,maxLat:i,minLng:s,maxLng:o})).filter(e=>this._pointInPolygon(e.lat,e.lng,t)).map(e=>e.objectId.toString())}return null}return null}_pointInPolygon(e,t,n){let r=!1;for(let i=0,s=n.length-1;i<n.length;s=i++){const[o,a]=n[i],[l,c]=n[s];a>e!=c>e&&t<(l-o)*(e-a)/(c-a)+o&&(r=!r)}return r}async clear(){await this.close();try{await this.rtree.file.delete()}catch(e){if(!e||"NotFoundError"!==e.name)throw e}this.rtree=new pt(this.rtree.filename,9),await this.open()}getSpec(){return{name:this.name,key:this.keys,"2dsphereIndexVersion":3}}}class mt{constructor(){this.type="full_scan",this.indexes=[],this.indexScans=[],this.estimatedCost=1/0,this.indexOnly=!1}}class yt{constructor(e){this.indexes=e}plan(e){const t=new mt;if(!e||0===Object.keys(e).length)return t;const n=this._analyzeQuery(e);if(n.hasTextSearch){const t=this._planTextSearch(e,n);if(t)return t}if(n.hasGeoQuery){const t=this._planGeoQuery(e,n);if(t)return t}if("and"===n.type){const t=this._planAndQuery(e,n);if("full_scan"!==t.type)return t}if("or"===n.type){const t=this._planOrQuery(e,n);if("full_scan"!==t.type)return t}const r=this._planSimpleQuery(e);return"full_scan"!==r.type?r:t}_analyzeQuery(e){const t={type:"simple",fields:[],operators:{},hasTextSearch:!1,hasGeoQuery:!1,conditions:[]},n=Object.keys(e);if(1===n.length){const r=n[0];if("$and"===r){t.type="and",t.conditions=e.$and;for(const e of t.conditions){const n=this._analyzeQuery(e);t.fields.push(...n.fields),n.hasTextSearch&&(t.hasTextSearch=!0),n.hasGeoQuery&&(t.hasGeoQuery=!0)}return t}if("$or"===r){t.type="or",t.conditions=e.$or;for(const e of t.conditions){const n=this._analyzeQuery(e);t.fields.push(...n.fields),n.hasTextSearch&&(t.hasTextSearch=!0),n.hasGeoQuery&&(t.hasGeoQuery=!0)}return t}}for(const r of n){if(r.startsWith("$"))continue;t.fields.push(r);const n=e[r];if("object"==typeof n&&null!==n&&!Array.isArray(n)){const e=Object.keys(n);t.operators[r]=e,e.includes("$text")&&(t.hasTextSearch=!0),e.some(e=>["$geoWithin","$geoIntersects","$near","$nearSphere"].includes(e))&&(t.hasGeoQuery=!0)}}return n.length>1&&(t.type="and"),t}_planTextSearch(e,t){for(const[n,r]of this.indexes)if(r instanceof at){const t=this._extractTextQuery(e);if(t){const e=new mt;return e.type="index_scan",e.indexes=[n],e.indexScans=[{indexName:n,index:r,textQuery:t}],e.estimatedCost=100,e.indexOnly=!0,e}}return null}_extractTextQuery(e){for(const t in e){const n=e[t];if("object"==typeof n&&null!==n&&n.$text)return"string"==typeof n.$text?n.$text:n.$text.$search}return null}_planGeoQuery(e,t){for(const[n,r]of this.indexes)if(r instanceof gt){const t=new mt;return t.type="index_scan",t.indexes=[n],t.indexScans=[{indexName:n,index:r,query:e}],t.estimatedCost=100,t.indexOnly=!0,t}return null}_planAndQuery(e,t){const n=new mt;let r;r=e.$and?e.$and:Object.keys(e).map(t=>({[t]:e[t]}));const i=[];for(const s of r){const e=this._planSimpleQuery(s);"index_scan"===e.type&&i.push(e.indexScans[0])}return i.length>1?(n.type="index_intersection",n.indexScans=i,n.indexes=i.map(e=>e.indexName),n.estimatedCost=50,n):1===i.length?(n.type="index_scan",n.indexScans=[i[0]],n.indexes=[i[0].indexName],n.estimatedCost=50,n):n}_planOrQuery(e,t){const n=new mt;if(!e.$or)return n;const r=e.$or,i=[];for(const s of r){const e=this._planSimpleQuery(s);"index_scan"===e.type&&i.push(e.indexScans[0])}return i.length>0?(n.type="index_union",n.indexScans=i,n.indexes=i.map(e=>e.indexName),n.estimatedCost=100*i.length,n):n}_planSimpleQuery(e){const t=new mt;if(0===Object.keys(e).length)return t;for(const[n,r]of this.indexes)if(!(r instanceof at||r instanceof gt)&&this._canIndexHandleQuery(r,e))return t.type="index_scan",t.indexes=[n],t.indexScans=[{indexName:n,index:r,query:e}],t.estimatedCost=50,t;return t}async _executeIndexScan(e){const{index:t,query:n,textQuery:r}=e;if("function"!=typeof t.open||void 0===t.isOpen||t.isOpen||await t.open(),void 0!==r)return await t.search(r);if(void 0!==n){const e=await t.query(n);return null!==e?e:[]}return void 0!==e.docIds?e.docIds:[]}_canIndexHandleQuery(e,t){const n=Object.keys(t),r=Object.keys(e.keys);if(1!==r.length)return!1;const i=r[0];return-1!==n.indexOf(i)}async execute(e){if("full_scan"===e.type)return null;if("index_scan"===e.type){const t=e.indexScans[0];return await this._executeIndexScan(t)}if("index_intersection"===e.type){if(0===e.indexScans.length)return null;const t=[];for(const i of e.indexScans)t.push({docIds:await this._executeIndexScan(i),indexName:i.indexName});const n=t.slice().sort((e,t)=>e.docIds.length-t.docIds.length);let r=new Set(n[0].docIds);for(let e=1;e<n.length;e++){const t=new Set(n[e].docIds);if(r=new Set([...r].filter(e=>t.has(e))),0===r.size)break}return Array.from(r)}if("index_union"===e.type){const t=new Set;for(const n of e.indexScans){(await this._executeIndexScan(n)).forEach(e=>t.add(e))}return Array.from(t)}return null}}class wt extends r.EventEmitter{constructor(e,t=[],n={}){super(),this.target=e,this.pipeline=t,this.options=n,this.closed=!1,this._listeners=new Map,this._changeCounter=0,this._startWatching()}_startWatching(){if(this.closed)return;const e=this._getCollectionsToWatch();for(const t of e)this._watchCollection(t);"DB"===this.target.constructor.name&&this._interceptDBCollectionCreation(),"MongoClient"===this.target.constructor.name&&this._interceptClientDBCreation()}_getCollectionsToWatch(){const e=[];if("MongoClient"===this.target.constructor.name)return this._monitorClient(),e;if("DB"===this.target.constructor.name){const t=this.target.getCollectionNames();for(const n of t){const t=this.target[n];t&&t.isCollection&&e.push(t)}this._monitorDB()}return this.target.isCollection&&e.push(this.target),e}_watchCollection(e){if(this.closed)return;if(!e)return;if("function"!=typeof e.on)return;if(!e.isCollection)return;if(this._listeners.has(e))return;const t={insert:t=>this._emitChange("insert",e,t),update:(t,n)=>this._emitChange("update",e,t,n),replace:t=>this._emitChange("replace",e,t),delete:t=>this._emitChange("delete",e,t)};this._listeners.set(e,t),e.on("insert",t.insert),e.on("update",t.update),e.on("replace",t.replace),e.on("delete",t.delete)}_emitChange(e,t,n,r=null){if(this.closed)return;const i=this._createChangeEvent(e,t,n,r);this._matchesPipeline(i)&&this.emit("change",i)}_createChangeEvent(e,t,n,r){const i={_id:{_data:Buffer.from(String(++this._changeCounter)).toString("base64")},operationType:e,clusterTime:new Date,ns:{db:t.db.dbName,coll:t.name},documentKey:{_id:n._id}};switch(e){case"insert":case"replace":i.fullDocument=n;break;case"update":i.updateDescription=r||{updatedFields:{},removedFields:[],truncatedArrays:[]},"updateLookup"===this.options.fullDocument&&(i.fullDocument=n)}return i}_matchesPipeline(e){if(!this.pipeline||0===this.pipeline.length)return!0;for(const t of this.pipeline)if(t.$match&&!He(e,t.$match))return!1;return!0}_getNestedValue(e,t){return t.split(".").reduce((e,t)=>e?.[t],e)}_monitorClient(){}_interceptClientDBCreation(){const e=this.target,t=e.db.bind(e),n=this;this._watchedDBs=new Map,e.db=function(e,r){const i=t(e,r),s=i.dbName;if(!n._watchedDBs.has(s)){n._watchedDBs.set(s,i);const e=i.getCollectionNames();for(const t of e){const e=i[t];e&&e.isCollection&&!n._listeners.has(e)&&n._watchCollection(e)}n._interceptDBCollectionCreationForClient(i)}return i},this._originalClientMethods={db:t}}_interceptDBCollectionCreationForClient(e){const t=e.collection.bind(e),n=e.createCollection.bind(e),r=this;e.collection=function(e){const n=t(e);return n&&n.isCollection&&!r._listeners.has(n)&&r._watchCollection(n),n},e.createCollection=function(t){n(t);const i=e[t];i&&i.isCollection&&!r._listeners.has(i)&&r._watchCollection(i)}}_monitorDB(){}_interceptDBCollectionCreation(){const e=this.target,t=e.collection.bind(e),n=e.createCollection.bind(e),r=this;e.collection=function(e){const n=t(e);return n&&n.isCollection&&!r._listeners.has(n)&&r._watchCollection(n),n},e.createCollection=function(t){n(t);const i=e[t];i&&i.isCollection&&!r._listeners.has(i)&&r._watchCollection(i)},this._originalDBMethods={collection:t,createCollection:n}}close(){if(!this.closed){this.closed=!0;for(const[e,t]of this._listeners)e.off("insert",t.insert),e.off("update",t.update),e.off("replace",t.replace),e.off("delete",t.delete);this._listeners.clear(),this._originalDBMethods&&"DB"===this.target.constructor.name&&(this.target.collection=this._originalDBMethods.collection,this.target.createCollection=this._originalDBMethods.createCollection),this._originalClientMethods&&"MongoClient"===this.target.constructor.name&&(this.target.db=this._originalClientMethods.db),this.emit("close"),this.removeAllListeners()}}get isClosed(){return this.closed}async*[Symbol.asyncIterator](){const e=[];let t=null,n=!1;const r=n=>{t?(t({value:n,done:!1}),t=null):e.push(n)},i=()=>{n=!0,t&&(t({done:!0}),t=null)},s=e=>{t&&(t(Promise.reject(e)),t=null)};this.on("change",r),this.on("close",i),this.on("error",s);try{for(;!n;)if(e.length>0)yield e.shift();else{const e=await new Promise(e=>{t=e,n&&e({done:!0})});if(e.done)break;yield e.value}}finally{this.off("change",r),this.off("close",i),this.off("error",s)}}async next(){return new Promise((e,t)=>{const n=t=>{s(),e(t)},r=()=>{s(),e(null)},i=e=>{s(),t(e)},s=()=>{this.off("change",n),this.off("close",r),this.off("error",i)};this.closed?e(null):(this.once("change",n),this.once("close",r),this.once("error",i))})}}class bt extends r.EventEmitter{constructor(e,t,n={}){super(),this.db=e,this.name=t,this.path=`${this.db.baseFolder}/${this.db.dbName}/${this.name}`,this.documentsPath=`${this.path}/documents.bjson`,this.order=n.bPlusTreeOrder||50,this.documents=null,this.indexes=new Map,this._initialized=!1,this.isCollection=!0,this.queryPlanner=new yt(this.indexes)}async _initialize(){if(!this._initialized){if(!globalThis.navigator||!globalThis.navigator.storage||"function"!=typeof globalThis.navigator.storage.getDirectory)throw new Error("OPFS not available: navigator.storage.getDirectory is missing");await this._ensureDirectoryForFile(this.documentsPath),this.documents=new ge(this.documentsPath,this.order),await this.documents.open(),await this._loadIndexes(),this._initialized=!0}}async _ensureDirectoryForFile(e){if(!e)return;const t=e.split("/").filter(Boolean);if(t.pop(),0!==t.length)try{let e=await globalThis.navigator.storage.getDirectory();for(const n of t)e=await e.getDirectoryHandle(n,{create:!0})}catch(n){if("EEXIST"!==n.code)throw n}}async _loadIndexes(){let e;try{const t=this.path.split("/").filter(Boolean);let n=await globalThis.navigator.storage.getDirectory();for(const e of t)n=await n.getDirectoryHandle(e,{create:!1});e=n}catch(t){if("NotFoundError"===t?.name||"ENOENT"===t?.code)return;throw t}for await(const[n,r]of e.entries()){if("file"!==r.kind)continue;let e;if(n.endsWith(".textindex-documents.bjson"))e="text";else if(n.endsWith(".rtree.bjson"))e="geospatial";else{if(!n.endsWith(".bplustree.bjson"))continue;e="regular"}const i=n.replace(/\.textindex-documents\.bjson$/,"").replace(/\.rtree\.bjson$/,"").replace(/\.bplustree\.bjson$/,"");if(this.indexes.has(i))continue;const s=this._parseIndexName(i,e);if(!s)continue;let o;if("text"===e){const t=await this._getIndexPath(i,e);o=new at(i,s,t,{})}else if("geospatial"===e){const t=await this._getIndexPath(i,e);o=new gt(i,s,t,{})}else{const t=await this._getIndexPath(i,e);o=new ot(i,s,t,{})}try{await o.open(),this.indexes.set(i,o)}catch(t){console.warn(`Failed to open index ${i}:`,t)}}}_parseIndexName(e,t){const n=e.split("_");if(n.length<2||n.length%2!=0)return null;const r={};for(let i=0;i<n.length;i+=2){const e=n[i],s=n[i+1];if(!e||void 0===s)return null;if("text"===t||"text"===s)r[e]="text";else if("geospatial"===t||"2dsphere"===s||"2d"===s)r[e]="2d"===s?"2d":"2dsphere";else{const t=Number(s);if(Number.isNaN(t)||1!==t&&-1!==t)return null;r[e]=t}}return r}async close(){if(this._initialized){await this.documents.close();for(const[e,t]of this.indexes)await t.close()}}generateIndexName(e){const t=[];for(const n in e)e.hasOwnProperty(n)&&t.push(n+"_"+e[n]);return t.join("_")}isTextIndex(e){for(const t in e)if("text"===e[t])return!0;return!1}isGeospatialIndex(e){for(const t in e)if("2dsphere"===e[t]||"2d"===e[t])return!0;return!1}async _getIndexPath(e,t){const n=String(e).replace(/[^a-zA-Z0-9_-]/g,"_");return"text"===t?`${this.path}/${n}.textindex`:"geospatial"===t?`${this.path}/${n}.rtree.bjson`:`${this.path}/${n}.bplustree.bjson`}async _buildIndex(e,t,n={}){let r,i,s;this._initialized||await this._initialize(),this.isTextIndex(t)?(s="text",i=await this._getIndexPath(e,s),r=new at(e,t,i,n)):this.isGeospatialIndex(t)?(s="geospatial",i=await this._getIndexPath(e,s),r=new gt(e,t,i,n)):(s="regular",i=await this._getIndexPath(e,s),r=new ot(e,t,i,n)),await r.open(),"function"==typeof r.clear&&await r.clear();for await(const o of this.documents)o&&o.value&&await r.add(o.value);return this.indexes.set(e,r),r}async updateIndexesOnInsert(e){const t=[];for(const[n,r]of this.indexes)t.push((async()=>{await this._ensureIndexOpen(r),await r.add(e)})());t.length>0&&await Promise.all(t)}async updateIndexesOnDelete(e){const t=[];for(const[n,r]of this.indexes)t.push((async()=>{await this._ensureIndexOpen(r),await r.remove(e)})());t.length>0&&await Promise.all(t)}async _ensureIndexOpen(e){e&&"function"==typeof e.open&&!e.isOpen&&await e.open()}planQuery(e){const t=this.queryPlanner.plan(e);return{useIndex:"full_scan"!==t.type,planType:t.type,indexNames:t.indexes,docIds:null,estimatedCost:t.estimatedCost,indexOnly:t.indexOnly||!1}}async planQueryAsync(e){const t=this.queryPlanner.plan(e),n=await this.queryPlanner.execute(t);return{useIndex:"full_scan"!==t.type,planType:t.type,indexNames:t.indexes,docIds:n,estimatedCost:t.estimatedCost,indexOnly:t.indexOnly||!1}}getTextIndex(e){for(const[t,n]of this.indexes)if(n instanceof at&&n.indexedFields.includes(e))return n;return null}async aggregate(e){if(!e||!E(e))throw new F("Pipeline must be an array",{collection:this.name,code:T.FAILED_TO_PARSE});let t=[];const n=await this.find({});for(;n.hasNext();)t.push(n.next());for(let r=0;r<e.length;r++){const n=e[r],i=Object.keys(n);if(1!==i.length)throw new F("Each pipeline stage must have exactly one key",{collection:this.name,code:T.FAILED_TO_PARSE});const s=i[0],o=n[s];if("$match"===s){const e=[];for(let n=0;n<t.length;n++)He(t[n],o)&&e.push(t[n]);t=e}else if("$project"===s){const e=[];for(let n=0;n<t.length;n++)e.push(xt(o,t[n]));t=e}else if("$addFields"===s||"$set"===s){const e=[];for(let n=0;n<t.length;n++){const r=v(t[n]);for(const e in o){const i=o[e];r[e]=be(i,t[n])}e.push(r)}t=e}else if("$unset"===s){const e=[];let n=[];"string"==typeof o?n=[o]:Array.isArray(o)?n=o:"object"==typeof o&&(n=Object.keys(o));for(let r=0;r<t.length;r++){const i=v(t[r]);for(let e=0;e<n.length;e++){const t=n[e],r=t.split(".");if(1===r.length)delete i[t];else{let e=i;for(let t=0;t<r.length-1&&(null!=e&&null!=e);t++)e=e[r[t]];null!=e&&null!=e&&delete e[r[r.length-1]]}}e.push(i)}t=e}else if("$sort"===s){const e=Object.keys(o);t.sort(function(t,n){for(let r=0;r<e.length;r++){const i=e[r];if(void 0===t[i]&&void 0!==n[i])return-1*o[i];if(void 0!==t[i]&&void 0===n[i])return 1*o[i];if(t[i]<n[i])return-1*o[i];if(t[i]>n[i])return 1*o[i]}return 0})}else if("$limit"===s)t=t.slice(0,o);else if("$skip"===s)t=t.slice(o);else if("$group"===s){const e={},n=o._id;for(let i=0;i<t.length;i++){const r=t[i];let s;s=null==n?null:be(n,r);const o=JSON.stringify(s);e[o]||(e[o]={_id:s,docs:[],accumulators:{}}),e[o].docs.push(r)}const r=[];for(const t in e){const n=e[t],i={_id:n._id};for(const e in o){if("_id"===e)continue;const t=o[e],r=Object.keys(t);if(1!==r.length)continue;const s=r[0],a=t[s];if("$sum"===s){let t=0;for(let e=0;e<n.docs.length;e++){const r=be(a,n.docs[e]);"number"==typeof r?t+=r:null!=r&&(t+=Number(r)||0)}i[e]=t}else if("$avg"===s){let t=0,r=0;for(let e=0;e<n.docs.length;e++){const i=be(a,n.docs[e]);null!=i&&(t+=Number(i)||0,r++)}i[e]=r>0?t/r:0}else if("$min"===s){let t;for(let e=0;e<n.docs.length;e++){const r=be(a,n.docs[e]);void 0!==r&&(void 0===t||r<t)&&(t=r)}i[e]=t}else if("$max"===s){let t;for(let e=0;e<n.docs.length;e++){const r=be(a,n.docs[e]);void 0!==r&&(void 0===t||r>t)&&(t=r)}i[e]=t}else if("$push"===s){const t=[];for(let e=0;e<n.docs.length;e++){const r=be(a,n.docs[e]);t.push(r)}i[e]=t}else if("$addToSet"===s){const t={};for(let e=0;e<n.docs.length;e++){const r=be(a,n.docs[e]);t[JSON.stringify(r)]=r}const r=[];for(const e in t)r.push(t[e]);i[e]=r}else if("$first"===s)n.docs.length>0&&(i[e]=be(a,n.docs[0]));else if("$last"===s)n.docs.length>0&&(i[e]=be(a,n.docs[n.docs.length-1]));else if("$stdDevPop"===s){const t=[];for(let e=0;e<n.docs.length;e++){const r=be(a,n.docs[e]);"number"==typeof r&&t.push(r)}if(t.length>0){const n=t.reduce((e,t)=>e+t,0)/t.length,r=t.reduce((e,t)=>e+Math.pow(t-n,2),0)/t.length;i[e]=Math.sqrt(r)}else i[e]=0}else if("$stdDevSamp"===s){const t=[];for(let e=0;e<n.docs.length;e++){const r=be(a,n.docs[e]);"number"==typeof r&&t.push(r)}if(t.length>1){const n=t.reduce((e,t)=>e+t,0)/t.length,r=t.reduce((e,t)=>e+Math.pow(t-n,2),0)/(t.length-1);i[e]=Math.sqrt(r)}else i[e]=0}else if("$mergeObjects"===s){const t={};for(let e=0;e<n.docs.length;e++){const r=be(a,n.docs[e]);"object"!=typeof r||null===r||Array.isArray(r)||Object.assign(t,r)}i[e]=t}}r.push(i)}t=r}else if("$count"===s)t=[{[o]:t.length}];else if("$unwind"===s){const e=[];let n=o;"string"==typeof n&&"$"===n.charAt(0)&&(n=n.substring(1));for(let r=0;r<t.length;r++){const i=t[r],s=N(i,n);if(s&&E(s)&&s.length>0)for(let t=0;t<s.length;t++){const r=v(i),o=n.split(".");let a=r;for(let e=0;e<o.length-1;e++)a[o[e]]||(a[o[e]]={}),a=a[o[e]];a[o[o.length-1]]=s[t],e.push(r)}}t=e}else if("$sortByCount"===s){const e={};for(let n=0;n<t.length;n++){const r=t[n],i=be(o,r),s=JSON.stringify(i);e[s]||(e[s]={_id:i,count:0}),e[s].count++}t=Object.values(e).sort((e,t)=>t.count-e.count)}else if("$replaceRoot"===s||"$replaceWith"===s){const e=[],n="$replaceRoot"===s?o.newRoot:o;for(let r=0;r<t.length;r++){const i=be(n,t[r]);if("object"!=typeof i||null===i||Array.isArray(i))throw new F("$replaceRoot expression must evaluate to an object",{collection:this.name,code:T.FAILED_TO_PARSE});e.push(i)}t=e}else if("$sample"===s){const e=o.size||1;if("number"!=typeof e||e<0)throw new F("$sample size must be a non-negative number",{collection:this.name,code:T.FAILED_TO_PARSE});const n=[...t];for(let t=n.length-1;t>0;t--){const e=Math.floor(Math.random()*(t+1));[n[t],n[e]]=[n[e],n[t]]}t=n.slice(0,Math.min(e,n.length))}else if("$bucket"===s){if(!o.groupBy||!o.boundaries)throw new F("$bucket requires groupBy and boundaries",{collection:this.name,code:T.FAILED_TO_PARSE});const e=o.boundaries,n=o.default,r=o.output||{count:{$sum:1}},i={};for(let t=0;t<e.length-1;t++){i[JSON.stringify(e[t])]={_id:e[t],docs:[]}}void 0!==n&&(i.default={_id:n,docs:[]});for(let a=0;a<t.length;a++){const r=t[a],s=be(o.groupBy,r);let l=!1;for(let t=0;t<e.length-1;t++)if(s>=e[t]&&s<e[t+1]){i[JSON.stringify(e[t])].docs.push(r),l=!0;break}l||void 0===n||i.default.docs.push(r)}const s=[];for(const t in i){const e=i[t];if(0===e.docs.length)continue;const n={_id:e._id};for(const t in r){const i=r[t],s=Object.keys(i);if(1!==s.length)continue;const o=s[0],a=i[o];if("$sum"===o){let r=0;for(let t=0;t<e.docs.length;t++){const n=be(a,e.docs[t]);"number"==typeof n?r+=n:null!=n&&(r+=Number(n)||0)}n[t]=r}else if("$avg"===o){let r=0,i=0;for(let t=0;t<e.docs.length;t++){const n=be(a,e.docs[t]);null!=n&&(r+=Number(n)||0,i++)}n[t]=i>0?r/i:0}else if("$push"===o){const r=[];for(let t=0;t<e.docs.length;t++){const n=be(a,e.docs[t]);r.push(n)}n[t]=r}else if("$addToSet"===o){const r={};for(let t=0;t<e.docs.length;t++){const n=be(a,e.docs[t]);r[JSON.stringify(n)]=n}n[t]=Object.values(r)}}s.push(n)}t=s.sort((e,t)=>e._id<t._id?-1:e._id>t._id?1:0)}else if("$bucketAuto"===s){if(!o.groupBy||!o.buckets)throw new F("$bucketAuto requires groupBy and buckets",{collection:this.name,code:T.FAILED_TO_PARSE});const e=o.buckets,n=o.output||{count:{$sum:1}};if(0===t.length)t=[];else{const r=t.map(e=>({value:be(o.groupBy,e),doc:e})).sort((e,t)=>e.value<t.value?-1:e.value>t.value?1:0),i=Math.ceil(r.length/e),s=[];for(let t=0;t<e&&t*i<r.length;t++){const e=t*i,n=Math.min((t+1)*i,r.length),o=r.slice(e,n);if(0===o.length)continue;const a={_id:{min:o[0].value,max:(r.length,o[o.length-1].value)},docs:o.map(e=>e.doc)};s.push(a)}const a=[];for(let e=0;e<s.length;e++){const t=s[e],r={_id:t._id};for(const e in n){const i=n[e],s=Object.keys(i);if(1!==s.length)continue;const o=s[0],a=i[o];if("$sum"===o){let n=0;for(let e=0;e<t.docs.length;e++){const r=be(a,t.docs[e]);"number"==typeof r?n+=r:null!=r&&(n+=Number(r)||0)}r[e]=n}else if("$avg"===o){let n=0,i=0;for(let e=0;e<t.docs.length;e++){const r=be(a,t.docs[e]);null!=r&&(n+=Number(r)||0,i++)}r[e]=i>0?n/i:0}else if("$push"===o){const n=[];for(let e=0;e<t.docs.length;e++){const r=be(a,t.docs[e]);n.push(r)}r[e]=n}}a.push(r)}t=a}}else if("$out"===s){const e=o;if("string"!=typeof e)throw new F("$out requires a string collection name",{collection:this.name,code:T.FAILED_TO_PARSE});this.db.collections.has(e)&&await this.db.dropCollection(e);const n=this.db[e];for(let r=0;r<t.length;r++){const e=t[r],i=e._id;"object"==typeof i&&i.toString?i.toString():String(i),await n.insertOne(e)}t=[]}else if("$merge"===s){let e,n="_id",r="merge",i="insert";if("string"==typeof o?e=o:"object"==typeof o&&(e=o.into,n=o.on||n,r=o.whenMatched||r,i=o.whenNotMatched||i),!e)throw new F("$merge requires a target collection",{collection:this.name,code:T.FAILED_TO_PARSE});const s=this.db[e];for(let o=0;o<t.length;o++){const e=t[o],a="string"==typeof n?n:n[0],l=N(e,a),c=await s.find({[a]:l}),u=c.hasNext()?c.next():null;if(u){if("replace"===r)await s.replaceOne({_id:u._id},e);else if("merge"===r){const t=Object.assign({},u,e);await s.replaceOne({_id:u._id},t)}else if("keepExisting"===r);else if("fail"===r)throw new F("$merge failed: duplicate key",{collection:this.name,code:T.DUPLICATE_KEY})}else if("insert"===i)await s.insertOne(e);else if("discard"===i);else if("fail"===i)throw new F("$merge failed: document not found",{collection:this.name,code:T.FAILED_TO_PARSE})}t=[]}else if("$lookup"===s){if(!(o.from&&o.localField&&o.foreignField&&o.as))throw new F("$lookup requires from, localField, foreignField, and as",{collection:this.name,code:T.FAILED_TO_PARSE});if(!this.db.getCollectionNames().includes(o.from))throw new F("$lookup: collection not found: "+o.from,{collection:this.name,code:T.NAMESPACE_NOT_FOUND});const e=this.db[o.from],n=[];for(let r=0;r<t.length;r++){const i=v(t[r]),s=N(i,o.localField),a=[],l=await e.find({[o.foreignField]:s});for(;l.hasNext();)a.push(l.next());i[o.as]=a,n.push(i)}t=n}else if("$graphLookup"===s){if(!(o.from&&o.startWith&&o.connectFromField&&o.connectToField&&o.as))throw new F("$graphLookup requires from, startWith, connectFromField, connectToField, and as",{collection:this.name,code:T.FAILED_TO_PARSE});if(!this.db.getCollectionNames().includes(o.from))throw new F("$graphLookup: collection not found: "+o.from,{collection:this.name,code:T.NAMESPACE_NOT_FOUND});const e=this.db[o.from],n=void 0!==o.maxDepth?o.maxDepth:Number.MAX_SAFE_INTEGER,r=o.depthField,i=o.restrictSearchWithMatch,s=[];for(let a=0;a<t.length;a++){const l=v(t[a]),c=be(o.startWith,t[a]),u=new Set,h=[],f=[{value:c,depth:0}];for(;f.length>0;){const{value:t,depth:s}=f.shift();if(s>n)continue;const a=JSON.stringify(t);if(u.has(a))continue;u.add(a);let l={[o.connectToField]:t};i&&(l={$and:[l,i]});const c=await e.find(l);for(;c.hasNext();){const e=c.next(),t=v(e);r&&(t[r]=s),h.push(t);const n=N(e,o.connectFromField);null!=n&&f.push({value:n,depth:s+1})}}l[o.as]=h,s.push(l)}t=s}else if("$facet"===s){if("object"!=typeof o||Array.isArray(o))throw new F("$facet requires an object with pipeline definitions",{collection:this.name,code:T.FAILED_TO_PARSE});const e={};for(const n in o){const r=o[n];if(!Array.isArray(r))throw new F("$facet pipeline must be an array",{collection:this.name,code:T.FAILED_TO_PARSE});let i=t.map(e=>v(e));for(let e=0;e<r.length;e++){const t=r[e],n=Object.keys(t);if(1!==n.length)throw new F("Each pipeline stage must have exactly one key",{collection:this.name,code:T.FAILED_TO_PARSE});const s=n[0],o=t[s];if("$match"===s){const e=[];for(let t=0;t<i.length;t++)He(i[t],o)&&e.push(i[t]);i=e}else if("$project"===s){const e=[];for(let t=0;t<i.length;t++)e.push(xt(o,i[t]));i=e}else if("$limit"===s)i=i.slice(0,o);else if("$skip"===s)i=i.slice(o);else if("$sort"===s){const e=Object.keys(o);i.sort(function(t,n){for(let r=0;r<e.length;r++){const i=e[r];if(void 0===t[i]&&void 0!==n[i])return-1*o[i];if(void 0!==t[i]&&void 0===n[i])return 1*o[i];if(t[i]<n[i])return-1*o[i];if(t[i]>n[i])return 1*o[i]}return 0})}else if("$count"===s)i=[{[o]:i.length}];else if("$group"===s){const e={},t=o._id;for(let r=0;r<i.length;r++){const n=i[r];let s;s=null==t?null:be(t,n);const o=JSON.stringify(s);e[o]||(e[o]={_id:s,docs:[],accumulators:{}}),e[o].docs.push(n)}const n=[];for(const r in e){const t=e[r],i={_id:t._id};for(const e in o){if("_id"===e)continue;const n=o[e],r=Object.keys(n);if(1!==r.length)continue;const s=r[0],a=n[s];if("$sum"===s){let n=0;for(let e=0;e<t.docs.length;e++){const r=be(a,t.docs[e]);"number"==typeof r?n+=r:null!=r&&(n+=Number(r)||0)}i[e]=n}else if("$avg"===s){let n=0,r=0;for(let e=0;e<t.docs.length;e++){const i=be(a,t.docs[e]);null!=i&&(n+=Number(i)||0,r++)}i[e]=r>0?n/r:0}else if("$max"===s){let n;for(let e=0;e<t.docs.length;e++){const r=be(a,t.docs[e]);void 0!==r&&(void 0===n||r>n)&&(n=r)}i[e]=n}}n.push(i)}i=n}else if("$sortByCount"===s){const e={};for(let t=0;t<i.length;t++){const n=i[t],r=be(o,n),s=JSON.stringify(r);e[s]||(e[s]={_id:r,count:0}),e[s].count++}i=Object.values(e).sort((e,t)=>t.count-e.count)}else if("$sample"===s){const e=o.size||1,t=[...i];for(let n=t.length-1;n>0;n--){const e=Math.floor(Math.random()*(n+1));[t[n],t[e]]=[t[e],t[n]]}i=t.slice(0,Math.min(e,t.length))}else if("$bucket"===s){const e=o.boundaries,t=o.default,n=o.output||{count:{$sum:1}},r={};for(let i=0;i<e.length-1;i++){r[JSON.stringify(e[i])]={_id:e[i],docs:[]}}void 0!==t&&(r.default={_id:t,docs:[]});for(let a=0;a<i.length;a++){const n=i[a],s=be(o.groupBy,n);let l=!1;for(let t=0;t<e.length-1;t++)if(s>=e[t]&&s<e[t+1]){r[JSON.stringify(e[t])].docs.push(n),l=!0;break}l||void 0===t||r.default.docs.push(n)}const s=[];for(const i in r){const e=r[i];if(0===e.docs.length)continue;const t={_id:e._id};for(const r in n){const i=n[r],s=Object.keys(i);if(1!==s.length)continue;const o=s[0],a=i[o];if("$sum"===o){let n=0;for(let t=0;t<e.docs.length;t++){const r=be(a,e.docs[t]);"number"==typeof r?n+=r:null!=r&&(n+=Number(r)||0)}t[r]=n}}s.push(t)}i=s.sort((e,t)=>e._id<t._id?-1:e._id>t._id?1:0)}}e[n]=i}t=[e]}else if("$redact"===s){const e=[];for(let n=0;n<t.length;n++){const r=t[n],i=be(o,r);if("$$DESCEND"===i)e.push(r);else{if("$$PRUNE"===i)continue;("$$KEEP"===i||i)&&e.push(r)}}t=e}else{if("$geoNear"!==s)throw new F("Unsupported aggregation stage: "+s,{collection:this.name,code:T.FAILED_TO_PARSE});{if(!o.near||!o.distanceField)throw new F("$geoNear requires near and distanceField",{collection:this.name,code:T.FAILED_TO_PARSE});const e=o.near,n=o.distanceField,r=o.maxDistance,i=o.minDistance||0,s=!1!==o.spherical,a=o.key||"location",l=[];for(let o=0;o<t.length;o++){const c=v(t[o]),u=N(c,a);if(!u||!Array.isArray(u)||u.length<2)continue;let h;if(s){const t=6371e3,n=e[1]*Math.PI/180,r=u[1]*Math.PI/180,i=(u[1]-e[1])*Math.PI/180,s=(u[0]-e[0])*Math.PI/180,o=Math.sin(i/2)*Math.sin(i/2)+Math.cos(n)*Math.cos(r)*Math.sin(s/2)*Math.sin(s/2);h=t*(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)))}else{const t=u[0]-e[0],n=u[1]-e[1];h=Math.sqrt(t*t+n*n)}h>=i&&(!r||h<=r)&&(c[n]=h,l.push(c))}l.sort((e,t)=>e[n]-t[n]),t=o.limit?l.slice(0,o.limit):l}}}return t}async bulkWrite(){throw new R("bulkWrite",{collection:this.name})}async count(){this._initialized||await this._initialize();let e=0;for await(const t of this.documents)e++;return e}async copyTo(e){const t=this.db.getCollection(e);let n=0;const r=await this.find({});for(;r.hasNext();)await t.insertOne(r.next()),n++;return n}async createIndex(e,t){if(this._initialized||await this._initialize(),!e||"object"!=typeof e||Array.isArray(e))throw new B("keys",e,"createIndex requires a key specification object",{collection:this.name});const n=t&&t.name?t.name:this.generateIndexName(e);if(this.indexes.has(n)){const t=this.indexes.get(n);if(JSON.stringify(t.keys)!==JSON.stringify(e))throw new M("Index with name '"+n+"' already exists with a different key specification",{code:T.INDEX_OPTIONS_CONFLICT,index:n,collection:this.name});return n}return await this._buildIndex(n,e,t),n}dataSize(){throw new R("dataSize",{collection:this.name})}async deleteOne(e){const t=await this.findOne(e);return t?(await this.updateIndexesOnDelete(t),await this.documents.delete(t._id.toString()),this.emit("delete",{_id:t._id}),{deletedCount:1}):{deletedCount:0}}async deleteMany(e){const t=await this.find(e),n=[],r=[];for(;t.hasNext();){const e=t.next();n.push(e._id),r.push(e)}const i=n.length;for(let s=0;s<n.length;s++)await this.updateIndexesOnDelete(r[s]),await this.documents.delete(n[s].toString()),this.emit("delete",{_id:n[s]});return{deletedCount:i}}async distinct(e,t){const n={},r=await this.find(t);for(;r.hasNext();){const t=r.next();t[e]&&(n[t[e]]=!0)}return Object.keys(n)}async drop(){this._initialized||await this._initialize();for(const[i,s]of this.indexes)s&&"function"==typeof s.close&&await s.close();this.documents&&"function"==typeof this.documents.close&&await this.documents.close();const e=this.path.split("/").filter(Boolean),t=e.pop();try{let r=await globalThis.navigator.storage.getDirectory();for(const t of e)r=await r.getDirectoryHandle(t,{create:!1});try{await r.removeEntry(t,{recursive:!0})}catch(n){if("TypeError"!==n.name&&!n.message?.includes("recursive"))throw n;await r.removeEntry(t)}}catch(r){if("NotFoundError"!==r.name&&"ENOENT"!==r.code)throw r}return this.documents=null,this.indexes.clear(),this._initialized=!1,this.db.collections.delete(this.name),this.emit("drop",{collection:this.name}),{ok:1}}async dropIndex(e){if(!this.indexes.has(e))throw new k(e,{collection:this.name});const t=this.indexes.get(e);return t&&"function"==typeof t.clear&&await t.clear(),t&&"function"==typeof t.close&&await t.close(),this.indexes.delete(e),{nIndexesWas:this.indexes.size+1,ok:1}}async dropIndexes(){const e=this.indexes.size;for(const[t,n]of this.indexes)n&&"function"==typeof n.clear&&await n.clear(),n&&"function"==typeof n.close&&await n.close();return this.indexes.clear(),{nIndexesWas:e,msg:"non-_id indexes dropped",ok:1}}ensureIndex(){throw new R("ensureIndex",{collection:this.name})}explain(){throw new R("explain",{collection:this.name})}async find(e,t){return this._validateProjection(t),this._findInternal(e,t)}_validateProjection(e){if(!e||0===Object.keys(e).length)return;const t=Object.keys(e);let n=!1,r=!1;for(const i of t)if("_id"!==i&&(e[i]?n=!0:r=!0,n&&r))break;if(n&&r)throw new F("Cannot do exclusion on field in inclusion projection",{code:T.CANNOT_DO_EXCLUSION_ON_FIELD_ID_IN_INCLUSION_PROJECTION,collection:this.name})}async _findInternal(e,t){this._initialized||await this._initialize();const n=null==e?{}:e,r=this._extractNearSpec(n),i=[],s={};if(this.indexes.size>0){const e=await this.planQueryAsync(n);if(e.useIndex&&e.docIds&&e.docIds.length>0){for(const t of e.docIds)if(!s[t]){const e=await this.documents.search(t);e&&He(e,n)&&(s[t]=!0,i.push(e))}}else for await(const t of this.documents)t&&t.value&&!s[t.value._id]&&He(t.value,n)&&(s[t.value._id]=!0,i.push(t.value))}else for await(const o of this.documents)o&&o.value&&!s[o.value._id]&&He(o.value,n)&&(s[o.value._id]=!0,i.push(o.value));return r&&this._sortByNearDistance(i,r),new z(this,n,t,i,q)}_extractNearSpec(e){for(const t of Object.keys(e||{})){if(t.startsWith("$"))continue;const n=e[t];if(n&&"object"==typeof n){if(n.$near){const e=this._parseNearCoordinates(n.$near);if(e)return{field:t,...e}}if(n.$nearSphere){const e=this._parseNearCoordinates(n.$nearSphere);if(e)return{field:t,...e}}}}return null}_parseNearCoordinates(e){let t;if(e&&"object"==typeof e&&(e.$geometry&&e.$geometry.coordinates?t=e.$geometry.coordinates:e.coordinates?t=e.coordinates:Array.isArray(e)&&(t=e)),!t||t.length<2)return null;const[n,r]=t;return"number"!=typeof r||"number"!=typeof n?null:{lat:r,lng:n}}_extractPointCoordinates(e){if(!e)return null;if("FeatureCollection"===e.type&&Array.isArray(e.features)&&e.features.length>0)return this._extractPointCoordinates(e.features[0].geometry);if("Feature"===e.type&&e.geometry)return this._extractPointCoordinates(e.geometry);if("Point"===e.type&&Array.isArray(e.coordinates)&&e.coordinates.length>=2){const[t,n]=e.coordinates;if("number"==typeof n&&"number"==typeof t)return{lat:n,lng:t}}return null}_sortByNearDistance(e,t){const{field:n,lat:r,lng:i}=t;e.sort((e,t)=>{const s=this._extractPointCoordinates(N(e,n)),o=this._extractPointCoordinates(N(t,n));return(s?this._haversineDistance(s.lat,s.lng,r,i):1/0)-(o?this._haversineDistance(o.lat,o.lng,r,i):1/0)})}_haversineDistance(e,t,n,r){const i=(n-e)*Math.PI/180,s=(r-t)*Math.PI/180,o=Math.sin(i/2)*Math.sin(i/2)+Math.cos(e*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin(s/2)*Math.sin(s/2);return 6371*(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)))}findAndModify(){throw new R("findAndModify",{collection:this.name})}async findOne(e,t){const n=await this.find(e,t);return n.hasNext()?n.next():null}async findOneAndDelete(e,t){let n=await this.find(e);if(t&&t.sort&&(n=n.sort(t.sort)),!n.hasNext())return null;const r=n.next();return await this.documents.delete(r._id.toString()),t&&t.projection?D(t.projection,r):r}async findOneAndReplace(e,t,n){let r=await this.find(e);if(n&&n.sort&&(r=r.sort(n.sort)),!r.hasNext())return null;const i=r.next();return t._id=i._id,await this.documents.add(i._id.toString(),t),n&&n.returnNewDocument?n&&n.projection?D(n.projection,t):t:n&&n.projection?D(n.projection,i):i}async findOneAndUpdate(e,t,n){let r=await this.find(e);if(n&&n.sort&&(r=r.sort(n.sort)),!r.hasNext())return null;const i=r.next(),s=Object.assign({},i);return rt(t,s,!1,Ke(i,e).arrayFilters,n&&n.arrayFilters),await this.documents.add(i._id.toString(),s),n&&n.returnNewDocument?n&&n.projection?D(n.projection,s):s:n&&n.projection?D(n.projection,i):i}getIndexes(){const e=[];for(const[t,n]of this.indexes)e.push(n.getSpec());return e}getShardDistribution(){throw new R("getShardDistribution",{collection:this.name})}getShardVersion(){throw new R("getShardVersion",{collection:this.name})}getStore(){return this.documents}group(){throw new R("group",{collection:this.name})}async insert(e){return Array==e.constructor?await this.insertMany(e):await this.insertOne(e)}async insertOne(e){return this._initialized||await this._initialize(),null==e._id&&(e._id=new m),await this.documents.add(e._id.toString(),e),await this.updateIndexesOnInsert(e),this.emit("insert",e),{insertedId:e._id}}async insertMany(e){this._initialized||await this._initialize();const t=[];for(let n=0;n<e.length;n++){const r=await this.insertOne(e[n]);t.push(r.insertedId)}return{insertedIds:t}}isCapped(){throw new R("isCapped",{collection:this.name})}mapReduce(){throw new R("mapReduce",{collection:this.name})}reIndex(){throw new R("reIndex",{collection:this.name})}async replaceOne(e,t,n){const r={},i=await this.find(e);if(r.matchedCount=i.count(),0==r.matchedCount){if(r.modifiedCount=0,n&&n.upsert){const e=t;e._id=new m,await this.documents.add(e._id.toString(),e),await this.updateIndexesOnInsert(e),this.emit("insert",e),r.upsertedId=e._id}}else{r.modifiedCount=1;const e=i.next();await this.updateIndexesOnDelete(e),t._id=e._id,await this.documents.add(e._id.toString(),t),await this.updateIndexesOnInsert(t),this.emit("replace",t)}return r}async remove(e,t){const n=await this.find(e);if(n.hasNext())if(!0===t||t&&t.justOne){const e=n.next();await this.updateIndexesOnDelete(e),await this.documents.delete(e._id.toString())}else for(;n.hasNext();){const e=n.next();await this.updateIndexesOnDelete(e),await this.documents.delete(e._id.toString())}}renameCollection(){throw new R("renameCollection",{collection:this.name})}save(){throw new R("save",{collection:this.name})}stats(){throw new R("stats",{collection:this.name})}storageSize(){throw new R("storageSize",{collection:this.name})}totalSize(){throw new R("totalSize",{collection:this.name})}totalIndexSize(){throw new R("totalIndexSize",{collection:this.name})}async update(e,t,n){const r=await this.find(e);if(r.hasNext())if(n&&n.multi)for(;r.hasNext();){const i=r.next(),s=Ke(i,e).arrayFilters,o=n&&n.arrayFilters;await this.updateIndexesOnDelete(i),rt(t,i,!1,s,o),await this.documents.add(i._id.toString(),i),await this.updateIndexesOnInsert(i)}else{const i=r.next(),s=Ke(i,e).arrayFilters,o=n&&n.arrayFilters;await this.updateIndexesOnDelete(i),rt(t,i,!1,s,o),await this.documents.add(i._id.toString(),i),await this.updateIndexesOnInsert(i)}else if(n&&n.upsert){const n=it(e,t,new m);await this.documents.add(n._id.toString(),n),await this.updateIndexesOnInsert(n)}}async updateOne(e,t,n){const r=await this.find(e);if(r.hasNext()){const i=r.next(),s=JSON.parse(JSON.stringify(i)),o=Ke(i,e).arrayFilters,a=n&&n.arrayFilters;await this.updateIndexesOnDelete(i),rt(t,i,!1,o,a),await this.documents.add(i._id.toString(),i),await this.updateIndexesOnInsert(i);const l=this._getUpdateDescription(s,i);this.emit("update",i,l)}else if(n&&n.upsert){const n=it(e,t,new m);await this.documents.add(n._id.toString(),n),await this.updateIndexesOnInsert(n),this.emit("insert",n)}}async updateMany(e,t,n){const r=await this.find(e);if(r.hasNext())for(;r.hasNext();){const i=r.next(),s=JSON.parse(JSON.stringify(i)),o=Ke(i,e).arrayFilters,a=n&&n.arrayFilters;await this.updateIndexesOnDelete(i),rt(t,i,!1,o,a),await this.documents.add(i._id.toString(),i),await this.updateIndexesOnInsert(i);const l=this._getUpdateDescription(s,i);this.emit("update",i,l)}else if(n&&n.upsert){const n=it(e,t,new m);await this.documents.add(n._id.toString(),n),await this.updateIndexesOnInsert(n),this.emit("insert",n)}}validate(){throw new R("validate",{collection:this.name})}_getUpdateDescription(e,t){const n={},r=[];for(const i in t)"_id"!==i&&JSON.stringify(e[i])!==JSON.stringify(t[i])&&(n[i]=t[i]);for(const i in e)"_id"!==i&&(i in t||r.push(i));return{updatedFields:n,removedFields:r,truncatedArrays:[]}}watch(e=[],t={}){return new wt(this,e,t)}}function xt(e,t){const n={},r=Object.keys(e);let i=!1,s=!1;for(const o of r){if("_id"===o)continue;const t=e[o];1===t||!0===t?i=!0:0===t||!1===t||(s=!0)}if(s||i){0!==e._id&&!1!==e._id&&(n._id=t._id);for(const i of r){const r=e[i];"_id"===i?0!==r&&!1!==r||delete n._id:n[i]=1===r||!0===r?N(t,i):be(r,t)}}else{for(const e in t)t.hasOwnProperty(e)&&(n[e]=t[e]);for(const t of r)0!==e[t]&&!1!==e[t]||delete n[t]}return n}class _t{constructor(e){this.options=e||{},this.baseFolder=this.options.baseFolder||"/micro-mongo",this.dbName=this.options.dbName||"default",this.dbFolder=`${this.baseFolder}/${this.dbName}`,this.collections=new Map;const t=new Proxy(this,{get:(e,t,n)=>t in e?Reflect.get(e,t,n):"symbol"==typeof t||t.startsWith("_")?void 0:"string"==typeof t?e.getCollection(t):void 0});return this._proxy=t,t}async close(){for(const[e,t]of this.collections)await t.close()}cloneCollection(){throw new R("cloneCollection",{database:this.dbName})}cloneDatabase(){throw new R("cloneDatabase",{database:this.dbName})}commandHelp(){throw new R("commandHelp",{database:this.dbName})}copyDatabase(){throw new R("copyDatabase",{database:this.dbName})}createCollection(e){return this.collections.has(e)||this.collections.set(e,new bt(this,e)),{ok:1}}currentOp(){throw new R("currentOp",{database:this.dbName})}async dropCollection(e){if(this.collections.has(e)){const t=this.collections.get(e);"function"==typeof t.drop&&await t.drop(),this.collections.delete(e)}}async dropDatabase(){for(const[i,s]of this.collections)await s.drop();this.collections.clear();const e=this.dbFolder.split("/").filter(Boolean),t=e.pop();let n=await globalThis.navigator.storage.getDirectory();for(const i of e)n=await n.getDirectoryHandle(i,{create:!1});try{await n.removeEntry(t,{recursive:!0})}catch(r){if("NotFoundError"!==r.name&&"ENOENT"!==r.code)throw r}return{ok:1}}eval(){throw new R("eval",{database:this.dbName})}fsyncLock(){throw new R("fsyncLock",{database:this.dbName})}fsyncUnlock(){throw new R("fsyncUnlock",{database:this.dbName})}getCollection(e){if(!this.collections.has(e)){const t=this._proxy||this;this.collections.set(e,new bt(t,e))}return this.collections.get(e)}collection(e){return this.getCollection(e)}getCollectionInfos(){throw new R("getCollectionInfos",{database:this.dbName})}getCollectionNames(){return Array.from(this.collections.keys())}getLastError(){throw new R("getLastError",{database:this.dbName})}getLastErrorObj(){throw new R("getLastErrorObj",{database:this.dbName})}getLogComponents(){throw new R("getLogComponents",{database:this.dbName})}getMongo(){throw new R("getMongo",{database:this.dbName})}getName(){throw new R("getName",{database:this.dbName})}getPrevError(){throw new R("getPrevError",{database:this.dbName})}getProfilingLevel(){throw new R("getProfilingLevel",{database:this.dbName})}getProfilingStatus(){throw new R("getProfilingStatus",{database:this.dbName})}getReplicationInfo(){throw new R("getReplicationInfo",{database:this.dbName})}getSiblingDB(){throw new R("getSiblingDB",{database:this.dbName})}help(){console.log("        help mr                      mapreduce"),console.log("        db.foo.find()                list objects in collection foo"),console.log("        db.foo.find( { a : 1 } )     list objects in foo where a == 1"),console.log("        it                           result of the last line evaluated; use to further iterate")}hostInfo(){throw new R("hostInfo",{database:this.dbName})}isMaster(){throw new R("isMaster",{database:this.dbName})}killOp(){throw new R("killOp",{database:this.dbName})}listCommands(){throw new R("listCommands",{database:this.dbName})}loadServerScripts(){throw new R("loadServerScripts",{database:this.dbName})}logout(){throw new R("logout",{database:this.dbName})}printCollectionStats(){throw new R("printCollectionStats",{database:this.dbName})}printReplicationInfo(){throw new R("printReplicationInfo",{database:this.dbName})}printShardingStatus(){throw new R("printShardingStatus",{database:this.dbName})}printSlaveReplicationInfo(){throw new R("printSlaveReplicationInfo",{database:this.dbName})}repairDatabase(){throw new R("repairDatabase",{database:this.dbName})}resetError(){throw new R("resetError",{database:this.dbName})}runCommand(){throw new R("runCommand",{database:this.dbName})}serverBuildInfo(){throw new R("serverBuildInfo",{database:this.dbName})}serverCmdLineOpts(){throw new R("serverCmdLineOpts",{database:this.dbName})}serverStatus(){throw new R("serverStatus",{database:this.dbName})}setLogLevel(){throw new R("setLogLevel",{database:this.dbName})}setProfilingLevel(){throw new R("setProfilingLevel",{database:this.dbName})}shutdownServer(){throw new R("shutdownServer",{database:this.dbName})}stats(){throw new R("stats",{database:this.dbName})}version(){throw new R("version",{database:this.dbName})}upgradeCheck(){throw new R("upgradeCheck",{database:this.dbName})}upgradeCheckAllDBs(){throw new R("upgradeCheckAllDBs",{database:this.dbName})}watch(e=[],t={}){return new wt(this,e,t)}}class vt extends r.EventEmitter{constructor(e="mongodb://localhost:27017",t={}){super(),this.uri=e,this.options=Object.freeze({...t}),this._isConnected=!1,this._defaultDb=this._parseDefaultDbName(e),this._databases=new Map}static async connect(e,t={}){const n=new vt(e,t);return await n.connect(),n}async connect(){return this._isConnected||(this._isConnected=!0,this.emit("open",this)),this}db(e,t={}){const n=e||this._defaultDb;if(!n)throw new Error("No database name provided and no default in connection string");if(this._databases.has(n))return this._databases.get(n);const r={...this.options,...t,dbName:n},i=new _t(r);return this._databases.set(n,i),i}async close(e=!1){if(this._isConnected){for(const[e,t]of this._databases)await t.close();this._databases.clear(),this._isConnected=!1,this.emit("close")}}startSession(e={}){return{id:crypto.randomUUID(),endSession:()=>{},withTransaction:async e=>await e(this)}}async withSession(e,t){const n=this.startSession("function"==typeof e?{}:e),r="function"==typeof e?e:t;try{return await r(n)}finally{n.endSession()}}get readConcern(){return this.options.readConcern}get writeConcern(){return this.options.writeConcern}get readPreference(){return this.options.readPreference}watch(e=[],t={}){return new wt(this,e,t)}_parseDefaultDbName(e){const t=e.match(/\/([^/?]+)/);return t?t[1]:null}}e.BadValueError=B,e.BulkWriteError=class extends L{constructor(e=[],t={}){super(`Bulk write operation error: ${e.length} error(s)`,t),this.name="BulkWriteError",this.writeErrors=e,this.code=t.code||T.WRITE_CONFLICT}},e.CannotCreateIndexError=class extends M{constructor(e,t={}){super(`Cannot create index: ${e}`,{...t,code:T.CANNOT_CREATE_INDEX}),this.name="CannotCreateIndexError"}},e.ChangeStream=wt,e.CursorError=U,e.CursorNotFoundError=class extends U{constructor(e,t={}){super(`Cursor ${e} not found`,{...t,code:T.CURSOR_NOT_FOUND}),this.name="CursorNotFoundError",this.cursorId=e}},e.DuplicateKeyError=class extends j{constructor(e,t={}){const n=JSON.stringify(e);super(`E11000 duplicate key error${t.collection?` collection: ${t.collection}`:""} index: ${n} dup key: ${n}`,{...t,code:T.DUPLICATE_KEY}),this.name="DuplicateKeyError",this.keyPattern=e,this.keyValue=t.keyValue||e}},e.ErrorCodes=T,e.IndexError=M,e.IndexExistsError=class extends M{constructor(e,t={}){super(`Index with name '${e}' already exists`,{...t,code:T.INDEX_EXISTS}),this.name="IndexExistsError",this.indexName=e}},e.IndexNotFoundError=k,e.InvalidNamespaceError=class extends P{constructor(e,t,n={}){"object"!=typeof t||n||(n=t,t=void 0);super(t?`Invalid namespace '${e}': ${t}`:`Invalid namespace '${e}'`,{...n,code:T.INVALID_NAMESPACE}),this.name="InvalidNamespaceError",this.namespace=e}},e.MongoClient=vt,e.MongoDriverError=class extends L{constructor(e,t={}){super(e,t),this.name="MongoDriverError",this.code=t.code||T.INTERNAL_ERROR}},e.MongoError=L,e.MongoNetworkError=class extends L{constructor(e,t={}){super(e,t),this.name="MongoNetworkError",this.code=t.code||T.HOST_UNREACHABLE}},e.MongoServerError=class extends L{constructor(e,t={}){super(e,t),this.name="MongoServerError"}},e.NamespaceError=P,e.NamespaceNotFoundError=class extends P{constructor(e,t={}){super(`Namespace '${e}' not found`,{...t,code:T.NAMESPACE_NOT_FOUND}),this.name="NamespaceNotFoundError",this.namespace=e}},e.NotImplementedError=R,e.ObjectId=m,e.OperationNotSupportedError=class extends L{constructor(e,t,n={}){"object"!=typeof t||n||(n=t,t=void 0);super(t?`Operation '${e}' is not supported: ${t}`:`Operation '${e}' is not supported`,{...n,code:T.OPERATION_NOT_SUPPORTED,operation:e}),this.name="OperationNotSupportedError"}},e.QueryError=F,e.TypeMismatchError=class extends L{constructor(e,t,n,r={}){super(`Type mismatch for field '${e}': expected ${t}, got ${n}`,{...r,code:T.TYPE_MISMATCH,field:e}),this.name="TypeMismatchError",this.expectedType=t,this.actualType=n}},e.ValidationError=class extends L{constructor(e,t={}){super(e,t),this.name="ValidationError",this.code=t.code||T.DOCUMENT_VALIDATION_FAILURE,this.validationErrors=t.validationErrors||[]}},e.WriteError=j,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=micro-mongo-2.0.0.min.umd.js.map
