!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).MicroMongo={})}(this,function(e){"use strict";var t,n={exports:{}};var r=function(){if(t)return n.exports;t=1;var e,r="object"==typeof Reflect?Reflect:null,i=r&&"function"==typeof r.apply?r.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};e=r&&"function"==typeof r.ownKeys?r.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var s=Number.isNaN||function(e){return e!=e};function o(){o.init.call(this)}n.exports=o,n.exports.once=function(e,t){return new Promise(function(n,r){function i(n){e.removeListener(t,s),r(n)}function s(){"function"==typeof e.removeListener&&e.removeListener("error",i),n([].slice.call(arguments))}m(e,t,s,{once:!0}),"error"!==t&&function(e,t,n){"function"==typeof e.on&&m(e,"error",t,n)}(e,i,{once:!0})})},o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var a=10;function l(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function c(e){return void 0===e._maxListeners?o.defaultMaxListeners:e._maxListeners}function u(e,t,n,r){var i,s,o,a;if(l(n),void 0===(s=e._events)?(s=e._events=Object.create(null),e._eventsCount=0):(void 0!==s.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),s=e._events),o=s[t]),void 0===o)o=s[t]=n,++e._eventsCount;else if("function"==typeof o?o=s[t]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),(i=c(e))>0&&o.length>i&&!o.warned){o.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=o.length,a=u,console&&console.warn&&console.warn(a)}return e}function h(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function d(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=h.bind(r);return i.listener=n,r.wrapFn=i,i}function f(e,t,n){var r=e._events;if(void 0===r)return[];var i=r[t];return void 0===i?[]:"function"==typeof i?n?[i.listener||i]:[i]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(i):g(i,i.length)}function p(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function g(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}function m(e,t,n,r){if("function"==typeof e.on)r.once?e.once(t,n):e.on(t,n);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,function i(s){r.once&&e.removeEventListener(t,i),n(s)})}}return Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return a},set:function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");a=e}}),o.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},o.prototype.getMaxListeners=function(){return c(this)},o.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var r="error"===e,s=this._events;if(void 0!==s)r=r&&void 0===s.error;else if(!r)return!1;if(r){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var l=s[e];if(void 0===l)return!1;if("function"==typeof l)i(l,this,t);else{var c=l.length,u=g(l,c);for(n=0;n<c;++n)i(u[n],this,t)}return!0},o.prototype.addListener=function(e,t){return u(this,e,t,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(e,t){return u(this,e,t,!0)},o.prototype.once=function(e,t){return l(t),this.on(e,d(this,e,t)),this},o.prototype.prependOnceListener=function(e,t){return l(t),this.prependListener(e,d(this,e,t)),this},o.prototype.removeListener=function(e,t){var n,r,i,s,o;if(l(t),void 0===(r=this._events))return this;if(void 0===(n=r[e]))return this;if(n===t||n.listener===t)0===--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,s=n.length-1;s>=0;s--)if(n[s]===t||n[s].listener===t){o=n[s].listener,i=s;break}if(i<0)return this;0===i?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,i),1===n.length&&(r[e]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",e,o||t)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(e){var t,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0===--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var i,s=Object.keys(n);for(r=0;r<s.length;++r)"removeListener"!==(i=s[r])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},o.prototype.listeners=function(e){return f(this,e,!0)},o.prototype.rawListeners=function(e){return f(this,e,!1)},o.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):p.call(e,t)},o.prototype.listenerCount=p,o.prototype.eventNames=function(){return this._eventsCount>0?e(this._events):[]},n.exports}();class i{constructor(e){if(null==e)this.id=i.generate();else if("string"==typeof e){if(!i.isValid(e))throw new Error(`Argument passed in must be a string of 24 hex characters, got: ${e}`);this.id=e.toLowerCase()}else if(e instanceof Uint8Array&&12===e.length)this.id=Array.from(e).map(e=>e.toString(16).padStart(2,"0")).join("");else{if(!(e instanceof i))throw new Error("Argument passed in must be a string of 24 hex characters or an ObjectId");this.id=e.id}}toString(){return this.id}toHexString(){return this.id}getTimestamp(){const e=parseInt(this.id.substring(0,8),16);return new Date(1e3*e)}equals(e){if(!(e instanceof i))throw new Error("Can only compare with another ObjectId");return this.id===e.id}compare(e){if(!(e instanceof i))throw new Error("Can only compare with another ObjectId");return this.id.localeCompare(e.id)}toJSON(){return this.id}inspect(){return`ObjectId("${this.id}")`}toBytes(){const e=new Uint8Array(12);for(let t=0;t<12;t++)e[t]=parseInt(this.id.substring(2*t,2*t+2),16);return e}static isValid(e){return!!e&&("string"==typeof e&&(24===e.length&&/^[0-9a-fA-F]{24}$/.test(e)))}static createFromTime(e){const t=("00000000"+Math.floor(e/1e3).toString(16)).slice(-8);return new i(t+"0000000000000000")}static generate(){const e=Math.floor(Date.now()/1e3),t="undefined"!=typeof crypto&&crypto.getRandomValues?new Uint8Array(8):null;let n="";if(t){crypto.getRandomValues(t);for(let e=0;e<t.length;e++)n+=("0"+t[e].toString(16)).slice(-2)}else n=Math.random().toString(16).slice(2).padEnd(8,"0").slice(0,8)+Math.random().toString(16).slice(2).padEnd(8,"0").slice(0,8);return(("00000000"+e.toString(16)).slice(-8)+n).slice(0,24)}}function s(e,t){return e instanceof i||t instanceof i?e instanceof i&&t instanceof i||e instanceof i&&"string"==typeof t?e.equals(t):t instanceof i&&"string"==typeof e&&t.equals(e):e==t}function o(e){if(e instanceof i)return new i(e.id);var t,n,r;for(r in t=Array.isArray(e)?[]:{},e)n=e[r],t[r]="object"==typeof n&&null!==n?o(n):n;return t}function a(e,t){for(var n=t.split("."),r=e[n[0]],i=1;i<n.length;i++){if(null==r||null==r)return r;var s=n[i],o=parseInt(s,10);r=u(r)&&!isNaN(o)&&o>=0&&o<r.length?r[o]:r[s]}return r}function l(e,t){for(var n=t.split("."),r=[e],i=0;i<n.length;i++){for(var s=n[i],o=parseInt(s,10),a=[],l=0;l<r.length;l++){var c=r[l];if(null!=c&&null!=c)if(u(c)&&!isNaN(o)&&o>=0)o<c.length&&a.push(c[o]);else if(u(c))for(var h=0;h<c.length;h++)null!=c[h]&&null!=c[h]&&"object"==typeof c[h]&&a.push(c[h][s]);else"object"==typeof c&&a.push(c[s])}r=a}if(0!==(r=r.filter(function(e){return void 0!==e})).length)return 1===r.length?r[0]:r}function c(e,t,n){if(-1!==t.indexOf("$[]"))return function(e,t,n){for(var r=t.split("."),i=e,s=0;s<r.length;s++){var o=r[s];if("$[]"===o){if(!Array.isArray(i))throw new Error("The positional operator did not find the match needed from the query.");for(var a=r.slice(s+1).join("."),l=0;l<i.length;l++)a?c(i[l],a,n):i[l]=n;return}var h=parseInt(o,10);if(u(i)&&!isNaN(h)&&h>=0)i=i[h];else{if(null==i[o]||null==i[o]){var d=s+1<r.length?r[s+1]:null;if("$[]"===d)i[o]=[];else{var f=parseInt(d,10);!isNaN(f)&&f>=0?i[o]=[]:i[o]={}}}i=i[o]}}}(e,t,n);for(var r=t.split("."),i=e,s=0;s<r.length-1;s++){var o=r[s],a=parseInt(o,10);if(u(i)&&!isNaN(a)&&a>=0){for(;i.length<=a;)i.push(void 0);if(null==i[a]||null==i[a]){var l=r[s+1],h=parseInt(l,10);!isNaN(h)&&h>=0?i[a]=[]:i[a]={}}i=i[a]}else{if(null==i[o]||null==i[o]){l=r[s+1],h=parseInt(l,10);!isNaN(h)&&h>=0?i[o]=[]:i[o]={}}i=i[o]}}var d=r[r.length-1],f=parseInt(d,10);if(u(i)&&!isNaN(f)&&f>=0){for(;i.length<=f;)i.push(void 0);i[f]=n}else i[d]=n}function u(e){return Array==e.constructor}function h(e){var t=[];for(var n in e)if(e.hasOwnProperty(n)){var r={};r[n]=e[n],t.push(r)}return t}function d(e,t){for(var n=0;n<t.length;n++)if(s(t[n],e))return!0;return!1}function f(e,t){if(e.length!=t.length)return!1;for(var n=0;n<e.length;n++)if(!s(e[n],t[n])){if(typeof e[n]!=typeof t[n])return!1;if("object"==typeof e[n]&&null!==e[n]){if(u(e[n])){if(!f(e[n],t[n]))return!1}else if(!p(e[n],t[n]))return!1}else if(!s(e[n],t[n]))return!1}return!0}function p(e,t){for(var n in e)if(e.hasOwnProperty(n)){if(!t.hasOwnProperty(n))return!1;if(!s(e[n],t[n])){if(typeof e[n]!=typeof t[n])return!1;if("object"==typeof e[n]&&null!==e[n]){if(u(e[n])){if(!f(e[n],t[n]))return!1}else if(!p(e[n],t[n]))return!1}else if(!s(e[n],t[n]))return!1}}for(var n in t)if(t.hasOwnProperty(n)&&!e.hasOwnProperty(n))return!1;return!0}function g(e,t){var n={},r=Object.keys(e);if(0==r.length)return t;for(var i=!1,s=!1,l=0;l<r.length;l++)"_id"!==r[l]&&(e[r[l]]?i=!0:s=!0);if(i&&s)throw{$err:"Can't canonicalize query: BadValue Projection cannot have a mix of inclusion and exclusion.",code:17287};if(e[r[0]]||i){0!==e._id&&(n._id=t._id);for(l=0;l<r.length;l++)if("_id"!==r[l]&&e[r[l]]){var h=a(t,p=r[l]);void 0!==h&&c(n,p,h)}}else{for(var d in t)if(t.hasOwnProperty(d)){var f=t[d];"object"!=typeof f||null===f||u(f)?u(f)?n[d]=f.slice():n[d]=f:n[d]=o(f)}for(l=0;l<r.length;l++)if(!e[r[l]]){var p,g=(p=r[l]).split(".");if(1===g.length)delete n[p];else{for(var m=n,y=0;y<g.length-1&&(null!=m&&null!=m);y++)m=m[g[y]];null!=m&&null!=m&&delete m[g[g.length-1]]}}}return n}const m={OK:0,INTERNAL_ERROR:1,BAD_VALUE:2,NO_SUCH_KEY:4,GRAPH_CONTAINS_CYCLE:5,HOST_UNREACHABLE:6,HOST_NOT_FOUND:7,UNKNOWN_ERROR:8,FAILED_TO_PARSE:17287,CANNOT_MUTATE_OBJECT:10,USER_NOT_FOUND:11,UNSUPPORTED_FORMAT:12,UNAUTHORIZED:13,TYPE_MISMATCH:14,OVERFLOW:15,INVALID_LENGTH:16,PROTOCOL_ERROR:17,AUTHENTICATION_FAILED:18,ILLEGAL_OPERATION:20,NAMESPACE_NOT_FOUND:26,INDEX_NOT_FOUND:27,PATH_NOT_VIABLE:28,CANNOT_CREATE_INDEX:67,INDEX_ALREADY_EXISTS:68,INDEX_EXISTS:68,COMMAND_NOT_FOUND:59,NAMESPACE_EXISTS:48,INVALID_NAMESPACE:73,INDEX_OPTIONS_CONFLICT:85,INVALID_INDEX_SPECIFICATION_OPTION:197,WRITE_CONFLICT:112,DUPLICATE_KEY:11e3,DUPLICATE_KEY_UPDATE:11001,DOCUMENT_VALIDATION_FAILURE:121,BAD_QUERY:2,CANNOT_INDEX_PARALLEL_ARRAYS:171,CURSOR_NOT_FOUND:43,COLLECTION_IS_EMPTY:26,NOT_IMPLEMENTED:999,OPERATION_NOT_SUPPORTED:998};class y extends Error{constructor(e,t={}){super(e),this.name="MongoError",this.code=t.code||m.UNKNOWN_ERROR,this.codeName=this._getCodeName(this.code),this.$err=e,t.collection&&(this.collection=t.collection),t.database&&(this.database=t.database),t.operation&&(this.operation=t.operation),t.query&&(this.query=t.query),t.document&&(this.document=t.document),t.field&&(this.field=t.field),t.index&&(this.index=t.index),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}_getCodeName(e){return{0:"OK",1:"InternalError",2:"BadValue",4:"NoSuchKey",5:"GraphContainsCycle",6:"HostUnreachable",7:"HostNotFound",8:"UnknownError",10:"CannotMutateObject",11:"UserNotFound",12:"UnsupportedFormat",13:"Unauthorized",14:"TypeMismatch",15:"Overflow",16:"InvalidLength",17:"ProtocolError",18:"AuthenticationFailed",20:"IllegalOperation",26:"NamespaceNotFound",27:"IndexNotFound",28:"PathNotViable",43:"CursorNotFound",48:"NamespaceExists",59:"CommandNotFound",67:"CannotCreateIndex",68:"IndexExists",73:"InvalidNamespace",85:"IndexOptionsConflict",112:"WriteConflict",121:"DocumentValidationFailure",171:"CannotIndexParallelArrays",197:"InvalidIndexSpecificationOption",998:"OperationNotSupported",999:"NotImplemented",11e3:"DuplicateKey",11001:"DuplicateKeyUpdate",17287:"FailedToParse"}[e]||"UnknownError"}toJSON(){const e={name:this.name,message:this.message,code:this.code,codeName:this.codeName};return this.collection&&(e.collection=this.collection),this.database&&(e.database=this.database),this.operation&&(e.operation=this.operation),this.index&&(e.index=this.index),this.indexName&&(e.indexName=this.indexName),this.field&&(e.field=this.field),this.query&&(e.query=this.query),this.document&&(e.document=this.document),this.namespace&&(e.namespace=this.namespace),this.cursorId&&(e.cursorId=this.cursorId),this.feature&&(e.feature=this.feature),this.keyPattern&&(e.keyPattern=this.keyPattern),this.keyValue&&(e.keyValue=this.keyValue),this.writeErrors&&(e.writeErrors=this.writeErrors),e}}class x extends y{constructor(e,t={}){super(e,t),this.name="WriteError",this.code=t.code||m.WRITE_CONFLICT}}class b extends y{constructor(e,t={}){super(e,t),this.name="IndexError"}}class w extends b{constructor(e,t={}){super(`Index '${e}' not found`,{...t,code:m.INDEX_NOT_FOUND,index:e}),this.name="IndexNotFoundError",this.indexName=e}}class _ extends y{constructor(e,t={}){super(e,t),this.name="QueryError",this.code=t.code||m.BAD_QUERY}}class v extends y{constructor(e,t={}){super(e,t),this.name="NamespaceError"}}class $ extends y{constructor(e,t={}){super(e,t),this.name="CursorError"}}class S extends y{constructor(e,t={}){super(`${e} is not implemented in micro-mongo`,{...t,code:m.NOT_IMPLEMENTED}),this.name="NotImplementedError",this.feature=e}}class N extends y{constructor(e,t,n,r={}){super(`Bad value for field '${e}': ${n}`,{...r,code:m.BAD_VALUE,field:e}),this.name="BadValueError",this.value=t}}class E{constructor(e,t,n,r,i){if(this.collection=e,this.query=t,this.projection=n,this.documents=r,this.SortedCursor=i,n&&Object.keys(n).length>0){const t=Object.keys(n);let r=!1,i=!1;for(let e=0;e<t.length;e++)"_id"!==t[e]&&(n[t[e]]?r=!0:i=!0);if(r&&i)throw new _("Can't canonicalize query: BadValue Projection cannot have a mix of inclusion and exclusion.",{code:m.FAILED_TO_PARSE,collection:e.name})}this.pos=0,this._limit=0,this._skip=0,this._closed=!1}batchSize(e){return this._batchSize=e,this}close(){this._closed=!0,this.pos=this.documents.length}comment(e){return this._comment=e,this}count(){return this.documents.length}explain(e="queryPlanner"){return{queryPlanner:{plannerVersion:1,namespace:`${this.collection.db?.name||"db"}.${this.collection.name}`,indexFilterSet:!1,parsedQuery:this.query,winningPlan:{stage:"COLLSCAN",filter:this.query,direction:"forward"}},executionStats:"executionStats"===e||"allPlansExecution"===e?{executionSuccess:!0,nReturned:this.documents.length,executionTimeMillis:0,totalKeysExamined:0,totalDocsExamined:this.documents.length}:void 0,ok:1}}async forEach(e){for(;this.hasNext();)await e(this.next())}hasNext(){if(this._closed)return!1;let e;return e=this._limit>0?Math.min(this._skip+this._limit,this.documents.length):this.documents.length,this.pos<e}hint(e){return this._hint=e,this}itcount(){let e=0;for(;this.hasNext();)this.next(),e++;return e}limit(e){return this._limit=e,this}map(e){const t=[];for(;this.hasNext();)t.push(e(this.next()));return t}maxScan(e){return this._maxScan=e,this}maxTimeMS(e){return this._maxTimeMS=e,this}max(e){return this._maxIndexBounds=e,this}min(e){return this._minIndexBounds=e,this}next(){if(!this.hasNext())throw new _("Error: error hasNext: false",{collection:this.collection.name});const e=this.documents[this.pos++];return this.projection?g(this.projection,e):e}noCursorTimeout(){return this._noCursorTimeout=!0,this}objsLeftInBatch(){return this.size()}pretty(){return this._pretty=!0,this}readConcern(e){return this._readConcern=e,this}readPref(e,t){return this._readPref={mode:e,tagSet:t},this}returnKey(e=!0){return this._returnKey=e,this}showRecordId(e=!0){return this._showRecordId=e,this}size(){const e=this.documents.length-this.pos;if(this._limit>0){const t=this._skip+this._limit;return Math.min(t-this.pos,e)}return e}skip(e){return this._skip=e,0===this.pos&&(this.pos=Math.min(e,this.documents.length)),this}isClosed(){return!0===this._closed}snapshot(){throw new S("snapshot")}sort(e){return new this.SortedCursor(this.collection,this.query,this,e)}allowDiskUse(e=!0){return this._allowDiskUse=e,this}collation(e){return this._collation=e,this}tailable(){throw new S("tailable")}async toArray(){const e=[];for(;this.hasNext();)e.push(this.next());return e}async*[Symbol.asyncIterator](){for(;this.hasNext();)yield this.next()}}class A{constructor(e,t,n,r){for(this.collection=e,this.query=t,this.sortSpec=r,this.pos=0,this.items=[];n.hasNext();)this.items.push(n.next());const i=Object.keys(r);this.items.sort(function(e,t){for(let n=0;n<i.length;n++){if(null==e[i[n]]&&null!=t[i[n]])return-1*r[i[n]];if(null!=e[i[n]]&&null==t[i[n]])return 1*r[i[n]];if(e[i[n]]<t[i[n]])return-1*r[i[n]];if(e[i[n]]>t[i[n]])return 1*r[i[n]]}return 0})}batchSize(){throw"Not Implemented"}close(){throw"Not Implemented"}comment(){throw"Not Implemented"}count(){return this.items.length}explain(){throw"Not Implemented"}async forEach(e){for(;this.hasNext();)await e(this.next())}hasNext(){return this.pos<this.items.length}hint(){throw"Not Implemented"}itcount(){throw"Not Implemented"}limit(e){return this.items=this.items.slice(0,e),this}map(e){const t=[];for(;this.hasNext();)t.push(e(this.next()));return t}maxScan(){throw"Not Implemented"}maxTimeMS(){throw"Not Implemented"}max(){throw"Not Implemented"}min(){throw"Not Implemented"}next(){return this.items[this.pos++]}noCursorTimeout(){throw"Not Implemented"}objsLeftInBatch(){throw"Not Implemented"}pretty(){throw"Not Implemented"}readConcern(){throw"Not Implemented"}readPref(){throw"Not Implemented"}returnKey(){throw"Not Implemented"}showRecordId(){throw"Not Implemented"}size(){throw"Not Implemented"}skip(e){for(;e>0;)this.next(),e--;return this}snapshot(){throw"Not Implemented"}sort(e){return new A(this.collection,this.query,this,e)}tailable(){throw"Not Implemented"}async toArray(){const e=[];for(;this.hasNext();)e.push(this.next());return e}async*[Symbol.asyncIterator](){for(;this.hasNext();)yield this.next()}}const I={ational:"ate",tional:"tion",enci:"ence",anci:"ance",izer:"ize",bli:"ble",alli:"al",entli:"ent",eli:"e",ousli:"ous",ization:"ize",ation:"ate",ator:"ate",alism:"al",iveness:"ive",fulness:"ful",ousness:"ous",aliti:"al",iviti:"ive",biliti:"ble",logi:"log"},O={icate:"ic",ative:"",alize:"al",iciti:"ic",ical:"ic",ful:"",ness:""},C="[aeiouy]",k="([^aeiou][^aeiouy]*)",M="("+C+"[aeiou]*)",D=new RegExp("^"+k+"?"+M+k),L=new RegExp("^"+k+"?"+M+k+M+"?$"),T=new RegExp("^"+k+"?("+M+k+"){2,}"),j=new RegExp("^"+k+"?"+C),P=new RegExp("^"+k+C+"[^aeiouwxy]$"),F=/ll$/,R=/^(.+?)e$/,B=/^(.+?)y$/,U=/^(.+?(s|t))(ion)$/,z=/^(.+?)(ed|ing)$/,q=/(at|bl|iz)$/,W=/^(.+?)eed$/,K=/^.+?[^s]s$/,V=/^.+?(ss|i)es$/,Q=/([^aeiouylsz])\1$/,J=/^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$/,H=/^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/,G=/^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$/;function Y(e){let t=String(e).toLowerCase();if(t.length<3)return t;let n,r=!1;return 121===t.codePointAt(0)&&(r=!0,t="Y"+t.slice(1)),V.test(t)?t=t.slice(0,-2):K.test(t)&&(t=t.slice(0,-1)),(n=W.exec(t))?D.test(n[1])&&(t=t.slice(0,-1)):(n=z.exec(t))&&j.test(n[1])&&(t=n[1],q.test(t)?t+="e":Q.test(t)?t=t.slice(0,-1):P.test(t)&&(t+="e")),(n=B.exec(t))&&j.test(n[1])&&(t=n[1]+"i"),(n=J.exec(t))&&D.test(n[1])&&(t=n[1]+I[n[2]]),(n=H.exec(t))&&D.test(n[1])&&(t=n[1]+O[n[2]]),(n=G.exec(t))?T.test(n[1])&&(t=n[1]):(n=U.exec(t))&&T.test(n[1])&&(t=n[1]),(n=R.exec(t))&&(T.test(n[1])||L.test(n[1])&&!P.test(n[1]))&&(t=n[1]),F.test(t)&&T.test(t)&&(t=t.slice(0,-1)),r&&(t="y"+t.slice(1)),t}class X{constructor(e){if(this._meta=new Map,this._data=new Map,e)for(const[t,n]of Object.entries(e))this._meta.set(t,n)}setMeta(e,t){this._meta.set(e,t)}hasMeta(e){return this._meta.has(e)}getMeta(e){return this._meta.get(e)}hasDataMap(e){return this._data.has(e)}getDataMap(e){return this._data.has(e)||this._data.set(e,new Map),this._data.get(e)}}const Z=new Set(["a","about","after","all","also","am","an","and","another","any","are","around","as","at","be","because","been","before","being","between","both","but","by","came","can","come","could","did","do","each","for","from","get","got","has","had","he","have","her","here","him","himself","his","how","i","if","in","into","is","it","like","make","many","me","might","more","most","much","must","my","never","now","of","on","only","or","other","our","out","over","said","same","see","should","since","some","still","such","take","than","that","the","their","them","then","there","these","they","this","those","through","to","too","under","up","very","was","way","we","well","were","what","where","which","while","who","with","would","you","your"]);class ee{constructor(e=new X){this.storage=e,this.index=this.storage.getDataMap("index"),this.documentTerms=this.storage.getDataMap("documentTerms"),this.documentLengths=this.storage.getDataMap("documentLengths")}_tokenize(e){if("string"!=typeof e)return[];return e.toLowerCase().split(/\W+/).filter(e=>e.length>0).filter(e=>!Z.has(e))}add(e,t){if(!e)throw new Error("Document ID is required");const n=this._tokenize(t),r=new Map;n.forEach(e=>{const t=Y(e);r.set(t,(r.get(t)||0)+1)}),r.forEach((t,n)=>{this.index.has(n)||this.index.set(n,new Map),this.index.get(n).set(e,t)}),this.documentTerms.set(e,r),this.documentLengths.set(e,n.length)}remove(e){if(!this.documentTerms.has(e))return!1;return this.documentTerms.get(e).forEach((t,n)=>{this.index.has(n)&&(this.index.get(n).delete(e),0===this.index.get(n).size&&this.index.delete(n))}),this.documentTerms.delete(e),this.documentLengths.delete(e),!0}query(e,t={scored:!0,requireAll:!1}){const n=this._tokenize(e);if(0===n.length)return[];const r=n.map(e=>Y(e)),i=[...new Set(r)];if(t.requireAll){const e=i.map(e=>{const t=this.index.get(e);return t?new Set(t.keys()):new Set});if(0===e.length)return[];const t=new Set(e[0]);for(let n=1;n<e.length;n++)for(const r of t)e[n].has(r)||t.delete(r);return Array.from(t)}const s=this.documentLengths.size,o=new Map;i.forEach(e=>{const t=this.index.get(e)?.size||0;t>0&&o.set(e,Math.log(s/t))});const a=new Map;i.forEach(e=>{const t=this.index.get(e);t&&t.forEach((t,n)=>{a.has(n)||a.set(n,0);const r=t/(this.documentLengths.get(n)||1)*(o.get(e)||0);a.set(n,a.get(n)+r)})}),a.forEach((e,t)=>{const n=this.documentTerms.get(t);if(n){const r=i.filter(e=>n.has(e)).length/i.length;a.set(t,e*(1+r))}});const l=Array.from(a.entries()).map(([e,t])=>({id:e,score:t})).sort((e,t)=>t.score-e.score);return!1===t.scored?l.map(e=>e.id):l}getTermCount(){return this.index.size}getDocumentCount(){return this.documentTerms.size}clear(){this.index.clear(),this.documentTerms.clear(),this.documentLengths.clear()}}function te(e,t){if(null==e)return e;if("boolean"==typeof e||"number"==typeof e)return e;if("string"==typeof e)return e.startsWith("$$")?"$$KEEP"===e||"$$PRUNE"===e||"$$DESCEND"===e?e:a(t,e.substring(2)):"$"===e.charAt(0)?a(t,e.substring(1)):e;if("object"==typeof e){if(Array.isArray(e))return e.map(e=>te(e,t));const n=Object.keys(e);if(0===n.length)return e;const r=n[0];if("$"===r.charAt(0)){return function(e,t,n){switch(e){case"$add":return function(e,t){if(!Array.isArray(e))return null;let n=0;for(const r of e){const e=te(r,t);e instanceof Date?n+=e.getTime():"number"==typeof e&&(n+=e)}return n}(t,n);case"$subtract":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=te(e[0],t),r=te(e[1],t);if(n instanceof Date&&r instanceof Date)return n.getTime()-r.getTime();if(n instanceof Date&&"number"==typeof r)return new Date(n.getTime()-r);if("number"==typeof n&&"number"==typeof r)return n-r;return null}(t,n);case"$multiply":return function(e,t){if(!Array.isArray(e))return null;let n=1;for(const r of e){const e=te(r,t);"number"==typeof e&&(n*=e)}return n}(t,n);case"$divide":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=te(e[0],t),r=te(e[1],t);if("number"==typeof n&&"number"==typeof r&&0!==r)return n/r;return null}(t,n);case"$mod":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=te(e[0],t),r=te(e[1],t);if("number"==typeof n&&"number"==typeof r&&0!==r)return n%r;return null}(t,n);case"$pow":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=te(e[0],t),r=te(e[1],t);if("number"==typeof n&&"number"==typeof r)return Math.pow(n,r);return null}(t,n);case"$sqrt":return function(e,t){const n=te(e,t);if("number"==typeof n&&n>=0)return Math.sqrt(n);return null}(t,n);case"$abs":return function(e,t){const n=te(e,t);if("number"==typeof n)return Math.abs(n);return null}(t,n);case"$ceil":return function(e,t){const n=te(e,t);if("number"==typeof n)return Math.ceil(n);return null}(t,n);case"$floor":return function(e,t){const n=te(e,t);if("number"==typeof n)return Math.floor(n);return null}(t,n);case"$trunc":return function(e,t){const n=te(e,t);if("number"==typeof n)return Math.trunc(n);return null}(t,n);case"$round":return function(e,t){const n=te(Array.isArray(e)?e[0]:e,t),r=Array.isArray(e)&&void 0!==e[1]?te(e[1],t):0;if("number"==typeof n&&"number"==typeof r){const e=Math.pow(10,r);return Math.round(n*e)/e}return null}(t,n);case"$concat":return function(e,t){if(!Array.isArray(e))return null;let n="";for(const r of e){const e=te(r,t);null!=e&&(n+=String(e))}return n}(t,n);case"$substr":return function(e,t){if(!Array.isArray(e)||e.length<3)return null;const n=String(te(e[0],t)||""),r=te(e[1],t),i=te(e[2],t);if("number"==typeof r&&"number"==typeof i)return n.substr(r,i);return null}(t,n);case"$toLower":return function(e,t){const n=te(e,t);return null!=n?String(n).toLowerCase():""}(t,n);case"$toUpper":return function(e,t){const n=te(e,t);return null!=n?String(n).toUpperCase():""}(t,n);case"$trim":return function(e,t){const n=te("object"==typeof e&&e.input?e.input:e,t),r=e.chars?te(e.chars,t):null;let i=null!=n?String(n):"";if(r){const e=new RegExp(`^[${ne(r)}]+|[${ne(r)}]+$`,"g");return i.replace(e,"")}return i.trim()}(t,n);case"$ltrim":return function(e,t){const n=te("object"==typeof e&&e.input?e.input:e,t),r=e.chars?te(e.chars,t):null;let i=null!=n?String(n):"";if(r){const e=new RegExp(`^[${ne(r)}]+`,"g");return i.replace(e,"")}return i.replace(/^\s+/,"")}(t,n);case"$rtrim":return function(e,t){const n=te("object"==typeof e&&e.input?e.input:e,t),r=e.chars?te(e.chars,t):null;let i=null!=n?String(n):"";if(r){const e=new RegExp(`[${ne(r)}]+$`,"g");return i.replace(e,"")}return i.replace(/\s+$/,"")}(t,n);case"$split":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=String(te(e[0],t)||""),r=String(te(e[1],t)||"");return n.split(r)}(t,n);case"$strLenCP":return function(e,t){const n=te(e,t);return null!=n?String(n).length:0}(t,n);case"$strcasecmp":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=String(te(e[0],t)||"").toLowerCase(),r=String(te(e[1],t)||"").toLowerCase();return n<r?-1:n>r?1:0}(t,n);case"$indexOfCP":return function(e,t){if(!Array.isArray(e)||e.length<2)return null;const n=String(te(e[0],t)||""),r=String(te(e[1],t)||""),i=void 0!==e[2]?te(e[2],t):0,s=void 0!==e[3]?te(e[3],t):n.length,o=n.substring(i,s).indexOf(r);return-1===o?-1:o+i}(t,n);case"$replaceOne":return function(e,t){const n=String(te(e.input,t)||""),r=String(te(e.find,t)||""),i=String(te(e.replacement,t)||"");return n.replace(r,i)}(t,n);case"$replaceAll":return function(e,t){const n=String(te(e.input,t)||""),r=String(te(e.find,t)||""),i=String(te(e.replacement,t)||"");return n.split(r).join(i)}(t,n);case"$cmp":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=te(e[0],t),r=te(e[1],t);return n<r?-1:n>r?1:0}(t,n);case"$eq":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=te(e[0],t),r=te(e[1],t);return n===r}(t,n);case"$ne":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=te(e[0],t),r=te(e[1],t);return n!==r}(t,n);case"$gt":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=te(e[0],t),r=te(e[1],t);return n>r}(t,n);case"$gte":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=te(e[0],t),r=te(e[1],t);return n>=r}(t,n);case"$lt":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=te(e[0],t),r=te(e[1],t);return n<r}(t,n);case"$lte":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=te(e[0],t),r=te(e[1],t);return n<=r}(t,n);case"$and":return function(e,t){if(!Array.isArray(e))return null;for(const n of e){if(!te(n,t))return!1}return!0}(t,n);case"$or":return function(e,t){if(!Array.isArray(e))return null;for(const n of e){if(te(n,t))return!0}return!1}(t,n);case"$not":return function(e,t){const n=te(Array.isArray(e)?e[0]:e,t);return!n}(t,n);case"$cond":return function(e,t){let n,r,i;if(Array.isArray(e)){if(3!==e.length)return null;[n,r,i]=e}else{if("object"!=typeof e)return null;n=e.if,r=e.then,i=e.else}const s=te(n,t);return te(s?r:i,t)}(t,n);case"$ifNull":return function(e,t){if(!Array.isArray(e)||e.length<2)return null;for(let n=0;n<e.length;n++){const r=te(e[n],t);if(null!=r)return r}return null}(t,n);case"$switch":return function(e,t){if("object"!=typeof e||!Array.isArray(e.branches))return null;for(const n of e.branches){if(te(n.case,t))return te(n.then,t)}return void 0!==e.default?te(e.default,t):null}(t,n);case"$year":return function(e,t){const n=te(e,t);if(n instanceof Date)return n.getUTCFullYear();return null}(t,n);case"$month":return function(e,t){const n=te(e,t);if(n instanceof Date)return n.getUTCMonth()+1;return null}(t,n);case"$dayOfMonth":return function(e,t){const n=te(e,t);if(n instanceof Date)return n.getUTCDate();return null}(t,n);case"$dayOfWeek":return function(e,t){const n=te(e,t);if(n instanceof Date)return n.getUTCDay()+1;return null}(t,n);case"$dayOfYear":return function(e,t){const n=te(e,t);if(n instanceof Date){const e=new Date(Date.UTC(n.getUTCFullYear(),0,0)),t=n-e,r=864e5;return Math.floor(t/r)}return null}(t,n);case"$hour":return function(e,t){const n=te(e,t);if(n instanceof Date)return n.getUTCHours();return null}(t,n);case"$minute":return function(e,t){const n=te(e,t);if(n instanceof Date)return n.getUTCMinutes();return null}(t,n);case"$second":return function(e,t){const n=te(e,t);if(n instanceof Date)return n.getUTCSeconds();return null}(t,n);case"$millisecond":return function(e,t){const n=te(e,t);if(n instanceof Date)return n.getUTCMilliseconds();return null}(t,n);case"$week":return function(e,t){const n=te(e,t);if(n instanceof Date){const e=new Date(Date.UTC(n.getUTCFullYear(),0,1));return Math.ceil(((n-e)/864e5+e.getUTCDay()+1)/7)-1}return null}(t,n);case"$isoWeek":return function(e,t){const n=te(e,t);if(n instanceof Date){const e=new Date(n.valueOf()),t=(n.getUTCDay()+6)%7;e.setUTCDate(e.getUTCDate()-t+3);const r=e.valueOf();return e.setUTCMonth(0,1),4!==e.getUTCDay()&&e.setUTCMonth(0,1+(4-e.getUTCDay()+7)%7),1+Math.ceil((r-e)/6048e5)}return null}(t,n);case"$isoWeekYear":return function(e,t){const n=te(e,t);if(n instanceof Date){const e=new Date(n.valueOf());return e.setUTCDate(e.getUTCDate()-(n.getUTCDay()+6)%7+3),e.getUTCFullYear()}return null}(t,n);case"$dateToString":return function(e,t){const n=e.format?te(e.format,t):"%Y-%m-%dT%H:%M:%S.%LZ",r=te(e.date,t);return r instanceof Date?n.replace("%Y",r.getUTCFullYear()).replace("%m",String(r.getUTCMonth()+1).padStart(2,"0")).replace("%d",String(r.getUTCDate()).padStart(2,"0")).replace("%H",String(r.getUTCHours()).padStart(2,"0")).replace("%M",String(r.getUTCMinutes()).padStart(2,"0")).replace("%S",String(r.getUTCSeconds()).padStart(2,"0")).replace("%L",String(r.getUTCMilliseconds()).padStart(3,"0")):null}(t,n);case"$toDate":return function(e,t){const n=te(e,t);if(n instanceof Date)return n;if("string"==typeof n||"number"==typeof n){const e=new Date(n);return isNaN(e.getTime())?null:e}return null}(t,n);case"$arrayElemAt":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=te(e[0],t),r=te(e[1],t);if(!Array.isArray(n)||"number"!=typeof r)return null;const i=r<0?n.length+r:r;return n[i]}(t,n);case"$concatArrays":return function(e,t){if(!Array.isArray(e))return null;const n=[];for(const r of e){const e=te(r,t);Array.isArray(e)&&n.push(...e)}return n}(t,n);case"$filter":return function(e,t){const n=te(e.input,t),r=e.as||"this",i=e.cond;return Array.isArray(n)?n.filter(e=>{const n={...t,[r]:e};return te(i,n)}):null}(t,n);case"$in":return function(e,t){if(!Array.isArray(e)||2!==e.length)return null;const n=te(e[0],t),r=te(e[1],t);return!!Array.isArray(r)&&r.includes(n)}(t,n);case"$indexOfArray":return function(e,t){if(!Array.isArray(e)||e.length<2)return null;const n=te(e[0],t),r=te(e[1],t),i=void 0!==e[2]?te(e[2],t):0,s=void 0!==e[3]?te(e[3],t):n.length;if(!Array.isArray(n))return null;for(let o=i;o<s&&o<n.length;o++)if(n[o]===r)return o;return-1}(t,n);case"$isArray":return function(e,t){const n=te(e,t);return Array.isArray(n)}(t,n);case"$map":return function(e,t){const n=te(e.input,t),r=e.as||"this",i=e.in;return Array.isArray(n)?n.map(e=>{const n={...t,[r]:e};return te(i,n)}):null}(t,n);case"$reduce":return function(e,t){const n=te(e.input,t),r=te(e.initialValue,t),i=e.in;if(!Array.isArray(n))return null;let s=r;for(const o of n){s=te(i,{...t,value:s,this:o})}return s}(t,n);case"$size":return function(e,t){const n=te(e,t);return Array.isArray(n)?n.length:null}(t,n);case"$slice":return function(e,t){if(!Array.isArray(e)||e.length<2)return null;const n=te(e[0],t);if(!Array.isArray(n))return null;if(2===e.length){const r=te(e[1],t);return r>=0?n.slice(0,r):n.slice(r)}{const r=te(e[1],t),i=te(e[2],t);return n.slice(r,r+i)}}(t,n);case"$reverseArray":return function(e,t){const n=te(e,t);return Array.isArray(n)?n.slice().reverse():null}(t,n);case"$zip":return function(e,t){const n=e.inputs?te(e.inputs,t):null,r=e.useLongestLength||!1,i=e.defaults;if(!Array.isArray(n))return null;const s=n.map(e=>te(e,t));if(!s.every(e=>Array.isArray(e)))return null;const o=Math.max(...s.map(e=>e.length)),a=r?o:Math.min(...s.map(e=>e.length)),l=[];for(let c=0;c<a;c++){const e=[];for(let t=0;t<s.length;t++)c<s[t].length?e.push(s[t][c]):i&&t<i.length?e.push(i[t]):e.push(null);l.push(e)}return l}(t,n);case"$type":return function(e,t){const n=te(e,t);return null===n?"null":void 0===n?"missing":"boolean"==typeof n?"bool":"number"==typeof n?Number.isInteger(n)?"int":"double":"string"==typeof n?"string":n instanceof Date?"date":Array.isArray(n)?"array":"object"==typeof n?"object":"unknown"}(t,n);case"$convert":return function(e,t){const n=te(e.input,t),r=e.to,i=e.onError,s=e.onNull;if(null===n)return void 0!==s?te(s,t):null;try{switch(r){case"double":case"decimal":return parseFloat(n);case"int":case"long":return parseInt(n);case"bool":return Boolean(n);case"string":return String(n);case"date":return new Date(n);default:return n}}catch(o){return void 0!==i?te(i,t):null}}(t,n);case"$toBool":return function(e,t){const n=te(e,t);return Boolean(n)}(t,n);case"$toDecimal":return function(e,t){const n=te(e,t);return parseFloat(n)}(t,n);case"$toDouble":return function(e,t){const n=te(e,t);return parseFloat(n)}(t,n);case"$toInt":return function(e,t){const n=te(e,t);return parseInt(n)}(t,n);case"$toLong":return function(e,t){const n=te(e,t);return parseInt(n)}(t,n);case"$toString":return function(e,t){const n=te(e,t);return null==n?null:String(n)}(t,n);case"$objectToArray":return function(e,t){const n=te(e,t);if("object"!=typeof n||null===n||Array.isArray(n))return null;return Object.keys(n).map(e=>({k:e,v:n[e]}))}(t,n);case"$arrayToObject":return function(e,t){const n=te(e,t);if(!Array.isArray(n))return null;const r={};for(const i of n)Array.isArray(i)&&2===i.length?r[i[0]]=i[1]:"object"==typeof i&&void 0!==i.k&&void 0!==i.v&&(r[i.k]=i.v);return r}(t,n);case"$mergeObjects":return function(e,t){if(!Array.isArray(e))return te(e,t);const n={};for(const r of e){const e=te(r,t);"object"!=typeof e||null===e||Array.isArray(e)||Object.assign(n,e)}return n}(t,n);case"$literal":return t;default:throw new Error(`Unsupported aggregation operator: ${e}`)}}(r,e[r],t)}{const r={};for(const i of n)r[i]=te(e[i],t);return r}}return e}function ne(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}const re={1:"double",2:"string",3:"object",4:"array",5:"binData",6:"undefined",7:"objectId",8:"bool",9:"date",10:"null",11:"regex",13:"javascript",15:"javascriptWithScope",16:"int",17:"timestamp",18:"long",19:"decimal",127:"maxKey","-1":"minKey"},ie=Object.entries(re).reduce((e,[t,n])=>(e[n]=parseInt(t),e),{});function se(e,t){if(u(t)){for(let n=0;n<t.length;n++)if(se(e,t[n]))return!0;return!1}const n="number"==typeof t?t:ie[t],r=re[n]||t;return null===e?"null"===r||10===n:void 0===e?"undefined"===r||6===n:"number"==typeof e?Number.isInteger(e)?"int"===r||16===n:"double"===r||1===n:"string"==typeof e?"string"===r||2===n:"boolean"==typeof e?"bool"===r||8===n:e instanceof Date?"date"===r||9===n:e instanceof i?"objectId"===r||7===n:e instanceof RegExp?"regex"===r||11===n:u(e)?"array"===r||4===n:"object"==typeof e?"object"===r||3===n:typeof e===t}function oe(e){if(u(e)){let t=0;for(let n=0;n<e.length;n++)t|=1<<e[n];return t}return"number"==typeof e?e:0}function ae(e,t){if("number"!=typeof e)return!1;const n=oe(t);return(e&n)===n}function le(e,t){if("number"!=typeof e)return!1;return 0===(e&oe(t))}function ce(e,t){if("number"!=typeof e)return!1;return 0!==(e&oe(t))}function ue(e,t){if("number"!=typeof e)return!1;const n=oe(t);return(e&n)!==n}function he(e,t){if(t.type){const n=u(e)?"array":null===e?"null":typeof e;if(t.type!==n)return!1}if(t.required&&u(t.required))for(let n=0;n<t.required.length;n++)if(!(t.required[n]in e))return!1;if(t.properties)for(const n in t.properties){if(!(n in e))return!1;const r=t.properties[n];if(!he(e[n],r))return!1}if(void 0!==t.minimum&&"number"==typeof e&&e<t.minimum)return!1;if(void 0!==t.maximum&&"number"==typeof e&&e>t.maximum)return!1;if(void 0!==t.minLength&&"string"==typeof e&&e.length<t.minLength)return!1;if(void 0!==t.maxLength&&"string"==typeof e&&e.length>t.maxLength)return!1;if(t.pattern&&"string"==typeof e){if(!new RegExp(t.pattern).test(e))return!1}return!(t.enum&&u(t.enum)&&!t.enum.includes(e))}function de(e,t){return e instanceof i&&t instanceof i?e.equals(t):e==t}function fe(e,t,n){let r=e,s=t;switch(e instanceof i&&(r=e.toString()),t instanceof i&&(s=t.toString()),n){case">":return r>s;case">=":return r>=s;case"<":return r<s;case"<=":return r<=s;default:return!1}}function pe(e,t){if(void 0===e)return!1;if(null===e)return t(e);if(u(e)){for(var n=0;n<e.length;n++)if(t(e[n]))return!0;return!1}return t(e)}function ge(e,t){const n=new ee;n.add("id",e);return 1===n.query(t,{scored:!1}).length}function me(e,t){try{if(!Array.isArray(t)||2!==t.length)return!1;const n=t[0][0],r=t[0][1],i=t[1][0];return ye(e,n,i,t[1][1],r)}catch(n){return!1}}function ye(e,t,n,r,i){if(!e)return!1;if("FeatureCollection"===e.type&&e.features&&e.features.length>0){for(const s of e.features)if(s.geometry&&!ye(s.geometry,t,n,r,i))return!1;return!0}if("Feature"===e.type&&e.geometry)return ye(e.geometry,t,n,r,i);if("Point"===e.type&&e.coordinates){const[s,o]=e.coordinates;if("number"==typeof s&&"number"==typeof o)return s>=t&&s<=n&&o>=r&&o<=i}if("Polygon"===e.type&&e.coordinates&&e.coordinates.length>0){for(const s of e.coordinates)for(const e of s){const s=e[0],o=e[1];if(s<t||s>n||o<r||o>i)return!1}return!0}return!1}function xe(e,t){if("function"==typeof t)try{return t.call(e)}catch(n){return!1}else if("string"==typeof t)try{return new Function("return "+t).call(e)}catch(n){return!1}return!1}function be(e,t){var n=Object.keys(t)[0],r=t[n];if("$"!=n.charAt(0))return we(e,n,r);if("$and"==n)return _e(e,r);if("$or"==n)return function(e,t){for(var n=0;n<t.length;n++)if(be(e,t[n]))return!0;return!1}(e,r);if("$not"==n)return function(e,t){return!be(e,t)}(e,r);if("$nor"==n)return function(e,t){for(var n=0;n<t.length;n++)if(be(e,t[n]))return!1;return!0}(e,r);if("$where"==n)return xe(e,r);if("$comment"==n)return!0;if("$jsonSchema"==n)return he(e,r);if("$expr"!=n)throw{$err:"Can't canonicalize query: BadValue unknown top level operator: "+n,code:17287};try{return te(r,e)}catch(i){return!1}}function we(e,t,n){var r=l(e,t);if("string"==typeof n)return pe(r,function(e){return de(e,n)});if("number"==typeof n)return pe(r,function(e){return de(e,n)});if("boolean"==typeof n)return pe(r,function(e){return de(e,n)});if(n instanceof i)return pe(r,function(e){return de(e,n)});if("object"==typeof n){if(n instanceof RegExp)return null!=r&&pe(r,function(e){return e&&e.match(n)});if(u(n))return null!=r&&pe(r,function(e){return e&&f(e,n)});var s=Object.keys(n);if("$"==s[0].charAt(0)){for(var o=0;o<s.length;o++){var c=Object.keys(n)[o],h=n[c];if("$eq"==c){if(!pe(r,function(e){return de(e,h)}))return!1}else if("$gt"==c){if(!pe(r,function(e){return fe(e,h,">")}))return!1}else if("$gte"==c){if(!pe(r,function(e){return fe(e,h,">=")}))return!1}else if("$lt"==c){if(!pe(r,function(e){return fe(e,h,"<")}))return!1}else if("$lte"==c){if(!pe(r,function(e){return fe(e,h,"<=")}))return!1}else if("$ne"==c){if(!pe(r,function(e){return!de(e,h)}))return!1}else if("$in"==c){if(!pe(r,function(e){return d(e,h)}))return!1}else if("$nin"==c){if(pe(r,function(e){return d(e,h)}))return!1}else if("$exists"==c){var g=a(e,t);if(h?null==g:null!=g)return!1}else if("$type"==c){if(void 0===r){if(6!==("number"==typeof h?h:ie[h]))return!1}else if(!se(r,h))return!1}else if("$mod"==c){if(2!=h.length)throw{$err:"Can't canonicalize query: BadValue malformed mod, not enough elements",code:17287};if(!pe(r,function(e){return null!=e&&e%h[0]==h[1]}))return!1}else if("$regex"==c){var m=h,y=n.$options||"",x="string"==typeof m?new RegExp(m,y):m;if(!pe(r,function(e){return null!=e&&x.test(e)}))return!1}else{if("$options"==c)continue;if("$text"==c){if(!pe(r,function(e){return null!=e&&ge(e,h)}))return!1}else if("$expr"==c)try{if(!te(h,e))return!1}catch(O){return!1}else if("$geoWithin"==c){if(!pe(r,function(e){return null!=e&&me(e,h)}))return!1}else if("$near"==c||"$nearSphere"==c||"$geoIntersects"==c);else if("$not"==c){if(we(e,t,h))return!1}else if("$all"==c){if(null==(w=a(e,t))||!u(w))return!1;for(var b=0;b<h.length;b++)if(!d(h[b],w))return!1}else if("$elemMatch"==c){var w;if(null==(w=a(e,t))||!u(w))return!1;var _=!1;for(b=0;b<w.length;b++){var v=w[b];if("object"!=typeof v||u(v)){for(var $=!0,S=Object.keys(h),N=0;N<S.length;N++){var E=S[N],A=h[E];("$gte"!=E||v>=A)&&("$gt"!=E||v>A)&&("$lte"!=E||v<=A)&&("$lt"!=E||v<A)?"$eq"==E&&v!=A||"$ne"==E&&v==A?$=!1:"$in"!=E||d(v,A)?"$nin"==E&&d(v,A)&&($=!1):$=!1:$=!1}if($){_=!0;break}}else if(ve(v,h)){_=!0;break}}if(!_)return!1}else if("$size"==c){var I=a(e,t);if(null==I||!u(I))return!1;if(I.length!=h)return!1}else if("$bitsAllSet"==c){if(!pe(r,function(e){return ae(e,h)}))return!1}else if("$bitsAllClear"==c){if(!pe(r,function(e){return le(e,h)}))return!1}else if("$bitsAnySet"==c){if(!pe(r,function(e){return ce(e,h)}))return!1}else{if("$bitsAnyClear"!=c)throw{$err:"Can't canonicalize query: BadValue unknown operator: "+c,code:17287};if(!pe(r,function(e){return ue(e,h)}))return!1}}}return!0}return a(e,t)&&p(a(e,t),n)}}function _e(e,t){for(var n=0;n<t.length;n++)if(!be(e,t[n]))return!1;return!0}function ve(e,t){return _e(e,h(t))}function $e(e,t){const n={};return{matched:Se(e,h(t),n),arrayFilters:n}}function Se(e,t,n){for(var r=0;r<t.length;r++)if(!Ne(e,t[r],n))return!1;return!0}function Ne(e,t,n){var r=Object.keys(t)[0],s=t[r];if("$"!=r.charAt(0))return function(e,t,n,r){const s=t.split(".")[0],o=l(e,t),c=(n,i)=>{if(void 0===n)return!1;if(null===n)return i(n);if(u(n)){if(u(a(e,s))){for(var o=0;o<n.length;o++)if(i(n[o]))return r[t]=o,!0;return!1}}return pe(n,i)};if("string"==typeof n)return c(o,function(e){return de(e,n)});if("number"==typeof n)return c(o,function(e){return de(e,n)});if("boolean"==typeof n)return c(o,function(e){return de(e,n)});if(n instanceof i)return c(o,function(e){return de(e,n)});if("object"==typeof n){if(n instanceof RegExp)return null!=o&&c(o,function(e){return e&&e.match(n)});if(u(n))return null!=o&&c(o,function(e){return e&&f(e,n)});var h=Object.keys(n);if("$"==h[0].charAt(0)){for(var g=0;g<h.length;g++){var m=h[g],y=n[m];if("$eq"==m){if(!c(o,function(e){return de(e,y)}))return!1}else if("$gt"==m){if(!c(o,function(e){return fe(e,y,">")}))return!1}else if("$gte"==m){if(!c(o,function(e){return fe(e,y,">=")}))return!1}else if("$lt"==m){if(!c(o,function(e){return fe(e,y,"<")}))return!1}else if("$lte"==m){if(!c(o,function(e){return fe(e,y,"<=")}))return!1}else if("$ne"==m){if(!c(o,function(e){return!de(e,y)}))return!1}else if("$in"==m){if(!c(o,function(e){return d(e,y)}))return!1}else if("$nin"==m){if(c(o,function(e){return d(e,y)}))return!1}else{if("$elemMatch"==m){var x=a(e,t);if(null==x||!u(x))return!1;for(var b=0;b<x.length;b++){var w=x[b];if("object"!=typeof w||u(w)){for(var _=!0,v=Object.keys(y),$=0;$<v.length;$++){var S=v[$],N=y[S];("$gte"!=S||w>=N)&&("$gt"!=S||w>N)&&("$lte"!=S||w<=N)&&("$lt"!=S||w<N)?("$eq"==S&&w!=N||"$ne"==S&&w==N)&&(_=!1):_=!1}if(_)return r[t]=b,!0}else if(ve(w,y))return r[t]=b,!0}return!1}if(!we(e,t,n))return!1}}return!0}return null!=o&&c(o,function(e){return p(e,n)})}return!1}(e,r,s,n);if("$and"==r)return Se(e,s,n);if("$or"==r)return function(e,t,n){for(var r=0;r<t.length;r++)if(Ne(e,t[r],n))return!0;return!1}(e,s,n);if("$not"==r)return!be(e,s);if("$nor"==r)return function(e,t,n){for(var r=0;r<t.length;r++)if(Ne(e,t[r],n))return!1;return!0}(e,s,n);if("$where"==r)return xe(e,s);if("$comment"==r)return!0;if("$jsonSchema"==r)return he(e,s);if("$expr"!=r)throw{$err:"Can't canonicalize query: BadValue unknown top level operator: "+r,code:17287};try{return te(s,e)}catch(o){return!1}}class Ee{constructor(e,t){0===arguments.length?(this.low=0,this.high=Math.floor(Date.now()/1e3)):1===arguments.length?"object"==typeof e&&null!==e?(this.low=e.low||0,this.high=e.high||0):(this.low=0,this.high=e):(this.low=e>>>0,this.high=t>>>0)}valueOf(){return 4294967296*this.high+this.low}toString(){return`Timestamp(${this.high}, ${this.low})`}toJSON(){return{$timestamp:{t:this.high,i:this.low}}}inspect(){return this.toString()}equals(e){return!!e&&((e instanceof Ee||"object"==typeof e&&void 0!==e.low&&void 0!==e.high)&&this.low===e.low&&this.high===e.high)}getHighBits(){return this.high}getLowBits(){return this.low}toDate(){return new Date(1e3*this.high)}static fromDate(e){const t=Math.floor(e.getTime()/1e3);return new Ee(0,t)}static now(){return new Ee}}function Ae(e){return e.split(".").map(e=>{const t=function(e){const t=e.match(/^\$\[([^\]]+)\]$/);return t?t[1]:null}(e);return{segment:e,isFilteredPositional:null!==t,identifier:t}})}function Ie(e,t,n,r,i){!function e(s,o,a){if(o>=t.length)return;const l=t[o],c=o===t.length-1;if(l.isFilteredPositional){const a=l.identifier,h=i?i.find(e=>Object.keys(e).some(e=>e.startsWith(a+".")||e===a)):null;if(!i){if(!s[l.segment]){const e=t[o+1];e&&e.isFilteredPositional?s[l.segment]=[]:s[l.segment]={}}return void(c?Oe(s,l.segment,n,r):e(s[l.segment],o+1))}if(!u(s))return s[l.segment]||(s[l.segment]={}),void(c?Oe(s,l.segment,n,r):e(s[l.segment],o+1));for(let t=0;t<s.length;t++){const i=s[t];let l=!0;if(h){let e={},t=!1;if(Object.keys(h).forEach(n=>{if(n.startsWith(a+".")){const t=n.substring(a.length+1);e[t]=h[n]}else n===a&&(e=h[n],t=!0)}),t){l=ve({value:i},{value:e})}else l=ve(i,e)}l&&(c?Oe(s,t,n,r):null!=i&&e(s[t],o+1))}}else{if((void 0===s[l.segment]||null===s[l.segment])&&!c){const e=t[o+1];e&&e.isFilteredPositional?s[l.segment]=[]:s[l.segment]={}}c?Oe(s,l.segment,n,r):void 0!==s[l.segment]&&null!==s[l.segment]&&e(s[l.segment],o+1)}}(e,0)}function Oe(e,t,n,r){switch(r){case"$set":default:e[t]=n;break;case"$inc":void 0===e[t]&&(e[t]=0),e[t]+=n;break;case"$mul":e[t]=e[t]*n;break;case"$min":e[t]=Math.min(e[t],n);break;case"$max":e[t]=Math.max(e[t],n);break;case"$unset":delete e[t]}}function Ce(e){return/\$\[[^\]]+\]/.test(e)}function ke(e){return-1!==e.indexOf("$[]")}function Me(e,t,n){for(var r=t.split("."),i=e,s=0;s<r.length;s++){var o=r[s];if("$[]"===o){if(!Array.isArray(i))return;for(var l=r.slice(s+1).join("."),u=0;u<i.length;u++)if(l)if(-1!==l.indexOf("$[]"))Me(i[u],l,n);else{var h=n(a(i[u],l));c(i[u],l,h)}else i[u]=n(i[u]);return}if(null==i||null==i)return;i=i[o]}}function De(e,t){if(!t||!e.includes("$"))return e;const n=e.split("."),r=n.indexOf("$");if(-1===r)return e;const i=n.slice(0,r).join(".");let s=null;for(const o in t)if(o===i||o.startsWith(i+".")){s=t[o];break}return null!=s?(n[r]=s.toString(),n.join(".")):e}function Le(e,t,n,r,i){for(var s=Object.keys(e),o=0;o<s.length;o++){var l=s[o],u=e[l];if("$inc"==l)for(var h=Object.keys(u),d=0;d<h.length;d++){var f=De(h[d],r),p=u[h[d]];if(Ce(f)){Ie(t,Ae(f),p,"$inc",i)}else if(ke(f))Me(t,f,function(e){return(void 0===e?0:e)+p});else{null==(g=a(t,f))&&(g=0),c(t,f,g+p)}}else if("$mul"==l)for(h=Object.keys(u),d=0;d<h.length;d++){f=De(h[d],r),p=u[h[d]];if(Ce(f)){Ie(t,Ae(f),p,"$mul",i)}else if(ke(f))Me(t,f,function(e){return e*p});else{null==(g=a(t,f))&&(g=0),c(t,f,g*p)}}else if("$rename"==l)for(h=Object.keys(u),d=0;d<h.length;d++){f=De(h[d],r);t[De(u[h[d]],r)]=t[f],delete t[f]}else if("$setOnInsert"==l&&n)for(h=Object.keys(u),d=0;d<h.length;d++){t[f=De(h[d],r)]=u[h[d]]}else if("$set"==l)for(h=Object.keys(u),d=0;d<h.length;d++){if(Ce(f=De(h[d],r))){Ie(t,Ae(f),u[h[d]],"$set",i)}else c(t,f,u[h[d]])}else if("$unset"==l)for(h=Object.keys(u),d=0;d<h.length;d++){delete t[f=De(h[d],r)]}else if("$min"==l)for(h=Object.keys(u),d=0;d<h.length;d++){f=De(h[d],r),p=u[h[d]];if(Ce(f)){Ie(t,Ae(f),p,"$min",i)}else if(ke(f))Me(t,f,function(e){return Math.min(e,p)});else{var g=a(t,f);c(t,f,Math.min(g,p))}}else if("$max"==l)for(h=Object.keys(u),d=0;d<h.length;d++){f=De(h[d],r),p=u[h[d]];if(Ce(f)){Ie(t,Ae(f),p,"$max",i)}else if(ke(f))Me(t,f,function(e){return Math.max(e,p)});else{g=a(t,f);c(t,f,Math.max(g,p))}}else if("$currentDate"==l)for(h=Object.keys(u),d=0;d<h.length;d++){f=De(h[d],r);var m=u[h[d]];!0===m||"object"==typeof m&&"date"===m.$type?c(t,f,new Date):"object"==typeof m&&"timestamp"===m.$type?c(t,f,new Ee):c(t,f,new Date)}else if("$addToSet"==l)for(h=Object.keys(u),d=0;d<h.length;d++){f=De(h[d],r);var y=u[h[d]];(L=a(t,f))&&Array.isArray(L)&&L.push(y)}else if("$pop"==l)for(h=Object.keys(u),d=0;d<h.length;d++){f=De(h[d],r);var x=u[h[d]];(L=a(t,f))&&Array.isArray(L)&&(1==x?L.pop():-1==x&&L.shift())}else if("$pull"==l)for(h=Object.keys(u),d=0;d<h.length;d++){f=De(h[d],r);var b=u[h[d]];if(null!=(S=a(t,f))&&Array.isArray(S)){for(var w=[],_=0;_<S.length;_++){var v=S[_],$=!1;if("object"!=typeof b||null===b||Array.isArray(b))$=v==b;else if("object"!=typeof v||null===v||Array.isArray(v))$=we({__temp:v},"__temp",b);else $=ve(v,b);$||w.push(v)}c(t,f,w)}}else if("$pullAll"==l)for(h=Object.keys(u),d=0;d<h.length;d++){var S=a(t,f=De(h[d],r)),N=u[h[d]];for(w=[],_=0;_<S.length;_++){for(var E=!1,A=0;A<N.length;A++)if(S[_]==N[A]){E=!0;break}E||w.push(S[_])}c(t,f,w)}else if("$pushAll"==l)for(h=Object.keys(u),d=0;d<h.length;d++){f=De(h[d],r);var I=u[h[d]];if((L=a(t,f))&&Array.isArray(L))for(_=0;_<I.length;_++)L.push(I[_])}else if("$push"==l)for(h=Object.keys(u),d=0;d<h.length;d++){f=De(h[d],r);var O=u[h[d]];if(null!==O&&"object"==typeof O&&(void 0!==O.$each||void 0!==O.$position||void 0!==O.$slice||void 0!==O.$sort)){(L=a(t,f))||c(t,f,L=[]);var C=void 0!==O.$each?O.$each:[O],k=void 0!==O.$position?O.$position:L.length;if(k<0&&(k=Math.max(0,L.length+k)),L.splice(k,0,...C),void 0!==O.$sort){var M=O.$sort;"number"==typeof M?L.sort(function(e,t){return e<t?M>0?-1:1:e>t?M>0?1:-1:0}):"object"==typeof M&&L.sort(function(e,t){for(var n=Object.keys(M),r=0;r<n.length;r++){var i=n[r],s=M[i],o=a(e,i),l=a(t,i);if(o<l)return s>0?-1:1;if(o>l)return s>0?1:-1}return 0})}if(void 0!==O.$slice){var D=O.$slice;if(D<0)c(t,f,L.slice(D));else if(0===D)c(t,f,[]);else{c(t,f,L.slice(0,D))}}}else{var L;(L=a(t,f))&&Array.isArray(L)&&L.push(O)}}else{if("$bit"!=l)throw"unknown update operator: "+l;f=De((h=Object.keys(u))[0],r);var T=u[h[0]],j=Object.keys(T)[0],P=T[j];g=a(t,f);if("and"==j)c(t,f,g&P);else if("or"==j)c(t,f,g|P);else{if("xor"!=j)throw"unknown $bit operator: "+j;c(t,f,g^P)}}}}function Te(e,t,n){for(var r={_id:n()},i=!0,s=Object.keys(t),o=0;o<s.length;o++)if("$"==s[o].charAt(0)){i=!1;break}if(i)for(o=0;o<s.length;o++)r[s[o]]=t[s[o]];else{var a=Object.keys(e);for(o=0;o<a.length;o++)r[a[o]]=e[a[o]];Le(t,r,!0)}return r}class je{constructor(e,t,n,r={}){this.name=e,this.keys=t,this.storage=n,this.options=r}add(e){throw new Error("add() must be implemented by subclass")}remove(e){throw new Error("remove() must be implemented by subclass")}update(e,t){this.remove(e),this.add(t)}query(e){throw new Error("query() must be implemented by subclass")}clear(){throw new Error("clear() must be implemented by subclass")}getSpec(){return{name:this.name,key:this.keys}}serialize(){throw new Error("serialize() must be implemented by subclass")}deserialize(e){throw new Error("deserialize() must be implemented by subclass")}}function Pe(e){return"string"==typeof e&&""!==e.trim()&&Number.isFinite(+e)}class Fe{constructor(e,t,n){if(!(t instanceof X))throw new Error("IndexStore is required to create BPlusTreeNode");if("object"==typeof e){this._data=e,this.id=this._data.id,this.keys=this._data.keys,this.values=this._data.values,this.children=[];for(const e of this._data.children){if(n.has(e)){this.children.push(n.get(e));continue}const r=t.getDataMap("nodes").get(e);if(!r)throw new Error(`BPlusTreeNode: Child node with id ${e} not found in IndexStore`);const i=new Fe(r,t,n);this.children.push(i),n.set(e,i)}if(this.isLeaf=this._data.isLeaf,this._data.next)if(n.has(this._data.next))this.next=n.get(this._data.next);else{const e=t.getDataMap("nodes").get(this._data.next);if(!e)throw new Error(`BPlusTreeNode: Next leaf node with id ${this._data.next} not found in IndexStore`);this.next=new Fe(e,t,n),n.set(this.next.id,this.next)}else this.next=null}else this._data={id:t.getMeta("nextId"),keys:[],values:[],children:[],isLeaf:e,next:null},t.setMeta("nextId",this._data.id+1),t.getDataMap("nodes").set(this._data.id,this._data),this.id=this._data.id,this.keys=this._data.keys,this.values=this._data.values,this.children=[],this.isLeaf=this._data.isLeaf,this.next=null;const r=this;return new Proxy(this,{get:(e,n)=>"children"===n?new Proxy(e.children,{get(e,n,i){if(!Pe(n)){if("length"===n)return Reflect.get(e,n,i);if("splice"===n)return function(...i){if(3==i.length){if(!(i[2]instanceof Fe))throw new Error("BPlusTreeNode: children array can only store BPlusTreeNode instances",i[2]);r._data.children.splice(i[0],i[1],i[2].id),t.getDataMap("nodes").set(r._data.id,r._data)}return Reflect.apply(e[n],e,i)};if("push"===n)return function(...e){if(1!==e.length)throw new Error("BPlusTreeNode: children.push only supports single argument");if(e[0]instanceof Fe)return r._data.children.push(e[0].id),t.getDataMap("nodes").set(r._data.id,r._data),r.children.push(e[0]);throw new Error("BPlusTreeNode: children array can only store BPlusTreeNode instances",e[2])}}return Reflect.get(e,n,i)},set:(e,n,i,s)=>(Pe(n)&&i instanceof Fe?Reflect.set(r._data.children,n,i.id,s):Reflect.set(r._data.children,n,i,s),t.getDataMap("nodes").set(r._data.id,r._data),Reflect.set(e,n,i,s))}):Reflect.get(e,n),set(e,n,r){if("next"===n)if(r instanceof Fe)e.next=r,e._data.next=r.id,t.getDataMap("nodes").set(e._data.id,e._data);else{if(null!==r)throw new Error("BPlusTreeNode: next pointer must be a BPlusTreeNode or null");e.next=null,e._data.next=null,t.getDataMap("nodes").set(e._data.id,e._data)}else"isLeaf"===n?(e.isLeaf=r,e._data.isLeaf=r,t.getDataMap("nodes").set(e._data.id,e._data)):"children"===n?(e.children=r,e._data.children=r.map(e=>e.id),t.getDataMap("nodes").set(e._data.id,e._data)):(e[n]=r,e._data[n]=r,t.getDataMap("nodes").set(e._data.id,e._data));return!0}})}}class Re{constructor(e=3,t=new X){if(e<3)throw new Error("B+ tree order must be at least 3");if(this.order=e,this.minKeys=Math.ceil(e/2)-1,this.indexStore=t,t.hasMeta("order")){if(t.getMeta("order")!==this.order)throw new Error(`B+ tree order does not match stored index metadata ${t.getMeta("order")} != ${this.order}`);if(t.getMeta("minKeys")!=this.minKeys)throw new Error(`B+ tree minKeys does not match stored index metadata ${t.getMeta("minKeys")} != ${this.minKeys}`);this._buildTreeFromStorage()}else this.indexStore.setMeta("order",this.order),this.indexStore.setMeta("minKeys",this.minKeys),this.indexStore.setMeta("nextId",1),this.root=new Fe(!0,this.indexStore),this.indexStore.setMeta("rootId",this.root.id)}_buildTreeFromStorage(){const e=new Map,t=this.indexStore.getDataMap("nodes").get(this.indexStore.getMeta("rootId"));if(!t)throw new Error("BPlusTree: Root node not found in IndexStore");this.root=new Fe(t,this.indexStore,e)}search(e){return this._searchNode(this.root,e)}_searchNode(e,t){if(e.isLeaf){const n=[];for(let r=0;r<e.keys.length;r++)t===e.keys[r]&&n.push(...e.values[r]);return n}{let n=0;for(;n<e.keys.length&&t>=e.keys[n];)n++;return this._searchNode(e.children[n],t)}}add(e,t){if(this.root.keys.length===this.indexStore.getMeta("order")-1){const e=new Fe(!1,this.indexStore);e.children.push(this.root),this._splitChild(e,0),this.root=e,this.indexStore.setMeta("rootId",this.root.id)}this._insertNonFull(this.root,e,t)}_insertNonFull(e,t,n){let r=e.keys.length-1;if(e.isLeaf){for(let r=0;r<e.keys.length;r++)if(e.keys[r]===t)return void e.values[r].push(n);for(e.keys.push(null),e.values.push(null);r>=0&&t<e.keys[r];)e.keys[r+1]=e.keys[r],e.values[r+1]=e.values[r],r--;e.keys[r+1]=t,e.values[r+1]=[n]}else{for(r=0;r<e.keys.length&&t>=e.keys[r];)r++;e.children[r].keys.length===this.indexStore.getMeta("order")-1&&(this._splitChild(e,r),t>=e.keys[r]&&r++),this._insertNonFull(e.children[r],t,n)}}_splitChild(e,t){const n=e.children[t],r=new Fe(n.isLeaf,this.indexStore),i=Math.floor((this.indexStore.getMeta("order")-1)/2);if(n.isLeaf)r.keys=n.keys.splice(i),r.values=n.values.splice(i),r.next=n.next,n.next=r,e.keys.splice(t,0,r.keys[0]);else{r.keys=n.keys.splice(i+1);const s=n.keys.pop();r.children=n.children.splice(i+1),e.keys.splice(t,0,s)}e.children.splice(t+1,0,r)}deleteValue(e,t){const n=this._deleteValue(this.root,e,t);return 0===this.root.keys.length&&!this.root.isLeaf&&this.root.children.length>0&&(this.root=this.root.children[0],this.indexStore.setMeta("rootId",this.root.id)),n}delete(e){const t=this._delete(this.root,e);return 0===this.root.keys.length&&!this.root.isLeaf&&this.root.children.length>0&&(this.root=this.root.children[0],this.indexStore.setMeta("rootId",this.root.id)),t}_deleteValue(e,t,n){if(e.isLeaf){for(let r=0;r<e.keys.length;r++)if(t===e.keys[r]){const t=e.values[r],i=t.indexOf(n);return-1!==i&&(t.splice(i,1),0===t.length&&(e.keys.splice(r,1),e.values.splice(r,1)),!0)}return!1}{let r=0;for(;r<e.keys.length&&t>=e.keys[r];)r++;const i=this._deleteValue(e.children[r],t,n);return i&&this._rebalanceAfterDelete(e,r),i}}_delete(e,t){if(e.isLeaf){for(let n=0;n<e.keys.length;n++)if(t===e.keys[n])return e.keys.splice(n,1),e.values.splice(n,1),!0;return!1}{let n=0;for(;n<e.keys.length&&t>=e.keys[n];)n++;const r=this._delete(e.children[n],t);return r&&this._rebalanceAfterDelete(e,n),r}}_rebalanceAfterDelete(e,t){if(!(e.children[t].keys.length>=this.indexStore.getMeta("minKeys"))){if(t>0){if(e.children[t-1].keys.length>this.indexStore.getMeta("minKeys"))return void this._borrowFromLeft(e,t)}if(t<e.children.length-1){if(e.children[t+1].keys.length>this.indexStore.getMeta("minKeys"))return void this._borrowFromRight(e,t)}t>0?this._merge(e,t-1):this._merge(e,t)}}_borrowFromLeft(e,t){const n=e.children[t],r=e.children[t-1];n.isLeaf?(n.keys.unshift(r.keys.pop()),n.values.unshift(r.values.pop()),e.keys[t-1]=n.keys[0]):(n.keys.unshift(e.keys[t-1]),e.keys[t-1]=r.keys.pop(),n.children.unshift(r.children.pop()))}_borrowFromRight(e,t){const n=e.children[t],r=e.children[t+1];n.isLeaf?(n.keys.push(r.keys.shift()),n.values.push(r.values.shift()),e.keys[t]=r.keys[0]):(n.keys.push(e.keys[t]),e.keys[t]=r.keys.shift(),n.children.push(r.children.shift()))}_merge(e,t){const n=e.children[t],r=e.children[t+1];n.isLeaf?(n.keys=n.keys.concat(r.keys),n.values=n.values.concat(r.values),n.next=r.next,e.keys.splice(t,1)):(n.keys.push(e.keys[t]),n.keys=n.keys.concat(r.keys),n.children=n.children.concat(r.children),e.keys.splice(t,1)),e.children.splice(t+1,1)}toArray(){const e=[];let t=this._getFirstLeaf(this.root);for(;t;){for(let n=0;n<t.keys.length;n++){const r=t.values[n];for(let i=0;i<r.length;i++)e.push({key:t.keys[n],value:r[i]})}t=t.next}return e}_getFirstLeaf(e){return e.isLeaf?e:this._getFirstLeaf(e.children[0])}size(){let e=0,t=this._getFirstLeaf(this.root);for(;t;){for(let n=0;n<t.values.length;n++)e+=t.values[n].length;t=t.next}return e}isEmpty(){return 0===this.root.keys.length}clear(){this.indexStore.getDataMap("nodes").clear(),this.root=new Fe(!0,this.indexStore),this.indexStore.setMeta("rootId",this.root.id)}rangeSearch(e,t){const n=[];let r=this._getFirstLeaf(this.root);for(;r&&r.keys[r.keys.length-1]<e;)r=r.next;for(;r;){for(let i=0;i<r.keys.length;i++)if(r.keys[i]>=e&&r.keys[i]<=t){const e=r.values[i];for(let t=0;t<e.length;t++)n.push({key:r.keys[i],value:e[t]})}else if(r.keys[i]>t)return n;r=r.next}return n}getHeight(){let e=0,t=this.root;for(;!t.isLeaf;)e++,t=t.children[0];return e}}class Be extends je{constructor(e,t,n,r={}){super(e,t,n,r),this.data=new Re(50,n)}extractIndexKey(e){const t=Object.keys(this.keys);if(0===t.length)return null;if(1===t.length){const n=a(e,t[0]);return void 0===n?null:n}const n=[];for(let r=0;r<t.length;r++){const i=a(e,t[r]);if(void 0===i)return null;n.push(i)}return n.join("\0")}add(e){const t=this.extractIndexKey(e);null!==t&&this.data.add(t,e._id.toString())}remove(e){const t=this.extractIndexKey(e);null!==t&&this.data.delete(t,e._id.toString())}query(e){const t=Object.keys(e),n=Object.keys(this.keys);if(1!==n.length)return null;const r=n[0];if(-1===t.indexOf(r))return null;const i=e[r];if("object"!=typeof i||null===i){const e=i;return this.data.search(e)}return"object"!=typeof i||Array.isArray(i)?null:this._queryWithOperators(r,i)}_queryWithOperators(e,t){const n=Object.keys(t),r=new Set;if(n.some(e=>["$gt","$gte","$lt","$lte"].includes(e))){const e=n.includes("$gt")||n.includes("$gte"),s=n.includes("$lt")||n.includes("$lte");if(e&&s){const e=n.includes("$gte")?t.$gte:n.includes("$gt")?t.$gt:-1/0,s=n.includes("$lte")?t.$lte:n.includes("$lt")?t.$lt:1/0,o=this.data.rangeSearch(e,s);for(const{key:a,value:l}of o)try{const e=a;let i=!0;!n.includes("$gt")||e>t.$gt||(i=!1),!n.includes("$gte")||e>=t.$gte||(i=!1),!n.includes("$lt")||e<t.$lt||(i=!1),!n.includes("$lte")||e<=t.$lte||(i=!1),i&&l&&r.add(l)}catch(i){}return Array.from(r)}{const e=this.data.toArray();for(const{key:s,value:o}of e)try{const e=s;let i=!0;for(const r of n){const n=t[r];("$gt"!==r||e>n)&&("$gte"!==r||e>=n)&&("$lt"!==r||e<n)&&("$lte"!==r||e<=n)?("$eq"===r&&e!==n||"$ne"===r&&e===n)&&(i=!1):i=!1}i&&o&&r.add(o)}catch(i){}return Array.from(r)}}if(n.includes("$in")){const e=t.$in;if(Array.isArray(e)){for(const t of e){const e=t,n=this.data.search(e);n&&n.forEach(e=>r.add(e))}return Array.from(r)}}if(n.includes("$eq")){const e=t.$eq;return this.data.search(e)||[]}if(n.includes("$ne")){const e=t.$ne,n=this.data.toArray();for(const{key:t,value:i}of n)t!==e&&i&&r.add(i);return Array.from(r)}return null}clear(){this.data.clear()}}class Ue extends je{constructor(e,t,n,r={}){super(e,t,n,r),this.textIndex=new ee(n),this.indexedFields=[];for(const i in t)"text"===t[i]&&this.indexedFields.push(i);if(0===this.indexedFields.length)throw new Error('Text index must have at least one field with type "text"')}_extractText(e){const t=[];for(const n of this.indexedFields){const r=a(e,n);null!=r&&t.push(String(r))}return t.join(" ")}add(e){if(!e._id)throw new Error("Document must have an _id field");const t=this._extractText(e);t&&this.textIndex.add(String(e._id),t)}remove(e){e._id&&this.textIndex.remove(String(e._id))}query(e){return null}search(e,t={}){return this.textIndex.query(e,{scored:!1,...t})}clear(){this.textIndex.clear()}getSpec(){return{name:this.name,key:this.keys,textIndexVersion:3,weights:this._getWeights()}}_getWeights(){const e={};for(const t of this.indexedFields)e[t]=1;return e}}function ze(e,t,n,r){const i=(n-e)*Math.PI/180,s=(r-t)*Math.PI/180,o=Math.sin(i/2)*Math.sin(i/2)+Math.cos(e*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin(s/2)*Math.sin(s/2);return 6371*(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)))}function qe(e,t){return!(e.maxLat<t.minLat||e.minLat>t.maxLat||e.maxLng<t.minLng||e.minLng>t.maxLng)}function We(e){return(e.maxLat-e.minLat)*(e.maxLng-e.minLng)}function Ke(e,t){return{minLat:Math.min(e.minLat,t.minLat),maxLat:Math.max(e.maxLat,t.maxLat),minLng:Math.min(e.minLng,t.minLng),maxLng:Math.max(e.maxLng,t.maxLng)}}function Ve(e,t){return We(Ke(e,t))-We(e)}class Qe{constructor(e=!1,t){if(!(t instanceof X))throw new Error("IndexStore is required to create RTreeNode");if(this.indexStore=t,"object"==typeof e)if(this._data=e,this.id=this._data.id,this.isLeaf=this._data.isLeaf,this.children=[],this.bbox=Object.assign({},this._data.bbox),this.isLeaf)this.children=[...this._data.children];else for(const n of this._data.children){const e=t.getDataMap("nodes").get(n);if(!e)throw new Error(`RTreeNode: Child node with id ${n} not found in IndexStore`);const r=new Qe(e,t);this.children.push(r)}else this._data={id:t.getMeta("nextId"),isLeaf:e,children:[],bbox:null},t.setMeta("nextId",this._data.id+1),t.getDataMap("nodes").set(this._data.id,this._data),this.id=this._data.id,this.isLeaf=e,this.children=[],this.bbox=null;return new Proxy(this,{set:(e,n,r)=>"children"===n?(e.children=r,e.isLeaf?e._data.children=[...e.children]:e._data.children=e.children.map(e=>e.id),t.getDataMap("nodes").set(e.id,e._data),!0):(e[n]=r,!0),get:(e,n)=>"children"===n?new Proxy(e.children,{set:(n,r,i)=>(n[r]=i,e.isLeaf?e._data.children=[...e.children]:e._data.children=e.children.map(e=>e.id),t.getDataMap("nodes").set(e.id,e._data),!0)}):e[n]})}updateBBox(){if(0===this.children.length)return void(this.bbox=null);let e=1/0,t=-1/0,n=1/0,r=-1/0;for(const i of this.children){const s=i.bbox;e=Math.min(e,s.minLat),t=Math.max(t,s.maxLat),n=Math.min(n,s.minLng),r=Math.max(r,s.maxLng)}this.bbox={minLat:e,maxLat:t,minLng:n,maxLng:r},this._data.bbox=Object.assign({},this.bbox),this.indexStore.getDataMap("nodes").set(this.id,this._data)}}class Je{constructor(e=9,t=new X){if(this.maxEntries=e,this.minEntries=Math.max(2,Math.ceil(e/2)),this.indexStore=t,t.hasMeta("maxEntries")){if(t.getMeta("maxEntries")!==e)throw new Error(`R-tree maxEntries does not match stored index metadata ${t.getMeta("maxEntries")} != ${e}`);if(t.getMeta("minEntries")!==this.minEntries)throw new Error(`R-tree minEntries does not match stored index metadata ${t.getMeta("minEntries")} != ${this.minEntries}`);this._size=this.indexStore.getMeta("size"),this.root=new Qe(this.indexStore.getDataMap("nodes").get(this.indexStore.getMeta("rootId")),this.indexStore)}else this.indexStore.setMeta("maxEntries",this.maxEntries),this.indexStore.setMeta("minEntries",this.minEntries),this.indexStore.setMeta("nextId",1),this.root=new Qe(!0,this.indexStore),this.indexStore.setMeta("rootId",this.root.id),this.indexStore.setMeta("size",0),this._size=0}insert(e,t,n){const r={bbox:{minLat:e,maxLat:e,minLng:t,maxLng:t},lat:e,lng:t,data:n};this._insert(r,this.root,1),this._size++,this.indexStore.setMeta("size",this._size)}_insert(e,t,n){if(t.isLeaf){if(t.children.push(e),t.updateBBox(),t.children.length>this.maxEntries)return this._split(t)}else{const r=this._chooseSubtree(e.bbox,t),i=this._insert(e,r,n+1);if(i){if(t.children.push(i),t.updateBBox(),t.children.length>this.maxEntries)return this._split(t)}else t.updateBBox()}return null}_chooseSubtree(e,t){let n=1/0,r=1/0,i=null;for(const s of t.children){const t=Ve(s.bbox,e),o=We(s.bbox);(t<n||t===n&&o<r)&&(n=t,r=o,i=s)}return i}_split(e){const t=e.children,n=e.isLeaf;let r=-1/0,i=0,s=1;for(let l=0;l<t.length;l++)for(let e=l+1;e<t.length;e++){const n=t[l].bbox,o=t[e].bbox,a=We(Ke(n,o))-We(n)-We(o);a>r&&(r=a,i=l,s=e)}const o=new Qe(n,this.indexStore),a=new Qe(n,this.indexStore);o.children.push(t[i]),a.children.push(t[s]);for(let l=0;l<t.length;l++){if(l===i||l===s)continue;const e=t[l],n=e.bbox,r=0===o.children.length?1/0:Ve(o.bbox||n,n),c=0===a.children.length?1/0:Ve(a.bbox||n,n);if(o.children.length<this.minEntries&&t.length-l+o.children.length<=this.minEntries)o.children.push(e);else if(a.children.length<this.minEntries&&t.length-l+a.children.length<=this.minEntries)a.children.push(e);else if(r<c)o.children.push(e);else if(c<r)a.children.push(e);else{(o.bbox?We(o.bbox):0)<(a.bbox?We(a.bbox):0)?o.children.push(e):a.children.push(e)}o.updateBBox(),a.updateBBox()}if(e.children=o.children,e.updateBBox(),e===this.root){const e=new Qe(!1,this.indexStore);return e.children=[o,a],e.updateBBox(),this.root=e,this.indexStore.setMeta("rootId",this.root.id),null}return a}searchBBox(e){const t=[];return this._searchBBox(e,this.root,t),t}_searchBBox(e,t,n){if(t.bbox&&qe(e,t.bbox))if(t.isLeaf)for(const r of t.children)qe(e,r.bbox)&&n.push(r);else for(const r of t.children)this._searchBBox(e,r,n)}searchRadius(e,t,n){const r=function(e,t,n){const r=n/111,i=n/(111*Math.cos(e*Math.PI/180));return{minLat:e-r,maxLat:e+r,minLng:t-i,maxLng:t+i}}(e,t,n),i=this.searchBBox(r),s=[];for(const o of i){ze(e,t,o.lat,o.lng)<=n&&s.push(o)}return s}remove(e,t,n=null){const r={minLat:e,maxLat:e,minLng:t,maxLng:t},i=this._remove(r,n,this.root,null,-1);return i&&(this._size--,this.indexStore.setMeta("size",this._size)),1!==this.root.children.length||this.root.isLeaf||(this.root=this.root.children[0],this.indexStore.setMeta("rootId",this.root.id)),i}_remove(e,t,n,r,i){if(!n.bbox||!qe(e,n.bbox))return!1;if(n.isLeaf)for(let s=0;s<n.children.length;s++){const o=n.children[s];if(o.lat===e.minLat&&o.lng===e.minLng){if(null===t||JSON.stringify(o.data)===JSON.stringify(t)){if(n.children.splice(s,1),n.updateBBox(),n.children.length<this.minEntries&&n!==this.root){const e=n.children.slice();n.children=[],n.updateBBox(),r&&(r.children.splice(i,1),r.updateBBox());for(const t of e)this._insert(t,this.root,1)}return!0}}}else for(let s=0;s<n.children.length;s++){const r=n.children[s];if(this._remove(e,t,r,n,s))return n.updateBBox(),!0}return!1}getAll(){const e=[];return this._getAll(this.root,e),e}_getAll(e,t){if(e.isLeaf)t.push(...e.children);else for(const n of e.children)this._getAll(n,t)}size(){return this._size}clear(){this.root=new Qe(!0,this.indexStore),this.indexStore.setMeta("rootId",this.root.id),this._size=0,this.indexStore.setMeta("size",0)}}class He extends je{constructor(e,t,n,r={}){super(e,t,n,r),this.rtree=new Je(9,n),this.geoField=null;for(const i in t)if("2dsphere"===t[i]||"2d"===t[i]){this.geoField=i;break}if(!this.geoField)throw new Error('Geospatial index must have at least one field with type "2dsphere" or "2d"')}_extractCoordinates(e){if(!e)return null;if("FeatureCollection"===e.type&&e.features&&e.features.length>0){const t=e.features[0];if(t.geometry)return this._extractCoordinates(t.geometry)}if("Feature"===e.type&&e.geometry)return this._extractCoordinates(e.geometry);if("Point"===e.type&&e.coordinates){const[t,n]=e.coordinates;if("number"==typeof t&&"number"==typeof n)return{lat:n,lng:t}}if("Polygon"===e.type&&e.coordinates&&e.coordinates.length>0){const t=e.coordinates[0];if(t.length>0){let e=0,n=0;for(const r of t)n+=r[0],e+=r[1];return{lat:e/t.length,lng:n/t.length}}}return null}add(e){if(!e._id)throw new Error("Document must have an _id field");const t=a(e,this.geoField),n=this._extractCoordinates(t);n&&this.rtree.insert(n.lat,n.lng,{_id:e._id,geoJson:t})}remove(e){if(!e._id)return;const t=a(e,this.geoField),n=this._extractCoordinates(t);n&&this.rtree.remove(n.lat,n.lng,{_id:e._id,geoJson:t})}query(e){if(!e[this.geoField])return null;const t=e[this.geoField];if(t.$geoWithin){const e=t.$geoWithin;if(Array.isArray(e)&&2===e.length){const t=e[0][0],n=e[0][1],r=e[1][0],i=e[1][1];return this.rtree.searchBBox({minLat:i,maxLat:n,minLng:t,maxLng:r}).map(e=>e.data._id)}}if(t.$near){const e=t.$near;let n;if(e.$geometry)n=e.$geometry.coordinates;else if(e.coordinates)n=e.coordinates;else{if(!Array.isArray(e))return null;n=e}if(!n||n.length<2)return null;const[r,i]=n,s=(e.$maxDistance||1e6)/1e3,o=this.rtree.searchRadius(i,r,s).map(e=>{const t=this._haversineDistance(i,r,e.lat,e.lng);return{_id:e.data._id,distance:t}});return o.sort((e,t)=>e.distance-t.distance),o.map(e=>e._id)}if(t.$nearSphere){const e=t.$nearSphere;let n;if(e.$geometry)n=e.$geometry.coordinates;else if(e.coordinates)n=e.coordinates;else{if(!Array.isArray(e))return null;n=e}if(!n||n.length<2)return null;const[r,i]=n,s=(e.$maxDistance||1e6)/1e3,o=this.rtree.searchRadius(i,r,s).map(e=>{const t=this._haversineDistance(i,r,e.lat,e.lng);return{_id:e.data._id,distance:t}});return o.sort((e,t)=>e.distance-t.distance),o.map(e=>e._id)}if(t.$geoIntersects){const e=t.$geoIntersects;let n;if(!e.$geometry)return null;if(n=e.$geometry,!n||!n.type)return null;if("Point"===n.type){const[e,t]=n.coordinates,r=1e-4;return this.rtree.searchBBox({minLat:t-r,maxLat:t+r,minLng:e-r,maxLng:e+r}).map(e=>e.data._id)}if("Polygon"===n.type){const e=n.coordinates;if(!e||0===e.length)return null;const t=e[0];if(!t||t.length<3)return null;let r=1/0,i=-1/0,s=1/0,o=-1/0;for(const n of t){const[e,t]=n;r=Math.min(r,t),i=Math.max(i,t),s=Math.min(s,e),o=Math.max(o,e)}return this.rtree.searchBBox({minLat:r,maxLat:i,minLng:s,maxLng:o}).filter(e=>this._pointInPolygon(e.lat,e.lng,t)).map(e=>e.data._id)}return null}return null}_haversineDistance(e,t,n,r){const i=(n-e)*Math.PI/180,s=(r-t)*Math.PI/180,o=Math.sin(i/2)*Math.sin(i/2)+Math.cos(e*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin(s/2)*Math.sin(s/2);return 6371*(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)))}_pointInPolygon(e,t,n){let r=!1;for(let i=0,s=n.length-1;i<n.length;s=i++){const[o,a]=n[i],[l,c]=n[s];a>e!=c>e&&t<(l-o)*(e-a)/(c-a)+o&&(r=!r)}return r}clear(){this.rtree.clear()}getSpec(){return{name:this.name,key:this.keys,"2dsphereIndexVersion":3}}}class Ge{constructor(){this.type="full_scan",this.indexes=[],this.indexScans=[],this.estimatedCost=1/0,this.indexOnly=!1}}class Ye{constructor(e){this.indexes=e}plan(e){const t=new Ge;if(!e||0===Object.keys(e).length)return t;const n=this._analyzeQuery(e);if(n.hasTextSearch){const t=this._planTextSearch(e,n);if(t)return t}if(n.hasGeoQuery){const t=this._planGeoQuery(e,n);if(t)return t}if("and"===n.type){const t=this._planAndQuery(e,n);if("full_scan"!==t.type)return t}if("or"===n.type){const t=this._planOrQuery(e,n);if("full_scan"!==t.type)return t}const r=this._planSimpleQuery(e);return"full_scan"!==r.type?r:t}_analyzeQuery(e){const t={type:"simple",fields:[],operators:{},hasTextSearch:!1,hasGeoQuery:!1,conditions:[]},n=Object.keys(e);if(1===n.length){const r=n[0];if("$and"===r){t.type="and",t.conditions=e.$and;for(const e of t.conditions){const n=this._analyzeQuery(e);t.fields.push(...n.fields),n.hasTextSearch&&(t.hasTextSearch=!0),n.hasGeoQuery&&(t.hasGeoQuery=!0)}return t}if("$or"===r){t.type="or",t.conditions=e.$or;for(const e of t.conditions){const n=this._analyzeQuery(e);t.fields.push(...n.fields),n.hasTextSearch&&(t.hasTextSearch=!0),n.hasGeoQuery&&(t.hasGeoQuery=!0)}return t}}for(const r of n){if(r.startsWith("$"))continue;t.fields.push(r);const n=e[r];if("object"==typeof n&&null!==n&&!Array.isArray(n)){const e=Object.keys(n);t.operators[r]=e,e.includes("$text")&&(t.hasTextSearch=!0),e.some(e=>["$geoWithin","$geoIntersects","$near","$nearSphere"].includes(e))&&(t.hasGeoQuery=!0)}}return n.length>1&&(t.type="and"),t}_planTextSearch(e,t){for(const[n,r]of this.indexes)if(r instanceof Ue){const t=this._extractTextQuery(e);if(t){const e=new Ge;return e.type="index_scan",e.indexes=[n],e.indexScans=[{indexName:n,index:r,textQuery:t}],e.estimatedCost=100,e.indexOnly=!0,e}}return null}_extractTextQuery(e){for(const t in e){const n=e[t];if("object"==typeof n&&null!==n&&n.$text)return"string"==typeof n.$text?n.$text:n.$text.$search}return null}_planGeoQuery(e,t){for(const[n,r]of this.indexes)if(r instanceof He){const t=new Ge;return t.type="index_scan",t.indexes=[n],t.indexScans=[{indexName:n,index:r,query:e}],t.estimatedCost=100,t.indexOnly=!0,t}return null}_planAndQuery(e,t){const n=new Ge;let r;r=e.$and?e.$and:Object.keys(e).map(t=>({[t]:e[t]}));const i=[];for(const s of r){const e=this._planSimpleQuery(s);"index_scan"===e.type&&i.push(e.indexScans[0])}return i.length>1?(n.type="index_intersection",n.indexScans=i,n.indexes=i.map(e=>e.indexName),n.estimatedCost=50,n):1===i.length?(n.type="index_scan",n.indexScans=[i[0]],n.indexes=[i[0].indexName],n.estimatedCost=50,n):n}_planOrQuery(e,t){const n=new Ge;if(!e.$or)return n;const r=e.$or,i=[];for(const s of r){const e=this._planSimpleQuery(s);"index_scan"===e.type&&i.push(e.indexScans[0])}return i.length>0?(n.type="index_union",n.indexScans=i,n.indexes=i.map(e=>e.indexName),n.estimatedCost=100*i.length,n):n}_planSimpleQuery(e){const t=new Ge;if(0===Object.keys(e).length)return t;for(const[n,r]of this.indexes)if(!(r instanceof Ue||r instanceof He)&&this._canIndexHandleQuery(r,e))return t.type="index_scan",t.indexes=[n],t.indexScans=[{indexName:n,index:r,query:e}],t.estimatedCost=50,t;return t}_executeIndexScan(e){const{index:t,query:n,textQuery:r}=e;if(void 0!==r)return t.search(r);if(void 0!==n){const e=t.query(n);return null!==e?e:[]}return void 0!==e.docIds?e.docIds:[]}_canIndexHandleQuery(e,t){const n=Object.keys(t),r=Object.keys(e.keys);if(1!==r.length)return!1;const i=r[0];return-1!==n.indexOf(i)}execute(e){if("full_scan"===e.type)return null;if("index_scan"===e.type){const t=e.indexScans[0];return this._executeIndexScan(t)}if("index_intersection"===e.type){if(0===e.indexScans.length)return null;const t=e.indexScans.map(e=>({docIds:this._executeIndexScan(e),indexName:e.indexName})).slice().sort((e,t)=>e.docIds.length-t.docIds.length);let n=new Set(t[0].docIds);for(let e=1;e<t.length;e++){const r=new Set(t[e].docIds);if(n=new Set([...n].filter(e=>r.has(e))),0===n.size)break}return Array.from(n)}if("index_union"===e.type){const t=new Set;for(const n of e.indexScans){this._executeIndexScan(n).forEach(e=>t.add(e))}return Array.from(t)}return null}}class Xe extends r.EventEmitter{constructor(e,t=[],n={}){super(),this.target=e,this.pipeline=t,this.options=n,this.closed=!1,this._listeners=new Map,this._changeCounter=0,this._startWatching()}_startWatching(){if(this.closed)return;const e=this._getCollectionsToWatch();for(const t of e)this._watchCollection(t);"DB"===this.target.constructor.name&&this._interceptDBCollectionCreation(),"MongoClient"===this.target.constructor.name&&this._interceptClientDBCreation()}_getCollectionsToWatch(){const e=[];if("MongoClient"===this.target.constructor.name)return this._monitorClient(),e;if("DB"===this.target.constructor.name){const t=this.target.getCollectionNames();for(const n of t){const t=this.target[n];t&&t.isCollection&&e.push(t)}this._monitorDB()}return this.target.isCollection&&e.push(this.target),e}_watchCollection(e){if(this.closed)return;if(!e)return;if("function"!=typeof e.on)return;if(!e.isCollection)return;if(this._listeners.has(e))return;const t={insert:t=>this._emitChange("insert",e,t),update:(t,n)=>this._emitChange("update",e,t,n),replace:t=>this._emitChange("replace",e,t),delete:t=>this._emitChange("delete",e,t)};this._listeners.set(e,t),e.on("insert",t.insert),e.on("update",t.update),e.on("replace",t.replace),e.on("delete",t.delete)}_emitChange(e,t,n,r=null){if(this.closed)return;const i=this._createChangeEvent(e,t,n,r);this._matchesPipeline(i)&&this.emit("change",i)}_createChangeEvent(e,t,n,r){const i={_id:{_data:Buffer.from(String(++this._changeCounter)).toString("base64")},operationType:e,clusterTime:new Date,ns:{db:t.db.dbName,coll:t.name},documentKey:{_id:n._id}};switch(e){case"insert":case"replace":i.fullDocument=n;break;case"update":i.updateDescription=r||{updatedFields:{},removedFields:[],truncatedArrays:[]},"updateLookup"===this.options.fullDocument&&(i.fullDocument=n)}return i}_matchesPipeline(e){if(!this.pipeline||0===this.pipeline.length)return!0;for(const t of this.pipeline)if(t.$match&&!ve(e,t.$match))return!1;return!0}_getNestedValue(e,t){return t.split(".").reduce((e,t)=>e?.[t],e)}_monitorClient(){}_interceptClientDBCreation(){const e=this.target,t=e.db.bind(e),n=this;this._watchedDBs=new Map,e.db=function(e,r){const i=t(e,r),s=i.dbName;if(!n._watchedDBs.has(s)){n._watchedDBs.set(s,i);const e=i.getCollectionNames();for(const t of e){const e=i[t];e&&e.isCollection&&!n._listeners.has(e)&&n._watchCollection(e)}n._interceptDBCollectionCreationForClient(i)}return i},this._originalClientMethods={db:t}}_interceptDBCollectionCreationForClient(e){const t=e.collection.bind(e),n=e.createCollection.bind(e),r=this;e.collection=function(e){const n=t(e);return n&&n.isCollection&&!r._listeners.has(n)&&r._watchCollection(n),n},e.createCollection=function(t){n(t);const i=e[t];i&&i.isCollection&&!r._listeners.has(i)&&r._watchCollection(i)}}_monitorDB(){}_interceptDBCollectionCreation(){const e=this.target,t=e.collection.bind(e),n=e.createCollection.bind(e),r=this;e.collection=function(e){const n=t(e);return n&&n.isCollection&&!r._listeners.has(n)&&r._watchCollection(n),n},e.createCollection=function(t){n(t);const i=e[t];i&&i.isCollection&&!r._listeners.has(i)&&r._watchCollection(i)},this._originalDBMethods={collection:t,createCollection:n}}close(){if(!this.closed){this.closed=!0;for(const[e,t]of this._listeners)e.off("insert",t.insert),e.off("update",t.update),e.off("replace",t.replace),e.off("delete",t.delete);this._listeners.clear(),this._originalDBMethods&&"DB"===this.target.constructor.name&&(this.target.collection=this._originalDBMethods.collection,this.target.createCollection=this._originalDBMethods.createCollection),this._originalClientMethods&&"MongoClient"===this.target.constructor.name&&(this.target.db=this._originalClientMethods.db),this.emit("close"),this.removeAllListeners()}}get isClosed(){return this.closed}async*[Symbol.asyncIterator](){const e=[];let t=null,n=!1;const r=n=>{t?(t({value:n,done:!1}),t=null):e.push(n)},i=()=>{n=!0,t&&(t({done:!0}),t=null)},s=e=>{t&&(t(Promise.reject(e)),t=null)};this.on("change",r),this.on("close",i),this.on("error",s);try{for(;!n;)if(e.length>0)yield e.shift();else{const e=await new Promise(e=>{t=e,n&&e({done:!0})});if(e.done)break;yield e.value}}finally{this.off("change",r),this.off("close",i),this.off("error",s)}}async next(){return new Promise((e,t)=>{const n=t=>{s(),e(t)},r=()=>{s(),e(null)},i=e=>{s(),t(e)},s=()=>{this.off("change",n),this.off("close",r),this.off("error",i)};this.closed?e(null):(this.once("change",n),this.once("close",r),this.once("error",i))})}}class Ze extends r.EventEmitter{constructor(e,t,n,r){super(),this.db=e,this.name=t,this.storage=n,this.idGenerator=r,this.indexes=new Map,this.queryPlanner=new Ye(this.indexes),this.isCollection=!0;for(const[i,s]of this.storage.indexes){let e;"text"===s.getMeta("type")?e=new Ue(i,s.getMeta("keys"),s):"geospatial"===s.getMeta("type")?e=new He(i,s.getMeta("keys"),s):"regular"===s.getMeta("type")&&(e=new Be(i,s.getMeta("keys"),s)),e&&this.indexes.set(e.name,e)}}generateIndexName(e){const t=[];for(const n in e)e.hasOwnProperty(n)&&t.push(n+"_"+e[n]);return t.join("_")}isTextIndex(e){for(const t in e)if("text"===e[t])return!0;return!1}isGeospatialIndex(e){for(const t in e)if("2dsphere"===e[t]||"2d"===e[t])return!0;return!1}buildIndex(e,t,n={}){let r;if(this.isTextIndex(t)){const i={type:"text",keys:t};r=new Ue(e,t,this.storage.createIndexStore(e,i),n)}else if(this.isGeospatialIndex(t)){const i={type:"geospatial",keys:t};r=new He(e,t,this.storage.createIndexStore(e,i),n)}else{const i={type:"regular",keys:t};r=new Be(e,t,this.storage.createIndexStore(e,i),n)}const i=this.storage.getAllDocuments();for(const s of i)s&&r.add(s);return this.indexes.set(e,r),r}updateIndexesOnInsert(e){for(const[t,n]of this.indexes)n.add(e)}updateIndexesOnDelete(e){for(const[t,n]of this.indexes)n.remove(e)}planQuery(e){const t=this.queryPlanner.plan(e),n=this.queryPlanner.execute(t);return{useIndex:"full_scan"!==t.type,planType:t.type,indexNames:t.indexes,docIds:n,estimatedCost:t.estimatedCost,indexOnly:t.indexOnly||!1}}getTextIndex(e){for(const[t,n]of this.indexes)if(n instanceof Ue&&n.indexedFields.includes(e))return n;return null}aggregate(e){if(!e||!u(e))throw new _("Pipeline must be an array",{collection:this.name,code:m.FAILED_TO_PARSE});let t=[];const n=this.find({});for(;n.hasNext();)t.push(n.next());for(let r=0;r<e.length;r++){const n=e[r],i=Object.keys(n);if(1!==i.length)throw new _("Each pipeline stage must have exactly one key",{collection:this.name,code:m.FAILED_TO_PARSE});const s=i[0],l=n[s];if("$match"===s){const e=[];for(let n=0;n<t.length;n++)ve(t[n],l)&&e.push(t[n]);t=e}else if("$project"===s){const e=[];for(let n=0;n<t.length;n++)e.push(et(l,t[n]));t=e}else if("$addFields"===s||"$set"===s){const e=[];for(let n=0;n<t.length;n++){const r=o(t[n]);for(const e in l){const i=l[e];r[e]=te(i,t[n])}e.push(r)}t=e}else if("$unset"===s){const e=[];let n=[];"string"==typeof l?n=[l]:Array.isArray(l)?n=l:"object"==typeof l&&(n=Object.keys(l));for(let r=0;r<t.length;r++){const i=o(t[r]);for(let e=0;e<n.length;e++){const t=n[e],r=t.split(".");if(1===r.length)delete i[t];else{let e=i;for(let t=0;t<r.length-1&&(null!=e&&null!=e);t++)e=e[r[t]];null!=e&&null!=e&&delete e[r[r.length-1]]}}e.push(i)}t=e}else if("$sort"===s){const e=Object.keys(l);t.sort(function(t,n){for(let r=0;r<e.length;r++){const i=e[r];if(void 0===t[i]&&void 0!==n[i])return-1*l[i];if(void 0!==t[i]&&void 0===n[i])return 1*l[i];if(t[i]<n[i])return-1*l[i];if(t[i]>n[i])return 1*l[i]}return 0})}else if("$limit"===s)t=t.slice(0,l);else if("$skip"===s)t=t.slice(l);else if("$group"===s){const e={},n=l._id;for(let i=0;i<t.length;i++){const r=t[i];let s;s=null==n?null:te(n,r);const o=JSON.stringify(s);e[o]||(e[o]={_id:s,docs:[],accumulators:{}}),e[o].docs.push(r)}const r=[];for(const t in e){const n=e[t],i={_id:n._id};for(const e in l){if("_id"===e)continue;const t=l[e],r=Object.keys(t);if(1!==r.length)continue;const s=r[0],o=t[s];if("$sum"===s){let t=0;for(let e=0;e<n.docs.length;e++){const r=te(o,n.docs[e]);"number"==typeof r?t+=r:null!=r&&(t+=Number(r)||0)}i[e]=t}else if("$avg"===s){let t=0,r=0;for(let e=0;e<n.docs.length;e++){const i=te(o,n.docs[e]);null!=i&&(t+=Number(i)||0,r++)}i[e]=r>0?t/r:0}else if("$min"===s){let t;for(let e=0;e<n.docs.length;e++){const r=te(o,n.docs[e]);void 0!==r&&(void 0===t||r<t)&&(t=r)}i[e]=t}else if("$max"===s){let t;for(let e=0;e<n.docs.length;e++){const r=te(o,n.docs[e]);void 0!==r&&(void 0===t||r>t)&&(t=r)}i[e]=t}else if("$push"===s){const t=[];for(let e=0;e<n.docs.length;e++){const r=te(o,n.docs[e]);t.push(r)}i[e]=t}else if("$addToSet"===s){const t={};for(let e=0;e<n.docs.length;e++){const r=te(o,n.docs[e]);t[JSON.stringify(r)]=r}const r=[];for(const e in t)r.push(t[e]);i[e]=r}else if("$first"===s)n.docs.length>0&&(i[e]=te(o,n.docs[0]));else if("$last"===s)n.docs.length>0&&(i[e]=te(o,n.docs[n.docs.length-1]));else if("$stdDevPop"===s){const t=[];for(let e=0;e<n.docs.length;e++){const r=te(o,n.docs[e]);"number"==typeof r&&t.push(r)}if(t.length>0){const n=t.reduce((e,t)=>e+t,0)/t.length,r=t.reduce((e,t)=>e+Math.pow(t-n,2),0)/t.length;i[e]=Math.sqrt(r)}else i[e]=0}else if("$stdDevSamp"===s){const t=[];for(let e=0;e<n.docs.length;e++){const r=te(o,n.docs[e]);"number"==typeof r&&t.push(r)}if(t.length>1){const n=t.reduce((e,t)=>e+t,0)/t.length,r=t.reduce((e,t)=>e+Math.pow(t-n,2),0)/(t.length-1);i[e]=Math.sqrt(r)}else i[e]=0}else if("$mergeObjects"===s){const t={};for(let e=0;e<n.docs.length;e++){const r=te(o,n.docs[e]);"object"!=typeof r||null===r||Array.isArray(r)||Object.assign(t,r)}i[e]=t}}r.push(i)}t=r}else if("$count"===s)t=[{[l]:t.length}];else if("$unwind"===s){const e=[];let n=l;"string"==typeof n&&"$"===n.charAt(0)&&(n=n.substring(1));for(let r=0;r<t.length;r++){const i=t[r],s=a(i,n);if(s&&u(s)&&s.length>0)for(let t=0;t<s.length;t++){const r=o(i),a=n.split(".");let l=r;for(let e=0;e<a.length-1;e++)l[a[e]]||(l[a[e]]={}),l=l[a[e]];l[a[a.length-1]]=s[t],e.push(r)}}t=e}else if("$sortByCount"===s){const e={};for(let n=0;n<t.length;n++){const r=t[n],i=te(l,r),s=JSON.stringify(i);e[s]||(e[s]={_id:i,count:0}),e[s].count++}t=Object.values(e).sort((e,t)=>t.count-e.count)}else if("$replaceRoot"===s||"$replaceWith"===s){const e=[],n="$replaceRoot"===s?l.newRoot:l;for(let r=0;r<t.length;r++){const i=te(n,t[r]);if("object"!=typeof i||null===i||Array.isArray(i))throw new _("$replaceRoot expression must evaluate to an object",{collection:this.name,code:m.FAILED_TO_PARSE});e.push(i)}t=e}else if("$sample"===s){const e=l.size||1;if("number"!=typeof e||e<0)throw new _("$sample size must be a non-negative number",{collection:this.name,code:m.FAILED_TO_PARSE});const n=[...t];for(let t=n.length-1;t>0;t--){const e=Math.floor(Math.random()*(t+1));[n[t],n[e]]=[n[e],n[t]]}t=n.slice(0,Math.min(e,n.length))}else if("$bucket"===s){if(!l.groupBy||!l.boundaries)throw new _("$bucket requires groupBy and boundaries",{collection:this.name,code:m.FAILED_TO_PARSE});const e=l.boundaries,n=l.default,r=l.output||{count:{$sum:1}},i={};for(let t=0;t<e.length-1;t++){i[JSON.stringify(e[t])]={_id:e[t],docs:[]}}void 0!==n&&(i.default={_id:n,docs:[]});for(let o=0;o<t.length;o++){const r=t[o],s=te(l.groupBy,r);let a=!1;for(let t=0;t<e.length-1;t++)if(s>=e[t]&&s<e[t+1]){i[JSON.stringify(e[t])].docs.push(r),a=!0;break}a||void 0===n||i.default.docs.push(r)}const s=[];for(const t in i){const e=i[t];if(0===e.docs.length)continue;const n={_id:e._id};for(const t in r){const i=r[t],s=Object.keys(i);if(1!==s.length)continue;const o=s[0],a=i[o];if("$sum"===o){let r=0;for(let t=0;t<e.docs.length;t++){const n=te(a,e.docs[t]);"number"==typeof n?r+=n:null!=n&&(r+=Number(n)||0)}n[t]=r}else if("$avg"===o){let r=0,i=0;for(let t=0;t<e.docs.length;t++){const n=te(a,e.docs[t]);null!=n&&(r+=Number(n)||0,i++)}n[t]=i>0?r/i:0}else if("$push"===o){const r=[];for(let t=0;t<e.docs.length;t++){const n=te(a,e.docs[t]);r.push(n)}n[t]=r}else if("$addToSet"===o){const r={};for(let t=0;t<e.docs.length;t++){const n=te(a,e.docs[t]);r[JSON.stringify(n)]=n}n[t]=Object.values(r)}}s.push(n)}t=s.sort((e,t)=>e._id<t._id?-1:e._id>t._id?1:0)}else if("$bucketAuto"===s){if(!l.groupBy||!l.buckets)throw new _("$bucketAuto requires groupBy and buckets",{collection:this.name,code:m.FAILED_TO_PARSE});const e=l.buckets,n=l.output||{count:{$sum:1}};if(0===t.length)t=[];else{const r=t.map(e=>({value:te(l.groupBy,e),doc:e})).sort((e,t)=>e.value<t.value?-1:e.value>t.value?1:0),i=Math.ceil(r.length/e),s=[];for(let t=0;t<e&&t*i<r.length;t++){const e=t*i,n=Math.min((t+1)*i,r.length),o=r.slice(e,n);if(0===o.length)continue;const a={_id:{min:o[0].value,max:(r.length,o[o.length-1].value)},docs:o.map(e=>e.doc)};s.push(a)}const o=[];for(let e=0;e<s.length;e++){const t=s[e],r={_id:t._id};for(const e in n){const i=n[e],s=Object.keys(i);if(1!==s.length)continue;const o=s[0],a=i[o];if("$sum"===o){let n=0;for(let e=0;e<t.docs.length;e++){const r=te(a,t.docs[e]);"number"==typeof r?n+=r:null!=r&&(n+=Number(r)||0)}r[e]=n}else if("$avg"===o){let n=0,i=0;for(let e=0;e<t.docs.length;e++){const r=te(a,t.docs[e]);null!=r&&(n+=Number(r)||0,i++)}r[e]=i>0?n/i:0}else if("$push"===o){const n=[];for(let e=0;e<t.docs.length;e++){const r=te(a,t.docs[e]);n.push(r)}r[e]=n}}o.push(r)}t=o}}else if("$out"===s){const e=l;if("string"!=typeof e)throw new _("$out requires a string collection name",{collection:this.name,code:m.FAILED_TO_PARSE});this.db[e]&&this.db.dropCollection(e),this.db.createCollection(e);const n=this.db[e];for(let r=0;r<t.length;r++){const e=t[r],i=e._id,s="object"==typeof i&&i.toString?i.toString():String(i);n.storage.set(s,e)}t=[]}else if("$merge"===s){let e,n="_id",r="merge",i="insert";if("string"==typeof l?e=l:"object"==typeof l&&(e=l.into,n=l.on||n,r=l.whenMatched||r,i=l.whenNotMatched||i),!e)throw new _("$merge requires a target collection",{collection:this.name,code:m.FAILED_TO_PARSE});this.db[e]||this.db.createCollection(e);const s=this.db[e];for(let o=0;o<t.length;o++){const e=t[o],l="string"==typeof n?n:n[0],c=a(e,l),u=s.find({[l]:c}),h=u.hasNext()?u.next():null;if(h){if("replace"===r){const t=e._id,n="object"==typeof t&&t.toString?t.toString():String(t);s.storage.set(n,e)}else if("merge"===r){const t=Object.assign({},h,e),n=t._id,r="object"==typeof n&&n.toString?n.toString():String(n);s.storage.set(r,t)}else if("keepExisting"===r);else if("fail"===r)throw new _("$merge failed: duplicate key",{collection:this.name,code:m.DUPLICATE_KEY})}else if("insert"===i){const t=e._id,n="object"==typeof t&&t.toString?t.toString():String(t);s.storage.set(n,e)}else if("discard"===i);else if("fail"===i)throw new _("$merge failed: document not found",{collection:this.name,code:m.FAILED_TO_PARSE})}t=[]}else if("$lookup"===s){if(!(l.from&&l.localField&&l.foreignField&&l.as))throw new _("$lookup requires from, localField, foreignField, and as",{collection:this.name,code:m.FAILED_TO_PARSE});if(!this.db.getCollectionNames().includes(l.from))throw new _("$lookup: collection not found: "+l.from,{collection:this.name,code:m.NAMESPACE_NOT_FOUND});const e=this.db[l.from],n=[];for(let r=0;r<t.length;r++){const i=o(t[r]),s=a(i,l.localField),c=[],u=e.find({[l.foreignField]:s});for(;u.hasNext();)c.push(u.next());i[l.as]=c,n.push(i)}t=n}else if("$graphLookup"===s){if(!(l.from&&l.startWith&&l.connectFromField&&l.connectToField&&l.as))throw new _("$graphLookup requires from, startWith, connectFromField, connectToField, and as",{collection:this.name,code:m.FAILED_TO_PARSE});if(!this.db.getCollectionNames().includes(l.from))throw new _("$graphLookup: collection not found: "+l.from,{collection:this.name,code:m.NAMESPACE_NOT_FOUND});const e=this.db[l.from],n=void 0!==l.maxDepth?l.maxDepth:Number.MAX_SAFE_INTEGER,r=l.depthField,i=l.restrictSearchWithMatch,s=[];for(let c=0;c<t.length;c++){const u=o(t[c]),h=te(l.startWith,t[c]),d=new Set,f=[],p=[{value:h,depth:0}];for(;p.length>0;){const{value:t,depth:s}=p.shift();if(s>n)continue;const c=JSON.stringify(t);if(d.has(c))continue;d.add(c);let u={[l.connectToField]:t};i&&(u={$and:[u,i]});const h=e.find(u);for(;h.hasNext();){const e=h.next(),t=o(e);r&&(t[r]=s),f.push(t);const n=a(e,l.connectFromField);null!=n&&p.push({value:n,depth:s+1})}}u[l.as]=f,s.push(u)}t=s}else if("$facet"===s){if("object"!=typeof l||Array.isArray(l))throw new _("$facet requires an object with pipeline definitions",{collection:this.name,code:m.FAILED_TO_PARSE});const e={};for(const n in l){const r=l[n];if(!Array.isArray(r))throw new _("$facet pipeline must be an array",{collection:this.name,code:m.FAILED_TO_PARSE});let i=t.map(e=>o(e));for(let e=0;e<r.length;e++){const t=r[e],n=Object.keys(t);if(1!==n.length)throw new _("Each pipeline stage must have exactly one key",{collection:this.name,code:m.FAILED_TO_PARSE});const s=n[0],o=t[s];if("$match"===s){const e=[];for(let t=0;t<i.length;t++)ve(i[t],o)&&e.push(i[t]);i=e}else if("$project"===s){const e=[];for(let t=0;t<i.length;t++)e.push(et(o,i[t]));i=e}else if("$limit"===s)i=i.slice(0,o);else if("$skip"===s)i=i.slice(o);else if("$sort"===s){const e=Object.keys(o);i.sort(function(t,n){for(let r=0;r<e.length;r++){const i=e[r];if(void 0===t[i]&&void 0!==n[i])return-1*o[i];if(void 0!==t[i]&&void 0===n[i])return 1*o[i];if(t[i]<n[i])return-1*o[i];if(t[i]>n[i])return 1*o[i]}return 0})}else if("$count"===s)i=[{[o]:i.length}];else if("$group"===s){const e={},t=o._id;for(let r=0;r<i.length;r++){const n=i[r];let s;s=null==t?null:te(t,n);const o=JSON.stringify(s);e[o]||(e[o]={_id:s,docs:[],accumulators:{}}),e[o].docs.push(n)}const n=[];for(const r in e){const t=e[r],i={_id:t._id};for(const e in o){if("_id"===e)continue;const n=o[e],r=Object.keys(n);if(1!==r.length)continue;const s=r[0],a=n[s];if("$sum"===s){let n=0;for(let e=0;e<t.docs.length;e++){const r=te(a,t.docs[e]);"number"==typeof r?n+=r:null!=r&&(n+=Number(r)||0)}i[e]=n}else if("$avg"===s){let n=0,r=0;for(let e=0;e<t.docs.length;e++){const i=te(a,t.docs[e]);null!=i&&(n+=Number(i)||0,r++)}i[e]=r>0?n/r:0}else if("$max"===s){let n;for(let e=0;e<t.docs.length;e++){const r=te(a,t.docs[e]);void 0!==r&&(void 0===n||r>n)&&(n=r)}i[e]=n}}n.push(i)}i=n}else if("$sortByCount"===s){const e={};for(let t=0;t<i.length;t++){const n=i[t],r=te(o,n),s=JSON.stringify(r);e[s]||(e[s]={_id:r,count:0}),e[s].count++}i=Object.values(e).sort((e,t)=>t.count-e.count)}else if("$sample"===s){const e=o.size||1,t=[...i];for(let n=t.length-1;n>0;n--){const e=Math.floor(Math.random()*(n+1));[t[n],t[e]]=[t[e],t[n]]}i=t.slice(0,Math.min(e,t.length))}else if("$bucket"===s){const e=o.boundaries,t=o.default,n=o.output||{count:{$sum:1}},r={};for(let i=0;i<e.length-1;i++){r[JSON.stringify(e[i])]={_id:e[i],docs:[]}}void 0!==t&&(r.default={_id:t,docs:[]});for(let a=0;a<i.length;a++){const n=i[a],s=te(o.groupBy,n);let l=!1;for(let t=0;t<e.length-1;t++)if(s>=e[t]&&s<e[t+1]){r[JSON.stringify(e[t])].docs.push(n),l=!0;break}l||void 0===t||r.default.docs.push(n)}const s=[];for(const i in r){const e=r[i];if(0===e.docs.length)continue;const t={_id:e._id};for(const r in n){const i=n[r],s=Object.keys(i);if(1!==s.length)continue;const o=s[0],a=i[o];if("$sum"===o){let n=0;for(let t=0;t<e.docs.length;t++){const r=te(a,e.docs[t]);"number"==typeof r?n+=r:null!=r&&(n+=Number(r)||0)}t[r]=n}}s.push(t)}i=s.sort((e,t)=>e._id<t._id?-1:e._id>t._id?1:0)}}e[n]=i}t=[e]}else if("$redact"===s){const e=[];for(let n=0;n<t.length;n++){const r=t[n],i=te(l,r);if("$$DESCEND"===i)e.push(r);else{if("$$PRUNE"===i)continue;("$$KEEP"===i||i)&&e.push(r)}}t=e}else{if("$geoNear"!==s)throw new _("Unsupported aggregation stage: "+s,{collection:this.name,code:m.FAILED_TO_PARSE});{if(!l.near||!l.distanceField)throw new _("$geoNear requires near and distanceField",{collection:this.name,code:m.FAILED_TO_PARSE});const e=l.near,n=l.distanceField,r=l.maxDistance,i=l.minDistance||0,s=!1!==l.spherical,c=l.key||"location",u=[];for(let l=0;l<t.length;l++){const h=o(t[l]),d=a(h,c);if(!d||!Array.isArray(d)||d.length<2)continue;let f;if(s){const t=6371e3,n=e[1]*Math.PI/180,r=d[1]*Math.PI/180,i=(d[1]-e[1])*Math.PI/180,s=(d[0]-e[0])*Math.PI/180,o=Math.sin(i/2)*Math.sin(i/2)+Math.cos(n)*Math.cos(r)*Math.sin(s/2)*Math.sin(s/2);f=t*(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)))}else{const t=d[0]-e[0],n=d[1]-e[1];f=Math.sqrt(t*t+n*n)}f>=i&&(!r||f<=r)&&(h[n]=f,u.push(h))}u.sort((e,t)=>e[n]-t[n]),t=l.limit?u.slice(0,l.limit):u}}}return t}bulkWrite(){throw new S("bulkWrite",{collection:this.name})}async count(){return this.storage.size()}async copyTo(e){this.db[e]||this.db.createCollection(e);const t=this.db[e];let n=0;const r=this.find({});for(;r.hasNext();)await t.insertOne(r.next()),n++;return n}async createIndex(e,t){if(!e||"object"!=typeof e||Array.isArray(e))throw new N("keys",e,"createIndex requires a key specification object",{collection:this.name});const n=t&&t.name?t.name:this.generateIndexName(e);if(this.indexes.has(n)){const t=this.indexes.get(n);if(JSON.stringify(t.keys)!==JSON.stringify(e))throw new b("Index with name '"+n+"' already exists with a different key specification",{code:m.INDEX_OPTIONS_CONFLICT,index:n,collection:this.name});return n}return this.buildIndex(n,e,t),n}dataSize(){throw new S("dataSize",{collection:this.name})}async deleteOne(e){const t=await this.findOne(e);return t?(this.updateIndexesOnDelete(t),this.storage.remove(t._id.toString()),this.emit("delete",{_id:t._id}),{deletedCount:1}):{deletedCount:0}}async deleteMany(e){const t=this.find(e),n=[],r=[];for(;t.hasNext();){const e=t.next();n.push(e._id),r.push(e)}const i=n.length;for(let s=0;s<n.length;s++)this.updateIndexesOnDelete(r[s]),this.storage.remove(n[s].toString()),this.emit("delete",{_id:n[s]});return{deletedCount:i}}async distinct(e,t){const n={},r=this.find(t);for(;r.hasNext();){const t=r.next();t[e]&&(n[t[e]]=!0)}return Object.keys(n)}drop(){for(const[e,t]of this.indexes)t.clear();this.storage.clear()}dropIndex(e){if(!this.indexes.has(e))throw new w(e,{collection:this.name});return this.indexes.get(e).clear(),this.indexes.delete(e),{nIndexesWas:this.indexes.size+1,ok:1}}dropIndexes(){const e=this.indexes.size;for(const[t,n]of this.indexes)n.clear();return this.indexes.clear(),{nIndexesWas:e,msg:"non-_id indexes dropped",ok:1}}ensureIndex(){throw new S("ensureIndex",{collection:this.name})}explain(){throw new S("explain",{collection:this.name})}find(e,t){const n=null==e?{}:e,r=this.planQuery(n),i=[],s={};if(r.useIndex&&r.docIds)for(const o of r.docIds){const e=this.storage.get(o.toString());e&&ve(e,n)&&(s[e._id]=!0,i.push(e))}if(!r.indexOnly){const e=this.storage.getAllDocuments();for(const t of e)!s[t._id]&&ve(t,n)&&(s[t._id]=!0,i.push(t))}return new E(this,n,t,i,A)}findAndModify(){throw new S("findAndModify",{collection:this.name})}async findOne(e,t){const n=this.find(e,t);return n.hasNext()?n.next():null}async findOneAndDelete(e,t){let n=this.find(e);if(t&&t.sort&&(n=n.sort(t.sort)),!n.hasNext())return null;const r=n.next();return this.storage.remove(r._id.toString()),t&&t.projection?g(t.projection,r):r}async findOneAndReplace(e,t,n){let r=this.find(e);if(n&&n.sort&&(r=r.sort(n.sort)),!r.hasNext())return null;const i=r.next();return t._id=i._id,this.storage.set(i._id.toString(),t),n&&n.returnNewDocument?n&&n.projection?g(n.projection,t):t:n&&n.projection?g(n.projection,i):i}async findOneAndUpdate(e,t,n){let r=this.find(e);if(n&&n.sort&&(r=r.sort(n.sort)),!r.hasNext())return null;const i=r.next(),s=Object.assign({},i);return Le(t,s,!1,$e(i,e).arrayFilters,n&&n.arrayFilters),this.storage.set(i._id.toString(),s),n&&n.returnNewDocument?n&&n.projection?g(n.projection,s):s:n&&n.projection?g(n.projection,i):i}getIndexes(){const e=[];for(const[t,n]of this.indexes)e.push(n.getSpec());return e}getShardDistribution(){throw new S("getShardDistribution",{collection:this.name})}getShardVersion(){throw new S("getShardVersion",{collection:this.name})}getStore(){return this.storage.getStore()}group(){throw new S("group",{collection:this.name})}async insert(e){return Array==e.constructor?await this.insertMany(e):await this.insertOne(e)}async insertOne(e){return null==e._id&&(e._id=this.idGenerator()),this.storage.set(e._id.toString(),e),this.updateIndexesOnInsert(e),this.emit("insert",e),{insertedId:e._id}}async insertMany(e){const t=[];for(let n=0;n<e.length;n++){const r=await this.insertOne(e[n]);t.push(r.insertedId)}return{insertedIds:t}}isCapped(){throw new S("isCapped",{collection:this.name})}mapReduce(){throw new S("mapReduce",{collection:this.name})}reIndex(){throw new S("reIndex",{collection:this.name})}async replaceOne(e,t,n){const r={},i=this.find(e);if(r.matchedCount=i.count(),0==r.matchedCount){if(r.modifiedCount=0,n&&n.upsert){const e=t;e._id=this.idGenerator(),this.storage.set(e._id.toString(),e),this.updateIndexesOnInsert(e),this.emit("insert",e),r.upsertedId=e._id}}else{r.modifiedCount=1;const e=i.next();this.updateIndexesOnDelete(e),t._id=e._id,this.storage.set(e._id.toString(),t),this.updateIndexesOnInsert(t),this.emit("replace",t)}return r}remove(e,t){const n=this.find(e);if(n.hasNext())if(!0===t||t&&t.justOne){const e=n.next();this.updateIndexesOnDelete(e),this.storage.remove(e._id.toString())}else for(;n.hasNext();){const e=n.next();this.updateIndexesOnDelete(e),this.storage.remove(e._id.toString())}}renameCollection(){throw new S("renameCollection",{collection:this.name})}save(){throw new S("save",{collection:this.name})}stats(){throw new S("stats",{collection:this.name})}storageSize(){throw new S("storageSize",{collection:this.name})}totalSize(){throw new S("totalSize",{collection:this.name})}totalIndexSize(){throw new S("totalIndexSize",{collection:this.name})}update(e,t,n){const r=this.find(e);if(r.hasNext())if(n&&n.multi)for(;r.hasNext();){const i=r.next(),s=$e(i,e).arrayFilters,o=n&&n.arrayFilters;this.updateIndexesOnDelete(i),Le(t,i,!1,s,o),this.storage.set(i._id.toString(),i),this.updateIndexesOnInsert(i)}else{const i=r.next(),s=$e(i,e).arrayFilters,o=n&&n.arrayFilters;this.updateIndexesOnDelete(i),Le(t,i,!1,s,o),this.storage.set(i._id.toString(),i),this.updateIndexesOnInsert(i)}else if(n&&n.upsert){const n=Te(e,t,this.idGenerator);this.storage.set(n._id.toString(),n),this.updateIndexesOnInsert(n)}}async updateOne(e,t,n){const r=this.find(e);if(r.hasNext()){const i=r.next(),s=JSON.parse(JSON.stringify(i)),o=$e(i,e).arrayFilters,a=n&&n.arrayFilters;this.updateIndexesOnDelete(i),Le(t,i,!1,o,a),this.storage.set(i._id.toString(),i),this.updateIndexesOnInsert(i);const l=this._getUpdateDescription(s,i);this.emit("update",i,l)}else if(n&&n.upsert){const n=Te(e,t,this.idGenerator);this.storage.set(n._id.toString(),n),this.updateIndexesOnInsert(n),this.emit("insert",n)}}async updateMany(e,t,n){const r=this.find(e);if(r.hasNext())for(;r.hasNext();){const i=r.next(),s=JSON.parse(JSON.stringify(i)),o=$e(i,e).arrayFilters,a=n&&n.arrayFilters;this.updateIndexesOnDelete(i),Le(t,i,!1,o,a),this.storage.set(i._id.toString(),i),this.updateIndexesOnInsert(i);const l=this._getUpdateDescription(s,i);this.emit("update",i,l)}else if(n&&n.upsert){const n=Te(e,t,this.idGenerator);this.storage.set(n._id.toString(),n),this.updateIndexesOnInsert(n),this.emit("insert",n)}}validate(){throw new S("validate",{collection:this.name})}_getUpdateDescription(e,t){const n={},r=[];for(const i in t)"_id"!==i&&JSON.stringify(e[i])!==JSON.stringify(t[i])&&(n[i]=t[i]);for(const i in e)"_id"!==i&&(i in t||r.push(i));return{updatedFields:n,removedFields:r,truncatedArrays:[]}}watch(e=[],t={}){return new Xe(this,e,t)}}function et(e,t){const n={},r=Object.keys(e);let i=!1,s=!1;for(const o of r){if("_id"===o)continue;const t=e[o];1===t||!0===t?i=!0:0===t||!1===t||(s=!0)}if(s||i){0!==e._id&&!1!==e._id&&(n._id=t._id);for(const i of r){const r=e[i];"_id"===i?0!==r&&!1!==r||delete n._id:n[i]=1===r||!0===r?a(t,i):te(r,t)}}else{for(const e in t)t.hasOwnProperty(e)&&(n[e]=t[e]);for(const t of r)0!==e[t]&&!1!==e[t]||delete n[t]}return n}class tt{constructor(){this.data=new Map}clear(){this.data=new Map}keys(){return this.data.keys()}get(e){return this.data.get(e)}remove(e){this.data.delete(e)}set(e,t){this.data.set(e,t)}size(){return this.data.size}}class nt{constructor(){this.documents=new tt,this.indexes=new Map}clear(){this.documents.clear(),this.indexes.clear()}documentKeys(){return this.documents.keys()}getAllDocuments(){return Array.from(this.documents.data.values())}get(e){if("string"!=typeof e)throw new Error("Document key must be a string");return this.documents.get(e)}set(e,t){if("string"!=typeof e)throw new Error("Document key must be a string");this.documents.set(e,t)}remove(e){if("string"!=typeof e)throw new Error("Document key must be a string");this.documents.remove(e)}size(){return this.documents.size()}getStore(){const e={};for(const t of this.documents.keys())e[t]=this.documents.get(t);return e}indexesCount(){return this.indexes.size}indexKeys(){return this.indexes.keys()}createIndexStore(e,t){return this.indexes.has(e)||this.indexes.set(e,new X(t)),this.indexes.get(e)}}class rt{constructor(){this.collections=new Map}collectionsCount(){return this.collections.size}collectionStoreKeys(){return this.collections.keys()}getCollectionStore(e){return this.collections.get(e)}createCollectionStore(e){if(this.collections.has(e))return this.collections.get(e);const t=new nt;return this.collections.set(e,t),t}removeCollectionStore(e){this.collections.delete(e)}save(){}}class it{constructor(e){return this.options=e||{},this.dbName=this.options.dbName||"default",this.storageEngine=this.options.storageEngine||new rt,this._loadExistingCollections(),new Proxy(this,{get:(e,t,n)=>t in e?Reflect.get(e,t,n):"symbol"==typeof t||t.startsWith("_")?void 0:"string"==typeof t?(Object.prototype.hasOwnProperty.call(e,t)||e.createCollection(t),e[t]):void 0})}_log(e){this.options&&this.options.print?this.options.print(e):console.log(e)}_id(){return this.options&&this.options.id?this.options.id():new i}_loadExistingCollections(){for(const e of this.storageEngine.collectionStoreKeys()){const t=this.storageEngine.getCollectionStore(e);this[e]=new Ze(this,e,t,this._id.bind(this))}}cloneCollection(){throw new S("cloneCollection",{database:this.dbName})}cloneDatabase(){throw new S("cloneDatabase",{database:this.dbName})}commandHelp(){throw new S("commandHelp",{database:this.dbName})}copyDatabase(){throw new S("copyDatabase",{database:this.dbName})}createCollection(e){e&&(this[e]=new Ze(this,e,this.storageEngine.createCollectionStore(e),this._id.bind(this)))}collection(e){if(!e)throw new Error("Collection name is required");return this[e]&&this[e].isCollection||this.createCollection(e),this[e]}currentOp(){throw new S("currentOp",{database:this.dbName})}dropCollection(e){this[e]&&(this.storageEngine.removeCollectionStore(e),delete this[e])}dropDatabase(){const e=this.getCollectionNames();for(const t of e)this.storageEngine.removeCollectionStore(t),delete this[t]}eval(){throw new S("eval",{database:this.dbName})}fsyncLock(){throw new S("fsyncLock",{database:this.dbName})}fsyncUnlock(){throw new S("fsyncUnlock",{database:this.dbName})}getCollection(){throw new S("getCollection",{database:this.dbName})}getCollectionInfos(){throw new S("getCollectionInfos",{database:this.dbName})}getCollectionNames(){const e=[];for(const t in this)null!=this[t]&&this[t].isCollection&&e.push(t);return e}getLastError(){throw new S("getLastError",{database:this.dbName})}getLastErrorObj(){throw new S("getLastErrorObj",{database:this.dbName})}getLogComponents(){throw new S("getLogComponents",{database:this.dbName})}getMongo(){throw new S("getMongo",{database:this.dbName})}getName(){throw new S("getName",{database:this.dbName})}getPrevError(){throw new S("getPrevError",{database:this.dbName})}getProfilingLevel(){throw new S("getProfilingLevel",{database:this.dbName})}getProfilingStatus(){throw new S("getProfilingStatus",{database:this.dbName})}getReplicationInfo(){throw new S("getReplicationInfo",{database:this.dbName})}getSiblingDB(){throw new S("getSiblingDB",{database:this.dbName})}help(){this._log("        help mr                      mapreduce"),this._log("        db.foo.find()                list objects in collection foo"),this._log("        db.foo.find( { a : 1 } )     list objects in foo where a == 1"),this._log("        it                           result of the last line evaluated; use to further iterate")}hostInfo(){throw new S("hostInfo",{database:this.dbName})}isMaster(){throw new S("isMaster",{database:this.dbName})}killOp(){throw new S("killOp",{database:this.dbName})}listCommands(){throw new S("listCommands",{database:this.dbName})}loadServerScripts(){throw new S("loadServerScripts",{database:this.dbName})}logout(){throw new S("logout",{database:this.dbName})}printCollectionStats(){throw new S("printCollectionStats",{database:this.dbName})}printReplicationInfo(){throw new S("printReplicationInfo",{database:this.dbName})}printShardingStatus(){throw new S("printShardingStatus",{database:this.dbName})}printSlaveReplicationInfo(){throw new S("printSlaveReplicationInfo",{database:this.dbName})}repairDatabase(){throw new S("repairDatabase",{database:this.dbName})}resetError(){throw new S("resetError",{database:this.dbName})}runCommand(){throw new S("runCommand",{database:this.dbName})}serverBuildInfo(){throw new S("serverBuildInfo",{database:this.dbName})}serverCmdLineOpts(){throw new S("serverCmdLineOpts",{database:this.dbName})}serverStatus(){throw new S("serverStatus",{database:this.dbName})}setLogLevel(){throw new S("setLogLevel",{database:this.dbName})}setProfilingLevel(){throw new S("setProfilingLevel",{database:this.dbName})}shutdownServer(){throw new S("shutdownServer",{database:this.dbName})}stats(){throw new S("stats",{database:this.dbName})}version(){throw new S("version",{database:this.dbName})}upgradeCheck(){throw new S("upgradeCheck",{database:this.dbName})}upgradeCheckAllDBs(){throw new S("upgradeCheckAllDBs",{database:this.dbName})}watch(e=[],t={}){return new Xe(this,e,t)}}class st extends r.EventEmitter{constructor(e="mongodb://localhost:27017",t={}){super(),this.uri=e,this.options=Object.freeze({...t}),this._isConnected=!1,this._defaultDb=this._parseDefaultDbName(e)}static async connect(e,t={}){const n=new st(e,t);return await n.connect(),n}async connect(){return this._isConnected||(this._isConnected=!0,this.emit("open",this)),this}db(e,t={}){const n=e||this._defaultDb;if(!n)throw new Error("No database name provided and no default in connection string");const r={...this.options,...t,dbName:n};return new it(r)}async close(e=!1){this._isConnected&&(this._isConnected=!1,this.emit("close"))}startSession(e={}){return{id:crypto.randomUUID(),endSession:()=>{},withTransaction:async e=>await e(this)}}async withSession(e,t){const n=this.startSession("function"==typeof e?{}:e),r="function"==typeof e?e:t;try{return await r(n)}finally{n.endSession()}}get readConcern(){return this.options.readConcern}get writeConcern(){return this.options.writeConcern}get readPreference(){return this.options.readPreference}watch(e=[],t={}){return new Xe(this,e,t)}_parseDefaultDbName(e){const t=e.match(/\/([^/?]+)/);return t?t[1]:null}}e.BadValueError=N,e.BulkWriteError=class extends y{constructor(e=[],t={}){super(`Bulk write operation error: ${e.length} error(s)`,t),this.name="BulkWriteError",this.writeErrors=e,this.code=t.code||m.WRITE_CONFLICT}},e.CannotCreateIndexError=class extends b{constructor(e,t={}){super(`Cannot create index: ${e}`,{...t,code:m.CANNOT_CREATE_INDEX}),this.name="CannotCreateIndexError"}},e.ChangeStream=Xe,e.CursorError=$,e.CursorNotFoundError=class extends ${constructor(e,t={}){super(`Cursor ${e} not found`,{...t,code:m.CURSOR_NOT_FOUND}),this.name="CursorNotFoundError",this.cursorId=e}},e.DuplicateKeyError=class extends x{constructor(e,t={}){const n=JSON.stringify(e);super(`E11000 duplicate key error${t.collection?` collection: ${t.collection}`:""} index: ${n} dup key: ${n}`,{...t,code:m.DUPLICATE_KEY}),this.name="DuplicateKeyError",this.keyPattern=e,this.keyValue=t.keyValue||e}},e.ErrorCodes=m,e.IndexError=b,e.IndexExistsError=class extends b{constructor(e,t={}){super(`Index with name '${e}' already exists`,{...t,code:m.INDEX_EXISTS}),this.name="IndexExistsError",this.indexName=e}},e.IndexNotFoundError=w,e.IndexedDbStorageEngine=class extends rt{constructor(e="micro-mongo"){super(),this.dbName=e,this.db=null,this.indexedDBName=`micro-mongo-${e}`}async initialize(){return new Promise((e,t)=>{const n=indexedDB.open(this.indexedDBName,1);n.onerror=()=>{t(new Error("Failed to open IndexedDB: "+n.error))},n.onsuccess=()=>{this.db=n.result,e()},n.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains("collections")||t.createObjectStore("collections",{keyPath:"name"}),t.objectStoreNames.contains("metadata")||t.createObjectStore("metadata",{keyPath:"key"})}})}async saveDatabase(e){this.db||await this.initialize();const t=this.db.transaction(["metadata"],"readwrite").objectStore("metadata");await new Promise((n,r)=>{const i=t.put({key:"dbName",value:e.name});i.onsuccess=()=>n(),i.onerror=()=>r(i.error)});for(const n in e.collections)e.collections.hasOwnProperty(n)&&await this.saveCollection(e.name,n,e.collections[n])}async loadDatabase(e){this.db||await this.initialize();const t=this.db.transaction(["collections"],"readonly").objectStore("collections");return new Promise((n,r)=>{const i=t.getAll();i.onsuccess=()=>{const t={};for(const e of i.result)t[e.name]={documents:e.documents||[],indexes:e.indexes||[]};n({name:e,collections:t})},i.onerror=()=>r(i.error)})}async saveCollection(e,t,n){this.db||await this.initialize();const r=this.db.transaction(["collections"],"readwrite").objectStore("collections");return new Promise((e,i)=>{const s=r.put({name:t,documents:n.documents||[],indexes:n.indexes||[]});s.onsuccess=()=>e(),s.onerror=()=>i(s.error)})}async loadCollection(e,t){this.db||await this.initialize();const n=this.db.transaction(["collections"],"readonly").objectStore("collections");return new Promise((e,r)=>{const i=n.get(t);i.onsuccess=()=>{i.result?e({documents:i.result.documents||[],indexes:i.result.indexes||[]}):e(null)},i.onerror=()=>r(i.error)})}async deleteCollection(e,t){this.db||await this.initialize();const n=this.db.transaction(["collections"],"readwrite").objectStore("collections");return new Promise((e,r)=>{const i=n.delete(t);i.onsuccess=()=>e(),i.onerror=()=>r(i.error)})}async deleteDatabase(e){return this.db&&(this.db.close(),this.db=null),new Promise((e,t)=>{const n=indexedDB.deleteDatabase(this.indexedDBName);n.onsuccess=()=>e(),n.onerror=()=>t(n.error)})}async close(){this.db&&(this.db.close(),this.db=null)}},e.InvalidNamespaceError=class extends v{constructor(e,t,n={}){"object"!=typeof t||n||(n=t,t=void 0);super(t?`Invalid namespace '${e}': ${t}`:`Invalid namespace '${e}'`,{...n,code:m.INVALID_NAMESPACE}),this.name="InvalidNamespaceError",this.namespace=e}},e.MongoClient=st,e.MongoDriverError=class extends y{constructor(e,t={}){super(e,t),this.name="MongoDriverError",this.code=t.code||m.INTERNAL_ERROR}},e.MongoError=y,e.MongoNetworkError=class extends y{constructor(e,t={}){super(e,t),this.name="MongoNetworkError",this.code=t.code||m.HOST_UNREACHABLE}},e.MongoServerError=class extends y{constructor(e,t={}){super(e,t),this.name="MongoServerError"}},e.NamespaceError=v,e.NamespaceNotFoundError=class extends v{constructor(e,t={}){super(`Namespace '${e}' not found`,{...t,code:m.NAMESPACE_NOT_FOUND}),this.name="NamespaceNotFoundError",this.namespace=e}},e.NotImplementedError=S,e.ObjectId=i,e.OperationNotSupportedError=class extends y{constructor(e,t,n={}){"object"!=typeof t||n||(n=t,t=void 0);super(t?`Operation '${e}' is not supported: ${t}`:`Operation '${e}' is not supported`,{...n,code:m.OPERATION_NOT_SUPPORTED,operation:e}),this.name="OperationNotSupportedError"}},e.QueryError=_,e.StorageEngine=rt,e.Timestamp=Ee,e.TypeMismatchError=class extends y{constructor(e,t,n,r={}){super(`Type mismatch for field '${e}': expected ${t}, got ${n}`,{...r,code:m.TYPE_MISMATCH,field:e}),this.name="TypeMismatchError",this.expectedType=t,this.actualType=n}},e.ValidationError=class extends y{constructor(e,t={}){super(e,t),this.name="ValidationError",this.code=t.code||m.DOCUMENT_VALIDATION_FAILURE,this.validationErrors=t.validationErrors||[]}},e.WriteError=x,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=micro-mongo-2.0.0.min.umd.js.map
