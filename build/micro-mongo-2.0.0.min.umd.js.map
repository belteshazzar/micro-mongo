{"version":3,"file":"micro-mongo-2.0.0.min.umd.js","sources":["../node_modules/events/events.js","../src/ObjectId.js","../src/utils.js","../src/Cursor.js","../src/SortedCursor.js","../node_modules/stemmer/index.js","../src/IndexStore.js","../src/TextIndex.js","../src/queryMatcher.js","../src/updates.js","../src/Index.js","../src/BPlusTree.js","../src/RegularCollectionIndex.js","../src/TextCollectionIndex.js","../src/RTree.js","../src/GeospatialCollectionIndex.js","../src/QueryPlanner.js","../src/aggregationExpressions.js","../src/ChangeStream.js","../src/Collection.js","../src/DocumentStore.js","../src/CollectionStore.js","../src/StorageEngine.js","../src/DB.js","../src/MongoClient.js","../src/IndexedDbStorageEngine.js"],"sourcesContent":["// Copyright Joyent, Inc. and other Node contributors.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a\n// copy of this software and associated documentation files (the\n// \"Software\"), to deal in the Software without restriction, including\n// without limitation the rights to use, copy, modify, merge, publish,\n// distribute, sublicense, and/or sell copies of the Software, and to permit\n// persons to whom the Software is furnished to do so, subject to the\n// following conditions:\n//\n// The above copyright notice and this permission notice shall be included\n// in all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS\n// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN\n// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR\n// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE\n// USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n'use strict';\n\nvar R = typeof Reflect === 'object' ? Reflect : null\nvar ReflectApply = R && typeof R.apply === 'function'\n  ? R.apply\n  : function ReflectApply(target, receiver, args) {\n    return Function.prototype.apply.call(target, receiver, args);\n  }\n\nvar ReflectOwnKeys\nif (R && typeof R.ownKeys === 'function') {\n  ReflectOwnKeys = R.ownKeys\n} else if (Object.getOwnPropertySymbols) {\n  ReflectOwnKeys = function ReflectOwnKeys(target) {\n    return Object.getOwnPropertyNames(target)\n      .concat(Object.getOwnPropertySymbols(target));\n  };\n} else {\n  ReflectOwnKeys = function ReflectOwnKeys(target) {\n    return Object.getOwnPropertyNames(target);\n  };\n}\n\nfunction ProcessEmitWarning(warning) {\n  if (console && console.warn) console.warn(warning);\n}\n\nvar NumberIsNaN = Number.isNaN || function NumberIsNaN(value) {\n  return value !== value;\n}\n\nfunction EventEmitter() {\n  EventEmitter.init.call(this);\n}\nmodule.exports = EventEmitter;\nmodule.exports.once = once;\n\n// Backwards-compat with node 0.10.x\nEventEmitter.EventEmitter = EventEmitter;\n\nEventEmitter.prototype._events = undefined;\nEventEmitter.prototype._eventsCount = 0;\nEventEmitter.prototype._maxListeners = undefined;\n\n// By default EventEmitters will print a warning if more than 10 listeners are\n// added to it. This is a useful default which helps finding memory leaks.\nvar defaultMaxListeners = 10;\n\nfunction checkListener(listener) {\n  if (typeof listener !== 'function') {\n    throw new TypeError('The \"listener\" argument must be of type Function. Received type ' + typeof listener);\n  }\n}\n\nObject.defineProperty(EventEmitter, 'defaultMaxListeners', {\n  enumerable: true,\n  get: function() {\n    return defaultMaxListeners;\n  },\n  set: function(arg) {\n    if (typeof arg !== 'number' || arg < 0 || NumberIsNaN(arg)) {\n      throw new RangeError('The value of \"defaultMaxListeners\" is out of range. It must be a non-negative number. Received ' + arg + '.');\n    }\n    defaultMaxListeners = arg;\n  }\n});\n\nEventEmitter.init = function() {\n\n  if (this._events === undefined ||\n      this._events === Object.getPrototypeOf(this)._events) {\n    this._events = Object.create(null);\n    this._eventsCount = 0;\n  }\n\n  this._maxListeners = this._maxListeners || undefined;\n};\n\n// Obviously not all Emitters should be limited to 10. This function allows\n// that to be increased. Set to zero for unlimited.\nEventEmitter.prototype.setMaxListeners = function setMaxListeners(n) {\n  if (typeof n !== 'number' || n < 0 || NumberIsNaN(n)) {\n    throw new RangeError('The value of \"n\" is out of range. It must be a non-negative number. Received ' + n + '.');\n  }\n  this._maxListeners = n;\n  return this;\n};\n\nfunction _getMaxListeners(that) {\n  if (that._maxListeners === undefined)\n    return EventEmitter.defaultMaxListeners;\n  return that._maxListeners;\n}\n\nEventEmitter.prototype.getMaxListeners = function getMaxListeners() {\n  return _getMaxListeners(this);\n};\n\nEventEmitter.prototype.emit = function emit(type) {\n  var args = [];\n  for (var i = 1; i < arguments.length; i++) args.push(arguments[i]);\n  var doError = (type === 'error');\n\n  var events = this._events;\n  if (events !== undefined)\n    doError = (doError && events.error === undefined);\n  else if (!doError)\n    return false;\n\n  // If there is no 'error' event listener then throw.\n  if (doError) {\n    var er;\n    if (args.length > 0)\n      er = args[0];\n    if (er instanceof Error) {\n      // Note: The comments on the `throw` lines are intentional, they show\n      // up in Node's output if this results in an unhandled exception.\n      throw er; // Unhandled 'error' event\n    }\n    // At least give some kind of context to the user\n    var err = new Error('Unhandled error.' + (er ? ' (' + er.message + ')' : ''));\n    err.context = er;\n    throw err; // Unhandled 'error' event\n  }\n\n  var handler = events[type];\n\n  if (handler === undefined)\n    return false;\n\n  if (typeof handler === 'function') {\n    ReflectApply(handler, this, args);\n  } else {\n    var len = handler.length;\n    var listeners = arrayClone(handler, len);\n    for (var i = 0; i < len; ++i)\n      ReflectApply(listeners[i], this, args);\n  }\n\n  return true;\n};\n\nfunction _addListener(target, type, listener, prepend) {\n  var m;\n  var events;\n  var existing;\n\n  checkListener(listener);\n\n  events = target._events;\n  if (events === undefined) {\n    events = target._events = Object.create(null);\n    target._eventsCount = 0;\n  } else {\n    // To avoid recursion in the case that type === \"newListener\"! Before\n    // adding it to the listeners, first emit \"newListener\".\n    if (events.newListener !== undefined) {\n      target.emit('newListener', type,\n                  listener.listener ? listener.listener : listener);\n\n      // Re-assign `events` because a newListener handler could have caused the\n      // this._events to be assigned to a new object\n      events = target._events;\n    }\n    existing = events[type];\n  }\n\n  if (existing === undefined) {\n    // Optimize the case of one listener. Don't need the extra array object.\n    existing = events[type] = listener;\n    ++target._eventsCount;\n  } else {\n    if (typeof existing === 'function') {\n      // Adding the second element, need to change to array.\n      existing = events[type] =\n        prepend ? [listener, existing] : [existing, listener];\n      // If we've already got an array, just append.\n    } else if (prepend) {\n      existing.unshift(listener);\n    } else {\n      existing.push(listener);\n    }\n\n    // Check for listener leak\n    m = _getMaxListeners(target);\n    if (m > 0 && existing.length > m && !existing.warned) {\n      existing.warned = true;\n      // No error code for this since it is a Warning\n      // eslint-disable-next-line no-restricted-syntax\n      var w = new Error('Possible EventEmitter memory leak detected. ' +\n                          existing.length + ' ' + String(type) + ' listeners ' +\n                          'added. Use emitter.setMaxListeners() to ' +\n                          'increase limit');\n      w.name = 'MaxListenersExceededWarning';\n      w.emitter = target;\n      w.type = type;\n      w.count = existing.length;\n      ProcessEmitWarning(w);\n    }\n  }\n\n  return target;\n}\n\nEventEmitter.prototype.addListener = function addListener(type, listener) {\n  return _addListener(this, type, listener, false);\n};\n\nEventEmitter.prototype.on = EventEmitter.prototype.addListener;\n\nEventEmitter.prototype.prependListener =\n    function prependListener(type, listener) {\n      return _addListener(this, type, listener, true);\n    };\n\nfunction onceWrapper() {\n  if (!this.fired) {\n    this.target.removeListener(this.type, this.wrapFn);\n    this.fired = true;\n    if (arguments.length === 0)\n      return this.listener.call(this.target);\n    return this.listener.apply(this.target, arguments);\n  }\n}\n\nfunction _onceWrap(target, type, listener) {\n  var state = { fired: false, wrapFn: undefined, target: target, type: type, listener: listener };\n  var wrapped = onceWrapper.bind(state);\n  wrapped.listener = listener;\n  state.wrapFn = wrapped;\n  return wrapped;\n}\n\nEventEmitter.prototype.once = function once(type, listener) {\n  checkListener(listener);\n  this.on(type, _onceWrap(this, type, listener));\n  return this;\n};\n\nEventEmitter.prototype.prependOnceListener =\n    function prependOnceListener(type, listener) {\n      checkListener(listener);\n      this.prependListener(type, _onceWrap(this, type, listener));\n      return this;\n    };\n\n// Emits a 'removeListener' event if and only if the listener was removed.\nEventEmitter.prototype.removeListener =\n    function removeListener(type, listener) {\n      var list, events, position, i, originalListener;\n\n      checkListener(listener);\n\n      events = this._events;\n      if (events === undefined)\n        return this;\n\n      list = events[type];\n      if (list === undefined)\n        return this;\n\n      if (list === listener || list.listener === listener) {\n        if (--this._eventsCount === 0)\n          this._events = Object.create(null);\n        else {\n          delete events[type];\n          if (events.removeListener)\n            this.emit('removeListener', type, list.listener || listener);\n        }\n      } else if (typeof list !== 'function') {\n        position = -1;\n\n        for (i = list.length - 1; i >= 0; i--) {\n          if (list[i] === listener || list[i].listener === listener) {\n            originalListener = list[i].listener;\n            position = i;\n            break;\n          }\n        }\n\n        if (position < 0)\n          return this;\n\n        if (position === 0)\n          list.shift();\n        else {\n          spliceOne(list, position);\n        }\n\n        if (list.length === 1)\n          events[type] = list[0];\n\n        if (events.removeListener !== undefined)\n          this.emit('removeListener', type, originalListener || listener);\n      }\n\n      return this;\n    };\n\nEventEmitter.prototype.off = EventEmitter.prototype.removeListener;\n\nEventEmitter.prototype.removeAllListeners =\n    function removeAllListeners(type) {\n      var listeners, events, i;\n\n      events = this._events;\n      if (events === undefined)\n        return this;\n\n      // not listening for removeListener, no need to emit\n      if (events.removeListener === undefined) {\n        if (arguments.length === 0) {\n          this._events = Object.create(null);\n          this._eventsCount = 0;\n        } else if (events[type] !== undefined) {\n          if (--this._eventsCount === 0)\n            this._events = Object.create(null);\n          else\n            delete events[type];\n        }\n        return this;\n      }\n\n      // emit removeListener for all listeners on all events\n      if (arguments.length === 0) {\n        var keys = Object.keys(events);\n        var key;\n        for (i = 0; i < keys.length; ++i) {\n          key = keys[i];\n          if (key === 'removeListener') continue;\n          this.removeAllListeners(key);\n        }\n        this.removeAllListeners('removeListener');\n        this._events = Object.create(null);\n        this._eventsCount = 0;\n        return this;\n      }\n\n      listeners = events[type];\n\n      if (typeof listeners === 'function') {\n        this.removeListener(type, listeners);\n      } else if (listeners !== undefined) {\n        // LIFO order\n        for (i = listeners.length - 1; i >= 0; i--) {\n          this.removeListener(type, listeners[i]);\n        }\n      }\n\n      return this;\n    };\n\nfunction _listeners(target, type, unwrap) {\n  var events = target._events;\n\n  if (events === undefined)\n    return [];\n\n  var evlistener = events[type];\n  if (evlistener === undefined)\n    return [];\n\n  if (typeof evlistener === 'function')\n    return unwrap ? [evlistener.listener || evlistener] : [evlistener];\n\n  return unwrap ?\n    unwrapListeners(evlistener) : arrayClone(evlistener, evlistener.length);\n}\n\nEventEmitter.prototype.listeners = function listeners(type) {\n  return _listeners(this, type, true);\n};\n\nEventEmitter.prototype.rawListeners = function rawListeners(type) {\n  return _listeners(this, type, false);\n};\n\nEventEmitter.listenerCount = function(emitter, type) {\n  if (typeof emitter.listenerCount === 'function') {\n    return emitter.listenerCount(type);\n  } else {\n    return listenerCount.call(emitter, type);\n  }\n};\n\nEventEmitter.prototype.listenerCount = listenerCount;\nfunction listenerCount(type) {\n  var events = this._events;\n\n  if (events !== undefined) {\n    var evlistener = events[type];\n\n    if (typeof evlistener === 'function') {\n      return 1;\n    } else if (evlistener !== undefined) {\n      return evlistener.length;\n    }\n  }\n\n  return 0;\n}\n\nEventEmitter.prototype.eventNames = function eventNames() {\n  return this._eventsCount > 0 ? ReflectOwnKeys(this._events) : [];\n};\n\nfunction arrayClone(arr, n) {\n  var copy = new Array(n);\n  for (var i = 0; i < n; ++i)\n    copy[i] = arr[i];\n  return copy;\n}\n\nfunction spliceOne(list, index) {\n  for (; index + 1 < list.length; index++)\n    list[index] = list[index + 1];\n  list.pop();\n}\n\nfunction unwrapListeners(arr) {\n  var ret = new Array(arr.length);\n  for (var i = 0; i < ret.length; ++i) {\n    ret[i] = arr[i].listener || arr[i];\n  }\n  return ret;\n}\n\nfunction once(emitter, name) {\n  return new Promise(function (resolve, reject) {\n    function errorListener(err) {\n      emitter.removeListener(name, resolver);\n      reject(err);\n    }\n\n    function resolver() {\n      if (typeof emitter.removeListener === 'function') {\n        emitter.removeListener('error', errorListener);\n      }\n      resolve([].slice.call(arguments));\n    };\n\n    eventTargetAgnosticAddListener(emitter, name, resolver, { once: true });\n    if (name !== 'error') {\n      addErrorHandlerIfEventEmitter(emitter, errorListener, { once: true });\n    }\n  });\n}\n\nfunction addErrorHandlerIfEventEmitter(emitter, handler, flags) {\n  if (typeof emitter.on === 'function') {\n    eventTargetAgnosticAddListener(emitter, 'error', handler, flags);\n  }\n}\n\nfunction eventTargetAgnosticAddListener(emitter, name, listener, flags) {\n  if (typeof emitter.on === 'function') {\n    if (flags.once) {\n      emitter.once(name, listener);\n    } else {\n      emitter.on(name, listener);\n    }\n  } else if (typeof emitter.addEventListener === 'function') {\n    // EventTarget does not have `error` event semantics like Node\n    // EventEmitters, we do not listen for `error` events here.\n    emitter.addEventListener(name, function wrapListener(arg) {\n      // IE does not have builtin `{ once: true }` support so we\n      // have to do it manually.\n      if (flags.once) {\n        emitter.removeEventListener(name, wrapListener);\n      }\n      listener(arg);\n    });\n  } else {\n    throw new TypeError('The \"emitter\" argument must be of type EventEmitter. Received type ' + typeof emitter);\n  }\n}\n","/**\r\n * ObjectId class - MongoDB-compatible 24-character hex string identifier\r\n * Format: 8-char timestamp + 16-char random data\r\n */\r\nexport class ObjectId {\r\n  constructor(id) {\r\n    if (id === undefined || id === null) {\r\n      // Generate new ObjectId\r\n      this.id = ObjectId.generate();\r\n    } else if (typeof id === 'string') {\r\n      // Create from hex string\r\n      if (!ObjectId.isValid(id)) {\r\n        throw new Error(`Argument passed in must be a string of 24 hex characters, got: ${id}`);\r\n      }\r\n      this.id = id.toLowerCase();\r\n    } else if (id instanceof ObjectId) {\r\n      // Copy constructor\r\n      this.id = id.id;\r\n    } else {\r\n      throw new Error(`Argument passed in must be a string of 24 hex characters or an ObjectId`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns the ObjectId as a 24-character hex string\r\n   */\r\n  toString() {\r\n    return this.id;\r\n  }\r\n\r\n  /**\r\n   * Returns the ObjectId as a 24-character hex string (alias for toString)\r\n   */\r\n  toHexString() {\r\n    return this.id;\r\n  }\r\n\r\n  /**\r\n   * Returns the timestamp portion of the ObjectId as a Date\r\n   */\r\n  getTimestamp() {\r\n    const timestamp = parseInt(this.id.substring(0, 8), 16);\r\n    return new Date(timestamp * 1000);\r\n  }\r\n\r\n  /**\r\n   * Compares this ObjectId with another for equality\r\n   */\r\n  equals(other) {\r\n    if (!other) return false;\r\n    \r\n    if (other instanceof ObjectId) {\r\n      return this.id === other.id;\r\n    }\r\n    \r\n    if (typeof other === 'string') {\r\n      return this.id === other.toLowerCase();\r\n    }\r\n    \r\n    // Handle objects with id property\r\n    if (other.id) {\r\n      return this.id === other.id;\r\n    }\r\n    \r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Returns the ObjectId in JSON format (as hex string)\r\n   */\r\n  toJSON() {\r\n    return this.id;\r\n  }\r\n\r\n  /**\r\n   * Custom inspect for Node.js console.log\r\n   */\r\n  inspect() {\r\n    return `ObjectId(\"${this.id}\")`;\r\n  }\r\n\r\n  /**\r\n   * Validates if a string is a valid ObjectId hex string\r\n   */\r\n  static isValid(id) {\r\n    if (!id) return false;\r\n    if (typeof id !== 'string') return false;\r\n    if (id.length !== 24) return false;\r\n    return /^[0-9a-fA-F]{24}$/.test(id);\r\n  }\r\n\r\n  /**\r\n   * Creates an ObjectId from a timestamp\r\n   */\r\n  static createFromTime(timestamp) {\r\n    const ts = Math.floor(timestamp / 1000);\r\n    const tsHex = ('00000000' + ts.toString(16)).slice(-8);\r\n    const tail = '0000000000000000'; // Zero out the random portion\r\n    return new ObjectId(tsHex + tail);\r\n  }\r\n\r\n  /**\r\n   * Generates a new ObjectId hex string\r\n   * Format: 8-char timestamp (4 bytes) + 16-char random data (8 bytes)\r\n   */\r\n  static generate() {\r\n    const ts = Math.floor(Date.now() / 1000);\r\n    \r\n    // Generate 8 random bytes\r\n    const rand = typeof crypto !== 'undefined' && crypto.getRandomValues ? new Uint8Array(8) : null;\r\n    let tail = '';\r\n    \r\n    if (rand) {\r\n      crypto.getRandomValues(rand);\r\n      for (let i = 0; i < rand.length; i++) {\r\n        tail += ('0' + rand[i].toString(16)).slice(-2);\r\n      }\r\n    } else {\r\n      // Fallback for environments without crypto\r\n      // Generate two 8-character hex strings\r\n      tail = Math.random().toString(16).slice(2).padEnd(8, '0').slice(0, 8) +\r\n             Math.random().toString(16).slice(2).padEnd(8, '0').slice(0, 8);\r\n    }\r\n    \r\n    const tsHex = ('00000000' + ts.toString(16)).slice(-8);\r\n    return (tsHex + tail).slice(0, 24);\r\n  }\r\n}","/**\n * Utility functions for MicroMongoDB\n */\n\nimport { ObjectId } from './ObjectId.js';\n\n/**\n * Compare two values for equality, handling ObjectId instances\n */\nfunction valuesEqual(a, b) {\n\t// Handle ObjectId comparison\n\tif (a instanceof ObjectId || b instanceof ObjectId) {\n\t\tif (a instanceof ObjectId && b instanceof ObjectId) {\n\t\t\treturn a.equals(b);\n\t\t}\n\t\tif (a instanceof ObjectId && typeof b === 'string') {\n\t\t\treturn a.equals(b);\n\t\t}\n\t\tif (b instanceof ObjectId && typeof a === 'string') {\n\t\t\treturn b.equals(a);\n\t\t}\n\t\treturn false;\n\t}\n\t\n\t// Regular equality\n\treturn a == b;\n}\n\n/**\n * Deep copy an object or array\n */\nexport function copy(o) {\n\t// Handle ObjectId\n\tif (o instanceof ObjectId) {\n\t\treturn new ObjectId(o.id);\n\t}\n\t\n\tvar out, v, key;\n\tout = Array.isArray(o) ? [] : {};\n\tfor (key in o) {\n\t\tv = o[key];\n\t\tout[key] = (typeof v === \"object\" && v !== null) ? copy(v) : v;\n\t}\n\treturn out;\n}\n\n/**\n * Get a property from an object using dot notation\n * Supports array element access via numeric indices (e.g., \"items.0.name\")\n */\nexport function getProp(obj, name) {\n\tvar path = name.split(\".\");\n\tvar result = obj[path[0]];\n\tfor (var i = 1; i < path.length; i++) {\n\t\tif (result == undefined || result == null) return result;\n\t\t\n\t\t// Check if this path segment is a numeric index\n\t\tvar pathSegment = path[i];\n\t\tvar numericIndex = parseInt(pathSegment, 10);\n\t\t\n\t\t// If it's a valid array index, use it\n\t\tif (isArray(result) && !isNaN(numericIndex) && numericIndex >= 0 && numericIndex < result.length) {\n\t\t\tresult = result[numericIndex];\n\t\t} else {\n\t\t\tresult = result[pathSegment];\n\t\t}\n\t}\n\treturn result;\n}\n\n/**\n * Get field values for query matching, handling MongoDB-style array traversal\n * When a path traverses an array, this returns all matching values from array elements\n * Returns an array of values if array traversal occurred, otherwise the single value\n * \n * Example:\n *   doc = { items: [{ price: 10 }, { price: 20 }] }\n *   getFieldValues(doc, 'items.price') -> [10, 20]\n */\nexport function getFieldValues(obj, name) {\n\tvar path = name.split(\".\");\n\tvar results = [obj];\n\t\n\tfor (var i = 0; i < path.length; i++) {\n\t\tvar pathSegment = path[i];\n\t\tvar numericIndex = parseInt(pathSegment, 10);\n\t\tvar newResults = [];\n\t\t\n\t\tfor (var j = 0; j < results.length; j++) {\n\t\t\tvar current = results[j];\n\t\t\tif (current == undefined || current == null) continue;\n\t\t\t\n\t\t\t// If this is a numeric index and current is an array, access that element\n\t\t\tif (isArray(current) && !isNaN(numericIndex) && numericIndex >= 0) {\n\t\t\t\tif (numericIndex < current.length) {\n\t\t\t\t\tnewResults.push(current[numericIndex]);\n\t\t\t\t}\n\t\t\t}\n\t\t\t// If current is an array but path segment is not numeric, traverse all elements\n\t\t\telse if (isArray(current)) {\n\t\t\t\tfor (var k = 0; k < current.length; k++) {\n\t\t\t\t\tif (current[k] != undefined && current[k] != null && typeof current[k] === 'object') {\n\t\t\t\t\t\tnewResults.push(current[k][pathSegment]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\t// Otherwise, normal property access\n\t\t\telse if (typeof current === 'object') {\n\t\t\t\tnewResults.push(current[pathSegment]);\n\t\t\t}\n\t\t}\n\t\t\n\t\tresults = newResults;\n\t}\n\t\n\t// Filter out undefined values\n\tresults = results.filter(function(v) { return v !== undefined; });\n\t\n\t// If we have multiple values, return the array\n\t// If we have exactly one, return it directly\n\t// If we have none, return undefined\n\tif (results.length === 0) return undefined;\n\tif (results.length === 1) return results[0];\n\treturn results;\n}\n\n/**\n * Set a property on an object using dot notation\n * Creates intermediate objects as needed\n * Supports array element access via numeric indices\n */\nexport function setProp(obj, name, value) {\n\tvar path = name.split(\".\");\n\tvar current = obj;\n\t\n\tfor (var i = 0; i < path.length - 1; i++) {\n\t\tvar pathSegment = path[i];\n\t\tvar numericIndex = parseInt(pathSegment, 10);\n\t\t\n\t\t// If this is a numeric index and current is an array\n\t\tif (isArray(current) && !isNaN(numericIndex) && numericIndex >= 0) {\n\t\t\t// Ensure the array is large enough\n\t\t\twhile (current.length <= numericIndex) {\n\t\t\t\tcurrent.push(undefined);\n\t\t\t}\n\t\t\t// If the element doesn't exist, create an object\n\t\t\tif (current[numericIndex] == undefined || current[numericIndex] == null) {\n\t\t\t\t// Look ahead to see if next segment is numeric (array) or not (object)\n\t\t\t\tvar nextSegment = path[i + 1];\n\t\t\t\tvar nextNumeric = parseInt(nextSegment, 10);\n\t\t\t\tif (!isNaN(nextNumeric) && nextNumeric >= 0) {\n\t\t\t\t\tcurrent[numericIndex] = [];\n\t\t\t\t} else {\n\t\t\t\t\tcurrent[numericIndex] = {};\n\t\t\t\t}\n\t\t\t}\n\t\t\tcurrent = current[numericIndex];\n\t\t}\n\t\t// Regular property access\n\t\telse {\n\t\t\tif (current[pathSegment] == undefined || current[pathSegment] == null) {\n\t\t\t\t// Look ahead to see if next segment is numeric (array) or not (object)\n\t\t\t\tvar nextSegment = path[i + 1];\n\t\t\t\tvar nextNumeric = parseInt(nextSegment, 10);\n\t\t\t\tif (!isNaN(nextNumeric) && nextNumeric >= 0) {\n\t\t\t\t\tcurrent[pathSegment] = [];\n\t\t\t\t} else {\n\t\t\t\t\tcurrent[pathSegment] = {};\n\t\t\t\t}\n\t\t\t}\n\t\t\tcurrent = current[pathSegment];\n\t\t}\n\t}\n\t\n\t// Set the final value\n\tvar lastSegment = path[path.length - 1];\n\tvar lastNumericIndex = parseInt(lastSegment, 10);\n\t\n\tif (isArray(current) && !isNaN(lastNumericIndex) && lastNumericIndex >= 0) {\n\t\twhile (current.length <= lastNumericIndex) {\n\t\t\tcurrent.push(undefined);\n\t\t}\n\t\tcurrent[lastNumericIndex] = value;\n\t} else {\n\t\tcurrent[lastSegment] = value;\n\t}\n}\n\n/**\n * Check if value is an array\n */\nexport function isArray(o) {\n\treturn Array == o.constructor;\n}\n\n/**\n * Convert object to array of key-value pairs\n */\nexport function toArray(obj) {\n\tvar arr = [];\n\tfor (var key in obj) {\n\t\tif (obj.hasOwnProperty(key)) {\n\t\t\tvar el = {};\n\t\t\tel[key] = obj[key];\n\t\t\tarr.push(el);\n\t\t}\n\t}\n\treturn arr;\n}\n\n/**\n * Check if a value is in an array\n */\nexport function isIn(val, values) {\n\tfor (var i = 0; i < values.length; i++) {\n\t\tif (valuesEqual(values[i], val)) return true;\n\t}\n\treturn false;\n}\n\n/**\n * Check if two arrays match\n */\nexport function arrayMatches(x, y) {\n\tif (x.length != y.length) return false;\n\tfor (var i = 0; i < x.length; i++) {\n\t\tif (valuesEqual(x[i], y[i])) continue;\n\t\tif (typeof (x[i]) != typeof (y[i])) return false;\n\t\tif (typeof (x[i]) == \"object\" && x[i] !== null) {\n\t\t\tif (isArray(x[i])) {\n\t\t\t\tif (!arrayMatches(x[i], y[i])) return false;\n\t\t\t} else {\n\t\t\t\tif (!objectMatches(x[i], y[i])) return false;\n\t\t\t}\n\t\t} else {\n\t\t\tif (!valuesEqual(x[i], y[i])) return false;\n\t\t}\n\t}\n\treturn true;\n}\n\n/**\n * Check if two objects match\n */\nexport function objectMatches(x, y) {\n\tfor (var p in x) {\n\t\tif (!x.hasOwnProperty(p)) continue;\n\t\tif (!y.hasOwnProperty(p)) return false;\n\t\tif (valuesEqual(x[p], y[p])) continue;\n\t\tif (typeof (x[p]) != typeof (y[p])) return false;\n\t\tif (typeof (x[p]) == \"object\" && x[p] !== null) {\n\t\t\tif (isArray(x[p])) {\n\t\t\t\tif (!arrayMatches(x[p], y[p])) return false;\n\t\t\t} else {\n\t\t\t\tif (!objectMatches(x[p], y[p])) return false;\n\t\t\t}\n\t\t} else {\n\t\t\tif (!valuesEqual(x[p], y[p])) return false;\n\t\t}\n\t}\n\tfor (var p in y) {\n\t\tif (y.hasOwnProperty(p) && !x.hasOwnProperty(p)) return false;\n\t}\n\treturn true;\n}\n\n/**\n * Apply projection to a document\n */\nexport function applyProjection(projection, doc) {\n\tvar result = {};\n\tvar keys = Object.keys(projection);\n\tif (keys.length == 0) return doc;\n\t\n\t// Check for mixed inclusion/exclusion (except _id which can be excluded in inclusion projection)\n\tvar hasInclusion = false;\n\tvar hasExclusion = false;\n\tfor (var i = 0; i < keys.length; i++) {\n\t\tif (keys[i] === '_id') continue; // _id is special\n\t\tif (projection[keys[i]]) hasInclusion = true;\n\t\telse hasExclusion = true;\n\t}\n\t\n\tif (hasInclusion && hasExclusion) {\n\t\tthrow { $err: \"Can't canonicalize query: BadValue Projection cannot have a mix of inclusion and exclusion.\", code: 17287 };\n\t}\n\t\n\tif (projection[keys[0]] || hasInclusion) {\n\t\t// Inclusion projection\n\t\t// Include _id unless explicitly excluded\n\t\tif (projection._id !== 0) {\n\t\t\tresult._id = doc._id;\n\t\t}\n\t\t\n\t\tfor (var i = 0; i < keys.length; i++) {\n\t\t\tif (keys[i] === '_id') continue;\n\t\t\tif (!projection[keys[i]]) continue;\n\t\t\t\n\t\t\tvar fieldPath = keys[i];\n\t\t\tvar value = getProp(doc, fieldPath);\n\t\t\t\n\t\t\tif (value !== undefined) {\n\t\t\t\t// Use setProp to create nested structure\n\t\t\t\tsetProp(result, fieldPath, value);\n\t\t\t}\n\t\t}\n\t} else {\n\t\t// Exclusion projection - start with a copy of the document\n\t\tfor (var key in doc) {\n\t\t\tif (doc.hasOwnProperty(key)) {\n\t\t\t\t// Deep copy the value\n\t\t\t\tvar val = doc[key];\n\t\t\t\tif (typeof val === 'object' && val !== null && !isArray(val)) {\n\t\t\t\t\tresult[key] = copy(val);\n\t\t\t\t} else if (isArray(val)) {\n\t\t\t\t\tresult[key] = val.slice(); // shallow copy array\n\t\t\t\t} else {\n\t\t\t\t\tresult[key] = val;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t\n\t\t// Remove excluded fields\n\t\tfor (var i = 0; i < keys.length; i++) {\n\t\t\tif (projection[keys[i]]) continue; // Skip if value is truthy\n\t\t\t\n\t\t\tvar fieldPath = keys[i];\n\t\t\tvar pathParts = fieldPath.split('.');\n\t\t\t\n\t\t\t// Navigate to the parent object and delete the final property\n\t\t\tif (pathParts.length === 1) {\n\t\t\t\tdelete result[fieldPath];\n\t\t\t} else {\n\t\t\t\tvar parent = result;\n\t\t\t\tfor (var j = 0; j < pathParts.length - 1; j++) {\n\t\t\t\t\tif (parent == undefined || parent == null) break;\n\t\t\t\t\tparent = parent[pathParts[j]];\n\t\t\t\t}\n\t\t\t\tif (parent != undefined && parent != null) {\n\t\t\t\t\tdelete parent[pathParts[pathParts.length - 1]];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\treturn result;\n}\n\n/**\n * Convert bbox to GeoJSON\n */\nexport function bboxToGeojson(bbox) {\n\tconst minLon = bbox[0][0];\n\tconst maxLat = bbox[0][1];\n\tconst maxLon = bbox[1][0];\n\tconst minLat = bbox[1][1];\n\treturn {\n\t\ttype: 'FeatureCollection',\n\t\tfeatures: [{\n\t\t\ttype: 'Feature',\n\t\t\tproperties: {},\n\t\t\tgeometry: {\n\t\t\t\ttype: 'Polygon',\n\t\t\t\tcoordinates: [[\n\t\t\t\t\t[minLon, maxLat],\n\t\t\t\t\t[minLon, minLat],\n\t\t\t\t\t[maxLon, minLat],\n\t\t\t\t\t[maxLon, maxLat],\n\t\t\t\t\t[minLon, maxLat]\n\t\t\t\t]]\n\t\t\t}\n\t\t}]\n\t};\n}\n","import { applyProjection } from './utils.js';\n\n/**\n * Cursor class for iterating over query results\n * Now a simple iterator over pre-filtered documents\n */\nexport class Cursor {\n\tconstructor(collection, query, projection, documents, SortedCursor) {\n\t\tthis.collection = collection;\n\t\tthis.query = query;\n\t\tthis.projection = projection;\n\t\tthis.documents = documents; // Pre-filtered array of documents\n\t\tthis.SortedCursor = SortedCursor;\n\n\t\t// Validate projection if provided\n\t\tif (projection && Object.keys(projection).length > 0) {\n\t\t\tconst keys = Object.keys(projection);\n\t\t\tlet hasInclusion = false;\n\t\t\tlet hasExclusion = false;\n\t\t\tfor (let i = 0; i < keys.length; i++) {\n\t\t\t\tif (keys[i] === '_id') continue; // _id is special\n\t\t\t\tif (projection[keys[i]]) hasInclusion = true;\n\t\t\t\telse hasExclusion = true;\n\t\t\t}\n\t\t\t\n\t\t\tif (hasInclusion && hasExclusion) {\n\t\t\t\tthrow { $err: \"Can't canonicalize query: BadValue Projection cannot have a mix of inclusion and exclusion.\", code: 17287 };\n\t\t\t}\n\t\t}\n\t\t\n\t\tthis.pos = 0;\n\t\tthis.max = 0;\n\t}\n\n\tbatchSize() { throw \"Not Implemented\"; }\n\tclose() { throw \"Not Implemented\"; }\n\tcomment() { throw \"Not Implemented\"; }\n\t\n\tcount() {\n\t\t// Return total count without considering skip/limit applied to this cursor\n\t\treturn this.documents.length;\n\t}\n\t\n\texplain() { throw \"Not Implemented\"; }\n\t\n\tasync forEach(fn) {\n\t\twhile (this.hasNext()) {\n\t\t\tawait fn(this.next());\n\t\t}\n\t}\n\t\n\thasNext() {\n\t\tconst effectiveMax = this.max > 0 ? Math.min(this.max, this.documents.length) : this.documents.length;\n\t\treturn this.pos < effectiveMax;\n\t}\n\t\n\thint() { throw \"Not Implemented\"; }\n\titcount() { throw \"Not Implemented\"; }\n\t\n\tlimit(_max) {\n\t\tthis.max = _max;\n\t\treturn this;\n\t}\n\t\n\tmap(fn) {\n\t\tconst results = [];\n\t\twhile (this.hasNext()) {\n\t\t\tresults.push(fn(this.next()));\n\t\t}\n\t\treturn results;\n\t}\n\t\n\tmaxScan() { throw \"Not Implemented\"; }\n\tmaxTimeMS() { throw \"Not Implemented\"; }\n\tmax() { throw \"Not Implemented\"; }\n\tmin() { throw \"Not Implemented\"; }\n\t\n\tnext() {\n\t\tif (!this.hasNext()) {\n\t\t\tthrow \"Error: error hasNext: false\";\n\t\t}\n\t\tconst result = this.documents[this.pos++];\n\t\tif (this.projection) {\n\t\t\treturn applyProjection(this.projection, result);\n\t\t}\n\t\treturn result;\n\t}\n\t\n\tnoCursorTimeout() { throw \"Not Implemented\"; }\n\tobjsLeftInBatch() { throw \"Not Implemented\"; }\n\tpretty() { throw \"Not Implemented\"; }\n\treadConcern() { throw \"Not Implemented\"; }\n\treadPref() { throw \"Not Implemented\"; }\n\treturnKey() { throw \"Not Implemented\"; }\n\tshowRecordId() { throw \"Not Implemented\"; }\n\tsize() { throw \"Not Implemented\"; }\n\t\n\tskip(num) {\n\t\tthis.pos = Math.min(this.pos + num, this.documents.length);\n\t\treturn this;\n\t}\n\t\n\tsnapshot() { throw \"Not Implemented\"; }\n\t\n\tsort(s) {\n\t\treturn new this.SortedCursor(this.collection, this.query, this, s);\n\t}\n\t\n\ttailable() { throw \"Not Implemented\"; }\n\t\n\tasync toArray() {\n\t\tconst results = [];\n\t\twhile (this.hasNext()) {\n\t\t\tresults.push(this.next());\n\t\t}\n\t\treturn results;\n\t}\n\t\n\t// Support for async iteration (for await...of)\n\tasync *[Symbol.asyncIterator]() {\n\t\twhile (this.hasNext()) {\n\t\t\tyield this.next();\n\t\t}\n\t}\n}\n","/**\n * SortedCursor class for iterating over sorted query results\n */\nexport class SortedCursor {\n\tconstructor(collection, query, cursor, sort) {\n\t\tthis.collection = collection;\n\t\tthis.query = query;\n\t\tthis.sortSpec = sort;\n\t\tthis.pos = 0;\n\t\tthis.items = [];\n\t\t\n\t\t// Collect all items from the cursor\n\t\twhile (cursor.hasNext()) {\n\t\t\tthis.items.push(cursor.next());\n\t\t}\n\t\t\n\t\t// Sort the items\n\t\tconst sortKeys = Object.keys(sort);\n\t\tthis.items.sort(function(a, b) {\n\t\t\tfor (let i = 0; i < sortKeys.length; i++) {\n\t\t\t\tif (a[sortKeys[i]] == undefined && b[sortKeys[i]] != undefined) return -1 * sort[sortKeys[i]];\n\t\t\t\tif (a[sortKeys[i]] != undefined && b[sortKeys[i]] == undefined) return 1 * sort[sortKeys[i]];\n\t\t\t\tif (a[sortKeys[i]] < b[sortKeys[i]]) return -1 * sort[sortKeys[i]];\n\t\t\t\tif (a[sortKeys[i]] > b[sortKeys[i]]) return 1 * sort[sortKeys[i]];\n\t\t\t}\n\t\t\treturn 0;\n\t\t});\n\t}\n\n\tbatchSize() { throw \"Not Implemented\"; }\n\tclose() { throw \"Not Implemented\"; }\n\tcomment() { throw \"Not Implemented\"; }\n\t\n\tcount() {\n\t\treturn this.items.length;\n\t}\n\t\n\texplain() { throw \"Not Implemented\"; }\n\t\n\tasync forEach(fn) {\n\t\twhile (this.hasNext()) {\n\t\t\tawait fn(this.next());\n\t\t}\n\t}\n\t\n\thasNext() {\n\t\treturn this.pos < this.items.length;\n\t}\n\t\n\thint() { throw \"Not Implemented\"; }\n\titcount() { throw \"Not Implemented\"; }\n\t\n\tlimit(max) {\n\t\tthis.items = this.items.slice(0, max);\n\t\treturn this;\n\t}\n\t\n\tmap(fn) {\n\t\tconst results = [];\n\t\twhile (this.hasNext()) {\n\t\t\tresults.push(fn(this.next()));\n\t\t}\n\t\treturn results;\n\t}\n\t\n\tmaxScan() { throw \"Not Implemented\"; }\n\tmaxTimeMS() { throw \"Not Implemented\"; }\n\tmax() { throw \"Not Implemented\"; }\n\tmin() { throw \"Not Implemented\"; }\n\t\n\tnext() {\n\t\treturn this.items[this.pos++];\n\t}\n\t\n\tnoCursorTimeout() { throw \"Not Implemented\"; }\n\tobjsLeftInBatch() { throw \"Not Implemented\"; }\n\tpretty() { throw \"Not Implemented\"; }\n\treadConcern() { throw \"Not Implemented\"; }\n\treadPref() { throw \"Not Implemented\"; }\n\treturnKey() { throw \"Not Implemented\"; }\n\tshowRecordId() { throw \"Not Implemented\"; }\n\tsize() { throw \"Not Implemented\"; }\n\t\n\tskip(num) {\n\t\twhile (num > 0) {\n\t\t\tthis.next();\n\t\t\tnum--;\n\t\t}\n\t\treturn this;\n\t}\n\t\n\tsnapshot() { throw \"Not Implemented\"; }\n\t\n\tsort(s) {\n\t\treturn new SortedCursor(this.collection, this.query, this, s);\n\t}\n\t\n\ttailable() { throw \"Not Implemented\"; }\n\t\n\tasync toArray() {\n\t\tconst results = [];\n\t\twhile (this.hasNext()) {\n\t\t\tresults.push(this.next());\n\t\t}\n\t\treturn results;\n\t}\n\t\n\t// Support for async iteration (for await...of)\n\tasync *[Symbol.asyncIterator]() {\n\t\twhile (this.hasNext()) {\n\t\t\tyield this.next();\n\t\t}\n\t}\n}\n","// Standard suffix manipulations.\n/** @type {Record<string, string>} */\nconst step2list = {\n  ational: 'ate',\n  tional: 'tion',\n  enci: 'ence',\n  anci: 'ance',\n  izer: 'ize',\n  bli: 'ble',\n  alli: 'al',\n  entli: 'ent',\n  eli: 'e',\n  ousli: 'ous',\n  ization: 'ize',\n  ation: 'ate',\n  ator: 'ate',\n  alism: 'al',\n  iveness: 'ive',\n  fulness: 'ful',\n  ousness: 'ous',\n  aliti: 'al',\n  iviti: 'ive',\n  biliti: 'ble',\n  logi: 'log'\n}\n\n/** @type {Record<string, string>} */\nconst step3list = {\n  icate: 'ic',\n  ative: '',\n  alize: 'al',\n  iciti: 'ic',\n  ical: 'ic',\n  ful: '',\n  ness: ''\n}\n\n// Consonant-vowel sequences.\nconst consonant = '[^aeiou]'\nconst vowel = '[aeiouy]'\nconst consonants = '(' + consonant + '[^aeiouy]*)'\nconst vowels = '(' + vowel + '[aeiou]*)'\n\nconst gt0 = new RegExp('^' + consonants + '?' + vowels + consonants)\nconst eq1 = new RegExp(\n  '^' + consonants + '?' + vowels + consonants + vowels + '?$'\n)\nconst gt1 = new RegExp('^' + consonants + '?(' + vowels + consonants + '){2,}')\nconst vowelInStem = new RegExp('^' + consonants + '?' + vowel)\nconst consonantLike = new RegExp('^' + consonants + vowel + '[^aeiouwxy]$')\n\n// Exception expressions.\nconst sfxLl = /ll$/\nconst sfxE = /^(.+?)e$/\nconst sfxY = /^(.+?)y$/\nconst sfxIon = /^(.+?(s|t))(ion)$/\nconst sfxEdOrIng = /^(.+?)(ed|ing)$/\nconst sfxAtOrBlOrIz = /(at|bl|iz)$/\nconst sfxEED = /^(.+?)eed$/\nconst sfxS = /^.+?[^s]s$/\nconst sfxSsesOrIes = /^.+?(ss|i)es$/\nconst sfxMultiConsonantLike = /([^aeiouylsz])\\1$/\nconst step2 =\n  /^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$/\nconst step3 = /^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/\nconst step4 =\n  /^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$/\n\n/**\n * Get the stem from a given value.\n *\n * @param {string} value\n *   Value to stem.\n * @returns {string}\n *   Stem for `value`\n */\n// eslint-disable-next-line complexity\nexport function stemmer(value) {\n  let result = String(value).toLowerCase()\n\n  // Exit early.\n  if (result.length < 3) {\n    return result\n  }\n\n  /** @type {boolean} */\n  let firstCharacterWasLowerCaseY = false\n\n  // Detect initial `y`, make sure it never matches.\n  if (\n    result.codePointAt(0) === 121 // Lowercase Y\n  ) {\n    firstCharacterWasLowerCaseY = true\n    result = 'Y' + result.slice(1)\n  }\n\n  // Step 1a.\n  if (sfxSsesOrIes.test(result)) {\n    // Remove last two characters.\n    result = result.slice(0, -2)\n  } else if (sfxS.test(result)) {\n    // Remove last character.\n    result = result.slice(0, -1)\n  }\n\n  /** @type {RegExpMatchArray|null} */\n  let match\n\n  // Step 1b.\n  if ((match = sfxEED.exec(result))) {\n    if (gt0.test(match[1])) {\n      // Remove last character.\n      result = result.slice(0, -1)\n    }\n  } else if ((match = sfxEdOrIng.exec(result)) && vowelInStem.test(match[1])) {\n    result = match[1]\n\n    if (sfxAtOrBlOrIz.test(result)) {\n      // Append `e`.\n      result += 'e'\n    } else if (sfxMultiConsonantLike.test(result)) {\n      // Remove last character.\n      result = result.slice(0, -1)\n    } else if (consonantLike.test(result)) {\n      // Append `e`.\n      result += 'e'\n    }\n  }\n\n  // Step 1c.\n  if ((match = sfxY.exec(result)) && vowelInStem.test(match[1])) {\n    // Remove suffixing `y` and append `i`.\n    result = match[1] + 'i'\n  }\n\n  // Step 2.\n  if ((match = step2.exec(result)) && gt0.test(match[1])) {\n    result = match[1] + step2list[match[2]]\n  }\n\n  // Step 3.\n  if ((match = step3.exec(result)) && gt0.test(match[1])) {\n    result = match[1] + step3list[match[2]]\n  }\n\n  // Step 4.\n  if ((match = step4.exec(result))) {\n    if (gt1.test(match[1])) {\n      result = match[1]\n    }\n  } else if ((match = sfxIon.exec(result)) && gt1.test(match[1])) {\n    result = match[1]\n  }\n\n  // Step 5.\n  if (\n    (match = sfxE.exec(result)) &&\n    (gt1.test(match[1]) ||\n      (eq1.test(match[1]) && !consonantLike.test(match[1])))\n  ) {\n    result = match[1]\n  }\n\n  if (sfxLl.test(result) && gt1.test(result)) {\n    result = result.slice(0, -1)\n  }\n\n  // Turn initial `Y` back to `y`.\n  if (firstCharacterWasLowerCaseY) {\n    result = 'y' + result.slice(1)\n  }\n\n  return result\n}\n","/**\n * IndexStore - In-memory index storage for collections\n * \n * Simple key-value store using a plain JavaScript object\n */\nexport class IndexStore {\n\tconstructor(meta) {\n    this._meta = new Map();\n\t\tthis._data = new Map();\n    \n    if (meta) {\n      for (const [key, value] of Object.entries(meta)) {\n        this._meta.set(key, value);\n      }\n    }\n\t}\n\n\tsetMeta(key, value) {\n\t\tthis._meta.set(key, value);\n\t}\n\n  hasMeta(key) {\n    return this._meta.has(key);\n  }\n\n  getMeta(key) {\n\t\treturn this._meta.get(key);\n\t}\n\n  hasDataMap(name) {\n    return this._data.has(name);\n  }\n\n  getDataMap(name) {\n    if (!this._data.has(name)) {\n      this._data.set(name, new Map());\n    }\n    return this._data.get(name);\n  }\n\n\t// clear() {\n\t// \tthis._data.clear();\n\t// }\n\n  // keys() {\n  //   return this._data.keys();\n  // }\n\n  // has(index) {\n  //   return this._data.has(index);\n  // }\n\n\t// get(index) {\n\t// \treturn this._data.get(index);\n\t// }\n\n\t// remove(key) {\n\t// \tthis._data.delete(key);\n\t// }\n\n\t// set(key, value) {\n\t// \tthis._data.set(key, value);\n\t// }\n\n\t// size() {\n\t// \treturn this._data.size;\n\t// }\n}\n","import { stemmer } from 'stemmer';\nimport { IndexStore } from './IndexStore.js';\n\n// Common English stop words that don't add semantic value to searches\nconst STOPWORDS = new Set([\n  'a', 'about', 'after', 'all', 'also', 'am', 'an', 'and', 'another', 'any', 'are', \n  'around', 'as', 'at', 'be', 'because', 'been', 'before', 'being', 'between', 'both', \n  'but', 'by', 'came', 'can', 'come', 'could', 'did', 'do', 'each', 'for', 'from', \n  'get', 'got', 'has', 'had', 'he', 'have', 'her', 'here', 'him', 'himself', 'his', \n  'how', 'i', 'if', 'in', 'into', 'is', 'it', 'like', 'make', 'many', 'me', 'might', \n  'more', 'most', 'much', 'must', 'my', 'never', 'now', 'of', 'on', 'only', 'or', \n  'other', 'our', 'out', 'over', 'said', 'same', 'see', 'should', 'since', 'some', \n  'still', 'such', 'take', 'than', 'that', 'the', 'their', 'them', 'then', 'there', \n  'these', 'they', 'this', 'those', 'through', 'to', 'too', 'under', 'up', 'very', \n  'was', 'way', 'we', 'well', 'were', 'what', 'where', 'which', 'while', 'who', \n  'with', 'would', 'you', 'your'\n]);\n\n/**\n * TextIndex - A text index implementation using Porter stemmer algorithm\n * \n * This class provides full-text search capabilities by indexing terms\n * and associating them with document IDs. It uses the Porter stemmer\n * algorithm to normalize words to their root forms.\n */\nexport class TextIndex {\n  constructor(storage = new IndexStore()) {\n    // Storage for persistence\n    this.storage = storage;\n    // Map from stemmed term to Map of document IDs to term frequency\n    // Structure: term -> { docId: frequency }\n    this.index = this.storage.getDataMap('index');\n    // Map from document ID to Map of stemmed terms to their frequency\n    // Structure: docId -> { term: frequency }\n    this.documentTerms = this.storage.getDataMap('documentTerms');\n    // Map from document ID to total term count (for normalization)\n    this.documentLengths = this.storage.getDataMap('documentLengths');\n  }\n\n  /**\n   * Tokenize text into individual words\n   * @param {string} text - The text to tokenize\n   * @returns {string[]} Array of words\n   */\n  _tokenize(text) {\n    if (typeof text !== 'string') {\n      return [];\n    }\n    // Split on non-word characters and filter out empty strings\n    const words = text.toLowerCase()\n      .split(/\\W+/)\n      .filter(word => word.length > 0);\n    \n    // Filter stop words\n    return words.filter(word => !STOPWORDS.has(word));\n  }\n\n  /**\n   * Add terms from text to the index for a given document ID\n   * @param {string} docId - The document identifier\n   * @param {string} text - The text content to index\n   */\n  add(docId, text) {\n    if (!docId) {\n      throw new Error('Document ID is required');\n    }\n\n    const words = this._tokenize(text);\n    const termFrequency = new Map();\n\n    // Count term frequencies\n    words.forEach(word => {\n      const stem = stemmer(word);\n      termFrequency.set(stem, (termFrequency.get(stem) || 0) + 1);\n    });\n\n    // Add to index\n    termFrequency.forEach((frequency, stem) => {\n      if (!this.index.has(stem)) {\n        this.index.set(stem, new Map());\n      }\n      this.index.get(stem).set(docId, frequency);\n    });\n\n    // Track document terms and frequencies\n    this.documentTerms.set(docId, termFrequency);\n    this.documentLengths.set(docId, words.length);\n  }\n\n  /**\n   * Remove all indexed terms for a given document ID\n   * @param {string} docId - The document identifier to remove\n   * @returns {boolean} True if document was found and removed, false otherwise\n   */\n  remove(docId) {\n    if (!this.documentTerms.has(docId)) {\n      return false;\n    }\n\n    // Get all terms associated with this document\n    const terms = this.documentTerms.get(docId);\n\n    // Remove document ID from each term's posting list\n    terms.forEach((frequency, term) => {\n      if (this.index.has(term)) {\n        this.index.get(term).delete(docId);\n        // Clean up empty term entries\n        if (this.index.get(term).size === 0) {\n          this.index.delete(term);\n        }\n      }\n    });\n\n    // Remove document from tracking\n    this.documentTerms.delete(docId);\n    this.documentLengths.delete(docId);\n    return true;\n  }\n\n  /**\n   * Query the index for documents containing the given terms with relevance scoring\n   * @param {string} queryText - The search query text\n   * @param {Object} options - Query options\n   * @param {boolean} options.scored - If true, return scored results; if false, return just IDs (default: true)\n   * @param {boolean} options.requireAll - If true, require ALL terms; if false, rank by relevance (default: false)\n   * @returns {Array} Array of document IDs (if scored=false) or objects with {id, score} (if scored=true)\n   */\n  query(queryText, options = { scored: true, requireAll: false }) {\n    const words = this._tokenize(queryText);\n    if (words.length === 0) {\n      return [];\n    }\n\n    // Get stemmed versions of query terms\n    const stemmedTerms = words.map(word => stemmer(word));\n    const uniqueTerms = [...new Set(stemmedTerms)];\n\n    if (options.requireAll) {\n      // Strict AND logic - document must contain ALL terms\n      const docSets = uniqueTerms.map(term => {\n        const termDocs = this.index.get(term);\n        return termDocs ? new Set(termDocs.keys()) : new Set();\n      });\n\n      if (docSets.length === 0) {\n        return [];\n      }\n\n      // Compute intersection of all document sets\n      const intersection = new Set(docSets[0]);\n      for (let i = 1; i < docSets.length; i++) {\n        for (const docId of intersection) {\n          if (!docSets[i].has(docId)) {\n            intersection.delete(docId);\n          }\n        }\n      }\n\n      return Array.from(intersection);\n    }\n\n    // Relevance-based scoring (OR logic with ranking)\n    // Calculate IDF (Inverse Document Frequency) for each term\n    const totalDocs = this.documentLengths.size;\n    const idf = new Map();\n    \n    uniqueTerms.forEach(term => {\n      const docsWithTerm = this.index.get(term)?.size || 0;\n      if (docsWithTerm > 0) {\n        // IDF = log(totalDocs / docsWithTerm)\n        idf.set(term, Math.log(totalDocs / docsWithTerm));\n      }\n    });\n\n    // Collect all documents that contain at least one query term\n    const docScores = new Map();\n\n    uniqueTerms.forEach(term => {\n      const termDocs = this.index.get(term);\n      if (!termDocs) return;\n\n      termDocs.forEach((termFreq, docId) => {\n        if (!docScores.has(docId)) {\n          docScores.set(docId, 0);\n        }\n\n        // Calculate TF-IDF score\n        // TF = term frequency in document / total terms in document\n        const docLength = this.documentLengths.get(docId) || 1;\n        const tf = termFreq / docLength;\n        \n        // Add to document's total score\n        const termIdf = idf.get(term) || 0;\n        const tfIdf = tf * termIdf;\n        \n        docScores.set(docId, docScores.get(docId) + tfIdf);\n      });\n    });\n\n    // Bonus for documents containing multiple query terms\n    docScores.forEach((score, docId) => {\n      const docTerms = this.documentTerms.get(docId);\n      if (docTerms) {\n        const matchingTerms = uniqueTerms.filter(term => docTerms.has(term)).length;\n        // Boost score based on term coverage (what % of query terms are present)\n        const coverage = matchingTerms / uniqueTerms.length;\n        docScores.set(docId, score * (1 + coverage));\n      }\n    });\n\n    // Sort by score (highest first)\n    const results = Array.from(docScores.entries())\n      .map(([id, score]) => ({ id, score }))\n      .sort((a, b) => b.score - a.score);\n\n    // Return based on options\n    if (options.scored === false) {\n      return results.map(r => r.id);\n    }\n    \n    return results;\n  }\n\n  /**\n   * Get the number of unique terms in the index\n   * @returns {number} Number of unique terms\n   */\n  getTermCount() {\n    return this.index.size;\n  }\n\n  /**\n   * Get the number of documents in the index\n   * @returns {number} Number of indexed documents\n   */\n  getDocumentCount() {\n    return this.documentTerms.size;\n  }\n\n  /**\n   * Clear all data from the index\n   */\n  clear() {\n    this.index.clear();\n    this.documentTerms.clear();\n    this.documentLengths.clear();\n  }\n\n}\n","import { getProp, getFieldValues, isArray, arrayMatches, objectMatches, toArray, isIn, bboxToGeojson } from './utils.js';\nimport { TextIndex } from './TextIndex.js';\nimport { ObjectId } from './ObjectId.js';\n\n/**\n * Compare two values for equality, handling ObjectId instances\n */\nfunction valuesEqual(a, b) {\n\t// Handle ObjectId comparison\n\tif (a instanceof ObjectId || b instanceof ObjectId) {\n\t\tif (a instanceof ObjectId && b instanceof ObjectId) {\n\t\t\treturn a.equals(b);\n\t\t}\n\t\tif (a instanceof ObjectId && typeof b === 'string') {\n\t\t\treturn a.equals(b);\n\t\t}\n\t\tif (b instanceof ObjectId && typeof a === 'string') {\n\t\t\treturn b.equals(a);\n\t\t}\n\t\treturn false;\n\t}\n\t\n\t// Regular equality\n\treturn a == b;\n}\n\n/**\n * Compare two values with a comparison operator, handling ObjectId instances\n */\nfunction compareValues(a, b, operator) {\n\t// Convert ObjectIds to comparable values (use timestamp for ordering)\n\tlet aVal = a;\n\tlet bVal = b;\n\t\n\tif (a instanceof ObjectId) {\n\t\taVal = a.toString();\n\t}\n\tif (b instanceof ObjectId) {\n\t\tbVal = b.toString();\n\t}\n\t\n\tswitch(operator) {\n\t\tcase '>': return aVal > bVal;\n\t\tcase '>=': return aVal >= bVal;\n\t\tcase '<': return aVal < bVal;\n\t\tcase '<=': return aVal <= bVal;\n\t\tdefault: return false;\n\t}\n}\n\n/**\n * Check if a field value (possibly from array traversal) matches a condition\n * Handles both single values and arrays of values (from array traversal)\n */\nfunction fieldValueMatches(fieldValue, checkFn) {\n\tif (fieldValue == undefined) return false;\n\t\n\t// If fieldValue is an array (from array traversal), check if ANY element matches\n\tif (isArray(fieldValue)) {\n\t\tfor (var i = 0; i < fieldValue.length; i++) {\n\t\t\tif (checkFn(fieldValue[i])) return true;\n\t\t}\n\t\treturn false;\n\t}\n\t\n\t// Otherwise check the single value\n\treturn checkFn(fieldValue);\n}\n\n/**\n * Text search helper\n * Creates a temporary TextIndex to check if the text matches the query\n */\nexport function text(prop, query) {\n\tconst textIndex = new TextIndex();\n\ttextIndex.add('id', prop);\n\tconst results = textIndex.query(query, { scored: false });\n\treturn results.length === 1;\n}\n\n/**\n * Geo within helper - using bounding box logic instead of de9im\n * This is a simpler implementation that doesn't require de9im dependency\n */\nexport function geoWithin(prop, query) {\n\ttry {\n\t\t// bbox format: [[minLon, maxLat], [maxLon, minLat]]\n\t\tif (!Array.isArray(query) || query.length !== 2) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst minLon = query[0][0];\n\t\tconst maxLat = query[0][1];\n\t\tconst maxLon = query[1][0];\n\t\tconst minLat = query[1][1];\n\n\t\t// Check if geometry is within bounding box\n\t\treturn isGeometryWithinBBox(prop, minLon, maxLon, minLat, maxLat);\n\t} catch (e) {\n\t\treturn false;\n\t}\n}\n\n/**\n * Check if a GeoJSON geometry is within a bounding box\n * For Points: checks if the point is within the bbox\n * For Polygons: checks if ALL vertices are within the bbox\n */\nfunction isGeometryWithinBBox(geoJson, minLon, maxLon, minLat, maxLat) {\n\tif (!geoJson) return false;\n\n\t// Handle GeoJSON FeatureCollection\n\tif (geoJson.type === 'FeatureCollection' && geoJson.features && geoJson.features.length > 0) {\n\t\t// All features must be within the bbox\n\t\tfor (const feature of geoJson.features) {\n\t\t\tif (feature.geometry) {\n\t\t\t\tif (!isGeometryWithinBBox(feature.geometry, minLon, maxLon, minLat, maxLat)) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\n\t// Handle GeoJSON Feature\n\tif (geoJson.type === 'Feature' && geoJson.geometry) {\n\t\treturn isGeometryWithinBBox(geoJson.geometry, minLon, maxLon, minLat, maxLat);\n\t}\n\n\t// Handle GeoJSON Point\n\tif (geoJson.type === 'Point' && geoJson.coordinates) {\n\t\tconst [lng, lat] = geoJson.coordinates;\n\t\tif (typeof lng === 'number' && typeof lat === 'number') {\n\t\t\treturn lng >= minLon && lng <= maxLon && lat >= minLat && lat <= maxLat;\n\t\t}\n\t}\n\n\t// Handle GeoJSON Polygon - ALL vertices must be within the bbox\n\tif (geoJson.type === 'Polygon' && geoJson.coordinates && geoJson.coordinates.length > 0) {\n\t\tfor (const ring of geoJson.coordinates) {\n\t\t\tfor (const coord of ring) {\n\t\t\t\tconst lng = coord[0];\n\t\t\t\tconst lat = coord[1];\n\t\t\t\tif (lng < minLon || lng > maxLon || lat < minLat || lat > maxLat) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\n\treturn false;\n}\n\n/**\n * Extract coordinates from a GeoJSON object for indexing purposes\n * This uses centroid for polygons to get a single point to index\n * @param {Object} geoJson - The GeoJSON object\n * @returns {Object|null} Object with lat and lng, or null if invalid\n */\nfunction extractCoordinatesFromGeoJSON(geoJson) {\n\tif (!geoJson) return null;\n\n\t// Handle GeoJSON FeatureCollection\n\tif (geoJson.type === 'FeatureCollection' && geoJson.features && geoJson.features.length > 0) {\n\t\tconst feature = geoJson.features[0];\n\t\tif (feature.geometry) {\n\t\t\treturn extractCoordinatesFromGeoJSON(feature.geometry);\n\t\t}\n\t}\n\n\t// Handle GeoJSON Feature\n\tif (geoJson.type === 'Feature' && geoJson.geometry) {\n\t\treturn extractCoordinatesFromGeoJSON(geoJson.geometry);\n\t}\n\n\t// Handle GeoJSON Point\n\tif (geoJson.type === 'Point' && geoJson.coordinates) {\n\t\tconst [lng, lat] = geoJson.coordinates;\n\t\tif (typeof lng === 'number' && typeof lat === 'number') {\n\t\t\treturn { lat, lng };\n\t\t}\n\t}\n\n\t// Handle GeoJSON Polygon - use centroid of first coordinate ring\n\tif (geoJson.type === 'Polygon' && geoJson.coordinates && geoJson.coordinates.length > 0) {\n\t\tconst ring = geoJson.coordinates[0];\n\t\tif (ring.length > 0) {\n\t\t\tlet sumLat = 0, sumLng = 0;\n\t\t\tfor (const coord of ring) {\n\t\t\t\tsumLng += coord[0];\n\t\t\t\tsumLat += coord[1];\n\t\t\t}\n\t\t\treturn {\n\t\t\t\tlat: sumLat / ring.length,\n\t\t\t\tlng: sumLng / ring.length\n\t\t\t};\n\t\t}\n\t}\n\n\treturn null;\n}\n\n/**\n * $where operator implementation\n * SECURITY NOTE: This uses Function constructor which can execute arbitrary code.\n * This is acceptable for a local/in-memory database but should NOT be used\n * in environments where untrusted user input is processed.\n */\nexport function where(doc, value) {\n\tif (typeof value === 'function') {\n\t\ttry {\n\t\t\treturn value.call(doc);\n\t\t} catch (e) {\n\t\t\treturn false;\n\t\t}\n\t} else if (typeof value === 'string') {\n\t\t// Evaluate the string as a function\n\t\ttry {\n\t\t\tvar fn = new Function('return ' + value);\n\t\t\treturn fn.call(doc);\n\t\t} catch (e) {\n\t\t\treturn false;\n\t\t}\n\t}\n\treturn false;\n}\n\n/**\n * Top-level match function\n */\nexport function tlMatches(doc, query) {\n\tvar key = Object.keys(query)[0];\n\tvar value = query[key];\n\tif (key.charAt(0) == \"$\") {\n\t\tif (key == \"$and\") return and(doc, value);\n\t\telse if (key == \"$or\") return or(doc, value);\n\t\telse if (key == \"$not\") return not(doc, value);\n\t\telse if (key == \"$nor\") return nor(doc, value);\n\t\telse if (key == \"$where\") return where(doc, value);\n\t\telse throw { $err: \"Can't canonicalize query: BadValue unknown top level operator: \" + key, code: 17287 };\n\t} else {\n\t\treturn opMatches(doc, key, value);\n\t}\n}\n\n/**\n * Operator match function\n */\nexport function opMatches(doc, key, value) {\n\t// Get field value using array-aware traversal\n\tvar fieldValue = getFieldValues(doc, key);\n\t\n\tif (typeof (value) == \"string\") return fieldValueMatches(fieldValue, function(v) { return valuesEqual(v, value); });\n\telse if (typeof (value) == \"number\") return fieldValueMatches(fieldValue, function(v) { return valuesEqual(v, value); });\n\telse if (typeof (value) == \"boolean\") return fieldValueMatches(fieldValue, function(v) { return valuesEqual(v, value); });\n\telse if (value instanceof ObjectId) return fieldValueMatches(fieldValue, function(v) { return valuesEqual(v, value); });\n\telse if (typeof (value) == \"object\") {\n\t\tif (value instanceof RegExp) return fieldValue != undefined && fieldValueMatches(fieldValue, function(v) { return v && v.match(value); });\n\t\telse if (isArray(value)) return fieldValue != undefined && fieldValueMatches(fieldValue, function(v) { return v && arrayMatches(v, value); });\n\t\telse {\n\t\t\tvar keys = Object.keys(value);\n\t\t\tif (keys[0].charAt(0) == \"$\") {\n\t\t\t\tfor (var i = 0; i < keys.length; i++) {\n\t\t\t\t\tvar operator = Object.keys(value)[i];\n\t\t\t\t\tvar operand = value[operator];\n\t\t\t\t\tif (operator == \"$eq\") {\n\t\t\t\t\t\tif (!fieldValueMatches(fieldValue, function(v) { return valuesEqual(v, operand); })) return false;\n\t\t\t\t\t} else if (operator == \"$gt\") {\n\t\t\t\t\t\tif (!fieldValueMatches(fieldValue, function(v) { return compareValues(v, operand, '>'); })) return false;\n\t\t\t\t\t} else if (operator == \"$gte\") {\n\t\t\t\t\t\tif (!fieldValueMatches(fieldValue, function(v) { return compareValues(v, operand, '>='); })) return false;\n\t\t\t\t\t} else if (operator == \"$lt\") {\n\t\t\t\t\t\tif (!fieldValueMatches(fieldValue, function(v) { return compareValues(v, operand, '<'); })) return false;\n\t\t\t\t\t} else if (operator == \"$lte\") {\n\t\t\t\t\t\tif (!fieldValueMatches(fieldValue, function(v) { return compareValues(v, operand, '<='); })) return false;\n\t\t\t\t\t} else if (operator == \"$ne\") {\n\t\t\t\t\t\tif (!fieldValueMatches(fieldValue, function(v) { return !valuesEqual(v, operand); })) return false;\n\t\t\t\t\t} else if (operator == \"$in\") {\n\t\t\t\t\t\tif (!fieldValueMatches(fieldValue, function(v) { return isIn(v, operand); })) return false;\n\t\t\t\t\t} else if (operator == \"$nin\") {\n\t\t\t\t\t\tif (fieldValueMatches(fieldValue, function(v) { return isIn(v, operand); })) return false;\n\t\t\t\t\t} else if (operator == \"$exists\") {\n\t\t\t\t\t\t// For $exists, we need to use getProp which returns undefined if field doesn't exist\n\t\t\t\t\t\t// getFieldValues might return an array which would be truthy\n\t\t\t\t\t\tvar rawValue = getProp(doc, key);\n\t\t\t\t\t\tif (operand ? rawValue == undefined : rawValue != undefined) return false;\n\t\t\t\t\t} else if (operator == \"$type\") {\n\t\t\t\t\t\tif (!fieldValueMatches(fieldValue, function(v) { return typeof(v) == operand; })) return false;\n\t\t\t\t\t} else if (operator == \"$mod\") {\n\t\t\t\t\t\tif (operand.length != 2) throw { $err: \"Can't canonicalize query: BadValue malformed mod, not enough elements\", code: 17287 };\n\t\t\t\t\t\tif (!fieldValueMatches(fieldValue, function(v) { return v != undefined && (v % operand[0] == operand[1]); })) return false;\n\t\t\t\t\t} else if (operator == \"$regex\") {\n\t\t\t\t\t\tif (!fieldValueMatches(fieldValue, function(v) { return v != undefined && v.match(operand); })) return false;\n\t\t\t\t\t} else if (operator == \"$text\") {\n\t\t\t\t\t\tif (!fieldValueMatches(fieldValue, function(v) { return v != undefined && text(v, operand); })) return false;\n\t\t\t\t\t} else if (operator == \"$geoWithin\") {\n\t\t\t\t\t\tif (!fieldValueMatches(fieldValue, function(v) { return v != undefined && geoWithin(v, operand); })) return false;\n\t\t\t\t\t} else if (operator == \"$near\" || operator == \"$nearSphere\" || operator == \"$geoIntersects\") {\n\t\t\t\t\t\t// These operators MUST be handled by an index\n\t\t\t\t\t\t// They should never reach the matcher level\n\t\t\t\t\t\t// If they do, the query planner should have already filtered documents via the index\n\t\t\t\t\t\t// So we just skip validation here - the index already did the work\n\t\t\t\t\t\t// Don't return false, as that would exclude documents that the index already selected\n\t\t\t\t\t} else if (operator == \"$not\") {\n\t\t\t\t\t\tif (opMatches(doc, key, operand)) return false;\n\t\t\t\t\t} else if (operator == \"$all\") {\n\t\t\t\t\t\t// $all requires the field to be an array, use getProp not getFieldValues\n\t\t\t\t\t\tvar arrayFieldValue = getProp(doc, key);\n\t\t\t\t\t\tif (arrayFieldValue == undefined || !isArray(arrayFieldValue)) return false;\n\t\t\t\t\t\tfor (var j = 0; j < operand.length; j++) {\n\t\t\t\t\t\t\tif (!isIn(operand[j], arrayFieldValue)) return false;\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if (operator == \"$elemMatch\") {\n\t\t\t\t\t\t// $elemMatch requires the field to be an array, use getProp not getFieldValues\n\t\t\t\t\t\tvar arrayFieldValue = getProp(doc, key);\n\t\t\t\t\t\tif (arrayFieldValue == undefined || !isArray(arrayFieldValue)) return false;\n\t\t\t\t\t\tvar found = false;\n\t\t\t\t\t\tfor (var j = 0; j < arrayFieldValue.length; j++) {\n\t\t\t\t\t\t\tvar element = arrayFieldValue[j];\n\t\t\t\t\t\t\t// Check if element matches the query\n\t\t\t\t\t\t\tif (typeof element === 'object' && !isArray(element)) {\n\t\t\t\t\t\t\t\t// For objects, use matches\n\t\t\t\t\t\t\t\tif (matches(element, operand)) {\n\t\t\t\t\t\t\t\t\tfound = true;\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t// For primitive values, check operators directly\n\t\t\t\t\t\t\t\tvar matchesPrimitive = true;\n\t\t\t\t\t\t\t\tvar opKeys = Object.keys(operand);\n\t\t\t\t\t\t\t\tfor (var k = 0; k < opKeys.length; k++) {\n\t\t\t\t\t\t\t\t\tvar op = opKeys[k];\n\t\t\t\t\t\t\t\t\tvar opValue = operand[op];\n\t\t\t\t\t\t\t\t\tif (op == \"$gte\" && !(element >= opValue)) matchesPrimitive = false;\n\t\t\t\t\t\t\t\t\telse if (op == \"$gt\" && !(element > opValue)) matchesPrimitive = false;\n\t\t\t\t\t\t\t\t\telse if (op == \"$lte\" && !(element <= opValue)) matchesPrimitive = false;\n\t\t\t\t\t\t\t\t\telse if (op == \"$lt\" && !(element < opValue)) matchesPrimitive = false;\n\t\t\t\t\t\t\t\t\telse if (op == \"$eq\" && !(element == opValue)) matchesPrimitive = false;\n\t\t\t\t\t\t\t\t\telse if (op == \"$ne\" && !(element != opValue)) matchesPrimitive = false;\n\t\t\t\t\t\t\t\t\telse if (op == \"$in\" && !isIn(element, opValue)) matchesPrimitive = false;\n\t\t\t\t\t\t\t\t\telse if (op == \"$nin\" && isIn(element, opValue)) matchesPrimitive = false;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif (matchesPrimitive) {\n\t\t\t\t\t\t\t\t\tfound = true;\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!found) return false;\n\t\t\t\t\t} else if (operator == \"$size\") {\n\t\t\t\t\t\tvar sizeFieldValue = getProp(doc, key);\n\t\t\t\t\t\tif (sizeFieldValue == undefined || !isArray(sizeFieldValue)) return false;\n\t\t\t\t\t\tif (sizeFieldValue.length != operand) return false;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthrow { $err: \"Can't canonicalize query: BadValue unknown operator: \" + operator, code: 17287 };\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn true;\n\t\t\t} else {\n\t\t\t\treturn getProp(doc, key) && objectMatches(getProp(doc, key), value);\n\t\t\t}\n\t\t}\n\t}\n}\n\n/**\n * $not operator\n */\nexport function not(doc, value) {\n\treturn !tlMatches(doc, value);\n}\n\n/**\n * $and operator\n */\nexport function and(doc, els) {\n\tfor (var i = 0; i < els.length; i++) {\n\t\tif (!tlMatches(doc, els[i])) {\n\t\t\treturn false;\n\t\t}\n\t}\n\treturn true;\n}\n\n/**\n * $or operator\n */\nexport function or(doc, els) {\n\tfor (var i = 0; i < els.length; i++) {\n\t\tif (tlMatches(doc, els[i])) return true;\n\t}\n\treturn false;\n}\n\n/**\n * $nor operator\n */\nexport function nor(doc, els) {\n\tfor (var i = 0; i < els.length; i++) {\n\t\tif (tlMatches(doc, els[i])) return false;\n\t}\n\treturn true;\n}\n\n/**\n * Main matches function - query structure: (top level operators ( \"age\" : (operators) ))\n * top, top level query, implicit $and\n */\nexport function matches(doc, query) {\n\treturn and(doc, toArray(query));\n}\n","/**\n * Update operations module\n */\n\nimport { setProp, getProp } from './utils.js';\n\n/**\n * Apply update operators to a document\n */\nexport function applyUpdates(updates, doc, setOnInsert) {\n\tvar keys = Object.keys(updates);\n\tfor (var i = 0; i < keys.length; i++) {\n\t\tvar key = keys[i];\n\t\tvar value = updates[key];\n\t\tif (key == \"$inc\") {\n\t\t\tvar fields = Object.keys(value);\n\t\t\tfor (var j = 0; j < fields.length; j++) {\n\t\t\t\tvar field = fields[j];\n\t\t\t\tvar amount = value[field];\n\t\t\t\tvar currentValue = getProp(doc, field);\n\t\t\t\tif (currentValue == undefined) currentValue = 0;\n\t\t\t\tsetProp(doc, field, currentValue + amount);\n\t\t\t}\n\t\t} else if (key == \"$mul\") {\n\t\t\tvar fields = Object.keys(value);\n\t\t\tfor (var j = 0; j < fields.length; j++) {\n\t\t\t\tvar field = fields[j];\n\t\t\t\tvar amount = value[field];\n\t\t\t\tdoc[field] = doc[field] * amount;\n\t\t\t}\n\t\t} else if (key == \"$rename\") {\n\t\t\tvar fields = Object.keys(value);\n\t\t\tfor (var j = 0; j < fields.length; j++) {\n\t\t\t\tvar field = fields[j];\n\t\t\t\tvar newName = value[field];\n\t\t\t\tdoc[newName] = doc[field];\n\t\t\t\tdelete doc[field];\n\t\t\t}\n\t\t} else if (key == \"$setOnInsert\" && setOnInsert) {\n\t\t\tvar fields = Object.keys(value);\n\t\t\tfor (var j = 0; j < fields.length; j++) {\n\t\t\t\tdoc[fields[j]] = value[fields[j]];\n\t\t\t}\n\t\t} else if (key == \"$set\") {\n\t\t\tvar fields = Object.keys(value);\n\t\t\tfor (var j = 0; j < fields.length; j++) {\n\t\t\t\tvar field = fields[j];\n\t\t\t\tsetProp(doc, field, value[field]);\n\t\t\t}\n\t\t} else if (key == \"$unset\") {\n\t\t\tvar fields = Object.keys(value);\n\t\t\tfor (var j = 0; j < fields.length; j++) {\n\t\t\t\tdelete doc[fields[j]];\n\t\t\t}\n\t\t} else if (key == \"$min\") {\n\t\t\tvar fields = Object.keys(value);\n\t\t\tfor (var j = 0; j < fields.length; j++) {\n\t\t\t\tvar field = fields[j];\n\t\t\t\tvar amount = value[field];\n\t\t\t\tdoc[field] = Math.min(doc[field], amount);\n\t\t\t}\n\t\t} else if (key == \"$max\") {\n\t\t\tvar fields = Object.keys(value);\n\t\t\tfor (var j = 0; j < fields.length; j++) {\n\t\t\t\tvar field = fields[j];\n\t\t\t\tvar amount = value[field];\n\t\t\t\tdoc[field] = Math.max(doc[field], amount);\n\t\t\t}\n\t\t} else if (key == \"$currentDate\") {  // TODO not the same as mongo\n\t\t\tvar fields = Object.keys(value);\n\t\t\tfor (var j = 0; j < fields.length; j++) {\n\t\t\t\tdoc[fields[j]] = new Date();\n\t\t\t}\n\t\t} else if (key == \"$addToSet\") {\n\t\t\tvar fields = Object.keys(value);\n\t\t\tfor (var j = 0; j < fields.length; j++) {\n\t\t\t\tvar field = fields[j];\n\t\t\t\tvar value = value[field];\n\t\t\t\tdoc[field].push(value);\n\t\t\t}\n\t\t} else if (key == \"$pop\") {\n\t\t\tvar fields = Object.keys(value);\n\t\t\tfor (var j = 0; j < fields.length; j++) {\n\t\t\t\tvar field = fields[j];\n\t\t\t\tvar value = value[field];\n\t\t\t\tif (value == 1) {\n\t\t\t\t\tdoc[field].pop();\n\t\t\t\t} else if (value == -1) {\n\t\t\t\t\tdoc[field].shift();\n\t\t\t\t}\n\t\t\t}\n\t\t} else if (key == \"$pullAll\") {\n\t\t\tvar fields = Object.keys(value);\n\t\t\tfor (var j = 0; j < fields.length; j++) {\n\t\t\t\tvar src = doc[fields[j]];\n\t\t\t\tvar toRemove = value[fields[j]];\n\t\t\t\tvar notRemoved = [];\n\t\t\t\tfor (var k = 0; k < src.length; k++) {\n\t\t\t\t\tvar removed = false;\n\t\t\t\t\tfor (var l = 0; l < toRemove.length; l++) {\n\t\t\t\t\t\tif (src[k] == toRemove[l]) {\n\t\t\t\t\t\t\tremoved = true;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!removed) notRemoved.push(src[k]);\n\t\t\t\t}\n\t\t\t\tdoc[fields[j]] = notRemoved;\n\t\t\t}\n\t\t} else if (key == \"$pushAll\") {\n\t\t\tvar fields = Object.keys(value);\n\t\t\tfor (var j = 0; j < fields.length; j++) {\n\t\t\t\tvar field = fields[j];\n\t\t\t\tvar values = value[field];\n\t\t\t\tfor (var k = 0; k < values.length; k++) {\n\t\t\t\t\tdoc[field].push(values[k]);\n\t\t\t\t}\n\t\t\t}\n\t\t} else if (key == \"$push\") {\n\t\t\tvar fields = Object.keys(value);\n\t\t\tfor (var j = 0; j < fields.length; j++) {\n\t\t\t\tvar field = fields[j];\n\t\t\t\tdoc[field].push(value[field]);\n\t\t\t}\n\t\t} else if (key == \"$bit\") {\n\t\t\tvar field = Object.keys(value)[0];\n\t\t\tvar operation = value[field];\n\t\t\tvar operator = Object.keys(operation)[0];\n\t\t\tvar operand = operation[operator];\n\t\t\tif (operator == \"and\") {\n\t\t\t\tdoc[field] = doc[field] & operand;\n\t\t\t} else if (operator == \"or\") {\n\t\t\t\tdoc[field] = doc[field] | operand;\n\t\t\t} else if (operator == \"xor\") {\n\t\t\t\tdoc[field] = doc[field] ^ operand;\n\t\t\t} else {\n\t\t\t\tthrow \"unknown $bit operator: \" + operator;\n\t\t\t}\n\t\t} else {\n\t\t\tthrow \"unknown update operator: \" + key;\n\t\t}\n\t}\n}\n\n/**\n * Create a new document from query and update operators for upsert\n */\nexport function createDocFromUpdate(query, updates, idGenerator) {\n\tvar newDoc = { _id: idGenerator() };\n\tvar onlyFields = true;\n\tvar updateKeys = Object.keys(updates);\n\tfor (var i = 0; i < updateKeys.length; i++) {\n\t\tif (updateKeys[i].charAt(0) == \"$\") {\n\t\t\tonlyFields = false;\n\t\t\tbreak;\n\t\t}\n\t}\n\tif (onlyFields) {\n\t\tfor (var i = 0; i < updateKeys.length; i++) {\n\t\t\tnewDoc[updateKeys[i]] = updates[updateKeys[i]];\n\t\t}\n\t} else {\n\t\tvar queryKeys = Object.keys(query);\n\t\tfor (var i = 0; i < queryKeys.length; i++) {\n\t\t\tnewDoc[queryKeys[i]] = query[queryKeys[i]];\n\t\t}\n\t\tapplyUpdates(updates, newDoc, true);\n\t}\n\treturn newDoc;\n}\n","/**\n * Base class for collection indexes\n * Provides a common interface for different types of indexes (e.g., regular, text, geo)\n */\nexport class Index {\n\tconstructor(name, keys, storage, options = {}) {\n\t\tthis.name = name;\n\t\tthis.keys = keys;\n\t\tthis.storage = storage;\n\t\tthis.options = options;\n\t}\n\n\t/**\n\t * Add a document to the index\n\t * @param {Object} doc - The document to index\n\t */\n\tadd(doc) {\n\t\tthrow new Error('add() must be implemented by subclass');\n\t}\n\n\t/**\n\t * Remove a document from the index\n\t * @param {Object} doc - The document to remove\n\t */\n\tremove(doc) {\n\t\tthrow new Error('remove() must be implemented by subclass');\n\t}\n\n\t/**\n\t * Update a document in the index (remove old, add new)\n\t * @param {Object} oldDoc - The old document\n\t * @param {Object} newDoc - The new document\n\t */\n\tupdate(oldDoc, newDoc) {\n\t\tthis.remove(oldDoc);\n\t\tthis.add(newDoc);\n\t}\n\n\t/**\n\t * Query the index\n\t * @param {*} query - The query to execute\n\t * @returns {Array} Array of document IDs or null if index cannot satisfy query\n\t */\n\tquery(query) {\n\t\tthrow new Error('query() must be implemented by subclass');\n\t}\n\n\t/**\n\t * Clear all data from the index\n\t */\n\tclear() {\n\t\tthrow new Error('clear() must be implemented by subclass');\n\t}\n\n\t/**\n\t * Get index specification (for getIndexes())\n\t */\n\tgetSpec() {\n\t\treturn {\n\t\t\tname: this.name,\n\t\t\tkey: this.keys\n\t\t};\n\t}\n\n\t/**\n\t * Serialize index state for storage\n\t * @returns {Object} Serializable index state\n\t */\n\tserialize() {\n\t\tthrow new Error('serialize() must be implemented by subclass');\n\t}\n\n\t/**\n\t * Restore index state from serialized data\n\t * @param {Object} data - Serialized index state\n\t */\n\tdeserialize(data) {\n\t\tthrow new Error('deserialize() must be implemented by subclass');\n\t}\n}\n","/**\n * BPlusTree - A B+ tree implementation for indexing\n * \n * A B+ tree is a self-balancing tree data structure that maintains sorted data\n * and allows searches, sequential access, insertions, and deletions in logarithmic time.\n * All values are stored in leaf nodes, and internal nodes only store keys for navigation.\n * \n * @class BPlusTree\n */\n\nimport { IndexStore } from \"./IndexStore.js\";\n\nfunction isNumericString(str) {\n  if (typeof str !== 'string' || str.trim() === '') {\n    return false; // Not a string or empty string\n  }\n  return Number.isFinite(+str);\n}\n\n/**\n * Node class representing a node in the B+ tree\n * @private\n */\nclass BPlusTreeNode {\n  /**\n   * Creates a new B+ tree node\n   * @param {boolean} isLeaf - Whether this node is a leaf node\n   */\n  constructor(isLeaf, indexStore, nodeCache) {\n    if (!(indexStore instanceof IndexStore)) {\n      throw new Error('IndexStore is required to create BPlusTreeNode');\n    }\n\n    if (typeof isLeaf === 'object') {\n      // Load existing node from indexStore\n      this._data = isLeaf;\n      this.id = this._data.id;\n      this.keys = this._data.keys;\n      this.values = this._data.values;\n      this.children = [];\n      for (const childId of this._data.children) {\n        if (nodeCache.has(childId)) {\n          this.children.push(nodeCache.get(childId));\n          continue;\n        }\n        const childData = indexStore.getDataMap('nodes').get(childId);\n        if (!childData) {\n          throw new Error(`BPlusTreeNode: Child node with id ${childId} not found in IndexStore`);\n        }\n        const childNode = new BPlusTreeNode(childData, indexStore, nodeCache);\n        this.children.push(childNode);\n        nodeCache.set(childId, childNode);\n      }\n      this.isLeaf = this._data.isLeaf;\n      if (this._data.next) {\n        if (nodeCache.has(this._data.next)) {\n          this.next = nodeCache.get(this._data.next);\n        } else {\n          const nextData = indexStore.getDataMap('nodes').get(this._data.next);\n          if (!nextData) {\n            throw new Error(`BPlusTreeNode: Next leaf node with id ${this._data.next} not found in IndexStore`);\n          }\n          this.next = new BPlusTreeNode(nextData, indexStore, nodeCache);\n          nodeCache.set(this.next.id, this.next);\n        }\n      } else {\n        this.next = null;\n      }\n    } else {\n      this._data = {\n        id: indexStore.getMeta('nextId'),\n        keys: [],      // Array of keys\n        values: [],    // Array of values (only used in leaf nodes)\n        children: [],  // Array of child nodes (only used in internal nodes)\n        isLeaf: isLeaf,\n        next : null,    // Pointer to next leaf node (only used in leaf nodes)\n      };\n      indexStore.setMeta('nextId', this._data.id + 1);\n      indexStore.getDataMap('nodes').set(this._data.id, this._data);\n      this.id = this._data.id;\n      this.keys = this._data.keys;\n      this.values = this._data.values;\n      this.children = [];\n      this.isLeaf = this._data.isLeaf;\n      this.next = null;\n    }\n    const self = this;\n\n    return new Proxy(this, {\n      get(target, prop) {\n        if (prop === 'children') {\n          return new Proxy(target.children, {\n            get(target, property, receiver) {\n              if (!isNumericString(property)) {\n                if (property === 'length') {\n                  return Reflect.get(target, property, receiver);\n                } else if (property === 'splice') {\n                  return function(...args) {\n                    if (args.length == 3) {\n                      if (args[2] instanceof BPlusTreeNode) {\n                        self._data.children.splice(args[0], args[1], args[2].id);\n                        indexStore.getDataMap('nodes').set(self._data.id, self._data);\n                      } else {\n                        throw new Error('BPlusTreeNode: children array can only store BPlusTreeNode instances',args[2]);\n                      }\n                    }\n                    return Reflect.apply(target[property], target, args);\n                  };\n                } else if (property === 'push') {\n                  return function(...args) {\n                    if (args.length !== 1) {\n                      throw new Error('BPlusTreeNode: children.push only supports single argument');\n                    }\n                    if (args[0] instanceof BPlusTreeNode) {\n                      self._data.children.push(args[0].id);\n                      indexStore.getDataMap('nodes').set(self._data.id, self._data);\n                      return self.children.push(args[0]);\n                    } else {\n                      throw new Error('BPlusTreeNode: children array can only store BPlusTreeNode instances',args[2]);\n                    }\n                  };\n                }\n              }\n              // Custom logic for getting properties\n              return Reflect.get(target, property, receiver); // Forward the operation to the original array\n            },\n            set(target, property, value, receiver) {\n              if (isNumericString(property) && value instanceof BPlusTreeNode) {\n                Reflect.set(self._data.children, property, value.id, receiver);\n              } else {\n                Reflect.set(self._data.children, property, value, receiver);\n              }\n              indexStore.getDataMap('nodes').set(self._data.id, self._data);\n              return Reflect.set(target, property, value, receiver); // Forward the operation to the original array\n            }\n          });\n        }\n        return Reflect.get(target, prop);\n      },\n      set(target, prop, value) {\n          if (prop === 'next') {\n            if (value instanceof BPlusTreeNode) {\n              target.next = value;\n              target._data.next = value.id;\n              indexStore.getDataMap('nodes').set(target._data.id, target._data);\n            } else if (value === null) {\n              target.next = null;\n              target._data.next = null;\n              indexStore.getDataMap('nodes').set(target._data.id, target._data);\n            } else {\n              throw new Error('BPlusTreeNode: next pointer must be a BPlusTreeNode or null');\n            }\n          } else if (prop === 'isLeaf') {\n            target.isLeaf = value;\n            target._data.isLeaf = value;\n            indexStore.getDataMap('nodes').set(target._data.id, target._data);\n          } else if (prop === 'children') {\n            target.children = value;\n            target._data.children = value.map(child => child.id);\n            indexStore.getDataMap('nodes').set(target._data.id, target._data);\n          } else {\n            target[prop] = value;\n            target._data[prop] = value;\n            indexStore.getDataMap('nodes').set(target._data.id, target._data);\n          }\n        return true;\n      }\n    });\n  }\n}\n\n/**\n * B+ Tree implementation\n */\nexport class BPlusTree {\n  /**\n   * Creates a new B+ tree\n    * @param {number} order - The maximum number of children per node (default: 3)\n    */\n  constructor(order = 3, indexStore = new IndexStore()) {\n    if (order < 3) {\n      throw new Error('B+ tree order must be at least 3');\n    }\n    this.order = order;\n    this.minKeys = Math.ceil(order / 2) - 1;\n    this.indexStore = indexStore;\n  \n    if (indexStore.hasMeta('order')) {\n      if (indexStore.getMeta('order') !== this.order) {\n        throw new Error(`B+ tree order does not match stored index metadata ${indexStore.getMeta('order')} != ${this.order}`);\n      }\n      if (indexStore.getMeta('minKeys') != this.minKeys) {\n        throw new Error(`B+ tree minKeys does not match stored index metadata ${indexStore.getMeta('minKeys')} != ${this.minKeys}`);\n      }\n\n      this._buildTreeFromStorage();\n\n    } else {\n      this.indexStore.setMeta('order', this.order);\n      this.indexStore.setMeta('minKeys', this.minKeys);\n      this.indexStore.setMeta('nextId', 1);\n      this.root = new BPlusTreeNode(true, this.indexStore);\n      this.indexStore.setMeta('rootId', this.root.id);\n    }\n  }\n\n  /**\n   * Builds the B+ tree from existing data in the IndexStore\n   * @private\n   */\n  _buildTreeFromStorage() {\n    const nodeCache = new Map();\n    const rootData = this.indexStore.getDataMap('nodes').get(this.indexStore.getMeta('rootId'));\n    if (!rootData) {\n      throw new Error('BPlusTree: Root node not found in IndexStore');\n    }\n    this.root = new BPlusTreeNode(rootData,this.indexStore, nodeCache);\n  }\n\n    /**\n     * Searches for a value by key in the B+ tree\n     * @param {*} key - The key to search for\n     * @returns {Array} Array of values associated with the key, or undefined if not found\n     */\n    search(key) {\n        return this._searchNode(this.root, key);\n    }\n\n    /**\n     * Internal method to search for a key in a node\n     * @private\n     * @param {BPlusTreeNode} node - The node to search in\n     * @param {*} key - The key to search for\n     * @returns {Array} Array of values if found, undefined otherwise\n     */\n    _searchNode(node, key) {\n        if (node.isLeaf) {\n            // In a leaf node, collect all values for the key\n            const values = [];\n            for (let i = 0; i < node.keys.length; i++) {\n                if (key === node.keys[i]) {\n                    // Values are stored as arrays, concatenate them\n                    values.push(...node.values[i]);\n                }\n            }\n            return values;//values.length > 0 ? values : undefined;\n        } else {\n            // In an internal node, find the appropriate child\n            // Keys in internal nodes are separators - go right if key >= separator\n            let i = 0;\n            while (i < node.keys.length && key >= node.keys[i]) {\n                i++;\n            }\n            return this._searchNode(node.children[i], key);\n        }\n    }\n\n    /**\n     * Inserts a key-value pair into the B+ tree.\n     * If the key already exists, its value will be updated.\n     * @param {*} key - The key to insert\n     * @param {*} value - The value to associate with the key\n     */\n    add(key, value) {\n        const root = this.root;\n\n        // If root is full, split it\n        if (root.keys.length === this.indexStore.getMeta('order') - 1) {\n            const newRoot = new BPlusTreeNode(false, this.indexStore);\n            newRoot.children.push(this.root);\n            this._splitChild(newRoot, 0);\n            this.root = newRoot;\n            this.indexStore.setMeta('rootId', this.root.id);\n        }\n\n        this._insertNonFull(this.root, key, value);\n    }\n\n    /**\n     * Inserts a key-value pair into a node that is not full\n     * @private\n     * @param {BPlusTreeNode} node - The node to insert into\n     * @param {*} key - The key to insert\n     * @param {*} value - The value to insert\n     */\n    _insertNonFull(node, key, value) {\n        let i = node.keys.length - 1;\n\n        if (node.isLeaf) {\n            // Check if key already exists and append value\n            for (let j = 0; j < node.keys.length; j++) {\n                if (node.keys[j] === key) {\n                    // Key exists, append value to array\n                    node.values[j].push(value);\n                    return;\n                }\n            }\n\n            // Insert into leaf node in sorted order\n            node.keys.push(null);\n            node.values.push(null);\n\n            while (i >= 0 && key < node.keys[i]) {\n                node.keys[i + 1] = node.keys[i];\n                node.values[i + 1] = node.values[i];\n                i--;\n            }\n\n            node.keys[i + 1] = key;\n            node.values[i + 1] = [value]; // Store as array\n\n        } else {\n            // Find the child to insert into\n            // In internal nodes, go right if key >= separator\n            i = 0;\n            while (i < node.keys.length && key >= node.keys[i]) {\n                i++;\n            }\n\n            // If child is full, split it\n            if (node.children[i].keys.length === this.indexStore.getMeta('order') - 1) {\n                this._splitChild(node, i);\n                // After split, re-check which child to insert into\n                if (key >= node.keys[i]) {\n                    i++;\n                }\n            }\n\n            this._insertNonFull(node.children[i], key, value);\n        }\n    }\n\n    /**\n     * Splits a full child node\n     * @private\n     * @param {BPlusTreeNode} parent - The parent node\n     * @param {number} index - The index of the child to split\n     */\n    _splitChild(parent, index) {\n        const fullChild = parent.children[index];\n        const newChild = new BPlusTreeNode(fullChild.isLeaf, this.indexStore);\n        const midIndex = Math.floor((this.indexStore.getMeta('order') - 1) / 2);\n\n        if (fullChild.isLeaf) {\n            // For leaf nodes, copy the upper half to new node\n            newChild.keys = fullChild.keys.splice(midIndex);\n            newChild.values = fullChild.values.splice(midIndex);\n\n            // Link leaf nodes\n            newChild.next = fullChild.next;\n            fullChild.next = newChild;\n\n            // Promote a copy of the first key of newChild to parent\n            parent.keys.splice(index, 0, newChild.keys[0]);\n        } else {\n            // For internal nodes, split children\n            newChild.keys = fullChild.keys.splice(midIndex + 1);\n            const promotedKey = fullChild.keys.pop();\n            newChild.children = fullChild.children.splice(midIndex + 1);\n\n            // Promote the middle key to parent\n            parent.keys.splice(index, 0, promotedKey);\n        }\n\n        parent.children.splice(index + 1, 0, newChild);\n    }\n\n    /**\n     * Deletes a specific value from a key in the B+ tree\n     * @param {*} key - The key to delete from\n     * @param {*} value - The specific value to remove\n     * @returns {boolean} True if the value was found and deleted, false otherwise\n     */\n    deleteValue(key, value) {\n        const deleted = this._deleteValue(this.root, key, value);\n\n        // If root is now empty after deletion, make its only child the new root\n        if (this.root.keys.length === 0) {\n            if (!this.root.isLeaf && this.root.children.length > 0) {\n                this.root = this.root.children[0];\n                this.indexStore.setMeta('rootId', this.root.id);\n            }\n        }\n\n        return deleted;\n    }\n\n    /**\n     * Deletes all values for a key from the B+ tree\n     * @param {*} key - The key to delete\n     * @returns {boolean} True if the key was found and deleted, false otherwise\n     */\n    delete(key) {\n        const deleted = this._delete(this.root, key);\n\n        // If root is now empty after deletion, make its only child the new root\n        if (this.root.keys.length === 0) {\n            if (!this.root.isLeaf && this.root.children.length > 0) {\n                this.root = this.root.children[0];\n                this.indexStore.setMeta('rootId', this.root.id);\n            }\n        }\n\n        return deleted;\n    }\n\n    /**\n     * Internal method to delete a specific value from a key\n     * @private\n     * @param {BPlusTreeNode} node - The node to delete from\n     * @param {*} key - The key to delete from\n     * @param {*} value - The value to delete\n     * @returns {boolean} True if deleted, false otherwise\n     */\n    _deleteValue(node, key, value) {\n        if (node.isLeaf) {\n            // Found the key in a leaf node\n            for (let i = 0; i < node.keys.length; i++) {\n                if (key === node.keys[i]) {\n                    const values = node.values[i];\n                    const valueIndex = values.indexOf(value);\n                    if (valueIndex === -1) {\n                        return false; // Value not found\n                    }\n                    \n                    // Remove the specific value\n                    values.splice(valueIndex, 1);\n                    \n                    // If no values left, remove the key entirely\n                    if (values.length === 0) {\n                        node.keys.splice(i, 1);\n                        node.values.splice(i, 1);\n                    }\n                    return true;\n                }\n            }\n            return false;\n        } else {\n            // Find the appropriate child to delete from\n            let i = 0;\n            while (i < node.keys.length && key >= node.keys[i]) {\n                i++;\n            }\n\n            // Recursively delete from the appropriate child\n            const deleted = this._deleteValue(node.children[i], key, value);\n\n            if (deleted) {\n                // After deletion, check if child needs rebalancing\n                this._rebalanceAfterDelete(node, i);\n            }\n\n            return deleted;\n        }\n    }\n\n    /**\n     * Internal method to delete a key from a node\n     * @private\n     * @param {BPlusTreeNode} node - The node to delete from\n     * @param {*} key - The key to delete\n     * @returns {boolean} True if deleted, false otherwise\n     */\n    _delete(node, key) {\n        if (node.isLeaf) {\n            // Found the key in a leaf node\n            for (let i = 0; i < node.keys.length; i++) {\n                if (key === node.keys[i]) {\n                    node.keys.splice(i, 1);\n                    node.values.splice(i, 1);\n                    return true;\n                }\n            }\n            return false;\n        } else {\n            // Find the appropriate child to delete from\n            let i = 0;\n            while (i < node.keys.length && key >= node.keys[i]) {\n                i++;\n            }\n\n            // Recursively delete from the appropriate child\n            const deleted = this._delete(node.children[i], key);\n\n            if (deleted) {\n                // After deletion, check if child needs rebalancing\n                this._rebalanceAfterDelete(node, i);\n            }\n\n            return deleted;\n        }\n    }\n\n    /**\n     * Rebalances the tree after a deletion\n     * @private\n     * @param {BPlusTreeNode} parent - The parent node\n     * @param {number} index - The index of the child that was modified\n     */\n    _rebalanceAfterDelete(parent, index) {\n        const child = parent.children[index];\n\n        // If child has enough keys, no rebalancing needed\n        if (child.keys.length >= this.indexStore.getMeta('minKeys')) {\n            return;\n        }\n\n        // Try to borrow from left sibling\n        if (index > 0) {\n            const leftSibling = parent.children[index - 1];\n            if (leftSibling.keys.length > this.indexStore.getMeta('minKeys')) {\n                this._borrowFromLeft(parent, index);\n                return;\n            }\n        }\n\n        // Try to borrow from right sibling\n        if (index < parent.children.length - 1) {\n            const rightSibling = parent.children[index + 1];\n            if (rightSibling.keys.length > this.indexStore.getMeta('minKeys')) {\n                this._borrowFromRight(parent, index);\n                return;\n            }\n        }\n\n        // Merge with a sibling\n        if (index > 0) {\n            this._merge(parent, index - 1);\n        } else {\n            this._merge(parent, index);\n        }\n    }\n\n    /**\n     * Borrows a key from the left sibling\n     * @private\n     * @param {BPlusTreeNode} parent - The parent node\n     * @param {number} index - The index of the child\n     */\n    _borrowFromLeft(parent, index) {\n        const child = parent.children[index];\n        const leftSibling = parent.children[index - 1];\n\n        if (child.isLeaf) {\n            // Move the last key-value from left sibling to child\n            child.keys.unshift(leftSibling.keys.pop());\n            child.values.unshift(leftSibling.values.pop());\n\n            // Update parent key\n            parent.keys[index - 1] = child.keys[0];\n        } else {\n            // Move parent key down and left sibling's last key up\n            child.keys.unshift(parent.keys[index - 1]);\n            parent.keys[index - 1] = leftSibling.keys.pop();\n            child.children.unshift(leftSibling.children.pop());\n        }\n    }\n\n    /**\n     * Borrows a key from the right sibling\n     * @private\n     * @param {BPlusTreeNode} parent - The parent node\n     * @param {number} index - The index of the child\n     */\n    _borrowFromRight(parent, index) {\n        const child = parent.children[index];\n        const rightSibling = parent.children[index + 1];\n\n        if (child.isLeaf) {\n            // Move the first key-value from right sibling to child\n            child.keys.push(rightSibling.keys.shift());\n            child.values.push(rightSibling.values.shift());\n\n            // Update parent key\n            parent.keys[index] = rightSibling.keys[0];\n        } else {\n            // Move parent key down and right sibling's first key up\n            child.keys.push(parent.keys[index]);\n            parent.keys[index] = rightSibling.keys.shift();\n            child.children.push(rightSibling.children.shift());\n        }\n    }\n\n    /**\n     * Merges a child with its right sibling\n     * @private\n     * @param {BPlusTreeNode} parent - The parent node\n     * @param {number} index - The index of the left child to merge\n     */\n    _merge(parent, index) {\n        const leftChild = parent.children[index];\n        const rightChild = parent.children[index + 1];\n\n        if (leftChild.isLeaf) {\n            // Merge leaf nodes\n            leftChild.keys = leftChild.keys.concat(rightChild.keys);\n            leftChild.values = leftChild.values.concat(rightChild.values);\n            leftChild.next = rightChild.next;\n\n            // Remove the parent key\n            parent.keys.splice(index, 1);\n        } else {\n            // Merge internal nodes\n            leftChild.keys.push(parent.keys[index]);\n            leftChild.keys = leftChild.keys.concat(rightChild.keys);\n            leftChild.children = leftChild.children.concat(rightChild.children);\n\n            // Remove the parent key\n            parent.keys.splice(index, 1);\n        }\n\n        // Remove the right child\n        parent.children.splice(index + 1, 1);\n    }\n\n    /**\n     * Returns all key-value pairs in sorted order\n     * @returns {Array} Array of {key, value} objects\n     */\n    toArray() {\n        const result = [];\n        let current = this._getFirstLeaf(this.root);\n\n        while (current) {\n            for (let i = 0; i < current.keys.length; i++) {\n                // Each key can have multiple values\n                const values = current.values[i];\n                for (let j = 0; j < values.length; j++) {\n                    result.push({\n                        key: current.keys[i],\n                        value: values[j]\n                    });\n                }\n            }\n            current = current.next;\n        }\n\n        return result;\n    }\n\n    /**\n     * Gets the first (leftmost) leaf node\n     * @private\n     * @param {BPlusTreeNode} node - The node to start from\n     * @returns {BPlusTreeNode} The leftmost leaf node\n     */\n    _getFirstLeaf(node) {\n        if (node.isLeaf) {\n            return node;\n        }\n        return this._getFirstLeaf(node.children[0]);\n    }\n\n    /**\n     * Returns the number of key-value pairs in the tree\n     * @returns {number} The size of the tree\n     */\n    size() {\n        let count = 0;\n        let current = this._getFirstLeaf(this.root);\n\n        while (current) {\n            // Count all values (each key can have multiple values)\n            for (let i = 0; i < current.values.length; i++) {\n                count += current.values[i].length;\n            }\n            current = current.next;\n        }\n\n        return count;\n    }\n\n    /**\n     * Checks if the tree is empty\n     * @returns {boolean} True if the tree is empty\n     */\n    isEmpty() {\n        return this.root.keys.length === 0;\n    }\n\n    /**\n     * Clears all entries from the tree\n     */\n    clear() {\n      this.indexStore.getDataMap('nodes').clear();\n      this.root = new BPlusTreeNode(true, this.indexStore);\n      this.indexStore.setMeta('rootId', this.root.id);\n    }\n\n    /**\n     * Performs a range search for all keys between min and max (inclusive)\n     * @param {*} minKey - The minimum key (inclusive)\n     * @param {*} maxKey - The maximum key (inclusive)\n     * @returns {Array} Array of {key, value} objects in range\n     */\n    rangeSearch(minKey, maxKey) {\n        const result = [];\n        let current = this._getFirstLeaf(this.root);\n\n        // Skip to the first node that might contain minKey\n        while (current && current.keys[current.keys.length - 1] < minKey) {\n            current = current.next;\n        }\n\n        // Collect all keys in range\n        while (current) {\n            for (let i = 0; i < current.keys.length; i++) {\n                if (current.keys[i] >= minKey && current.keys[i] <= maxKey) {\n                    // Each key can have multiple values\n                    const values = current.values[i];\n                    for (let j = 0; j < values.length; j++) {\n                        result.push({\n                            key: current.keys[i],\n                            value: values[j]\n                        });\n                    }\n                } else if (current.keys[i] > maxKey) {\n                    return result;\n                }\n            }\n            current = current.next;\n        }\n\n        return result;\n    }\n\n    /**\n     * Gets the height of the tree\n     * @returns {number} The height of the tree\n     */\n    getHeight() {\n        let height = 0;\n        let current = this.root;\n\n        while (!current.isLeaf) {\n            height++;\n            current = current.children[0];\n        }\n\n        return height;\n    }\n}\n","import { Index } from './Index.js';\nimport { getProp } from './utils.js';\nimport { BPlusTree } from './BPlusTree.js';\n\n/**\n * Uses B+ tree for efficient storage and range queries\n */\nexport class RegularCollectionIndex extends Index {\n\tconstructor(name, keys, storage, options = {}) {\n\t\tsuper(name, keys, storage, options);\n\t\t// B+ tree mapping index key to array of document _ids\n\t\t// Order 50 provides good balance between node size and tree height\n\t\tthis.data = new BPlusTree(50,storage);\n\t}\n\n\t/**\n\t * Extract index key value from a document\n\t */\n\textractIndexKey(doc) {\n\t\tconst keyFields = Object.keys(this.keys);\n\t\tif (keyFields.length === 0) return null;\n\n\t\t// For simple single-field index\n\t\tif (keyFields.length === 1) {\n\t\t\tconst field = keyFields[0];\n\t\t\tconst value = getProp(doc, field);\n\t\t\tif (value === undefined) return null;\n\t\t\t// Preserve type information in the key\n\t\t\treturn value; //JSON.stringify({ t: typeof value, v: value });\n\t\t}\n\n\t\t// For compound index, concatenate values with type preservation\n\t\tconst keyParts = [];\n\t\tfor (let i = 0; i < keyFields.length; i++) {\n\t\t\tconst value = getProp(doc, keyFields[i]);\n\t\t\tif (value === undefined) return null;\n\t\t\tkeyParts.push(value /*JSON.stringify(value) */);\n\t\t}\n\t\t// Use a separator that won't appear in JSON\n\t\treturn keyParts.join('\\x00');\n\t}\n\n\t/**\n\t * Add a document to the index\n   * \n\t * @param {Object} doc - The document to index\n\t */\n\tadd(doc) {\n\t\tconst indexKey = this.extractIndexKey(doc);\n\t\tif (indexKey !== null) {\n\t\t\tthis.data.add(indexKey, doc._id.toString());\n\t\t}\n\t}\n\n\t/**\n\t * Remove a document from the index\n   * \n\t * @param {Object} doc - The document to remove\n\t */\n\tremove(doc) {\n\t\tconst indexKey = this.extractIndexKey(doc);\n\t\tif (indexKey !== null) {\n      this.data.delete(indexKey, doc._id.toString());\n\t\t}\n\t}\n\n\t/**\n\t * Query the index\n   * \n\t * @param {*} query - The query object\n\t * @returns {Array|null} Array of document IDs or null if index cannot satisfy query\n\t */\n\tquery(query) {\n\t\tconst queryKeys = Object.keys(query);\n\t\tconst indexFields = Object.keys(this.keys);\n\n\t\t// Only support single-field index queries for now\n\t\tif (indexFields.length !== 1) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst field = indexFields[0];\n\t\t\n\t\t// Check if query has this field\n\t\tif (queryKeys.indexOf(field) === -1) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst queryValue = query[field];\n\n\t\t// Case 1: Simple equality\n\t\tif (typeof queryValue !== 'object' || queryValue === null) {\n\t\t\tconst indexKey = queryValue; //JSON.stringify({ t: typeof queryValue, v: queryValue });\n\t\t\treturn this.data.search(indexKey);\n\t\t}\n\n\t\t// Case 2: Query with operators\n\t\tif (typeof queryValue === 'object' && !Array.isArray(queryValue)) {\n\t\t\treturn this._queryWithOperators(field, queryValue);\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * Query index with comparison operators\n   * \n\t * @private\n\t */\n\t_queryWithOperators(field, operators) {\n\t\tconst ops = Object.keys(operators);\n\t\tconst results = new Set();\n\n\t\t// Handle range queries: $gt, $gte, $lt, $lte\n\t\tconst hasRangeOp = ops.some(op => ['$gt', '$gte', '$lt', '$lte'].includes(op));\n\t\t\n\t\tif (hasRangeOp) {\n\t\t\t// Use B+ tree's efficient range search if we have both bounds\n\t\t\tconst hasGt = ops.includes('$gt') || ops.includes('$gte');\n\t\t\tconst hasLt = ops.includes('$lt') || ops.includes('$lte');\n\t\t\t\n\t\t\tif (hasGt && hasLt) {\n\t\t\t\t// Determine min and max bounds\n\t\t\t\tconst minValue = ops.includes('$gte') ? operators['$gte'] : \n\t\t\t\t                ops.includes('$gt') ? operators['$gt'] : -Infinity;\n\t\t\t\tconst maxValue = ops.includes('$lte') ? operators['$lte'] : \n\t\t\t\t                ops.includes('$lt') ? operators['$lt'] : Infinity;\n\t\t\t\t\n\t\t\t\tconst minKey = minValue; //JSON.stringify({ t: typeof minValue, v: minValue });\n\t\t\t\tconst maxKey = maxValue; //JSON.stringify({ t: typeof maxValue, v: maxValue });\n\t\t\t\t\n\t\t\t\t// Use B+ tree range search\n\t\t\t\tconst rangeResults = this.data.rangeSearch(minKey, maxKey);\n\t\t\t\t\n\t\t\t\tfor (const {key, value} of rangeResults) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\t//const parsed = JSON.parse(key);\n\t\t\t\t\t\tconst keyValue = key; //parsed.v;\n\t\t\t\t\t\t\n\t\t\t\t\t\t// Apply exact operator semantics\n\t\t\t\t\t\tlet matches = true;\n\t\t\t\t\t\tif (ops.includes('$gt') && !(keyValue > operators['$gt'])) matches = false;\n\t\t\t\t\t\tif (ops.includes('$gte') && !(keyValue >= operators['$gte'])) matches = false;\n\t\t\t\t\t\tif (ops.includes('$lt') && !(keyValue < operators['$lt'])) matches = false;\n\t\t\t\t\t\tif (ops.includes('$lte') && !(keyValue <= operators['$lte'])) matches = false;\n\t\t\t\t\t\t\n\t\t\t\t\t\tif (matches && value) {\n\t\t\t\t\t\t\t// value is now a single document ID (from the flattened array)\n\t\t\t\t\t\t\tresults.add(value);\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t// Skip malformed entries\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn Array.from(results);\n\t\t\t} else {\n\t\t\t\t// Scan all entries if we don't have both bounds\n\t\t\t\tconst allEntries = this.data.toArray();\n\t\t\t\tfor (const {key, value} of allEntries) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\t//const parsed = JSON.parse(key);\n\t\t\t\t\t\tconst keyValue = key; //parsed.v;\n\t\t\t\t\t\t\n\t\t\t\t\t\t// Check if value matches all operators\n\t\t\t\t\t\tlet matches = true;\n\t\t\t\t\t\tfor (const op of ops) {\n\t\t\t\t\t\t\tconst operand = operators[op];\n\t\t\t\t\t\t\tif (op === '$gt' && !(keyValue > operand)) matches = false;\n\t\t\t\t\t\t\telse if (op === '$gte' && !(keyValue >= operand)) matches = false;\n\t\t\t\t\t\t\telse if (op === '$lt' && !(keyValue < operand)) matches = false;\n\t\t\t\t\t\t\telse if (op === '$lte' && !(keyValue <= operand)) matches = false;\n\t\t\t\t\t\t\telse if (op === '$eq' && !(keyValue === operand)) matches = false;\n\t\t\t\t\t\t\telse if (op === '$ne' && !(keyValue !== operand)) matches = false;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\tif (matches && value) {\n\t\t\t\t\t\t\t// value is now a single document ID (from the flattened array)\n\t\t\t\t\t\t\tresults.add(value);\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t// Skip malformed entries\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn Array.from(results);\n\t\t\t}\n\t\t}\n\n\t\t// Handle $in operator\n\t\tif (ops.includes('$in')) {\n\t\t\tconst values = operators['$in'];\n\t\t\tif (Array.isArray(values)) {\n\t\t\t\tfor (const value of values) {\n\t\t\t\t\tconst indexKey = value; //JSON.stringify({ t: typeof value, v: value });\n\t\t\t\t\tconst idArray = this.data.search(indexKey);\n\t\t\t\t\tif (idArray) {\n\t\t\t\t\t\tidArray.forEach(id => results.add(id));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn Array.from(results);\n\t\t\t}\n\t\t}\n\n\t\t// Handle $eq operator\n\t\tif (ops.includes('$eq')) {\n\t\t\tconst value = operators['$eq'];\n\t\t\tconst indexKey = value; //JSON.stringify({ t: typeof value, v: value });\n\t\t\tconst result = this.data.search(indexKey);\n\t\t\treturn result || [];\n\t\t}\n\n\t\t// Handle $ne operator (requires full scan, not optimal)\n\t\tif (ops.includes('$ne')) {\n\t\t\tconst excludeValue = operators['$ne'];\n\t\t\tconst excludeKey = excludeValue; //JSON.stringify({ t: typeof excludeValue, v: excludeValue });\n\t\t\tconst allEntries = this.data.toArray();\n\t\t\tfor (const {key, value} of allEntries) {\n\t\t\t\tif (key !== excludeKey && value) {\n\t\t\t\t\t// value is now a single document ID (from the flattened array)\n\t\t\t\t\tresults.add(value);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn Array.from(results);\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * Clear all entries from the index\n\t */\n\tclear() {\n\t\tthis.data.clear();\n\t}\n}\n","import { Index } from './Index.js';\nimport { TextIndex } from './TextIndex.js';\nimport { getProp } from './utils.js';\n\n/**\n * Text index implementation using TextIndex\n * Supports full-text search on one or more fields\n */\nexport class TextCollectionIndex extends Index {\n\tconstructor(name, keys, storage, options = {}) {\n\t\tsuper(name, keys, storage, options);\n\t\t// Create the underlying TextIndex\n\t\tthis.textIndex = new TextIndex(storage);\n\t\t// Track which fields are indexed\n\t\tthis.indexedFields = [];\n\t\tfor (const field in keys) {\n\t\t\tif (keys[field] === 'text') {\n\t\t\t\tthis.indexedFields.push(field);\n\t\t\t}\n\t\t}\n\t\tif (this.indexedFields.length === 0) {\n\t\t\tthrow new Error('Text index must have at least one field with type \"text\"');\n\t\t}\n\t\t\n\t}\n\n\t/**\n\t * Extract text content from a document for the indexed fields\n\t * @param {Object} doc - The document\n\t * @returns {string} Combined text from all indexed fields\n\t */\n\t_extractText(doc) {\n\t\tconst textParts = [];\n\t\tfor (const field of this.indexedFields) {\n\t\t\tconst value = getProp(doc, field);\n\t\t\tif (value !== undefined && value !== null) {\n\t\t\t\ttextParts.push(String(value));\n\t\t\t}\n\t\t}\n\t\treturn textParts.join(' ');\n\t}\n\n\t/**\n\t * Add a document to the text index\n\t * @param {Object} doc - The document to index\n\t */\n\tadd(doc) {\n\t\tif (!doc._id) {\n\t\t\tthrow new Error('Document must have an _id field');\n\t\t}\n\t\tconst text = this._extractText(doc);\n\t\tif (text) {\n\t\t\tthis.textIndex.add(String(doc._id), text);\n\t\t}\n\t}\n\n\t/**\n\t * Remove a document from the text index\n\t * @param {Object} doc - The document to remove\n\t */\n\tremove(doc) {\n\t\tif (!doc._id) {\n\t\t\treturn;\n\t\t}\n\t\tthis.textIndex.remove(String(doc._id));\n\t}\n\n\t/**\n\t * Query the text index\n\t * @param {*} query - The query object\n\t * @returns {Array|null} Array of document IDs or null if query is not a text search\n\t */\n\tquery(query) {\n\t\t// This method is used for query planning\n\t\t// Text queries are handled separately in queryMatcher\n\t\treturn null;\n\t}\n\n\t/**\n\t * Search the text index\n\t * @param {string} searchText - The text to search for\n\t * @param {Object} options - Search options\n\t * @returns {Array} Array of document IDs\n\t */\n\tsearch(searchText, options = {}) {\n\t\tconst results = this.textIndex.query(searchText, { scored: false, ...options });\n\t\treturn results;\n\t}\n\n\t/**\n\t * Clear all data from the index\n\t */\n\tclear() {\n\t\tthis.textIndex.clear();\n\t}\n\n\t/**\n\t * Get index specification\n\t */\n\tgetSpec() {\n\t\treturn {\n\t\t\tname: this.name,\n\t\t\tkey: this.keys,\n\t\t\ttextIndexVersion: 3,\n\t\t\tweights: this._getWeights()\n\t\t};\n\t}\n\n\t/**\n\t * Get field weights (all default to 1 for now)\n\t */\n\t_getWeights() {\n\t\tconst weights = {};\n\t\tfor (const field of this.indexedFields) {\n\t\t\tweights[field] = 1;\n\t\t}\n\t\treturn weights;\n\t}\n\n}\n","\nimport { IndexStore } from './IndexStore.js';\n\n/**\n * R-tree implementation for geospatial indexing\n * \n * This implementation supports:\n * - Adding points with lat/lng coordinates\n * - Removing points\n * - Bounding box queries\n * - Location + radius queries (converted to bounding box)\n */\n\n/**\n * Calculate distance between two points using Haversine formula\n * @param {number} lat1 - Latitude of first point\n * @param {number} lng1 - Longitude of first point\n * @param {number} lat2 - Latitude of second point\n * @param {number} lng2 - Longitude of second point\n * @returns {number} Distance in kilometers\n */\nfunction haversineDistance(lat1, lng1, lat2, lng2) {\n\tconst R = 6371; // Earth's radius in kilometers\n\tconst dLat = (lat2 - lat1) * Math.PI / 180;\n\tconst dLng = (lng2 - lng1) * Math.PI / 180;\n\tconst a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +\n\t\tMath.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *\n\t\tMath.sin(dLng / 2) * Math.sin(dLng / 2);\n\tconst c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n\treturn R * c;\n}\n\n/**\n * Convert radius query to bounding box\n * Approximation: 1 degree latitude  111 km\n * @param {number} lat - Center latitude\n * @param {number} lng - Center longitude\n * @param {number} radiusKm - Radius in kilometers\n * @returns {Object} Bounding box {minLat, maxLat, minLng, maxLng}\n */\nfunction radiusToBoundingBox(lat, lng, radiusKm) {\n\tconst latDelta = radiusKm / 111; // degrees\n\tconst lngDelta = radiusKm / (111 * Math.cos(lat * Math.PI / 180)); // degrees\n\t\n\treturn {\n\t\tminLat: lat - latDelta,\n\t\tmaxLat: lat + latDelta,\n\t\tminLng: lng - lngDelta,\n\t\tmaxLng: lng + lngDelta\n\t};\n}\n\n/**\n * Check if two bounding boxes intersect\n */\nfunction intersects(bbox1, bbox2) {\n\treturn !(bbox1.maxLat < bbox2.minLat ||\n\t\tbbox1.minLat > bbox2.maxLat ||\n\t\tbbox1.maxLng < bbox2.minLng ||\n\t\tbbox1.minLng > bbox2.maxLng);\n}\n\n/**\n * Check if bbox1 contains bbox2\n */\nfunction contains(bbox1, bbox2) {\n\treturn bbox1.minLat <= bbox2.minLat &&\n\t\tbbox1.maxLat >= bbox2.maxLat &&\n\t\tbbox1.minLng <= bbox2.minLng &&\n\t\tbbox1.maxLng >= bbox2.maxLng;\n}\n\n/**\n * Calculate the area of a bounding box\n */\nfunction area(bbox) {\n\treturn (bbox.maxLat - bbox.minLat) * (bbox.maxLng - bbox.minLng);\n}\n\n/**\n * Calculate the bounding box that contains both input boxes\n */\nfunction union(bbox1, bbox2) {\n\treturn {\n\t\tminLat: Math.min(bbox1.minLat, bbox2.minLat),\n\t\tmaxLat: Math.max(bbox1.maxLat, bbox2.maxLat),\n\t\tminLng: Math.min(bbox1.minLng, bbox2.minLng),\n\t\tmaxLng: Math.max(bbox1.maxLng, bbox2.maxLng)\n\t};\n}\n\n/**\n * Calculate the enlargement needed to include bbox2 in bbox1\n */\nfunction enlargement(bbox1, bbox2) {\n\tconst unionBox = union(bbox1, bbox2);\n\treturn area(unionBox) - area(bbox1);\n}\n\n/**\n * R-tree Node class\n */\nclass RTreeNode {\n\tconstructor(isLeaf = false, indexStore) {\n    if (!(indexStore instanceof IndexStore)) {\n      throw new Error('IndexStore is required to create RTreeNode');\n    }\n\n    this.indexStore = indexStore;\n\n    if (typeof isLeaf === 'object') {\n      this._data = isLeaf;\n      this.id = this._data.id;\n      this.isLeaf = this._data.isLeaf;\n      this.children = [];\n      this.bbox = Object.assign({}, this._data.bbox);\n\n      // leaf nodes will have data entries as children\n      // internal nodes will have child node IDs\n      if (!this.isLeaf) {\n        for (const childId of this._data.children) {\n          const childData = indexStore.getDataMap('nodes').get(childId);\n          if (!childData) {\n            throw new Error(`RTreeNode: Child node with id ${childId} not found in IndexStore`);\n          }\n          const childNode = new RTreeNode(childData, indexStore);\n          this.children.push(childNode);\n        }\n      } else {\n        this.children = [...this._data.children];\n      }\n\n    } else {\n      this._data = {\n        id: indexStore.getMeta('nextId'),\n        isLeaf: isLeaf,\n        children: [],\n        bbox: null\n      };\n      indexStore.setMeta('nextId', this._data.id + 1);\n      indexStore.getDataMap('nodes').set(this._data.id, this._data);\n      this.id = this._data.id;\n      this.isLeaf = isLeaf;\n      this.children = []; // For internal nodes: child nodes; For leaf nodes: data entries\n      this.bbox = null;\n    }\n\n    return new Proxy(this, {\n      set(target, prop, value) {\n        if (prop === 'children') {\n          // console.warn('Directly modifying children', value);\n          target.children = value;\n          // Update the stored children IDs\n          if (!target.isLeaf) {\n            target._data.children = target.children.map(child => child.id);\n          } else {\n            target._data.children = [...target.children];\n          }\n          indexStore.getDataMap('nodes').set(target.id, target._data);\n          return true;\n        }\n        target[prop] = value;\n        return true;\n      },\n      get(target, prop) {\n        if (prop === 'children') {\n          return new Proxy(target.children, {\n            set(childTarget, childProp, childValue) {\n              childTarget[childProp] = childValue;\n              // Update the stored children IDs\n              if (!target.isLeaf) {\n                target._data.children = target.children.map(child => child.id);\n              } else {\n                target._data.children = [...target.children];\n              }\n              indexStore.getDataMap('nodes').set(target.id, target._data);\n              return true;\n            }\n          });\n        }\n        return target[prop];\n      }\n    });\n\t}\n\n\t/**\n\t * Update the bounding box to contain all children\n\t */\n\tupdateBBox() {\n\t\tif (this.children.length === 0) {\n\t\t\tthis.bbox = null;\n\t\t\treturn;\n\t\t}\n\n\t\tlet minLat = Infinity, maxLat = -Infinity;\n\t\tlet minLng = Infinity, maxLng = -Infinity;\n\n\t\tfor (const child of this.children) {\n\t\t\tconst bbox = child.bbox;\n\t\t\tminLat = Math.min(minLat, bbox.minLat);\n\t\t\tmaxLat = Math.max(maxLat, bbox.maxLat);\n\t\t\tminLng = Math.min(minLng, bbox.minLng);\n\t\t\tmaxLng = Math.max(maxLng, bbox.maxLng);\n\t\t}\n\n\t\tthis.bbox = { minLat, maxLat, minLng, maxLng };\n    this._data.bbox = Object.assign({}, this.bbox);\n    this.indexStore.getDataMap('nodes').set(this.id, this._data);\n\t}\n}\n\n/**\n * R-tree implementation\n */\nexport class RTree {\n\tconstructor(maxEntries = 9, indexStore = new IndexStore()) {\n\t\tthis.maxEntries = maxEntries;\n\t\tthis.minEntries = Math.max(2, Math.ceil(maxEntries / 2));\n    this.indexStore = indexStore;\n\n    if (indexStore.hasMeta('maxEntries')) {\n      if (indexStore.getMeta('maxEntries') !== maxEntries) {\n        throw new Error(`R-tree maxEntries does not match stored index metadata ${indexStore.getMeta('maxEntries')} != ${maxEntries}`);\n      }\n      if (indexStore.getMeta('minEntries') !== this.minEntries) {\n        throw new Error(`R-tree minEntries does not match stored index metadata ${indexStore.getMeta('minEntries')} != ${this.minEntries}`);\n      }\n\n      this._size = this.indexStore.getMeta('size');\n      this.root = new RTreeNode(this.indexStore.getDataMap('nodes').get(this.indexStore.getMeta('rootId')), this.indexStore);\n    } else {\n      this.indexStore.setMeta('maxEntries', this.maxEntries);\n      this.indexStore.setMeta('minEntries', this.minEntries);\n      this.indexStore.setMeta('nextId', 1);\n      this.root = new RTreeNode(true, this.indexStore);\n      this.indexStore.setMeta('rootId', this.root.id);\n      this.indexStore.setMeta('size', 0);\n      this._size = 0;\n    }\n\t}\n\n\t/**\n\t * Insert a point into the R-tree\n\t * @param {number} lat - Latitude\n\t * @param {number} lng - Longitude\n\t * @param {*} data - Associated data\n\t */\n\tinsert(lat, lng, data) {\n\t\t// Create a point bounding box (bbox with zero area)\n\t\tconst bbox = {\n\t\t\tminLat: lat,\n\t\t\tmaxLat: lat,\n\t\t\tminLng: lng,\n\t\t\tmaxLng: lng\n\t\t};\n\n\t\tconst entry = { bbox, lat, lng, data };\n\t\tthis._insert(entry, this.root, 1);\n\t\tthis._size++;\n    this.indexStore.setMeta('size', this._size);\n\t}\n\n\t/**\n\t * Internal insert method\n\t */\n\t_insert(entry, node, level) {\n\t\tif (node.isLeaf) {\n\t\t\tnode.children.push(entry);\n\t\t\tnode.updateBBox();\n\n\t\t\tif (node.children.length > this.maxEntries) {\n\t\t\t\treturn this._split(node);\n\t\t\t}\n\t\t} else {\n\t\t\t// Choose subtree\n\t\t\tconst target = this._chooseSubtree(entry.bbox, node);\n\t\t\tconst splitNode = this._insert(entry, target, level + 1);\n\n\t\t\tif (splitNode) {\n\t\t\t\tnode.children.push(splitNode);\n\t\t\t\tnode.updateBBox();\n\n\t\t\t\tif (node.children.length > this.maxEntries) {\n\t\t\t\t\treturn this._split(node);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tnode.updateBBox();\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n\n\t/**\n\t * Choose the best subtree to insert an entry\n\t */\n\t_chooseSubtree(bbox, node) {\n\t\tlet minEnlargement = Infinity;\n\t\tlet minArea = Infinity;\n\t\tlet targetNode = null;\n\n\t\tfor (const child of node.children) {\n\t\t\tconst enl = enlargement(child.bbox, bbox);\n\t\t\tconst ar = area(child.bbox);\n\n\t\t\tif (enl < minEnlargement || (enl === minEnlargement && ar < minArea)) {\n\t\t\t\tminEnlargement = enl;\n\t\t\t\tminArea = ar;\n\t\t\t\ttargetNode = child;\n\t\t\t}\n\t\t}\n\n\t\treturn targetNode;\n\t}\n\n\t/**\n\t * Split an overflowing node\n\t */\n\t_split(node) {\n\n    // console.log(`Splitting node ${node.id} with ${node.children.length} children`);\n\t\t// Simple linear split algorithm\n\t\tconst children = node.children;\n\t\tconst isLeaf = node.isLeaf;\n\n\t\t// Find two seeds (most distant entries)\n\t\tlet maxDist = -Infinity;\n\t\tlet seed1Idx = 0, seed2Idx = 1;\n\n\t\tfor (let i = 0; i < children.length; i++) {\n\t\t\tfor (let j = i + 1; j < children.length; j++) {\n\t\t\t\tconst bbox1 = children[i].bbox;\n\t\t\t\tconst bbox2 = children[j].bbox;\n\t\t\t\tconst combinedBox = union(bbox1, bbox2);\n\t\t\t\tconst waste = area(combinedBox) - area(bbox1) - area(bbox2);\n\t\t\t\t\n\t\t\t\tif (waste > maxDist) {\n\t\t\t\t\tmaxDist = waste;\n\t\t\t\t\tseed1Idx = i;\n\t\t\t\t\tseed2Idx = j;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Create two new nodes\n\t\tconst node1 = new RTreeNode(isLeaf, this.indexStore);\n\t\tconst node2 = new RTreeNode(isLeaf, this.indexStore);\n\n\t\tnode1.children.push(children[seed1Idx]);\n\t\tnode2.children.push(children[seed2Idx]);\n\n    // console.log('node1 children after seeds:', node1);\n    // console.log('node2 children after seeds:', node2);\n\n\t\t// Distribute remaining entries\n\t\tfor (let i = 0; i < children.length; i++) {\n\t\t\tif (i === seed1Idx || i === seed2Idx) continue;\n\n\t\t\tconst child = children[i];\n\t\t\tconst bbox = child.bbox;\n\t\t\t\n\t\t\tconst enl1 = node1.children.length === 0 ? Infinity : enlargement(node1.bbox || bbox, bbox);\n\t\t\tconst enl2 = node2.children.length === 0 ? Infinity : enlargement(node2.bbox || bbox, bbox);\n\n\t\t\tif (node1.children.length < this.minEntries && \n\t\t\t\tchildren.length - i + node1.children.length <= this.minEntries) {\n\t\t\t\tnode1.children.push(child);\n\t\t\t} else if (node2.children.length < this.minEntries && \n\t\t\t\tchildren.length - i + node2.children.length <= this.minEntries) {\n\t\t\t\tnode2.children.push(child);\n\t\t\t} else if (enl1 < enl2) {\n\t\t\t\tnode1.children.push(child);\n\t\t\t} else if (enl2 < enl1) {\n\t\t\t\tnode2.children.push(child);\n\t\t\t} else {\n\t\t\t\t// Equal enlargement, choose the one with smaller area\n\t\t\t\tconst area1 = node1.bbox ? area(node1.bbox) : 0;\n\t\t\t\tconst area2 = node2.bbox ? area(node2.bbox) : 0;\n\t\t\t\tif (area1 < area2) {\n\t\t\t\t\tnode1.children.push(child);\n\t\t\t\t} else {\n\t\t\t\t\tnode2.children.push(child);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tnode1.updateBBox();\n\t\t\tnode2.updateBBox();\n\t\t}\n\n\t\t// Update the original node with one group\n\t\tnode.children = node1.children;\n\t\tnode.updateBBox();\n\n\t\t// If this was the root, create a new root\n\t\tif (node === this.root) {\n\t\t\tconst newRoot = new RTreeNode(false, this.indexStore);\n\t\t\tnewRoot.children = [node1, node2];\n\t\t\tnewRoot.updateBBox();\n\t\t\tthis.root = newRoot;\n      this.indexStore.setMeta('rootId', this.root.id);\n\t\t\treturn null;\n\t\t}\n\n\t\treturn node2;\n\t}\n\n\t/**\n\t * Search for points within a bounding box\n\t * @param {Object} bbox - Bounding box {minLat, maxLat, minLng, maxLng}\n\t * @returns {Array} Array of matching entries\n\t */\n\tsearchBBox(bbox) {\n\t\tconst results = [];\n\t\tthis._searchBBox(bbox, this.root, results);\n\t\treturn results;\n\t}\n\n\t/**\n\t * Internal bounding box search\n\t */\n\t_searchBBox(bbox, node, results) {\n\t\tif (!node.bbox || !intersects(bbox, node.bbox)) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (node.isLeaf) {\n\t\t\tfor (const entry of node.children) {\n\t\t\t\tif (intersects(bbox, entry.bbox)) {\n\t\t\t\t\tresults.push(entry);\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tfor (const child of node.children) {\n\t\t\t\tthis._searchBBox(bbox, child, results);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Search for points within a radius of a location\n\t * @param {number} lat - Center latitude\n\t * @param {number} lng - Center longitude\n\t * @param {number} radiusKm - Radius in kilometers\n\t * @returns {Array} Array of matching entries\n\t */\n\tsearchRadius(lat, lng, radiusKm) {\n\t\t// Convert radius to bounding box for initial filtering\n\t\tconst bbox = radiusToBoundingBox(lat, lng, radiusKm);\n\t\tconst candidates = this.searchBBox(bbox);\n\n\t\t// Filter by actual distance\n\t\tconst results = [];\n\t\tfor (const entry of candidates) {\n\t\t\tconst dist = haversineDistance(lat, lng, entry.lat, entry.lng);\n\t\t\tif (dist <= radiusKm) {\n\t\t\t\tresults.push(entry);\n\t\t\t}\n\t\t}\n\n\t\treturn results;\n\t}\n\n\t/**\n\t * Remove a point from the R-tree\n\t * @param {number} lat - Latitude\n\t * @param {number} lng - Longitude\n\t * @param {*} data - Associated data (optional, for exact match)\n\t * @returns {boolean} True if removed, false if not found\n\t */\n\tremove(lat, lng, data = null) {\n\t\tconst bbox = {\n\t\t\tminLat: lat,\n\t\t\tmaxLat: lat,\n\t\t\tminLng: lng,\n\t\t\tmaxLng: lng\n\t\t};\n\n\t\tconst removed = this._remove(bbox, data, this.root, null, -1);\n\t\t\n\t\tif (removed) {\n\t\t\tthis._size--;\n      this.indexStore.setMeta('size', this._size);\n\t\t}\n\t\t\n\t\t// If root has only one child after removal, make that child the new root\n\t\tif (this.root.children.length === 1 && !this.root.isLeaf) {\n\t\t\tthis.root = this.root.children[0];\n      this.indexStore.setMeta('rootId', this.root.id);\n\t\t}\n\n\t\treturn removed;\n\t}\n\n\t/**\n\t * Internal remove method\n\t */\n\t_remove(bbox, data, node, parent, indexInParent) {\n\t\tif (!node.bbox || !intersects(bbox, node.bbox)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (node.isLeaf) {\n\t\t\tfor (let i = 0; i < node.children.length; i++) {\n\t\t\t\tconst entry = node.children[i];\n\t\t\t\tif (entry.lat === bbox.minLat && entry.lng === bbox.minLng) {\n\t\t\t\t\t// If data is specified, check for match\n\t\t\t\t\tconst dataMatches = data === null || \n\t\t\t\t\t\tJSON.stringify(entry.data) === JSON.stringify(data);\n\t\t\t\t\t\n\t\t\t\t\tif (dataMatches) {\n\t\t\t\t\t\tnode.children.splice(i, 1);\n\t\t\t\t\t\tnode.updateBBox();\n\t\t\t\t\t\t\n\t\t\t\t\t\t// Handle underflow\n\t\t\t\t\t\tif (node.children.length < this.minEntries && node !== this.root) {\n\t\t\t\t\t\t\t// Simple approach: reinsert all entries from this node\n\t\t\t\t\t\t\tconst entries = node.children.slice();\n\t\t\t\t\t\t\tnode.children = [];\n\t\t\t\t\t\t\tnode.updateBBox();\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t// Remove this node from parent\n\t\t\t\t\t\t\tif (parent) {\n\t\t\t\t\t\t\t\tparent.children.splice(indexInParent, 1);\n\t\t\t\t\t\t\t\tparent.updateBBox();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t// Reinsert entries\n\t\t\t\t\t\t\tfor (const e of entries) {\n\t\t\t\t\t\t\t\tthis._insert(e, this.root, 1);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tfor (let i = 0; i < node.children.length; i++) {\n\t\t\t\tconst child = node.children[i];\n\t\t\t\tif (this._remove(bbox, data, child, node, i)) {\n\t\t\t\t\tnode.updateBBox();\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn false;\n\t}\n\n\t/**\n\t * Get all entries in the tree\n\t * @returns {Array} All entries\n\t */\n\tgetAll() {\n\t\tconst results = [];\n\t\tthis._getAll(this.root, results);\n\t\treturn results;\n\t}\n\n\t/**\n\t * Internal method to get all entries\n\t */\n\t_getAll(node, results) {\n\t\tif (node.isLeaf) {\n\t\t\tresults.push(...node.children);\n\t\t} else {\n\t\t\tfor (const child of node.children) {\n\t\t\t\tthis._getAll(child, results);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Get the number of entries in the tree\n\t * @returns {number} Number of entries\n\t */\n\tsize() {\n\t\treturn this._size;\n\t}\n\n\t/**\n\t * Clear all entries from the tree\n\t */\n\tclear() {\n\t\tthis.root = new RTreeNode(true, this.indexStore);\n    this.indexStore.setMeta('rootId', this.root.id);\n\t\tthis._size = 0;\n    this.indexStore.setMeta('size', 0);\n\t}\n\n}\n\nexport default RTree;\n","import { Index } from './Index.js';\nimport { RTree } from './RTree.js';\nimport { getProp } from './utils.js';\n\n/**\n * Geospatial index implementation using RTree\n * Supports geospatial queries on GeoJSON fields\n */\nexport class GeospatialCollectionIndex extends Index {\n\tconstructor(name, keys, storage, options = {}) {\n\t\tsuper(name, keys, storage, options);\n\t\t// Create the underlying RTree\n\t\tthis.rtree = new RTree(9, storage);\n\t\t// Track which field is the geospatial field\n\t\tthis.geoField = null;\n\t\tfor (const field in keys) {\n\t\t\tif (keys[field] === '2dsphere' || keys[field] === '2d') {\n\t\t\t\tthis.geoField = field;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tif (!this.geoField) {\n\t\t\tthrow new Error('Geospatial index must have at least one field with type \"2dsphere\" or \"2d\"');\n\t\t}\n\t}\n\n\t/**\n\t * Extract coordinates from a GeoJSON object\n\t * @param {Object} geoJson - The GeoJSON object\n\t * @returns {Object|null} Object with lat and lng, or null if invalid\n\t */\n\t_extractCoordinates(geoJson) {\n\t\tif (!geoJson) return null;\n\n\t\t// Handle GeoJSON FeatureCollection\n\t\tif (geoJson.type === 'FeatureCollection' && geoJson.features && geoJson.features.length > 0) {\n\t\t\tconst feature = geoJson.features[0];\n\t\t\tif (feature.geometry) {\n\t\t\t\treturn this._extractCoordinates(feature.geometry);\n\t\t\t}\n\t\t}\n\n\t\t// Handle GeoJSON Feature\n\t\tif (geoJson.type === 'Feature' && geoJson.geometry) {\n\t\t\treturn this._extractCoordinates(geoJson.geometry);\n\t\t}\n\n\t\t// Handle GeoJSON Point\n\t\tif (geoJson.type === 'Point' && geoJson.coordinates) {\n\t\t\tconst [lng, lat] = geoJson.coordinates;\n\t\t\tif (typeof lng === 'number' && typeof lat === 'number') {\n\t\t\t\treturn { lat, lng };\n\t\t\t}\n\t\t}\n\n\t\t// Handle GeoJSON Polygon - use centroid of first coordinate\n\t\tif (geoJson.type === 'Polygon' && geoJson.coordinates && geoJson.coordinates.length > 0) {\n\t\t\tconst ring = geoJson.coordinates[0];\n\t\t\tif (ring.length > 0) {\n\t\t\t\tlet sumLat = 0, sumLng = 0;\n\t\t\t\tfor (const coord of ring) {\n\t\t\t\t\tsumLng += coord[0];\n\t\t\t\t\tsumLat += coord[1];\n\t\t\t\t}\n\t\t\t\treturn {\n\t\t\t\t\tlat: sumLat / ring.length,\n\t\t\t\t\tlng: sumLng / ring.length\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * Add a document to the geospatial index\n\t * @param {Object} doc - The document to index\n\t */\n\tadd(doc) {\n\t\tif (!doc._id) {\n\t\t\tthrow new Error('Document must have an _id field');\n\t\t}\n\t\tconst geoValue = getProp(doc, this.geoField);\n\t\tconst coords = this._extractCoordinates(geoValue);\n\t\tif (coords) {\n\t\t\tthis.rtree.insert(coords.lat, coords.lng, { \n\t\t\t\t_id: doc._id, \n\t\t\t\tgeoJson: geoValue \n\t\t\t});\n\t\t}\n\t}\n\n\t/**\n\t * Remove a document from the geospatial index\n\t * @param {Object} doc - The document to remove\n\t */\n\tremove(doc) {\n\t\tif (!doc._id) {\n\t\t\treturn;\n\t\t}\n\t\tconst geoValue = getProp(doc, this.geoField);\n\t\tconst coords = this._extractCoordinates(geoValue);\n\t\tif (coords) {\n\t\t\tthis.rtree.remove(coords.lat, coords.lng, { \n\t\t\t\t_id: doc._id, \n\t\t\t\tgeoJson: geoValue \n\t\t\t});\n\t\t}\n\t}\n\n\t/**\n\t * Query the geospatial index\n\t * @param {*} query - The query object\n\t * @returns {Array|null} Array of document IDs or null if query is not a geospatial query\n\t */\n\tquery(query) {\n\t\t// Check if this is a geospatial query on our indexed field\n\t\tif (!query[this.geoField]) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst geoQuery = query[this.geoField];\n\n\t\t// Handle $geoWithin with bounding box\n\t\tif (geoQuery.$geoWithin) {\n\t\t\tconst bbox = geoQuery.$geoWithin;\n\t\t\t// bbox format: [[minLon, maxLat], [maxLon, minLat]]\n\t\t\tif (Array.isArray(bbox) && bbox.length === 2) {\n\t\t\t\tconst minLon = bbox[0][0];\n\t\t\t\tconst maxLat = bbox[0][1];\n\t\t\t\tconst maxLon = bbox[1][0];\n\t\t\t\tconst minLat = bbox[1][1];\n\n\t\t\t\tconst results = this.rtree.searchBBox({\n\t\t\t\t\tminLat: minLat,\n\t\t\t\t\tmaxLat: maxLat,\n\t\t\t\t\tminLng: minLon,\n\t\t\t\t\tmaxLng: maxLon\n\t\t\t\t});\n\n\t\t\t\t// Extract document IDs\n\t\t\t\treturn results.map(entry => entry.data._id);\n\t\t\t}\n\t\t}\n\n\t\t// Handle $near with radius\n\t\tif (geoQuery.$near) {\n\t\t\tconst nearQuery = geoQuery.$near;\n\t\t\t\n\t\t\t// Extract geometry from $geometry or use direct coordinates\n\t\t\tlet coordinates;\n\t\t\tif (nearQuery.$geometry) {\n\t\t\t\tcoordinates = nearQuery.$geometry.coordinates;\n\t\t\t} else if (nearQuery.coordinates) {\n\t\t\t\tcoordinates = nearQuery.coordinates;\n\t\t\t} else if (Array.isArray(nearQuery)) {\n\t\t\t\tcoordinates = nearQuery;\n\t\t\t} else {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tif (!coordinates || coordinates.length < 2) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tconst [lng, lat] = coordinates;\n\t\t\t\n\t\t\t// $maxDistance in meters (default to 1000km if not specified)\n\t\t\tconst maxDistanceMeters = nearQuery.$maxDistance || 1000000;\n\t\t\tconst maxDistanceKm = maxDistanceMeters / 1000;\n\n\t\t\t// Use rtree.searchRadius to find points within distance\n\t\t\tconst results = this.rtree.searchRadius(lat, lng, maxDistanceKm);\n\n\t\t\t// Calculate actual distances and sort by distance\n\t\t\tconst withDistances = results.map(entry => {\n\t\t\t\tconst dist = this._haversineDistance(lat, lng, entry.lat, entry.lng);\n\t\t\t\treturn {\n\t\t\t\t\t_id: entry.data._id,\n\t\t\t\t\tdistance: dist\n\t\t\t\t};\n\t\t\t});\n\n\t\t\t// Sort by distance (ascending)\n\t\t\twithDistances.sort((a, b) => a.distance - b.distance);\n\n\t\t\t// Return just the document IDs\n\t\t\treturn withDistances.map(entry => entry._id);\n\t\t}\n\n\t\t// Handle $nearSphere with radius (uses spherical distance, same as $near)\n\t\tif (geoQuery.$nearSphere) {\n\t\t\tconst nearQuery = geoQuery.$nearSphere;\n\t\t\t\n\t\t\t// Extract geometry from $geometry or use direct coordinates\n\t\t\tlet coordinates;\n\t\t\tif (nearQuery.$geometry) {\n\t\t\t\tcoordinates = nearQuery.$geometry.coordinates;\n\t\t\t} else if (nearQuery.coordinates) {\n\t\t\t\tcoordinates = nearQuery.coordinates;\n\t\t\t} else if (Array.isArray(nearQuery)) {\n\t\t\t\tcoordinates = nearQuery;\n\t\t\t} else {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tif (!coordinates || coordinates.length < 2) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tconst [lng, lat] = coordinates;\n\t\t\t\n\t\t\t// $maxDistance in meters (default to 1000km if not specified)\n\t\t\tconst maxDistanceMeters = nearQuery.$maxDistance || 1000000;\n\t\t\tconst maxDistanceKm = maxDistanceMeters / 1000;\n\n\t\t\t// Use rtree.searchRadius to find points within distance (already uses Haversine)\n\t\t\tconst results = this.rtree.searchRadius(lat, lng, maxDistanceKm);\n\n\t\t\t// Calculate actual distances and sort by distance\n\t\t\tconst withDistances = results.map(entry => {\n\t\t\t\tconst dist = this._haversineDistance(lat, lng, entry.lat, entry.lng);\n\t\t\t\treturn {\n\t\t\t\t\t_id: entry.data._id,\n\t\t\t\t\tdistance: dist\n\t\t\t\t};\n\t\t\t});\n\n\t\t\t// Sort by distance (ascending)\n\t\t\twithDistances.sort((a, b) => a.distance - b.distance);\n\n\t\t\t// Return just the document IDs\n\t\t\treturn withDistances.map(entry => entry._id);\n\t\t}\n\n\t\t// Handle $geoIntersects\n\t\tif (geoQuery.$geoIntersects) {\n\t\t\tconst intersectsQuery = geoQuery.$geoIntersects;\n\t\t\t\n\t\t\t// Extract geometry\n\t\t\tlet geometry;\n\t\t\tif (intersectsQuery.$geometry) {\n\t\t\t\tgeometry = intersectsQuery.$geometry;\n\t\t\t} else {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tif (!geometry || !geometry.type) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\t// For now, support Point and Polygon geometries\n\t\t\tif (geometry.type === 'Point') {\n\t\t\t\tconst [lng, lat] = geometry.coordinates;\n\t\t\t\t\n\t\t\t\t// Search for points at this exact location\n\t\t\t\t// Use a very small bounding box\n\t\t\t\tconst epsilon = 0.0001; // ~11 meters\n\t\t\t\tconst results = this.rtree.searchBBox({\n\t\t\t\t\tminLat: lat - epsilon,\n\t\t\t\t\tmaxLat: lat + epsilon,\n\t\t\t\t\tminLng: lng - epsilon,\n\t\t\t\t\tmaxLng: lng + epsilon\n\t\t\t\t});\n\n\t\t\t\t// Return document IDs\n\t\t\t\treturn results.map(entry => entry.data._id);\n\t\t\t} else if (geometry.type === 'Polygon') {\n\t\t\t\tconst coordinates = geometry.coordinates;\n\t\t\t\tif (!coordinates || coordinates.length === 0) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\t// Get the exterior ring\n\t\t\t\tconst ring = coordinates[0];\n\t\t\t\tif (!ring || ring.length < 3) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\t// Calculate bounding box of the polygon\n\t\t\t\tlet minLat = Infinity, maxLat = -Infinity;\n\t\t\t\tlet minLng = Infinity, maxLng = -Infinity;\n\t\t\t\t\n\t\t\t\tfor (const coord of ring) {\n\t\t\t\t\tconst [lng, lat] = coord;\n\t\t\t\t\tminLat = Math.min(minLat, lat);\n\t\t\t\t\tmaxLat = Math.max(maxLat, lat);\n\t\t\t\t\tminLng = Math.min(minLng, lng);\n\t\t\t\t\tmaxLng = Math.max(maxLng, lng);\n\t\t\t\t}\n\n\t\t\t\t// Search for points within the bounding box\n\t\t\t\tconst candidates = this.rtree.searchBBox({\n\t\t\t\t\tminLat,\n\t\t\t\t\tmaxLat,\n\t\t\t\t\tminLng,\n\t\t\t\t\tmaxLng\n\t\t\t\t});\n\n\t\t\t\t// Filter by actual point-in-polygon test\n\t\t\t\tconst results = candidates.filter(entry => {\n\t\t\t\t\treturn this._pointInPolygon(entry.lat, entry.lng, ring);\n\t\t\t\t});\n\n\t\t\t\treturn results.map(entry => entry.data._id);\n\t\t\t}\n\n\t\t\treturn null;\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * Calculate distance between two points using Haversine formula\n\t * @param {number} lat1 - Latitude of first point\n\t * @param {number} lng1 - Longitude of first point\n\t * @param {number} lat2 - Latitude of second point\n\t * @param {number} lng2 - Longitude of second point\n\t * @returns {number} Distance in kilometers\n\t */\n\t_haversineDistance(lat1, lng1, lat2, lng2) {\n\t\tconst R = 6371; // Earth's radius in kilometers\n\t\tconst dLat = (lat2 - lat1) * Math.PI / 180;\n\t\tconst dLng = (lng2 - lng1) * Math.PI / 180;\n\t\tconst a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +\n\t\t\tMath.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *\n\t\t\tMath.sin(dLng / 2) * Math.sin(dLng / 2);\n\t\tconst c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n\t\treturn R * c;\n\t}\n\n\t/**\n\t * Test if a point is inside a polygon using ray casting algorithm\n\t * @param {number} lat - Point latitude\n\t * @param {number} lng - Point longitude\n\t * @param {Array} ring - Polygon ring as array of [lng, lat] coordinates\n\t * @returns {boolean} True if point is inside polygon\n\t */\n\t_pointInPolygon(lat, lng, ring) {\n\t\tlet inside = false;\n\t\t\n\t\tfor (let i = 0, j = ring.length - 1; i < ring.length; j = i++) {\n\t\t\tconst [xi, yi] = ring[i];\n\t\t\tconst [xj, yj] = ring[j];\n\t\t\t\n\t\t\tconst intersect = ((yi > lat) !== (yj > lat)) &&\n\t\t\t\t(lng < (xj - xi) * (lat - yi) / (yj - yi) + xi);\n\t\t\t\n\t\t\tif (intersect) {\n\t\t\t\tinside = !inside;\n\t\t\t}\n\t\t}\n\t\t\n\t\treturn inside;\n\t}\n\n\t/**\n\t * Clear all data from the index\n\t */\n\tclear() {\n\t\tthis.rtree.clear();\n\t}\n\n\t/**\n\t * Get index specification\n\t */\n\tgetSpec() {\n\t\treturn {\n\t\t\tname: this.name,\n\t\t\tkey: this.keys,\n\t\t\t'2dsphereIndexVersion': 3\n\t\t};\n\t}\n\n}\n","import { TextCollectionIndex } from './TextCollectionIndex.js';\nimport { GeospatialCollectionIndex } from './GeospatialCollectionIndex.js';\n\n/**\n * Query execution plan\n */\nclass QueryPlan {\n\tconstructor() {\n\t\tthis.type = 'full_scan'; // 'full_scan', 'index_scan', 'index_intersection', 'index_union'\n\t\tthis.indexes = []; // Indexes to use\n\t\tthis.indexScans = []; // Array of { indexName, docIds }\n\t\tthis.estimatedCost = Infinity;\n\t\tthis.indexOnly = false; // If true, only use index results (no full scan fallback)\n\t}\n}\n\n/**\n * Query planner - analyzes queries and generates optimal execution plans\n */\nexport class QueryPlanner {\n\tconstructor(indexes) {\n\t\tthis.indexes = indexes; // Map<string, CollectionIndex>\n\t}\n\n\t/**\n\t * Generate an execution plan for a query\n\t * @param {Object} query - MongoDB query object\n\t * @returns {QueryPlan} Execution plan\n\t */\n\tplan(query) {\n\t\tconst plan = new QueryPlan();\n\n\t\t// Empty query - full scan\n\t\tif (!query || Object.keys(query).length === 0) {\n\t\t\treturn plan;\n\t\t}\n\n\t\t// Analyze query structure\n\t\tconst analysis = this._analyzeQuery(query);\n\n\t\t// Check for text search\n\t\tif (analysis.hasTextSearch) {\n\t\t\tconst textPlan = this._planTextSearch(query, analysis);\n\t\t\tif (textPlan) {\n\t\t\t\treturn textPlan;\n\t\t\t}\n\t\t}\n\n\t\t// Check for geospatial query\n\t\tif (analysis.hasGeoQuery) {\n\t\t\tconst geoPlan = this._planGeoQuery(query, analysis);\n\t\t\tif (geoPlan) {\n\t\t\t\treturn geoPlan;\n\t\t\t}\n\t\t}\n\n\t\t// Check for $and queries - can use index intersection\n\t\tif (analysis.type === 'and') {\n\t\t\tconst andPlan = this._planAndQuery(query, analysis);\n\t\t\tif (andPlan.type !== 'full_scan') {\n\t\t\t\treturn andPlan;\n\t\t\t}\n\t\t}\n\n\t\t// Check for $or queries - can use index union\n\t\tif (analysis.type === 'or') {\n\t\t\tconst orPlan = this._planOrQuery(query, analysis);\n\t\t\tif (orPlan.type !== 'full_scan') {\n\t\t\t\treturn orPlan;\n\t\t\t}\n\t\t}\n\n\t\t// Try to find a single index for simple queries\n\t\tconst simplePlan = this._planSimpleQuery(query);\n\t\tif (simplePlan.type !== 'full_scan') {\n\t\t\treturn simplePlan;\n\t\t}\n\n\t\t// Fall back to full scan\n\t\treturn plan;\n\t}\n\n\t/**\n\t * Analyze query structure\n\t * @private\n\t */\n\t_analyzeQuery(query) {\n\t\tconst analysis = {\n\t\t\ttype: 'simple', // 'simple', 'and', 'or', 'complex'\n\t\t\tfields: [],\n\t\t\toperators: {},\n\t\t\thasTextSearch: false,\n\t\t\thasGeoQuery: false,\n\t\t\tconditions: []\n\t\t};\n\n\t\tconst keys = Object.keys(query);\n\n\t\t// Check for top-level logical operators\n\t\tif (keys.length === 1) {\n\t\t\tconst key = keys[0];\n\t\t\tif (key === '$and') {\n\t\t\t\tanalysis.type = 'and';\n\t\t\t\tanalysis.conditions = query.$and;\n\t\t\t\t// Analyze each condition\n\t\t\t\tfor (const condition of analysis.conditions) {\n\t\t\t\t\tconst subAnalysis = this._analyzeQuery(condition);\n\t\t\t\t\tanalysis.fields.push(...subAnalysis.fields);\n\t\t\t\t\tif (subAnalysis.hasTextSearch) analysis.hasTextSearch = true;\n\t\t\t\t\tif (subAnalysis.hasGeoQuery) analysis.hasGeoQuery = true;\n\t\t\t\t}\n\t\t\t\treturn analysis;\n\t\t\t} else if (key === '$or') {\n\t\t\t\tanalysis.type = 'or';\n\t\t\t\tanalysis.conditions = query.$or;\n\t\t\t\t// Analyze each condition\n\t\t\t\tfor (const condition of analysis.conditions) {\n\t\t\t\t\tconst subAnalysis = this._analyzeQuery(condition);\n\t\t\t\t\tanalysis.fields.push(...subAnalysis.fields);\n\t\t\t\t\tif (subAnalysis.hasTextSearch) analysis.hasTextSearch = true;\n\t\t\t\t\tif (subAnalysis.hasGeoQuery) analysis.hasGeoQuery = true;\n\t\t\t\t}\n\t\t\t\treturn analysis;\n\t\t\t}\n\t\t}\n\n\t\t// Analyze simple field conditions\n\t\tfor (const field of keys) {\n\t\t\tif (field.startsWith('$')) {\n\t\t\t\tcontinue; // Skip top-level operators we don't handle yet\n\t\t\t}\n\n\t\t\tanalysis.fields.push(field);\n\t\t\tconst value = query[field];\n\n\t\t\t// Check for operators\n\t\t\tif (typeof value === 'object' && value !== null && !Array.isArray(value)) {\n\t\t\t\tconst ops = Object.keys(value);\n\t\t\t\tanalysis.operators[field] = ops;\n\n\t\t\t\t// Check for text search\n\t\t\t\tif (ops.includes('$text')) {\n\t\t\t\t\tanalysis.hasTextSearch = true;\n\t\t\t\t}\n\n\t\t\t\t// Check for geospatial operators\n\t\t\t\tif (ops.some(op => ['$geoWithin', '$geoIntersects', '$near', '$nearSphere'].includes(op))) {\n\t\t\t\t\tanalysis.hasGeoQuery = true;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// If multiple fields, it's an implicit $and\n\t\tif (keys.length > 1) {\n\t\t\tanalysis.type = 'and';\n\t\t}\n\n\t\treturn analysis;\n\t}\n\n\t/**\n\t * Plan for text search queries\n\t * @private\n\t */\n\t_planTextSearch(query, analysis) {\n\t\t// Find text index\n\t\tfor (const [indexName,index] of this.indexes) {\n\t\t\tif (index instanceof TextCollectionIndex) {\n\t\t\t\t// Look for $text operator in query\n\t\t\t\tconst textQuery = this._extractTextQuery(query);\n\t\t\t\tif (textQuery) {\n\t\t\t\t\tconst plan = new QueryPlan();\n\t\t\t\t\tplan.type = 'index_scan';\n\t\t\t\t\tplan.indexes = [indexName];\n\t\t\t\t\tconst docIds = index.search(textQuery);\n\t\t\t\t\tplan.indexScans = [{ indexName, docIds }];\n\t\t\t\t\tplan.estimatedCost = docIds.length;\n\t\t\t\t\tplan.indexOnly = true; // Text search must use index\n\t\t\t\t\treturn plan;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n\n\t/**\n\t * Extract $text query from query object\n\t * @private\n\t */\n\t_extractTextQuery(query) {\n\t\tfor (const field in query) {\n\t\t\tconst value = query[field];\n\t\t\tif (typeof value === 'object' && value !== null && value.$text) {\n\t\t\t\treturn typeof value.$text === 'string' ? value.$text : value.$text.$search;\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n\n\t/**\n\t * Plan for geospatial queries\n\t * @private\n\t */\n\t_planGeoQuery(query, analysis) {\n\t\t// Find geospatial index\n\t\tfor (const [indexName,index] of this.indexes) {\n\t\t\tif (index instanceof GeospatialCollectionIndex) {\n\t\t\t\tconst docIds = index.query(query);\n\t\t\t\tif (docIds !== null) {\n\t\t\t\t\tconst plan = new QueryPlan();\n\t\t\t\t\tplan.type = 'index_scan';\n\t\t\t\t\tplan.indexes = [indexName];\n\t\t\t\t\tplan.indexScans = [{ indexName, docIds }];\n\t\t\t\t\tplan.estimatedCost = docIds.length;\n\t\t\t\t\tplan.indexOnly = true; // Geospatial queries must use index\n\t\t\t\t\treturn plan;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n\n\t/**\n\t * Plan for $and queries (index intersection)\n\t * @private\n\t */\n\t_planAndQuery(query, analysis) {\n\t\tconst plan = new QueryPlan();\n\n\t\t// Extract conditions\n\t\tlet conditions;\n\t\tif (query.$and) {\n\t\t\tconditions = query.$and;\n\t\t} else {\n\t\t\t// Implicit AND - convert to array of conditions\n\t\t\tconditions = Object.keys(query).map(field => ({ [field]: query[field] }));\n\t\t}\n\n\t\t// Try to find indexes for each condition\n\t\tconst indexableConditions = [];\n\t\tfor (const condition of conditions) {\n\t\t\tconst conditionPlan = this._planSimpleQuery(condition);\n\t\t\tif (conditionPlan.type === 'index_scan') {\n\t\t\t\tindexableConditions.push(conditionPlan.indexScans[0]);\n\t\t\t}\n\t\t}\n\n\t\t// If we have multiple indexable conditions, use index intersection\n\t\tif (indexableConditions.length > 1) {\n\t\t\tplan.type = 'index_intersection';\n\t\t\tplan.indexScans = indexableConditions;\n\t\t\tplan.indexes = indexableConditions.map(scan => scan.indexName);\n\t\t\t\n\t\t\t// Estimate cost as the smallest set\n\t\t\tplan.estimatedCost = Math.min(...indexableConditions.map(scan => scan.docIds.length));\n\t\t\treturn plan;\n\t\t}\n\n\t\t// If we have one indexable condition, use it\n\t\tif (indexableConditions.length === 1) {\n\t\t\tplan.type = 'index_scan';\n\t\t\tplan.indexScans = [indexableConditions[0]];\n\t\t\tplan.indexes = [indexableConditions[0].indexName];\n\t\t\tplan.estimatedCost = indexableConditions[0].docIds.length;\n\t\t\treturn plan;\n\t\t}\n\n\t\treturn plan; // full_scan\n\t}\n\n\t/**\n\t * Plan for $or queries (index union)\n\t * @private\n\t */\n\t_planOrQuery(query, analysis) {\n\t\tconst plan = new QueryPlan();\n\n\t\tif (!query.$or) {\n\t\t\treturn plan;\n\t\t}\n\n\t\tconst conditions = query.$or;\n\n\t\t// Try to find indexes for each condition\n\t\tconst indexableConditions = [];\n\t\tfor (const condition of conditions) {\n\t\t\tconst conditionPlan = this._planSimpleQuery(condition);\n\t\t\tif (conditionPlan.type === 'index_scan') {\n\t\t\t\tindexableConditions.push(conditionPlan.indexScans[0]);\n\t\t\t}\n\t\t}\n\n\t\t// If we have at least one indexable condition, use index union\n\t\tif (indexableConditions.length > 0) {\n\t\t\tplan.type = 'index_union';\n\t\t\tplan.indexScans = indexableConditions;\n\t\t\tplan.indexes = indexableConditions.map(scan => scan.indexName);\n\t\t\t\n\t\t\t// Estimate cost as the sum of all sets\n\t\t\tplan.estimatedCost = indexableConditions.reduce((sum, scan) => sum + scan.docIds.length, 0);\n\t\t\treturn plan;\n\t\t}\n\n\t\treturn plan; // full_scan\n\t}\n\n\t/**\n\t * Plan for simple single-field queries\n\t * @private\n\t */\n\t_planSimpleQuery(query) {\n\t\tconst plan = new QueryPlan();\n\t\tconst queryKeys = Object.keys(query);\n\n\t\tif (queryKeys.length === 0) {\n\t\t\treturn plan;\n\t\t}\n\n\t\t// Try each index\n\t\tfor (const [indexName,index] of this.indexes) {\n\n\t\t\t// Skip special index types (they have their own planning)\n\t\t\tif (index instanceof TextCollectionIndex || index instanceof GeospatialCollectionIndex) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t// Try to use this index\n\t\t\tconst docIds = index.query(query);\n\t\t\tif (docIds !== null && docIds.length >= 0) {\n\t\t\t\tplan.type = 'index_scan';\n\t\t\t\tplan.indexes = [indexName];\n\t\t\t\tplan.indexScans = [{ indexName, docIds }];\n\t\t\t\tplan.estimatedCost = docIds.length;\n\t\t\t\treturn plan;\n\t\t\t}\n\t\t}\n\n\t\treturn plan; // full_scan\n\t}\n\n\t/**\n\t * Execute a query plan and return document IDs\n\t * @param {QueryPlan} plan - The execution plan\n\t * @returns {Array|null} Array of document IDs or null for full scan\n\t */\n\texecute(plan) {\n\t\tif (plan.type === 'full_scan') {\n\t\t\treturn null; // Signals cursor to do full scan\n\t\t}\n\n\t\tif (plan.type === 'index_scan') {\n\t\t\treturn plan.indexScans[0].docIds;\n\t\t}\n\n\t\tif (plan.type === 'index_intersection') {\n\t\t\t// Intersection: docs must be in ALL index results\n\t\t\tif (plan.indexScans.length === 0) return null;\n\t\t\t\n\t\t\t// Start with the smallest set for efficiency\n\t\t\tconst sorted = plan.indexScans.slice().sort((a, b) => a.docIds.length - b.docIds.length);\n\t\t\tlet result = new Set(sorted[0].docIds);\n\t\t\t\n\t\t\t// Intersect with each subsequent set\n\t\t\tfor (let i = 1; i < sorted.length; i++) {\n\t\t\t\tconst currentSet = new Set(sorted[i].docIds);\n\t\t\t\tresult = new Set([...result].filter(id => currentSet.has(id)));\n\t\t\t\t\n\t\t\t\t// Early exit if intersection becomes empty\n\t\t\t\tif (result.size === 0) break;\n\t\t\t}\n\t\t\t\n\t\t\treturn Array.from(result);\n\t\t}\n\n\t\tif (plan.type === 'index_union') {\n\t\t\t// Union: docs in ANY index result\n\t\t\tconst result = new Set();\n\t\t\tfor (const scan of plan.indexScans) {\n\t\t\t\tscan.docIds.forEach(id => result.add(id));\n\t\t\t}\n\t\t\treturn Array.from(result);\n\t\t}\n\n\t\treturn null;\n\t}\n}\n","/**\n * Aggregation Expression Evaluator\n * \n * Implements MongoDB aggregation expression operators for use in\n * $project, $addFields, $set, $group, and other pipeline stages.\n */\n\nimport { getProp } from './utils.js';\n\n/**\n * Evaluate an aggregation expression against a document\n * @param {*} expr - The expression to evaluate (can be literal, field reference, or expression object)\n * @param {Object} doc - The document to evaluate against\n * @returns {*} The evaluated result\n */\nexport function evaluateExpression(expr, doc) {\n\t// Literal values (strings not starting with $, numbers, booleans, null)\n\tif (expr === null || expr === undefined) {\n\t\treturn expr;\n\t}\n\t\n\tif (typeof expr === 'boolean' || typeof expr === 'number') {\n\t\treturn expr;\n\t}\n\t\n\t// Field reference ($fieldName) or variable reference ($$variableName)\n\tif (typeof expr === 'string') {\n\t\tif (expr.startsWith('$$')) {\n\t\t\t// Variable reference ($$var)\n\t\t\treturn getProp(doc, expr.substring(2));\n\t\t} else if (expr.charAt(0) === '$') {\n\t\t\t// Field reference ($field)\n\t\t\treturn getProp(doc, expr.substring(1));\n\t\t}\n\t\treturn expr; // Literal string\n\t}\n\t\n\t// Expression object\n\tif (typeof expr === 'object') {\n\t\t// Check if it's an array literal\n\t\tif (Array.isArray(expr)) {\n\t\t\treturn expr.map(item => evaluateExpression(item, doc));\n\t\t}\n\t\t\n\t\t// Expression operator\n\t\tconst keys = Object.keys(expr);\n\t\tif (keys.length === 0) {\n\t\t\treturn expr; // Empty object literal\n\t\t}\n\t\t\n\t\tconst operator = keys[0];\n\t\tconst operand = expr[operator];\n\t\t\n\t\t// Evaluate the expression based on operator\n\t\treturn evaluateOperator(operator, operand, doc);\n\t}\n\t\n\treturn expr;\n}\n\n/**\n * Evaluate a specific operator\n */\nfunction evaluateOperator(operator, operand, doc) {\n\tswitch (operator) {\n\t\t// Arithmetic operators\n\t\tcase '$add': return evalAdd(operand, doc);\n\t\tcase '$subtract': return evalSubtract(operand, doc);\n\t\tcase '$multiply': return evalMultiply(operand, doc);\n\t\tcase '$divide': return evalDivide(operand, doc);\n\t\tcase '$mod': return evalMod(operand, doc);\n\t\tcase '$pow': return evalPow(operand, doc);\n\t\tcase '$sqrt': return evalSqrt(operand, doc);\n\t\tcase '$abs': return evalAbs(operand, doc);\n\t\tcase '$ceil': return evalCeil(operand, doc);\n\t\tcase '$floor': return evalFloor(operand, doc);\n\t\tcase '$trunc': return evalTrunc(operand, doc);\n\t\tcase '$round': return evalRound(operand, doc);\n\t\t\n\t\t// String operators\n\t\tcase '$concat': return evalConcat(operand, doc);\n\t\tcase '$substr': return evalSubstr(operand, doc);\n\t\tcase '$toLower': return evalToLower(operand, doc);\n\t\tcase '$toUpper': return evalToUpper(operand, doc);\n\t\tcase '$trim': return evalTrim(operand, doc);\n\t\tcase '$ltrim': return evalLtrim(operand, doc);\n\t\tcase '$rtrim': return evalRtrim(operand, doc);\n\t\tcase '$split': return evalSplit(operand, doc);\n\t\tcase '$strLenCP': return evalStrLenCP(operand, doc);\n\t\tcase '$strcasecmp': return evalStrcasecmp(operand, doc);\n\t\tcase '$indexOfCP': return evalIndexOfCP(operand, doc);\n\t\tcase '$replaceOne': return evalReplaceOne(operand, doc);\n\t\tcase '$replaceAll': return evalReplaceAll(operand, doc);\n\t\t\n\t\t// Comparison operators\n\t\tcase '$cmp': return evalCmp(operand, doc);\n\t\tcase '$eq': return evalEq(operand, doc);\n\t\tcase '$ne': return evalNe(operand, doc);\n\t\tcase '$gt': return evalGt(operand, doc);\n\t\tcase '$gte': return evalGte(operand, doc);\n\t\tcase '$lt': return evalLt(operand, doc);\n\t\tcase '$lte': return evalLte(operand, doc);\n\t\t\n\t\t// Logical operators\n\t\tcase '$and': return evalAnd(operand, doc);\n\t\tcase '$or': return evalOr(operand, doc);\n\t\tcase '$not': return evalNot(operand, doc);\n\t\t\n\t\t// Conditional operators\n\t\tcase '$cond': return evalCond(operand, doc);\n\t\tcase '$ifNull': return evalIfNull(operand, doc);\n\t\tcase '$switch': return evalSwitch(operand, doc);\n\t\t\n\t\t// Date operators\n\t\tcase '$year': return evalYear(operand, doc);\n\t\tcase '$month': return evalMonth(operand, doc);\n\t\tcase '$dayOfMonth': return evalDayOfMonth(operand, doc);\n\t\tcase '$dayOfWeek': return evalDayOfWeek(operand, doc);\n\t\tcase '$dayOfYear': return evalDayOfYear(operand, doc);\n\t\tcase '$hour': return evalHour(operand, doc);\n\t\tcase '$minute': return evalMinute(operand, doc);\n\t\tcase '$second': return evalSecond(operand, doc);\n\t\tcase '$millisecond': return evalMillisecond(operand, doc);\n\t\tcase '$week': return evalWeek(operand, doc);\n\t\tcase '$isoWeek': return evalIsoWeek(operand, doc);\n\t\tcase '$isoWeekYear': return evalIsoWeekYear(operand, doc);\n\t\tcase '$dateToString': return evalDateToString(operand, doc);\n\t\tcase '$toDate': return evalToDate(operand, doc);\n\t\t\n\t\t// Array operators\n\t\tcase '$arrayElemAt': return evalArrayElemAt(operand, doc);\n\t\tcase '$concatArrays': return evalConcatArrays(operand, doc);\n\t\tcase '$filter': return evalFilter(operand, doc);\n\t\tcase '$in': return evalIn(operand, doc);\n\t\tcase '$indexOfArray': return evalIndexOfArray(operand, doc);\n\t\tcase '$isArray': return evalIsArray(operand, doc);\n\t\tcase '$map': return evalMap(operand, doc);\n\t\tcase '$reduce': return evalReduce(operand, doc);\n\t\tcase '$size': return evalSize(operand, doc);\n\t\tcase '$slice': return evalSlice(operand, doc);\n\t\tcase '$reverseArray': return evalReverseArray(operand, doc);\n\t\tcase '$zip': return evalZip(operand, doc);\n\t\t\n\t\t// Type operators\n\t\tcase '$type': return evalType(operand, doc);\n\t\tcase '$convert': return evalConvert(operand, doc);\n\t\tcase '$toBool': return evalToBool(operand, doc);\n\t\tcase '$toDecimal': return evalToDecimal(operand, doc);\n\t\tcase '$toDouble': return evalToDouble(operand, doc);\n\t\tcase '$toInt': return evalToInt(operand, doc);\n\t\tcase '$toLong': return evalToLong(operand, doc);\n\t\tcase '$toString': return evalToString(operand, doc);\n\t\t\n\t\t// Object operators\n\t\tcase '$objectToArray': return evalObjectToArray(operand, doc);\n\t\tcase '$arrayToObject': return evalArrayToObject(operand, doc);\n\t\tcase '$mergeObjects': return evalMergeObjects(operand, doc);\n\t\t\n\t\t// Literal operator\n\t\tcase '$literal': return operand;\n\t\t\n\t\tdefault:\n\t\t\tthrow new Error(`Unsupported aggregation operator: ${operator}`);\n\t}\n}\n\n// ============================================================================\n// ARITHMETIC OPERATORS\n// ============================================================================\n\nfunction evalAdd(operands, doc) {\n\tif (!Array.isArray(operands)) return null;\n\tlet sum = 0;\n\tfor (const operand of operands) {\n\t\tconst val = evaluateExpression(operand, doc);\n\t\tif (val instanceof Date) {\n\t\t\tsum += val.getTime();\n\t\t} else if (typeof val === 'number') {\n\t\t\tsum += val;\n\t\t}\n\t}\n\treturn sum;\n}\n\nfunction evalSubtract(operands, doc) {\n\tif (!Array.isArray(operands) || operands.length !== 2) return null;\n\tconst val1 = evaluateExpression(operands[0], doc);\n\tconst val2 = evaluateExpression(operands[1], doc);\n\t\n\tif (val1 instanceof Date && val2 instanceof Date) {\n\t\treturn val1.getTime() - val2.getTime();\n\t} else if (val1 instanceof Date && typeof val2 === 'number') {\n\t\treturn new Date(val1.getTime() - val2);\n\t} else if (typeof val1 === 'number' && typeof val2 === 'number') {\n\t\treturn val1 - val2;\n\t}\n\treturn null;\n}\n\nfunction evalMultiply(operands, doc) {\n\tif (!Array.isArray(operands)) return null;\n\tlet product = 1;\n\tfor (const operand of operands) {\n\t\tconst val = evaluateExpression(operand, doc);\n\t\tif (typeof val === 'number') {\n\t\t\tproduct *= val;\n\t\t}\n\t}\n\treturn product;\n}\n\nfunction evalDivide(operands, doc) {\n\tif (!Array.isArray(operands) || operands.length !== 2) return null;\n\tconst val1 = evaluateExpression(operands[0], doc);\n\tconst val2 = evaluateExpression(operands[1], doc);\n\tif (typeof val1 === 'number' && typeof val2 === 'number' && val2 !== 0) {\n\t\treturn val1 / val2;\n\t}\n\treturn null;\n}\n\nfunction evalMod(operands, doc) {\n\tif (!Array.isArray(operands) || operands.length !== 2) return null;\n\tconst val1 = evaluateExpression(operands[0], doc);\n\tconst val2 = evaluateExpression(operands[1], doc);\n\tif (typeof val1 === 'number' && typeof val2 === 'number' && val2 !== 0) {\n\t\treturn val1 % val2;\n\t}\n\treturn null;\n}\n\nfunction evalPow(operands, doc) {\n\tif (!Array.isArray(operands) || operands.length !== 2) return null;\n\tconst base = evaluateExpression(operands[0], doc);\n\tconst exponent = evaluateExpression(operands[1], doc);\n\tif (typeof base === 'number' && typeof exponent === 'number') {\n\t\treturn Math.pow(base, exponent);\n\t}\n\treturn null;\n}\n\nfunction evalSqrt(operand, doc) {\n\tconst val = evaluateExpression(operand, doc);\n\tif (typeof val === 'number' && val >= 0) {\n\t\treturn Math.sqrt(val);\n\t}\n\treturn null;\n}\n\nfunction evalAbs(operand, doc) {\n\tconst val = evaluateExpression(operand, doc);\n\tif (typeof val === 'number') {\n\t\treturn Math.abs(val);\n\t}\n\treturn null;\n}\n\nfunction evalCeil(operand, doc) {\n\tconst val = evaluateExpression(operand, doc);\n\tif (typeof val === 'number') {\n\t\treturn Math.ceil(val);\n\t}\n\treturn null;\n}\n\nfunction evalFloor(operand, doc) {\n\tconst val = evaluateExpression(operand, doc);\n\tif (typeof val === 'number') {\n\t\treturn Math.floor(val);\n\t}\n\treturn null;\n}\n\nfunction evalTrunc(operand, doc) {\n\tconst val = evaluateExpression(operand, doc);\n\tif (typeof val === 'number') {\n\t\treturn Math.trunc(val);\n\t}\n\treturn null;\n}\n\nfunction evalRound(operands, doc) {\n\tconst val = evaluateExpression(Array.isArray(operands) ? operands[0] : operands, doc);\n\tconst place = Array.isArray(operands) && operands[1] !== undefined \n\t\t? evaluateExpression(operands[1], doc) \n\t\t: 0;\n\t\n\tif (typeof val === 'number' && typeof place === 'number') {\n\t\tconst multiplier = Math.pow(10, place);\n\t\treturn Math.round(val * multiplier) / multiplier;\n\t}\n\treturn null;\n}\n\n// ============================================================================\n// STRING OPERATORS\n// ============================================================================\n\nfunction evalConcat(operands, doc) {\n\tif (!Array.isArray(operands)) return null;\n\tlet result = '';\n\tfor (const operand of operands) {\n\t\tconst val = evaluateExpression(operand, doc);\n\t\tif (val !== null && val !== undefined) {\n\t\t\tresult += String(val);\n\t\t}\n\t}\n\treturn result;\n}\n\nfunction evalSubstr(operands, doc) {\n\tif (!Array.isArray(operands) || operands.length < 3) return null;\n\tconst str = String(evaluateExpression(operands[0], doc) || '');\n\tconst start = evaluateExpression(operands[1], doc);\n\tconst length = evaluateExpression(operands[2], doc);\n\tif (typeof start === 'number' && typeof length === 'number') {\n\t\treturn str.substr(start, length);\n\t}\n\treturn null;\n}\n\nfunction evalToLower(operand, doc) {\n\tconst val = evaluateExpression(operand, doc);\n\treturn val !== null && val !== undefined ? String(val).toLowerCase() : '';\n}\n\nfunction evalToUpper(operand, doc) {\n\tconst val = evaluateExpression(operand, doc);\n\treturn val !== null && val !== undefined ? String(val).toUpperCase() : '';\n}\n\nfunction evalTrim(operand, doc) {\n\tconst val = evaluateExpression(typeof operand === 'object' && operand.input ? operand.input : operand, doc);\n\tconst chars = operand.chars ? evaluateExpression(operand.chars, doc) : null;\n\t\n\tlet str = val !== null && val !== undefined ? String(val) : '';\n\t\n\tif (chars) {\n\t\tconst charsRegex = new RegExp(`^[${escapeRegex(chars)}]+|[${escapeRegex(chars)}]+$`, 'g');\n\t\treturn str.replace(charsRegex, '');\n\t}\n\treturn str.trim();\n}\n\nfunction evalLtrim(operand, doc) {\n\tconst val = evaluateExpression(typeof operand === 'object' && operand.input ? operand.input : operand, doc);\n\tconst chars = operand.chars ? evaluateExpression(operand.chars, doc) : null;\n\t\n\tlet str = val !== null && val !== undefined ? String(val) : '';\n\t\n\tif (chars) {\n\t\tconst charsRegex = new RegExp(`^[${escapeRegex(chars)}]+`, 'g');\n\t\treturn str.replace(charsRegex, '');\n\t}\n\treturn str.replace(/^\\s+/, '');\n}\n\nfunction evalRtrim(operand, doc) {\n\tconst val = evaluateExpression(typeof operand === 'object' && operand.input ? operand.input : operand, doc);\n\tconst chars = operand.chars ? evaluateExpression(operand.chars, doc) : null;\n\t\n\tlet str = val !== null && val !== undefined ? String(val) : '';\n\t\n\tif (chars) {\n\t\tconst charsRegex = new RegExp(`[${escapeRegex(chars)}]+$`, 'g');\n\t\treturn str.replace(charsRegex, '');\n\t}\n\treturn str.replace(/\\s+$/, '');\n}\n\nfunction evalSplit(operands, doc) {\n\tif (!Array.isArray(operands) || operands.length !== 2) return null;\n\tconst str = String(evaluateExpression(operands[0], doc) || '');\n\tconst delimiter = String(evaluateExpression(operands[1], doc) || '');\n\treturn str.split(delimiter);\n}\n\nfunction evalStrLenCP(operand, doc) {\n\tconst val = evaluateExpression(operand, doc);\n\treturn val !== null && val !== undefined ? String(val).length : 0;\n}\n\nfunction evalStrcasecmp(operands, doc) {\n\tif (!Array.isArray(operands) || operands.length !== 2) return null;\n\tconst str1 = String(evaluateExpression(operands[0], doc) || '').toLowerCase();\n\tconst str2 = String(evaluateExpression(operands[1], doc) || '').toLowerCase();\n\t\n\tif (str1 < str2) return -1;\n\tif (str1 > str2) return 1;\n\treturn 0;\n}\n\nfunction evalIndexOfCP(operands, doc) {\n\tif (!Array.isArray(operands) || operands.length < 2) return null;\n\tconst str = String(evaluateExpression(operands[0], doc) || '');\n\tconst substr = String(evaluateExpression(operands[1], doc) || '');\n\tconst start = operands[2] !== undefined ? evaluateExpression(operands[2], doc) : 0;\n\tconst end = operands[3] !== undefined ? evaluateExpression(operands[3], doc) : str.length;\n\t\n\tconst searchStr = str.substring(start, end);\n\tconst index = searchStr.indexOf(substr);\n\treturn index === -1 ? -1 : index + start;\n}\n\nfunction evalReplaceOne(operand, doc) {\n\tconst input = String(evaluateExpression(operand.input, doc) || '');\n\tconst find = String(evaluateExpression(operand.find, doc) || '');\n\tconst replacement = String(evaluateExpression(operand.replacement, doc) || '');\n\t\n\treturn input.replace(find, replacement);\n}\n\nfunction evalReplaceAll(operand, doc) {\n\tconst input = String(evaluateExpression(operand.input, doc) || '');\n\tconst find = String(evaluateExpression(operand.find, doc) || '');\n\tconst replacement = String(evaluateExpression(operand.replacement, doc) || '');\n\t\n\treturn input.split(find).join(replacement);\n}\n\nfunction escapeRegex(str) {\n\treturn str.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n}\n\n// ============================================================================\n// COMPARISON OPERATORS\n// ============================================================================\n\nfunction evalCmp(operands, doc) {\n\tif (!Array.isArray(operands) || operands.length !== 2) return null;\n\tconst val1 = evaluateExpression(operands[0], doc);\n\tconst val2 = evaluateExpression(operands[1], doc);\n\t\n\tif (val1 < val2) return -1;\n\tif (val1 > val2) return 1;\n\treturn 0;\n}\n\nfunction evalEq(operands, doc) {\n\tif (!Array.isArray(operands) || operands.length !== 2) return null;\n\tconst val1 = evaluateExpression(operands[0], doc);\n\tconst val2 = evaluateExpression(operands[1], doc);\n\treturn val1 === val2;\n}\n\nfunction evalNe(operands, doc) {\n\tif (!Array.isArray(operands) || operands.length !== 2) return null;\n\tconst val1 = evaluateExpression(operands[0], doc);\n\tconst val2 = evaluateExpression(operands[1], doc);\n\treturn val1 !== val2;\n}\n\nfunction evalGt(operands, doc) {\n\tif (!Array.isArray(operands) || operands.length !== 2) return null;\n\tconst val1 = evaluateExpression(operands[0], doc);\n\tconst val2 = evaluateExpression(operands[1], doc);\n\treturn val1 > val2;\n}\n\nfunction evalGte(operands, doc) {\n\tif (!Array.isArray(operands) || operands.length !== 2) return null;\n\tconst val1 = evaluateExpression(operands[0], doc);\n\tconst val2 = evaluateExpression(operands[1], doc);\n\treturn val1 >= val2;\n}\n\nfunction evalLt(operands, doc) {\n\tif (!Array.isArray(operands) || operands.length !== 2) return null;\n\tconst val1 = evaluateExpression(operands[0], doc);\n\tconst val2 = evaluateExpression(operands[1], doc);\n\treturn val1 < val2;\n}\n\nfunction evalLte(operands, doc) {\n\tif (!Array.isArray(operands) || operands.length !== 2) return null;\n\tconst val1 = evaluateExpression(operands[0], doc);\n\tconst val2 = evaluateExpression(operands[1], doc);\n\treturn val1 <= val2;\n}\n\n// ============================================================================\n// LOGICAL OPERATORS\n// ============================================================================\n\nfunction evalAnd(operands, doc) {\n\tif (!Array.isArray(operands)) return null;\n\tfor (const operand of operands) {\n\t\tconst val = evaluateExpression(operand, doc);\n\t\tif (!val) return false;\n\t}\n\treturn true;\n}\n\nfunction evalOr(operands, doc) {\n\tif (!Array.isArray(operands)) return null;\n\tfor (const operand of operands) {\n\t\tconst val = evaluateExpression(operand, doc);\n\t\tif (val) return true;\n\t}\n\treturn false;\n}\n\nfunction evalNot(operand, doc) {\n\tconst val = evaluateExpression(Array.isArray(operand) ? operand[0] : operand, doc);\n\treturn !val;\n}\n\n// ============================================================================\n// CONDITIONAL OPERATORS\n// ============================================================================\n\nfunction evalCond(operand, doc) {\n\t// Supports both array form [if, then, else] and object form {if, then, else}\n\tlet ifExpr, thenExpr, elseExpr;\n\t\n\tif (Array.isArray(operand)) {\n\t\tif (operand.length !== 3) return null;\n\t\t[ifExpr, thenExpr, elseExpr] = operand;\n\t} else if (typeof operand === 'object') {\n\t\tifExpr = operand.if;\n\t\tthenExpr = operand.then;\n\t\telseExpr = operand.else;\n\t} else {\n\t\treturn null;\n\t}\n\t\n\tconst condition = evaluateExpression(ifExpr, doc);\n\treturn condition ? evaluateExpression(thenExpr, doc) : evaluateExpression(elseExpr, doc);\n}\n\nfunction evalIfNull(operands, doc) {\n\tif (!Array.isArray(operands) || operands.length < 2) return null;\n\t\n\tfor (let i = 0; i < operands.length; i++) {\n\t\tconst val = evaluateExpression(operands[i], doc);\n\t\tif (val !== null && val !== undefined) {\n\t\t\treturn val;\n\t\t}\n\t}\n\treturn null;\n}\n\nfunction evalSwitch(operand, doc) {\n\tif (typeof operand !== 'object' || !Array.isArray(operand.branches)) {\n\t\treturn null;\n\t}\n\t\n\tfor (const branch of operand.branches) {\n\t\tconst caseResult = evaluateExpression(branch.case, doc);\n\t\tif (caseResult) {\n\t\t\treturn evaluateExpression(branch.then, doc);\n\t\t}\n\t}\n\t\n\treturn operand.default !== undefined ? evaluateExpression(operand.default, doc) : null;\n}\n\n// ============================================================================\n// DATE OPERATORS\n// ============================================================================\n\nfunction evalYear(operand, doc) {\n\tconst date = evaluateExpression(operand, doc);\n\tif (date instanceof Date) {\n\t\treturn date.getUTCFullYear();\n\t}\n\treturn null;\n}\n\nfunction evalMonth(operand, doc) {\n\tconst date = evaluateExpression(operand, doc);\n\tif (date instanceof Date) {\n\t\treturn date.getUTCMonth() + 1; // MongoDB returns 1-12\n\t}\n\treturn null;\n}\n\nfunction evalDayOfMonth(operand, doc) {\n\tconst date = evaluateExpression(operand, doc);\n\tif (date instanceof Date) {\n\t\treturn date.getUTCDate();\n\t}\n\treturn null;\n}\n\nfunction evalDayOfWeek(operand, doc) {\n\tconst date = evaluateExpression(operand, doc);\n\tif (date instanceof Date) {\n\t\treturn date.getUTCDay() + 1; // MongoDB returns 1-7 (Sunday is 1)\n\t}\n\treturn null;\n}\n\nfunction evalDayOfYear(operand, doc) {\n\tconst date = evaluateExpression(operand, doc);\n\tif (date instanceof Date) {\n\t\tconst start = new Date(Date.UTC(date.getUTCFullYear(), 0, 0));\n\t\tconst diff = date - start;\n\t\tconst oneDay = 1000 * 60 * 60 * 24;\n\t\treturn Math.floor(diff / oneDay);\n\t}\n\treturn null;\n}\n\nfunction evalHour(operand, doc) {\n\tconst date = evaluateExpression(operand, doc);\n\tif (date instanceof Date) {\n\t\treturn date.getUTCHours();\n\t}\n\treturn null;\n}\n\nfunction evalMinute(operand, doc) {\n\tconst date = evaluateExpression(operand, doc);\n\tif (date instanceof Date) {\n\t\treturn date.getUTCMinutes();\n\t}\n\treturn null;\n}\n\nfunction evalSecond(operand, doc) {\n\tconst date = evaluateExpression(operand, doc);\n\tif (date instanceof Date) {\n\t\treturn date.getUTCSeconds();\n\t}\n\treturn null;\n}\n\nfunction evalMillisecond(operand, doc) {\n\tconst date = evaluateExpression(operand, doc);\n\tif (date instanceof Date) {\n\t\treturn date.getUTCMilliseconds();\n\t}\n\treturn null;\n}\n\nfunction evalWeek(operand, doc) {\n\tconst date = evaluateExpression(operand, doc);\n\tif (date instanceof Date) {\n\t\tconst onejan = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));\n\t\tconst week = Math.ceil((((date - onejan) / 86400000) + onejan.getUTCDay() + 1) / 7);\n\t\treturn week - 1; // MongoDB weeks are 0-indexed\n\t}\n\treturn null;\n}\n\nfunction evalIsoWeek(operand, doc) {\n\tconst date = evaluateExpression(operand, doc);\n\tif (date instanceof Date) {\n\t\tconst target = new Date(date.valueOf());\n\t\tconst dayNr = (date.getUTCDay() + 6) % 7;\n\t\ttarget.setUTCDate(target.getUTCDate() - dayNr + 3);\n\t\tconst firstThursday = target.valueOf();\n\t\ttarget.setUTCMonth(0, 1);\n\t\tif (target.getUTCDay() !== 4) {\n\t\t\ttarget.setUTCMonth(0, 1 + ((4 - target.getUTCDay()) + 7) % 7);\n\t\t}\n\t\treturn 1 + Math.ceil((firstThursday - target) / 604800000);\n\t}\n\treturn null;\n}\n\nfunction evalIsoWeekYear(operand, doc) {\n\tconst date = evaluateExpression(operand, doc);\n\tif (date instanceof Date) {\n\t\tconst target = new Date(date.valueOf());\n\t\ttarget.setUTCDate(target.getUTCDate() - ((date.getUTCDay() + 6) % 7) + 3);\n\t\treturn target.getUTCFullYear();\n\t}\n\treturn null;\n}\n\nfunction evalDateToString(operand, doc) {\n\tconst format = operand.format ? evaluateExpression(operand.format, doc) : '%Y-%m-%dT%H:%M:%S.%LZ';\n\tconst date = evaluateExpression(operand.date, doc);\n\t\n\tif (!(date instanceof Date)) return null;\n\t\n\t// Simple format string implementation using UTC methods\n\treturn format\n\t\t.replace('%Y', date.getUTCFullYear())\n\t\t.replace('%m', String(date.getUTCMonth() + 1).padStart(2, '0'))\n\t\t.replace('%d', String(date.getUTCDate()).padStart(2, '0'))\n\t\t.replace('%H', String(date.getUTCHours()).padStart(2, '0'))\n\t\t.replace('%M', String(date.getUTCMinutes()).padStart(2, '0'))\n\t\t.replace('%S', String(date.getUTCSeconds()).padStart(2, '0'))\n\t\t.replace('%L', String(date.getUTCMilliseconds()).padStart(3, '0'));\n}\n\nfunction evalToDate(operand, doc) {\n\tconst val = evaluateExpression(operand, doc);\n\tif (val instanceof Date) return val;\n\tif (typeof val === 'string' || typeof val === 'number') {\n\t\tconst date = new Date(val);\n\t\treturn isNaN(date.getTime()) ? null : date;\n\t}\n\treturn null;\n}\n\n// ============================================================================\n// ARRAY OPERATORS\n// ============================================================================\n\nfunction evalArrayElemAt(operands, doc) {\n\tif (!Array.isArray(operands) || operands.length !== 2) return null;\n\tconst arr = evaluateExpression(operands[0], doc);\n\tconst idx = evaluateExpression(operands[1], doc);\n\t\n\tif (!Array.isArray(arr) || typeof idx !== 'number') return null;\n\t\n\tconst index = idx < 0 ? arr.length + idx : idx;\n\treturn arr[index];\n}\n\nfunction evalConcatArrays(operands, doc) {\n\tif (!Array.isArray(operands)) return null;\n\tconst result = [];\n\tfor (const operand of operands) {\n\t\tconst arr = evaluateExpression(operand, doc);\n\t\tif (Array.isArray(arr)) {\n\t\t\tresult.push(...arr);\n\t\t}\n\t}\n\treturn result;\n}\n\nfunction evalFilter(operand, doc) {\n\tconst input = evaluateExpression(operand.input, doc);\n\tconst asVar = operand.as || 'this';\n\tconst cond = operand.cond;\n\t\n\tif (!Array.isArray(input)) return null;\n\t\n\treturn input.filter(item => {\n\t\tconst itemDoc = { ...doc, [asVar]: item };\n\t\treturn evaluateExpression(cond, itemDoc);\n\t});\n}\n\nfunction evalIn(operands, doc) {\n\tif (!Array.isArray(operands) || operands.length !== 2) return null;\n\tconst value = evaluateExpression(operands[0], doc);\n\tconst arr = evaluateExpression(operands[1], doc);\n\t\n\tif (!Array.isArray(arr)) return false;\n\treturn arr.includes(value);\n}\n\nfunction evalIndexOfArray(operands, doc) {\n\tif (!Array.isArray(operands) || operands.length < 2) return null;\n\tconst arr = evaluateExpression(operands[0], doc);\n\tconst search = evaluateExpression(operands[1], doc);\n\tconst start = operands[2] !== undefined ? evaluateExpression(operands[2], doc) : 0;\n\tconst end = operands[3] !== undefined ? evaluateExpression(operands[3], doc) : arr.length;\n\t\n\tif (!Array.isArray(arr)) return null;\n\t\n\tfor (let i = start; i < end && i < arr.length; i++) {\n\t\tif (arr[i] === search) return i;\n\t}\n\treturn -1;\n}\n\nfunction evalIsArray(operand, doc) {\n\tconst val = evaluateExpression(operand, doc);\n\treturn Array.isArray(val);\n}\n\nfunction evalMap(operand, doc) {\n\tconst input = evaluateExpression(operand.input, doc);\n\tconst asVar = operand.as || 'this';\n\tconst inExpr = operand.in;\n\t\n\tif (!Array.isArray(input)) return null;\n\t\n\treturn input.map(item => {\n\t\tconst itemDoc = { ...doc, [asVar]: item };\n\t\treturn evaluateExpression(inExpr, itemDoc);\n\t});\n}\n\nfunction evalReduce(operand, doc) {\n\tconst input = evaluateExpression(operand.input, doc);\n\tconst initialValue = evaluateExpression(operand.initialValue, doc);\n\tconst inExpr = operand.in;\n\t\n\tif (!Array.isArray(input)) return null;\n\t\n\tlet value = initialValue;\n\tfor (const item of input) {\n\t\tconst itemDoc = { ...doc, value, this: item };\n\t\tvalue = evaluateExpression(inExpr, itemDoc);\n\t}\n\treturn value;\n}\n\nfunction evalSize(operand, doc) {\n\tconst arr = evaluateExpression(operand, doc);\n\treturn Array.isArray(arr) ? arr.length : null;\n}\n\nfunction evalSlice(operands, doc) {\n\tif (!Array.isArray(operands) || operands.length < 2) return null;\n\tconst arr = evaluateExpression(operands[0], doc);\n\t\n\tif (!Array.isArray(arr)) return null;\n\t\n\tif (operands.length === 2) {\n\t\tconst n = evaluateExpression(operands[1], doc);\n\t\treturn n >= 0 ? arr.slice(0, n) : arr.slice(n);\n\t} else {\n\t\tconst position = evaluateExpression(operands[1], doc);\n\t\tconst n = evaluateExpression(operands[2], doc);\n\t\treturn arr.slice(position, position + n);\n\t}\n}\n\nfunction evalReverseArray(operand, doc) {\n\tconst arr = evaluateExpression(operand, doc);\n\treturn Array.isArray(arr) ? arr.slice().reverse() : null;\n}\n\nfunction evalZip(operand, doc) {\n\tconst inputs = operand.inputs ? evaluateExpression(operand.inputs, doc) : null;\n\tconst useLongestLength = operand.useLongestLength || false;\n\tconst defaults = operand.defaults;\n\t\n\tif (!Array.isArray(inputs)) return null;\n\t\n\tconst arrays = inputs.map(input => evaluateExpression(input, doc));\n\tif (!arrays.every(arr => Array.isArray(arr))) return null;\n\t\n\tconst maxLength = Math.max(...arrays.map(arr => arr.length));\n\tconst length = useLongestLength ? maxLength : Math.min(...arrays.map(arr => arr.length));\n\t\n\tconst result = [];\n\tfor (let i = 0; i < length; i++) {\n\t\tconst tuple = [];\n\t\tfor (let j = 0; j < arrays.length; j++) {\n\t\t\tif (i < arrays[j].length) {\n\t\t\t\ttuple.push(arrays[j][i]);\n\t\t\t} else if (defaults && j < defaults.length) {\n\t\t\t\ttuple.push(defaults[j]);\n\t\t\t} else {\n\t\t\t\ttuple.push(null);\n\t\t\t}\n\t\t}\n\t\tresult.push(tuple);\n\t}\n\treturn result;\n}\n\n// ============================================================================\n// TYPE OPERATORS\n// ============================================================================\n\nfunction evalType(operand, doc) {\n\tconst val = evaluateExpression(operand, doc);\n\t\n\tif (val === null) return 'null';\n\tif (val === undefined) return 'missing';\n\tif (typeof val === 'boolean') return 'bool';\n\tif (typeof val === 'number') return Number.isInteger(val) ? 'int' : 'double';\n\tif (typeof val === 'string') return 'string';\n\tif (val instanceof Date) return 'date';\n\tif (Array.isArray(val)) return 'array';\n\tif (typeof val === 'object') return 'object';\n\t\n\treturn 'unknown';\n}\n\nfunction evalConvert(operand, doc) {\n\tconst input = evaluateExpression(operand.input, doc);\n\tconst to = operand.to;\n\tconst onError = operand.onError;\n\tconst onNull = operand.onNull;\n\t\n\tif (input === null) {\n\t\treturn onNull !== undefined ? evaluateExpression(onNull, doc) : null;\n\t}\n\t\n\ttry {\n\t\tswitch (to) {\n\t\t\tcase 'double':\n\t\t\tcase 'decimal':\n\t\t\t\treturn parseFloat(input);\n\t\t\tcase 'int':\n\t\t\tcase 'long':\n\t\t\t\treturn parseInt(input);\n\t\t\tcase 'bool':\n\t\t\t\treturn Boolean(input);\n\t\t\tcase 'string':\n\t\t\t\treturn String(input);\n\t\t\tcase 'date':\n\t\t\t\treturn new Date(input);\n\t\t\tdefault:\n\t\t\t\treturn input;\n\t\t}\n\t} catch (e) {\n\t\treturn onError !== undefined ? evaluateExpression(onError, doc) : null;\n\t}\n}\n\nfunction evalToBool(operand, doc) {\n\tconst val = evaluateExpression(operand, doc);\n\treturn Boolean(val);\n}\n\nfunction evalToDecimal(operand, doc) {\n\tconst val = evaluateExpression(operand, doc);\n\treturn parseFloat(val);\n}\n\nfunction evalToDouble(operand, doc) {\n\tconst val = evaluateExpression(operand, doc);\n\treturn parseFloat(val);\n}\n\nfunction evalToInt(operand, doc) {\n\tconst val = evaluateExpression(operand, doc);\n\treturn parseInt(val);\n}\n\nfunction evalToLong(operand, doc) {\n\tconst val = evaluateExpression(operand, doc);\n\treturn parseInt(val);\n}\n\nfunction evalToString(operand, doc) {\n\tconst val = evaluateExpression(operand, doc);\n\tif (val === null || val === undefined) return null;\n\treturn String(val);\n}\n\n// ============================================================================\n// OBJECT OPERATORS\n// ============================================================================\n\nfunction evalObjectToArray(operand, doc) {\n\tconst obj = evaluateExpression(operand, doc);\n\tif (typeof obj !== 'object' || obj === null || Array.isArray(obj)) {\n\t\treturn null;\n\t}\n\t\n\treturn Object.keys(obj).map(key => ({ k: key, v: obj[key] }));\n}\n\nfunction evalArrayToObject(operand, doc) {\n\tconst arr = evaluateExpression(operand, doc);\n\tif (!Array.isArray(arr)) return null;\n\t\n\tconst result = {};\n\tfor (const item of arr) {\n\t\tif (Array.isArray(item) && item.length === 2) {\n\t\t\tresult[item[0]] = item[1];\n\t\t} else if (typeof item === 'object' && item.k !== undefined && item.v !== undefined) {\n\t\t\tresult[item.k] = item.v;\n\t\t}\n\t}\n\treturn result;\n}\n\nfunction evalMergeObjects(operands, doc) {\n\tif (!Array.isArray(operands)) {\n\t\t// Single object\n\t\treturn evaluateExpression(operands, doc);\n\t}\n\t\n\tconst result = {};\n\tfor (const operand of operands) {\n\t\tconst obj = evaluateExpression(operand, doc);\n\t\tif (typeof obj === 'object' && obj !== null && !Array.isArray(obj)) {\n\t\t\tObject.assign(result, obj);\n\t\t}\n\t}\n\treturn result;\n}\n","import { EventEmitter } from 'events';\nimport { matches } from './queryMatcher.js';\n\n/**\n * ChangeStream watches for changes in collections and emits change events\n * Compatible with MongoDB Change Streams API\n */\nexport class ChangeStream extends EventEmitter {\n\tconstructor(target, pipeline = [], options = {}) {\n\t\tsuper();\n\t\t\n\t\tthis.target = target; // MongoClient, DB, or Collection\n\t\tthis.pipeline = pipeline;\n\t\tthis.options = options;\n\t\tthis.closed = false;\n\t\tthis._listeners = new Map();\n\t\tthis._changeCounter = 0;\n\t\t\n\t\t// Start watching immediately (synchronously)\n\t\tthis._startWatching();\n\t}\n\n\t/**\n\t * Start watching for changes\n\t * @private\n\t */\n\t_startWatching() {\n\t\tif (this.closed) return;\n\t\t\n\t\tconst collections = this._getCollectionsToWatch();\n\t\t\n\t\tfor (const collection of collections) {\n\t\t\tthis._watchCollection(collection);\n\t\t}\n\t\t\n\t\t// For DB watching, we also need to intercept new collection creation\n\t\tif (this.target.constructor.name === 'DB') {\n\t\t\tthis._interceptDBCollectionCreation();\n\t\t}\n\t\t\n\t\t// For MongoClient watching, intercept db() calls\n\t\tif (this.target.constructor.name === 'MongoClient') {\n\t\t\tthis._interceptClientDBCreation();\n\t\t}\n\t}\n\n\t/**\n\t * Get collections to watch based on target type\n\t * @private\n\t */\n\t_getCollectionsToWatch() {\n\t\tconst collections = [];\n\t\t\n\t\t// MongoClient - watch all collections in all databases\n\t\tif (this.target.constructor.name === 'MongoClient') {\n\t\t\t// Store reference to monitor for new databases/collections\n\t\t\tthis._monitorClient();\n\t\t\treturn collections;\n\t\t}\n\t\t\n\t\t// DB - watch all collections in the database\n\t\tif (this.target.constructor.name === 'DB') {\n\t\t\tconst collectionNames = this.target.getCollectionNames();\n\t\t\tfor (const name of collectionNames) {\n\t\t\t\tconst collection = this.target[name];\n\t\t\t\tif (collection && collection.isCollection) {\n\t\t\t\t\tcollections.push(collection);\n\t\t\t\t}\n\t\t\t}\n\t\t\t// Also monitor for new collections\n\t\t\tthis._monitorDB();\n\t\t}\n\t\t\n\t\t// Collection - watch specific collection\n\t\tif (this.target.isCollection) {\n\t\t\tcollections.push(this.target);\n\t\t}\n\t\t\n\t\treturn collections;\n\t}\n\n\t/**\n\t * Watch a specific collection for changes\n\t * @private\n\t */\n\t_watchCollection(collection) {\n\t\tif (this.closed) return;\n\t\tif (!collection) return; // Skip null/undefined\n\t\tif (typeof collection.on !== 'function') return; // Skip non-EventEmitters\n\t\tif (!collection.isCollection) return; // Skip non-collections\n\t\tif (this._listeners.has(collection)) return; // Already watching\n\t\t\n\t\tconst handlers = {\n\t\t\tinsert: (doc) => this._emitChange('insert', collection, doc),\n\t\t\tupdate: (doc, updateDescription) => this._emitChange('update', collection, doc, updateDescription),\n\t\t\treplace: (doc) => this._emitChange('replace', collection, doc),\n\t\t\tdelete: (doc) => this._emitChange('delete', collection, doc)\n\t\t};\n\t\t\n\t\t// Store handlers for cleanup\n\t\tthis._listeners.set(collection, handlers);\n\t\t\n\t\t// Listen to collection change events\n\t\tcollection.on('insert', handlers.insert);\n\t\tcollection.on('update', handlers.update);\n\t\tcollection.on('replace', handlers.replace);\n\t\tcollection.on('delete', handlers.delete);\n\t}\n\n\t/**\n\t * Emit a change event\n\t * @private\n\t */\n\t_emitChange(operationType, collection, doc, updateDescription = null) {\n\t\tif (this.closed) return;\n\t\t\n\t\tconst changeEvent = this._createChangeEvent(\n\t\t\toperationType,\n\t\t\tcollection,\n\t\t\tdoc,\n\t\t\tupdateDescription\n\t\t);\n\t\t\n\t\t// Apply pipeline filters if any\n\t\tif (!this._matchesPipeline(changeEvent)) {\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tthis.emit('change', changeEvent);\n\t}\n\n\t/**\n\t * Create a MongoDB-compatible change event document\n\t * @private\n\t */\n\t_createChangeEvent(operationType, collection, doc, updateDescription) {\n\t\tconst event = {\n\t\t\t_id: {\n\t\t\t\t_data: Buffer.from(String(++this._changeCounter)).toString('base64')\n\t\t\t},\n\t\t\toperationType,\n\t\t\tclusterTime: new Date(),\n\t\t\tns: {\n\t\t\t\tdb: collection.db.dbName,\n\t\t\t\tcoll: collection.name\n\t\t\t},\n\t\t\tdocumentKey: {\n\t\t\t\t_id: doc._id\n\t\t\t}\n\t\t};\n\t\t\n\t\tswitch (operationType) {\n\t\t\tcase 'insert':\n\t\t\t\tevent.fullDocument = doc;\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\tcase 'update':\n\t\t\t\tevent.updateDescription = updateDescription || {\n\t\t\t\t\tupdatedFields: {},\n\t\t\t\t\tremovedFields: [],\n\t\t\t\t\ttruncatedArrays: []\n\t\t\t\t};\n\t\t\t\t// Include full document if requested\n\t\t\t\tif (this.options.fullDocument === 'updateLookup') {\n\t\t\t\t\tevent.fullDocument = doc;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\tcase 'replace':\n\t\t\t\tevent.fullDocument = doc;\n\t\t\t\tbreak;\n\t\t\t\t\n\t\t\tcase 'delete':\n\t\t\t\t// For delete, doc contains the deleted document's _id\n\t\t\t\tbreak;\n\t\t}\n\t\t\n\t\treturn event;\n\t}\n\n\t/**\n\t * Check if change event matches pipeline filters\n\t * @private\n\t */\n\t_matchesPipeline(changeEvent) {\n\t\tif (!this.pipeline || this.pipeline.length === 0) {\n\t\t\treturn true;\n\t\t}\n\t\t\n\t\t// Process pipeline stages\n\t\tfor (const stage of this.pipeline) {\n\t\t\tif (stage.$match) {\n\t\t\t\t// Use the same query matcher as find()\n\t\t\t\t// Note: matches(document, query) - document first, query second\n\t\t\t\tif (!matches(changeEvent, stage.$match)) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t\n\t\treturn true;\n\t}\n\n\t/**\n\t * Get nested value from object using dot notation\n\t * @private\n\t */\n\t_getNestedValue(obj, path) {\n\t\treturn path.split('.').reduce((current, part) => current?.[part], obj);\n\t}\n\n\t/**\n\t * Monitor client for new databases/collections (simplified)\n\t * @private\n\t */\n\t_monitorClient() {\n\t\t// Handled by _interceptClientDBCreation\n\t}\n\n\t/**\n\t * Intercept DB creation on a MongoClient\n\t * @private\n\t */\n\t_interceptClientDBCreation() {\n\t\tconst client = this.target;\n\t\tconst originalDb = client.db.bind(client);\n\t\tconst self = this;\n\t\t\n\t\t// Track databases we're watching\n\t\tthis._watchedDBs = new Map();\n\t\t\n\t\t// Override db() method to watch new databases\n\t\tclient.db = function(name, opts) {\n\t\t\tconst database = originalDb(name, opts);\n\t\t\tconst dbName = database.dbName;\n\t\t\t\n\t\t\t// Only set up watch once per database\n\t\t\tif (!self._watchedDBs.has(dbName)) {\n\t\t\t\tself._watchedDBs.set(dbName, database);\n\t\t\t\t\n\t\t\t\t// Watch existing collections in this database\n\t\t\t\tconst collectionNames = database.getCollectionNames();\n\t\t\t\tfor (const colName of collectionNames) {\n\t\t\t\t\tconst col = database[colName];\n\t\t\t\t\tif (col && col.isCollection && !self._listeners.has(col)) {\n\t\t\t\t\t\tself._watchCollection(col);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t// Intercept new collection creation on this database\n\t\t\t\tself._interceptDBCollectionCreationForClient(database);\n\t\t\t}\n\t\t\t\n\t\t\treturn database;\n\t\t};\n\t\t\n\t\t// Store original for cleanup\n\t\tthis._originalClientMethods = { db: originalDb };\n\t}\n\n\t/**\n\t * Intercept collection creation for a database in client watch mode\n\t * @private\n\t */\n\t_interceptDBCollectionCreationForClient(db) {\n\t\tconst originalCollection = db.collection.bind(db);\n\t\tconst originalCreateCollection = db.createCollection.bind(db);\n\t\tconst self = this;\n\t\t\n\t\tdb.collection = function(name) {\n\t\t\tconst col = originalCollection(name);\n\t\t\tif (col && col.isCollection && !self._listeners.has(col)) {\n\t\t\t\tself._watchCollection(col);\n\t\t\t}\n\t\t\treturn col;\n\t\t};\n\t\t\n\t\tdb.createCollection = function(name) {\n\t\t\toriginalCreateCollection(name);\n\t\t\tconst col = db[name];\n\t\t\tif (col && col.isCollection && !self._listeners.has(col)) {\n\t\t\t\tself._watchCollection(col);\n\t\t\t}\n\t\t};\n\t}\n\n\t/**\n\t * Monitor database for new collections\n\t * @private\n\t */\n\t_monitorDB() {\n\t\t// Handled by _interceptDBCollectionCreation\n\t}\n\n\t/**\n\t * Intercept new collection creation on a DB\n\t * @private\n\t */\n\t_interceptDBCollectionCreation() {\n\t\tconst db = this.target;\n\t\tconst originalCollection = db.collection.bind(db);\n\t\tconst originalCreateCollection = db.createCollection.bind(db);\n\t\tconst self = this;\n\t\t\n\t\t// Override collection() method to watch new collections\n\t\tdb.collection = function(name) {\n\t\t\tconst col = originalCollection(name);\n\t\t\t// Watch this collection if we haven't already\n\t\t\tif (col && col.isCollection && !self._listeners.has(col)) {\n\t\t\t\tself._watchCollection(col);\n\t\t\t}\n\t\t\treturn col;\n\t\t};\n\t\t\n\t\t// Override createCollection() method\n\t\tdb.createCollection = function(name) {\n\t\t\toriginalCreateCollection(name);\n\t\t\tconst col = db[name];\n\t\t\tif (col && col.isCollection && !self._listeners.has(col)) {\n\t\t\t\tself._watchCollection(col);\n\t\t\t}\n\t\t};\n\t\t\n\t\t// Store originals for cleanup\n\t\tthis._originalDBMethods = { collection: originalCollection, createCollection: originalCreateCollection };\n\t}\n\n\t/**\n\t * Close the change stream\n\t */\n\tclose() {\n\t\tif (this.closed) return;\n\t\t\n\t\tthis.closed = true;\n\t\t\n\t\t// Remove all collection listeners\n\t\tfor (const [collection, handlers] of this._listeners) {\n\t\t\tcollection.off('insert', handlers.insert);\n\t\t\tcollection.off('update', handlers.update);\n\t\t\tcollection.off('replace', handlers.replace);\n\t\t\tcollection.off('delete', handlers.delete);\n\t\t}\n\t\t\n\t\tthis._listeners.clear();\n\t\t\n\t\t// Restore original DB methods if we intercepted them\n\t\tif (this._originalDBMethods && this.target.constructor.name === 'DB') {\n\t\t\tthis.target.collection = this._originalDBMethods.collection;\n\t\t\tthis.target.createCollection = this._originalDBMethods.createCollection;\n\t\t}\n\t\t\n\t\t// Restore original MongoClient methods if we intercepted them\n\t\tif (this._originalClientMethods && this.target.constructor.name === 'MongoClient') {\n\t\t\tthis.target.db = this._originalClientMethods.db;\n\t\t}\n\t\t\n\t\t// Emit close before removing all listeners\n\t\tthis.emit('close');\n\t\tthis.removeAllListeners();\n\t}\n\n\t/**\n\t * Check if the stream is closed\n\t */\n\tget isClosed() {\n\t\treturn this.closed;\n\t}\n\n\t/**\n\t * Async iterator support for for-await-of loops\n\t */\n\tasync *[Symbol.asyncIterator]() {\n\t\tconst queue = [];\n\t\tlet resolveNext = null;\n\t\tlet streamClosed = false;\n\t\t\n\t\tconst onChange = (change) => {\n\t\t\tif (resolveNext) {\n\t\t\t\tresolveNext({ value: change, done: false });\n\t\t\t\tresolveNext = null;\n\t\t\t} else {\n\t\t\t\tqueue.push(change);\n\t\t\t}\n\t\t};\n\t\t\n\t\tconst onClose = () => {\n\t\t\tstreamClosed = true;\n\t\t\tif (resolveNext) {\n\t\t\t\tresolveNext({ done: true });\n\t\t\t\tresolveNext = null;\n\t\t\t}\n\t\t};\n\t\t\n\t\tconst onError = (error) => {\n\t\t\tif (resolveNext) {\n\t\t\t\tresolveNext(Promise.reject(error));\n\t\t\t\tresolveNext = null;\n\t\t\t}\n\t\t};\n\t\t\n\t\tthis.on('change', onChange);\n\t\tthis.on('close', onClose);\n\t\tthis.on('error', onError);\n\t\t\n\t\ttry {\n\t\t\twhile (!streamClosed) {\n\t\t\t\tif (queue.length > 0) {\n\t\t\t\t\tyield queue.shift();\n\t\t\t\t} else {\n\t\t\t\t\tconst next = await new Promise((resolve) => {\n\t\t\t\t\t\tresolveNext = resolve;\n\t\t\t\t\t\t// Check if stream was closed while waiting\n\t\t\t\t\t\tif (streamClosed) {\n\t\t\t\t\t\t\tresolve({ done: true });\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t\t\n\t\t\t\t\tif (next.done) break;\n\t\t\t\t\tyield next.value;\n\t\t\t\t}\n\t\t\t}\n\t\t} finally {\n\t\t\tthis.off('change', onChange);\n\t\t\tthis.off('close', onClose);\n\t\t\tthis.off('error', onError);\n\t\t}\n\t}\n\n\t/**\n\t * Get next change (for compatibility)\n\t */\n\tasync next() {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst onChange = (change) => {\n\t\t\t\tcleanup();\n\t\t\t\tresolve(change);\n\t\t\t};\n\t\t\t\n\t\t\tconst onClose = () => {\n\t\t\t\tcleanup();\n\t\t\t\tresolve(null);\n\t\t\t};\n\t\t\t\n\t\t\tconst onError = (error) => {\n\t\t\t\tcleanup();\n\t\t\t\treject(error);\n\t\t\t};\n\t\t\t\n\t\t\tconst cleanup = () => {\n\t\t\t\tthis.off('change', onChange);\n\t\t\t\tthis.off('close', onClose);\n\t\t\t\tthis.off('error', onError);\n\t\t\t};\n\t\t\t\n\t\t\tif (this.closed) {\n\t\t\t\tresolve(null);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t\n\t\t\tthis.once('change', onChange);\n\t\t\tthis.once('close', onClose);\n\t\t\tthis.once('error', onError);\n\t\t});\n\t}\n}\n","import { EventEmitter } from 'events';\nimport { Cursor } from './Cursor.js';\nimport { SortedCursor } from './SortedCursor.js';\nimport { isArray, getProp, applyProjection, copy } from './utils.js';\nimport { matches } from './queryMatcher.js';\nimport { applyUpdates, createDocFromUpdate } from './updates.js';\nimport { RegularCollectionIndex } from './RegularCollectionIndex.js';\nimport { TextCollectionIndex } from './TextCollectionIndex.js';\nimport { GeospatialCollectionIndex } from './GeospatialCollectionIndex.js';\nimport { QueryPlanner } from './QueryPlanner.js';\nimport { evaluateExpression } from './aggregationExpressions.js';\nimport { ChangeStream } from './ChangeStream.js';\n\n/**\n * Collection class\n */\nexport class Collection extends EventEmitter {\n\tconstructor(db, name, storage, idGenerator) {\n\t\tsuper();\n\t\tthis.db = db;\n\t\tthis.name = name;\n\t\tthis.storage = storage;\n\t\tthis.idGenerator = idGenerator;\n\t\tthis.indexes = new Map(); // Index storage - map of index name to index structure\n\t\tthis.queryPlanner = new QueryPlanner(this.indexes); // Query planner\n\t\tthis.isCollection = true; // TODO used by dropDatabase, ugly\n\n\t\t// Load existing indexes from storage\n\t\tfor (const [indexName, indexStore] of this.storage.indexes) {\n\t\t\tlet index;\n\t\t\tif (indexStore.getMeta('type') === 'text') {\n\t\t\t\tindex = new TextCollectionIndex(indexName, indexStore.getMeta('keys'), indexStore);\n\t\t\t} else if (indexStore.getMeta('type') === 'geospatial') {\n\t\t\t\tindex = new GeospatialCollectionIndex(indexName, indexStore.getMeta('keys'), indexStore);\n\t\t\t} else if (indexStore.getMeta('type') === 'regular') {\n\t\t\t\t// Default to regular index\n\t\t\t\tindex = new RegularCollectionIndex(indexName, indexStore.getMeta('keys'), indexStore);\n\t\t\t}\n\t\t\tif (index) {\n\t\t\t\tthis.indexes.set(index.name, index);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Generate index name from keys\n\t */\n\tgenerateIndexName(keys) {\n\t\tconst parts = [];\n\t\tfor (const field in keys) {\n\t\t\tif (keys.hasOwnProperty(field)) {\n\t\t\t\tparts.push(field + '_' + keys[field]);\n\t\t\t}\n\t\t}\n\t\treturn parts.join('_');\n\t}\n\n\t/**\n\t * Determine if keys specify a text index\n\t */\n\tisTextIndex(keys) {\n\t\tfor (const field in keys) {\n\t\t\tif (keys[field] === 'text') {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\t/**\n\t * Determine if keys specify a geospatial index\n\t */\n\tisGeospatialIndex(keys) {\n\t\tfor (const field in keys) {\n\t\t\tif (keys[field] === '2dsphere' || keys[field] === '2d') {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\t/**\n\t * Build/rebuild an index\n\t */\n\tbuildIndex(indexName, keys, options = {}) {\n\t\tlet index;\n\t\t\n\t\t// Create appropriate index type\n\t\tif (this.isTextIndex(keys)) {\n\t\t\tconst meta = { type: 'text', keys };\n\t\t\tindex = new TextCollectionIndex(indexName, keys, this.storage.createIndexStore(indexName, meta), options);\n\t\t} else if (this.isGeospatialIndex(keys)) {\n\t\t\tconst meta = { type: 'geospatial', keys };\n\t\t\tindex = new GeospatialCollectionIndex(indexName, keys, this.storage.createIndexStore(indexName, meta), options);\n\t\t} else {\n\t\t\tconst meta = { type: 'regular', keys };\n\t\t\tindex = new RegularCollectionIndex(indexName, keys, this.storage.createIndexStore(indexName, meta), options);\n\t\t}\n\n\t\t// Build index by scanning all documents\n\t\tconst allDocs = this.storage.getAllDocuments();\n\t\tfor (const doc of allDocs) {\n\t\t\tif (doc) {\n\t\t\t\tindex.add(doc);\n\t\t\t}\n\t\t}\n\n\t\tthis.indexes.set(indexName, index);\n\t\treturn index;\n\t}\n\n\t/**\n\t * Update indexes when a document is inserted\n\t */\n\tupdateIndexesOnInsert(doc) {\n\t\tfor (const [indexName, index] of this.indexes) {\n\t\t\tindex.add(doc);\n\t\t}\n\t}\n\n\t/**\n\t * Update indexes when a document is deleted\n\t */\n\tupdateIndexesOnDelete(doc) {\n\t\tfor (const [indexName, index] of this.indexes) {\n\t\t\tindex.remove(doc);\n\t\t}\n\t}\n\n\t/**\n\t * Query planner - analyze query and determine optimal execution plan\n\t */\n\tplanQuery(query) {\n\t\tconst plan = this.queryPlanner.plan(query);\n\t\tconst docIds = this.queryPlanner.execute(plan);\n\t\t\n\t\treturn {\n\t\t\tuseIndex: plan.type !== 'full_scan',\n\t\t\tplanType: plan.type,\n\t\t\tindexNames: plan.indexes,\n\t\t\tdocIds: docIds,\n\t\t\testimatedCost: plan.estimatedCost,\n\t\t\tindexOnly: plan.indexOnly || false\n\t\t};\n\t}\n\n\t/**\n\t * Get a text index for the given field\n\t * @param {string} field - The field name\n\t * @returns {TextCollectionIndex|null} The text index or null if not found\n\t */\n\tgetTextIndex(field) {\n\t\tfor (const [indexName, index] of this.indexes) {\n\t\t\tif (index instanceof TextCollectionIndex) {\n\t\t\t\t// Check if this field is indexed\n\t\t\t\tif (index.indexedFields.includes(field)) {\n\t\t\t\t\treturn index;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n\n\t// Collection methods\n\taggregate(pipeline) {\n\t\tif (!pipeline || !isArray(pipeline)) {\n\t\t\tthrow { $err: \"Pipeline must be an array\", code: 17287 };\n\t\t}\n\n\t\t// Start with all documents\n\t\tlet results = [];\n\t\tconst cursor = this.find({});\n\t\twhile (cursor.hasNext()) {\n\t\t\tresults.push(cursor.next());\n\t\t}\n\n\t\t// Process each stage in the pipeline\n\t\tfor (let i = 0; i < pipeline.length; i++) {\n\t\t\tconst stage = pipeline[i];\n\t\t\tconst stageKeys = Object.keys(stage);\n\t\t\tif (stageKeys.length !== 1) {\n\t\t\t\tthrow { $err: \"Each pipeline stage must have exactly one key\", code: 17287 };\n\t\t\t}\n\t\t\tconst stageType = stageKeys[0];\n\t\t\tconst stageSpec = stage[stageType];\n\n\t\t\tif (stageType === \"$match\") {\n\t\t\t\t// Filter documents based on query\n\t\t\t\tconst matched = [];\n\t\t\t\tfor (let j = 0; j < results.length; j++) {\n\t\t\t\t\tif (matches(results[j], stageSpec)) {\n\t\t\t\t\t\tmatched.push(results[j]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tresults = matched;\n\t\t\t} else if (stageType === \"$project\") {\n\t\t\t\t// Reshape documents with expression support\n\t\t\t\tconst projected = [];\n\t\t\t\tfor (let j = 0; j < results.length; j++) {\n\t\t\t\t\tprojected.push(applyProjectionWithExpressions(stageSpec, results[j]));\n\t\t\t\t}\n\t\t\t\tresults = projected;\n\t\t\t} else if (stageType === \"$addFields\" || stageType === \"$set\") {\n\t\t\t\t// Add/set fields with computed expressions\n\t\t\t\tconst modified = [];\n\t\t\t\tfor (let j = 0; j < results.length; j++) {\n\t\t\t\t\tconst doc = copy(results[j]);\n\t\t\t\t\tfor (const field in stageSpec) {\n\t\t\t\t\t\tconst expr = stageSpec[field];\n\t\t\t\t\t\tdoc[field] = evaluateExpression(expr, results[j]);\n\t\t\t\t\t}\n\t\t\t\t\tmodified.push(doc);\n\t\t\t\t}\n\t\t\t\tresults = modified;\n\t\t\t} else if (stageType === \"$unset\") {\n\t\t\t\t// Remove fields from documents\n\t\t\t\tconst modified = [];\n\t\t\t\t// $unset can be a string (single field), array of strings, or object\n\t\t\t\tlet fieldsToRemove = [];\n\t\t\t\tif (typeof stageSpec === 'string') {\n\t\t\t\t\tfieldsToRemove = [stageSpec];\n\t\t\t\t} else if (Array.isArray(stageSpec)) {\n\t\t\t\t\tfieldsToRemove = stageSpec;\n\t\t\t\t} else if (typeof stageSpec === 'object') {\n\t\t\t\t\t// Object form: { field1: \"\", field2: \"\" } or { field1: 1, field2: 1 }\n\t\t\t\t\tfieldsToRemove = Object.keys(stageSpec);\n\t\t\t\t}\n\n\t\t\t\tfor (let j = 0; j < results.length; j++) {\n\t\t\t\t\tconst doc = copy(results[j]);\n\t\t\t\t\tfor (let k = 0; k < fieldsToRemove.length; k++) {\n\t\t\t\t\t\tconst field = fieldsToRemove[k];\n\t\t\t\t\t\t// Support dot notation for nested field removal\n\t\t\t\t\t\tconst pathParts = field.split('.');\n\t\t\t\t\t\tif (pathParts.length === 1) {\n\t\t\t\t\t\t\tdelete doc[field];\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Navigate to parent and delete nested field\n\t\t\t\t\t\t\tlet parent = doc;\n\t\t\t\t\t\t\tfor (let m = 0; m < pathParts.length - 1; m++) {\n\t\t\t\t\t\t\t\tif (parent == undefined || parent == null) break;\n\t\t\t\t\t\t\t\tparent = parent[pathParts[m]];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (parent != undefined && parent != null) {\n\t\t\t\t\t\t\t\tdelete parent[pathParts[pathParts.length - 1]];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tmodified.push(doc);\n\t\t\t\t}\n\t\t\t\tresults = modified;\n\t\t\t} else if (stageType === \"$sort\") {\n\t\t\t\t// Sort documents\n\t\t\t\tconst sortKeys = Object.keys(stageSpec);\n\t\t\t\tresults.sort(function (a, b) {\n\t\t\t\t\tfor (let k = 0; k < sortKeys.length; k++) {\n\t\t\t\t\t\tconst key = sortKeys[k];\n\t\t\t\t\t\tif (a[key] === undefined && b[key] !== undefined) return -1 * stageSpec[key];\n\t\t\t\t\t\tif (a[key] !== undefined && b[key] === undefined) return 1 * stageSpec[key];\n\t\t\t\t\t\tif (a[key] < b[key]) return -1 * stageSpec[key];\n\t\t\t\t\t\tif (a[key] > b[key]) return 1 * stageSpec[key];\n\t\t\t\t\t}\n\t\t\t\t\treturn 0;\n\t\t\t\t});\n\t\t\t} else if (stageType === \"$limit\") {\n\t\t\t\t// Limit number of documents\n\t\t\t\tresults = results.slice(0, stageSpec);\n\t\t\t} else if (stageType === \"$skip\") {\n\t\t\t\t// Skip documents\n\t\t\t\tresults = results.slice(stageSpec);\n\t\t\t} else if (stageType === \"$group\") {\n\t\t\t\t// Group documents\n\t\t\t\tconst groups = {};\n\t\t\t\tconst groupId = stageSpec._id;\n\n\t\t\t\tfor (let j = 0; j < results.length; j++) {\n\t\t\t\t\tconst doc = results[j];\n\t\t\t\t\tlet key;\n\n\t\t\t\t\t// Compute group key using expression evaluator\n\t\t\t\t\tif (groupId === null || groupId === undefined) {\n\t\t\t\t\t\tkey = null;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tkey = evaluateExpression(groupId, doc);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst keyStr = JSON.stringify(key);\n\n\t\t\t\t\t// Initialize group\n\t\t\t\t\tif (!groups[keyStr]) {\n\t\t\t\t\t\tgroups[keyStr] = {\n\t\t\t\t\t\t\t_id: key,\n\t\t\t\t\t\t\tdocs: [],\n\t\t\t\t\t\t\taccumulators: {}\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\n\t\t\t\t\tgroups[keyStr].docs.push(doc);\n\t\t\t\t}\n\n\t\t\t\t// Apply accumulators\n\t\t\t\tconst grouped = [];\n\t\t\t\tfor (const groupKey in groups) {\n\t\t\t\t\tconst group = groups[groupKey];\n\t\t\t\t\tconst result = { _id: group._id };\n\n\t\t\t\t\t// Process each accumulator field\n\t\t\t\t\tfor (const field in stageSpec) {\n\t\t\t\t\t\tif (field === '_id') continue;\n\n\t\t\t\t\t\tconst accumulator = stageSpec[field];\n\t\t\t\t\t\tconst accKeys = Object.keys(accumulator);\n\t\t\t\t\t\tif (accKeys.length !== 1) continue;\n\n\t\t\t\t\t\tconst accType = accKeys[0];\n\t\t\t\t\t\tconst accExpr = accumulator[accType];\n\n\t\t\t\t\t\tif (accType === '$sum') {\n\t\t\t\t\t\t\tlet sum = 0;\n\t\t\t\t\t\t\tfor (let k = 0; k < group.docs.length; k++) {\n\t\t\t\t\t\t\t\tconst val = evaluateExpression(accExpr, group.docs[k]);\n\t\t\t\t\t\t\t\tif (typeof val === 'number') {\n\t\t\t\t\t\t\t\t\tsum += val;\n\t\t\t\t\t\t\t\t} else if (val !== null && val !== undefined) {\n\t\t\t\t\t\t\t\t\tsum += Number(val) || 0;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tresult[field] = sum;\n\t\t\t\t\t\t} else if (accType === '$avg') {\n\t\t\t\t\t\t\tlet sum = 0;\n\t\t\t\t\t\t\tlet count = 0;\n\t\t\t\t\t\t\tfor (let k = 0; k < group.docs.length; k++) {\n\t\t\t\t\t\t\t\tconst val = evaluateExpression(accExpr, group.docs[k]);\n\t\t\t\t\t\t\t\tif (val !== undefined && val !== null) {\n\t\t\t\t\t\t\t\t\tsum += Number(val) || 0;\n\t\t\t\t\t\t\t\t\tcount++;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tresult[field] = count > 0 ? sum / count : 0;\n\t\t\t\t\t\t} else if (accType === '$min') {\n\t\t\t\t\t\t\tlet min = undefined;\n\t\t\t\t\t\t\tfor (let k = 0; k < group.docs.length; k++) {\n\t\t\t\t\t\t\t\tconst val = evaluateExpression(accExpr, group.docs[k]);\n\t\t\t\t\t\t\t\tif (val !== undefined && (min === undefined || val < min)) {\n\t\t\t\t\t\t\t\t\tmin = val;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tresult[field] = min;\n\t\t\t\t\t\t} else if (accType === '$max') {\n\t\t\t\t\t\t\tlet max = undefined;\n\t\t\t\t\t\t\tfor (let k = 0; k < group.docs.length; k++) {\n\t\t\t\t\t\t\t\tconst val = evaluateExpression(accExpr, group.docs[k]);\n\t\t\t\t\t\t\t\tif (val !== undefined && (max === undefined || val > max)) {\n\t\t\t\t\t\t\t\t\tmax = val;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tresult[field] = max;\n\t\t\t\t\t\t} else if (accType === '$push') {\n\t\t\t\t\t\t\tconst arr = [];\n\t\t\t\t\t\t\tfor (let k = 0; k < group.docs.length; k++) {\n\t\t\t\t\t\t\t\tconst val = evaluateExpression(accExpr, group.docs[k]);\n\t\t\t\t\t\t\t\tarr.push(val);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tresult[field] = arr;\n\t\t\t\t\t\t} else if (accType === '$addToSet') {\n\t\t\t\t\t\t\tconst set = {};\n\t\t\t\t\t\t\tfor (let k = 0; k < group.docs.length; k++) {\n\t\t\t\t\t\t\t\tconst val = evaluateExpression(accExpr, group.docs[k]);\n\t\t\t\t\t\t\t\tset[JSON.stringify(val)] = val;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tconst arr = [];\n\t\t\t\t\t\t\tfor (const valKey in set) {\n\t\t\t\t\t\t\t\tarr.push(set[valKey]);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tresult[field] = arr;\n\t\t\t\t\t\t} else if (accType === '$first') {\n\t\t\t\t\t\t\tif (group.docs.length > 0) {\n\t\t\t\t\t\t\t\tresult[field] = evaluateExpression(accExpr, group.docs[0]);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (accType === '$last') {\n\t\t\t\t\t\t\tif (group.docs.length > 0) {\n\t\t\t\t\t\t\t\tresult[field] = evaluateExpression(accExpr, group.docs[group.docs.length - 1]);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (accType === '$stdDevPop') {\n\t\t\t\t\t\t\t// Population standard deviation\n\t\t\t\t\t\t\tconst values = [];\n\t\t\t\t\t\t\tfor (let k = 0; k < group.docs.length; k++) {\n\t\t\t\t\t\t\t\tconst val = evaluateExpression(accExpr, group.docs[k]);\n\t\t\t\t\t\t\t\tif (typeof val === 'number') {\n\t\t\t\t\t\t\t\t\tvalues.push(val);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (values.length > 0) {\n\t\t\t\t\t\t\t\tconst mean = values.reduce((a, b) => a + b, 0) / values.length;\n\t\t\t\t\t\t\t\tconst variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;\n\t\t\t\t\t\t\t\tresult[field] = Math.sqrt(variance);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tresult[field] = 0;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (accType === '$stdDevSamp') {\n\t\t\t\t\t\t\t// Sample standard deviation\n\t\t\t\t\t\t\tconst values = [];\n\t\t\t\t\t\t\tfor (let k = 0; k < group.docs.length; k++) {\n\t\t\t\t\t\t\t\tconst val = evaluateExpression(accExpr, group.docs[k]);\n\t\t\t\t\t\t\t\tif (typeof val === 'number') {\n\t\t\t\t\t\t\t\t\tvalues.push(val);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (values.length > 1) {\n\t\t\t\t\t\t\t\tconst mean = values.reduce((a, b) => a + b, 0) / values.length;\n\t\t\t\t\t\t\t\tconst variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / (values.length - 1);\n\t\t\t\t\t\t\t\tresult[field] = Math.sqrt(variance);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tresult[field] = 0;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (accType === '$mergeObjects') {\n\t\t\t\t\t\t\t// Merge objects from all documents in group\n\t\t\t\t\t\t\tconst merged = {};\n\t\t\t\t\t\t\tfor (let k = 0; k < group.docs.length; k++) {\n\t\t\t\t\t\t\t\tconst val = evaluateExpression(accExpr, group.docs[k]);\n\t\t\t\t\t\t\t\tif (typeof val === 'object' && val !== null && !Array.isArray(val)) {\n\t\t\t\t\t\t\t\t\tObject.assign(merged, val);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tresult[field] = merged;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tgrouped.push(result);\n\t\t\t\t}\n\t\t\t\tresults = grouped;\n\t\t\t} else if (stageType === \"$count\") {\n\t\t\t\t// Count documents and return single document with count\n\t\t\t\tresults = [{ [stageSpec]: results.length }];\n\t\t\t} else if (stageType === \"$unwind\") {\n\t\t\t\t// Unwind array field\n\t\t\t\tconst unwound = [];\n\t\t\t\tlet fieldPath = stageSpec;\n\t\t\t\tif (typeof fieldPath === 'string' && fieldPath.charAt(0) === '$') {\n\t\t\t\t\tfieldPath = fieldPath.substring(1);\n\t\t\t\t}\n\n\t\t\t\tfor (let j = 0; j < results.length; j++) {\n\t\t\t\t\tconst doc = results[j];\n\t\t\t\t\tconst arr = getProp(doc, fieldPath);\n\n\t\t\t\t\tif (arr && isArray(arr) && arr.length > 0) {\n\t\t\t\t\t\tfor (let k = 0; k < arr.length; k++) {\n\t\t\t\t\t\t\tconst unwoundDoc = copy(doc);\n\t\t\t\t\t\t\t// Set the unwound value\n\t\t\t\t\t\t\tconst parts = fieldPath.split('.');\n\t\t\t\t\t\t\tlet target = unwoundDoc;\n\t\t\t\t\t\t\tfor (let l = 0; l < parts.length - 1; l++) {\n\t\t\t\t\t\t\t\tif (!target[parts[l]]) {\n\t\t\t\t\t\t\t\t\ttarget[parts[l]] = {};\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\ttarget = target[parts[l]];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\ttarget[parts[parts.length - 1]] = arr[k];\n\t\t\t\t\t\t\tunwound.push(unwoundDoc);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t// MongoDB's default behavior: skip documents where field is missing, null, empty array, or not an array\n\t\t\t\t}\n\t\t\t\tresults = unwound;\n\t\t\t} else {\n\t\t\t\tthrow { $err: \"Unsupported aggregation stage: \" + stageType, code: 17287 };\n\t\t\t}\n\t\t}\n\n\t\treturn results;\n\t}\n\n\tbulkWrite() { throw \"Not Implemented\"; }\n\n\tasync count() {\n\t\treturn this.storage.size();\n\t}\n\n\tasync copyTo(destCollectionName) {\n\t\tif (!this.db[destCollectionName]) {\n\t\t\tthis.db.createCollection(destCollectionName);\n\t\t}\n\t\tconst destCol = this.db[destCollectionName];\n\t\tlet numCopied = 0;\n\t\tconst c = this.find({});\n\t\twhile (c.hasNext()) {\n\t\t\tawait destCol.insertOne(c.next());\n\t\t\tnumCopied++;\n\t\t}\n\t\treturn numCopied;\n\t}\n\n\tasync createIndex(keys, options) {\n\t\t// MongoDB-compliant createIndex\n\t\t// keys: { fieldName: 1 } for ascending, { fieldName: -1 } for descending, { fieldName: 'text' } for text\n\t\t// options: { name: \"indexName\", unique: true, ... }\n\n\t\tif (!keys || typeof keys !== 'object' || Array.isArray(keys)) {\n\t\t\tthrow { $err: \"createIndex requires a key specification object\", code: 2 };\n\t\t}\n\n\t\tconst indexName = (options && options.name) ? options.name : this.generateIndexName(keys);\n\n\t\t// Check if index already exists\n\t\tif (this.indexes.has(indexName)) {\n\t\t\t// MongoDB checks for key specification conflicts\n\t\t\tconst existingIndex = this.indexes.get(indexName);\n\t\t\tconst existingKeys = JSON.stringify(existingIndex.keys);\n\t\t\tconst newKeys = JSON.stringify(keys);\n\t\t\tif (existingKeys !== newKeys) {\n\t\t\t\tthrow { $err: \"Index with name '\" + indexName + \"' already exists with a different key specification\", code: 85 };\n\t\t\t}\n\t\t\t// Same index, return without error\n\t\t\treturn indexName;\n\t\t}\n\n\t\t// Build the index\n\t\tthis.buildIndex(indexName, keys, options);\n\n\t\treturn indexName;\n\t}\n\n\tdataSize() { throw \"Not Implemented\"; }\n\n\tasync deleteOne(query) {\n\t\tconst doc = await this.findOne(query);\n\t\tif (doc) {\n\t\t\tthis.updateIndexesOnDelete(doc);\n\t\t\tthis.storage.remove(doc._id.toString());\n\t\t\tthis.emit('delete', { _id: doc._id });\n\t\t\treturn { deletedCount: 1 };\n\t\t} else {\n\t\t\treturn { deletedCount: 0 };\n\t\t}\n\t}\n\n\tasync deleteMany(query) {\n\t\tconst c = this.find(query);\n\t\tconst ids = [];\n\t\tconst docs = [];\n\t\twhile (c.hasNext()) {\n\t\t\tconst doc = c.next();\n\t\t\tids.push(doc._id);\n\t\t\tdocs.push(doc);\n\t\t}\n\t\tconst deletedCount = ids.length;\n\t\tfor (let i = 0; i < ids.length; i++) {\n\t\t\tthis.updateIndexesOnDelete(docs[i]);\n\t\t\tthis.storage.remove(ids[i].toString());\n\t\t\tthis.emit('delete', { _id: ids[i] });\n\t\t}\n\t\treturn { deletedCount: deletedCount };\n\t}\n\n\tasync distinct(field, query) {\n\t\tconst vals = {};\n\t\tconst c = this.find(query);\n\t\twhile (c.hasNext()) {\n\t\t\tconst d = c.next();\n\t\t\tif (d[field]) {\n\t\t\t\tvals[d[field]] = true;\n\t\t\t}\n\t\t}\n\t\treturn Object.keys(vals);\n\t}\n\n\tdrop() {\n\t\t// Clear all indexes\n\t\tfor (const [indexName, index] of this.indexes) {\n\t\t\tindex.clear();\n\t\t}\n\t\tthis.storage.clear();\n\t}\n\n\tdropIndex(indexName) {\n\t\tif (!this.indexes.has(indexName)) {\n\t\t\tthrow { $err: \"Index not found with name: \" + indexName, code: 27 };\n\t\t}\n\t\tthis.indexes.get(indexName).clear();\n\t\tthis.indexes.delete(indexName);\n\t\treturn { nIndexesWas: this.indexes.size + 1, ok: 1 };\n\t}\n\n\tdropIndexes() {\n\t\tconst count = this.indexes.size;\n\t\tfor (const [indexName, index] of this.indexes) {\n\t\t\tindex.clear();\n\t\t}\n\t\tthis.indexes.clear();\n\t\treturn { nIndexesWas: count, msg: \"non-_id indexes dropped\", ok: 1 };\n\t}\n\tensureIndex() { throw \"Not Implemented\"; }\n\texplain() { throw \"Not Implemented\"; }\n\n\tfind(query, projection) {\n\t\tconst normalizedQuery = query == undefined ? {} : query;\n\t\t\n\t\t// Get query plan\n\t\tconst queryPlan = this.planQuery(normalizedQuery);\n\t\tconst documents = [];\n\t\tconst seen = {}; // Track which docs we've seen to avoid duplicates\n\t\t\n\t\t// If using index, get documents by ID\n\t\tif (queryPlan.useIndex && queryPlan.docIds) {\n\t\t\tfor (const docId of queryPlan.docIds) {\n\t\t\t\tconst doc = this.storage.get(docId.toString());\n\t\t\t\tif (doc && matches(doc, normalizedQuery)) {\n\t\t\t\t\tseen[doc._id] = true;\n\t\t\t\t\tdocuments.push(doc);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t\n\t\t// If not index-only query, do full scan for remaining documents\n\t\t// This handles complex queries where index only partially matches\n\t\tif (!queryPlan.indexOnly) {\n\t\t\tconst allDocs = this.storage.getAllDocuments();\n\t\t\tfor (const doc of allDocs) {\n\t\t\t\tif (!seen[doc._id] && matches(doc, normalizedQuery)) {\n\t\t\t\t\tseen[doc._id] = true;\n\t\t\t\t\tdocuments.push(doc);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t\n\t\treturn new Cursor(\n\t\t\tthis,\n\t\t\tnormalizedQuery,\n\t\t\tprojection,\n\t\t\tdocuments,\n\t\t\tSortedCursor\n\t\t);\n\t}\n\n\tfindAndModify() { throw \"Not Implemented\"; }\n\n\tasync findOne(query, projection) {\n\t\tconst cursor = this.find(query, projection);\n\t\tif (cursor.hasNext()) {\n\t\t\treturn cursor.next();\n\t\t} else {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tasync findOneAndDelete(filter, options) {\n\t\tlet c = this.find(filter);\n\t\tif (options && options.sort) c = c.sort(options.sort);\n\t\tif (!c.hasNext()) return null;\n\t\tconst doc = c.next();\n\t\tthis.storage.remove(doc._id.toString());\n\t\tif (options && options.projection) return applyProjection(options.projection, doc);\n\t\telse return doc;\n\t}\n\n\tasync findOneAndReplace(filter, replacement, options) {\n\t\tlet c = this.find(filter);\n\t\tif (options && options.sort) c = c.sort(options.sort);\n\t\tif (!c.hasNext()) return null;\n\t\tconst doc = c.next();\n\t\treplacement._id = doc._id;\n\t\tthis.storage.set(doc._id.toString(), replacement);\n\t\tif (options && options.returnNewDocument) {\n\t\t\tif (options && options.projection) return applyProjection(options.projection, replacement);\n\t\t\telse return replacement;\n\t\t} else {\n\t\t\tif (options && options.projection) return applyProjection(options.projection, doc);\n\t\t\telse return doc;\n\t\t}\n\t}\n\n\tasync findOneAndUpdate(filter, update, options) {\n\t\tlet c = this.find(filter);\n\t\tif (options && options.sort) c = c.sort(options.sort);\n\t\tif (!c.hasNext()) return null;\n\t\tconst doc = c.next();\n\t\tconst clone = Object.assign({}, doc);\n\t\tapplyUpdates(update, clone);\n\t\tthis.storage.set(doc._id.toString(), clone);\n\t\tif (options && options.returnNewDocument) {\n\t\t\tif (options && options.projection) return applyProjection(options.projection, clone);\n\t\t\telse return clone;\n\t\t} else {\n\t\t\tif (options && options.projection) return applyProjection(options.projection, doc);\n\t\t\telse return doc;\n\t\t}\n\t}\n\n\tgetIndexes() {\n\t\t// Return array of index specifications\n\t\tconst result = [];\n\t\tfor (const [indexName, index] of this.indexes) {\n\t\t\tresult.push(index.getSpec());\n\t\t}\n\t\treturn result;\n\t}\n\n\tgetShardDistribution() { throw \"Not Implemented\"; }\n\tgetShardVersion() { throw \"Not Implemented\"; }\n\n\t// non-mongo\n\tgetStore() {\n\t\treturn this.storage.getStore();\n\t}\n\n\tgroup() { throw \"Not Implemented\"; }\n\n\tasync insert(doc) {\n\t\tif (Array == doc.constructor) {\n\t\t\treturn await this.insertMany(doc);\n\t\t} else {\n\t\t\treturn await this.insertOne(doc);\n\t\t}\n\t}\n\n\tasync insertOne(doc) {\n\t\tif (doc._id == undefined) doc._id = this.idGenerator();\n\t\tthis.storage.set(doc._id.toString(), doc);\n\t\tthis.updateIndexesOnInsert(doc);\n\t\tthis.emit('insert', doc);\n\t\treturn { insertedId: doc._id };\n\t}\n\n\tasync insertMany(docs) {\n\t\tconst insertedIds = [];\n\t\tfor (let i = 0; i < docs.length; i++) {\n\t\t\tconst result = await this.insertOne(docs[i]);\n\t\t\tinsertedIds.push(result.insertedId);\n\t\t}\n\t\treturn { insertedIds: insertedIds };\n\t}\n\n\tisCapped() { throw \"Not Implemented\"; }\n\tmapReduce() { throw \"Not Implemented\"; }\n\treIndex() { throw \"Not Implemented\"; }\n\n\tasync replaceOne(query, replacement, options) { // only replace\n\t\t// first\n\t\tconst result = {};\n\t\tconst c = this.find(query);\n\t\tresult.matchedCount = c.count();\n\t\tif (result.matchedCount == 0) {\n\t\t\tresult.modifiedCount = 0;\n\t\t\tif (options && options.upsert) {\n\t\t\t\tconst newDoc = replacement;\n\t\t\t\tnewDoc._id = this.idGenerator();\n\t\t\t\tthis.storage.set(newDoc._id.toString(), newDoc);\n\t\t\t\tthis.updateIndexesOnInsert(newDoc);\n\t\t\t\tthis.emit('insert', newDoc);\n\t\t\t\tresult.upsertedId = newDoc._id;\n\t\t\t}\n\t\t} else {\n\t\t\tresult.modifiedCount = 1;\n\t\t\tconst doc = c.next();\n\t\t\tthis.updateIndexesOnDelete(doc);\n\t\t\treplacement._id = doc._id;\n\t\t\tthis.storage.set(doc._id.toString(), replacement);\n\t\t\tthis.updateIndexesOnInsert(replacement);\n\t\t\tthis.emit('replace', replacement);\n\t\t}\n\t\treturn result;\n\t}\n\n\tremove(query, options) {\n\t\tconst c = this.find(query);\n\t\tif (!c.hasNext()) return;\n\t\tif (options === true || (options && options.justOne)) {\n\t\t\tconst doc = c.next();\n\t\t\tthis.updateIndexesOnDelete(doc);\n\t\t\tthis.storage.remove(doc._id.toString());\n\t\t} else {\n\t\t\twhile (c.hasNext()) {\n\t\t\t\tconst doc = c.next();\n\t\t\t\tthis.updateIndexesOnDelete(doc);\n\t\t\t\tthis.storage.remove(doc._id.toString());\n\t\t\t}\n\t\t}\n\t}\n\n\trenameCollection() { throw \"Not Implemented\"; }\n\tsave() { throw \"Not Implemented\"; }\n\tstats() { throw \"Not Implemented\"; }\n\tstorageSize() { throw \"Not Implemented\"; }\n\ttotalSize() { throw \"Not Implemented\"; }\n\ttotalIndexSize() { throw \"Not Implemented\"; }\n\n\tupdate(query, updates, options) {\n\t\tconst c = this.find(query);\n\t\tif (c.hasNext()) {\n\t\t\tif (options && options.multi) {\n\t\t\t\twhile (c.hasNext()) {\n\t\t\t\t\tconst doc = c.next();\n\t\t\t\t\tthis.updateIndexesOnDelete(doc);\n\t\t\t\t\tapplyUpdates(updates, doc);\n\t\t\t\t\tthis.storage.set(doc._id.toString(), doc);\n\t\t\t\t\tthis.updateIndexesOnInsert(doc);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tconst doc = c.next();\n\t\t\t\tthis.updateIndexesOnDelete(doc);\n\t\t\t\tapplyUpdates(updates, doc);\n\t\t\t\tthis.storage.set(doc._id.toString(), doc);\n\t\t\t\tthis.updateIndexesOnInsert(doc);\n\t\t\t}\n\t\t} else {\n\t\t\tif (options && options.upsert) {\n\t\t\t\tconst newDoc = createDocFromUpdate(query, updates, this.idGenerator);\n\t\t\t\tthis.storage.set(newDoc._id.toString(), newDoc);\n\t\t\t\tthis.updateIndexesOnInsert(newDoc);\n\t\t\t}\n\t\t}\n\t}\n\n\tasync updateOne(query, updates, options) {\n\t\tconst c = this.find(query);\n\t\tif (c.hasNext()) {\n\t\t\tconst doc = c.next();\n\t\t\tconst originalDoc = JSON.parse(JSON.stringify(doc));\n\t\t\tthis.updateIndexesOnDelete(doc);\n\t\t\tapplyUpdates(updates, doc);\n\t\t\tthis.storage.set(doc._id.toString(), doc);\n\t\t\tthis.updateIndexesOnInsert(doc);\n\t\t\tconst updateDescription = this._getUpdateDescription(originalDoc, doc);\n\t\t\tthis.emit('update', doc, updateDescription);\n\t\t} else {\n\t\t\tif (options && options.upsert) {\n\t\t\t\tconst newDoc = createDocFromUpdate(query, updates, this.idGenerator);\n\t\t\t\tthis.storage.set(newDoc._id.toString(), newDoc);\n\t\t\t\tthis.updateIndexesOnInsert(newDoc);\n\t\t\t\tthis.emit('insert', newDoc);\n\t\t\t}\n\t\t}\n\t}\n\n\tasync updateMany(query, updates, options) {\n\t\tconst c = this.find(query);\n\t\tif (c.hasNext()) {\n\t\t\twhile (c.hasNext()) {\n\t\t\t\tconst doc = c.next();\n\t\t\t\tconst originalDoc = JSON.parse(JSON.stringify(doc));\n\t\t\t\tthis.updateIndexesOnDelete(doc);\n\t\t\t\tapplyUpdates(updates, doc);\n\t\t\t\tthis.storage.set(doc._id.toString(), doc);\n\t\t\t\tthis.updateIndexesOnInsert(doc);\n\t\t\t\tconst updateDescription = this._getUpdateDescription(originalDoc, doc);\n\t\t\t\tthis.emit('update', doc, updateDescription);\n\t\t\t}\n\t\t} else {\n\t\t\tif (options && options.upsert) {\n\t\t\t\tconst newDoc = createDocFromUpdate(query, updates, this.idGenerator);\n\t\t\t\tthis.storage.set(newDoc._id.toString(), newDoc);\n\t\t\t\tthis.updateIndexesOnInsert(newDoc);\n\t\t\t\tthis.emit('insert', newDoc);\n\t\t\t}\n\t\t}\n\t}\n\n\tvalidate() { throw \"Not Implemented\"; }\n\n\t/**\n\t * Generate updateDescription for change events\n\t * Compares original and updated documents to track changes\n\t */\n\t_getUpdateDescription(originalDoc, updatedDoc) {\n\t\tconst updatedFields = {};\n\t\tconst removedFields = [];\n\n\t\t// Find updated and new fields\n\t\tfor (const key in updatedDoc) {\n\t\t\tif (key === '_id') continue;\n\t\t\tif (JSON.stringify(originalDoc[key]) !== JSON.stringify(updatedDoc[key])) {\n\t\t\t\tupdatedFields[key] = updatedDoc[key];\n\t\t\t}\n\t\t}\n\n\t\t// Find removed fields\n\t\tfor (const key in originalDoc) {\n\t\t\tif (key === '_id') continue;\n\t\t\tif (!(key in updatedDoc)) {\n\t\t\t\tremovedFields.push(key);\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tupdatedFields,\n\t\t\tremovedFields,\n\t\t\ttruncatedArrays: [] // Not implemented in micro-mongo\n\t\t};\n\t}\n\n\t/**\n\t * Watch for changes to this collection\n\t * @param {Array} pipeline - Aggregation pipeline to filter changes\n\t * @param {Object} options - Watch options (fullDocument, etc.)\n\t * @returns {ChangeStream} A change stream instance\n\t */\n\twatch(pipeline = [], options = {}) {\n\t\treturn new ChangeStream(this, pipeline, options);\n\t}\n\n}\n\n/**\n * Apply projection with expression support\n * Enhanced version of applyProjection that supports computed expressions\n */\nfunction applyProjectionWithExpressions(projection, doc) {\n\tconst result = {};\n\tconst keys = Object.keys(projection);\n\t\n\t// Check if this is an inclusion or exclusion projection\n\tlet isInclusion = false;\n\tlet isExclusion = false;\n\tlet hasComputedFields = false;\n\t\n\tfor (const key of keys) {\n\t\tif (key === '_id') continue;\n\t\tconst value = projection[key];\n\t\t\n\t\tif (value === 1 || value === true) {\n\t\t\tisInclusion = true;\n\t\t} else if (value === 0 || value === false) {\n\t\t\tisExclusion = true;\n\t\t} else {\n\t\t\t// Computed field (expression)\n\t\t\thasComputedFields = true;\n\t\t}\n\t}\n\t\n\t// Handle computed fields - they imply inclusion mode\n\tif (hasComputedFields || isInclusion) {\n\t\t// Inclusion mode: only include specified fields\n\t\t// Always include _id unless explicitly excluded\n\t\tif (projection._id !== 0 && projection._id !== false) {\n\t\t\tresult._id = doc._id;\n\t\t}\n\t\t\n\t\tfor (const key of keys) {\n\t\t\tconst value = projection[key];\n\t\t\t\n\t\t\tif (key === '_id') {\n\t\t\t\tif (value === 0 || value === false) {\n\t\t\t\t\tdelete result._id;\n\t\t\t\t}\n\t\t\t} else if (value === 1 || value === true) {\n\t\t\t\t// Simple field inclusion\n\t\t\t\tresult[key] = getProp(doc, key);\n\t\t\t} else {\n\t\t\t\t// Computed field (expression)\n\t\t\t\tresult[key] = evaluateExpression(value, doc);\n\t\t\t}\n\t\t}\n\t} else {\n\t\t// Exclusion mode: include all fields except specified ones\n\t\tfor (const key in doc) {\n\t\t\tif (doc.hasOwnProperty(key)) {\n\t\t\t\tresult[key] = doc[key];\n\t\t\t}\n\t\t}\n\t\t\n\t\tfor (const key of keys) {\n\t\t\tif (projection[key] === 0 || projection[key] === false) {\n\t\t\t\tdelete result[key];\n\t\t\t}\n\t\t}\n\t}\n\t\n\treturn result;\n}\n","/**\n * DocumentStore - In-memory document storage for collections\n * Simple key-value store using a plain JavaScript object\n */\nexport class DocumentStore {\n\tconstructor() {\n\t\tthis.data = new Map();\n\t}\n\n\tclear() {\n\t\tthis.data = new Map();\n\t}\n\n  keys() {\n    return this.data.keys();\n  }\n\n\tget(index) {\n\t\treturn this.data.get(index);\n\t}\n\n\tremove(key) {\n\t\tthis.data.delete(key);\n\t}\n\n\tset(key, value) {\n\t\tthis.data.set(key, value);\n\t}\n\n\tsize() {\n\t\treturn this.data.size;\n\t}\n}\n","import { DocumentStore } from './DocumentStore.js';\nimport { IndexStore } from './IndexStore.js';\n\n/**\n * CollectionStore - Unified storage for collection documents and indexes\n * \n * Provides:\n * - Document storage (via DocumentStore)\n * - Index data storage (plain objects for each index)\n * - Unified interface for Collection to manage all its data\n */\nexport class CollectionStore {\n\tconstructor() {\n\n\t\t// Document storage - uses DocumentStore for document CRUD operations\n\t\tthis.documents = new DocumentStore();\n\t\t\n\t\t// Index storage - plain object to store index data\n\t\t// Structure: { indexName: indexDataObject }\n\t\tthis.indexes = new Map();\n\t}\n\n\t/**\n\t * Clear all documents and indexes\n\t */\n\tclear() {\n\t\tthis.documents.clear();\n    this.indexes.clear();\n\t}\n\n  /**\n   * Get all document keys\n   * @returns {[string]} Array of document keys\n   */\n  documentKeys() {\n    return this.documents.keys();\n  }\n\n\t/**\n\t * Get all documents as an array\n\t * @returns {Array} Array of all documents\n\t */\n\tgetAllDocuments() {\n\t\treturn Array.from(this.documents.data.values());\n\t}\n\n\t/**\n\t * Get document by ID\n\t * @param {string} docId - Document ID\n\t * @returns {Object|undefined} Document or undefined\n\t */\n\tget(key) {\n    if (typeof key !== 'string') throw new Error(\"Document key must be a string\");\n\t\treturn this.documents.get(key);\n\t}\n\n\t/**\n\t * \n\t */\n\tset(key, value) {\n    if (typeof key !== 'string') throw new Error(\"Document key must be a string\");\n    this.documents.set(key, value);\n\t}\n\n\t/**\n\t * \n\t */\n\tremove(key) {\n    if (typeof key !== 'string') throw new Error(\"Document key must be a string\");\n\t\tthis.documents.remove(key);\n\t}\n\n\t/**\n\t *\n\t */\n\tsize() {\n\t\treturn this.documents.size();\n\t}\n\n\t/**\n\t * Get entire document store (for export/save)\n\t * @returns {Object} Document store object\n\t */\n\tgetStore() {\n\t\tconst store = {};\n\t\tfor (const key of this.documents.keys()) {\n\t\t\tstore[key] = this.documents.get(key);\n\t\t}\n\t\treturn store;\n\t}\n\n\t// ==========================================\n\t// Index Storage Interface\n\t// ==========================================\n\n  indexesCount() {\n    return this.indexes.size;\n  }\n\n  indexKeys() {\n    return this.indexes.keys();\n  }\n\n\t/**\n\t * Get index data for a specific index\n\t * @param {string} indexName - Name of the index\n\t * @returns {Object} Index data object (or creates empty one if doesn't exist)\n\t */\n\tcreateIndexStore(name,meta) {\n\t\tif (!this.indexes.has(name)) {\n\t\t\tthis.indexes.set(name, new IndexStore(meta));\n\t\t}\n\t\treturn this.indexes.get(name);\n\t}\n\n}\n","import { CollectionStore } from './CollectionStore.js';\n\n/**\n * In-memory storage engine (default)\n */\nexport class StorageEngine {\n\tconstructor() {\n\t\tthis.collections = new Map();\n\t}\n\n  collectionsCount() {\n    return this.collections.size;\n  }\n  \n  /**\n   * \n   * @returns {[string]} list of collection names\n   */\n  collectionStoreKeys() {\n    return this.collections.keys();\n  }\n\n  /**\n   * \n   * @param {*} collectionName \n   * @returns \n   */\n  getCollectionStore(collectionName) {\n    return this.collections.get(collectionName);\n  }\n\n\t/**\n\t * Create a collection's state\n\t * @param {string} collectionName - The collection name\n\t * @returns {CollectionStore} The collection store\n\t */\n\tcreateCollectionStore(collectionName) {\n    if (this.collections.has(collectionName)) {\n      return this.collections.get(collectionName);\n    }\n    const collectionStore = new CollectionStore();\n    this.collections.set(collectionName, collectionStore);\n    return collectionStore;\n  }\n\n\t/**\n\t * Delete a collection\n\t * @param {string} collectionName - The collection name\n\t */\n\tremoveCollectionStore(collectionName) {\n    this.collections.delete(collectionName);\n\t}\n\n\t/**\n\t * Save the entire database state\n\t * @returns {Promise<void>}\n\t */\n\tsave() {\n\t\t// In-memory storage does not persist data\n\t}\n\n}\n","import { Collection } from './Collection.js';\nimport { StorageEngine } from './StorageEngine.js';\nimport { ObjectId } from './ObjectId.js';\nimport { ChangeStream } from './ChangeStream.js';\n\n/**\n * DB class\n */\nexport class DB {\n\tconstructor(options) {\n\t\tthis.options = options || {};\n\t\tthis.dbName = this.options.dbName || 'default';\n\t\t\t\n\t\t// StorageEngine\n\t\tthis.storageEngine = this.options.storageEngine || new StorageEngine();\n\n\t\t// Load existing collections from storage engine\n\t\tthis._loadExistingCollections();\n\n\t\t// Return a Proxy to enable dynamic collection creation\n\t\treturn new Proxy(this, {\n\t\t\tget(target, property, receiver) {\n\t\t\t\t// If property exists on target (including undefined values), return it\n\t\t\t\tif (property in target) {\n\t\t\t\t\treturn Reflect.get(target, property, receiver);\n\t\t\t\t}\n\n\t\t\t\t// If property is a symbol or special property, return undefined\n\t\t\t\tif (typeof property === 'symbol' || property.startsWith('_')) {\n\t\t\t\t\treturn undefined;\n\t\t\t\t}\n\n        // For collection names, create the collection if it doesn't exist\n        // Only auto-create if it's a valid collection name and doesn't already exist\n        if (typeof property === 'string') {\n          // Don't auto-create if property was explicitly deleted\n          if (Object.prototype.hasOwnProperty.call(target, property)) {\n            return target[property];\n          }\n          // Auto-create the collection\n          target.createCollection(property);\n          return target[property];\n        }\n        return undefined;\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n\t * Log function\n\t */\n\t_log(msg) {\n\t\tif (this.options && this.options.print) this.options.print(msg);\n\t\telse console.log(msg);\n\t}\n\n\t/**\n\t * ID generator function\n\t */\n\t_id() {\n\t\tif (this.options && this.options.id) return this.options.id();\n\t\telse return new ObjectId();\n\t}\n\n\t/**\n\t * Load existing collections from storage engine\n\t * @private\n\t */\n\t_loadExistingCollections() {\n\t\t// Iterate through all collection stores in the storage engine\n\t\tfor (const collectionName of this.storageEngine.collectionStoreKeys()) {\n\t\t\tconst collectionStore = this.storageEngine.getCollectionStore(collectionName);\n\t\t\t// Create Collection instance for each existing collection\n\t\t\tthis[collectionName] = new Collection(\n\t\t\t\tthis,\n\t\t\t\tcollectionName,\n\t\t\t\tcollectionStore,\n\t\t\t\tthis._id.bind(this)\n\t\t\t);\n\t\t}\n\t}\n\n\t// DB Methods\n\tcloneCollection() { throw \"Not Implemented\"; }\n\tcloneDatabase() { throw \"Not Implemented\"; }\n\tcommandHelp() { throw \"Not Implemented\"; }\n\tcopyDatabase() { throw \"Not Implemented\"; }\n\n\tcreateCollection(name) {\n\t\tif (!name) return;\n\t\tthis[name] = new Collection(\n\t\t\tthis,\n      name,\n\t\t\tthis.storageEngine.createCollectionStore(name),\n\t\t\tthis._id.bind(this)\n\t\t);\n\t}\n\n\t/**\n\t * Get or create a collection by name (MongoDB-compatible method)\n\t * @param {string} name - Collection name\n\t * @returns {Collection} The collection instance\n\t */\n\tcollection(name) {\n\t\tif (!name) throw new Error('Collection name is required');\n\t\t\n\t\t// Return existing collection if it exists\n\t\tif (this[name] && this[name].isCollection) {\n\t\t\treturn this[name];\n\t\t}\n\t\t\n\t\t// Create and return new collection\n\t\tthis.createCollection(name);\n\t\treturn this[name];\n\t}\n\n\tcurrentOp() { throw \"Not Implemented\"; }\n\n\tdropDatabase() {\n\t\t// Get all collection names\n\t\tconst collectionNames = this.getCollectionNames();\n\t\t\n\t\t// Drop each collection\n\t\tfor (const name of collectionNames) {\n\t\t\t// Remove from storage engine\n\t\t\tthis.storageEngine.removeCollectionStore(name);\n\t\t\t// Delete the collection property from DB\n\t\t\tdelete this[name];\n\t\t}\n\t}\n\n\teval() { throw \"Not Implemented\"; }\n\tfsyncLock() { throw \"Not Implemented\"; }\n\tfsyncUnlock() { throw \"Not Implemented\"; }\n\tgetCollection() { throw \"Not Implemented\"; }\n\tgetCollectionInfos() { throw \"Not Implemented\"; }\n\n\tgetCollectionNames() {\n\t\tconst names = [];\n\t\tfor (const key in this) {\n\t\t\tif (this[key] != null && this[key].isCollection) {\n\t\t\t\tnames.push(key);\n\t\t\t}\n\t\t}\n\t\treturn names;\n\t}\n\n\tgetLastError() { throw \"Not Implemented\"; }\n\tgetLastErrorObj() { throw \"Not Implemented\"; }\n\tgetLogComponents() { throw \"Not Implemented\"; }\n\tgetMongo() { throw \"Not Implemented\"; }\n\tgetName() { throw \"Not Implemented\"; }\n\tgetPrevError() { throw \"Not Implemented\"; }\n\tgetProfilingLevel() { throw \"Not Implemented\"; }\n\tgetProfilingStatus() { throw \"Not Implemented\"; }\n\tgetReplicationInfo() { throw \"Not Implemented\"; }\n\tgetSiblingDB() { throw \"Not Implemented\"; }\n\n\thelp() {\n\t\tthis._log(\"        help mr                      mapreduce\");\n\t\tthis._log(\"        db.foo.find()                list objects in collection foo\");\n\t\tthis._log(\"        db.foo.find( { a : 1 } )     list objects in foo where a == 1\");\n\t\tthis._log(\"        it                           result of the last line evaluated; use to further iterate\");\n\t}\n\n\thostInfo() { throw \"Not Implemented\"; }\n\tisMaster() { throw \"Not Implemented\"; }\n\tkillOp() { throw \"Not Implemented\"; }\n\tlistCommands() { throw \"Not Implemented\"; }\n\tloadServerScripts() { throw \"Not Implemented\"; }\n\tlogout() { throw \"Not Implemented\"; }\n\tprintCollectionStats() { throw \"Not Implemented\"; }\n\tprintReplicationInfo() { throw \"Not Implemented\"; }\n\tprintShardingStatus() { throw \"Not Implemented\"; }\n\tprintSlaveReplicationInfo() { throw \"Not Implemented\"; }\n\trepairDatabase() { throw \"Not Implemented\"; }\n\tresetError() { throw \"Not Implemented\"; }\n\trunCommand() { throw \"Not Implemented\"; }\n\tserverBuildInfo() { throw \"Not Implemented\"; }\n\tserverCmdLineOpts() { throw \"Not Implemented\"; }\n\tserverStatus() { throw \"Not Implemented\"; }\n\tsetLogLevel() { throw \"Not Implemented\"; }\n\tsetProfilingLevel() { throw \"Not Implemented\"; }\n\tshutdownServer() { throw \"Not Implemented\"; }\n\tstats() { throw \"Not Implemented\"; }\n\tversion() { throw \"Not Implemented\"; }\n\tupgradeCheck() { throw \"Not Implemented\"; }\n\tupgradeCheckAllDBs() { throw \"Not Implemented\"; }\n\n\t/**\n\t * Watch for changes across all collections in this database\n\t * @param {Array} pipeline - Aggregation pipeline to filter changes\n\t * @param {Object} options - Watch options\n\t * @returns {ChangeStream} A change stream instance\n\t */\n\twatch(pipeline = [], options = {}) {\n\t\treturn new ChangeStream(this, pipeline, options);\n\t}\n}\n","import { EventEmitter } from 'events';\r\nimport { DB } from './DB.js';\r\nimport { ChangeStream } from './ChangeStream.js';\r\n\r\nexport class MongoClient extends EventEmitter {\r\n  constructor(uri = 'mongodb://localhost:27017', options = {}) {\r\n    super();\r\n    this.uri = uri;\r\n    this.options = Object.freeze({ ...options }); // Make immutable\r\n    this._isConnected = false;\r\n    this._defaultDb = this._parseDefaultDbName(uri);\r\n  }\r\n\r\n  static async connect(uri, options = {}) {\r\n    const client = new MongoClient(uri, options);\r\n    await client.connect();\r\n    return client;\r\n  }\r\n\r\n  async connect() {\r\n    if (this._isConnected) return this;\r\n    \r\n    this._isConnected = true;\r\n    this.emit('open', this);\r\n    return this;\r\n  }\r\n\r\n  db(name, opts = {}) {\r\n    // Use default from URI if no name provided\r\n    const dbName = name || this._defaultDb;\r\n    if (!dbName) {\r\n      throw new Error('No database name provided and no default in connection string');\r\n    }\r\n    \r\n    const dbOptions = { ...this.options, ...opts, dbName };\r\n    return new DB(dbOptions);\r\n  }\r\n\r\n  async close(force = false) {\r\n    if (!this._isConnected) return;\r\n    \r\n    this._isConnected = false;\r\n    this.emit('close');\r\n  }\r\n\r\n  // Session management stubs\r\n  startSession(options = {}) {\r\n    // Return minimal session object for compatibility\r\n    return {\r\n      id: crypto.randomUUID(),\r\n      endSession: () => {},\r\n      withTransaction: async (fn) => await fn(this)\r\n    };\r\n  }\r\n\r\n  async withSession(optionsOrExecutor, executor) {\r\n    const session = this.startSession(\r\n      typeof optionsOrExecutor === 'function' ? {} : optionsOrExecutor\r\n    );\r\n    const fn = typeof optionsOrExecutor === 'function' ? optionsOrExecutor : executor;\r\n    \r\n    try {\r\n      return await fn(session);\r\n    } finally {\r\n      session.endSession();\r\n    }\r\n  }\r\n\r\n  // Configuration getters\r\n  get readConcern() { return this.options.readConcern; }\r\n  get writeConcern() { return this.options.writeConcern; }\r\n  get readPreference() { return this.options.readPreference; }\r\n\r\n  /**\r\n   * Watch for changes across all databases and collections\r\n   * @param {Array} pipeline - Aggregation pipeline to filter changes\r\n   * @param {Object} options - Watch options\r\n   * @returns {ChangeStream} A change stream instance\r\n   */\r\n  watch(pipeline = [], options = {}) {\r\n    return new ChangeStream(this, pipeline, options);\r\n  }\r\n\r\n  _parseDefaultDbName(uri) {\r\n    // Parse mongodb://host:port/dbname format\r\n    const match = uri.match(/\\/([^/?]+)/);\r\n    return match ? match[1] : null;\r\n  }\r\n}","import { StorageEngine } from './StorageEngine.js';\n\n/**\n * IndexedDB-based storage engine for persistent storage\n * Stores each collection separately in IndexedDB\n */\nexport class IndexedDbStorageEngine extends StorageEngine {\n\tconstructor(dbName = 'micro-mongo') {\n\t\tsuper();\n\t\tthis.dbName = dbName;\n\t\tthis.db = null;\n\t\tthis.indexedDBName = `micro-mongo-${dbName}`;\n\t}\n\n\t/**\n\t * Initialize the IndexedDB connection\n\t * @returns {Promise<void>}\n\t */\n\tasync initialize() {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst request = indexedDB.open(this.indexedDBName, 1);\n\n\t\t\trequest.onerror = () => {\n\t\t\t\treject(new Error('Failed to open IndexedDB: ' + request.error));\n\t\t\t};\n\n\t\t\trequest.onsuccess = () => {\n\t\t\t\tthis.db = request.result;\n\t\t\t\tresolve();\n\t\t\t};\n\n\t\t\trequest.onupgradeneeded = (event) => {\n\t\t\t\tconst db = event.target.result;\n\t\t\t\t\n\t\t\t\t// Create object stores for collections and metadata\n\t\t\t\tif (!db.objectStoreNames.contains('collections')) {\n\t\t\t\t\tdb.createObjectStore('collections', { keyPath: 'name' });\n\t\t\t\t}\n\t\t\t\tif (!db.objectStoreNames.contains('metadata')) {\n\t\t\t\t\tdb.createObjectStore('metadata', { keyPath: 'key' });\n\t\t\t\t}\n\t\t\t};\n\t\t});\n\t}\n\n\t/**\n\t * Save the entire database state\n\t * @param {Object} dbState - The database state to save\n\t * @returns {Promise<void>}\n\t */\n\tasync saveDatabase(dbState) {\n\t\tif (!this.db) {\n\t\t\tawait this.initialize();\n\t\t}\n\n\t\t// Save metadata\n\t\tconst transaction = this.db.transaction(['metadata'], 'readwrite');\n\t\tconst metadataStore = transaction.objectStore('metadata');\n\t\t\n\t\tawait new Promise((resolve, reject) => {\n\t\t\tconst request = metadataStore.put({\n\t\t\t\tkey: 'dbName',\n\t\t\t\tvalue: dbState.name\n\t\t\t});\n\t\t\trequest.onsuccess = () => resolve();\n\t\t\trequest.onerror = () => reject(request.error);\n\t\t});\n\n\t\t// Save each collection\n\t\tfor (const collectionName in dbState.collections) {\n\t\t\tif (dbState.collections.hasOwnProperty(collectionName)) {\n\t\t\t\tawait this.saveCollection(dbState.name, collectionName, dbState.collections[collectionName]);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Load the entire database state\n\t * @param {string} dbName - The database name\n\t * @returns {Promise<Object|null>} The database state or null if not found\n\t */\n\tasync loadDatabase(dbName) {\n\t\tif (!this.db) {\n\t\t\tawait this.initialize();\n\t\t}\n\n\t\tconst transaction = this.db.transaction(['collections'], 'readonly');\n\t\tconst collectionsStore = transaction.objectStore('collections');\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst request = collectionsStore.getAll();\n\t\t\t\n\t\t\trequest.onsuccess = () => {\n\t\t\t\tconst collections = {};\n\t\t\t\tfor (const collectionData of request.result) {\n\t\t\t\t\tcollections[collectionData.name] = {\n\t\t\t\t\t\tdocuments: collectionData.documents || [],\n\t\t\t\t\t\tindexes: collectionData.indexes || []\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tresolve({\n\t\t\t\t\tname: dbName,\n\t\t\t\t\tcollections: collections\n\t\t\t\t});\n\t\t\t};\n\t\t\t\n\t\t\trequest.onerror = () => reject(request.error);\n\t\t});\n\t}\n\n\t/**\n\t * Save a single collection's state\n\t * @param {string} dbName - The database name\n\t * @param {string} collectionName - The collection name\n\t * @param {Object} collectionState - The collection state to save\n\t * @returns {Promise<void>}\n\t */\n\tasync saveCollection(dbName, collectionName, collectionState) {\n\t\tif (!this.db) {\n\t\t\tawait this.initialize();\n\t\t}\n\n\t\tconst transaction = this.db.transaction(['collections'], 'readwrite');\n\t\tconst collectionsStore = transaction.objectStore('collections');\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst request = collectionsStore.put({\n\t\t\t\tname: collectionName,\n\t\t\t\tdocuments: collectionState.documents || [],\n\t\t\t\tindexes: collectionState.indexes || []\n\t\t\t});\n\t\t\t\n\t\t\trequest.onsuccess = () => resolve();\n\t\t\trequest.onerror = () => reject(request.error);\n\t\t});\n\t}\n\n\t/**\n\t * Load a single collection's state\n\t * @param {string} dbName - The database name\n\t * @param {string} collectionName - The collection name\n\t * @returns {Promise<Object|null>} The collection state or null if not found\n\t */\n\tasync loadCollection(dbName, collectionName) {\n\t\tif (!this.db) {\n\t\t\tawait this.initialize();\n\t\t}\n\n\t\tconst transaction = this.db.transaction(['collections'], 'readonly');\n\t\tconst collectionsStore = transaction.objectStore('collections');\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst request = collectionsStore.get(collectionName);\n\t\t\t\n\t\t\trequest.onsuccess = () => {\n\t\t\t\tif (request.result) {\n\t\t\t\t\tresolve({\n\t\t\t\t\t\tdocuments: request.result.documents || [],\n\t\t\t\t\t\tindexes: request.result.indexes || []\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tresolve(null);\n\t\t\t\t}\n\t\t\t};\n\t\t\t\n\t\t\trequest.onerror = () => reject(request.error);\n\t\t});\n\t}\n\n\t/**\n\t * Delete a collection\n\t * @param {string} dbName - The database name\n\t * @param {string} collectionName - The collection name\n\t * @returns {Promise<void>}\n\t */\n\tasync deleteCollection(dbName, collectionName) {\n\t\tif (!this.db) {\n\t\t\tawait this.initialize();\n\t\t}\n\n\t\tconst transaction = this.db.transaction(['collections'], 'readwrite');\n\t\tconst collectionsStore = transaction.objectStore('collections');\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst request = collectionsStore.delete(collectionName);\n\t\t\trequest.onsuccess = () => resolve();\n\t\t\trequest.onerror = () => reject(request.error);\n\t\t});\n\t}\n\n\t/**\n\t * Delete the entire database\n\t * @param {string} dbName - The database name\n\t * @returns {Promise<void>}\n\t */\n\tasync deleteDatabase(dbName) {\n\t\tif (this.db) {\n\t\t\tthis.db.close();\n\t\t\tthis.db = null;\n\t\t}\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst request = indexedDB.deleteDatabase(this.indexedDBName);\n\t\t\trequest.onsuccess = () => resolve();\n\t\t\trequest.onerror = () => reject(request.error);\n\t\t});\n\t}\n\n\t/**\n\t * Close/cleanup the storage engine\n\t * @returns {Promise<void>}\n\t */\n\tasync close() {\n\t\tif (this.db) {\n\t\t\tthis.db.close();\n\t\t\tthis.db = null;\n\t\t}\n\t}\n}\n"],"names":["ReflectOwnKeys","R","Reflect","ReflectApply","apply","target","receiver","args","Function","prototype","call","ownKeys","Object","getOwnPropertySymbols","getOwnPropertyNames","concat","NumberIsNaN","Number","isNaN","value","EventEmitter","init","this","eventsModule","exports","once","emitter","name","Promise","resolve","reject","errorListener","err","removeListener","resolver","slice","arguments","eventTargetAgnosticAddListener","handler","flags","on","addErrorHandlerIfEventEmitter","_events","_eventsCount","_maxListeners","defaultMaxListeners","checkListener","listener","TypeError","_getMaxListeners","that","_addListener","type","prepend","m","events","existing","warning","create","newListener","emit","unshift","push","length","warned","w","Error","String","count","console","warn","onceWrapper","fired","wrapFn","_onceWrap","state","wrapped","bind","_listeners","unwrap","evlistener","arr","ret","Array","i","unwrapListeners","arrayClone","listenerCount","n","copy","addEventListener","wrapListener","arg","removeEventListener","defineProperty","enumerable","get","set","RangeError","getPrototypeOf","setMaxListeners","getMaxListeners","doError","error","er","message","context","len","listeners","addListener","prependListener","prependOnceListener","list","position","originalListener","shift","index","pop","spliceOne","off","removeAllListeners","key","keys","rawListeners","eventNames","ObjectId","constructor","id","generate","isValid","toLowerCase","toString","toHexString","getTimestamp","timestamp","parseInt","substring","Date","equals","other","toJSON","inspect","test","createFromTime","tsHex","Math","floor","ts","now","rand","crypto","getRandomValues","Uint8Array","tail","random","padEnd","valuesEqual","a","b","o","out","v","isArray","getProp","obj","path","split","result","pathSegment","numericIndex","setProp","current","nextSegment","nextNumeric","lastSegment","lastNumericIndex","isIn","val","values","arrayMatches","x","y","objectMatches","p","hasOwnProperty","applyProjection","projection","doc","hasInclusion","hasExclusion","$err","code","_id","fieldPath","pathParts","parent","j","Cursor","collection","query","documents","SortedCursor","pos","max","batchSize","close","comment","explain","forEach","fn","hasNext","next","effectiveMax","min","hint","itcount","limit","_max","map","results","maxScan","maxTimeMS","noCursorTimeout","objsLeftInBatch","pretty","readConcern","readPref","returnKey","showRecordId","size","skip","num","snapshot","sort","s","tailable","toArray","Symbol","asyncIterator","cursor","sortSpec","items","sortKeys","step2list","ational","tional","enci","anci","izer","bli","alli","entli","eli","ousli","ization","ation","ator","alism","iveness","fulness","ousness","aliti","iviti","biliti","logi","step3list","icate","ative","alize","iciti","ical","ful","ness","vowel","consonants","vowels","gt0","RegExp","eq1","gt1","vowelInStem","consonantLike","sfxLl","sfxE","sfxY","sfxIon","sfxEdOrIng","sfxAtOrBlOrIz","sfxEED","sfxS","sfxSsesOrIes","sfxMultiConsonantLike","step2","step3","step4","stemmer","match","firstCharacterWasLowerCaseY","codePointAt","exec","IndexStore","meta","_meta","Map","_data","entries","setMeta","hasMeta","has","getMeta","hasDataMap","getDataMap","STOPWORDS","Set","TextIndex","storage","documentTerms","documentLengths","_tokenize","text","filter","word","add","docId","words","termFrequency","stem","frequency","remove","term","delete","queryText","options","scored","requireAll","stemmedTerms","uniqueTerms","docSets","termDocs","intersection","from","totalDocs","idf","docsWithTerm","log","docScores","termFreq","tfIdf","score","docTerms","coverage","r","getTermCount","getDocumentCount","clear","compareValues","operator","aVal","bVal","fieldValueMatches","fieldValue","checkFn","prop","textIndex","geoWithin","minLon","maxLat","maxLon","isGeometryWithinBBox","e","geoJson","minLat","features","feature","geometry","coordinates","lng","lat","ring","coord","tlMatches","charAt","and","els","or","not","nor","where","opMatches","newResults","k","getFieldValues","operand","rawValue","arrayFieldValue","found","element","matchesPrimitive","opKeys","op","opValue","matches","sizeFieldValue","el","applyUpdates","updates","setOnInsert","fields","amount","field","currentValue","src","toRemove","notRemoved","removed","l","operation","createDocFromUpdate","idGenerator","newDoc","onlyFields","updateKeys","queryKeys","Index","update","oldDoc","getSpec","serialize","deserialize","data","isNumericString","str","trim","isFinite","BPlusTreeNode","isLeaf","indexStore","nodeCache","children","childId","childData","childNode","nextData","self","Proxy","property","splice","child","BPlusTree","order","minKeys","ceil","_buildTreeFromStorage","root","rootData","search","_searchNode","node","newRoot","_splitChild","_insertNonFull","fullChild","newChild","midIndex","promotedKey","deleteValue","deleted","_deleteValue","_delete","valueIndex","indexOf","_rebalanceAfterDelete","_borrowFromLeft","_borrowFromRight","_merge","leftSibling","rightSibling","leftChild","rightChild","_getFirstLeaf","isEmpty","rangeSearch","minKey","maxKey","getHeight","height","RegularCollectionIndex","super","extractIndexKey","keyFields","keyParts","join","indexKey","indexFields","queryValue","_queryWithOperators","operators","ops","some","includes","hasGt","hasLt","Infinity","rangeResults","keyValue","allEntries","idArray","excludeKey","TextCollectionIndex","indexedFields","_extractText","textParts","searchText","textIndexVersion","weights","_getWeights","haversineDistance","lat1","lng1","lat2","lng2","dLat","PI","dLng","sin","cos","atan2","sqrt","intersects","bbox1","bbox2","maxLng","minLng","area","bbox","union","enlargement","RTreeNode","assign","childTarget","childProp","childValue","updateBBox","RTree","maxEntries","minEntries","_size","insert","entry","_insert","level","_split","_chooseSubtree","splitNode","minEnlargement","minArea","targetNode","enl","ar","maxDist","seed1Idx","seed2Idx","waste","node1","node2","enl1","enl2","searchBBox","_searchBBox","searchRadius","radiusKm","latDelta","lngDelta","radiusToBoundingBox","candidates","_remove","indexInParent","JSON","stringify","getAll","_getAll","GeospatialCollectionIndex","rtree","geoField","_extractCoordinates","sumLat","sumLng","geoValue","coords","geoQuery","$geoWithin","$near","nearQuery","$geometry","maxDistanceKm","$maxDistance","withDistances","dist","_haversineDistance","distance","$nearSphere","$geoIntersects","intersectsQuery","epsilon","_pointInPolygon","inside","xi","yi","xj","yj","QueryPlan","indexes","indexScans","estimatedCost","indexOnly","QueryPlanner","plan","analysis","_analyzeQuery","hasTextSearch","textPlan","_planTextSearch","hasGeoQuery","geoPlan","_planGeoQuery","andPlan","_planAndQuery","orPlan","_planOrQuery","simplePlan","_planSimpleQuery","conditions","$and","condition","subAnalysis","$or","startsWith","indexName","textQuery","_extractTextQuery","docIds","$text","$search","indexableConditions","conditionPlan","scan","reduce","sum","execute","sorted","currentSet","evaluateExpression","expr","item","operands","getTime","evalAdd","val1","val2","evalSubtract","product","evalMultiply","evalDivide","evalMod","base","exponent","pow","evalPow","evalSqrt","abs","evalAbs","evalCeil","evalFloor","trunc","evalTrunc","place","multiplier","round","evalRound","evalConcat","start","substr","evalSubstr","evalToLower","toUpperCase","evalToUpper","input","chars","charsRegex","escapeRegex","replace","evalTrim","evalLtrim","evalRtrim","delimiter","evalSplit","evalStrLenCP","str1","str2","evalStrcasecmp","end","evalIndexOfCP","find","replacement","evalReplaceOne","evalReplaceAll","evalCmp","evalEq","evalNe","evalGt","evalGte","evalLt","evalLte","evalAnd","evalOr","evalNot","ifExpr","thenExpr","elseExpr","if","then","else","evalCond","evalIfNull","branches","branch","case","default","evalSwitch","date","getUTCFullYear","evalYear","getUTCMonth","evalMonth","getUTCDate","evalDayOfMonth","getUTCDay","evalDayOfWeek","UTC","diff","oneDay","evalDayOfYear","getUTCHours","evalHour","getUTCMinutes","evalMinute","getUTCSeconds","evalSecond","getUTCMilliseconds","evalMillisecond","onejan","evalWeek","valueOf","dayNr","setUTCDate","firstThursday","setUTCMonth","evalIsoWeek","evalIsoWeekYear","format","padStart","evalDateToString","evalToDate","idx","evalArrayElemAt","evalConcatArrays","asVar","as","cond","itemDoc","evalFilter","evalIn","evalIndexOfArray","evalIsArray","inExpr","in","evalMap","initialValue","evalReduce","evalSize","evalSlice","reverse","evalReverseArray","inputs","useLongestLength","defaults","arrays","every","maxLength","tuple","evalZip","isInteger","evalType","to","onError","onNull","parseFloat","Boolean","evalConvert","evalToBool","evalToDecimal","evalToDouble","evalToInt","evalToLong","evalToString","evalObjectToArray","evalArrayToObject","evalMergeObjects","evaluateOperator","ChangeStream","pipeline","closed","_changeCounter","_startWatching","collections","_getCollectionsToWatch","_watchCollection","_interceptDBCollectionCreation","_interceptClientDBCreation","_monitorClient","collectionNames","getCollectionNames","isCollection","_monitorDB","handlers","_emitChange","updateDescription","operationType","changeEvent","_createChangeEvent","_matchesPipeline","event","Buffer","clusterTime","ns","db","dbName","coll","documentKey","fullDocument","updatedFields","removedFields","truncatedArrays","stage","$match","_getNestedValue","part","client","originalDb","_watchedDBs","opts","database","colName","col","_interceptDBCollectionCreationForClient","_originalClientMethods","originalCollection","originalCreateCollection","createCollection","_originalDBMethods","isClosed","queue","resolveNext","streamClosed","onChange","change","done","onClose","cleanup","Collection","queryPlanner","generateIndexName","parts","isTextIndex","isGeospatialIndex","buildIndex","createIndexStore","allDocs","getAllDocuments","updateIndexesOnInsert","updateIndexesOnDelete","planQuery","useIndex","planType","indexNames","getTextIndex","aggregate","stageKeys","stageType","stageSpec","matched","projected","applyProjectionWithExpressions","modified","fieldsToRemove","groups","groupId","keyStr","docs","accumulators","grouped","groupKey","group","accumulator","accKeys","accType","accExpr","valKey","mean","variance","merged","unwound","unwoundDoc","bulkWrite","copyTo","destCollectionName","destCol","numCopied","c","insertOne","createIndex","existingIndex","dataSize","deleteOne","findOne","deletedCount","deleteMany","ids","distinct","vals","d","drop","dropIndex","nIndexesWas","ok","dropIndexes","msg","ensureIndex","normalizedQuery","queryPlan","seen","findAndModify","findOneAndDelete","findOneAndReplace","returnNewDocument","findOneAndUpdate","clone","getIndexes","getShardDistribution","getShardVersion","getStore","insertMany","insertedId","insertedIds","isCapped","mapReduce","reIndex","replaceOne","matchedCount","modifiedCount","upsert","upsertedId","justOne","renameCollection","save","stats","storageSize","totalSize","totalIndexSize","multi","updateOne","originalDoc","parse","_getUpdateDescription","updateMany","validate","updatedDoc","watch","isInclusion","hasComputedFields","DocumentStore","CollectionStore","documentKeys","store","indexesCount","indexKeys","StorageEngine","collectionsCount","collectionStoreKeys","getCollectionStore","collectionName","createCollectionStore","collectionStore","removeCollectionStore","DB","storageEngine","_loadExistingCollections","_log","print","cloneCollection","cloneDatabase","commandHelp","copyDatabase","currentOp","dropDatabase","eval","fsyncLock","fsyncUnlock","getCollection","getCollectionInfos","names","getLastError","getLastErrorObj","getLogComponents","getMongo","getName","getPrevError","getProfilingLevel","getProfilingStatus","getReplicationInfo","getSiblingDB","help","hostInfo","isMaster","killOp","listCommands","loadServerScripts","logout","printCollectionStats","printReplicationInfo","printShardingStatus","printSlaveReplicationInfo","repairDatabase","resetError","runCommand","serverBuildInfo","serverCmdLineOpts","serverStatus","setLogLevel","setProfilingLevel","shutdownServer","version","upgradeCheck","upgradeCheckAllDBs","MongoClient","uri","freeze","_isConnected","_defaultDb","_parseDefaultDbName","connect","dbOptions","force","startSession","randomUUID","endSession","withTransaction","async","withSession","optionsOrExecutor","executor","session","writeConcern","readPreference","indexedDBName","initialize","request","indexedDB","open","onerror","onsuccess","onupgradeneeded","objectStoreNames","contains","createObjectStore","keyPath","saveDatabase","dbState","metadataStore","transaction","objectStore","put","saveCollection","loadDatabase","collectionsStore","collectionData","collectionState","loadCollection","deleteCollection","deleteDatabase"],"mappings":"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","x_google_ignoreList":[0,5]}