{"version":3,"file":"micro-mongo-1.1.3.min.js","sources":["../src/ObjectId.js","../src/utils.js","../src/Cursor.js","../src/SortedCursor.js","../node_modules/stemmer/index.js","../src/text-index.js","../src/queryMatcher.js","../src/updates.js","../src/CollectionIndex.js","../src/RegularCollectionIndex.js","../src/TextCollectionIndex.js","../src/rtree.js","../src/GeospatialCollectionIndex.js","../src/Collection.js","../src/DB.js","../src/MongoClient.js","../main.js"],"sourcesContent":["/**\r\n * ObjectId class - MongoDB-compatible 24-character hex string identifier\r\n * Format: 8-char timestamp + 16-char random data\r\n */\r\nexport class ObjectId {\r\n  constructor(id) {\r\n    if (id === undefined || id === null) {\r\n      // Generate new ObjectId\r\n      this.id = ObjectId.generate();\r\n    } else if (typeof id === 'string') {\r\n      // Create from hex string\r\n      if (!ObjectId.isValid(id)) {\r\n        throw new Error(`Argument passed in must be a string of 24 hex characters, got: ${id}`);\r\n      }\r\n      this.id = id.toLowerCase();\r\n    } else if (id instanceof ObjectId) {\r\n      // Copy constructor\r\n      this.id = id.id;\r\n    } else {\r\n      throw new Error(`Argument passed in must be a string of 24 hex characters or an ObjectId`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns the ObjectId as a 24-character hex string\r\n   */\r\n  toString() {\r\n    return this.id;\r\n  }\r\n\r\n  /**\r\n   * Returns the ObjectId as a 24-character hex string (alias for toString)\r\n   */\r\n  toHexString() {\r\n    return this.id;\r\n  }\r\n\r\n  /**\r\n   * Returns the timestamp portion of the ObjectId as a Date\r\n   */\r\n  getTimestamp() {\r\n    const timestamp = parseInt(this.id.substring(0, 8), 16);\r\n    return new Date(timestamp * 1000);\r\n  }\r\n\r\n  /**\r\n   * Compares this ObjectId with another for equality\r\n   */\r\n  equals(other) {\r\n    if (!other) return false;\r\n    \r\n    if (other instanceof ObjectId) {\r\n      return this.id === other.id;\r\n    }\r\n    \r\n    if (typeof other === 'string') {\r\n      return this.id === other.toLowerCase();\r\n    }\r\n    \r\n    // Handle objects with id property\r\n    if (other.id) {\r\n      return this.id === other.id;\r\n    }\r\n    \r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Returns the ObjectId in JSON format (as hex string)\r\n   */\r\n  toJSON() {\r\n    return this.id;\r\n  }\r\n\r\n  /**\r\n   * Custom inspect for Node.js console.log\r\n   */\r\n  inspect() {\r\n    return `ObjectId(\"${this.id}\")`;\r\n  }\r\n\r\n  /**\r\n   * Validates if a string is a valid ObjectId hex string\r\n   */\r\n  static isValid(id) {\r\n    if (!id) return false;\r\n    if (typeof id !== 'string') return false;\r\n    if (id.length !== 24) return false;\r\n    return /^[0-9a-fA-F]{24}$/.test(id);\r\n  }\r\n\r\n  /**\r\n   * Creates an ObjectId from a timestamp\r\n   */\r\n  static createFromTime(timestamp) {\r\n    const ts = Math.floor(timestamp / 1000);\r\n    const tsHex = ('00000000' + ts.toString(16)).slice(-8);\r\n    const tail = '0000000000000000'; // Zero out the random portion\r\n    return new ObjectId(tsHex + tail);\r\n  }\r\n\r\n  /**\r\n   * Generates a new ObjectId hex string\r\n   * Format: 8-char timestamp (4 bytes) + 16-char random data (8 bytes)\r\n   */\r\n  static generate() {\r\n    const ts = Math.floor(Date.now() / 1000);\r\n    \r\n    // Generate 8 random bytes\r\n    const rand = typeof crypto !== 'undefined' && crypto.getRandomValues ? new Uint8Array(8) : null;\r\n    let tail = '';\r\n    \r\n    if (rand) {\r\n      crypto.getRandomValues(rand);\r\n      for (let i = 0; i < rand.length; i++) {\r\n        tail += ('0' + rand[i].toString(16)).slice(-2);\r\n      }\r\n    } else {\r\n      // Fallback for environments without crypto\r\n      // Generate two 8-character hex strings\r\n      tail = Math.random().toString(16).slice(2).padEnd(8, '0').slice(0, 8) +\r\n             Math.random().toString(16).slice(2).padEnd(8, '0').slice(0, 8);\r\n    }\r\n    \r\n    const tsHex = ('00000000' + ts.toString(16)).slice(-8);\r\n    return (tsHex + tail).slice(0, 24);\r\n  }\r\n}","/**\n * Utility functions for MicroMongoDB\n */\n\nimport { ObjectId } from './ObjectId.js';\n\n/**\n * Compare two values for equality, handling ObjectId instances\n */\nfunction valuesEqual(a, b) {\n\t// Handle ObjectId comparison\n\tif (a instanceof ObjectId || b instanceof ObjectId) {\n\t\tif (a instanceof ObjectId && b instanceof ObjectId) {\n\t\t\treturn a.equals(b);\n\t\t}\n\t\tif (a instanceof ObjectId && typeof b === 'string') {\n\t\t\treturn a.equals(b);\n\t\t}\n\t\tif (b instanceof ObjectId && typeof a === 'string') {\n\t\t\treturn b.equals(a);\n\t\t}\n\t\treturn false;\n\t}\n\t\n\t// Regular equality\n\treturn a == b;\n}\n\n/**\n * Deep copy an object or array\n */\nexport function copy(o) {\n\t// Handle ObjectId\n\tif (o instanceof ObjectId) {\n\t\treturn new ObjectId(o.id);\n\t}\n\t\n\tvar out, v, key;\n\tout = Array.isArray(o) ? [] : {};\n\tfor (key in o) {\n\t\tv = o[key];\n\t\tout[key] = (typeof v === \"object\" && v !== null) ? copy(v) : v;\n\t}\n\treturn out;\n}\n\n/**\n * Get a property from an object using dot notation\n */\nexport function getProp(obj, name) {\n\tvar path = name.split(\".\");\n\tvar result = obj[path[0]];\n\tfor (var i = 1; i < path.length; i++) {\n\t\tif (result == undefined || result == null) return result;\n\t\tresult = result[path[i]];\n\t}\n\treturn result;\n}\n\n/**\n * Check if value is an array\n */\nexport function isArray(o) {\n\treturn Array == o.constructor;\n}\n\n/**\n * Convert object to array of key-value pairs\n */\nexport function toArray(obj) {\n\tvar arr = [];\n\tfor (var key in obj) {\n\t\tif (obj.hasOwnProperty(key)) {\n\t\t\tvar el = {};\n\t\t\tel[key] = obj[key];\n\t\t\tarr.push(el);\n\t\t}\n\t}\n\treturn arr;\n}\n\n/**\n * Check if a value is in an array\n */\nexport function isIn(val, values) {\n\tfor (var i = 0; i < values.length; i++) {\n\t\tif (valuesEqual(values[i], val)) return true;\n\t}\n\treturn false;\n}\n\n/**\n * Check if two arrays match\n */\nexport function arrayMatches(x, y) {\n\tif (x.length != y.length) return false;\n\tfor (var i = 0; i < x.length; i++) {\n\t\tif (valuesEqual(x[i], y[i])) continue;\n\t\tif (typeof (x[i]) != typeof (y[i])) return false;\n\t\tif (typeof (x[i]) == \"object\" && x[i] !== null) {\n\t\t\tif (isArray(x[i])) {\n\t\t\t\tif (!arrayMatches(x[i], y[i])) return false;\n\t\t\t} else {\n\t\t\t\tif (!objectMatches(x[i], y[i])) return false;\n\t\t\t}\n\t\t} else {\n\t\t\tif (!valuesEqual(x[i], y[i])) return false;\n\t\t}\n\t}\n\treturn true;\n}\n\n/**\n * Check if two objects match\n */\nexport function objectMatches(x, y) {\n\tfor (var p in x) {\n\t\tif (!x.hasOwnProperty(p)) continue;\n\t\tif (!y.hasOwnProperty(p)) return false;\n\t\tif (valuesEqual(x[p], y[p])) continue;\n\t\tif (typeof (x[p]) != typeof (y[p])) return false;\n\t\tif (typeof (x[p]) == \"object\" && x[p] !== null) {\n\t\t\tif (isArray(x[p])) {\n\t\t\t\tif (!arrayMatches(x[p], y[p])) return false;\n\t\t\t} else {\n\t\t\t\tif (!objectMatches(x[p], y[p])) return false;\n\t\t\t}\n\t\t} else {\n\t\t\tif (!valuesEqual(x[p], y[p])) return false;\n\t\t}\n\t}\n\tfor (var p in y) {\n\t\tif (y.hasOwnProperty(p) && !x.hasOwnProperty(p)) return false;\n\t}\n\treturn true;\n}\n\n/**\n * Apply projection to a document\n */\nexport function applyProjection(projection, doc) {\n\tvar result = {};\n\tvar keys = Object.keys(projection);\n\tif (keys.length == 0) return doc;\n\t\n\t// Check for mixed inclusion/exclusion (except _id which can be excluded in inclusion projection)\n\tvar hasInclusion = false;\n\tvar hasExclusion = false;\n\tfor (var i = 0; i < keys.length; i++) {\n\t\tif (keys[i] === '_id') continue; // _id is special\n\t\tif (projection[keys[i]]) hasInclusion = true;\n\t\telse hasExclusion = true;\n\t}\n\t\n\tif (hasInclusion && hasExclusion) {\n\t\tthrow { $err: \"Can't canonicalize query: BadValue Projection cannot have a mix of inclusion and exclusion.\", code: 17287 };\n\t}\n\t\n\tif (projection[keys[0]] || hasInclusion) {\n\t\t// inclusion with _id (unless explicitly excluded)\n\t\tif (projection._id !== 0) {\n\t\t\tresult._id = doc._id;\n\t\t}\n\t\tfor (var i = 0; i < keys.length; i++) {\n\t\t\tif (keys[i] === '_id') continue;\n\t\t\tif (!projection[keys[i]]) continue;\n\t\t\tresult[keys[i]] = doc[keys[i]];\n\t\t}\n\t} else {\n\t\t// exclusion\n\t\tfor (var key in doc) {\n\t\t\tresult[key] = doc[key];\n\t\t}\n\t\tfor (var i = 0; i < keys.length; i++) {\n\t\t\tif (projection[keys[i]]) continue;\n\t\t\tdelete result[keys[i]];\n\t\t}\n\t}\n\treturn result;\n}\n\n/**\n * Convert bbox to GeoJSON\n */\nexport function bboxToGeojson(bbox) {\n\tconst minLon = bbox[0][0];\n\tconst maxLat = bbox[0][1];\n\tconst maxLon = bbox[1][0];\n\tconst minLat = bbox[1][1];\n\treturn {\n\t\ttype: 'FeatureCollection',\n\t\tfeatures: [{\n\t\t\ttype: 'Feature',\n\t\t\tproperties: {},\n\t\t\tgeometry: {\n\t\t\t\ttype: 'Polygon',\n\t\t\t\tcoordinates: [[\n\t\t\t\t\t[minLon, maxLat],\n\t\t\t\t\t[minLon, minLat],\n\t\t\t\t\t[maxLon, minLat],\n\t\t\t\t\t[maxLon, maxLat],\n\t\t\t\t\t[minLon, maxLat]\n\t\t\t\t]]\n\t\t\t}\n\t\t}]\n\t};\n}\n","import { applyProjection } from './utils.js';\n\n/**\n * Cursor class for iterating over query results\n */\nexport class Cursor {\n\tconstructor(collection, query, projection, matches, storage, indexes, planQuery, SortedCursor) {\n\t\tthis.collection = collection;\n\t\tthis.query = query;\n\t\tthis.projection = projection;\n\t\tthis.matches = matches;\n\t\tthis.storage = storage;\n\t\tthis.indexes = indexes;\n\t\tthis.planQuery = planQuery;\n\t\tthis.SortedCursor = SortedCursor;\n\t\t\n\t\t// Validate projection if provided\n\t\tif (projection && Object.keys(projection).length > 0) {\n\t\t\tconst keys = Object.keys(projection);\n\t\t\tlet hasInclusion = false;\n\t\t\tlet hasExclusion = false;\n\t\t\tfor (let i = 0; i < keys.length; i++) {\n\t\t\t\tif (keys[i] === '_id') continue; // _id is special\n\t\t\t\tif (projection[keys[i]]) hasInclusion = true;\n\t\t\t\telse hasExclusion = true;\n\t\t\t}\n\t\t\t\n\t\t\tif (hasInclusion && hasExclusion) {\n\t\t\t\tthrow { $err: \"Can't canonicalize query: BadValue Projection cannot have a mix of inclusion and exclusion.\", code: 17287 };\n\t\t\t}\n\t\t}\n\t\t\n\t\tthis.pos = 0;\n\t\tthis.max = 0;\n\t\tthis._next = false; // false == unknown, null == no more, !null == next\n\t\t\n\t\t// Query planning - check if we can use an index\n\t\tconst queryPlan = this.planQuery(this.query);\n\t\tthis.indexDocIds = null;\n\t\tthis.indexPos = 0;\n\t\tthis.fullScanDocIds = {}; // Track which docs we've seen to avoid duplicates\n\n\t\t// If using index, get the document IDs from the index\n\t\tif (queryPlan && queryPlan.useIndex) {\n\t\t\tthis.indexDocIds = queryPlan.docIds ? queryPlan.docIds.slice() : [];\n\t\t}\n\t\t\n\t\t// Initialize by finding first document\n\t\tthis._findNext();\n\t}\n\n\t_findNext() {\n\t\t// First, try to get documents from index\n\t\twhile (this.indexDocIds !== null && this.indexPos < this.indexDocIds.length) {\n\t\t\tconst docId = this.indexDocIds[this.indexPos++];\n\t\t\tconst doc = this.storage.getStore()[docId];\n\t\t\tif (doc && this.matches(doc, this.query)) {\n\t\t\t\tthis.fullScanDocIds[doc._id] = true;\n\t\t\t\tthis._next = doc;\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t// If doc doesn't match (shouldn't happen with good index), continue to next\n\t\t}\n\n\t\t// Then fall back to full scan for remaining documents\n\t\t// This handles complex queries where index only partially matches\n\t\twhile (this.pos < this.storage.size() && (this.max == 0 || this.pos < this.max)) {\n\t\t\tconst cur = this.storage.get(this.pos++);\n\t\t\t// Skip docs we already returned from index\n\t\t\tif (cur && !this.fullScanDocIds[cur._id] && this.matches(cur, this.query)) {\n\t\t\t\tthis.fullScanDocIds[cur._id] = true;\n\t\t\t\tthis._next = cur;\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\tthis._next = null;\n\t}\n\n\tbatchSize() { throw \"Not Implemented\"; }\n\tclose() { throw \"Not Implemented\"; }\n\tcomment() { throw \"Not Implemented\"; }\n\t\n\tcount() {\n\t\tlet num = 0;\n\t\tconst c = new Cursor(this.collection, this.query, null, this.matches, this.storage, this.indexes, this.planQuery, this.SortedCursor);\n\t\twhile (c.hasNext()) {\n\t\t\tnum++;\n\t\t\tc.next();\n\t\t}\n\t\treturn num;\n\t}\n\t\n\texplain() { throw \"Not Implemented\"; }\n\t\n\tasync forEach(fn) {\n\t\twhile (this.hasNext()) {\n\t\t\tawait fn(this.next());\n\t\t}\n\t}\n\t\n\thasNext() {\n\t\tif (this._next === false) this._findNext();\n\t\treturn this._next != null;\n\t}\n\t\n\thint() { throw \"Not Implemented\"; }\n\titcount() { throw \"Not Implemented\"; }\n\t\n\tlimit(_max) {\n\t\tthis.max = _max;\n\t\treturn this;\n\t}\n\t\n\tmap(fn) {\n\t\tconst results = [];\n\t\twhile (this.hasNext()) {\n\t\t\tresults.push(fn(this.next()));\n\t\t}\n\t\treturn results;\n\t}\n\t\n\tmaxScan() { throw \"Not Implemented\"; }\n\tmaxTimeMS() { throw \"Not Implemented\"; }\n\tmax() { throw \"Not Implemented\"; }\n\tmin() { throw \"Not Implemented\"; }\n\t\n\tnext() {\n\t\tif (this._next == null) throw \"Error: error hasNext: false\";\n\t\tconst result = this._next;\n\t\tthis._findNext();\n\t\tif (this.projection) return applyProjection(this.projection, result);\n\t\telse return result;\n\t}\n\t\n\tnoCursorTimeout() { throw \"Not Implemented\"; }\n\tobjsLeftInBatch() { throw \"Not Implemented\"; }\n\tpretty() { throw \"Not Implemented\"; }\n\treadConcern() { throw \"Not Implemented\"; }\n\treadPref() { throw \"Not Implemented\"; }\n\treturnKey() { throw \"Not Implemented\"; }\n\tshowRecordId() { throw \"Not Implemented\"; }\n\tsize() { throw \"Not Implemented\"; }\n\t\n\tskip(num) {\n\t\twhile (num > 0) {\n\t\t\tthis.next();\n\t\t\tnum--;\n\t\t}\n\t\treturn this;\n\t}\n\t\n\tsnapshot() { throw \"Not Implemented\"; }\n\t\n\tsort(s) {\n\t\treturn new this.SortedCursor(this.collection, this.query, this, s);\n\t}\n\t\n\ttailable() { throw \"Not Implemented\"; }\n\t\n\tasync toArray() {\n\t\tconst results = [];\n\t\twhile (this.hasNext()) {\n\t\t\tresults.push(this.next());\n\t\t}\n\t\treturn results;\n\t}\n\t\n\t// Support for async iteration (for await...of)\n\tasync *[Symbol.asyncIterator]() {\n\t\twhile (this.hasNext()) {\n\t\t\tyield this.next();\n\t\t}\n\t}\n}\n","/**\n * SortedCursor class for iterating over sorted query results\n */\nexport class SortedCursor {\n\tconstructor(collection, query, cursor, sort) {\n\t\tthis.collection = collection;\n\t\tthis.query = query;\n\t\tthis.sortSpec = sort;\n\t\tthis.pos = 0;\n\t\tthis.items = [];\n\t\t\n\t\t// Collect all items from the cursor\n\t\twhile (cursor.hasNext()) {\n\t\t\tthis.items.push(cursor.next());\n\t\t}\n\t\t\n\t\t// Sort the items\n\t\tconst sortKeys = Object.keys(sort);\n\t\tthis.items.sort(function(a, b) {\n\t\t\tfor (let i = 0; i < sortKeys.length; i++) {\n\t\t\t\tif (a[sortKeys[i]] == undefined && b[sortKeys[i]] != undefined) return -1 * sort[sortKeys[i]];\n\t\t\t\tif (a[sortKeys[i]] != undefined && b[sortKeys[i]] == undefined) return 1 * sort[sortKeys[i]];\n\t\t\t\tif (a[sortKeys[i]] < b[sortKeys[i]]) return -1 * sort[sortKeys[i]];\n\t\t\t\tif (a[sortKeys[i]] > b[sortKeys[i]]) return 1 * sort[sortKeys[i]];\n\t\t\t}\n\t\t\treturn 0;\n\t\t});\n\t}\n\n\tbatchSize() { throw \"Not Implemented\"; }\n\tclose() { throw \"Not Implemented\"; }\n\tcomment() { throw \"Not Implemented\"; }\n\t\n\tcount() {\n\t\treturn this.items.length;\n\t}\n\t\n\texplain() { throw \"Not Implemented\"; }\n\t\n\tasync forEach(fn) {\n\t\twhile (this.hasNext()) {\n\t\t\tawait fn(this.next());\n\t\t}\n\t}\n\t\n\thasNext() {\n\t\treturn this.pos < this.items.length;\n\t}\n\t\n\thint() { throw \"Not Implemented\"; }\n\titcount() { throw \"Not Implemented\"; }\n\t\n\tlimit(max) {\n\t\tthis.items = this.items.slice(0, max);\n\t\treturn this;\n\t}\n\t\n\tmap(fn) {\n\t\tconst results = [];\n\t\twhile (this.hasNext()) {\n\t\t\tresults.push(fn(this.next()));\n\t\t}\n\t\treturn results;\n\t}\n\t\n\tmaxScan() { throw \"Not Implemented\"; }\n\tmaxTimeMS() { throw \"Not Implemented\"; }\n\tmax() { throw \"Not Implemented\"; }\n\tmin() { throw \"Not Implemented\"; }\n\t\n\tnext() {\n\t\treturn this.items[this.pos++];\n\t}\n\t\n\tnoCursorTimeout() { throw \"Not Implemented\"; }\n\tobjsLeftInBatch() { throw \"Not Implemented\"; }\n\tpretty() { throw \"Not Implemented\"; }\n\treadConcern() { throw \"Not Implemented\"; }\n\treadPref() { throw \"Not Implemented\"; }\n\treturnKey() { throw \"Not Implemented\"; }\n\tshowRecordId() { throw \"Not Implemented\"; }\n\tsize() { throw \"Not Implemented\"; }\n\t\n\tskip(num) {\n\t\twhile (num > 0) {\n\t\t\tthis.next();\n\t\t\tnum--;\n\t\t}\n\t\treturn this;\n\t}\n\t\n\tsnapshot() { throw \"Not Implemented\"; }\n\t\n\tsort(s) {\n\t\treturn new SortedCursor(this.collection, this.query, this, s);\n\t}\n\t\n\ttailable() { throw \"Not Implemented\"; }\n\t\n\tasync toArray() {\n\t\tconst results = [];\n\t\twhile (this.hasNext()) {\n\t\t\tresults.push(this.next());\n\t\t}\n\t\treturn results;\n\t}\n\t\n\t// Support for async iteration (for await...of)\n\tasync *[Symbol.asyncIterator]() {\n\t\twhile (this.hasNext()) {\n\t\t\tyield this.next();\n\t\t}\n\t}\n}\n","// Standard suffix manipulations.\n/** @type {Record<string, string>} */\nconst step2list = {\n  ational: 'ate',\n  tional: 'tion',\n  enci: 'ence',\n  anci: 'ance',\n  izer: 'ize',\n  bli: 'ble',\n  alli: 'al',\n  entli: 'ent',\n  eli: 'e',\n  ousli: 'ous',\n  ization: 'ize',\n  ation: 'ate',\n  ator: 'ate',\n  alism: 'al',\n  iveness: 'ive',\n  fulness: 'ful',\n  ousness: 'ous',\n  aliti: 'al',\n  iviti: 'ive',\n  biliti: 'ble',\n  logi: 'log'\n}\n\n/** @type {Record<string, string>} */\nconst step3list = {\n  icate: 'ic',\n  ative: '',\n  alize: 'al',\n  iciti: 'ic',\n  ical: 'ic',\n  ful: '',\n  ness: ''\n}\n\n// Consonant-vowel sequences.\nconst consonant = '[^aeiou]'\nconst vowel = '[aeiouy]'\nconst consonants = '(' + consonant + '[^aeiouy]*)'\nconst vowels = '(' + vowel + '[aeiou]*)'\n\nconst gt0 = new RegExp('^' + consonants + '?' + vowels + consonants)\nconst eq1 = new RegExp(\n  '^' + consonants + '?' + vowels + consonants + vowels + '?$'\n)\nconst gt1 = new RegExp('^' + consonants + '?(' + vowels + consonants + '){2,}')\nconst vowelInStem = new RegExp('^' + consonants + '?' + vowel)\nconst consonantLike = new RegExp('^' + consonants + vowel + '[^aeiouwxy]$')\n\n// Exception expressions.\nconst sfxLl = /ll$/\nconst sfxE = /^(.+?)e$/\nconst sfxY = /^(.+?)y$/\nconst sfxIon = /^(.+?(s|t))(ion)$/\nconst sfxEdOrIng = /^(.+?)(ed|ing)$/\nconst sfxAtOrBlOrIz = /(at|bl|iz)$/\nconst sfxEED = /^(.+?)eed$/\nconst sfxS = /^.+?[^s]s$/\nconst sfxSsesOrIes = /^.+?(ss|i)es$/\nconst sfxMultiConsonantLike = /([^aeiouylsz])\\1$/\nconst step2 =\n  /^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$/\nconst step3 = /^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/\nconst step4 =\n  /^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$/\n\n/**\n * Get the stem from a given value.\n *\n * @param {string} value\n *   Value to stem.\n * @returns {string}\n *   Stem for `value`\n */\n// eslint-disable-next-line complexity\nexport function stemmer(value) {\n  let result = String(value).toLowerCase()\n\n  // Exit early.\n  if (result.length < 3) {\n    return result\n  }\n\n  /** @type {boolean} */\n  let firstCharacterWasLowerCaseY = false\n\n  // Detect initial `y`, make sure it never matches.\n  if (\n    result.codePointAt(0) === 121 // Lowercase Y\n  ) {\n    firstCharacterWasLowerCaseY = true\n    result = 'Y' + result.slice(1)\n  }\n\n  // Step 1a.\n  if (sfxSsesOrIes.test(result)) {\n    // Remove last two characters.\n    result = result.slice(0, -2)\n  } else if (sfxS.test(result)) {\n    // Remove last character.\n    result = result.slice(0, -1)\n  }\n\n  /** @type {RegExpMatchArray|null} */\n  let match\n\n  // Step 1b.\n  if ((match = sfxEED.exec(result))) {\n    if (gt0.test(match[1])) {\n      // Remove last character.\n      result = result.slice(0, -1)\n    }\n  } else if ((match = sfxEdOrIng.exec(result)) && vowelInStem.test(match[1])) {\n    result = match[1]\n\n    if (sfxAtOrBlOrIz.test(result)) {\n      // Append `e`.\n      result += 'e'\n    } else if (sfxMultiConsonantLike.test(result)) {\n      // Remove last character.\n      result = result.slice(0, -1)\n    } else if (consonantLike.test(result)) {\n      // Append `e`.\n      result += 'e'\n    }\n  }\n\n  // Step 1c.\n  if ((match = sfxY.exec(result)) && vowelInStem.test(match[1])) {\n    // Remove suffixing `y` and append `i`.\n    result = match[1] + 'i'\n  }\n\n  // Step 2.\n  if ((match = step2.exec(result)) && gt0.test(match[1])) {\n    result = match[1] + step2list[match[2]]\n  }\n\n  // Step 3.\n  if ((match = step3.exec(result)) && gt0.test(match[1])) {\n    result = match[1] + step3list[match[2]]\n  }\n\n  // Step 4.\n  if ((match = step4.exec(result))) {\n    if (gt1.test(match[1])) {\n      result = match[1]\n    }\n  } else if ((match = sfxIon.exec(result)) && gt1.test(match[1])) {\n    result = match[1]\n  }\n\n  // Step 5.\n  if (\n    (match = sfxE.exec(result)) &&\n    (gt1.test(match[1]) ||\n      (eq1.test(match[1]) && !consonantLike.test(match[1])))\n  ) {\n    result = match[1]\n  }\n\n  if (sfxLl.test(result) && gt1.test(result)) {\n    result = result.slice(0, -1)\n  }\n\n  // Turn initial `Y` back to `y`.\n  if (firstCharacterWasLowerCaseY) {\n    result = 'y' + result.slice(1)\n  }\n\n  return result\n}\n","import { stemmer } from 'stemmer';\n\n// Common English stop words that don't add semantic value to searches\nconst STOPWORDS = new Set([\n  'a', 'about', 'after', 'all', 'also', 'am', 'an', 'and', 'another', 'any', 'are', \n  'around', 'as', 'at', 'be', 'because', 'been', 'before', 'being', 'between', 'both', \n  'but', 'by', 'came', 'can', 'come', 'could', 'did', 'do', 'each', 'for', 'from', \n  'get', 'got', 'has', 'had', 'he', 'have', 'her', 'here', 'him', 'himself', 'his', \n  'how', 'i', 'if', 'in', 'into', 'is', 'it', 'like', 'make', 'many', 'me', 'might', \n  'more', 'most', 'much', 'must', 'my', 'never', 'now', 'of', 'on', 'only', 'or', \n  'other', 'our', 'out', 'over', 'said', 'same', 'see', 'should', 'since', 'some', \n  'still', 'such', 'take', 'than', 'that', 'the', 'their', 'them', 'then', 'there', \n  'these', 'they', 'this', 'those', 'through', 'to', 'too', 'under', 'up', 'very', \n  'was', 'way', 'we', 'well', 'were', 'what', 'where', 'which', 'while', 'who', \n  'with', 'would', 'you', 'your'\n]);\n\n/**\n * TextIndex - A text index implementation using Porter stemmer algorithm\n * \n * This class provides full-text search capabilities by indexing terms\n * and associating them with document IDs. It uses the Porter stemmer\n * algorithm to normalize words to their root forms.\n */\nexport class TextIndex {\n  constructor(options = {}) {\n    // Map from stemmed term to Map of document IDs to term frequency\n    // Structure: term -> { docId: frequency }\n    this.index = new Map();\n    // Map from document ID to Map of stemmed terms to their frequency\n    // Structure: docId -> { term: frequency }\n    this.documentTerms = new Map();\n    // Map from document ID to total term count (for normalization)\n    this.documentLengths = new Map();\n    // Stop words configuration\n    this.useStopWords = options.useStopWords !== false; // default: true\n    // Create a copy of STOPWORDS to avoid mutating the global set\n    this.stopWords = options.stopWords || new Set(STOPWORDS);\n  }\n\n  /**\n   * Tokenize text into individual words\n   * @param {string} text - The text to tokenize\n   * @returns {string[]} Array of words\n   */\n  _tokenize(text) {\n    if (typeof text !== 'string') {\n      return [];\n    }\n    // Split on non-word characters and filter out empty strings\n    const words = text.toLowerCase()\n      .split(/\\W+/)\n      .filter(word => word.length > 0);\n    \n    // Filter stop words if enabled\n    if (this.useStopWords) {\n      return words.filter(word => !this.stopWords.has(word));\n    }\n    \n    return words;\n  }\n\n  /**\n   * Add terms from text to the index for a given document ID\n   * @param {string} docId - The document identifier\n   * @param {string} text - The text content to index\n   */\n  add(docId, text) {\n    if (!docId) {\n      throw new Error('Document ID is required');\n    }\n\n    const words = this._tokenize(text);\n    const termFrequency = new Map();\n\n    // Count term frequencies\n    words.forEach(word => {\n      const stem = stemmer(word);\n      termFrequency.set(stem, (termFrequency.get(stem) || 0) + 1);\n    });\n\n    // Add to index\n    termFrequency.forEach((frequency, stem) => {\n      if (!this.index.has(stem)) {\n        this.index.set(stem, new Map());\n      }\n      this.index.get(stem).set(docId, frequency);\n    });\n\n    // Track document terms and frequencies\n    this.documentTerms.set(docId, termFrequency);\n    this.documentLengths.set(docId, words.length);\n  }\n\n  /**\n   * Remove all indexed terms for a given document ID\n   * @param {string} docId - The document identifier to remove\n   * @returns {boolean} True if document was found and removed, false otherwise\n   */\n  remove(docId) {\n    if (!this.documentTerms.has(docId)) {\n      return false;\n    }\n\n    // Get all terms associated with this document\n    const terms = this.documentTerms.get(docId);\n\n    // Remove document ID from each term's posting list\n    terms.forEach((frequency, term) => {\n      if (this.index.has(term)) {\n        this.index.get(term).delete(docId);\n        // Clean up empty term entries\n        if (this.index.get(term).size === 0) {\n          this.index.delete(term);\n        }\n      }\n    });\n\n    // Remove document from tracking\n    this.documentTerms.delete(docId);\n    this.documentLengths.delete(docId);\n    return true;\n  }\n\n  /**\n   * Query the index for documents containing the given terms with relevance scoring\n   * @param {string} queryText - The search query text\n   * @param {Object} options - Query options\n   * @param {boolean} options.scored - If true, return scored results; if false, return just IDs (default: true)\n   * @param {boolean} options.requireAll - If true, require ALL terms; if false, rank by relevance (default: false)\n   * @returns {Array} Array of document IDs (if scored=false) or objects with {id, score} (if scored=true)\n   */\n  query(queryText, options = { scored: true, requireAll: false }) {\n    const words = this._tokenize(queryText);\n    if (words.length === 0) {\n      return [];\n    }\n\n    // Get stemmed versions of query terms\n    const stemmedTerms = words.map(word => stemmer(word));\n    const uniqueTerms = [...new Set(stemmedTerms)];\n\n    if (options.requireAll) {\n      // Strict AND logic - document must contain ALL terms\n      const docSets = uniqueTerms.map(term => {\n        const termDocs = this.index.get(term);\n        return termDocs ? new Set(termDocs.keys()) : new Set();\n      });\n\n      if (docSets.length === 0) {\n        return [];\n      }\n\n      // Compute intersection of all document sets\n      const intersection = new Set(docSets[0]);\n      for (let i = 1; i < docSets.length; i++) {\n        for (const docId of intersection) {\n          if (!docSets[i].has(docId)) {\n            intersection.delete(docId);\n          }\n        }\n      }\n\n      return Array.from(intersection);\n    }\n\n    // Relevance-based scoring (OR logic with ranking)\n    // Calculate IDF (Inverse Document Frequency) for each term\n    const totalDocs = this.documentLengths.size;\n    const idf = new Map();\n    \n    uniqueTerms.forEach(term => {\n      const docsWithTerm = this.index.get(term)?.size || 0;\n      if (docsWithTerm > 0) {\n        // IDF = log(totalDocs / docsWithTerm)\n        idf.set(term, Math.log(totalDocs / docsWithTerm));\n      }\n    });\n\n    // Collect all documents that contain at least one query term\n    const docScores = new Map();\n\n    uniqueTerms.forEach(term => {\n      const termDocs = this.index.get(term);\n      if (!termDocs) return;\n\n      termDocs.forEach((termFreq, docId) => {\n        if (!docScores.has(docId)) {\n          docScores.set(docId, 0);\n        }\n\n        // Calculate TF-IDF score\n        // TF = term frequency in document / total terms in document\n        const docLength = this.documentLengths.get(docId) || 1;\n        const tf = termFreq / docLength;\n        \n        // Add to document's total score\n        const termIdf = idf.get(term) || 0;\n        const tfIdf = tf * termIdf;\n        \n        docScores.set(docId, docScores.get(docId) + tfIdf);\n      });\n    });\n\n    // Bonus for documents containing multiple query terms\n    docScores.forEach((score, docId) => {\n      const docTerms = this.documentTerms.get(docId);\n      if (docTerms) {\n        const matchingTerms = uniqueTerms.filter(term => docTerms.has(term)).length;\n        // Boost score based on term coverage (what % of query terms are present)\n        const coverage = matchingTerms / uniqueTerms.length;\n        docScores.set(docId, score * (1 + coverage));\n      }\n    });\n\n    // Sort by score (highest first)\n    const results = Array.from(docScores.entries())\n      .map(([id, score]) => ({ id, score }))\n      .sort((a, b) => b.score - a.score);\n\n    // Return based on options\n    if (options.scored === false) {\n      return results.map(r => r.id);\n    }\n    \n    return results;\n  }\n\n  /**\n   * Get the number of unique terms in the index\n   * @returns {number} Number of unique terms\n   */\n  getTermCount() {\n    return this.index.size;\n  }\n\n  /**\n   * Get the number of documents in the index\n   * @returns {number} Number of indexed documents\n   */\n  getDocumentCount() {\n    return this.documentTerms.size;\n  }\n\n  /**\n   * Clear all data from the index\n   */\n  clear() {\n    this.index.clear();\n    this.documentTerms.clear();\n    this.documentLengths.clear();\n  }\n\n  /**\n   * Add custom stop words\n   * @param {...string} words - Words to add to stop word list\n   * @returns {TextIndex} this for chaining\n   */\n  addStopWords(...words) {\n    words.forEach(word => this.stopWords.add(word.toLowerCase()));\n    return this;\n  }\n\n  /**\n   * Remove words from stop word list\n   * @param {...string} words - Words to remove from stop word list\n   * @returns {TextIndex} this for chaining\n   */\n  removeStopWords(...words) {\n    words.forEach(word => this.stopWords.delete(word.toLowerCase()));\n    return this;\n  }\n\n  /**\n   * Enable or disable stop word filtering\n   * @param {boolean} enabled - Whether to filter stop words\n   * @returns {TextIndex} this for chaining\n   */\n  setStopWordFiltering(enabled) {\n    this.useStopWords = enabled;\n    return this;\n  }\n}\n","import { getProp, isArray, arrayMatches, objectMatches, toArray, isIn, bboxToGeojson } from './utils.js';\nimport { TextIndex } from './text-index.js';\nimport { ObjectId } from './ObjectId.js';\n\n/**\n * Compare two values for equality, handling ObjectId instances\n */\nfunction valuesEqual(a, b) {\n\t// Handle ObjectId comparison\n\tif (a instanceof ObjectId || b instanceof ObjectId) {\n\t\tif (a instanceof ObjectId && b instanceof ObjectId) {\n\t\t\treturn a.equals(b);\n\t\t}\n\t\tif (a instanceof ObjectId && typeof b === 'string') {\n\t\t\treturn a.equals(b);\n\t\t}\n\t\tif (b instanceof ObjectId && typeof a === 'string') {\n\t\t\treturn b.equals(a);\n\t\t}\n\t\treturn false;\n\t}\n\t\n\t// Regular equality\n\treturn a == b;\n}\n\n/**\n * Compare two values with a comparison operator, handling ObjectId instances\n */\nfunction compareValues(a, b, operator) {\n\t// Convert ObjectIds to comparable values (use timestamp for ordering)\n\tlet aVal = a;\n\tlet bVal = b;\n\t\n\tif (a instanceof ObjectId) {\n\t\taVal = a.toString();\n\t}\n\tif (b instanceof ObjectId) {\n\t\tbVal = b.toString();\n\t}\n\t\n\tswitch(operator) {\n\t\tcase '>': return aVal > bVal;\n\t\tcase '>=': return aVal >= bVal;\n\t\tcase '<': return aVal < bVal;\n\t\tcase '<=': return aVal <= bVal;\n\t\tdefault: return false;\n\t}\n}\n\n/**\n * Text search helper\n * Creates a temporary TextIndex to check if the text matches the query\n */\nexport function text(prop, query) {\n\tconst textIndex = new TextIndex();\n\ttextIndex.add('id', prop);\n\tconst results = textIndex.query(query, { scored: false });\n\treturn results.length === 1;\n}\n\n/**\n * Geo within helper - using bounding box logic instead of de9im\n * This is a simpler implementation that doesn't require de9im dependency\n */\nexport function geoWithin(prop, query) {\n\ttry {\n\t\t// bbox format: [[minLon, maxLat], [maxLon, minLat]]\n\t\tif (!Array.isArray(query) || query.length !== 2) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst minLon = query[0][0];\n\t\tconst maxLat = query[0][1];\n\t\tconst maxLon = query[1][0];\n\t\tconst minLat = query[1][1];\n\n\t\t// Check if geometry is within bounding box\n\t\treturn isGeometryWithinBBox(prop, minLon, maxLon, minLat, maxLat);\n\t} catch (e) {\n\t\treturn false;\n\t}\n}\n\n/**\n * Check if a GeoJSON geometry is within a bounding box\n * For Points: checks if the point is within the bbox\n * For Polygons: checks if ALL vertices are within the bbox\n */\nfunction isGeometryWithinBBox(geoJson, minLon, maxLon, minLat, maxLat) {\n\tif (!geoJson) return false;\n\n\t// Handle GeoJSON FeatureCollection\n\tif (geoJson.type === 'FeatureCollection' && geoJson.features && geoJson.features.length > 0) {\n\t\t// All features must be within the bbox\n\t\tfor (const feature of geoJson.features) {\n\t\t\tif (feature.geometry) {\n\t\t\t\tif (!isGeometryWithinBBox(feature.geometry, minLon, maxLon, minLat, maxLat)) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\n\t// Handle GeoJSON Feature\n\tif (geoJson.type === 'Feature' && geoJson.geometry) {\n\t\treturn isGeometryWithinBBox(geoJson.geometry, minLon, maxLon, minLat, maxLat);\n\t}\n\n\t// Handle GeoJSON Point\n\tif (geoJson.type === 'Point' && geoJson.coordinates) {\n\t\tconst [lng, lat] = geoJson.coordinates;\n\t\tif (typeof lng === 'number' && typeof lat === 'number') {\n\t\t\treturn lng >= minLon && lng <= maxLon && lat >= minLat && lat <= maxLat;\n\t\t}\n\t}\n\n\t// Handle GeoJSON Polygon - ALL vertices must be within the bbox\n\tif (geoJson.type === 'Polygon' && geoJson.coordinates && geoJson.coordinates.length > 0) {\n\t\tfor (const ring of geoJson.coordinates) {\n\t\t\tfor (const coord of ring) {\n\t\t\t\tconst lng = coord[0];\n\t\t\t\tconst lat = coord[1];\n\t\t\t\tif (lng < minLon || lng > maxLon || lat < minLat || lat > maxLat) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\n\treturn false;\n}\n\n/**\n * Extract coordinates from a GeoJSON object for indexing purposes\n * This uses centroid for polygons to get a single point to index\n * @param {Object} geoJson - The GeoJSON object\n * @returns {Object|null} Object with lat and lng, or null if invalid\n */\nfunction extractCoordinatesFromGeoJSON(geoJson) {\n\tif (!geoJson) return null;\n\n\t// Handle GeoJSON FeatureCollection\n\tif (geoJson.type === 'FeatureCollection' && geoJson.features && geoJson.features.length > 0) {\n\t\tconst feature = geoJson.features[0];\n\t\tif (feature.geometry) {\n\t\t\treturn extractCoordinatesFromGeoJSON(feature.geometry);\n\t\t}\n\t}\n\n\t// Handle GeoJSON Feature\n\tif (geoJson.type === 'Feature' && geoJson.geometry) {\n\t\treturn extractCoordinatesFromGeoJSON(geoJson.geometry);\n\t}\n\n\t// Handle GeoJSON Point\n\tif (geoJson.type === 'Point' && geoJson.coordinates) {\n\t\tconst [lng, lat] = geoJson.coordinates;\n\t\tif (typeof lng === 'number' && typeof lat === 'number') {\n\t\t\treturn { lat, lng };\n\t\t}\n\t}\n\n\t// Handle GeoJSON Polygon - use centroid of first coordinate ring\n\tif (geoJson.type === 'Polygon' && geoJson.coordinates && geoJson.coordinates.length > 0) {\n\t\tconst ring = geoJson.coordinates[0];\n\t\tif (ring.length > 0) {\n\t\t\tlet sumLat = 0, sumLng = 0;\n\t\t\tfor (const coord of ring) {\n\t\t\t\tsumLng += coord[0];\n\t\t\t\tsumLat += coord[1];\n\t\t\t}\n\t\t\treturn {\n\t\t\t\tlat: sumLat / ring.length,\n\t\t\t\tlng: sumLng / ring.length\n\t\t\t};\n\t\t}\n\t}\n\n\treturn null;\n}\n\n/**\n * $where operator implementation\n * SECURITY NOTE: This uses Function constructor which can execute arbitrary code.\n * This is acceptable for a local/in-memory database but should NOT be used\n * in environments where untrusted user input is processed.\n */\nexport function where(doc, value) {\n\tif (typeof value === 'function') {\n\t\ttry {\n\t\t\treturn value.call(doc);\n\t\t} catch (e) {\n\t\t\treturn false;\n\t\t}\n\t} else if (typeof value === 'string') {\n\t\t// Evaluate the string as a function\n\t\ttry {\n\t\t\tvar fn = new Function('return ' + value);\n\t\t\treturn fn.call(doc);\n\t\t} catch (e) {\n\t\t\treturn false;\n\t\t}\n\t}\n\treturn false;\n}\n\n/**\n * Top-level match function\n */\nexport function tlMatches(doc, query) {\n\tvar key = Object.keys(query)[0];\n\tvar value = query[key];\n\tif (key.charAt(0) == \"$\") {\n\t\tif (key == \"$and\") return and(doc, value);\n\t\telse if (key == \"$or\") return or(doc, value);\n\t\telse if (key == \"$not\") return not(doc, value);\n\t\telse if (key == \"$nor\") return nor(doc, value);\n\t\telse if (key == \"$where\") return where(doc, value);\n\t\telse throw { $err: \"Can't canonicalize query: BadValue unknown top level operator: \" + key, code: 17287 };\n\t} else {\n\t\treturn opMatches(doc, key, value);\n\t}\n}\n\n/**\n * Operator match function\n */\nexport function opMatches(doc, key, value) {\n\tif (typeof (value) == \"string\") return valuesEqual(getProp(doc, key), value);\n\telse if (typeof (value) == \"number\") return valuesEqual(getProp(doc, key), value);\n\telse if (typeof (value) == \"boolean\") return valuesEqual(getProp(doc, key), value);\n\telse if (value instanceof ObjectId) return valuesEqual(getProp(doc, key), value);\n\telse if (typeof (value) == \"object\") {\n\t\tif (value instanceof RegExp) return getProp(doc, key) && getProp(doc, key).match(value);\n\t\telse if (isArray(value)) return getProp(doc, key) && arrayMatches(getProp(doc, key), value);\n\t\telse {\n\t\t\tvar keys = Object.keys(value);\n\t\t\tif (keys[0].charAt(0) == \"$\") {\n\t\t\t\tfor (var i = 0; i < keys.length; i++) {\n\t\t\t\t\tvar operator = Object.keys(value)[i];\n\t\t\t\t\tvar operand = value[operator];\n\t\t\t\t\tif (operator == \"$eq\") {\n\t\t\t\t\t\tif (getProp(doc, key) == undefined || !valuesEqual(getProp(doc, key), operand)) return false;\n\t\t\t\t\t} else if (operator == \"$gt\") {\n\t\t\t\t\t\tif (getProp(doc, key) == undefined || !compareValues(getProp(doc, key), operand, '>')) return false;\n\t\t\t\t\t} else if (operator == \"$gte\") {\n\t\t\t\t\t\tif (getProp(doc, key) == undefined || !compareValues(getProp(doc, key), operand, '>=')) return false;\n\t\t\t\t\t} else if (operator == \"$lt\") {\n\t\t\t\t\t\tif (getProp(doc, key) == undefined || !compareValues(getProp(doc, key), operand, '<')) return false;\n\t\t\t\t\t} else if (operator == \"$lte\") {\n\t\t\t\t\t\tif (getProp(doc, key) == undefined || !compareValues(getProp(doc, key), operand, '<=')) return false;\n\t\t\t\t\t} else if (operator == \"$ne\") {\n\t\t\t\t\t\tif (getProp(doc, key) == undefined || !(!valuesEqual(getProp(doc, key), operand))) return false;\n\t\t\t\t\t} else if (operator == \"$in\") {\n\t\t\t\t\t\tif (getProp(doc, key) == undefined || !isIn(getProp(doc, key), operand)) return false;\n\t\t\t\t\t} else if (operator == \"$nin\") {\n\t\t\t\t\t\tif (getProp(doc, key) == undefined || isIn(getProp(doc, key), operand)) return false;\n\t\t\t\t\t} else if (operator == \"$exists\") {\n\t\t\t\t\t\tif (operand ? getProp(doc, key) == undefined : getProp(doc, key) != undefined) return false;\n\t\t\t\t\t} else if (operator == \"$type\") {\n\t\t\t\t\t\tif (typeof (getProp(doc, key)) != operand) return false;\n\t\t\t\t\t} else if (operator == \"$mod\") {\n\t\t\t\t\t\tif (operand.length != 2) throw { $err: \"Can't canonicalize query: BadValue malformed mod, not enough elements\", code: 17287 };\n\t\t\t\t\t\tif (getProp(doc, key) == undefined || (getProp(doc, key) % operand[0] != operand[1])) return false;\n\t\t\t\t\t} else if (operator == \"$regex\") {\n\t\t\t\t\t\tif (getProp(doc, key) == undefined || !getProp(doc, key).match(operand)) return false;\n\t\t\t\t\t} else if (operator == \"$text\") {\n\t\t\t\t\t\tif (getProp(doc, key) == undefined || !text(getProp(doc, key), operand)) return false;\n\t\t\t\t\t} else if (operator == \"$geoWithin\") {\n\t\t\t\t\t\tif (getProp(doc, key) == undefined || !geoWithin(getProp(doc, key), operand)) return false;\n\t\t\t\t\t} else if (operator == \"$not\") {\n\t\t\t\t\t\tif (opMatches(doc, key, operand)) return false;\n\t\t\t\t\t} else if (operator == \"$all\") {\n\t\t\t\t\t\tvar fieldValue = getProp(doc, key);\n\t\t\t\t\t\tif (fieldValue == undefined || !isArray(fieldValue)) return false;\n\t\t\t\t\t\tfor (var j = 0; j < operand.length; j++) {\n\t\t\t\t\t\t\tif (!isIn(operand[j], fieldValue)) return false;\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if (operator == \"$elemMatch\") {\n\t\t\t\t\t\tvar fieldValue = getProp(doc, key);\n\t\t\t\t\t\tif (fieldValue == undefined || !isArray(fieldValue)) return false;\n\t\t\t\t\t\tvar found = false;\n\t\t\t\t\t\tfor (var j = 0; j < fieldValue.length; j++) {\n\t\t\t\t\t\t\tvar element = fieldValue[j];\n\t\t\t\t\t\t\t// Check if element matches the query\n\t\t\t\t\t\t\tif (typeof element === 'object' && !isArray(element)) {\n\t\t\t\t\t\t\t\t// For objects, use matches\n\t\t\t\t\t\t\t\tif (matches(element, operand)) {\n\t\t\t\t\t\t\t\t\tfound = true;\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t// For primitive values, check operators directly\n\t\t\t\t\t\t\t\tvar matchesPrimitive = true;\n\t\t\t\t\t\t\t\tvar opKeys = Object.keys(operand);\n\t\t\t\t\t\t\t\tfor (var k = 0; k < opKeys.length; k++) {\n\t\t\t\t\t\t\t\t\tvar op = opKeys[k];\n\t\t\t\t\t\t\t\t\tvar opValue = operand[op];\n\t\t\t\t\t\t\t\t\tif (op == \"$gte\" && !(element >= opValue)) matchesPrimitive = false;\n\t\t\t\t\t\t\t\t\telse if (op == \"$gt\" && !(element > opValue)) matchesPrimitive = false;\n\t\t\t\t\t\t\t\t\telse if (op == \"$lte\" && !(element <= opValue)) matchesPrimitive = false;\n\t\t\t\t\t\t\t\t\telse if (op == \"$lt\" && !(element < opValue)) matchesPrimitive = false;\n\t\t\t\t\t\t\t\t\telse if (op == \"$eq\" && !(element == opValue)) matchesPrimitive = false;\n\t\t\t\t\t\t\t\t\telse if (op == \"$ne\" && !(element != opValue)) matchesPrimitive = false;\n\t\t\t\t\t\t\t\t\telse if (op == \"$in\" && !isIn(element, opValue)) matchesPrimitive = false;\n\t\t\t\t\t\t\t\t\telse if (op == \"$nin\" && isIn(element, opValue)) matchesPrimitive = false;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif (matchesPrimitive) {\n\t\t\t\t\t\t\t\t\tfound = true;\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!found) return false;\n\t\t\t\t\t} else if (operator == \"$size\") {\n\t\t\t\t\t\tvar fieldValue = getProp(doc, key);\n\t\t\t\t\t\tif (fieldValue == undefined || !isArray(fieldValue)) return false;\n\t\t\t\t\t\tif (fieldValue.length != operand) return false;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthrow { $err: \"Can't canonicalize query: BadValue unknown operator: \" + operator, code: 17287 };\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn true;\n\t\t\t} else {\n\t\t\t\treturn getProp(doc, key) && objectMatches(getProp(doc, key), value);\n\t\t\t}\n\t\t}\n\t}\n}\n\n/**\n * $not operator\n */\nexport function not(doc, value) {\n\treturn !tlMatches(doc, value);\n}\n\n/**\n * $and operator\n */\nexport function and(doc, els) {\n\tfor (var i = 0; i < els.length; i++) {\n\t\tif (!tlMatches(doc, els[i])) {\n\t\t\treturn false;\n\t\t}\n\t}\n\treturn true;\n}\n\n/**\n * $or operator\n */\nexport function or(doc, els) {\n\tfor (var i = 0; i < els.length; i++) {\n\t\tif (tlMatches(doc, els[i])) return true;\n\t}\n\treturn false;\n}\n\n/**\n * $nor operator\n */\nexport function nor(doc, els) {\n\tfor (var i = 0; i < els.length; i++) {\n\t\tif (tlMatches(doc, els[i])) return false;\n\t}\n\treturn true;\n}\n\n/**\n * Main matches function - query structure: (top level operators ( \"age\" : (operators) ))\n * top, top level query, implicit $and\n */\nexport function matches(doc, query) {\n\treturn and(doc, toArray(query));\n}\n","/**\n * Update operations module\n */\n\n/**\n * Apply update operators to a document\n */\nexport function applyUpdates(updates, doc, setOnInsert) {\n\tvar keys = Object.keys(updates);\n\tfor (var i = 0; i < keys.length; i++) {\n\t\tvar key = keys[i];\n\t\tvar value = updates[key];\n\t\tif (key == \"$inc\") {\n\t\t\tvar fields = Object.keys(value);\n\t\t\tfor (var j = 0; j < fields.length; j++) {\n\t\t\t\tvar field = fields[j];\n\t\t\t\tvar amount = value[field];\n\t\t\t\tdoc[field] = doc[field] + amount;\n\t\t\t}\n\t\t} else if (key == \"$mul\") {\n\t\t\tvar fields = Object.keys(value);\n\t\t\tfor (var j = 0; j < fields.length; j++) {\n\t\t\t\tvar field = fields[j];\n\t\t\t\tvar amount = value[field];\n\t\t\t\tdoc[field] = doc[field] * amount;\n\t\t\t}\n\t\t} else if (key == \"$rename\") {\n\t\t\tvar fields = Object.keys(value);\n\t\t\tfor (var j = 0; j < fields.length; j++) {\n\t\t\t\tvar field = fields[j];\n\t\t\t\tvar newName = value[field];\n\t\t\t\tdoc[newName] = doc[field];\n\t\t\t\tdelete doc[field];\n\t\t\t}\n\t\t} else if (key == \"$setOnInsert\" && setOnInsert) {\n\t\t\tvar fields = Object.keys(value);\n\t\t\tfor (var j = 0; j < fields.length; j++) {\n\t\t\t\tdoc[fields[j]] = value[fields[j]];\n\t\t\t}\n\t\t} else if (key == \"$set\") {\n\t\t\tvar fields = Object.keys(value);\n\t\t\tfor (var j = 0; j < fields.length; j++) {\n\t\t\t\tdoc[fields[j]] = value[fields[j]];\n\t\t\t}\n\t\t} else if (key == \"$unset\") {\n\t\t\tvar fields = Object.keys(value);\n\t\t\tfor (var j = 0; j < fields.length; j++) {\n\t\t\t\tdelete doc[fields[j]];\n\t\t\t}\n\t\t} else if (key == \"$min\") {\n\t\t\tvar fields = Object.keys(value);\n\t\t\tfor (var j = 0; j < fields.length; j++) {\n\t\t\t\tvar field = fields[j];\n\t\t\t\tvar amount = value[field];\n\t\t\t\tdoc[field] = Math.min(doc[field], amount);\n\t\t\t}\n\t\t} else if (key == \"$max\") {\n\t\t\tvar fields = Object.keys(value);\n\t\t\tfor (var j = 0; j < fields.length; j++) {\n\t\t\t\tvar field = fields[j];\n\t\t\t\tvar amount = value[field];\n\t\t\t\tdoc[field] = Math.max(doc[field], amount);\n\t\t\t}\n\t\t} else if (key == \"$currentDate\") {  // TODO not the same as mongo\n\t\t\tvar fields = Object.keys(value);\n\t\t\tfor (var j = 0; j < fields.length; j++) {\n\t\t\t\tdoc[fields[j]] = new Date();\n\t\t\t}\n\t\t} else if (key == \"$addToSet\") {\n\t\t\tvar fields = Object.keys(value);\n\t\t\tfor (var j = 0; j < fields.length; j++) {\n\t\t\t\tvar field = fields[j];\n\t\t\t\tvar value = value[field];\n\t\t\t\tdoc[field].push(value);\n\t\t\t}\n\t\t} else if (key == \"$pop\") {\n\t\t\tvar fields = Object.keys(value);\n\t\t\tfor (var j = 0; j < fields.length; j++) {\n\t\t\t\tvar field = fields[j];\n\t\t\t\tvar value = value[field];\n\t\t\t\tif (value == 1) {\n\t\t\t\t\tdoc[field].pop();\n\t\t\t\t} else if (value == -1) {\n\t\t\t\t\tdoc[field].shift();\n\t\t\t\t}\n\t\t\t}\n\t\t} else if (key == \"$pullAll\") {\n\t\t\tvar fields = Object.keys(value);\n\t\t\tfor (var j = 0; j < fields.length; j++) {\n\t\t\t\tvar src = doc[fields[j]];\n\t\t\t\tvar toRemove = value[fields[j]];\n\t\t\t\tvar notRemoved = [];\n\t\t\t\tfor (var k = 0; k < src.length; k++) {\n\t\t\t\t\tvar removed = false;\n\t\t\t\t\tfor (var l = 0; l < toRemove.length; l++) {\n\t\t\t\t\t\tif (src[k] == toRemove[l]) {\n\t\t\t\t\t\t\tremoved = true;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!removed) notRemoved.push(src[k]);\n\t\t\t\t}\n\t\t\t\tdoc[fields[j]] = notRemoved;\n\t\t\t}\n\t\t} else if (key == \"$pushAll\") {\n\t\t\tvar fields = Object.keys(value);\n\t\t\tfor (var j = 0; j < fields.length; j++) {\n\t\t\t\tvar field = fields[j];\n\t\t\t\tvar values = value[field];\n\t\t\t\tfor (var k = 0; k < values.length; k++) {\n\t\t\t\t\tdoc[field].push(values[k]);\n\t\t\t\t}\n\t\t\t}\n\t\t} else if (key == \"$push\") {\n\t\t\tvar fields = Object.keys(value);\n\t\t\tfor (var j = 0; j < fields.length; j++) {\n\t\t\t\tvar field = fields[j];\n\t\t\t\tdoc[field].push(value[field]);\n\t\t\t}\n\t\t} else if (key == \"$bit\") {\n\t\t\tvar field = Object.keys(value)[0];\n\t\t\tvar operation = value[field];\n\t\t\tvar operator = Object.keys(operation)[0];\n\t\t\tvar operand = operation[operator];\n\t\t\tif (operator == \"and\") {\n\t\t\t\tdoc[field] = doc[field] & operand;\n\t\t\t} else if (operator == \"or\") {\n\t\t\t\tdoc[field] = doc[field] | operand;\n\t\t\t} else if (operator == \"xor\") {\n\t\t\t\tdoc[field] = doc[field] ^ operand;\n\t\t\t} else {\n\t\t\t\tthrow \"unknown $bit operator: \" + operator;\n\t\t\t}\n\t\t} else {\n\t\t\tthrow \"unknown update operator: \" + key;\n\t\t}\n\t}\n}\n\n/**\n * Create a new document from query and update operators for upsert\n */\nexport function createDocFromUpdate(query, updates, idGenerator) {\n\tvar newDoc = { _id: idGenerator() };\n\tvar onlyFields = true;\n\tvar updateKeys = Object.keys(updates);\n\tfor (var i = 0; i < updateKeys.length; i++) {\n\t\tif (updateKeys[i].charAt(0) == \"$\") {\n\t\t\tonlyFields = false;\n\t\t\tbreak;\n\t\t}\n\t}\n\tif (onlyFields) {\n\t\tfor (var i = 0; i < updateKeys.length; i++) {\n\t\t\tnewDoc[updateKeys[i]] = updates[updateKeys[i]];\n\t\t}\n\t} else {\n\t\tvar queryKeys = Object.keys(query);\n\t\tfor (var i = 0; i < queryKeys.length; i++) {\n\t\t\tnewDoc[queryKeys[i]] = query[queryKeys[i]];\n\t\t}\n\t\tapplyUpdates(updates, newDoc, true);\n\t}\n\treturn newDoc;\n}\n","/**\n * Base class for collection indexes\n * Provides a common interface for different types of indexes (e.g., regular, text, geo)\n */\nexport class CollectionIndex {\n\tconstructor(keys, options = {}) {\n\t\tthis.keys = keys;\n\t\tthis.options = options;\n\t\tthis.name = options.name || this.generateIndexName(keys);\n\t}\n\n\t/**\n\t * Generate index name from keys\n\t */\n\tgenerateIndexName(keys) {\n\t\tconst parts = [];\n\t\tfor (const field in keys) {\n\t\t\tif (keys.hasOwnProperty(field)) {\n\t\t\t\tparts.push(field + '_' + keys[field]);\n\t\t\t}\n\t\t}\n\t\treturn parts.join('_');\n\t}\n\n\t/**\n\t * Add a document to the index\n\t * @param {Object} doc - The document to index\n\t */\n\tadd(doc) {\n\t\tthrow new Error('add() must be implemented by subclass');\n\t}\n\n\t/**\n\t * Remove a document from the index\n\t * @param {Object} doc - The document to remove\n\t */\n\tremove(doc) {\n\t\tthrow new Error('remove() must be implemented by subclass');\n\t}\n\n\t/**\n\t * Update a document in the index (remove old, add new)\n\t * @param {Object} oldDoc - The old document\n\t * @param {Object} newDoc - The new document\n\t */\n\tupdate(oldDoc, newDoc) {\n\t\tthis.remove(oldDoc);\n\t\tthis.add(newDoc);\n\t}\n\n\t/**\n\t * Query the index\n\t * @param {*} query - The query to execute\n\t * @returns {Array} Array of document IDs or null if index cannot satisfy query\n\t */\n\tquery(query) {\n\t\tthrow new Error('query() must be implemented by subclass');\n\t}\n\n\t/**\n\t * Clear all data from the index\n\t */\n\tclear() {\n\t\tthrow new Error('clear() must be implemented by subclass');\n\t}\n\n\t/**\n\t * Get index specification (for getIndexes())\n\t */\n\tgetSpec() {\n\t\treturn {\n\t\t\tname: this.name,\n\t\t\tkey: this.keys\n\t\t};\n\t}\n}\n","import { CollectionIndex } from './CollectionIndex.js';\nimport { getProp } from './utils.js';\n\n/**\n * Regular (B-tree style) index implementation\n * Supports equality queries on indexed fields\n */\nexport class RegularCollectionIndex extends CollectionIndex {\n\tconstructor(keys, options = {}) {\n\t\tsuper(keys, options);\n\t\t// Map of key value to array of document _ids\n\t\tthis.data = {};\n\t}\n\n\t/**\n\t * Extract index key value from a document\n\t */\n\textractIndexKey(doc) {\n\t\tconst keyFields = Object.keys(this.keys);\n\t\tif (keyFields.length === 0) return null;\n\n\t\t// For simple single-field index\n\t\tif (keyFields.length === 1) {\n\t\t\tconst field = keyFields[0];\n\t\t\tconst value = getProp(doc, field);\n\t\t\tif (value === undefined) return null;\n\t\t\t// Preserve type information in the key\n\t\t\treturn JSON.stringify({ t: typeof value, v: value });\n\t\t}\n\n\t\t// For compound index, concatenate values with type preservation\n\t\tconst keyParts = [];\n\t\tfor (let i = 0; i < keyFields.length; i++) {\n\t\t\tconst value = getProp(doc, keyFields[i]);\n\t\t\tif (value === undefined) return null;\n\t\t\tkeyParts.push(JSON.stringify(value));\n\t\t}\n\t\t// Use a separator that won't appear in JSON\n\t\treturn keyParts.join('\\x00');\n\t}\n\n\t/**\n\t * Add a document to the index\n\t * @param {Object} doc - The document to index\n\t */\n\tadd(doc) {\n\t\tconst indexKey = this.extractIndexKey(doc);\n\t\tif (indexKey !== null) {\n\t\t\tif (!this.data[indexKey]) {\n\t\t\t\tthis.data[indexKey] = [];\n\t\t\t}\n\t\t\tthis.data[indexKey].push(doc._id);\n\t\t}\n\t}\n\n\t/**\n\t * Remove a document from the index\n\t * @param {Object} doc - The document to remove\n\t */\n\tremove(doc) {\n\t\tconst indexKey = this.extractIndexKey(doc);\n\t\tif (indexKey !== null && this.data[indexKey]) {\n\t\t\tconst arr = this.data[indexKey];\n\t\t\tconst idx = arr.indexOf(doc._id);\n\t\t\tif (idx !== -1) {\n\t\t\t\tarr.splice(idx, 1);\n\t\t\t}\n\t\t\tif (arr.length === 0) {\n\t\t\t\tdelete this.data[indexKey];\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Query the index\n\t * @param {*} query - The query object\n\t * @returns {Array|null} Array of document IDs or null if index cannot satisfy query\n\t */\n\tquery(query) {\n\t\tconst queryKeys = Object.keys(query);\n\t\tconst indexFields = Object.keys(this.keys);\n\n\t\t// Check if query matches index (simple case: single field equality)\n\t\tif (indexFields.length === 1) {\n\t\t\tconst field = indexFields[0];\n\t\t\t// Check for simple equality\n\t\t\tif (queryKeys.indexOf(field) !== -1) {\n\t\t\t\tconst queryValue = query[field];\n\t\t\t\t// Only use index for simple equality (not operators like $gt, $lt, etc.)\n\t\t\t\tif (typeof queryValue !== 'object' || queryValue === null) {\n\t\t\t\t\tconst indexKey = JSON.stringify({ t: typeof queryValue, v: queryValue });\n\t\t\t\t\treturn this.data[indexKey] || [];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * Clear all data from the index\n\t */\n\tclear() {\n\t\tthis.data = {};\n\t}\n}\n","import { CollectionIndex } from './CollectionIndex.js';\nimport { TextIndex } from './text-index.js';\nimport { getProp } from './utils.js';\n\n/**\n * Text index implementation using TextIndex\n * Supports full-text search on one or more fields\n */\nexport class TextCollectionIndex extends CollectionIndex {\n\tconstructor(keys, options = {}) {\n\t\tsuper(keys, options);\n\t\t// Create the underlying TextIndex\n\t\tthis.textIndex = new TextIndex(options);\n\t\t// Track which fields are indexed\n\t\tthis.indexedFields = [];\n\t\tfor (const field in keys) {\n\t\t\tif (keys[field] === 'text') {\n\t\t\t\tthis.indexedFields.push(field);\n\t\t\t}\n\t\t}\n\t\tif (this.indexedFields.length === 0) {\n\t\t\tthrow new Error('Text index must have at least one field with type \"text\"');\n\t\t}\n\t}\n\n\t/**\n\t * Extract text content from a document for the indexed fields\n\t * @param {Object} doc - The document\n\t * @returns {string} Combined text from all indexed fields\n\t */\n\t_extractText(doc) {\n\t\tconst textParts = [];\n\t\tfor (const field of this.indexedFields) {\n\t\t\tconst value = getProp(doc, field);\n\t\t\tif (value !== undefined && value !== null) {\n\t\t\t\ttextParts.push(String(value));\n\t\t\t}\n\t\t}\n\t\treturn textParts.join(' ');\n\t}\n\n\t/**\n\t * Add a document to the text index\n\t * @param {Object} doc - The document to index\n\t */\n\tadd(doc) {\n\t\tif (!doc._id) {\n\t\t\tthrow new Error('Document must have an _id field');\n\t\t}\n\t\tconst text = this._extractText(doc);\n\t\tif (text) {\n\t\t\tthis.textIndex.add(String(doc._id), text);\n\t\t}\n\t}\n\n\t/**\n\t * Remove a document from the text index\n\t * @param {Object} doc - The document to remove\n\t */\n\tremove(doc) {\n\t\tif (!doc._id) {\n\t\t\treturn;\n\t\t}\n\t\tthis.textIndex.remove(String(doc._id));\n\t}\n\n\t/**\n\t * Query the text index\n\t * @param {*} query - The query object\n\t * @returns {Array|null} Array of document IDs or null if query is not a text search\n\t */\n\tquery(query) {\n\t\t// This method is used for query planning\n\t\t// Text queries are handled separately in queryMatcher\n\t\treturn null;\n\t}\n\n\t/**\n\t * Search the text index\n\t * @param {string} searchText - The text to search for\n\t * @param {Object} options - Search options\n\t * @returns {Array} Array of document IDs\n\t */\n\tsearch(searchText, options = {}) {\n\t\tconst results = this.textIndex.query(searchText, { scored: false, ...options });\n\t\treturn results;\n\t}\n\n\t/**\n\t * Clear all data from the index\n\t */\n\tclear() {\n\t\tthis.textIndex.clear();\n\t}\n\n\t/**\n\t * Get index specification\n\t */\n\tgetSpec() {\n\t\treturn {\n\t\t\tname: this.name,\n\t\t\tkey: this.keys,\n\t\t\ttextIndexVersion: 3,\n\t\t\tweights: this._getWeights()\n\t\t};\n\t}\n\n\t/**\n\t * Get field weights (all default to 1 for now)\n\t */\n\t_getWeights() {\n\t\tconst weights = {};\n\t\tfor (const field of this.indexedFields) {\n\t\t\tweights[field] = 1;\n\t\t}\n\t\treturn weights;\n\t}\n}\n","/**\n * R-tree implementation for geospatial indexing\n * \n * This implementation supports:\n * - Adding points with lat/lng coordinates\n * - Removing points\n * - Bounding box queries\n * - Location + radius queries (converted to bounding box)\n */\n\n/**\n * Calculate distance between two points using Haversine formula\n * @param {number} lat1 - Latitude of first point\n * @param {number} lng1 - Longitude of first point\n * @param {number} lat2 - Latitude of second point\n * @param {number} lng2 - Longitude of second point\n * @returns {number} Distance in kilometers\n */\nfunction haversineDistance(lat1, lng1, lat2, lng2) {\n\tconst R = 6371; // Earth's radius in kilometers\n\tconst dLat = (lat2 - lat1) * Math.PI / 180;\n\tconst dLng = (lng2 - lng1) * Math.PI / 180;\n\tconst a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +\n\t\tMath.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *\n\t\tMath.sin(dLng / 2) * Math.sin(dLng / 2);\n\tconst c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n\treturn R * c;\n}\n\n/**\n * Convert radius query to bounding box\n * Approximation: 1 degree latitude  111 km\n * @param {number} lat - Center latitude\n * @param {number} lng - Center longitude\n * @param {number} radiusKm - Radius in kilometers\n * @returns {Object} Bounding box {minLat, maxLat, minLng, maxLng}\n */\nfunction radiusToBoundingBox(lat, lng, radiusKm) {\n\tconst latDelta = radiusKm / 111; // degrees\n\tconst lngDelta = radiusKm / (111 * Math.cos(lat * Math.PI / 180)); // degrees\n\t\n\treturn {\n\t\tminLat: lat - latDelta,\n\t\tmaxLat: lat + latDelta,\n\t\tminLng: lng - lngDelta,\n\t\tmaxLng: lng + lngDelta\n\t};\n}\n\n/**\n * Check if two bounding boxes intersect\n */\nfunction intersects(bbox1, bbox2) {\n\treturn !(bbox1.maxLat < bbox2.minLat ||\n\t\tbbox1.minLat > bbox2.maxLat ||\n\t\tbbox1.maxLng < bbox2.minLng ||\n\t\tbbox1.minLng > bbox2.maxLng);\n}\n\n/**\n * Check if bbox1 contains bbox2\n */\nfunction contains(bbox1, bbox2) {\n\treturn bbox1.minLat <= bbox2.minLat &&\n\t\tbbox1.maxLat >= bbox2.maxLat &&\n\t\tbbox1.minLng <= bbox2.minLng &&\n\t\tbbox1.maxLng >= bbox2.maxLng;\n}\n\n/**\n * Calculate the area of a bounding box\n */\nfunction area(bbox) {\n\treturn (bbox.maxLat - bbox.minLat) * (bbox.maxLng - bbox.minLng);\n}\n\n/**\n * Calculate the bounding box that contains both input boxes\n */\nfunction union(bbox1, bbox2) {\n\treturn {\n\t\tminLat: Math.min(bbox1.minLat, bbox2.minLat),\n\t\tmaxLat: Math.max(bbox1.maxLat, bbox2.maxLat),\n\t\tminLng: Math.min(bbox1.minLng, bbox2.minLng),\n\t\tmaxLng: Math.max(bbox1.maxLng, bbox2.maxLng)\n\t};\n}\n\n/**\n * Calculate the enlargement needed to include bbox2 in bbox1\n */\nfunction enlargement(bbox1, bbox2) {\n\tconst unionBox = union(bbox1, bbox2);\n\treturn area(unionBox) - area(bbox1);\n}\n\n/**\n * R-tree Node class\n */\nclass RTreeNode {\n\tconstructor(isLeaf = false) {\n\t\tthis.isLeaf = isLeaf;\n\t\tthis.children = []; // For internal nodes: child nodes; For leaf nodes: data entries\n\t\tthis.bbox = null;\n\t}\n\n\t/**\n\t * Update the bounding box to contain all children\n\t */\n\tupdateBBox() {\n\t\tif (this.children.length === 0) {\n\t\t\tthis.bbox = null;\n\t\t\treturn;\n\t\t}\n\n\t\tlet minLat = Infinity, maxLat = -Infinity;\n\t\tlet minLng = Infinity, maxLng = -Infinity;\n\n\t\tfor (const child of this.children) {\n\t\t\tconst bbox = child.bbox;\n\t\t\tminLat = Math.min(minLat, bbox.minLat);\n\t\t\tmaxLat = Math.max(maxLat, bbox.maxLat);\n\t\t\tminLng = Math.min(minLng, bbox.minLng);\n\t\t\tmaxLng = Math.max(maxLng, bbox.maxLng);\n\t\t}\n\n\t\tthis.bbox = { minLat, maxLat, minLng, maxLng };\n\t}\n}\n\n/**\n * R-tree implementation\n */\nexport class RTree {\n\tconstructor(maxEntries = 9) {\n\t\tthis.maxEntries = maxEntries;\n\t\tthis.minEntries = Math.max(2, Math.ceil(maxEntries / 2));\n\t\tthis.root = new RTreeNode(true);\n\t\tthis._size = 0; // Track size for O(1) queries\n\t}\n\n\t/**\n\t * Insert a point into the R-tree\n\t * @param {number} lat - Latitude\n\t * @param {number} lng - Longitude\n\t * @param {*} data - Associated data\n\t */\n\tinsert(lat, lng, data) {\n\t\t// Create a point bounding box (bbox with zero area)\n\t\tconst bbox = {\n\t\t\tminLat: lat,\n\t\t\tmaxLat: lat,\n\t\t\tminLng: lng,\n\t\t\tmaxLng: lng\n\t\t};\n\n\t\tconst entry = { bbox, lat, lng, data };\n\t\tthis._insert(entry, this.root, 1);\n\t\tthis._size++;\n\t}\n\n\t/**\n\t * Internal insert method\n\t */\n\t_insert(entry, node, level) {\n\t\tif (node.isLeaf) {\n\t\t\tnode.children.push(entry);\n\t\t\tnode.updateBBox();\n\n\t\t\tif (node.children.length > this.maxEntries) {\n\t\t\t\treturn this._split(node);\n\t\t\t}\n\t\t} else {\n\t\t\t// Choose subtree\n\t\t\tconst target = this._chooseSubtree(entry.bbox, node);\n\t\t\tconst splitNode = this._insert(entry, target, level + 1);\n\n\t\t\tif (splitNode) {\n\t\t\t\tnode.children.push(splitNode);\n\t\t\t\tnode.updateBBox();\n\n\t\t\t\tif (node.children.length > this.maxEntries) {\n\t\t\t\t\treturn this._split(node);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tnode.updateBBox();\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n\n\t/**\n\t * Choose the best subtree to insert an entry\n\t */\n\t_chooseSubtree(bbox, node) {\n\t\tlet minEnlargement = Infinity;\n\t\tlet minArea = Infinity;\n\t\tlet targetNode = null;\n\n\t\tfor (const child of node.children) {\n\t\t\tconst enl = enlargement(child.bbox, bbox);\n\t\t\tconst ar = area(child.bbox);\n\n\t\t\tif (enl < minEnlargement || (enl === minEnlargement && ar < minArea)) {\n\t\t\t\tminEnlargement = enl;\n\t\t\t\tminArea = ar;\n\t\t\t\ttargetNode = child;\n\t\t\t}\n\t\t}\n\n\t\treturn targetNode;\n\t}\n\n\t/**\n\t * Split an overflowing node\n\t */\n\t_split(node) {\n\t\t// Simple linear split algorithm\n\t\tconst children = node.children;\n\t\tconst isLeaf = node.isLeaf;\n\n\t\t// Find two seeds (most distant entries)\n\t\tlet maxDist = -Infinity;\n\t\tlet seed1Idx = 0, seed2Idx = 1;\n\n\t\tfor (let i = 0; i < children.length; i++) {\n\t\t\tfor (let j = i + 1; j < children.length; j++) {\n\t\t\t\tconst bbox1 = children[i].bbox;\n\t\t\t\tconst bbox2 = children[j].bbox;\n\t\t\t\tconst combinedBox = union(bbox1, bbox2);\n\t\t\t\tconst waste = area(combinedBox) - area(bbox1) - area(bbox2);\n\t\t\t\t\n\t\t\t\tif (waste > maxDist) {\n\t\t\t\t\tmaxDist = waste;\n\t\t\t\t\tseed1Idx = i;\n\t\t\t\t\tseed2Idx = j;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Create two new nodes\n\t\tconst node1 = new RTreeNode(isLeaf);\n\t\tconst node2 = new RTreeNode(isLeaf);\n\n\t\tnode1.children.push(children[seed1Idx]);\n\t\tnode2.children.push(children[seed2Idx]);\n\n\t\t// Distribute remaining entries\n\t\tfor (let i = 0; i < children.length; i++) {\n\t\t\tif (i === seed1Idx || i === seed2Idx) continue;\n\n\t\t\tconst child = children[i];\n\t\t\tconst bbox = child.bbox;\n\t\t\t\n\t\t\tconst enl1 = node1.children.length === 0 ? Infinity : enlargement(node1.bbox || bbox, bbox);\n\t\t\tconst enl2 = node2.children.length === 0 ? Infinity : enlargement(node2.bbox || bbox, bbox);\n\n\t\t\tif (node1.children.length < this.minEntries && \n\t\t\t\tchildren.length - i + node1.children.length <= this.minEntries) {\n\t\t\t\tnode1.children.push(child);\n\t\t\t} else if (node2.children.length < this.minEntries && \n\t\t\t\tchildren.length - i + node2.children.length <= this.minEntries) {\n\t\t\t\tnode2.children.push(child);\n\t\t\t} else if (enl1 < enl2) {\n\t\t\t\tnode1.children.push(child);\n\t\t\t} else if (enl2 < enl1) {\n\t\t\t\tnode2.children.push(child);\n\t\t\t} else {\n\t\t\t\t// Equal enlargement, choose the one with smaller area\n\t\t\t\tconst area1 = node1.bbox ? area(node1.bbox) : 0;\n\t\t\t\tconst area2 = node2.bbox ? area(node2.bbox) : 0;\n\t\t\t\tif (area1 < area2) {\n\t\t\t\t\tnode1.children.push(child);\n\t\t\t\t} else {\n\t\t\t\t\tnode2.children.push(child);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tnode1.updateBBox();\n\t\t\tnode2.updateBBox();\n\t\t}\n\n\t\t// Update the original node with one group\n\t\tnode.children = node1.children;\n\t\tnode.updateBBox();\n\n\t\t// If this was the root, create a new root\n\t\tif (node === this.root) {\n\t\t\tconst newRoot = new RTreeNode(false);\n\t\t\tnewRoot.children = [node1, node2];\n\t\t\tnewRoot.updateBBox();\n\t\t\tthis.root = newRoot;\n\t\t\treturn null;\n\t\t}\n\n\t\treturn node2;\n\t}\n\n\t/**\n\t * Search for points within a bounding box\n\t * @param {Object} bbox - Bounding box {minLat, maxLat, minLng, maxLng}\n\t * @returns {Array} Array of matching entries\n\t */\n\tsearchBBox(bbox) {\n\t\tconst results = [];\n\t\tthis._searchBBox(bbox, this.root, results);\n\t\treturn results;\n\t}\n\n\t/**\n\t * Internal bounding box search\n\t */\n\t_searchBBox(bbox, node, results) {\n\t\tif (!node.bbox || !intersects(bbox, node.bbox)) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (node.isLeaf) {\n\t\t\tfor (const entry of node.children) {\n\t\t\t\tif (intersects(bbox, entry.bbox)) {\n\t\t\t\t\tresults.push(entry);\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tfor (const child of node.children) {\n\t\t\t\tthis._searchBBox(bbox, child, results);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Search for points within a radius of a location\n\t * @param {number} lat - Center latitude\n\t * @param {number} lng - Center longitude\n\t * @param {number} radiusKm - Radius in kilometers\n\t * @returns {Array} Array of matching entries\n\t */\n\tsearchRadius(lat, lng, radiusKm) {\n\t\t// Convert radius to bounding box for initial filtering\n\t\tconst bbox = radiusToBoundingBox(lat, lng, radiusKm);\n\t\tconst candidates = this.searchBBox(bbox);\n\n\t\t// Filter by actual distance\n\t\tconst results = [];\n\t\tfor (const entry of candidates) {\n\t\t\tconst dist = haversineDistance(lat, lng, entry.lat, entry.lng);\n\t\t\tif (dist <= radiusKm) {\n\t\t\t\tresults.push(entry);\n\t\t\t}\n\t\t}\n\n\t\treturn results;\n\t}\n\n\t/**\n\t * Remove a point from the R-tree\n\t * @param {number} lat - Latitude\n\t * @param {number} lng - Longitude\n\t * @param {*} data - Associated data (optional, for exact match)\n\t * @returns {boolean} True if removed, false if not found\n\t */\n\tremove(lat, lng, data = null) {\n\t\tconst bbox = {\n\t\t\tminLat: lat,\n\t\t\tmaxLat: lat,\n\t\t\tminLng: lng,\n\t\t\tmaxLng: lng\n\t\t};\n\n\t\tconst removed = this._remove(bbox, data, this.root, null, -1);\n\t\t\n\t\tif (removed) {\n\t\t\tthis._size--;\n\t\t}\n\t\t\n\t\t// If root has only one child after removal, make that child the new root\n\t\tif (this.root.children.length === 1 && !this.root.isLeaf) {\n\t\t\tthis.root = this.root.children[0];\n\t\t}\n\n\t\treturn removed;\n\t}\n\n\t/**\n\t * Internal remove method\n\t */\n\t_remove(bbox, data, node, parent, indexInParent) {\n\t\tif (!node.bbox || !intersects(bbox, node.bbox)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (node.isLeaf) {\n\t\t\tfor (let i = 0; i < node.children.length; i++) {\n\t\t\t\tconst entry = node.children[i];\n\t\t\t\tif (entry.lat === bbox.minLat && entry.lng === bbox.minLng) {\n\t\t\t\t\t// If data is specified, check for match\n\t\t\t\t\tconst dataMatches = data === null || \n\t\t\t\t\t\tJSON.stringify(entry.data) === JSON.stringify(data);\n\t\t\t\t\t\n\t\t\t\t\tif (dataMatches) {\n\t\t\t\t\t\tnode.children.splice(i, 1);\n\t\t\t\t\t\tnode.updateBBox();\n\t\t\t\t\t\t\n\t\t\t\t\t\t// Handle underflow\n\t\t\t\t\t\tif (node.children.length < this.minEntries && node !== this.root) {\n\t\t\t\t\t\t\t// Simple approach: reinsert all entries from this node\n\t\t\t\t\t\t\tconst entries = node.children.slice();\n\t\t\t\t\t\t\tnode.children = [];\n\t\t\t\t\t\t\tnode.updateBBox();\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t// Remove this node from parent\n\t\t\t\t\t\t\tif (parent) {\n\t\t\t\t\t\t\t\tparent.children.splice(indexInParent, 1);\n\t\t\t\t\t\t\t\tparent.updateBBox();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t// Reinsert entries\n\t\t\t\t\t\t\tfor (const e of entries) {\n\t\t\t\t\t\t\t\tthis._insert(e, this.root, 1);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tfor (let i = 0; i < node.children.length; i++) {\n\t\t\t\tconst child = node.children[i];\n\t\t\t\tif (this._remove(bbox, data, child, node, i)) {\n\t\t\t\t\tnode.updateBBox();\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn false;\n\t}\n\n\t/**\n\t * Get all entries in the tree\n\t * @returns {Array} All entries\n\t */\n\tgetAll() {\n\t\tconst results = [];\n\t\tthis._getAll(this.root, results);\n\t\treturn results;\n\t}\n\n\t/**\n\t * Internal method to get all entries\n\t */\n\t_getAll(node, results) {\n\t\tif (node.isLeaf) {\n\t\t\tresults.push(...node.children);\n\t\t} else {\n\t\t\tfor (const child of node.children) {\n\t\t\t\tthis._getAll(child, results);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Get the number of entries in the tree\n\t * @returns {number} Number of entries\n\t */\n\tsize() {\n\t\treturn this._size;\n\t}\n\n\t/**\n\t * Clear all entries from the tree\n\t */\n\tclear() {\n\t\tthis.root = new RTreeNode(true);\n\t\tthis._size = 0;\n\t}\n}\n\nexport default RTree;\n","import { CollectionIndex } from './CollectionIndex.js';\nimport { RTree } from './rtree.js';\nimport { getProp } from './utils.js';\n\n/**\n * Geospatial index implementation using RTree\n * Supports geospatial queries on GeoJSON fields\n */\nexport class GeospatialCollectionIndex extends CollectionIndex {\n\tconstructor(keys, options = {}) {\n\t\tsuper(keys, options);\n\t\t// Create the underlying RTree\n\t\tthis.rtree = new RTree();\n\t\t// Track which field is the geospatial field\n\t\tthis.geoField = null;\n\t\tfor (const field in keys) {\n\t\t\tif (keys[field] === '2dsphere' || keys[field] === '2d') {\n\t\t\t\tthis.geoField = field;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tif (!this.geoField) {\n\t\t\tthrow new Error('Geospatial index must have at least one field with type \"2dsphere\" or \"2d\"');\n\t\t}\n\t}\n\n\t/**\n\t * Extract coordinates from a GeoJSON object\n\t * @param {Object} geoJson - The GeoJSON object\n\t * @returns {Object|null} Object with lat and lng, or null if invalid\n\t */\n\t_extractCoordinates(geoJson) {\n\t\tif (!geoJson) return null;\n\n\t\t// Handle GeoJSON FeatureCollection\n\t\tif (geoJson.type === 'FeatureCollection' && geoJson.features && geoJson.features.length > 0) {\n\t\t\tconst feature = geoJson.features[0];\n\t\t\tif (feature.geometry) {\n\t\t\t\treturn this._extractCoordinates(feature.geometry);\n\t\t\t}\n\t\t}\n\n\t\t// Handle GeoJSON Feature\n\t\tif (geoJson.type === 'Feature' && geoJson.geometry) {\n\t\t\treturn this._extractCoordinates(geoJson.geometry);\n\t\t}\n\n\t\t// Handle GeoJSON Point\n\t\tif (geoJson.type === 'Point' && geoJson.coordinates) {\n\t\t\tconst [lng, lat] = geoJson.coordinates;\n\t\t\tif (typeof lng === 'number' && typeof lat === 'number') {\n\t\t\t\treturn { lat, lng };\n\t\t\t}\n\t\t}\n\n\t\t// Handle GeoJSON Polygon - use centroid of first coordinate\n\t\tif (geoJson.type === 'Polygon' && geoJson.coordinates && geoJson.coordinates.length > 0) {\n\t\t\tconst ring = geoJson.coordinates[0];\n\t\t\tif (ring.length > 0) {\n\t\t\t\tlet sumLat = 0, sumLng = 0;\n\t\t\t\tfor (const coord of ring) {\n\t\t\t\t\tsumLng += coord[0];\n\t\t\t\t\tsumLat += coord[1];\n\t\t\t\t}\n\t\t\t\treturn {\n\t\t\t\t\tlat: sumLat / ring.length,\n\t\t\t\t\tlng: sumLng / ring.length\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * Add a document to the geospatial index\n\t * @param {Object} doc - The document to index\n\t */\n\tadd(doc) {\n\t\tif (!doc._id) {\n\t\t\tthrow new Error('Document must have an _id field');\n\t\t}\n\t\tconst geoValue = getProp(doc, this.geoField);\n\t\tconst coords = this._extractCoordinates(geoValue);\n\t\tif (coords) {\n\t\t\tthis.rtree.insert(coords.lat, coords.lng, { \n\t\t\t\t_id: doc._id, \n\t\t\t\tgeoJson: geoValue \n\t\t\t});\n\t\t}\n\t}\n\n\t/**\n\t * Remove a document from the geospatial index\n\t * @param {Object} doc - The document to remove\n\t */\n\tremove(doc) {\n\t\tif (!doc._id) {\n\t\t\treturn;\n\t\t}\n\t\tconst geoValue = getProp(doc, this.geoField);\n\t\tconst coords = this._extractCoordinates(geoValue);\n\t\tif (coords) {\n\t\t\tthis.rtree.remove(coords.lat, coords.lng, { \n\t\t\t\t_id: doc._id, \n\t\t\t\tgeoJson: geoValue \n\t\t\t});\n\t\t}\n\t}\n\n\t/**\n\t * Query the geospatial index\n\t * @param {*} query - The query object\n\t * @returns {Array|null} Array of document IDs or null if query is not a geospatial query\n\t */\n\tquery(query) {\n\t\t// Check if this is a geospatial query on our indexed field\n\t\tif (!query[this.geoField]) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst geoQuery = query[this.geoField];\n\n\t\t// Handle $geoWithin with bounding box\n\t\tif (geoQuery.$geoWithin) {\n\t\t\tconst bbox = geoQuery.$geoWithin;\n\t\t\t// bbox format: [[minLon, maxLat], [maxLon, minLat]]\n\t\t\tif (Array.isArray(bbox) && bbox.length === 2) {\n\t\t\t\tconst minLon = bbox[0][0];\n\t\t\t\tconst maxLat = bbox[0][1];\n\t\t\t\tconst maxLon = bbox[1][0];\n\t\t\t\tconst minLat = bbox[1][1];\n\n\t\t\t\tconst results = this.rtree.searchBBox({\n\t\t\t\t\tminLat: minLat,\n\t\t\t\t\tmaxLat: maxLat,\n\t\t\t\t\tminLng: minLon,\n\t\t\t\t\tmaxLng: maxLon\n\t\t\t\t});\n\n\t\t\t\t// Extract document IDs\n\t\t\t\treturn results.map(entry => entry.data._id);\n\t\t\t}\n\t\t}\n\n\t\t// Handle $near with radius (future enhancement)\n\t\t// if (geoQuery.$near) {\n\t\t//   const center = geoQuery.$near;\n\t\t//   const maxDistance = geoQuery.$maxDistance || 1000; // default 1000km\n\t\t//   // Implementation would use rtree.searchRadius\n\t\t// }\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * Clear all data from the index\n\t */\n\tclear() {\n\t\tthis.rtree.clear();\n\t}\n\n\t/**\n\t * Get index specification\n\t */\n\tgetSpec() {\n\t\treturn {\n\t\t\tname: this.name,\n\t\t\tkey: this.keys,\n\t\t\t'2dsphereIndexVersion': 3\n\t\t};\n\t}\n}\n","import { Cursor } from './Cursor.js';\nimport { SortedCursor } from './SortedCursor.js';\nimport { isArray, getProp, applyProjection, copy } from './utils.js';\nimport { matches } from './queryMatcher.js';\nimport { applyUpdates, createDocFromUpdate } from './updates.js';\nimport { RegularCollectionIndex } from './RegularCollectionIndex.js';\nimport { TextCollectionIndex } from './TextCollectionIndex.js';\nimport { GeospatialCollectionIndex } from './GeospatialCollectionIndex.js';\n\n/**\n * Collection class\n */\nexport class Collection {\n\tconstructor(db, storage, idGenerator) {\n\t\tthis.db = db;\n\t\tthis.storage = storage;\n\t\tthis.idGenerator = idGenerator;\n\t\tthis.indexes = {}; // Index storage - map of index name to index structure\n\t\tthis.isCollection = true; // TODO used by dropDatabase, ugly\n\t}\n\n\t/**\n\t * Generate index name from keys\n\t */\n\tgenerateIndexName(keys) {\n\t\tconst parts = [];\n\t\tfor (const field in keys) {\n\t\t\tif (keys.hasOwnProperty(field)) {\n\t\t\t\tparts.push(field + '_' + keys[field]);\n\t\t\t}\n\t\t}\n\t\treturn parts.join('_');\n\t}\n\n\t/**\n\t * Determine if keys specify a text index\n\t */\n\tisTextIndex(keys) {\n\t\tfor (const field in keys) {\n\t\t\tif (keys[field] === 'text') {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\t/**\n\t * Determine if keys specify a geospatial index\n\t */\n\tisGeospatialIndex(keys) {\n\t\tfor (const field in keys) {\n\t\t\tif (keys[field] === '2dsphere' || keys[field] === '2d') {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\t/**\n\t * Build/rebuild an index\n\t */\n\tbuildIndex(indexName, keys, options = {}) {\n\t\tlet index;\n\t\t\n\t\t// Create appropriate index type\n\t\tif (this.isTextIndex(keys)) {\n\t\t\tindex = new TextCollectionIndex(keys, { ...options, name: indexName });\n\t\t} else if (this.isGeospatialIndex(keys)) {\n\t\t\tindex = new GeospatialCollectionIndex(keys, { ...options, name: indexName });\n\t\t} else {\n\t\t\tindex = new RegularCollectionIndex(keys, { ...options, name: indexName });\n\t\t}\n\n\t\t// Build index by scanning all documents\n\t\tfor (let i = 0; i < this.storage.size(); i++) {\n\t\t\tconst doc = this.storage.get(i);\n\t\t\tif (doc) {\n\t\t\t\tindex.add(doc);\n\t\t\t}\n\t\t}\n\n\t\tthis.indexes[indexName] = index;\n\t\treturn index;\n\t}\n\n\t/**\n\t * Update indexes when a document is inserted\n\t */\n\tupdateIndexesOnInsert(doc) {\n\t\tfor (const indexName in this.indexes) {\n\t\t\tif (this.indexes.hasOwnProperty(indexName)) {\n\t\t\t\tconst index = this.indexes[indexName];\n\t\t\t\tindex.add(doc);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Update indexes when a document is deleted\n\t */\n\tupdateIndexesOnDelete(doc) {\n\t\tfor (const indexName in this.indexes) {\n\t\t\tif (this.indexes.hasOwnProperty(indexName)) {\n\t\t\t\tconst index = this.indexes[indexName];\n\t\t\t\tindex.remove(doc);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Query planner - analyze query and determine if an index can be used\n\t */\n\tplanQuery(query) {\n\t\t// Simple query planner - look for equality queries on indexed fields\n\t\tconst queryKeys = Object.keys(query);\n\n\t\tfor (const indexName in this.indexes) {\n\t\t\tif (this.indexes.hasOwnProperty(indexName)) {\n\t\t\t\tconst index = this.indexes[indexName];\n\t\t\t\t\n\t\t\t\t// Skip text indexes - they are handled separately\n\t\t\t\tif (index instanceof TextCollectionIndex) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\t// Try geospatial indexes\n\t\t\t\tif (index instanceof GeospatialCollectionIndex) {\n\t\t\t\t\tconst docIds = index.query(query);\n\t\t\t\t\tif (docIds !== null) {\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tuseIndex: true,\n\t\t\t\t\t\t\tindexName: indexName,\n\t\t\t\t\t\t\tdocIds: docIds\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tconst indexFields = Object.keys(index.keys);\n\n\t\t\t\t// Check if query matches index (simple case: single field equality)\n\t\t\t\t// Note: Compound indexes are created but only single-field equality queries use them\n\t\t\t\tif (indexFields.length === 1) {\n\t\t\t\t\tconst field = indexFields[0];\n\t\t\t\t\t// Check for simple equality\n\t\t\t\t\tif (queryKeys.indexOf(field) !== -1) {\n\t\t\t\t\t\tconst queryValue = query[field];\n\t\t\t\t\t\t// Only use index for simple equality (not operators like $gt, $lt, etc.)\n\t\t\t\t\t\tif (typeof queryValue !== 'object' || queryValue === null) {\n\t\t\t\t\t\t\tconst docIds = index.query(query);\n\t\t\t\t\t\t\tif (docIds !== null) {\n\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\tuseIndex: true,\n\t\t\t\t\t\t\t\t\tindexName: indexName,\n\t\t\t\t\t\t\t\t\tdocIds: docIds\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * Get a text index for the given field\n\t * @param {string} field - The field name\n\t * @returns {TextCollectionIndex|null} The text index or null if not found\n\t */\n\tgetTextIndex(field) {\n\t\tfor (const indexName in this.indexes) {\n\t\t\tif (this.indexes.hasOwnProperty(indexName)) {\n\t\t\t\tconst index = this.indexes[indexName];\n\t\t\t\tif (index instanceof TextCollectionIndex) {\n\t\t\t\t\t// Check if this field is indexed\n\t\t\t\t\tif (index.indexedFields.includes(field)) {\n\t\t\t\t\t\treturn index;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n\n\t// Collection methods\n\taggregate(pipeline) {\n\t\tif (!pipeline || !isArray(pipeline)) {\n\t\t\tthrow { $err: \"Pipeline must be an array\", code: 17287 };\n\t\t}\n\n\t\t// Start with all documents\n\t\tlet results = [];\n\t\tconst cursor = this.find({});\n\t\twhile (cursor.hasNext()) {\n\t\t\tresults.push(cursor.next());\n\t\t}\n\n\t\t// Process each stage in the pipeline\n\t\tfor (let i = 0; i < pipeline.length; i++) {\n\t\t\tconst stage = pipeline[i];\n\t\t\tconst stageKeys = Object.keys(stage);\n\t\t\tif (stageKeys.length !== 1) {\n\t\t\t\tthrow { $err: \"Each pipeline stage must have exactly one key\", code: 17287 };\n\t\t\t}\n\t\t\tconst stageType = stageKeys[0];\n\t\t\tconst stageSpec = stage[stageType];\n\n\t\t\tif (stageType === \"$match\") {\n\t\t\t\t// Filter documents based on query\n\t\t\t\tconst matched = [];\n\t\t\t\tfor (let j = 0; j < results.length; j++) {\n\t\t\t\t\tif (matches(results[j], stageSpec)) {\n\t\t\t\t\t\tmatched.push(results[j]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tresults = matched;\n\t\t\t} else if (stageType === \"$project\") {\n\t\t\t\t// Reshape documents\n\t\t\t\tconst projected = [];\n\t\t\t\tfor (let j = 0; j < results.length; j++) {\n\t\t\t\t\tprojected.push(applyProjection(stageSpec, results[j]));\n\t\t\t\t}\n\t\t\t\tresults = projected;\n\t\t\t} else if (stageType === \"$sort\") {\n\t\t\t\t// Sort documents\n\t\t\t\tconst sortKeys = Object.keys(stageSpec);\n\t\t\t\tresults.sort(function (a, b) {\n\t\t\t\t\tfor (let k = 0; k < sortKeys.length; k++) {\n\t\t\t\t\t\tconst key = sortKeys[k];\n\t\t\t\t\t\tif (a[key] === undefined && b[key] !== undefined) return -1 * stageSpec[key];\n\t\t\t\t\t\tif (a[key] !== undefined && b[key] === undefined) return 1 * stageSpec[key];\n\t\t\t\t\t\tif (a[key] < b[key]) return -1 * stageSpec[key];\n\t\t\t\t\t\tif (a[key] > b[key]) return 1 * stageSpec[key];\n\t\t\t\t\t}\n\t\t\t\t\treturn 0;\n\t\t\t\t});\n\t\t\t} else if (stageType === \"$limit\") {\n\t\t\t\t// Limit number of documents\n\t\t\t\tresults = results.slice(0, stageSpec);\n\t\t\t} else if (stageType === \"$skip\") {\n\t\t\t\t// Skip documents\n\t\t\t\tresults = results.slice(stageSpec);\n\t\t\t} else if (stageType === \"$group\") {\n\t\t\t\t// Group documents\n\t\t\t\tconst groups = {};\n\t\t\t\tconst groupId = stageSpec._id;\n\n\t\t\t\tfor (let j = 0; j < results.length; j++) {\n\t\t\t\t\tconst doc = results[j];\n\t\t\t\t\tlet key;\n\n\t\t\t\t\t// Compute group key\n\t\t\t\t\tif (groupId === null || groupId === undefined) {\n\t\t\t\t\t\tkey = null;\n\t\t\t\t\t} else if (typeof groupId === 'string' && groupId.charAt(0) === '$') {\n\t\t\t\t\t\t// Field reference\n\t\t\t\t\t\tkey = getProp(doc, groupId.substring(1));\n\t\t\t\t\t} else if (typeof groupId === 'object') {\n\t\t\t\t\t\t// Computed key\n\t\t\t\t\t\tkey = JSON.stringify(groupId);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tkey = groupId;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst keyStr = JSON.stringify(key);\n\n\t\t\t\t\t// Initialize group\n\t\t\t\t\tif (!groups[keyStr]) {\n\t\t\t\t\t\tgroups[keyStr] = {\n\t\t\t\t\t\t\t_id: key,\n\t\t\t\t\t\t\tdocs: [],\n\t\t\t\t\t\t\taccumulators: {}\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\n\t\t\t\t\tgroups[keyStr].docs.push(doc);\n\t\t\t\t}\n\n\t\t\t\t// Apply accumulators\n\t\t\t\tconst grouped = [];\n\t\t\t\tfor (const groupKey in groups) {\n\t\t\t\t\tconst group = groups[groupKey];\n\t\t\t\t\tconst result = { _id: group._id };\n\n\t\t\t\t\t// Process each accumulator field\n\t\t\t\t\tfor (const field in stageSpec) {\n\t\t\t\t\t\tif (field === '_id') continue;\n\n\t\t\t\t\t\tconst accumulator = stageSpec[field];\n\t\t\t\t\t\tconst accKeys = Object.keys(accumulator);\n\t\t\t\t\t\tif (accKeys.length !== 1) continue;\n\n\t\t\t\t\t\tconst accType = accKeys[0];\n\t\t\t\t\t\tconst accExpr = accumulator[accType];\n\n\t\t\t\t\t\tif (accType === '$sum') {\n\t\t\t\t\t\t\tlet sum = 0;\n\t\t\t\t\t\t\tfor (let k = 0; k < group.docs.length; k++) {\n\t\t\t\t\t\t\t\tif (typeof accExpr === 'number') {\n\t\t\t\t\t\t\t\t\tsum += accExpr;\n\t\t\t\t\t\t\t\t} else if (typeof accExpr === 'string' && accExpr.charAt(0) === '$') {\n\t\t\t\t\t\t\t\t\tconst val = getProp(group.docs[k], accExpr.substring(1));\n\t\t\t\t\t\t\t\t\tsum += val || 0;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tresult[field] = sum;\n\t\t\t\t\t\t} else if (accType === '$avg') {\n\t\t\t\t\t\t\tlet sum = 0;\n\t\t\t\t\t\t\tlet count = 0;\n\t\t\t\t\t\t\tfor (let k = 0; k < group.docs.length; k++) {\n\t\t\t\t\t\t\t\tif (typeof accExpr === 'string' && accExpr.charAt(0) === '$') {\n\t\t\t\t\t\t\t\t\tconst val = getProp(group.docs[k], accExpr.substring(1));\n\t\t\t\t\t\t\t\t\tif (val !== undefined && val !== null) {\n\t\t\t\t\t\t\t\t\t\tsum += val;\n\t\t\t\t\t\t\t\t\t\tcount++;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tresult[field] = count > 0 ? sum / count : 0;\n\t\t\t\t\t\t} else if (accType === '$min') {\n\t\t\t\t\t\t\tlet min = undefined;\n\t\t\t\t\t\t\tfor (let k = 0; k < group.docs.length; k++) {\n\t\t\t\t\t\t\t\tif (typeof accExpr === 'string' && accExpr.charAt(0) === '$') {\n\t\t\t\t\t\t\t\t\tconst val = getProp(group.docs[k], accExpr.substring(1));\n\t\t\t\t\t\t\t\t\tif (val !== undefined && (min === undefined || val < min)) {\n\t\t\t\t\t\t\t\t\t\tmin = val;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tresult[field] = min;\n\t\t\t\t\t\t} else if (accType === '$max') {\n\t\t\t\t\t\t\tlet max = undefined;\n\t\t\t\t\t\t\tfor (let k = 0; k < group.docs.length; k++) {\n\t\t\t\t\t\t\t\tif (typeof accExpr === 'string' && accExpr.charAt(0) === '$') {\n\t\t\t\t\t\t\t\t\tconst val = getProp(group.docs[k], accExpr.substring(1));\n\t\t\t\t\t\t\t\t\tif (val !== undefined && (max === undefined || val > max)) {\n\t\t\t\t\t\t\t\t\t\tmax = val;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tresult[field] = max;\n\t\t\t\t\t\t} else if (accType === '$push') {\n\t\t\t\t\t\t\tconst arr = [];\n\t\t\t\t\t\t\tfor (let k = 0; k < group.docs.length; k++) {\n\t\t\t\t\t\t\t\tif (typeof accExpr === 'string' && accExpr.charAt(0) === '$') {\n\t\t\t\t\t\t\t\t\tconst val = getProp(group.docs[k], accExpr.substring(1));\n\t\t\t\t\t\t\t\t\tarr.push(val);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tresult[field] = arr;\n\t\t\t\t\t\t} else if (accType === '$addToSet') {\n\t\t\t\t\t\t\tconst set = {};\n\t\t\t\t\t\t\tfor (let k = 0; k < group.docs.length; k++) {\n\t\t\t\t\t\t\t\tif (typeof accExpr === 'string' && accExpr.charAt(0) === '$') {\n\t\t\t\t\t\t\t\t\tconst val = getProp(group.docs[k], accExpr.substring(1));\n\t\t\t\t\t\t\t\t\tset[JSON.stringify(val)] = val;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tconst arr = [];\n\t\t\t\t\t\t\tfor (const valKey in set) {\n\t\t\t\t\t\t\t\tarr.push(set[valKey]);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tresult[field] = arr;\n\t\t\t\t\t\t} else if (accType === '$first') {\n\t\t\t\t\t\t\tif (group.docs.length > 0) {\n\t\t\t\t\t\t\t\tif (typeof accExpr === 'string' && accExpr.charAt(0) === '$') {\n\t\t\t\t\t\t\t\t\tresult[field] = getProp(group.docs[0], accExpr.substring(1));\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (accType === '$last') {\n\t\t\t\t\t\t\tif (group.docs.length > 0) {\n\t\t\t\t\t\t\t\tif (typeof accExpr === 'string' && accExpr.charAt(0) === '$') {\n\t\t\t\t\t\t\t\t\tresult[field] = getProp(group.docs[group.docs.length - 1], accExpr.substring(1));\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tgrouped.push(result);\n\t\t\t\t}\n\t\t\t\tresults = grouped;\n\t\t\t} else if (stageType === \"$count\") {\n\t\t\t\t// Count documents and return single document with count\n\t\t\t\tresults = [{ [stageSpec]: results.length }];\n\t\t\t} else if (stageType === \"$unwind\") {\n\t\t\t\t// Unwind array field\n\t\t\t\tconst unwound = [];\n\t\t\t\tlet fieldPath = stageSpec;\n\t\t\t\tif (typeof fieldPath === 'string' && fieldPath.charAt(0) === '$') {\n\t\t\t\t\tfieldPath = fieldPath.substring(1);\n\t\t\t\t}\n\n\t\t\t\tfor (let j = 0; j < results.length; j++) {\n\t\t\t\t\tconst doc = results[j];\n\t\t\t\t\tconst arr = getProp(doc, fieldPath);\n\n\t\t\t\t\tif (arr && isArray(arr) && arr.length > 0) {\n\t\t\t\t\t\tfor (let k = 0; k < arr.length; k++) {\n\t\t\t\t\t\t\tconst unwoundDoc = copy(doc);\n\t\t\t\t\t\t\t// Set the unwound value\n\t\t\t\t\t\t\tconst parts = fieldPath.split('.');\n\t\t\t\t\t\t\tlet target = unwoundDoc;\n\t\t\t\t\t\t\tfor (let l = 0; l < parts.length - 1; l++) {\n\t\t\t\t\t\t\t\tif (!target[parts[l]]) {\n\t\t\t\t\t\t\t\t\ttarget[parts[l]] = {};\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\ttarget = target[parts[l]];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\ttarget[parts[parts.length - 1]] = arr[k];\n\t\t\t\t\t\t\tunwound.push(unwoundDoc);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t// MongoDB's default behavior: skip documents where field is missing, null, empty array, or not an array\n\t\t\t\t}\n\t\t\t\tresults = unwound;\n\t\t\t} else {\n\t\t\t\tthrow { $err: \"Unsupported aggregation stage: \" + stageType, code: 17287 };\n\t\t\t}\n\t\t}\n\n\t\treturn results;\n\t}\n\n\tbulkWrite() { throw \"Not Implemented\"; }\n\n\tasync count() {\n\t\treturn this.storage.size();\n\t}\n\n\tasync copyTo(destCollectionName) {\n\t\tif (!this.db[destCollectionName]) {\n\t\t\tthis.db.createCollection(destCollectionName);\n\t\t}\n\t\tconst destCol = this.db[destCollectionName];\n\t\tlet numCopied = 0;\n\t\tconst c = this.find({});\n\t\twhile (c.hasNext()) {\n\t\t\tawait destCol.insertOne(c.next());\n\t\t\tnumCopied++;\n\t\t}\n\t\treturn numCopied;\n\t}\n\n\tasync createIndex(keys, options) {\n\t\t// MongoDB-compliant createIndex\n\t\t// keys: { fieldName: 1 } for ascending, { fieldName: -1 } for descending, { fieldName: 'text' } for text\n\t\t// options: { name: \"indexName\", unique: true, ... }\n\n\t\tif (!keys || typeof keys !== 'object' || Array.isArray(keys)) {\n\t\t\tthrow { $err: \"createIndex requires a key specification object\", code: 2 };\n\t\t}\n\n\t\tconst indexName = (options && options.name) ? options.name : this.generateIndexName(keys);\n\n\t\t// Check if index already exists\n\t\tif (this.indexes[indexName]) {\n\t\t\t// MongoDB checks for key specification conflicts\n\t\t\tconst existingIndex = this.indexes[indexName];\n\t\t\tconst existingKeys = JSON.stringify(existingIndex.keys);\n\t\t\tconst newKeys = JSON.stringify(keys);\n\t\t\tif (existingKeys !== newKeys) {\n\t\t\t\tthrow { $err: \"Index with name '\" + indexName + \"' already exists with a different key specification\", code: 85 };\n\t\t\t}\n\t\t\t// Same index, return without error\n\t\t\treturn indexName;\n\t\t}\n\n\t\t// Build the index\n\t\tthis.buildIndex(indexName, keys, options);\n\n\t\treturn indexName;\n\t}\n\n\tdataSize() { throw \"Not Implemented\"; }\n\n\tasync deleteOne(query) {\n\t\tconst doc = await this.findOne(query);\n\t\tif (doc) {\n\t\t\tthis.updateIndexesOnDelete(doc);\n\t\t\tthis.storage.remove(doc._id);\n\t\t\treturn { deletedCount: 1 };\n\t\t} else {\n\t\t\treturn { deletedCount: 0 };\n\t\t}\n\t}\n\n\tasync deleteMany(query) {\n\t\tconst c = this.find(query);\n\t\tconst ids = [];\n\t\tconst docs = [];\n\t\twhile (c.hasNext()) {\n\t\t\tconst doc = c.next();\n\t\t\tids.push(doc._id);\n\t\t\tdocs.push(doc);\n\t\t}\n\t\tconst deletedCount = ids.length;\n\t\tfor (let i = 0; i < ids.length; i++) {\n\t\t\tthis.updateIndexesOnDelete(docs[i]);\n\t\t\tthis.storage.remove(ids[i]);\n\t\t}\n\t\treturn { deletedCount: deletedCount };\n\t}\n\n\tasync distinct(field, query) {\n\t\tconst vals = {};\n\t\tconst c = this.find(query);\n\t\twhile (c.hasNext()) {\n\t\t\tconst d = c.next();\n\t\t\tif (d[field]) {\n\t\t\t\tvals[d[field]] = true;\n\t\t\t}\n\t\t}\n\t\treturn Object.keys(vals);\n\t}\n\n\tdrop() {\n\t\tthis.storage.clear();\n\t\t// Clear all indexes\n\t\tfor (const indexName in this.indexes) {\n\t\t\tif (this.indexes.hasOwnProperty(indexName)) {\n\t\t\t\tthis.indexes[indexName].clear();\n\t\t\t}\n\t\t}\n\t}\n\n\tdropIndex(indexName) {\n\t\tif (!this.indexes[indexName]) {\n\t\t\tthrow { $err: \"Index not found with name: \" + indexName, code: 27 };\n\t\t}\n\t\tthis.indexes[indexName].clear();\n\t\tdelete this.indexes[indexName];\n\t\treturn { nIndexesWas: Object.keys(this.indexes).length + 1, ok: 1 };\n\t}\n\n\tdropIndexes() {\n\t\tconst count = Object.keys(this.indexes).length;\n\t\tfor (const indexName in this.indexes) {\n\t\t\tif (this.indexes.hasOwnProperty(indexName)) {\n\t\t\t\tthis.indexes[indexName].clear();\n\t\t\t}\n\t\t}\n\t\tthis.indexes = {};\n\t\treturn { nIndexesWas: count, msg: \"non-_id indexes dropped\", ok: 1 };\n\t}\n\tensureIndex() { throw \"Not Implemented\"; }\n\texplain() { throw \"Not Implemented\"; }\n\n\tfind(query, projection) {\n\t\treturn new Cursor(\n\t\t\tthis,\n\t\t\t(query == undefined ? {} : query),\n\t\t\tprojection,\n\t\t\tmatches,\n\t\t\tthis.storage,\n\t\t\tthis.indexes,\n\t\t\tthis.planQuery.bind(this),\n\t\t\tSortedCursor\n\t\t);\n\t}\n\n\tfindAndModify() { throw \"Not Implemented\"; }\n\n\tasync findOne(query, projection) {\n\t\tconst cursor = this.find(query, projection);\n\t\tif (cursor.hasNext()) {\n\t\t\treturn cursor.next();\n\t\t} else {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tasync findOneAndDelete(filter, options) {\n\t\tlet c = this.find(filter);\n\t\tif (options && options.sort) c = c.sort(options.sort);\n\t\tif (!c.hasNext()) return null;\n\t\tconst doc = c.next();\n\t\tthis.storage.remove(doc._id);\n\t\tif (options && options.projection) return applyProjection(options.projection, doc);\n\t\telse return doc;\n\t}\n\n\tasync findOneAndReplace(filter, replacement, options) {\n\t\tlet c = this.find(filter);\n\t\tif (options && options.sort) c = c.sort(options.sort);\n\t\tif (!c.hasNext()) return null;\n\t\tconst doc = c.next();\n\t\treplacement._id = doc._id;\n\t\tthis.storage.set(doc._id, replacement);\n\t\tif (options && options.returnNewDocument) {\n\t\t\tif (options && options.projection) return applyProjection(options.projection, replacement);\n\t\t\telse return replacement;\n\t\t} else {\n\t\t\tif (options && options.projection) return applyProjection(options.projection, doc);\n\t\t\telse return doc;\n\t\t}\n\t}\n\n\tasync findOneAndUpdate(filter, update, options) {\n\t\tlet c = this.find(filter);\n\t\tif (options && options.sort) c = c.sort(options.sort);\n\t\tif (!c.hasNext()) return null;\n\t\tconst doc = c.next();\n\t\tconst clone = Object.assign({}, doc);\n\t\tapplyUpdates(update, clone);\n\t\tthis.storage.set(doc._id, clone);\n\t\tif (options && options.returnNewDocument) {\n\t\t\tif (options && options.projection) return applyProjection(options.projection, clone);\n\t\t\telse return clone;\n\t\t} else {\n\t\t\tif (options && options.projection) return applyProjection(options.projection, doc);\n\t\t\telse return doc;\n\t\t}\n\t}\n\n\tgetIndexes() {\n\t\t// Return array of index specifications\n\t\tconst result = [];\n\t\tfor (const indexName in this.indexes) {\n\t\t\tif (this.indexes.hasOwnProperty(indexName)) {\n\t\t\t\tresult.push(this.indexes[indexName].getSpec());\n\t\t\t}\n\t\t}\n\t\treturn result;\n\t}\n\n\tgetShardDistribution() { throw \"Not Implemented\"; }\n\tgetShardVersion() { throw \"Not Implemented\"; }\n\n\t// non-mongo\n\tgetStore() {\n\t\treturn this.storage.getStore();\n\t}\n\n\tgroup() { throw \"Not Implemented\"; }\n\n\tasync insert(doc) {\n\t\tif (Array == doc.constructor) {\n\t\t\treturn await this.insertMany(doc);\n\t\t} else {\n\t\t\treturn await this.insertOne(doc);\n\t\t}\n\t}\n\n\tasync insertOne(doc) {\n\t\tif (doc._id == undefined) doc._id = this.idGenerator();\n\t\tthis.storage.set(doc._id, doc);\n\t\tthis.updateIndexesOnInsert(doc);\n\t\treturn { insertedId: doc._id };\n\t}\n\n\tasync insertMany(docs) {\n\t\tconst insertedIds = [];\n\t\tfor (let i = 0; i < docs.length; i++) {\n\t\t\tconst result = await this.insertOne(docs[i]);\n\t\t\tinsertedIds.push(result.insertedId);\n\t\t}\n\t\treturn { insertedIds: insertedIds };\n\t}\n\n\tisCapped() { throw \"Not Implemented\"; }\n\tmapReduce() { throw \"Not Implemented\"; }\n\treIndex() { throw \"Not Implemented\"; }\n\n\tasync replaceOne(query, replacement, options) { // only replace\n\t\t// first\n\t\tconst result = {};\n\t\tconst c = this.find(query);\n\t\tresult.matchedCount = c.count();\n\t\tif (result.matchedCount == 0) {\n\t\t\tresult.modifiedCount = 0;\n\t\t\tif (options && options.upsert) {\n\t\t\t\tconst newDoc = replacement;\n\t\t\t\tnewDoc._id = this.idGenerator();\n\t\t\t\tthis.storage.set(newDoc._id, newDoc);\n\t\t\t\tresult.upsertedId = newDoc._id;\n\t\t\t}\n\t\t} else {\n\t\t\tresult.modifiedCount = 1;\n\t\t\tconst doc = c.next();\n\t\t\tthis.updateIndexesOnDelete(doc);\n\t\t\treplacement._id = doc._id;\n\t\t\tthis.storage.set(doc._id, replacement);\n\t\t\tthis.updateIndexesOnInsert(replacement);\n\t\t}\n\t\treturn result;\n\t}\n\n\tremove(query, options) {\n\t\tconst c = this.find(query);\n\t\tif (!c.hasNext()) return;\n\t\tif (options === true || (options && options.justOne)) {\n\t\t\tconst doc = c.next();\n\t\t\tthis.updateIndexesOnDelete(doc);\n\t\t\tthis.storage.remove(doc._id);\n\t\t} else {\n\t\t\twhile (c.hasNext()) {\n\t\t\t\tconst doc = c.next();\n\t\t\t\tthis.updateIndexesOnDelete(doc);\n\t\t\t\tthis.storage.remove(doc._id);\n\t\t\t}\n\t\t}\n\t}\n\n\trenameCollection() { throw \"Not Implemented\"; }\n\tsave() { throw \"Not Implemented\"; }\n\tstats() { throw \"Not Implemented\"; }\n\tstorageSize() { throw \"Not Implemented\"; }\n\ttotalSize() { throw \"Not Implemented\"; }\n\ttotalIndexSize() { throw \"Not Implemented\"; }\n\n\tupdate(query, updates, options) {\n\t\tconst c = this.find(query);\n\t\tif (c.hasNext()) {\n\t\t\tif (options && options.multi) {\n\t\t\t\twhile (c.hasNext()) {\n\t\t\t\t\tconst doc = c.next();\n\t\t\t\t\tthis.updateIndexesOnDelete(doc);\n\t\t\t\t\tapplyUpdates(updates, doc);\n\t\t\t\t\tthis.storage.set(doc._id, doc);\n\t\t\t\t\tthis.updateIndexesOnInsert(doc);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tconst doc = c.next();\n\t\t\t\tthis.updateIndexesOnDelete(doc);\n\t\t\t\tapplyUpdates(updates, doc);\n\t\t\t\tthis.storage.set(doc._id, doc);\n\t\t\t\tthis.updateIndexesOnInsert(doc);\n\t\t\t}\n\t\t} else {\n\t\t\tif (options && options.upsert) {\n\t\t\t\tconst newDoc = createDocFromUpdate(query, updates, this.idGenerator);\n\t\t\t\tthis.storage.set(newDoc._id, newDoc);\n\t\t\t\tthis.updateIndexesOnInsert(newDoc);\n\t\t\t}\n\t\t}\n\t}\n\n\tasync updateOne(query, updates, options) {\n\t\tconst c = this.find(query);\n\t\tif (c.hasNext()) {\n\t\t\tconst doc = c.next();\n\t\t\tthis.updateIndexesOnDelete(doc);\n\t\t\tapplyUpdates(updates, doc);\n\t\t\tthis.storage.set(doc._id, doc);\n\t\t\tthis.updateIndexesOnInsert(doc);\n\t\t} else {\n\t\t\tif (options && options.upsert) {\n\t\t\t\tconst newDoc = createDocFromUpdate(query, updates, this.idGenerator);\n\t\t\t\tthis.storage.set(newDoc._id, newDoc);\n\t\t\t\tthis.updateIndexesOnInsert(newDoc);\n\t\t\t}\n\t\t}\n\t}\n\n\tasync updateMany(query, updates, options) {\n\t\tconst c = this.find(query);\n\t\tif (c.hasNext()) {\n\t\t\twhile (c.hasNext()) {\n\t\t\t\tconst doc = c.next();\n\t\t\t\tthis.updateIndexesOnDelete(doc);\n\t\t\t\tapplyUpdates(updates, doc);\n\t\t\t\tthis.storage.set(doc._id, doc);\n\t\t\t\tthis.updateIndexesOnInsert(doc);\n\t\t\t}\n\t\t} else {\n\t\t\tif (options && options.upsert) {\n\t\t\t\tconst newDoc = createDocFromUpdate(query, updates, this.idGenerator);\n\t\t\t\tthis.storage.set(newDoc._id, newDoc);\n\t\t\t\tthis.updateIndexesOnInsert(newDoc);\n\t\t\t}\n\t\t}\n\t}\n\n\tvalidate() { throw \"Not Implemented\"; }\n}\n","import { Collection } from './Collection.js';\nimport { LocalStorageStore, ObjectStore } from '../main.js';\nimport { ObjectId } from './ObjectId.js';\n\n/**\n * DB class\n */\nexport class DB {\n\tconstructor(options) {\n\t\tthis.options = options || {};\n\t\t\n\t\t// Initialize localStorage collection if available\n\t\tif (typeof localStorage !== \"undefined\") {\n\t\t\tthis.localStorage = new Collection(\n\t\t\t\tthis,\n\t\t\t\t(this.options.localStorage ? this.options.localStorage : LocalStorageStore),\n\t\t\t\tthis._id.bind(this)\n\t\t\t);\n\t\t} else {\n\t\t\tthis.localStorage = null;\n\t\t}\n\n\t\t// Return a Proxy to enable dynamic collection creation\n\t\treturn new Proxy(this, {\n\t\t\tget(target, property, receiver) {\n\t\t\t\t// If property exists on target (including undefined values), return it\n\t\t\t\tif (property in target) {\n\t\t\t\t\treturn Reflect.get(target, property, receiver);\n\t\t\t\t}\n\n\t\t\t\t// If property is a symbol or special property, return undefined\n\t\t\t\tif (typeof property === 'symbol' || property.startsWith('_')) {\n\t\t\t\t\treturn undefined;\n\t\t\t\t}\n\n\t\t\t\t// For collection names, create the collection if it doesn't exist\n\t\t\t\t// Only auto-create if it's a valid collection name and doesn't already exist\n\t\t\t\tif (typeof property === 'string' && property !== 'localStorage') {\n\t\t\t\t\t// Don't auto-create if property was explicitly deleted\n\t\t\t\t\tif (Object.prototype.hasOwnProperty.call(target, property)) {\n\t\t\t\t\t\treturn target[property];\n\t\t\t\t\t}\n\t\t\t\t\t// Auto-create the collection\n\t\t\t\t\ttarget.createCollection(property);\n\t\t\t\t\treturn target[property];\n\t\t\t\t}\n\n\t\t\t\treturn undefined;\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n\t * Log function\n\t */\n\t_log(msg) {\n\t\tif (this.options && this.options.print) this.options.print(msg);\n\t\telse console.log(msg);\n\t}\n\n\t/**\n\t * ID generator function\n\t */\n\t_id() {\n\t\tif (this.options && this.options.id) return this.options.id();\n\t\telse return new ObjectId();\n\t}\n\n\t// DB Methods\n\tcloneCollection() { throw \"Not Implemented\"; }\n\tcloneDatabase() { throw \"Not Implemented\"; }\n\tcommandHelp() { throw \"Not Implemented\"; }\n\tcopyDatabase() { throw \"Not Implemented\"; }\n\n\tcreateCollection(name) {\n\t\tif (!name) return;\n\t\tif (name == \"localStorage\") {\n\t\t\tthis.localStorage = new Collection(\n\t\t\t\tthis,\n\t\t\t\t(this.options.localStorage ? this.options.localStorage : LocalStorageStore),\n\t\t\t\tthis._id.bind(this)\n\t\t\t);\n\t\t} else {\n\t\t\tthis[name] = new Collection(\n\t\t\t\tthis,\n\t\t\t\t(this.options && this.options.storage ? new this.options.storage() : new ObjectStore()),\n\t\t\t\tthis._id.bind(this)\n\t\t\t);\n\t\t}\n\t}\n\n\tcurrentOp() { throw \"Not Implemented\"; }\n\n\tdropDatabase() {\n\t\tfor (const key in this) {\n\t\t\tif (this[key] != null && this[key].isCollection) {\n\t\t\t\tthis[key].drop(); // drop the contents\n\t\t\t\tdelete this[key];\n\t\t\t}\n\t\t}\n\t}\n\n\teval() { throw \"Not Implemented\"; }\n\tfsyncLock() { throw \"Not Implemented\"; }\n\tfsyncUnlock() { throw \"Not Implemented\"; }\n\tgetCollection() { throw \"Not Implemented\"; }\n\tgetCollectionInfos() { throw \"Not Implemented\"; }\n\n\tgetCollectionNames() {\n\t\tconst names = [];\n\t\tfor (const key in this) {\n\t\t\tif (this[key] != null && this[key].isCollection) {\n\t\t\t\tnames.push(key);\n\t\t\t}\n\t\t}\n\t\treturn names;\n\t}\n\n\tgetLastError() { throw \"Not Implemented\"; }\n\tgetLastErrorObj() { throw \"Not Implemented\"; }\n\tgetLogComponents() { throw \"Not Implemented\"; }\n\tgetMongo() { throw \"Not Implemented\"; }\n\tgetName() { throw \"Not Implemented\"; }\n\tgetPrevError() { throw \"Not Implemented\"; }\n\tgetProfilingLevel() { throw \"Not Implemented\"; }\n\tgetProfilingStatus() { throw \"Not Implemented\"; }\n\tgetReplicationInfo() { throw \"Not Implemented\"; }\n\tgetSiblingDB() { throw \"Not Implemented\"; }\n\n\thelp() {\n\t\tthis._log(\"        help mr                      mapreduce\");\n\t\tthis._log(\"        db.foo.find()                list objects in collection foo\");\n\t\tthis._log(\"        db.foo.find( { a : 1 } )     list objects in foo where a == 1\");\n\t\tthis._log(\"        it                           result of the last line evaluated; use to further iterate\");\n\t}\n\n\thostInfo() { throw \"Not Implemented\"; }\n\tisMaster() { throw \"Not Implemented\"; }\n\tkillOp() { throw \"Not Implemented\"; }\n\tlistCommands() { throw \"Not Implemented\"; }\n\tloadServerScripts() { throw \"Not Implemented\"; }\n\tlogout() { throw \"Not Implemented\"; }\n\tprintCollectionStats() { throw \"Not Implemented\"; }\n\tprintReplicationInfo() { throw \"Not Implemented\"; }\n\tprintShardingStatus() { throw \"Not Implemented\"; }\n\tprintSlaveReplicationInfo() { throw \"Not Implemented\"; }\n\trepairDatabase() { throw \"Not Implemented\"; }\n\tresetError() { throw \"Not Implemented\"; }\n\trunCommand() { throw \"Not Implemented\"; }\n\tserverBuildInfo() { throw \"Not Implemented\"; }\n\tserverCmdLineOpts() { throw \"Not Implemented\"; }\n\tserverStatus() { throw \"Not Implemented\"; }\n\tsetLogLevel() { throw \"Not Implemented\"; }\n\tsetProfilingLevel() { throw \"Not Implemented\"; }\n\tshutdownServer() { throw \"Not Implemented\"; }\n\tstats() { throw \"Not Implemented\"; }\n\tversion() { throw \"Not Implemented\"; }\n\tupgradeCheck() { throw \"Not Implemented\"; }\n\tupgradeCheckAllDBs() { throw \"Not Implemented\"; }\n}\n","\r\nimport { DB } from './DB.js'\r\n// https://mongodb.github.io/node-mongodb-native/6.20/classes/MongoClient.html\r\nexport class MongoClient {\r\n\r\n  constructor(uri, options = {}) {\r\n    this.uri = uri;\r\n    this.options = options;\r\n  }\r\n\r\n  static async connect(uri, options = {}) {\r\n    return new MongoClient(uri, options);\r\n  }\r\n\r\n  db(name, opts = {}) {\r\n    // Merge client options with db-specific options\r\n    const dbOptions = { ...this.options, ...opts };\r\n    return new DB(dbOptions);\r\n  }\r\n\r\n  async close() {\r\n    /* no-op for in-memory */ \r\n  }\r\n}","/**\n * MicroMongoDB - Lightweight MongoDB-compatible database\n * Refactored into separate class files\n */\n\n/**\n * MicroMongoDB.LocalStorageStore\n * \n * Singleton\n */\nexport const LocalStorageStore = (function() {\n\n\treturn {\n\t\tclear : function() {\n\t\t\tlocalStorage.clear();\n\t\t},\n\t\tget : function(i) {\n\t\t\treturn JSON.parse(localStorage.getItem(localStorage.key(i)));\n\t\t},\n\t\tgetStore : function() {\n\t\t\treturn localStorage;\n\t\t},\n\t\tremove : function(key) {\n\t\t\tlocalStorage.removeItem(key);\n\t\t},\n\t\tset : async function(key,val) {\n\t\t\tlocalStorage.setItem(key,JSON.stringify(val));\n\t\t},\n\t\tsize : function() {\n\t\t\treturn localStorage.length;\n\t\t}\n\t};\n\n})(); // MicroMongoDB.LocalStorageStore\n\n/**\n * MicroMongoDB.ObjectStore\n * \n * Public Constructor Function\n */\nexport const ObjectStore = function() {\n\n\tvar objs = {};\n\n\treturn {\n\t\tclear : function() {\n\t\t\tobjs = {};\n\t\t},\n\t\tget : function(i) {\n\t\t\treturn objs[Object.keys(objs)[i]];\n\t\t},\n\t\tgetStore : function() {\n\t\t\treturn objs;\n\t\t},\n\t\tremove : function(key) {\n\t\t\tdelete objs[key];\n\t\t},\n\t\tset : function(key,val) {\n\t\t\tobjs[key] = val;\n\t\t},\n\t\tsize : function() {\n\t\t\treturn Object.keys(objs).length;\n\t\t}\n\t}; // MicroMongoDB.ObjectStore return\n}; // MicroMongoDB.ObjectStore\n\n// Export refactored classes\nexport { MongoClient } from './src/MongoClient.js';\nexport { ObjectId } from './src/ObjectId.js';\n"],"names":["ObjectId","constructor","id","this","generate","isValid","Error","toLowerCase","toString","toHexString","getTimestamp","timestamp","parseInt","substring","Date","equals","other","toJSON","inspect","length","test","createFromTime","tsHex","Math","floor","slice","ts","now","rand","crypto","getRandomValues","Uint8Array","tail","i","random","padEnd","valuesEqual","a","b","copy","o","out","v","key","Array","isArray","getProp","obj","name","path","split","result","isIn","val","values","arrayMatches","x","y","objectMatches","p","hasOwnProperty","applyProjection","projection","doc","keys","Object","hasInclusion","hasExclusion","$err","code","_id","Cursor","collection","query","matches","storage","indexes","planQuery","SortedCursor","pos","max","_next","queryPlan","indexDocIds","indexPos","fullScanDocIds","useIndex","docIds","_findNext","docId","getStore","size","cur","get","batchSize","close","comment","count","num","c","hasNext","next","explain","forEach","fn","hint","itcount","limit","_max","map","results","push","maxScan","maxTimeMS","min","noCursorTimeout","objsLeftInBatch","pretty","readConcern","readPref","returnKey","showRecordId","skip","snapshot","sort","s","tailable","toArray","Symbol","asyncIterator","cursor","sortSpec","items","sortKeys","step2list","ational","tional","enci","anci","izer","bli","alli","entli","eli","ousli","ization","ation","ator","alism","iveness","fulness","ousness","aliti","iviti","biliti","logi","step3list","icate","ative","alize","iciti","ical","ful","ness","vowel","consonants","vowels","gt0","RegExp","eq1","gt1","vowelInStem","consonantLike","sfxLl","sfxE","sfxY","sfxIon","sfxEdOrIng","sfxAtOrBlOrIz","sfxEED","sfxS","sfxSsesOrIes","sfxMultiConsonantLike","step2","step3","step4","stemmer","value","String","match","firstCharacterWasLowerCaseY","codePointAt","exec","STOPWORDS","Set","TextIndex","options","index","Map","documentTerms","documentLengths","useStopWords","stopWords","_tokenize","text","words","filter","word","has","add","termFrequency","stem","set","frequency","remove","term","delete","queryText","scored","requireAll","stemmedTerms","uniqueTerms","docSets","termDocs","intersection","from","totalDocs","idf","docsWithTerm","log","docScores","termFreq","tfIdf","score","docTerms","coverage","entries","r","getTermCount","getDocumentCount","clear","addStopWords","removeStopWords","setStopWordFiltering","enabled","compareValues","operator","aVal","bVal","prop","textIndex","geoWithin","minLon","maxLat","maxLon","isGeometryWithinBBox","e","geoJson","minLat","type","features","feature","geometry","coordinates","lng","lat","ring","coord","tlMatches","charAt","and","els","or","not","nor","call","Function","where","opMatches","operand","fieldValue","j","found","element","matchesPrimitive","opKeys","k","op","opValue","arr","el","applyUpdates","updates","setOnInsert","fields","amount","field","pop","shift","src","toRemove","notRemoved","removed","l","operation","createDocFromUpdate","idGenerator","newDoc","onlyFields","updateKeys","queryKeys","CollectionIndex","generateIndexName","parts","join","update","oldDoc","getSpec","RegularCollectionIndex","super","data","extractIndexKey","keyFields","JSON","stringify","t","keyParts","indexKey","idx","indexOf","splice","indexFields","queryValue","TextCollectionIndex","indexedFields","_extractText","textParts","search","searchText","textIndexVersion","weights","_getWeights","haversineDistance","lat1","lng1","lat2","lng2","dLat","PI","dLng","sin","cos","atan2","sqrt","intersects","bbox1","bbox2","maxLng","minLng","area","bbox","union","enlargement","RTreeNode","isLeaf","children","updateBBox","Infinity","child","RTree","maxEntries","minEntries","ceil","root","_size","insert","entry","_insert","node","level","_split","target","_chooseSubtree","splitNode","minEnlargement","minArea","targetNode","enl","ar","maxDist","seed1Idx","seed2Idx","waste","node1","node2","enl1","enl2","newRoot","searchBBox","_searchBBox","searchRadius","radiusKm","latDelta","lngDelta","radiusToBoundingBox","candidates","_remove","parent","indexInParent","getAll","_getAll","GeospatialCollectionIndex","rtree","geoField","_extractCoordinates","sumLat","sumLng","geoValue","coords","geoQuery","$geoWithin","Collection","db","isCollection","isTextIndex","isGeospatialIndex","buildIndex","indexName","updateIndexesOnInsert","updateIndexesOnDelete","getTextIndex","includes","aggregate","pipeline","find","stage","stageKeys","stageType","stageSpec","matched","projected","groups","groupId","keyStr","docs","accumulators","grouped","groupKey","group","accumulator","accKeys","accType","accExpr","sum","valKey","unwound","fieldPath","unwoundDoc","bulkWrite","copyTo","destCollectionName","createCollection","destCol","numCopied","insertOne","createIndex","existingIndex","dataSize","deleteOne","findOne","deletedCount","deleteMany","ids","distinct","vals","d","drop","dropIndex","nIndexesWas","ok","dropIndexes","msg","ensureIndex","bind","findAndModify","findOneAndDelete","findOneAndReplace","replacement","returnNewDocument","findOneAndUpdate","clone","assign","getIndexes","getShardDistribution","getShardVersion","insertMany","insertedId","insertedIds","isCapped","mapReduce","reIndex","replaceOne","matchedCount","modifiedCount","upsert","upsertedId","justOne","renameCollection","save","stats","storageSize","totalSize","totalIndexSize","multi","updateOne","updateMany","validate","DB","localStorage","LocalStorageStore","Proxy","property","receiver","Reflect","startsWith","prototype","_log","print","console","cloneCollection","cloneDatabase","commandHelp","copyDatabase","ObjectStore","currentOp","dropDatabase","eval","fsyncLock","fsyncUnlock","getCollection","getCollectionInfos","getCollectionNames","names","getLastError","getLastErrorObj","getLogComponents","getMongo","getName","getPrevError","getProfilingLevel","getProfilingStatus","getReplicationInfo","getSiblingDB","help","hostInfo","isMaster","killOp","listCommands","loadServerScripts","logout","printCollectionStats","printReplicationInfo","printShardingStatus","printSlaveReplicationInfo","repairDatabase","resetError","runCommand","serverBuildInfo","serverCmdLineOpts","serverStatus","setLogLevel","setProfilingLevel","shutdownServer","version","upgradeCheck","upgradeCheckAllDBs","MongoClient","uri","connect","opts","dbOptions","parse","getItem","removeItem","async","setItem","objs"],"mappings":"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","x_google_ignoreList":[4]}