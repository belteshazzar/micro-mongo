# Micro-Mongo AI Guide
- Scope: MongoDB-like in-memory DB with optional browser persistence and Node/browser compatibility; entry exports live in [main.js](main.js).
- ESM only (`type: module`); imports use extensioned relative paths; ObjectId comes from `bjson`.
- Client/DB lifecycle: [src/MongoClient.js](src/MongoClient.js) emits `open`/`close`, parses default DB from URI, and returns [src/DB.js](src/DB.js) instances.
- DB setup: DB wraps a Proxy that auto-creates collections on unknown string properties while ignoring symbols/underscored names; pass `storageEngine`, `dbName`, `id` generator, or `print` logger through DB options.
- Storage engines: [src/StorageEngine.js](src/StorageEngine.js) is the default in-memory Map-based engine; [src/IndexedDbStorageEngine.js](src/IndexedDbStorageEngine.js) persists collections/index metadata into IndexedDB object stores `collections` and `metadata` and must be initialized in browser contexts.
- Collections: [src/Collection.js](src/Collection.js) owns documents and indexes per collection; initializes existing indexes from the storage layer and keeps an `indexes` Map plus a `QueryPlanner` per collection.
- Indexing: regular/text/geospatial indexes live in `RegularCollectionIndex`, `TextCollectionIndex`, and `GeospatialCollectionIndex`; `createIndex` builds indexes by scanning stored docs and writes metadata via `storage.createIndexStore`; index name defaults to `field_direction` unless `options.name` is provided.
- Query planner: `find` consults `planQuery`, executes index lookups when possible, then full scans for completeness; results feed `Cursor`/`SortedCursor`, so keep plan outputs in sync when adding operators.
- Aggregation pipeline: `aggregate` in [src/Collection.js](src/Collection.js) runs synchronously over an in-memory doc array; implements `$match`, `$project` with expression support, `$addFields/$set`, `$unset`, `$sort`, `$limit/$skip`, `$group`, `$facet`, `$lookup`, `$graphLookup`, `$merge`, `$geoNear`, `$sortByCount`, `$bucket`, etc. Extend this switch carefullyâ€”errors use `QueryError`/`ErrorCodes`.
- Updates & array filters: Mutations use `applyUpdates` and `matchWithArrayIndices` to honor positional array filters; `createDocFromUpdate` handles upserts. Keep `updateIndexesOnDelete/Insert` around each mutation so indexes stay consistent.
- Change events: Inserts/updates/deletes emit events that feed `ChangeStream` (watchers on collections, DBs, and client). When adding new mutations, emit appropriate events and update `_getUpdateDescription` if needed.
- ID handling: `_id` is auto-assigned via DB `idGenerator` (ObjectId by default) and stored as string keys in the collection store; preserve string conversion when touching storage.
- Non-persistent storage: `save` in `StorageEngine` is intentionally a no-op; persistence requires passing a storage engine with real save/load semantics.
- Error handling: Unsupported Mongo API surface methods throw `NotImplementedError` from [src/errors.js](src/errors.js); keep stubs throwing rather than silently failing.
- Async surface, sync internals: Public collection methods (`insertOne`, `updateOne`, `deleteOne`, `findOne`, etc.) are async for driver parity, but most work synchronously on in-memory data. Maintain this shape for new APIs.
- Cursor usage: Cursors are synchronous (`hasNext/next`, `sort`, `skip`, `limit`) with `toArray` convenience; async iteration is handled at call sites (see README examples).
- Tests: Mocha suite enumerated in `npm test` script; `npm run test:browser` targets browser harness; `npm run test:all` chains both. Coverage via `npm run cover` (c8).
- Build: Vite-based; `npm run build` -> clean + dev + min; configs in [vite.config.js](vite.config.js) and [vite.config.min.js](vite.config.min.js); build outputs live in `build/` (ESM + UMD). Dev server: `npm run dev`; preview: `npm run preview`.
- Docs/examples: High-level usage and status in [README.md](README.md); build specifics in [docs/BUILD.md](docs/BUILD.md); feature guides in `docs/` (aggregation, change streams, storage engine, array filters, text search, geospatial). Browser demos live in [test-browser-simple.html](test-browser-simple.html) and [test-indexeddb.html](test-indexeddb.html).
- When adding new operators or storage behaviors, align with existing docs and update relevant tests under [test/](test/); prefer extending the existing switch-style handlers in Collection over ad-hoc logic elsewhere.
